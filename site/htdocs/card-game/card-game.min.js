function uniqueValues(e){var r={};return e.filter(function(e){return r.hasOwnProperty(e)?!1:r[e]=!0})}function compareZIndex(e,r){return e.zIndex<r.zIndex?-1:e.zIndex>r.zIndex?1:0}function getRandomInteger(e,r){return Math.floor(Math.random()*(r-e+1))+e}function loadingProgress(){console.log("loading - "+Loader.getProgress())}function getCanvasPosition(){canvasElemCoords=document.getElementById("cardGame").getBoundingClientRect(),outerCanvasLeft=canvasElemCoords.left,outerCanvasTop=canvasElemCoords.top,outerCanvasWidth=canvasElemCoords.right-canvasElemCoords.left,outerCanvasHeight=canvasElemCoords.bottom-canvasElemCoords.top,pageLoadScroll=document.body.scrollTop+document.documentElement.scrollTop}function initCardGame(){getCanvasPosition(),gameCanvas=document.getElementById("cardGame"),gameCanvas.getContext&&(gameContext=gameCanvas.getContext("2d"),canvasWidth=gameCanvas.width,canvasHeight=gameCanvas.height),cards=[];for(var e=0;e<numberOfCardsInGame;e++)cards[e]={x:-100,y:-100,index:e,zIndex:0,flippedAnimation:0,isMovingToBoard:!1,originalOwner:e>=numberOfCardsInGame/2?2:1,hasBeenPlaced:!1,cardType:allCardsThisGame[e],currentOwner:e>=numberOfCardsInGame/2?2:1,draw:function(){offsetX=0,offsetY=0,this.flippedAnimation>0&&(randomAmount=4*this.flippedAnimation,offsetX=getRandomInteger(0,randomAmount),offsetY=getRandomInteger(0,randomAmount),this.flippedAnimation--,0==this.flippedAnimation&&(this.zIndex=0)),gameContext.fillStyle=playerColours[this.currentOwner],gameContext.fillRect(this.x+offsetX,this.y+offsetY,cardWidth,cardHeight),gameContext.drawImage(cardImages[this.cardType],this.x+offsetX,this.y+offsetY)}};cardImages=[];for(var e=1;numberOfCardTypes>=e;e++)cardImages[e]=Loader.getImage("card"+e);boardImage=Loader.getImage("board"),currentCardSelectedImage=Loader.getImage("selected"),currentCardSelected={draw:function(){-1!=currentlySelectedCard&&gameContext.drawImage(currentCardSelectedImage,cards[currentlySelectedCard].x-20,cards[currentlySelectedCard].y-20)}},currentPlayerMarkerImage=Loader.getImage("current"),currentPlayerMarker={xScale:1,increment:-.05,draw:function(){this.xScale+=this.increment,Math.abs(this.xScale)>1&&(this.increment*=-1),gameContext.save(),this.x=1==currentPlayersTurn?84:925,gameContext.translate(this.x,20),gameContext.scale(this.xScale,1),gameContext.drawImage(currentPlayerMarkerImage,0-currentPlayerMarkerImage.width/2,0),gameContext.restore()}},placeCardOnBoard(0,boardWidth/2-1,boardHeight/2-1,!0),placeCardOnBoard(1,boardWidth/2,boardHeight/2,!0),placeCardOnBoard(numberOfCardsInGame/2,boardWidth/2,boardHeight/2-1,!0),placeCardOnBoard(numberOfCardsInGame/2+1,boardWidth/2-1,boardHeight/2,!0);for(var r=2,a=numberOfCardsInGame/2+2,n=0;n<boardWidth;n++)for(var t=0;t<boardHeight;t++)"#"==board[t][n]?(placeCardOnBoard(r,n,t,!1),r++):"@"==board[t][n]&&(placeCardOnBoard(a,n,t,!1),a++);placedCards=4,currentPlayersTurn=getRandomInteger(1,2),currentlySelectedCard=-1,currentOpponent=1,isPlayer1AI=!0,whoCanClick=currentPlayersTurn,gameMode="play",aiIsWorking=-1,waitForDrawUpdate=!1,1==currentPlayersTurn&&(currentOpponent=2,isPlayer1AI&&doAIMove())}function placeCardOnBoard(e,r,a,n){board[a][r]=e,cards[e].x=r*cardWidth,cards[e].y=a*cardHeight,cards[e].hasBeenPlaced=n}function update(){waitForDrawUpdate&&(doAIMove(),waitForDrawUpdate=!1);for(var e=0;e<numberOfCardsInGame;e++)if(cards[e].isMovingToBoard){var r=cards[e].gridX*cardWidth,a=cards[e].gridY*cardHeight;if(cards[e].x-=.3*(cards[e].x-r),cards[e].y-=.3*(cards[e].y-a),Math.abs(cards[e].x-r)<10&&Math.abs(cards[e].y-a)<10){if(cards[e].isMovingToBoard=!1,cards[e].x=cards[e].gridX*cardWidth,cards[e].y=cards[e].gridY*cardHeight,cards[e].hasBeenPlaced=!0,cards[e].zIndex=0,checkAttacksInAllDirections(cards[e].gridX,cards[e].gridY,board,cards,currentOpponent,currentPlayersTurn,!1),placedCards++,placedCards==numberOfCardsInGame){gameMode="gameover";for(var n=0,t=0,o=0;o<numberOfCardsInGame;o++)1==cards[o].currentOwner?n++:t++;t>n?playerColours[1]="#665200":n>t&&(playerColours[2]="#660052"),draw()}var d=currentPlayersTurn;currentPlayersTurn=currentOpponent,currentOpponent=d,1==currentPlayersTurn&&isPlayer1AI&&(waitForDrawUpdate=!0)}}aiIsWorking>0&&(aiIsWorking++,aiIsWorking>36&&(aiIsWorking=-1,currentlySelectedCard=whichMoveToMake[1],cards[currentlySelectedCard].isMovingToBoard=!0,cards[currentlySelectedCard].gridX=whichMoveToMake[2],cards[currentlySelectedCard].gridY=whichMoveToMake[3],board[whichMoveToMake[3]][whichMoveToMake[2]]=currentlySelectedCard,cards[currentlySelectedCard].zIndex=1,currentlySelectedCard=-1,whoCanClick=2))}function draw(){gameContext.drawImage(boardImage,0,0);for(var e=cards.slice(),r=e.sort(compareZIndex),a=0;a<numberOfCardsInGame;a++)cards[r[a].index].draw();currentCardSelected.draw(),currentPlayerMarker.draw()}function isValidMove(e,r,a){for(var n=!1,t=e-1;e+1>=t;t++)for(var o=r-1;r+1>=o;o++)o>=0&&o<boardHeight&&(isNaN(a[o][t])||(n=!0));return n}function checkAttacksInAllDirections(e,r,a,n,t,o,d){checkAttack(e,r,-1,0,a,n,t,o,d),checkAttack(e,r,1,0,a,n,t,o,d),checkAttack(e,r,0,-1,a,n,t,o,d),checkAttack(e,r,0,1,a,n,t,o,d),checkAttack(e,r,-1,-1,a,n,t,o,d),checkAttack(e,r,1,1,a,n,t,o,d),checkAttack(e,r,-1,1,a,n,t,o,d),checkAttack(e,r,1,-1,a,n,t,o,d)}function checkAttack(e,r,a,n,t,o,d,c,i){var s=0,l=[],u=e+a,m=r+n;do{var g=!1;if(m>=0&&m<boardHeight){var h=t[m][u];if(!isNaN(h)&&o[h].currentOwner==d){g=!0,l.push(h);var f=o[h].cardType;s+=parseInt(allCardData[f][1]),u+=a,m+=n}}}while(g);var C=o[t[r][e]].cardType,p=parseInt(allCardData[C][0]);if(m>=0&&m<boardHeight&&!isNaN(t[m][u])&&o[t[m][u]].currentOwner==c){var v=o[t[m][u]].cardType,w=parseInt(allCardData[v][0]);if(p+w>=s)if(i){thisMovesScore+=l.length;for(var y=0;y<l.length;y++)o[l[y]].currentOwner=c}else for(var y=0;y<l.length;y++)flipCard(l[y],o,c)}}function flipCard(e,r,a){r[e].currentOwner=a,r[e].flippedAnimation=10,r[e].zIndex=1}function insertNewMove(e,r){return r.splice(locationOfBestScores(e,r)+1,0,e),r}function locationOfBestScores(e,r,a,n){a=a||0,n=n||r.length;var t=parseInt(a+(n-a)/2,10);return r[t][0]===e[0]?t:1>=n-a?r[t][0]<e[0]?t-1:t:r[t][0]>e[0]?locationOfBestScores(e,r,t,n):locationOfBestScores(e,r,a,t)}function doAIMove(){console.log("AI thinking..."),aiIsWorking=1,findBestMove(board,currentPlayersTurn,cards)}function findBestMove(e,r){whichOpponentCurrently=1==r?2:1;for(var a=[[-999999,-1,-1,-1]],n=2,t=0,o=n;o<boardWidth-n;o++)for(var d=t;d<boardHeight-t;d++)if("-"==e[d][o]&&isValidMove(o,d,e))for(var c=[],i=0;i<numberOfCardsInGame;i++)if(1==cards[i].currentOwner&&!cards[i].hasBeenPlaced&&-1==c.indexOf(cards[i].cardType)){c.push(cards[i].cardType);for(var s=[],l=0;l<numberOfCardsInGame;l++)s[l]={index:cards[l].index,originalOwner:cards[l].originalOwner,hasBeenPlaced:cards[l].hasBeenPlaced,cardType:cards[l].cardType,currentOwner:cards[l].currentOwner};for(var u=[],m=0;m<e.length;m++)u[m]=e[m].slice();u[d][o]=i,s[i].hasBeenPlaced=!0,thisMovesScore=0,checkAttacksInAllDirections(o,d,u,s,whichOpponentCurrently,r,!0),AIScore=1.01*thisMovesScore,bestCounterMove=0,whichCounterPlayerCurrently=whichOpponentCurrently,whichCounterOpponentCurrently=r;for(var g=n;g<boardWidth-n;g++)for(var m=t;m<boardHeight-t;m++)if("-"==u[m][g]&&isValidMove(g,m,u))for(var h=[],f=0;f<numberOfCardsInGame;f++)if(2==s[f].currentOwner&&!s[f].hasBeenPlaced&&-1==h.indexOf(s[f].cardType)){h.push(s[f].cardType);for(var C=[],l=0;l<numberOfCardsInGame;l++)C[l]={index:s[l].index,originalOwner:s[l].originalOwner,hasBeenPlaced:s[l].hasBeenPlaced,cardType:s[l].cardType,currentOwner:s[l].currentOwner};for(var p=[],l=0;l<u.length;l++)p[l]=u[l].slice();p[m][g]=f,C[f].hasBeenPlaced=!0,thisMovesScore=0,checkAttacksInAllDirections(g,m,p,C,whichCounterOpponentCurrently,whichCounterPlayerCurrently,!0),thisMovesScore>bestCounterMove&&(bestCounterMove=thisMovesScore)}thisMovesScore=AIScore-bestCounterMove,a=insertNewMove([thisMovesScore,i,o,d],a),a.length>10&&a.pop()}-999999==a[a.length-1][0]&&a.pop();var v=player2Skill,w=0;console.log(a);do if(w++,w==a.length)break;while(a[w][0]==a[0][0]);w>v&&(v=w),v>a.length&&(v=a.length-1),whichMoveToMake=a[Math.floor(Math.random()*v)]}function canvasClick(e){var r=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft-outerCanvasLeft,a=e.clientY+document.body.scrollTop+document.documentElement.scrollTop-outerCanvasTop-pageLoadScroll;switch(gameMode){case"play":gridX=Math.floor(r/outerCanvasWidth*boardWidth),gridY=Math.floor(a/outerCanvasHeight*boardHeight);var n=board[gridY][gridX];if("-"==n)-1!=currentlySelectedCard&&isValidMove(gridX,gridY,board)&&(cards[currentlySelectedCard].isMovingToBoard=!0,cards[currentlySelectedCard].gridX=gridX,cards[currentlySelectedCard].gridY=gridY,board[gridY][gridX]=currentlySelectedCard,cards[currentlySelectedCard].zIndex=1,currentlySelectedCard=-1,whoCanClick=currentOpponent);else if("x"!=n){var t=!1;cards[n].hasBeenPlaced||cards[n].currentOwner==whoCanClick&&(t=!0),isPlayer1AI&&1==whoCanClick&&(t=!1),t&&(currentlySelectedCard=n)}}}function gameLoop(){setTimeout(function(){switch(window.requestAnimationFrame(gameLoop),gameMode){case"loading":console.log("loading...");break;case"play":update(),draw();break;case"gameover":console.log("game over")}},1e3/framesPerSecond)}if(framesPerSecond=24,playerColours=["","#ffcc00","#ff00cc"],cardWidth=84,cardHeight=102,allCardsThisGame=player1Cards.concat(player2Cards),numberOfCardsInGame=allCardsThisGame.length,board=[["#","#","x","x","x","-","-","x","x","x","x","x"],["#","#","x","x","-","-","-","-","x","x","@","@"],["#","#","x","-","-","-","-","-","-","x","@","@"],["#","#","x","-","-","-","-","-","-","x","@","@"],["#","#","x","x","-","-","-","-","x","x","@","@"],["x","x","x","x","x","-","-","x","x","x","@","@"]],boardWidth=board[0].length,boardHeight=board.length,function(){for(var e=0,r=["ms","moz","webkit","o"],a=0;a<r.length&&!window.requestAnimationFrame;++a)window.requestAnimationFrame=window[r[a]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[r[a]+"CancelAnimationFrame"]||window[r[a]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(r,a){var n=(new Date).getTime(),t=Math.max(0,16-(n-e)),o=window.setTimeout(function(){r(n+t)},t);return e=n+t,o}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),window.Loader=function(){function e(){}function r(){}function a(a){++i,e(c()),i==l&&(s=!1,r())}function n(e){console.log("Error on loading the image: "+e.srcElement)}function t(e,r){try{u[e]=new Image,u[e].onload=function(){a(e)},u[e].onerror=n,u[e].src=r}catch(t){console.log(t.message)}}function o(e){return u[e]?u[e]:void 0}function d(a,n,o){if(!s){s=!0;try{l=a.length,e=o||function(){},r=n||function(){};for(var d=0;d<a.length;++d)t(a[d].name,a[d].src)}catch(c){console.log(c.message)}}}function c(){return i/l*100}var i=0,s=!1,l=0,u={};return{preload:d,getProgress:c,getImage:o,images:u}}(),cutsTheMustard&&supportsCanvas()){allCardsToLoadThisGame=uniqueValues(allCardsThisGame);for(var numberOfCardTypes=allCardsToLoadThisGame.length,imagesToLoad=[{name:"board",src:"http://www.autumnearth.com/images/card-game/board.jpg"},{name:"selected",src:"http://www.autumnearth.com/images/card-game/selected-card.png"},{name:"current",src:"http://www.autumnearth.com/images/card-game/current-player.png"}],i=1;numberOfCardTypes>=i;i++)imagesToLoad.push({name:"card"+i,src:"http://www.autumnearth.com/images/card-game/cards/"+i+".png"});document.getElementById("cardGame").addEventListener("click",function(e){canvasClick(e),e&&e.preventDefault()},!1),canvasResizeHandler=debounce(function(){getCanvasPosition()},250),window.addEventListener("resize",canvasResizeHandler),gameMode="loading",gameLoop(),Loader.preload(imagesToLoad,initCardGame,loadingProgress)}