<?php

include($_SERVER['DOCUMENT_ROOT']."/includes/functions.php");

/*
$transcriptionData = '{"title":"Concerning Hobbits","timeCreated":"1589139516389","content":[[0, "c5-d"],[144.23076923076925, "c5-e"],[288.4615384615385, "c5-fs"],[1442.3076923076924, "c5-fs"],[2019.230769230769, "c5-fs"],[2307.692307692308, "c5-a"],[2596.153846153846, "c5-e"],[2884.6153846153848, "c5-d"],[3173.076923076923, "c5-e"],[4615.384615384616, "c4-a"],[4759.615384615384, "c4-b"],[4903.846153846154, "c5-cs"],[5480.7692307692305, "c5-cs"],[5769.2307692307695, "c5-cs"],[6057.692307692308, "c5-d"],[6634.615384615384, "c4-b"],[6923.076923076924, "c4-fs"],[7788.461538461539, "c4-a"],[8076.923076923076, "c4-e"],[10384.615384615385, "c4-a"],[10961.538461538461, "c5-cs"],[11538.461538461539, "c5-d"],[11682.692307692309, "c5-e"],[11826.923076923076, "c5-fs"],[12403.846153846152, "c5-fs"],[13557.692307692309, "c5-a"],[13846.153846153848, "c5-fs"],[14134.615384615385, "c5-e"],[14711.538461538461, "c5-d"],[15000, "c5-e"],[15288.461538461537, "c5-cs"],[15865.384615384615, "c5-d"],[16009.615384615383, "c5-cs"],[16153.846153846152, "c4-b"],[18461.538461538465, "c5-d"],[19326.923076923078, "c5-cs"],[19615.384615384617, "c5-cs"],[20480.76923076923, "c4-b"],[20769.23076923077, "c4-fs"],[21634.615384615383, "c4-g"],[21778.846153846152, "c4-fs"],[21923.076923076922, "c4-e"],[22788.461538461535, "c4-d"],[22932.692307692305, "c4-fs"],[23365.384615384617, "c4-fs"],[23509.615384615383, "c4-g"],[23653.846153846152, "c4-e"],[24807.692307692305, "c5-cs"],[24951.923076923078, "c5-d"],[25096.153846153848, "c5-e"],[26250, "c5-e"],[26826.923076923078, "c5-e"],[27115.384615384617, "c5-g"],[27403.846153846152, "c5-d"],[27692.307692307695, "c5-cs"],[27980.76923076923, "c5-d"],[29423.076923076922, "c4-g"],[29567.307692307695, "c4-a"],[29711.538461538465, "c4-b"],[30288.461538461535, "c4-b"],[30576.923076923074, "c4-b"],[30865.384615384613, "c5-cs"],[31442.307692307695, "c4-a"],[31730.76923076923, "c4-e"],[32596.153846153848, "c4-g"],[32884.61538461539, "c4-d"],[35192.307692307695, "c4-g"],[35769.230769230766, "c4-b"],[36346.153846153844, "c5-cs"],[36490.38461538461, "c5-d"],[36634.61538461539, "c5-e"],[37211.53846153846, "c5-e"],[38365.38461538461, "c5-g"],[38653.846153846156, "c5-e"],[38942.307692307695, "c5-d"],[39519.230769230766, "c5-cs"],[39807.692307692305, "c5-d"],[40096.153846153844, "c4-b"],[40673.07692307693, "c5-cs"],[40817.307692307695, "c4-b"],[40961.53846153846, "c4-a"],[43269.230769230766, "c5-cs"],[44134.61538461539, "c4-b"],[44423.07692307693, "c4-b"],[45288.46153846154, "c4-a"],[45576.92307692307, "c4-e"],[46442.307692307695, "c4-fs"],[46586.53846153846, "c4-e"],[46730.769230769234, "c4-d"],[47596.153846153844, "c4-cs"],[47740.38461538461, "c4-e"],[48173.07692307693, "c4-e"],[48317.307692307695, "c4-fs"],[48461.53846153846, "c4-d"],[49615.38461538461, "c5-cs"],[49759.61538461539, "c5-d"],[49903.846153846156, "c5-e"],[51057.692307692305, "c5-e"],[51634.61538461539, "c5-e"],[51923.07692307693, "c5-g"],[52211.53846153846, "c5-d"],[52500, "c5-cs"],[52788.46153846154, "c5-d"],[54230.769230769234, "c4-g"],[54375, "c4-a"],[54519.230769230766, "c4-b"],[55096.153846153844, "c4-b"],[55384.61538461539, "c4-b"],[55673.07692307693, "c5-cs"],[56250, "c4-a"],[56538.46153846154, "c4-e"],[57403.846153846156, "c4-g"],[57692.307692307695, "c4-d"],[60000, "c4-g"],[60576.92307692307, "c4-b"],[61153.84615384615, "c5-cs"],[61298.07692307693, "c5-d"],[61442.30769230769, "c5-e"],[62019.23076923077, "c5-e"],[63173.07692307693, "c5-g"],[63461.53846153846, "c5-e"],[63750, "c5-d"],[64326.92307692308, "c5-cs"],[64615.38461538461, "c5-d"],[64903.84615384615, "c4-b"],[65480.76923076923, "c5-cs"],[65625, "c4-b"],[65769.23076923078, "c4-a"],[68076.92307692308, "c5-cs"],[68942.30769230769, "c4-b"],[69230.76923076922, "c4-b"],[70096.15384615386, "c4-a"],[70384.61538461539, "c4-e"],[71250, "c4-fs"],[71394.23076923078, "c4-e"],[71538.46153846153, "c4-d"],[72403.84615384614, "c4-cs"],[72548.07692307692, "c4-e"],[72980.76923076922, "c4-e"],[73125, "c4-fs"],[73269.23076923078, "c4-d"],[74423.07692307692, "c5-d"],[74567.30769230769, "c5-e"],[74711.53846153847, "c5-fs"],[75865.38461538461, "c5-fs"],[76442.30769230769, "c5-fs"],[76730.76923076922, "c5-a"],[77019.23076923078, "c5-e"],[77307.69230769231, "c5-d"],[77596.15384615386, "c5-e"],[79038.46153846153, "c4-a"],[79182.69230769231, "c4-b"],[79326.92307692308, "c5-cs"],[79903.84615384614, "c5-cs"],[80192.30769230769, "c5-cs"],[80480.76923076922, "c5-d"],[81057.69230769231, "c4-b"],[81346.15384615386, "c4-fs"],[82211.53846153847, "c4-a"],[82500, "c4-e"],[84807.69230769231, "c4-a"],[85384.61538461539, "c5-cs"],[85961.53846153847, "c5-d"],[86105.76923076922, "c5-e"],[86250, "c5-fs"],[86826.92307692308, "c5-fs"],[87980.76923076922, "c5-a"],[88269.23076923078, "c5-fs"],[88557.69230769231, "c5-e"],[89134.61538461539, "c5-d"],[89423.07692307692, "c5-e"],[89711.53846153847, "c5-cs"],[90288.46153846153, "c5-d"],[90432.69230769231, "c5-cs"],[90576.92307692308, "c4-b"],[92884.61538461539, "c5-d"],[93750, "c5-cs"],[94038.46153846153, "c5-cs"],[94903.84615384614, "c4-b"],[95192.30769230769, "c4-fs"],[96057.69230769231, "c4-g"],[96201.92307692308, "c4-fs"],[96346.15384615386, "c4-e"],[97211.53846153847, "c4-d"],[97355.76923076922, "c4-fs"],[97788.46153846153, "c4-fs"],[97932.69230769231, "c4-g"],[98076.92307692308, "c4-e"],[99230.76923076922, "c5-cs"],[99375, "c5-d"],[99519.23076923078, "c5-e"],[100673.07692307692, "c5-e"],[101250, "c5-e"],[101538.46153846153, "c5-g"],[101826.92307692308, "c5-d"],[102115.38461538461, "c5-cs"],[102403.84615384614, "c5-d"],[103846.15384615386, "c4-g"],[103990.38461538461, "c4-a"],[104134.61538461539, "c4-b"],[104711.53846153847, "c4-b"],[105000, "c4-b"],[105288.46153846153, "c5-cs"],[105865.38461538461, "c4-a"],[106153.84615384614, "c4-e"],[107019.23076923078, "c4-g"],[107307.69230769231, "c4-d"],[109615.38461538461, "c4-g"],[110192.30769230769, "c4-b"],[110769.23076923078, "c5-cs"],[110913.46153846153, "c5-d"],[111057.69230769231, "c5-e"],[111634.61538461539, "c5-e"],[112788.46153846153, "c5-g"],[113076.92307692308, "c5-e"],[113365.38461538461, "c5-d"],[113942.30769230769, "c5-cs"],[114230.76923076922, "c5-d"],[114519.23076923078, "c4-b"],[115096.15384615386, "c5-cs"],[115240.38461538461, "c4-b"],[115384.61538461539, "c4-a"],[117692.30769230769, "c5-cs"],[118557.69230769231, "c4-b"],[118846.15384615386, "c4-b"],[119711.53846153847, "c4-a"],[120000, "c4-e"],[120865.38461538462, "c4-fs"],[121009.61538461538, "c4-e"],[121153.84615384614, "c4-d"],[122019.23076923078, "c4-cs"],[122163.46153846155, "c4-e"],[122596.15384615386, "c4-e"],[122740.38461538462, "c4-fs"],[122884.61538461538, "c4-d"],[124038.46153846155, "c5-cs"],[124182.6923076923, "c5-d"],[124326.92307692308, "c5-e"],[125480.76923076922, "c5-e"],[126057.6923076923, "c5-e"],[126346.15384615386, "c5-g"],[126634.61538461538, "c5-d"],[126923.07692307692, "c5-cs"],[127211.53846153845, "c5-d"],[128653.84615384616, "c4-g"],[128798.07692307694, "c4-a"],[128942.3076923077, "c4-b"],[129519.23076923078, "c4-b"],[129807.6923076923, "c4-b"],[130096.15384615384, "c5-cs"],[130673.07692307694, "c4-a"],[130961.53846153845, "c4-e"],[131826.92307692306, "c4-g"],[132115.38461538462, "c4-d"],[134423.07692307694, "c4-g"],[135000, "c4-b"],[135576.92307692306, "c5-cs"],[135721.15384615384, "c5-d"],[135865.38461538462, "c5-e"],[136442.30769230772, "c5-e"],[137596.15384615384, "c5-g"],[137884.61538461538, "c5-e"],[138173.07692307694, "c5-d"],[138750, "c5-cs"],[139038.46153846156, "c5-d"],[139326.92307692306, "c4-b"],[139903.84615384616, "c5-cs"],[140048.07692307694, "c4-b"],[140192.30769230772, "c4-a"],[142500, "c5-cs"],[143365.38461538462, "c4-b"],[143653.84615384616, "c4-b"],[144519.23076923078, "c4-a"],[144807.69230769228, "c4-e"],[145673.07692307694, "c4-fs"],[145817.30769230772, "c4-e"],[145961.53846153844, "c4-d"],[146826.92307692306, "c4-cs"],[146971.15384615384, "c4-e"],[147403.84615384616, "c4-e"],[147548.07692307694, "c4-fs"],[147692.30769230772, "c4-d"],[148846.15384615384, "c5-d"],[148990.38461538462, "c5-e"],[149134.61538461538, "c5-fs"],[150288.46153846156, "c5-fs"],[150865.38461538462, "c5-fs"],[151153.84615384616, "c5-a"],[151442.30769230772, "c5-e"],[151730.76923076922, "c5-d"],[152019.23076923078, "c5-e"],[153461.53846153844, "c4-a"],[153605.76923076922, "c4-b"],[153750, "c5-cs"],[154326.92307692306, "c5-cs"],[154615.38461538462, "c5-cs"],[154903.84615384616, "c5-d"],[155480.76923076922, "c4-b"],[155769.23076923078, "c4-fs"],[156634.61538461538, "c4-a"],[156923.07692307694, "c4-e"],[159230.76923076922, "c4-a"],[159807.69230769228, "c5-cs"]]}';

$thisCharId = 999;
*/

$transcriptionData = $_POST['transcription'];
$thisCharId = $_POST['chr'];


$transcriptionDataJson = json_decode($transcriptionData, true);


if((!isset($transcriptionDataJson['title'])) || ($transcriptionDataJson['title'] == '')) {
$songTitle = 'untitled';
} else {
  $songTitle = $transcriptionDataJson['title'];
}

    // save the song data:
$songPath = "../data/chr".$thisCharId."/music/".cleanURL($songTitle);
$version = 1;

do {

  if($version == 1) {
$filename = $songPath.".json";
  } else {
      $filename = $songPath.'-'.$version.".json";
      }
      $version++;

} while(file_exists($filename));


$fp = fopen($filename, 'w');
$writing = fwrite($fp, $transcriptionData);
fclose($fp);



header('Content-Type: application/json');
// return success or fail:

if($writing === false) {
// failed
  echo '{"success":false}';
} else {
echo '{"success":true,"filename":"'.$filename.'","songname":"'.cleanURL($songTitle).'"}';
}
?>