<?php

include($_SERVER['DOCUMENT_ROOT']."/includes/signalnoise.php");
include($_SERVER['DOCUMENT_ROOT']."/includes/connect.php");


$debug = false;
if(isset($_GET["debug"])) {
$debug = true;
}


if($debug) {
$chr=999;
$fakePost = '{"x":1272,"y":1176,"z":0,"dx":0,"dy":0,"breadcrumb":[[26,24],[26,24],[26,24],[26,24],[26,24],[26,24],[26,24],[26,24],[26,24],[26,24],[26,24],[26,24],[26,24],[26,24],[26,24],[26,24]],"width":20,"length":20,"centreX":40,"centreY":69,"speed":4,"spriteWidth":62,"spriteHeight":79,"isMoving":false,"facing":"n","animation":{"walk":{"length":1,"n":0,"e":1,"s":2,"w":3}},"currentMap":2,"tileX":26,"tileY":24,"bags":[{"type":20,"quality":100,"durability":100,"currentWear":0,"effectiveness":100,"colour":1,"enchanted":0,"hallmark":0,"inscription":""},{"type":17,"quality":100,"durability":100,"currentWear":0,"effectiveness":100,"colour":0,"enchanted":0,"hallmark":0,"inscription":""}],"inventory":{"0-0":{"type":19,"quantity":12,"quality":100,"durability":100,"currentWear":0,"effectiveness":100,"colour":0,"enchanted":0,"hallmark":0,"inscription":""},"0-1":{"type":5,"quantity":18,"quality":100,"durability":100,"currentWear":0,"effectiveness":100,"colour":4,"enchanted":0,"hallmark":0,"inscription":""},"0-2":{"type":5,"quantity":9,"quality":40,"durability":100,"currentWear":0,"effectiveness":50,"colour":4,"enchanted":0,"hallmark":0,"inscription":""},"0-3":{"type":19,"quantity":12,"quality":100,"durability":100,"currentWear":0,"effectiveness":100,"colour":0,"enchanted":0,"hallmark":0,"inscription":""},"0-9":{"type":12,"quantity":6,"quality":100,"durability":100,"currentWear":0,"effectiveness":100,"colour":1,"enchanted":0,"hallmark":0,"inscription":""},"0-8":{"type":12,"quantity":2,"quality":100,"durability":100,"currentWear":0,"effectiveness":100,"colour":6,"enchanted":0,"hallmark":0,"inscription":""},"0-4":{"type":9,"quantity":6,"quality":100,"durability":100,"currentWear":0,"effectiveness":100,"colour":16,"enchanted":0,"hallmark":0,"inscription":""},"0-5":{"type":10,"quantity":3,"quality":100,"durability":100,"currentWear":0,"effectiveness":45,"colour":8,"enchanted":0,"hallmark":0,"inscription":""},"0-6":{"type":8,"quantity":3,"quality":100,"durability":100,"currentWear":0,"effectiveness":45,"colour":0,"enchanted":0,"hallmark":0,"inscription":""},"0-7":{"type":11,"quantity":6,"quality":100,"durability":100,"currentWear":0,"effectiveness":100,"colour":0,"enchanted":0,"hallmark":0,"inscription":""},"0-17":{"type":5,"quantity":1,"quality":8,"durability":45,"currentWear":0,"effectiveness":100,"colour":4,"enchanted":0,"hallmark":0,"inscription":""},"p0-2":{"type":36,"quantity":1,"quality":100,"durability":100,"currentWear":0,"effectiveness":100,"colour":0,"enchanted":0,"hallmark":0,"inscription":""},"p0-3":{"type":55,"quantity":1,"quality":100,"durability":100,"currentWear":0,"effectiveness":100,"colour":0,"enchanted":0,"hallmark":0,"inscription":{"title":"A quest book","timeCreated":"1489052663553","content":"<section><h1>Chapter 1</h1><p>You\'ve just started a new quest. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Morbi non ultricies ipsum, a faucibus neque. Duis rutrum, nunc ac mattis vestibulum, lorem odio facilisis lectus, vel finibus tellus libero non quam. Ut sodales aliquet mauris, sit amet suscipit ante vulputate a. Nulla sed ex tempus lacus rutrum egestas sit amet et eros. Ut sit amet metus tortor. Nulla tincidunt luctus commodo. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae;</p><p>Curabitur ut est vitae quam vehicula efficitur nec at orci. Vivamus semper lectus nisi, et vehicula eros imperdiet viverra. Donec imperdiet magna lectus, sed tempus libero dapibus et. Ut non viverra nulla. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Curabitur turpis justo, vulputate a vehicula ut, pellentesque rutrum dolor. Proin et dolor dignissim, auctor purus vel, accumsan lorem. </p></section>"}},"0-10":{"type":33,"quantity":10,"quality":100,"durability":100,"currentWear":0,"effectiveness":100,"colour":5,"enchanted":0,"hallmark":0,"inscription":""},"0-12":{"type":40,"quantity":2,"quality":100,"durability":100,"currentWear":0,"effectiveness":100,"colour":16,"enchanted":0,"hallmark":0,"inscription":""},"0-16":{"type":40,"quantity":2,"quality":100,"durability":100,"currentWear":0,"effectiveness":100,"colour":5,"enchanted":0,"hallmark":0,"inscription":""},"1-1":{"type":21,"quantity":2,"quality":100,"durability":100,"currentWear":0,"effectiveness":100,"colour":0,"enchanted":0,"hallmark":0,"inscription":""},"1-2":{"type":21,"quantity":1,"quality":100,"durability":100,"currentWear":0,"effectiveness":100,"colour":0,"enchanted":0,"hallmark":0,"inscription":""},"1-4":{"type":29,"quantity":1,"quality":100,"durability":100,"currentWear":0,"effectiveness":100,"colour":0,"enchanted":0,"hallmark":0,"inscription":""},"1-5":{"type":30,"quantity":1,"quality":100,"durability":100,"currentWear":0,"effectiveness":100,"colour":0,"enchanted":0,"hallmark":0,"inscription":""},"1-6":{"type":13,"quantity":1,"quality":100,"durability":100,"currentWear":0,"effectiveness":100,"colour":0,"enchanted":0,"hallmark":0,"inscription":""},"0-11":{"type":20,"quantity":1,"quality":100,"durability":100,"currentWear":0,"effectiveness":100,"colour":0,"enchanted":0,"hallmark":0,"inscription":""},"1-7":{"type":33,"quantity":1,"quality":100,"durability":100,"currentWear":0,"effectiveness":100,"colour":16,"enchanted":0,"hallmark":0,"inscription":{"title":"An old book","timeCreated":"1489052663553","content":"<section><h1>Chapter 1</h1><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Morbi non ultricies ipsum, a faucibus neque. Duis rutrum, nunc ac mattis vestibulum, lorem odio facilisis lectus, vel finibus tellus libero non quam. Ut sodales aliquet mauris, sit amet suscipit ante vulputate a. Nulla sed ex tempus lacus rutrum egestas sit amet et eros. Ut sit amet metus tortor. Nulla tincidunt luctus commodo. Vestibulum ante ipsum primis in faucibus orci luctus et ultrices posuere cubilia Curae;</p><p>Curabitur ut est vitae quam vehicula efficitur nec at orci. Vivamus semper lectus nisi, et vehicula eros imperdiet viverra. Donec imperdiet magna lectus, sed tempus libero dapibus et. Ut non viverra nulla. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Curabitur turpis justo, vulputate a vehicula ut, pellentesque rutrum dolor. Proin et dolor dignissim, auctor purus vel, accumsan lorem. </p></section>"}},"1-8":{"type":31,"quantity":1,"quality":100,"durability":100,"currentWear":0,"effectiveness":100,"colour":0,"enchanted":0,"hallmark":0,"inscription":"","contains":[{"type":28,"quantity":1,"quality":100,"durability":100,"currentWear":0,"effectiveness":100,"colour":8,"enchanted":0,"hallmark":0,"inscription":""}]},"1-9":{"type":32,"quantity":1,"quality":100,"durability":100,"currentWear":0,"effectiveness":100,"colour":16,"enchanted":0,"hallmark":0,"inscription":{"title":"Another old book","timeCreated":"1489052678002","content":"<section><h1>Chapter 1</h1><p>\'Wow! wow! wow!\' While the Owl had the door of which was the Hatter.</p><p> \'You ought to eat or drink under the window, she suddenly spread out her hand on the floor, and a bright brass plate with the dream of Wonderland of long ago: and how she would keep, through all her wonderful Adventures, till she got to do,\' said the Pigeon in a natural way again.</p><p> That\'s all.\' \'In that direction,\' the Cat.</p></section><section><h1>Chapter 2</h1><p>\'Off with her friend.</p><p> When she got to go and get ready to sink into the book her sister sat still just as well as if she were looking over their slates; \'but it sounds uncommon nonsense.\' Alice didn\'t think that there was nothing so very tired of this.</p><p> I think it was,\' the March Hare said—\' \'I didn\'t!\' the March Hare and the beak— Pray how did you call it purring, not growling,\' said Alice.</p></section>"}},"1-18":{"type":53,"quantity":1,"quality":100,"durability":100,"currentWear":0,"effectiveness":100,"colour":0,"enchanted":0,"hallmark":0,"inscription":"","additional":"2|4|4","cooldown":500,"cooldownTimer":0},"1-19":{"type":32,"quantity":5,"quality":100,"durability":100,"currentWear":0,"effectiveness":100,"colour":16,"enchanted":0,"hallmark":0,"inscription":""},"1-10":{"type":41,"quantity":1,"quality":100,"durability":100,"currentWear":0,"effectiveness":100,"colour":0,"enchanted":0,"hallmark":0,"inscription":""}},"cards":[6,5,4,4,4,4,4,4,4,4,4,4,4,4,4],"stats":{"cardGamesWon":2,"cardGamesLost":4,"cardGamesDrawn":0,"numberOfcardsFlipped":8,"retinueMissionsCompleted":0,"retinueExplorationMissionsCompleted":0,"itemsCrafted":0,"itemsGathered":0},"settings":{"soundVolume":"1","musicVolume":"0"},"titlesEarned":[3,7],"activeTitle":3,"professionsKnown":[0,1],"recipesKnown":[0,1,2,3,10,11,7,6,12,13,8,14],"plantCrossesKnown":["1-5","5-23"],"totalGameTimePlayed":200,"fae":{"range":4950,"speed":4},"activePets":[0,1],"allPets":[{"name":"White Hen","src":"white-hen.png","width":20,"length":20,"spriteWidth":28,"spriteHeight":34,"centreX":19,"centreY":28,"tileX":26,"tileY":25,"facing":"n","speed":4,"inventorySize":6,"animation":{"walk":{"length":1,"n":0,"e":1,"s":2,"w":3}},"state":"wait","x":1272,"y":1224,"z":0,"dx":0,"dy":0,"foundPath":"","breadcrumb":[[26,25],[26,25],[26,25],[26,25],[26,25],[26,25],[26,25],[26,25],[26,25],[26,25],[26,25],[26,25],[26,25],[26,25],[26,25],[26,25]]},{"name":"Brown Hen","src":"brown-hen.png","width":20,"length":20,"spriteWidth":28,"spriteHeight":34,"centreX":19,"centreY":28,"tileX":26,"tileY":26,"facing":"n","speed":4,"inventorySize":6,"animation":{"walk":{"length":1,"n":0,"e":1,"s":2,"w":3}},"state":"queuing","x":1272,"y":1272,"z":0,"dx":0,"dy":0,"foundPath":"","breadcrumb":[[26,26],[26,26],[26,26],[26,26],[26,26],[26,26],[26,26],[26,26],[26,26],[26,26],[26,26],[26,26],[26,26],[26,26],[26,26],[26,26]]}],"currency":{"money":3412510,"cardDust":12,"keys":[]},"npcsFollowing":[],"lineOfSightRange":20,"retinueMapAreasRevealed":["-3,2","-2,1","-2,2","-1,1"],"collections":{},"actions":[["Harmful extraction","gather",1,{"time":1500,"purity":10,"quality":-40}],["Gentle extraction","gather",1,{"time":1500,"purity":10,"quality":-50}],"-",["Cross pollinate plants","plant-breeding",null,{}],["Dowse for metals","dowse",4,{"range":30}],["Survey for metals","survey",4,{"time":-500}],["Mineral extraction","gather",4,{"time":1500,"purity":10,"quality":-40}],"-","-",["Mount","mount",null,{"pet-name":"brown horse"}]],"crafting":{"0":{"name":"Dyeing","recipes":{"0":{"components":[{"type":11,"quantity":1,"minQuality":0,"influence":{"effectiveness":0,"durability":0,"quality":0}},{"type":"mrdt","quantity":1,"minQuality":0,"influence":{"effectiveness":70}},{"type":2,"quantity":2,"minQuality":0,"influence":{"quality":70}}],"creates":"12","hiddenCreates":"","defaultColour":"1","prerequisite":"0","tier":"10","recipeName":"Crimson Dye","imageId":"12-crimson","recipeDescription":"A standard pigment dye."},"1":{"components":[{"type":11,"quantity":1,"minQuality":0,"influence":{"effectiveness":0,"durability":0,"quality":0}},{"type":"mrdt","quantity":1,"minQuality":0,"influence":{"effectiveness":70}},{"type":3,"quantity":2,"minQuality":0,"influence":{"quality":70}}],"creates":"12","hiddenCreates":"","defaultColour":"2","prerequisite":"0","tier":"10","recipeName":"Yellow Dye","imageId":"12-yellow","recipeDescription":"A standard pigment dye."},"2":{"components":[{"type":11,"quantity":1,"minQuality":0,"influence":{"effectiveness":0,"durability":0,"quality":0}},{"type":"mrdt","quantity":1,"minQuality":0,"influence":{"effectiveness":70}},{"type":5,"quantity":2,"minQuality":0,"influence":{"quality":70}}],"creates":"12","hiddenCreates":"","defaultColour":"4","prerequisite":"0","tier":"10","recipeName":"Blue Dye","imageId":"12-blue","recipeDescription":"A standard pigment dye."},"3":{"components":[{"type":11,"quantity":1,"minQuality":0,"influence":{"effectiveness":0,"durability":0,"quality":0}},{"type":"mrdt","quantity":1,"minQuality":0,"influence":{"effectiveness":70}},{"type":24,"quantity":2,"minQuality":0,"influence":{"quality":70}}],"creates":"7","hiddenCreates":"","defaultColour":"","prerequisite":"0","tier":"10","recipeName":"Archil","imageId":"7","recipeDescription":"A purple dye."},"6":{"components":[{"type":"dye","quantity":2,"minQuality":0,"influence":null}],"creates":"12","hiddenCreates":"","defaultColour":"","prerequisite":"0","tier":"0","recipeName":"Mix dyes","imageId":"12","recipeDescription":"Mix 2 or more dyes to create new colours."},"7":{"components":[{"type":27,"quantity":1,"minQuality":0,"influence":null}],"creates":"26","hiddenCreates":"","defaultColour":"","prerequisite":"0","tier":"10","recipeName":"Burn Wood","imageId":"26","recipeDescription":"Produce Wood Ash by burning"},"8":{"components":[{"type":"dye","quantity":1,"minQuality":0,"influence":null},{"type":14,"quantity":1,"minQuality":0,"influence":null}],"creates":"14","hiddenCreates":"11","defaultColour":"","prerequisite":"0","tier":"0","recipeName":"Dye Linen","imageId":"14","recipeDescription":"Colour some linen."},"14":{"components":[{"type":"dye","quantity":1,"minQuality":0,"influence":null},{"type":15,"quantity":1,"minQuality":0,"influence":null}],"creates":"15","hiddenCreates":"11","defaultColour":"","prerequisite":"0","tier":"0","recipeName":"Dye Wool","imageId":"15","recipeDescription":"Colour some wool."}},"sortOrder":[3,2,7,0,8,14,6,1],"filters":{"All":["3","2","7","0","8","14","6","1"],"Dyer\'s Provisions":["3","2","0","6","1"],"Miscellaneous":["7"],"Tailor\'s Provisions":["8","14"]},"filterOrder":["All","Dyer\'s Provisions","Miscellaneous","Tailor\'s Provisions"]},"1":{"name":"Weaving","recipes":{"10":{"components":[{"type":1,"quantity":1,"minQuality":0,"influence":null}],"creates":"14","hiddenCreates":"","defaultColour":"","prerequisite":"0","tier":"0","recipeName":"Linen","imageId":"14","recipeDescription":"A useful fabric."},"11":{"components":[{"type":15,"quantity":1,"minQuality":0,"influence":null}],"creates":"16","hiddenCreates":"","defaultColour":"","prerequisite":"0","tier":"0","recipeName":"Woolen Yarn","imageId":"16","recipeDescription":"Spun wool."},"13":{"components":[{"type":15,"quantity":1,"minQuality":0,"influence":null}],"creates":"49","hiddenCreates":"","defaultColour":"","prerequisite":"0","tier":"0","recipeName":"Worsted Yarn","imageId":"49","recipeDescription":"Thicker, spun wool."}},"sortOrder":[10,11,13],"filters":{"All":["10","11","13"],"Tailor\'s Provisions":["10","11","13"]},"filterOrder":["All","Tailor\'s Provisions"]},"4":{"name":"Ink Making","recipes":{"12":{"components":[{"type":37,"quantity":1,"minQuality":0,"influence":null},{"type":38,"quantity":1,"minQuality":0,"influence":null},{"type":39,"quantity":1,"minQuality":0,"influence":null}],"creates":"40","hiddenCreates":"","defaultColour":"16","prerequisite":"0","tier":"0","recipeName":"Black Ink","imageId":"40-black","recipeDescription":""}},"sortOrder":[12],"filters":{"All":["12"],"Miscellaneous":["12"]},"filterOrder":["All","Miscellaneous"]}},"isox":912,"isoy":600}';
$postedData = json_decode($fakePost,true); 
} else {
$postedData = json_decode($_POST['postData'],true);
$chr = $_POST['chr'];
}




$fieldsToUpdate = ['currentMap', 'tileX', 'tileY', 'bags', 'inventory', 'titlesEarned', 'activeTitle', 'professionsKnown', 'recipesKnown', 'plantCrossesKnown', 'totalGameTimePlayed', 'cards', 'stats', 'settings', 'fae', 'activePets', 'allPets', 'currency', 'npcsFollowing', 'lineOfSightRange', 'retinueMapAreasRevealed', 'collections', 'actions'];

$query = "UPDATE tblcharacters SET ";
// loop through and add all fields:

for($i=0;$i<count($fieldsToUpdate); $i++) {
  $query .= $fieldsToUpdate[$i]." = '".mysqli_real_escape_string($connection,json_encode($postedData[($fieldsToUpdate[$i])]))."', ";
}

// remove last comma:
$query = rtrim($query,', ');

$query .= " where charID = '".$chr."'";



if(!$debug) {

$result = mysqli_query($connection, $query);
 $returnedResult = "false";
    if($result) {
        $returnedResult = "true";
    }


header('Content-Type: application/json');
// return success or fail:
echo '{"success":"'.$returnedResult.'"}';


} else {
  echo $query;
}




?>