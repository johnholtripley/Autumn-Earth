"use strict";function loadGlobalMapData(){getJSON("/data/world-map.json",function(a){worldMap=a.worldMap},function(a){loadGlobalMapData()})}self.importScripts("shared-worker-functions.min.js");var thisMapData,visibleMaps,mapTilesY,mapTilesX,thisAgentsIndex,uncheckedTiles,nodes,firstKey,worldMap="";loadGlobalMapData();const tileW=48;var isOverWorldMap=!0;const worldMapTileLength=50;function isATerrainCollision(a,i){var s=getLocalCoordinatesX(a),e=getLocalCoordinatesX(i);if(isOverWorldMap){if(a<0||i<0||a>=worldMapTileLength*worldMap[0].length||i>=worldMapTileLength*worldMap.length)return 1}else if(s<0||e<0||s>=mapTilesX||e>=mapTilesY)return 1;var t=findMapNumberFromGlobalCoordinates(a,i);switch(thisMapData[t].collisions[e][s]){case 1:return 1;case"<":case">":case"^":case"v":case"d":default:return 0}}function addNode(a,i,s,e,t){if(!isATerrainCollision(i,s)){var l=Math.abs(i-e)+Math.abs(s-t),n=a.cost+1,p=n+l;if(void 0===nodes[i+"-"+s]){nodes[i+"-"+s]={x:i,y:s,parentX:a.x,parentY:a.y,cost:n,summedCost:p};for(var h=0;h<uncheckedTiles.length;h++)if(p<uncheckedTiles[h].summedCost){uncheckedTiles.splice(h,0,nodes[i+"-"+s]);break}h>=uncheckedTiles.length&&uncheckedTiles.push(nodes[i+"-"+s])}else n<nodes[i+"-"+s].cost&&(nodes[i+"-"+s].cost=p,nodes[i+"-"+s].summedCost=n,nodes[i+"-"+s].parentX=a.x,nodes[i+"-"+s].parentY=a.y)}}function findPath(a,i,s,e){uncheckedTiles=[];var t,l=Math.abs(a-s)+Math.abs(i-e);(nodes={})[a+"-"+i]={x:a,y:i,parentX:void 0,parentY:void 0,cost:0,summedCost:l},uncheckedTiles.push(nodes[a+"-"+i]);for(var n=!1,p=0;p<visibleMaps.length;p++){for(var h=0;h<thisMapData[visibleMaps[p]].npcs.length;h++)thisMapData[visibleMaps[p]].npcs.uniqueIndex!=thisAgentsIndex&&"-"==thisMapData[visibleMaps[p]].npcs[h].movement[thisMapData[visibleMaps[p]].npcs[h].movementIndex]&&thisMapData[visibleMaps[p]].npcs[h].isCollidable&&(thisMapData[visibleMaps[p]].npcs[h].tileX==s&&thisMapData[visibleMaps[p]].npcs[h].tileY==e||(thisMapData[visibleMaps[p]].collisions[thisMapData[visibleMaps[p]].npcs[h].tileY][thisMapData[visibleMaps[p]].npcs[h].tileX]=1));for(h=0;h<thisMapData[visibleMaps[p]].items.length;h++){if(thisMapData[visibleMaps[p]].collisions[thisMapData[visibleMaps[p]].items[h].tileY][thisMapData[visibleMaps[p]].items[h].tileX]=1,thisMapData[visibleMaps[p]].items[h].width>tileW)for(var o=1;o<thisMapData[visibleMaps[p]].items[h].width/tileW;o++)thisMapData[visibleMaps[p]].collisions[thisMapData[visibleMaps[p]].items[h].tileY][thisMapData[visibleMaps[p]].items[h].tileX+o]=1,thisMapData[visibleMaps[p]].collisions[thisMapData[visibleMaps[p]].items[h].tileY][thisMapData[visibleMaps[p]].items[h].tileX-o]=1;if(thisMapData[visibleMaps[p]].items[h].height>tileW)for(o=1;o<thisMapData[visibleMaps[p]].items[h].height/tileW;o++)thisMapData[visibleMaps[p]].collisions[thisMapData[visibleMaps[p]].items[h].tileY+o][thisMapData[visibleMaps[p]].items[h].tileX]=1,thisMapData[visibleMaps[p]].collisions[thisMapData[visibleMaps[p]].items[h].tileY-o][thisMapData[visibleMaps[p]].items[h].tileX]=1}if(void 0!==thisMapData[visibleMaps[p]].innerDoors)for(var h in thisMapData[visibleMaps[p]].innerDoors)thisMapData[visibleMaps[p]].innerDoors[h].isOpen||(thisMapData[visibleMaps[p]].collisions[thisMapData[visibleMaps[p]].innerDoors[h].tileY][thisMapData[visibleMaps[p]].innerDoors[h].tileX]=1)}do{if((t=uncheckedTiles.shift()).x==s&&t.y==e){n=!0;for(var M=[];void 0!==t.parentX;)M.unshift([t.parentX,t.parentY]),t=nodes[t.parentX+"-"+t.parentY];var r=[];for(h=1;h<M.length;h++)M[h][0]==M[h-1][0]?M[h][1]>M[h-1][1]?r.push("s"):r.push("n"):M[h][0]>M[h-1][0]?r.push("e"):r.push("w");r.push("pathEnd")}else addNode(t,t.x+1,t.y,s,e),addNode(t,t.x-1,t.y,s,e),addNode(t,t.x,t.y+1,s,e),addNode(t,t.x,t.y-1,s,e)}while(uncheckedTiles.length>0&&!n);return uncheckedTiles=null,thisMapData=null,visibleMaps=null,nodes=null,thisAgentsIndex=null,n?r:["-","pathEnd"]}onmessage=function(a){if(""!=worldMap)switch(a.data[0]){case"tile":var i=a.data[1],s=a.data[2],e=a.data[3];for(firstKey in thisMapData=a.data[4],visibleMaps=a.data[5],thisMapData)break;mapTilesY=thisMapData[firstKey].terrain.length,mapTilesX=thisMapData[firstKey].terrain[0].length,postMessage([e.uniqueIndex,findPath(e.tileX,e.tileY,i,s),i+"-"+s]);break;case"shop":var t;e=a.data[1];for(firstKey in thisMapData=a.data[2],visibleMaps=a.data[3],thisMapData)break;mapTilesY=thisMapData[firstKey].terrain.length,mapTilesX=thisMapData[firstKey].terrain[0].length,thisAgentsIndex=e.uniqueIndex;for(var l=[],n=[],p=0;p<visibleMaps.length;p++)for(var h=0;h<thisMapData[visibleMaps[p]].npcs.length;h++)thisMapData[visibleMaps[p]].npcs[h].uniqueIndex!=thisAgentsIndex&&(t=thisMapData[visibleMaps[p]].npcs[h]).speech&&"shop"==t.speech[t.speechIndex][1]&&(l.push(h),n.push(visibleMaps[p]));if(l.length>0){var o,M;do{M=Math.floor(Math.random()*l.length),o=thisMapData[n[M]].npcs[l[M]].tileX+"-"+thisMapData[n[M]].npcs[l[M]].tileY}while(o==e.lastTargetDestination);postMessage([e.uniqueIndex,findPath(e.tileX,e.tileY,thisMapData[n[M]].npcs[l[M]].tileX,thisMapData[n[M]].npcs[l[M]].tileY),o])}else postMessage([e.uniqueIndex,["-","pathEnd"],""]);break;case"petToHero":e=a.data[1];for(firstKey in thisMapData=a.data[2],visibleMaps=a.data[3],thisAgentsIndex=-1,thisMapData)break;mapTilesY=thisMapData[firstKey].terrain.length,mapTilesX=thisMapData[firstKey].terrain[0].length,postMessage(["pet",a.data[5],findPath(e.tileX,e.tileY,a.data[3],a.data[4])]);break;case"npcFindFollowing":e=a.data[1];for(firstKey in thisMapData=a.data[2],visibleMaps=a.data[3],thisMapData)break;mapTilesY=thisMapData[firstKey].terrain.length,mapTilesX=thisMapData[firstKey].terrain[0].length,thisAgentsIndex=e.uniqueIndex,postMessage([e.uniqueIndex,findPath(e.tileX,e.tileY,e.following.tileX,e.following.tileY)])}};