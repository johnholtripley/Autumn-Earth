"use strict";function isATerrainCollision(e,s){if(0>e||0>s||e>=mapTilesX||s>=mapTilesY)return 1;switch(thisMapData.collisions[s][e]){case 1:return 1;default:return 0}}function addNode(e,s,a,t,n){if(!isATerrainCollision(s,a)){for(var i=!1,h=0;h<thisMapData.items.length;h++)thisMapData.items[h].tileX==s&&thisMapData.items[h].tileY==a&&(i=!0);for(var h=0;h<thisMapData.npcs.length;h++)h!=thisNPCsIndex&&"-"==thisMapData.npcs[h].movement[thisMapData.npcs[h].movementIndex]&&(s!=t||a!=n)&&parseInt(thisMapData.npcs[h].tileX)==parseInt(s)&&parseInt(thisMapData.npcs[h].tileY)==parseInt(a)&&(i=!0);if(!i){var p=Math.abs(s-t)+Math.abs(a-n),d=e.cost+1,o=d+p;if("undefined"==typeof nodes[s+"-"+a]){nodes[s+"-"+a]={x:s,y:a,parentX:e.x,parentY:e.y,cost:d,summedCost:o};for(var h=0;h<uncheckedTiles.length;h++)if(o<uncheckedTiles[h].summedCost){uncheckedTiles.splice(h,0,nodes[s+"-"+a]);break}h>=uncheckedTiles.length&&uncheckedTiles.push(nodes[s+"-"+a])}else d<nodes[s+"-"+a].cost&&(nodes[s+"-"+a].cost=o,nodes[s+"-"+a].summedCost=d,nodes[s+"-"+a].parentX=e.x,nodes[s+"-"+a].parentY=e.y)}}}function findPath(e,s,a,t){console.log("start path: "+e+", "+s),console.log("end path: "+a+", "+t),uncheckedTiles=[];var n=Math.abs(e-a)+Math.abs(s-t);nodes={},nodes[e+"-"+s]={x:e,y:s,parentX:void 0,parentY:void 0,cost:0,summedCost:n},uncheckedTiles.push(nodes[e+"-"+s]);var i,h=!1;do if(i=uncheckedTiles.shift(),i.x==a&&i.y==t){h=!0;for(var p=[];"undefined"!=typeof i.parentX;)p.unshift([i.parentX,i.parentY]),i=nodes[i.parentX+"-"+i.parentY];for(var d=[],o=1;o<p.length;o++)p[o][0]==p[o-1][0]?p[o][1]>p[o-1][1]?d.push("s"):d.push("n"):p[o][0]>p[o-1][0]?d.push("e"):d.push("w");d.push("pathEnd"),console.log(d.join(", "))}else addNode(i,i.x+1,i.y,a,t),addNode(i,i.x-1,i.y,a,t),addNode(i,i.x,i.y+1,a,t),addNode(i,i.x,i.y-1,a,t);while(uncheckedTiles.length>0&&!h);return uncheckedTiles=null,thisMapData=null,nodes=null,thisNPCsIndex=null,h?d:["-","pathEnd"]}var thisMapData,mapTilesY,mapTilesX,thisNPCsIndex,uncheckedTiles,nodes;onmessage=function(e){switch(e.data[0]){case"shop":var s=e.data[1];thisMapData=e.data[2],mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length,thisNPCsIndex=thisMapData.npcs.map(function(e){return e.name}).indexOf(s.name);for(var a,t=[],n=0;n<thisMapData.npcs.length;n++)n!=thisNPCsIndex&&(a=thisMapData.npcs[n],"undefined"!=typeof a.speech&&"undefined"!=typeof a.speechIndex&&"shop"==a.speech[a.speechIndex][1]&&t.push(n));if(t.length>0){var i,h;do h=Math.floor(Math.random()*t.length),i=thisMapData.npcs[t[h]].tileX+"-"+thisMapData.npcs[t[h]].tileY;while(i==s.lastTargetDestination);postMessage([s.name,findPath(s.tileX,s.tileY,thisMapData.npcs[t[h]].tileX,thisMapData.npcs[t[h]].tileY),i])}else postMessage([s.name,["-","pathEnd"],""])}};