"use strict";function loadGlobalMapData(){getJSON("/data/world-map.json",function(a){worldMap=a.worldMap},function(a){loadGlobalMapData()})}self.importScripts("shared-worker-functions.min.js");var thisMapData,visibleMaps,mapTilesY,mapTilesX,thisAgentsIndex,uncheckedTiles,nodes,firstKey,isOverWorldMap,worldMap="";loadGlobalMapData();const tileW=48,worldMapTileLength=50;function isATerrainCollision(a,s){var e=getLocalCoordinatesX(a),i=getLocalCoordinatesX(s);if(isOverWorldMap){if(a<0||s<0||a>=worldMapTileLength*worldMap[0].length||s>=worldMapTileLength*worldMap.length)return 1}else if(e<0||i<0||e>=mapTilesX||i>=mapTilesY)return 1;var t=findMapNumberFromGlobalCoordinates(a,s);switch(thisMapData[t].collisions[i][e]){case 1:return 1;case"<":case">":case"^":case"v":case"d":default:return 0}}function addNode(a,s,e,i,t){if(!isATerrainCollision(s,e)){var n=Math.abs(s-i)+Math.abs(e-t),l=a.cost+1,p=l+n;if(void 0===nodes[s+"-"+e]){nodes[s+"-"+e]={x:s,y:e,parentX:a.x,parentY:a.y,cost:l,summedCost:p};for(var o=0;o<uncheckedTiles.length;o++)if(p<uncheckedTiles[o].summedCost){uncheckedTiles.splice(o,0,nodes[s+"-"+e]);break}o>=uncheckedTiles.length&&uncheckedTiles.push(nodes[s+"-"+e])}else l<nodes[s+"-"+e].cost&&(nodes[s+"-"+e].cost=p,nodes[s+"-"+e].summedCost=l,nodes[s+"-"+e].parentX=a.x,nodes[s+"-"+e].parentY=a.y)}}function findPath(a,s,e,i){uncheckedTiles=[];var t,n=Math.abs(a-e)+Math.abs(s-i);(nodes={})[a+"-"+s]={x:a,y:s,parentX:void 0,parentY:void 0,cost:0,summedCost:n},uncheckedTiles.push(nodes[a+"-"+s]);for(var l,p,o=!1,r=0;r<visibleMaps.length;r++){for(var h=0;h<thisMapData[visibleMaps[r]].npcs.length;h++)thisMapData[visibleMaps[r]].npcs.uniqueIndex!=thisAgentsIndex&&"-"==thisMapData[visibleMaps[r]].npcs[h].movement[thisMapData[visibleMaps[r]].npcs[h].movementIndex]&&thisMapData[visibleMaps[r]].npcs[h].isCollidable&&(thisMapData[visibleMaps[r]].npcs[h].tileX==e&&thisMapData[visibleMaps[r]].npcs[h].tileY==i||(l=getLocalCoordinatesX(thisMapData[visibleMaps[r]].npcs[h].tileX),p=getLocalCoordinatesY(thisMapData[visibleMaps[r]].npcs[h].tileY),thisMapData[visibleMaps[r]].collisions[p][l]=1));for(h=0;h<thisMapData[visibleMaps[r]].items.length;h++){if(l=getLocalCoordinatesX(thisMapData[visibleMaps[r]].items[h].tileX),p=getLocalCoordinatesY(thisMapData[visibleMaps[r]].items[h].tileY),thisMapData[visibleMaps[r]].collisions[p][l]=1,thisMapData[visibleMaps[r]].items[h].width>tileW)for(var d=1;d<thisMapData[visibleMaps[r]].items[h].width/tileW;d++)thisMapData[visibleMaps[r]].collisions[p][l+d]=1,thisMapData[visibleMaps[r]].collisions[p][l-d]=1;if(thisMapData[visibleMaps[r]].items[h].height>tileW)for(d=1;d<thisMapData[visibleMaps[r]].items[h].height/tileW;d++)thisMapData[visibleMaps[r]].collisions[p+d][l]=1,thisMapData[visibleMaps[r]].collisions[p-d][l]=1}if(void 0!==thisMapData[visibleMaps[r]].innerDoors)for(var h in thisMapData[visibleMaps[r]].innerDoors)thisMapData[visibleMaps[r]].innerDoors[h].isOpen||(l=getLocalCoordinatesX(thisMapData[visibleMaps[r]].innerDoors[h].tileX),p=getLocalCoordinatesY(thisMapData[visibleMaps[r]].innerDoors[h].tileY),thisMapData[visibleMaps[r]].collisions[p][l]=1)}do{if((t=uncheckedTiles.shift()).x==e&&t.y==i){o=!0;for(var M=[];void 0!==t.parentX;)M.unshift([t.parentX,t.parentY]),t=nodes[t.parentX+"-"+t.parentY];var c=[];for(h=1;h<M.length;h++)M[h][0]==M[h-1][0]?M[h][1]>M[h-1][1]?c.push("s"):c.push("n"):M[h][0]>M[h-1][0]?c.push("e"):c.push("w");c.push("pathEnd")}else addNode(t,t.x+1,t.y,e,i),addNode(t,t.x-1,t.y,e,i),addNode(t,t.x,t.y+1,e,i),addNode(t,t.x,t.y-1,e,i)}while(uncheckedTiles.length>0&&!o);return uncheckedTiles=null,thisMapData=null,visibleMaps=null,nodes=null,thisAgentsIndex=null,o?c:["-","pathEnd"]}onmessage=function(a){if(""!=worldMap)switch(a.data[0]){case"tile":var s=a.data[1],e=a.data[2],i=a.data[3];for(firstKey in thisMapData=a.data[4],visibleMaps=a.data[5],isOverWorldMap=a.data[6],thisMapData)break;mapTilesY=thisMapData[firstKey].terrain.length,mapTilesX=thisMapData[firstKey].terrain[0].length,postMessage([i.uniqueIndex,findPath(i.tileX,i.tileY,s,e),s+"-"+e]);break;case"shop":var t;i=a.data[1];for(firstKey in thisMapData=a.data[2],visibleMaps=a.data[3],isOverWorldMap=a.data[4],thisMapData)break;mapTilesY=thisMapData[firstKey].terrain.length,mapTilesX=thisMapData[firstKey].terrain[0].length,thisAgentsIndex=i.uniqueIndex;for(var n=[],l=[],p=0;p<visibleMaps.length;p++)for(var o=0;o<thisMapData[visibleMaps[p]].npcs.length;o++)thisMapData[visibleMaps[p]].npcs[o].uniqueIndex!=thisAgentsIndex&&(t=thisMapData[visibleMaps[p]].npcs[o]).speech&&"shop"==t.speech[t.speechIndex][1]&&(n.push(o),l.push(visibleMaps[p]));if(n.length>0){var r,h;do{h=Math.floor(Math.random()*n.length),r=thisMapData[l[h]].npcs[n[h]].tileX+"-"+thisMapData[l[h]].npcs[n[h]].tileY}while(r==i.lastTargetDestination);postMessage([i.uniqueIndex,findPath(i.tileX,i.tileY,thisMapData[l[h]].npcs[n[h]].tileX,thisMapData[l[h]].npcs[n[h]].tileY),r])}else postMessage([i.uniqueIndex,["-","pathEnd"],""]);break;case"petToHero":i=a.data[1];for(firstKey in thisMapData=a.data[2],visibleMaps=a.data[6],isOverWorldMap=a.data[7],thisAgentsIndex=-1,thisMapData)break;mapTilesY=thisMapData[firstKey].terrain.length,mapTilesX=thisMapData[firstKey].terrain[0].length,postMessage(["pet",a.data[5],findPath(i.tileX,i.tileY,a.data[3],a.data[4])]);break;case"npcFindFollowing":i=a.data[1];for(firstKey in thisMapData=a.data[2],visibleMaps=a.data[3],isOverWorldMap=a.data[4],thisMapData)break;mapTilesY=thisMapData[firstKey].terrain.length,mapTilesX=thisMapData[firstKey].terrain[0].length,thisAgentsIndex=i.uniqueIndex,postMessage([i.uniqueIndex,findPath(i.tileX,i.tileY,i.following.tileX,i.following.tileY)])}};