function isATerrainCollision(e,a){if(0>e||0>a||e>=mapTilesX||a>=mapTilesY)return 1;switch(thisMapData.collisions[a][e]){case 1:return 1;default:return 0}}function addNode(e,a,t,s,i){if(!isATerrainCollision(a,t)){for(var n=!1,h=0;h<thisMapData.items.length;h++)thisMapData.items[h].tileX==a&&thisMapData.items[h].tileY==t&&(n=!0);if(!n&&"undefined"!=typeof nodes[a+"-"+t]){var l=Math.abs(a-s)+Math.abs(t-i);nodes[a+"-"+t]={x:a,y:t,parentX:e.x,parentY:e.y,cost:l};for(var h=0;h<uncheckedTiles.length;h++)if(l<uncheckedTiles[h].cost){uncheckedTiles.splice(h,0,nodes[a+"-"+t]);break}h>=uncheckedTiles.length&&uncheckedTiles.push(nodes[a+"-"+t])}}}function findPath(e,a,t,s){uncheckedTiles=[];var i=Math.abs(e-t)+Math.abs(a-s);nodes={},nodes[e+"-"+a]={x:e,y:a,parentX:null,parentY:null,cost:i},uncheckedTiles.push(nodes[e+"-"+a]);var n,h=!1;do n=uncheckedTiles.shift(),n.x==t&&n.y==s?h=!0:(addNode(n,n.x+1,n.y,t,s),addNode(n,n.x-1,n.y,t,s),addNode(n,n.x,n.y+1,t,s),addNode(n,n.x,n.y-1,t,s));while(uncheckedTiles.length>0&&!h);return delete uncheckedTiles,delete thisMapData,delete nodes,["n","n","e","pathEnd"]}onmessage=function(e){switch(e.data[0]){case"shop":console.log("web worker is looking for a shop");var a=e.data[1];thisMapData=e.data[2],mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length;for(var t,s=thisMapData.npcs.map(function(e){return e.name}).indexOf(a.name),i=[],n=0;n<thisMapData.npcs.length;n++)n!=s&&(t=thisMapData.npcs[n],t.speech&&"shop"==t.speech[t.speechIndex][1]&&i.push(n));if(i.length>0){for(var h,l,p,c=9999999,n=0;n<i.length;n++)h=thisMapData.npcs[i[n]].tileX+"-"+thisMapData.npcs[i[n]].tileY,h!=a.lastTargetDestination&&(l=Math.sqrt((a.tileX-thisMapData.npcs[i[n]].tileX)*(a.tileX-thisMapData.npcs[i[n]].tileX)+(a.tileY-thisMapData.npcs[i[n]].tileY)*(a.tileY-thisMapData.npcs[i[n]].tileY)),c>l&&(p=n));var d=thisMapData.npcs[i[p]].tileX+"-"+thisMapData.npcs[i[p]].tileY;postMessage([a.name,findPath(a.tileX,a.tileY,thisMapData.npcs[i[p]].tileX,thisMapData.npcs[i[p]].tileY),d])}else postMessage([a.name,["-","pathEnd"],""])}};