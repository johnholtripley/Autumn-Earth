function isATerrainCollision(e,t){if(0>e||0>t||e>=mapTilesX||t>=mapTilesY)return 1;switch(thisMapData.collisions[t][e]){case 1:return 1;default:return 0}}function addNode(e,t,a,s,n){if(!isATerrainCollision(t,a)){for(var i=!1,h=0;h<thisMapData.items.length;h++)thisMapData.items[h].tileX==t&&thisMapData.items[h].tileY==a&&(i=!0);for(var h=0;h<thisMapData.npcs.length;h++)h!=thisNPCsIndex&&(t!=s||a!=n)&&parseInt(thisMapData.npcs[h].tileX)==parseInt(t)&&parseInt(thisMapData.npcs[h].tileY)==parseInt(a)&&(i=!0);if(!i){var d=Math.abs(t-s)+Math.abs(a-n),p=e.cost+1,o=p+d;if("undefined"==typeof nodes[t+"-"+a]){nodes[t+"-"+a]={x:t,y:a,parentX:e.x,parentY:e.y,cost:p,summedCost:o};for(var h=0;h<uncheckedTiles.length;h++)if(o<uncheckedTiles[h].summedCost){uncheckedTiles.splice(h,0,nodes[t+"-"+a]);break}h>=uncheckedTiles.length&&uncheckedTiles.push(nodes[t+"-"+a])}else p<nodes[t+"-"+a].cost&&(nodes[t+"-"+a].cost=o,nodes[t+"-"+a].summedCost=p,nodes[t+"-"+a].parentX=e.x,nodes[t+"-"+a].parentY=e.y)}}}function findPath(e,t,a,s){uncheckedTiles=[];var n=Math.abs(e-a)+Math.abs(t-s);nodes={},nodes[e+"-"+t]={x:e,y:t,parentX:void 0,parentY:void 0,cost:0,summedCost:n},uncheckedTiles.push(nodes[e+"-"+t]);var i,h=!1;do if(i=uncheckedTiles.shift(),i.x==a&&i.y==s){h=!0;for(var d=[];"undefined"!=typeof i.parentX;)d.unshift([i.parentX,i.parentY]),i=nodes[i.parentX+"-"+i.parentY];for(var p=[],o=1;o<d.length;o++)d[o][0]==d[o-1][0]?d[o][1]>d[o-1][1]?p.push("s"):p.push("n"):d[o][0]>d[o-1][0]?p.push("e"):p.push("w");p.push("pathEnd")}else addNode(i,i.x+1,i.y,a,s),addNode(i,i.x-1,i.y,a,s),addNode(i,i.x,i.y+1,a,s),addNode(i,i.x,i.y-1,a,s);while(uncheckedTiles.length>0&&!h);return delete uncheckedTiles,delete thisMapData,delete nodes,delete thisNPCsIndex,h?p:["-","pathEnd"]}onmessage=function(e){switch(e.data[0]){case"shop":var t=e.data[1];thisMapData=e.data[2],mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length,thisNPCsIndex=thisMapData.npcs.map(function(e){return e.name}).indexOf(t.name);for(var a,s=[],n=0;n<thisMapData.npcs.length;n++)n!=thisNPCsIndex&&(a=thisMapData.npcs[n],a.speech&&"shop"==a.speech[a.speechIndex][1]&&s.push(n));if(s.length>0){var i,h;do h=Math.floor(Math.random()*s.length),i=thisMapData.npcs[s[h]].tileX+"-"+thisMapData.npcs[s[h]].tileY;while(i==t.lastTargetDestination);postMessage([t.name,findPath(t.tileX,t.tileY,thisMapData.npcs[s[h]].tileX,thisMapData.npcs[s[h]].tileY),i])}else postMessage([t.name,["-","pathEnd"],""])}};