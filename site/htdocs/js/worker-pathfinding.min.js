"use strict";var thisMapData,mapTilesY,mapTilesX,thisAgentsIndex,uncheckedTiles,nodes;function isATerrainCollision(a,t){if(a<0||t<0||a>=mapTilesX||t>=mapTilesY)return 1;switch(thisMapData.collisions[t][a]){case 1:return 1;default:return 0}}function addNode(a,t,e,s,n){if(!isATerrainCollision(t,e)){for(var i=!1,h=0;h<thisMapData.items.length;h++)thisMapData.items[h].tileX==t&&thisMapData.items[h].tileY==e&&(i=!0);for(h=0;h<thisMapData.npcs.length;h++)h!=thisAgentsIndex&&"-"==thisMapData.npcs[h].movement[thisMapData.npcs[h].movementIndex]&&thisMapData.npcs[h].isCollidable&&(t==s&&e==n||parseInt(thisMapData.npcs[h].tileX)==parseInt(t)&&parseInt(thisMapData.npcs[h].tileY)==parseInt(e)&&(i=!0));for(h=0;h<thisMapData.items.length;h++)thisMapData.items[h].tileX==t&&thisMapData.items[h].tileY==e&&(i=!0);if(void 0!==thisMapData.innerDoors)for(var h in thisMapData.innerDoors)thisMapData.innerDoors[h].isOpen||thisMapData.innerDoors[h].tileX==t&&thisMapData.innerDoors[h].tileY==e&&(i=!0);if(!i){var p=Math.abs(t-s)+Math.abs(e-n),l=a.cost+1,o=l+p;if(void 0===nodes[t+"-"+e]){nodes[t+"-"+e]={x:t,y:e,parentX:a.x,parentY:a.y,cost:l,summedCost:o};for(h=0;h<uncheckedTiles.length;h++)if(o<uncheckedTiles[h].summedCost){uncheckedTiles.splice(h,0,nodes[t+"-"+e]);break}h>=uncheckedTiles.length&&uncheckedTiles.push(nodes[t+"-"+e])}else l<nodes[t+"-"+e].cost&&(nodes[t+"-"+e].cost=o,nodes[t+"-"+e].summedCost=l,nodes[t+"-"+e].parentX=a.x,nodes[t+"-"+e].parentY=a.y)}}}function findPath(a,t,e,s){uncheckedTiles=[];var n,i=Math.abs(a-e)+Math.abs(t-s);(nodes={})[a+"-"+t]={x:a,y:t,parentX:void 0,parentY:void 0,cost:0,summedCost:i},uncheckedTiles.push(nodes[a+"-"+t]);var h=!1;do{if((n=uncheckedTiles.shift()).x==e&&n.y==s){h=!0;for(var p=[];void 0!==n.parentX;)p.unshift([n.parentX,n.parentY]),n=nodes[n.parentX+"-"+n.parentY];for(var l=[],o=1;o<p.length;o++)p[o][0]==p[o-1][0]?p[o][1]>p[o-1][1]?l.push("s"):l.push("n"):p[o][0]>p[o-1][0]?l.push("e"):l.push("w");l.push("pathEnd")}else addNode(n,n.x+1,n.y,e,s),addNode(n,n.x-1,n.y,e,s),addNode(n,n.x,n.y+1,e,s),addNode(n,n.x,n.y-1,e,s)}while(uncheckedTiles.length>0&&!h);return uncheckedTiles=null,thisMapData=null,nodes=null,thisAgentsIndex=null,h?l:["-","pathEnd"]}onmessage=function(a){switch(a.data[0]){case"shop":var t,e=a.data[1];thisMapData=a.data[2],mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length,thisAgentsIndex=thisMapData.npcs.map(function(a){return a.name}).indexOf(e.name);for(var s=[],n=0;n<thisMapData.npcs.length;n++)n!=thisAgentsIndex&&(t=thisMapData.npcs[n]).speech&&"shop"==t.speech[t.speechIndex][1]&&s.push(n);if(s.length>0){var i,h;do{h=Math.floor(Math.random()*s.length),i=thisMapData.npcs[s[h]].tileX+"-"+thisMapData.npcs[s[h]].tileY}while(i==e.lastTargetDestination);postMessage([e.name,findPath(e.tileX,e.tileY,thisMapData.npcs[s[h]].tileX,thisMapData.npcs[s[h]].tileY),i])}else postMessage([e.name,["-","pathEnd"],""]);break;case"petToHero":e=a.data[1];thisMapData=a.data[2],thisAgentsIndex=-1,mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length,postMessage(["pet",a.data[5],findPath(e.tileX,e.tileY,a.data[3],a.data[4])]);break;case"npcFindFollowing":e=a.data[1];thisMapData=a.data[2],mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length,thisAgentsIndex=thisMapData.npcs.map(function(a){return a.name}).indexOf(e.name),postMessage([e.name,findPath(e.tileX,e.tileY,e.following.tileX,e.following.tileY)])}};