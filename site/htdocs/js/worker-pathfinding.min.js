"use strict";var thisMapData,mapTilesY,mapTilesX,thisAgentsIndex,uncheckedTiles,nodes;function isATerrainCollision(a,t){if(a<0||t<0||a>=mapTilesX||t>=mapTilesY)return 1;switch(thisMapData.collisions[t][a]){case 1:return 1;default:return 0}}function addNode(a,t,e,s,i){if(!isATerrainCollision(t,e)){for(var n=!1,h=0;h<thisMapData.items.length;h++)thisMapData.items[h].tileX==t&&thisMapData.items[h].tileY==e&&(n=!0);for(h=0;h<thisMapData.npcs.length;h++)h!=thisAgentsIndex&&"-"==thisMapData.npcs[h].movement[thisMapData.npcs[h].movementIndex]&&thisMapData.npcs[h].isCollidable&&(t==s&&e==i||parseInt(thisMapData.npcs[h].tileX)==parseInt(t)&&parseInt(thisMapData.npcs[h].tileY)==parseInt(e)&&(n=!0));for(h=0;h<thisMapData.items.length;h++)thisMapData.items[h].tileX==t&&thisMapData.items[h].tileY==e&&(n=!0);if(void 0!==thisMapData.innerDoors)for(var h in thisMapData.innerDoors)thisMapData.innerDoors[h].isOpen||thisMapData.innerDoors[h].tileX==t&&thisMapData.innerDoors[h].tileY==e&&(n=!0);if(!n){var p=Math.abs(t-s)+Math.abs(e-i),l=a.cost+1,d=l+p;if(void 0===nodes[t+"-"+e]){nodes[t+"-"+e]={x:t,y:e,parentX:a.x,parentY:a.y,cost:l,summedCost:d};for(h=0;h<uncheckedTiles.length;h++)if(d<uncheckedTiles[h].summedCost){uncheckedTiles.splice(h,0,nodes[t+"-"+e]);break}h>=uncheckedTiles.length&&uncheckedTiles.push(nodes[t+"-"+e])}else l<nodes[t+"-"+e].cost&&(nodes[t+"-"+e].cost=d,nodes[t+"-"+e].summedCost=l,nodes[t+"-"+e].parentX=a.x,nodes[t+"-"+e].parentY=a.y)}}}function findPath(a,t,e,s){uncheckedTiles=[];var i,n=Math.abs(a-e)+Math.abs(t-s);(nodes={})[a+"-"+t]={x:a,y:t,parentX:void 0,parentY:void 0,cost:0,summedCost:n},uncheckedTiles.push(nodes[a+"-"+t]);var h=!1;do{if((i=uncheckedTiles.shift()).x==e&&i.y==s){h=!0;for(var p=[];void 0!==i.parentX;)p.unshift([i.parentX,i.parentY]),i=nodes[i.parentX+"-"+i.parentY];for(var l=[],d=1;d<p.length;d++)p[d][0]==p[d-1][0]?p[d][1]>p[d-1][1]?l.push("s"):l.push("n"):p[d][0]>p[d-1][0]?l.push("e"):l.push("w");l.push("pathEnd")}else addNode(i,i.x+1,i.y,e,s),addNode(i,i.x-1,i.y,e,s),addNode(i,i.x,i.y+1,e,s),addNode(i,i.x,i.y-1,e,s)}while(uncheckedTiles.length>0&&!h);return uncheckedTiles=null,thisMapData=null,nodes=null,thisAgentsIndex=null,h?l:["-","pathEnd"]}onmessage=function(a){switch(a.data[0]){case"tile":var t=a.data[1],e=a.data[2],s=a.data[3];thisMapData=a.data[4],mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length,postMessage([s.name,findPath(s.tileX,s.tileY,t,e),t+"-"+e]);break;case"shop":var i;s=a.data[1];thisMapData=a.data[2],mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length,thisAgentsIndex=thisMapData.npcs.map(function(a){return a.name}).indexOf(s.name);for(var n=[],h=0;h<thisMapData.npcs.length;h++)h!=thisAgentsIndex&&(i=thisMapData.npcs[h]).speech&&"shop"==i.speech[i.speechIndex][1]&&n.push(h);if(n.length>0){var p,l;do{l=Math.floor(Math.random()*n.length),p=thisMapData.npcs[n[l]].tileX+"-"+thisMapData.npcs[n[l]].tileY}while(p==s.lastTargetDestination);postMessage([s.name,findPath(s.tileX,s.tileY,thisMapData.npcs[n[l]].tileX,thisMapData.npcs[n[l]].tileY),p])}else postMessage([s.name,["-","pathEnd"],""]);break;case"petToHero":s=a.data[1];thisMapData=a.data[2],thisAgentsIndex=-1,mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length,postMessage(["pet",a.data[5],findPath(s.tileX,s.tileY,a.data[3],a.data[4])]);break;case"npcFindFollowing":s=a.data[1];thisMapData=a.data[2],mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length,thisAgentsIndex=thisMapData.npcs.map(function(a){return a.name}).indexOf(s.name),postMessage([s.name,findPath(s.tileX,s.tileY,s.following.tileX,s.following.tileY)])}};