"use strict";function loadGlobalMapData(){getJSON("/data/world-map.json",function(a){worldMap=a.worldMap},function(a){loadGlobalMapData()})}self.importScripts("shared-worker-functions.min.js");var worldMap="";loadGlobalMapData();const tileW=48;var thisMapData,visibleMaps,mapTilesY,mapTilesX,thisAgentsIndex,uncheckedTiles,nodes,firstKey;function addNode(a,s,i,t,e){if(!isATerrainCollision(s,i)){var l=Math.abs(s-t)+Math.abs(i-e),p=a.cost+1,n=p+l;if(void 0===nodes[s+"-"+i]){nodes[s+"-"+i]={x:s,y:i,parentX:a.x,parentY:a.y,cost:p,summedCost:n};for(var h=0;h<uncheckedTiles.length;h++)if(n<uncheckedTiles[h].summedCost){uncheckedTiles.splice(h,0,nodes[s+"-"+i]);break}h>=uncheckedTiles.length&&uncheckedTiles.push(nodes[s+"-"+i])}else p<nodes[s+"-"+i].cost&&(nodes[s+"-"+i].cost=n,nodes[s+"-"+i].summedCost=p,nodes[s+"-"+i].parentX=a.x,nodes[s+"-"+i].parentY=a.y)}}function findPath(a,s,i,t){uncheckedTiles=[];var e,l=Math.abs(a-i)+Math.abs(s-t);(nodes={})[a+"-"+s]={x:a,y:s,parentX:void 0,parentY:void 0,cost:0,summedCost:l},uncheckedTiles.push(nodes[a+"-"+s]);for(var p=!1,n=0;n<visibleMaps.length;n++){for(var h=0;h<thisMapData[visibleMaps[n]].npcs.length;h++)thisMapData[visibleMaps[n]].npcs.uniqueIndex!=thisAgentsIndex&&"-"==thisMapData[visibleMaps[n]].npcs[h].movement[thisMapData[visibleMaps[n]].npcs[h].movementIndex]&&thisMapData[visibleMaps[n]].npcs[h].isCollidable&&(thisMapData[visibleMaps[n]].npcs[h].tileX==i&&thisMapData[visibleMaps[n]].npcs[h].tileY==t||(thisMapData[visibleMaps[n]].collisions[thisMapData[visibleMaps[n]].npcs[h].tileY][thisMapData[visibleMaps[n]].npcs[h].tileX]=1));for(h=0;h<thisMapData[visibleMaps[n]].items.length;h++){if(thisMapData[visibleMaps[n]].collisions[thisMapData[visibleMaps[n]].items[h].tileY][thisMapData[visibleMaps[n]].items[h].tileX]=1,thisMapData[visibleMaps[n]].items[h].width>tileW)for(var o=1;o<thisMapData[visibleMaps[n]].items[h].width/tileW;o++)thisMapData[visibleMaps[n]].collisions[thisMapData[visibleMaps[n]].items[h].tileY][thisMapData[visibleMaps[n]].items[h].tileX+o]=1,thisMapData[visibleMaps[n]].collisions[thisMapData[visibleMaps[n]].items[h].tileY][thisMapData[visibleMaps[n]].items[h].tileX-o]=1;if(thisMapData[visibleMaps[n]].items[h].height>tileW)for(o=1;o<thisMapData[visibleMaps[n]].items[h].height/tileW;o++)thisMapData[visibleMaps[n]].collisions[thisMapData[visibleMaps[n]].items[h].tileY+o][thisMapData[visibleMaps[n]].items[h].tileX]=1,thisMapData[visibleMaps[n]].collisions[thisMapData[visibleMaps[n]].items[h].tileY-o][thisMapData[visibleMaps[n]].items[h].tileX]=1}if(void 0!==thisMapData[visibleMaps[n]].innerDoors)for(var h in thisMapData[visibleMaps[n]].innerDoors)thisMapData[visibleMaps[n]].innerDoors[h].isOpen||(thisMapData[visibleMaps[n]].collisions[thisMapData[visibleMaps[n]].innerDoors[h].tileY][thisMapData[visibleMaps[n]].innerDoors[h].tileX]=1)}do{if((e=uncheckedTiles.shift()).x==i&&e.y==t){p=!0;for(var M=[];void 0!==e.parentX;)M.unshift([e.parentX,e.parentY]),e=nodes[e.parentX+"-"+e.parentY];var r=[];for(h=1;h<M.length;h++)M[h][0]==M[h-1][0]?M[h][1]>M[h-1][1]?r.push("s"):r.push("n"):M[h][0]>M[h-1][0]?r.push("e"):r.push("w");r.push("pathEnd")}else addNode(e,e.x+1,e.y,i,t),addNode(e,e.x-1,e.y,i,t),addNode(e,e.x,e.y+1,i,t),addNode(e,e.x,e.y-1,i,t)}while(uncheckedTiles.length>0&&!p);return uncheckedTiles=null,thisMapData=null,visibleMaps=null,nodes=null,thisAgentsIndex=null,p?r:["-","pathEnd"]}onmessage=function(a){if(""!=worldMap)switch(a.data[0]){case"tile":var s=a.data[1],i=a.data[2],t=a.data[3];for(firstKey in thisMapData=a.data[4],visibleMaps=a.data[5],thisMapData)break;mapTilesY=thisMapData[firstKey].terrain.length,mapTilesX=thisMapData[firstKey].terrain[0].length,postMessage([t.name,findPath(t.tileX,t.tileY,s,i),s+"-"+i]);break;case"shop":var e;t=a.data[1];for(firstKey in thisMapData=a.data[2],visibleMaps=a.data[3],thisMapData)break;mapTilesY=thisMapData[firstKey].terrain.length,mapTilesX=thisMapData[firstKey].terrain[0].length,thisAgentsIndex=t.uniqueIndex;for(var l=[],p=[],n=0;n<visibleMaps.length;n++)for(var h=0;h<thisMapData[visibleMaps[n]].npcs.length;h++)thisMapData[visibleMaps[n]].npcs[h].uniqueIndex!=thisAgentsIndex&&(e=thisMapData[visibleMaps[n]].npcs[h]).speech&&"shop"==e.speech[e.speechIndex][1]&&(l.push(h),p.push(n));if(console.log(l),console.log(p),console.log("-----------"),l.length>0){var o,M;do{M=Math.floor(Math.random()*l.length),o=thisMapData[p[M]].npcs[l[M]].tileX+"-"+thisMapData[p[M]].npcs[l[M]].tileY}while(o==t.lastTargetDestination);postMessage([t.name,findPath(t.tileX,t.tileY,thisMapData[p[M]].npcs[l[M]].tileX,thisMapData[p[M]].npcs[l[M]].tileY),o])}else postMessage([t.name,["-","pathEnd"],""]);break;case"petToHero":t=a.data[1];for(firstKey in thisMapData=a.data[2],visibleMaps=a.data[3],thisAgentsIndex=-1,thisMapData)break;mapTilesY=thisMapData[firstKey].terrain.length,mapTilesX=thisMapData[firstKey].terrain[0].length,postMessage(["pet",a.data[5],findPath(t.tileX,t.tileY,a.data[3],a.data[4])]);break;case"npcFindFollowing":t=a.data[1];for(firstKey in thisMapData=a.data[2],visibleMaps=a.data[3],thisMapData)break;mapTilesY=thisMapData[firstKey].terrain.length,mapTilesX=thisMapData[firstKey].terrain[0].length,thisAgentsIndex=t.uniqueIndex,postMessage([t.name,findPath(t.tileX,t.tileY,t.following.tileX,t.following.tileY)])}};