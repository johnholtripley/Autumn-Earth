"use strict";function isATerrainCollision(a,e){if(0>a||0>e||a>=mapTilesX||e>=mapTilesY)return 1;switch(thisMapData.collisions[e][a]){case 1:return 1;default:return 0}}function addNode(a,e,t,s,n){if(!isATerrainCollision(e,t)){for(var i=!1,p=0;p<thisMapData.items.length;p++)thisMapData.items[p].tileX==e&&thisMapData.items[p].tileY==t&&(i=!0);for(var p=0;p<thisMapData.npcs.length;p++)p!=thisAgentsIndex&&"-"==thisMapData.npcs[p].movement[thisMapData.npcs[p].movementIndex]&&thisMapData.npcs[p].isCollidable&&(e!=s||t!=n)&&parseInt(thisMapData.npcs[p].tileX)==parseInt(e)&&parseInt(thisMapData.npcs[p].tileY)==parseInt(t)&&(i=!0);for(var p=0;p<thisMapData.items.length;p++)thisMapData.items[p].tileX==e&&thisMapData.items[p].tileY==t&&(i=!0);if("undefined"!=typeof thisMapData.innerDoors)for(var p in thisMapData.innerDoors)thisMapData.innerDoors[p].isOpen||thisMapData.innerDoors[p].tileX==e&&thisMapData.innerDoors[p].tileY==t&&(i=!0);if(!i){var h=Math.abs(e-s)+Math.abs(t-n),l=a.cost+1,o=l+h;if("undefined"==typeof nodes[e+"-"+t]){nodes[e+"-"+t]={x:e,y:t,parentX:a.x,parentY:a.y,cost:l,summedCost:o};for(var p=0;p<uncheckedTiles.length;p++)if(o<uncheckedTiles[p].summedCost){uncheckedTiles.splice(p,0,nodes[e+"-"+t]);break}p>=uncheckedTiles.length&&uncheckedTiles.push(nodes[e+"-"+t])}else l<nodes[e+"-"+t].cost&&(nodes[e+"-"+t].cost=o,nodes[e+"-"+t].summedCost=l,nodes[e+"-"+t].parentX=a.x,nodes[e+"-"+t].parentY=a.y)}}}function findPath(a,e,t,s){uncheckedTiles=[];var n=Math.abs(a-t)+Math.abs(e-s);nodes={},nodes[a+"-"+e]={x:a,y:e,parentX:void 0,parentY:void 0,cost:0,summedCost:n},uncheckedTiles.push(nodes[a+"-"+e]);var i,p=!1;do if(i=uncheckedTiles.shift(),i.x==t&&i.y==s){p=!0;for(var h=[];"undefined"!=typeof i.parentX;)h.unshift([i.parentX,i.parentY]),i=nodes[i.parentX+"-"+i.parentY];for(var l=[],o=1;o<h.length;o++)h[o][0]==h[o-1][0]?h[o][1]>h[o-1][1]?l.push("s"):l.push("n"):h[o][0]>h[o-1][0]?l.push("e"):l.push("w");l.push("pathEnd")}else addNode(i,i.x+1,i.y,t,s),addNode(i,i.x-1,i.y,t,s),addNode(i,i.x,i.y+1,t,s),addNode(i,i.x,i.y-1,t,s);while(uncheckedTiles.length>0&&!p);return uncheckedTiles=null,thisMapData=null,nodes=null,thisAgentsIndex=null,p?l:["-","pathEnd"]}var thisMapData,mapTilesY,mapTilesX,thisAgentsIndex,uncheckedTiles,nodes;onmessage=function(a){switch(a.data[0]){case"shop":var e=a.data[1];thisMapData=a.data[2],mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length,thisAgentsIndex=thisMapData.npcs.map(function(a){return a.name}).indexOf(e.name);for(var t,s=[],n=0;n<thisMapData.npcs.length;n++)n!=thisAgentsIndex&&(t=thisMapData.npcs[n],t.speech&&"shop"==t.speech[t.speechIndex][1]&&s.push(n));if(s.length>0){var i,p;do p=Math.floor(Math.random()*s.length),i=thisMapData.npcs[s[p]].tileX+"-"+thisMapData.npcs[s[p]].tileY;while(i==e.lastTargetDestination);postMessage([e.name,findPath(e.tileX,e.tileY,thisMapData.npcs[s[p]].tileX,thisMapData.npcs[s[p]].tileY),i])}else postMessage([e.name,["-","pathEnd"],""]);break;case"petToHero":var e=a.data[1];thisMapData=a.data[2],thisAgentsIndex=-1,mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length,postMessage(["pet",a.data[5],findPath(e.tileX,e.tileY,a.data[3],a.data[4])]);break;case"npcFindFollowing":var e=a.data[1];thisMapData=a.data[2],mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length,thisAgentsIndex=thisMapData.npcs.map(function(a){return a.name}).indexOf(e.name),postMessage([e.name,findPath(e.tileX,e.tileY,e.following.tileX,e.following.tileY)])}};