"use strict";const tileW=48;var thisMapData,mapTilesY,mapTilesX,thisAgentsIndex,uncheckedTiles,nodes;function isATerrainCollision(a,t){if(a<0||t<0||a>=mapTilesX||t>=mapTilesY)return 1;switch(thisMapData.collisions[t][a]){case 1:return 1;default:return 0}}function addNode(a,t,e,s,i){if(!isATerrainCollision(t,e)){var n=Math.abs(t-s)+Math.abs(e-i),h=a.cost+1,p=h+n;if(void 0===nodes[t+"-"+e]){nodes[t+"-"+e]={x:t,y:e,parentX:a.x,parentY:a.y,cost:h,summedCost:p};for(var l=0;l<uncheckedTiles.length;l++)if(p<uncheckedTiles[l].summedCost){uncheckedTiles.splice(l,0,nodes[t+"-"+e]);break}l>=uncheckedTiles.length&&uncheckedTiles.push(nodes[t+"-"+e])}else h<nodes[t+"-"+e].cost&&(nodes[t+"-"+e].cost=p,nodes[t+"-"+e].summedCost=h,nodes[t+"-"+e].parentX=a.x,nodes[t+"-"+e].parentY=a.y)}}function findPath(a,t,e,s){uncheckedTiles=[];var i,n=Math.abs(a-e)+Math.abs(t-s);(nodes={})[a+"-"+t]={x:a,y:t,parentX:void 0,parentY:void 0,cost:0,summedCost:n},uncheckedTiles.push(nodes[a+"-"+t]);for(var h=!1,p=0;p<thisMapData.npcs.length;p++)p!=thisAgentsIndex&&"-"==thisMapData.npcs[p].movement[thisMapData.npcs[p].movementIndex]&&thisMapData.npcs[p].isCollidable&&(thisMapData.npcs[p].tileX==e&&thisMapData.npcs[p].tileY==s||(thisMapData.collisions[thisMapData.npcs[p].tileY][thisMapData.npcs[p].tileX]=1));for(p=0;p<thisMapData.items.length;p++){if(thisMapData.collisions[thisMapData.items[p].tileY][thisMapData.items[p].tileX]=1,thisMapData.items[p].width>tileW)for(var l=1;l<thisMapData.items[p].width/tileW;l++)thisMapData.collisions[thisMapData.items[p].tileY][thisMapData.items[p].tileX+l]=1,thisMapData.collisions[thisMapData.items[p].tileY][thisMapData.items[p].tileX-l]=1;if(thisMapData.items[p].height>tileW)for(l=1;l<thisMapData.items[p].height/tileW;l++)thisMapData.collisions[thisMapData.items[p].tileY+l][thisMapData.items[p].tileX]=1,thisMapData.collisions[thisMapData.items[p].tileY-l][thisMapData.items[p].tileX]=1}if(void 0!==thisMapData.innerDoors)for(var p in thisMapData.innerDoors)thisMapData.innerDoors[p].isOpen||(thisMapData.collisions[thisMapData.innerDoors[p].tileY][thisMapData.innerDoors[p].tileX]=1);do{if((i=uncheckedTiles.shift()).x==e&&i.y==s){h=!0;for(var o=[];void 0!==i.parentX;)o.unshift([i.parentX,i.parentY]),i=nodes[i.parentX+"-"+i.parentY];var d=[];for(p=1;p<o.length;p++)o[p][0]==o[p-1][0]?o[p][1]>o[p-1][1]?d.push("s"):d.push("n"):o[p][0]>o[p-1][0]?d.push("e"):d.push("w");d.push("pathEnd")}else addNode(i,i.x+1,i.y,e,s),addNode(i,i.x-1,i.y,e,s),addNode(i,i.x,i.y+1,e,s),addNode(i,i.x,i.y-1,e,s)}while(uncheckedTiles.length>0&&!h);return uncheckedTiles=null,thisMapData=null,nodes=null,thisAgentsIndex=null,h?d:["-","pathEnd"]}onmessage=function(a){switch(a.data[0]){case"tile":var t=a.data[1],e=a.data[2],s=a.data[3];thisMapData=a.data[4],mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length,postMessage([s.name,findPath(s.tileX,s.tileY,t,e),t+"-"+e]);break;case"shop":var i;s=a.data[1];thisMapData=a.data[2],mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length,thisAgentsIndex=thisMapData.npcs.map(function(a){return a.name}).indexOf(s.name);for(var n=[],h=0;h<thisMapData.npcs.length;h++)h!=thisAgentsIndex&&(i=thisMapData.npcs[h]).speech&&"shop"==i.speech[i.speechIndex][1]&&n.push(h);if(n.length>0){var p,l;do{l=Math.floor(Math.random()*n.length),p=thisMapData.npcs[n[l]].tileX+"-"+thisMapData.npcs[n[l]].tileY}while(p==s.lastTargetDestination);postMessage([s.name,findPath(s.tileX,s.tileY,thisMapData.npcs[n[l]].tileX,thisMapData.npcs[n[l]].tileY),p])}else postMessage([s.name,["-","pathEnd"],""]);break;case"petToHero":s=a.data[1];thisMapData=a.data[2],thisAgentsIndex=-1,mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length,postMessage(["pet",a.data[5],findPath(s.tileX,s.tileY,a.data[3],a.data[4])]);break;case"npcFindFollowing":s=a.data[1];thisMapData=a.data[2],mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length,thisAgentsIndex=thisMapData.npcs.map(function(a){return a.name}).indexOf(s.name),postMessage([s.name,findPath(s.tileX,s.tileY,s.following.tileX,s.following.tileY)])}};