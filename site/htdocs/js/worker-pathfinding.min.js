function isATerrainCollision(e,a){if(0>e||0>a||e>=mapTilesX||a>=mapTilesY)return 1;switch(thisMapData.collisions[a][e]){case 1:return 1;default:return 0}}function addNode(e,a,t,s,n){if(!isATerrainCollision(a,t)){for(var i=!1,h=0;h<thisMapData.items.length;h++)thisMapData.items[h].tileX==a&&thisMapData.items[h].tileY==t&&(i=!0);if(!i){var d=Math.abs(a-s)+Math.abs(t-n);if("undefined"==typeof nodes[a+"-"+t]){nodes[a+"-"+t]={x:a,y:t,parentX:e.x,parentY:e.y,cost:d};for(var h=0;h<uncheckedTiles.length;h++)if(d<uncheckedTiles[h].cost){uncheckedTiles.splice(h,0,nodes[a+"-"+t]);break}h>=uncheckedTiles.length&&uncheckedTiles.push(nodes[a+"-"+t])}else d<nodes[a+"-"+t].cost&&(nodes[a+"-"+t].cost=d,nodes[a+"-"+t].parentX=e.x,nodes[a+"-"+t].parentY=e.y)}}}function findPath(e,a,t,s){uncheckedTiles=[];var n=Math.abs(e-t)+Math.abs(a-s);nodes={},nodes[e+"-"+a]={x:e,y:a,parentX:void 0,parentY:void 0,cost:n},uncheckedTiles.push(nodes[e+"-"+a]);var i,h=!1;do if(i=uncheckedTiles.shift(),i.x==t&&i.y==s){h=!0;for(var d=[];"undefined"!=typeof i.parentX;)d.unshift([i.parentX,i.parentY]),i=nodes[i.parentX+"-"+i.parentY];for(var p=[],o=1;o<d.length;o++)d[o][0]==d[o-1][0]?d[o][1]>d[o-1][1]?p.push("s"):p.push("n"):d[o][0]>d[o-1][0]?p.push("e"):p.push("w");p.push("pathEnd")}else addNode(i,i.x+1,i.y,t,s),addNode(i,i.x-1,i.y,t,s),addNode(i,i.x,i.y+1,t,s),addNode(i,i.x,i.y-1,t,s);while(uncheckedTiles.length>0&&!h);return delete uncheckedTiles,delete thisMapData,delete nodes,h?p:["-","pathEnd"]}onmessage=function(e){switch(e.data[0]){case"shop":var a=e.data[1];thisMapData=e.data[2],mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length;for(var t,s=thisMapData.npcs.map(function(e){return e.name}).indexOf(a.name),n=[],i=0;i<thisMapData.npcs.length;i++)i!=s&&(t=thisMapData.npcs[i],t.speech&&"shop"==t.speech[t.speechIndex][1]&&n.push(i));if(n.length>0){var h,d;do d=Math.floor(Math.random()*n.length),h=thisMapData.npcs[n[d]].tileX+"-"+thisMapData.npcs[n[d]].tileY;while(h==a.lastTargetDestination);postMessage([a.name,findPath(a.tileX,a.tileY,thisMapData.npcs[n[d]].tileX,thisMapData.npcs[n[d]].tileY),h])}else postMessage([a.name,["-","pathEnd"],""])}};