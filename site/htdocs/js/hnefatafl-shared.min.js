"use strict";var hnefataflNameSpace={squareSize:62,boardInset:28,pieceGraphicalOffset:12,originalWidth:612,highlightSquare:[],board:[],animatingPieces:{},piecesToRemove:[],pieceSpeed:28,initialisehnefataflGame:function(){hnefataflNameSpace.board=[["0","0","0","b","b","b","0","0","0"],["0","0","0","0","b","0","0","0","0"],["0","0","0","0","w","0","0","0","0"],["b","0","0","0","w","0","0","0","b"],["b","b","w","w","W","w","w","b","b"],["b","0","0","0","w","0","0","0","b"],["0","0","0","0","w","0","0","0","0"],["0","0","0","0","b","0","0","0","0"],["0","0","0","b","b","b","0","0","0"]],hnefataflNameSpace.boardWidth=hnefataflNameSpace.board[0].length,hnefataflNameSpace.boardHeight=hnefataflNameSpace.board.length,hnefataflNameSpace.imagesToLoad=[{name:"board",src:"/images/hnefatafl/board.jpg"},{name:"highlight",src:"/images/hnefatafl/highlight.png"},{name:"active-white",src:"/images/hnefatafl/active-player-white.png"},{name:"active-black",src:"/images/hnefatafl/active-player-black.png"},{name:"white-piece",src:"/images/hnefatafl/white-piece.png"},{name:"black-piece",src:"/images/hnefatafl/black-piece.png"},{name:"king",src:"/images/hnefatafl/king.png"}],document.getElementById("hnefataflGame").addEventListener("click",hnefataflNameSpace.canvasClick,!1),hnefataflNameSpace.gameMode="loading",Loader.preload(hnefataflNameSpace.imagesToLoad,hnefataflNameSpace.initCardGame,loadingProgress)},getTilePosition:function(a){return a*hnefataflNameSpace.squareSize+hnefataflNameSpace.boardInset},getCanvasPosition:function(){var a=document.getElementById("hnefataflGame").getBoundingClientRect();hnefataflNameSpace.outerCanvasLeft=a.left,hnefataflNameSpace.outerCanvasTop=a.top,hnefataflNameSpace.outerCanvasWidth=a.right-a.left,hnefataflNameSpace.scale=hnefataflNameSpace.originalWidth/hnefataflNameSpace.outerCanvasWidth,hnefataflNameSpace.outerCanvasHeight=hnefataflNameSpace.outerCanvasWidth,hnefataflNameSpace.pageLoadScroll=document.body.scrollTop+document.documentElement.scrollTop},canvasClick:function(a){var e=!0;if(hnefataflNameSpace.isPlayer1AI&&hnefataflNameSpace.player1==hnefataflNameSpace.currentPlayer&&(e=!1),a&&a.preventDefault(),e){var f=a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,t=a.clientY+document.body.scrollTop+document.documentElement.scrollTop-hnefataflNameSpace.pageLoadScroll;switch(hnefataflNameSpace.gameMode){case"play":case"hnefataflGame":var n=f-hnefataflNameSpace.outerCanvasLeft,c=t-hnefataflNameSpace.outerCanvasTop,l=Math.floor((hnefataflNameSpace.scale*n-hnefataflNameSpace.boardInset)/hnefataflNameSpace.squareSize),h=Math.floor((hnefataflNameSpace.scale*c-hnefataflNameSpace.boardInset)/hnefataflNameSpace.squareSize);if(hnefataflNameSpace.board[h][l].toLowerCase()==hnefataflNameSpace.currentPlayer)hnefataflNameSpace.highlightSquare=[l,h];else{if(hnefataflNameSpace.highlightSquare.length>0){var m=!1,i=hnefataflNameSpace.highlightSquare[0],p=hnefataflNameSpace.highlightSquare[1];if(console.log("moving from "+i+","+p+" to "+l+","+h),h==hnefataflNameSpace.highlightSquare[1])if(m=!0,l>i)for(var o=i+1;o<=l;o++)console.log("checking "+o+","+h+" : "+hnefataflNameSpace.board[h][o]),"0"!=hnefataflNameSpace.board[h][o]&&(m=!1);else for(o=l;o<i;o++)console.log("checking "+o+","+h+" : "+hnefataflNameSpace.board[h][o]),"0"!=hnefataflNameSpace.board[h][o]&&(m=!1);else if(l==hnefataflNameSpace.highlightSquare[0])if(m=!0,h>p)for(o=p+1;o<=h;o++)console.log("checking "+l+","+o+" : "+hnefataflNameSpace.board[o][l]),"0"!=hnefataflNameSpace.board[o][l]&&(m=!1);else for(o=h;o<p;o++)console.log("checking "+l+","+o+" : "+hnefataflNameSpace.board[o][l]),"0"!=hnefataflNameSpace.board[o][l]&&(m=!1);m&&hnefataflNameSpace.makeMove(i,p,l,h)}hnefataflNameSpace.highlightSquare=[]}}}},makeMove:function(a,e,f,t){hnefataflNameSpace.board[t][f]=hnefataflNameSpace.board[e][a],hnefataflNameSpace.board[e][a]="0",hnefataflNameSpace.animatingPieces[f+"_"+t]=[hnefataflNameSpace.getTilePosition(a),hnefataflNameSpace.getTilePosition(e),hnefataflNameSpace.getTilePosition(f),hnefataflNameSpace.getTilePosition(t)],hnefataflNameSpace.checkForCapturedPieces(f,t,hnefataflNameSpace.currentPlayer),"w"==hnefataflNameSpace.currentPlayer?hnefataflNameSpace.currentPlayer="b":hnefataflNameSpace.currentPlayer="w"},checkVictoryConditions:function(){for(var a=!1,e=!1,f=0;f<hnefataflNameSpace.board.length;f++)for(var t=0;t<hnefataflNameSpace.board[0].length;t++)if("W"==hnefataflNameSpace.board[f][t]){if(0==f||0==t||f==hnefataflNameSpace.board.length-1||t==hnefataflNameSpace.board[0].length-1){e=!0;break}a=!0}a||(hnefataflNameSpace.gameMode="gameover",hnefataflNameSpace.draw(),"b"==hnefataflNameSpace.player2?hnefataflPlayer2Wins():hnefataflPlayer1Wins()),e&&(hnefataflNameSpace.gameMode="gameover",hnefataflNameSpace.draw(),"w"==hnefataflNameSpace.player2?hnefataflPlayer2Wins():hnefataflPlayer1Wins())},checkForCapturedPieces:function(a,e,f){var t;t="w"==f?"b":"w";for(var n,c,l,h,m=[[-1,0],[1,0],[0,-1],[0,1]],i=0;i<m.length;i++)c=e+m[i][0],(n=a+m[i][1])>=0&&c>=0&&n<hnefataflNameSpace.board.length&&c<hnefataflNameSpace.board.length&&hnefataflNameSpace.board[c][n].toLowerCase()==t&&(h=e+2*m[i][0],(l=a+2*m[i][1])>=0&&h>=0&&l<hnefataflNameSpace.board.length&&h<hnefataflNameSpace.board.length&&hnefataflNameSpace.board[h][l].toLowerCase()==f&&hnefataflNameSpace.piecesToRemove.push([n,c]))},checkForPiecesToRemove:function(){if(hnefataflNameSpace.piecesToRemove.length>0)for(var a=0;a<hnefataflNameSpace.piecesToRemove.length;a++)hnefataflNameSpace.board[hnefataflNameSpace.piecesToRemove[a][1]][hnefataflNameSpace.piecesToRemove[a][0]]="0",hnefataflNameSpace.piecesToRemove.splice(a,1);hnefataflNameSpace.checkVictoryConditions()},initCardGame:function(){hnefataflNameSpace.getCanvasPosition(),hnefataflNameSpace.gameCanvas=document.getElementById("hnefataflGame"),hnefataflNameSpace.gameCanvas.getContext&&(hnefataflNameSpace.gameContext=hnefataflNameSpace.gameCanvas.getContext("2d"),hnefataflNameSpace.canvasWidth=hnefataflNameSpace.gameCanvas.width,hnefataflNameSpace.canvasHeight=hnefataflNameSpace.gameCanvas.height),hnefataflNameSpace.boardImage=Loader.getImage("board"),hnefataflNameSpace.highlightImage=Loader.getImage("highlight"),hnefataflNameSpace.activeWhiteImage=Loader.getImage("active-white"),hnefataflNameSpace.activeBlackImage=Loader.getImage("active-black"),hnefataflNameSpace.whitePieceImage=Loader.getImage("white-piece"),hnefataflNameSpace.kingImage=Loader.getImage("king"),hnefataflNameSpace.blackPieceImage=Loader.getImage("black-piece"),hnefataflNameSpace.currentPlayer="w",hnefataflNameSpace.player1="w",hnefataflNameSpace.player2="b",hnefataflNameSpace.isPlayer1AI=!0,hnefataflNameSpace.aiIsWorking=-1,hnefataflNameSpace.AIisWaitingToMove=!0,hnefataflNameSpace.whoCanClick=hnefataflNameSpace.currentPlayersTurn,hnefataflNameSpace.gameMode="play","undefined"!=typeof gameMode&&(gameMode="hnefataflGame")},draw:function(){var a;hnefataflNameSpace.gameContext.drawImage(hnefataflNameSpace.boardImage,0,0),"w"==hnefataflNameSpace.currentPlayer?hnefataflNameSpace.gameContext.drawImage(hnefataflNameSpace.activeWhiteImage,0,0):hnefataflNameSpace.gameContext.drawImage(hnefataflNameSpace.activeBlackImage,0,0),hnefataflNameSpace.highlightSquare.length>0&&hnefataflNameSpace.gameContext.drawImage(hnefataflNameSpace.highlightImage,hnefataflNameSpace.highlightSquare[0]*hnefataflNameSpace.squareSize+hnefataflNameSpace.boardInset,hnefataflNameSpace.highlightSquare[1]*hnefataflNameSpace.squareSize+hnefataflNameSpace.boardInset);for(var e=0;e<hnefataflNameSpace.board.length;e++)for(var f=0;f<hnefataflNameSpace.board[0].length;f++){switch(hnefataflNameSpace.board[e][f]){case"b":a=hnefataflNameSpace.blackPieceImage;break;case"w":a=hnefataflNameSpace.whitePieceImage;break;case"W":a=hnefataflNameSpace.kingImage;break;default:a=""}""!=a&&(f+"_"+e in hnefataflNameSpace.animatingPieces?(hnefataflNameSpace.animatingPieces[f+"_"+e][0]>hnefataflNameSpace.animatingPieces[f+"_"+e][2]?hnefataflNameSpace.animatingPieces[f+"_"+e][0]-=hnefataflNameSpace.pieceSpeed:hnefataflNameSpace.animatingPieces[f+"_"+e][0]<hnefataflNameSpace.animatingPieces[f+"_"+e][2]&&(hnefataflNameSpace.animatingPieces[f+"_"+e][0]+=hnefataflNameSpace.pieceSpeed),hnefataflNameSpace.animatingPieces[f+"_"+e][1]-hnefataflNameSpace.animatingPieces[f+"_"+e][3]>=hnefataflNameSpace.pieceSpeed?hnefataflNameSpace.animatingPieces[f+"_"+e][1]-=hnefataflNameSpace.pieceSpeed:hnefataflNameSpace.animatingPieces[f+"_"+e][1]-hnefataflNameSpace.animatingPieces[f+"_"+e][3]<=-hnefataflNameSpace.pieceSpeed&&(hnefataflNameSpace.animatingPieces[f+"_"+e][1]+=hnefataflNameSpace.pieceSpeed),hnefataflNameSpace.gameContext.drawImage(a,hnefataflNameSpace.animatingPieces[f+"_"+e][0]-hnefataflNameSpace.pieceGraphicalOffset,hnefataflNameSpace.animatingPieces[f+"_"+e][1]-hnefataflNameSpace.pieceGraphicalOffset),hnefataflNameSpace.animatingPieces[f+"_"+e][1]==hnefataflNameSpace.animatingPieces[f+"_"+e][3]&&Math.abs(hnefataflNameSpace.animatingPieces[f+"_"+e][0]-hnefataflNameSpace.animatingPieces[f+"_"+e][2])<hnefataflNameSpace.pieceSpeed&&(delete hnefataflNameSpace.animatingPieces[f+"_"+e],hnefataflNameSpace.checkForPiecesToRemove()),f+"_"+e in hnefataflNameSpace.animatingPieces&&hnefataflNameSpace.animatingPieces[f+"_"+e][0]==hnefataflNameSpace.animatingPieces[f+"_"+e][2]&&Math.abs(hnefataflNameSpace.animatingPieces[f+"_"+e][1]-hnefataflNameSpace.animatingPieces[f+"_"+e][3])<hnefataflNameSpace.pieceSpeed&&(delete hnefataflNameSpace.animatingPieces[f+"_"+e],hnefataflNameSpace.checkForPiecesToRemove())):hnefataflNameSpace.gameContext.drawImage(a,hnefataflNameSpace.getTilePosition(f)-hnefataflNameSpace.pieceGraphicalOffset,hnefataflNameSpace.getTilePosition(e)-hnefataflNameSpace.pieceGraphicalOffset))}},isEmpty:function(a){for(var e in a)if(a.hasOwnProperty(e))return!1;return JSON.stringify(a)===JSON.stringify({})},update:function(){hnefataflNameSpace.isPlayer1AI&&hnefataflNameSpace.player1==hnefataflNameSpace.currentPlayer&&"w"==hnefataflNameSpace.player1&&(hnefataflNameSpace.AIisWaitingToMove?(hnefataflNameSpace.AIisWaitingToMove=!1,hnefataflNameSpace.doAIMove()):hnefataflNameSpace.isEmpty(hnefataflNameSpace.animatingPieces)&&(hnefataflNameSpace.AIisWaitingToMove=!0))},doAIMove:function(){console.log("ai go");for(var a,e,f,t,n,c,l=[[-1,0],[1,0],[0,-1],[0,1]],h=0;h<hnefataflNameSpace.board.length;h++)for(var m=0;m<hnefataflNameSpace.board[0].length;m++)if(hnefataflNameSpace.board[h][m].toLowerCase()==hnefataflNameSpace.player1)for(var i=0;i<l.length;i++)n=h+l[i][0],(c=m+l[i][1])>=0&&n>=0&&c<hnefataflNameSpace.board.length&&n<hnefataflNameSpace.board.length&&"0"==hnefataflNameSpace.board[n][c]&&(a=c,e=n,f=m,t=h);hnefataflNameSpace.makeMove(f,t,a,e)}};