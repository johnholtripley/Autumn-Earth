function uniqueValues(e){var r={};return e.filter(function(e){return r.hasOwnProperty(e)?!1:r[e]=!0})}function sortByHighestValue(e,r){return e[0]<r[0]?1:e[0]>r[0]?-1:0}function compareZIndex(e,r){return e.zIndex<r.zIndex?-1:e.zIndex>r.zIndex?1:0}function getRandomInteger(e,r){return Math.floor(Math.random()*(r-e+1))+e}function loadingProgress(){console.log("loading - "+Loader.getProgress())}function getCanvasPosition(){canvasElemCoords=document.getElementById("cardGame").getBoundingClientRect(),outerCanvasLeft=canvasElemCoords.left,outerCanvasTop=canvasElemCoords.top,outerCanvasWidth=canvasElemCoords.right-canvasElemCoords.left,outerCanvasHeight=canvasElemCoords.bottom-canvasElemCoords.top,pageLoadScroll=document.body.scrollTop+document.documentElement.scrollTop}function initCardGame(){getCanvasPosition(),gameCanvas=document.getElementById("cardGame"),gameCanvas.getContext&&(gameContext=gameCanvas.getContext("2d"),canvasWidth=gameCanvas.width,canvasHeight=gameCanvas.height),cards=[];for(var e=0;e<numberOfCardsInGame;e++)cards[e]={x:-100,y:-100,index:e,zIndex:0,flippedAnimation:0,isMovingToBoard:!1,originalOwner:e>=numberOfCardsInGame/2?2:1,hasBeenPlaced:!1,cardType:allCardsThisGame[e],currentOwner:e>=numberOfCardsInGame/2?2:1,draw:function(){offsetX=0,offsetY=0,this.flippedAnimation>0&&(randomAmount=4*this.flippedAnimation,offsetX=getRandomInteger(0,randomAmount),offsetY=getRandomInteger(0,randomAmount),this.flippedAnimation--,0==this.flippedAnimation&&(this.zIndex=0)),gameContext.fillStyle=playerColours[this.currentOwner],gameContext.fillRect(this.x+offsetX,this.y+offsetY,cardWidth,cardHeight),gameContext.drawImage(cardImages[this.cardType],this.x+offsetX,this.y+offsetY)}};cardImages=[];for(var e=1;numberOfCardTypes>=e;e++)cardImages[e]=Loader.getImage("card"+e);boardImage=Loader.getImage("board"),currentCardSelectedImage=Loader.getImage("selected"),currentCardSelected={draw:function(){-1!=currentlySelectedCard&&gameContext.drawImage(currentCardSelectedImage,cards[currentlySelectedCard].x-20,cards[currentlySelectedCard].y-20)}},currentPlayerMarkerImage=Loader.getImage("current"),currentPlayerMarker={xScale:1,increment:-.05,draw:function(){this.xScale+=this.increment,Math.abs(this.xScale)>1&&(this.increment*=-1),gameContext.save(),this.x=1==currentPlayersTurn?84:925,gameContext.translate(this.x,20),gameContext.scale(this.xScale,1),gameContext.drawImage(currentPlayerMarkerImage,0-currentPlayerMarkerImage.width/2,0),gameContext.restore()}},placeCardOnBoard(0,boardWidth/2-1,boardHeight/2-1,!0),placeCardOnBoard(1,boardWidth/2,boardHeight/2,!0),placeCardOnBoard(numberOfCardsInGame/2,boardWidth/2,boardHeight/2-1,!0),placeCardOnBoard(numberOfCardsInGame/2+1,boardWidth/2-1,boardHeight/2,!0);for(var r=2,a=numberOfCardsInGame/2+2,t=0;t<boardWidth;t++)for(var o=0;o<boardHeight;o++)"#"==board[o][t]?(placeCardOnBoard(r,t,o,!1),r++):"@"==board[o][t]&&(placeCardOnBoard(a,t,o,!1),a++);placedCards=4,currentPlayersTurn=getRandomInteger(1,2),currentlySelectedCard=-1,currentOpponent=1,isPlayer1AI=!0,isNetworkOpponent=!1,whoCanClick=currentPlayersTurn,gameMode="play",aiIsWorking=-1,waitForDrawUpdate=!1,1==currentPlayersTurn&&(currentOpponent=2,isPlayer1AI&&doAIMove())}function placeCardOnBoard(e,r,a,t){board[a][r]=e,cards[e].x=r*cardWidth,cards[e].y=a*cardHeight,cards[e].hasBeenPlaced=t}function update(){waitForDrawUpdate&&(doAIMove(),waitForDrawUpdate=!1);for(var e=0;e<numberOfCardsInGame;e++)if(cards[e].isMovingToBoard){var r=cards[e].gridX*cardWidth,a=cards[e].gridY*cardHeight;if(cards[e].x-=.3*(cards[e].x-r),cards[e].y-=.3*(cards[e].y-a),Math.abs(cards[e].x-r)<10&&Math.abs(cards[e].y-a)<10){if(cards[e].isMovingToBoard=!1,cards[e].x=cards[e].gridX*cardWidth,cards[e].y=cards[e].gridY*cardHeight,cards[e].hasBeenPlaced=!0,cards[e].zIndex=0,checkAttacksInAllDirections(cards[e].gridX,cards[e].gridY,board,cards,currentOpponent,currentPlayersTurn,!1),placedCards++,placedCards==numberOfCardsInGame){gameMode="gameover";for(var t=0,o=0,n=0;n<numberOfCardsInGame;n++)1==cards[n].currentOwner?t++:o++;o>t?playerColours[1]="#665200":t>o&&(playerColours[2]="#660052"),draw()}var s=currentPlayersTurn;currentPlayersTurn=currentOpponent,currentOpponent=s,1==currentPlayersTurn&&isPlayer1AI&&(waitForDrawUpdate=!0)}}aiIsWorking>0&&(aiIsWorking++,aiIsWorking>36&&(aiIsWorking=-1,currentlySelectedCard=whichMoveToMake[1],cards[currentlySelectedCard].isMovingToBoard=!0,cards[currentlySelectedCard].gridX=whichMoveToMake[2],cards[currentlySelectedCard].gridY=whichMoveToMake[3],board[whichMoveToMake[3]][whichMoveToMake[2]]=currentlySelectedCard,cards[currentlySelectedCard].zIndex=1,currentlySelectedCard=-1,whoCanClick=2))}function draw(){gameContext.drawImage(boardImage,0,0);for(var e=cards.slice(),r=e.sort(compareZIndex),a=0;a<numberOfCardsInGame;a++)cards[r[a].index].draw();currentCardSelected.draw(),currentPlayerMarker.draw()}function isValidMove(e,r,a){for(var t=!1,o=e-1;e+1>=o;o++)for(var n=r-1;r+1>=n;n++)n>=0&&n<boardHeight&&(isNaN(a[n][o])||(t=!0));return t}function checkAttacksInAllDirections(e,r,a,t,o,n,s){checkAttack(e,r,-1,0,a,t,o,n,s),checkAttack(e,r,1,0,a,t,o,n,s),checkAttack(e,r,0,-1,a,t,o,n,s),checkAttack(e,r,0,1,a,t,o,n,s),checkAttack(e,r,-1,-1,a,t,o,n,s),checkAttack(e,r,1,1,a,t,o,n,s),checkAttack(e,r,-1,1,a,t,o,n,s),checkAttack(e,r,1,-1,a,t,o,n,s)}function checkAttack(e,r,a,t,o,n,s,i,d){var c=0,l=[],u=e+a,h=r+t;do{var g=!1;if(h>=0&&h<boardHeight){var m=o[h][u];if(!isNaN(m)&&n[m].currentOwner==s){g=!0,l.push(m);var f=n[m].cardType;c+=parseInt(allCardData[f][1]),u+=a,h+=t}}}while(g);var v=n[o[r][e]].cardType,C=parseInt(allCardData[v][0]);if(h>=0&&h<boardHeight&&!isNaN(o[h][u])&&n[o[h][u]].currentOwner==i){var p=n[o[h][u]].cardType,b=parseInt(allCardData[p][0]);if(C+b>=c)if(d){thisMovesScore+=l.length;for(var w=0;w<l.length;w++)n[l[w]].currentOwner=i}else for(var w=0;w<l.length;w++)flipCard(l[w],n,i)}}function flipCard(e,r,a){r[e].currentOwner=a,r[e].flippedAnimation=10,r[e].zIndex=1}function insertNewMove(e,r){return r.splice(locationOfBestScores(e,r)+1,0,e),r}function locationOfBestScores(e,r,a,t){a=a||0,t=t||r.length;var o=parseInt(a+(t-a)/2,10);return r[o][0]===e[0]?o:1>=t-a?r[o][0]<e[0]?o-1:o:r[o][0]>e[0]?locationOfBestScores(e,r,o,t):locationOfBestScores(e,r,a,o)}function findLowestScoreInGroup(){for(var e=99999,r=0;r<thisGroupsScore.length;r++){var a=cards[listOfPossibleBestMoves[thisGroupsScore[r]][1]].cardType,t=parseInt(allCardData[a][0])+parseInt(allCardData[a][1]);e>t&&(e=t)}for(var r=0;r<thisGroupsScore.length;r++){var a=cards[listOfPossibleBestMoves[thisGroupsScore[r]][1]].cardType,t=parseInt(allCardData[a][0])+parseInt(allCardData[a][1]);t!=e&&indexesToRemove.push(thisGroupsScore[r])}thisGroupsScore=[],thisGroupsScore.push(indexToCheck)}function doAIMove(){console.log("AI thinking..."),aiIsWorking=1,findBestMove(board,currentPlayersTurn,cards)}function findBestMove(e,r){whichOpponentCurrently=1==r?2:1,listOfPossibleBestMoves=[[-999999,-1,-1,-1]];for(var a=2,t=0,o=a;o<boardWidth-a;o++)for(var n=t;n<boardHeight-t;n++)if("-"==e[n][o]&&isValidMove(o,n,e))for(var s=[],i=0;i<numberOfCardsInGame;i++)if(1==cards[i].currentOwner&&!cards[i].hasBeenPlaced&&-1==s.indexOf(cards[i].cardType)){s.push(cards[i].cardType);for(var d=[],c=0;c<numberOfCardsInGame;c++)d[c]={index:cards[c].index,originalOwner:cards[c].originalOwner,hasBeenPlaced:cards[c].hasBeenPlaced,cardType:cards[c].cardType,currentOwner:cards[c].currentOwner};for(var l=[],u=0;u<e.length;u++)l[u]=e[u].slice();l[n][o]=i,d[i].hasBeenPlaced=!0,thisMovesScore=0,checkAttacksInAllDirections(o,n,l,d,whichOpponentCurrently,r,!0),AIScore=1.01*thisMovesScore,bestCounterMove=0,bestCounterMovePositions=[],whichCounterPlayerCurrently=whichOpponentCurrently,whichCounterOpponentCurrently=r;for(var h=a;h<boardWidth-a;h++)for(var u=t;u<boardHeight-t;u++)if("-"==l[u][h]&&isValidMove(h,u,l))for(var g=[],m=0;m<numberOfCardsInGame;m++)if(2==d[m].currentOwner&&!d[m].hasBeenPlaced&&-1==g.indexOf(d[m].cardType)){g.push(d[m].cardType);for(var f=[],c=0;c<numberOfCardsInGame;c++)f[c]={index:d[c].index,originalOwner:d[c].originalOwner,hasBeenPlaced:d[c].hasBeenPlaced,cardType:d[c].cardType,currentOwner:d[c].currentOwner};for(var v=[],c=0;c<l.length;c++)v[c]=l[c].slice();v[u][h]=m,f[m].hasBeenPlaced=!0,thisMovesScore=0,checkAttacksInAllDirections(h,u,v,f,whichCounterOpponentCurrently,whichCounterPlayerCurrently,!0),thisMovesScore>bestCounterMove?(bestCounterMove=thisMovesScore,bestCounterMovePositions=[h+","+u]):thisMovesScore==bestCounterMove&&bestCounterMovePositions.push(h+","+u)}thisMovesScore=AIScore-bestCounterMove,listOfPossibleBestMoves=insertNewMove([thisMovesScore,i,o,n],listOfPossibleBestMoves),listOfPossibleBestMoves.length>10&&listOfPossibleBestMoves.pop()}-999999==listOfPossibleBestMoves[listOfPossibleBestMoves.length-1][0]&&listOfPossibleBestMoves.pop();for(var C=0;C<listOfPossibleBestMoves.length;C++){var p=listOfPossibleBestMoves[C][2]+","+listOfPossibleBestMoves[C][3];-1!=bestCounterMovePositions.indexOf(p)&&(listOfPossibleBestMoves[C][0]+=.001)}listOfPossibleBestMoves.sort(sortByHighestValue),indexToCheck=0;var b=listOfPossibleBestMoves[indexToCheck][0];thisGroupsScore=[],indexesToRemove=[];do{var w=listOfPossibleBestMoves[indexToCheck][0];w==b?thisGroupsScore.push(indexToCheck):findLowestScoreInGroup(),b=w,indexToCheck++}while(indexToCheck<listOfPossibleBestMoves.length);thisGroupsScore.length==listOfPossibleBestMoves.length&&findLowestScoreInGroup();for(var y=indexesToRemove.length-1;y>=0;y--)listOfPossibleBestMoves.splice(indexesToRemove[y],1);console.log(listOfPossibleBestMoves);var M=player2Skill,O=0;do if(O++,O==listOfPossibleBestMoves.length)break;while(listOfPossibleBestMoves[O][0]==listOfPossibleBestMoves[0][0]);O>M&&(M=O),M>listOfPossibleBestMoves.length&&(M=listOfPossibleBestMoves.length-1),whichMoveToMake=listOfPossibleBestMoves[Math.floor(Math.random()*M)]}function canvasClick(e){var r=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft-outerCanvasLeft,a=e.clientY+document.body.scrollTop+document.documentElement.scrollTop-outerCanvasTop-pageLoadScroll;switch(gameMode){case"play":gridX=Math.floor(r/outerCanvasWidth*boardWidth),gridY=Math.floor(a/outerCanvasHeight*boardHeight);var t=board[gridY][gridX];if("-"==t)-1!=currentlySelectedCard&&isValidMove(gridX,gridY,board)&&(cards[currentlySelectedCard].isMovingToBoard=!0,cards[currentlySelectedCard].gridX=gridX,cards[currentlySelectedCard].gridY=gridY,board[gridY][gridX]=currentlySelectedCard,cards[currentlySelectedCard].zIndex=1,currentlySelectedCard=-1,whoCanClick=currentOpponent);else if("x"!=t){var o=!1;cards[t].hasBeenPlaced||cards[t].currentOwner==whoCanClick&&(o=!0),isPlayer1AI&&1==whoCanClick&&(o=!1),o&&(currentlySelectedCard=t)}}}function gameLoop(){setTimeout(function(){switch(window.requestAnimationFrame(gameLoop),gameMode){case"loading":console.log("loading...");break;case"play":update(),draw();break;case"gameover":console.log("game over")}},1e3/framesPerSecond)}if(framesPerSecond=24,playerColours=["","#ffcc00","#ff00cc"],cardWidth=84,cardHeight=102,allCardsThisGame=player1Cards.concat(player2Cards),numberOfCardsInGame=allCardsThisGame.length,board=[["#","#","x","x","x","-","-","x","x","x","x","x"],["#","#","x","x","-","-","-","-","x","x","@","@"],["#","#","x","-","-","-","-","-","-","x","@","@"],["#","#","x","-","-","-","-","-","-","x","@","@"],["#","#","x","x","-","-","-","-","x","x","@","@"],["x","x","x","x","x","-","-","x","x","x","@","@"]],boardWidth=board[0].length,boardHeight=board.length,function(){for(var e=0,r=["ms","moz","webkit","o"],a=0;a<r.length&&!window.requestAnimationFrame;++a)window.requestAnimationFrame=window[r[a]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[r[a]+"CancelAnimationFrame"]||window[r[a]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(r,a){var t=(new Date).getTime(),o=Math.max(0,16-(t-e)),n=window.setTimeout(function(){r(t+o)},o);return e=t+o,n}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),window.Loader=function(){function e(){}function r(){}function a(a){++d,e(i()),d==l&&(c=!1,r())}function t(e){console.log("Error on loading the image: "+e.srcElement)}function o(e,r){try{u[e]=new Image,u[e].onload=function(){a(e)},u[e].onerror=t,u[e].src=r}catch(o){console.log(o.message)}}function n(e){return u[e]?u[e]:void 0}function s(a,t,n){if(!c){c=!0;try{l=a.length,e=n||function(){},r=t||function(){};for(var s=0;s<a.length;++s)o(a[s].name,a[s].src)}catch(i){console.log(i.message)}}}function i(){return d/l*100}var d=0,c=!1,l=0,u={};return{preload:s,getProgress:i,getImage:n,images:u}}(),cutsTheMustard&&supportsCanvas()){allCardsToLoadThisGame=uniqueValues(allCardsThisGame);for(var numberOfCardTypes=allCardsToLoadThisGame.length,imagesToLoad=[{name:"board",src:"/images/card-game/board.jpg"},{name:"selected",src:"/images/card-game/selected-card.png"},{name:"current",src:"/images/card-game/current-player.png"}],i=1;numberOfCardTypes>=i;i++)imagesToLoad.push({name:"card"+i,src:"/images/card-game/cards/"+i+".png"});document.getElementById("cardGame").addEventListener("click",function(e){canvasClick(e),e&&e.preventDefault()},!1),canvasResizeHandler=debounce(function(){getCanvasPosition()},250),window.addEventListener("resize",canvasResizeHandler),gameMode="loading",gameLoop(),Loader.preload(imagesToLoad,initCardGame,loadingProgress)}