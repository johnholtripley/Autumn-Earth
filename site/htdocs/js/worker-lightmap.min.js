"use strict";var thisMapData,mapTilesY,mapTilesX,herosTileX,herosTileY,herosLineOfSightRange,lightMap,oldBright;const directionDiagonals=[[-1,-1],[1,-1],[-1,1],[1,1]],persistentLightLevel=.4;function getRadiusFromHero(i,e){var t=herosTileX-i,a=herosTileY-e;return Math.sqrt(t*t+a*a)}function tileIsBlocked(i,e){if(thisMapData.collisions[e][i]>=1)return!0;var t;if(void 0!==thisMapData.innerDoors)for(var a in thisMapData.innerDoors)if(!(t=thisMapData.innerDoors[a]).isOpen&&t.tileX==i&&t.tileY==e)return!0;return!1}function castLight(i,e,t,a,s,r,o){var n,h,l,g,p,f,L,c,d,M=0,T=!1;if(!(e<t))for(n=i;n<=herosLineOfSightRange;n++)if(!T)for(l=-n,h=-n;h<=0;h++)if(p=herosTileY+h*r+l*o,f=(h-.5)/(l+.5),L=(h+.5)/(l-.5),(g=herosTileX+h*a+l*s)>=0&&p>=0&&g<mapTilesX&&p<mapTilesY&&!(e<L)){if(t>f)break;if((d=getRadiusFromHero(g,p))<=herosLineOfSightRange&&(c=1-d/herosLineOfSightRange,oldBright=lightMap[p][g],c<persistentLightLevel&&oldBright>=persistentLightLevel&&(c=persistentLightLevel),lightMap[p][g]=c),T){if(tileIsBlocked(g,p)){M=L;continue}T=!1,e=M}else tileIsBlocked(g,p)&&n<herosLineOfSightRange&&(T=!0,castLight(n+1,e,f,a,s,r,o),M=L)}}onmessage=function(i){thisMapData=i.data[0],herosTileX=i.data[1],herosTileY=i.data[2],herosLineOfSightRange=i.data[3],mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length,lightMap=i.data[4];for(var e=mapTilesY-1;e>=0;e--)for(var t=mapTilesX-1;t>=0;t--)lightMap[e][t]>persistentLightLevel&&(lightMap[e][t]=persistentLightLevel);for(var a in lightMap[herosTileY][herosTileX]=1,directionDiagonals)castLight(1,1,0,0,directionDiagonals[a][0],directionDiagonals[a][1],0),castLight(1,1,0,directionDiagonals[a][0],0,0,directionDiagonals[a][1]);postMessage(lightMap)};