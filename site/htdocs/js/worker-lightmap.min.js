"use strict";function getRadiusFromHero(i,e){var a=herosTileX-i,t=herosTileY-e;return Math.sqrt(a*a+t*t)}function tileIsBlocked(i,e){if(thisMapData.collisions[e][i]>=1)return!0;if("undefined"!=typeof thisMapData.innerDoors){var a;for(var t in thisMapData.innerDoors)if(a=thisMapData.innerDoors[t],!a.isOpen&&a.tileX==i&&a.tileY==e)return!0}return!1}function castLight(i,e,a,t,s,r,o){var n,h,l,g,f,p,c,T,d,D=0,M=!1;if(!(a>e))for(n=i;herosLineOfSightRange>=n;n++)if(!M)for(l=-n,h=-n;0>=h;h++)if(g=herosTileX+h*t+l*s,f=herosTileY+h*r+l*o,p=(h-.5)/(l+.5),c=(h+.5)/(l-.5),g>=0&&f>=0&&mapTilesX>g&&mapTilesY>f&&!(c>e)){if(a>p)break;if(d=getRadiusFromHero(g,f),herosLineOfSightRange>=d&&(T=1-d/herosLineOfSightRange,lightMap[f][g]=T),M){if(tileIsBlocked(g,f)){D=c;continue}M=!1,e=D}else tileIsBlocked(g,f)&&herosLineOfSightRange>n&&(M=!0,castLight(n+1,e,p,t,s,r,o),D=c)}}var thisMapData,mapTilesY,mapTilesX,herosTileX,herosTileY,herosLineOfSightRange,lightMap;const directionDiagonals=[[-1,-1],[1,-1],[-1,1],[1,1]];onmessage=function(i){thisMapData=i.data[0],herosTileX=i.data[1],herosTileY=i.data[2],herosLineOfSightRange=i.data[3],mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length,lightMap=[];for(var e=mapTilesY-1;e>=0;e--){for(var a=[],t=mapTilesX-1;t>=0;t--)a[t]=0;lightMap[e]=a}lightMap[herosTileY][herosTileX]=1;for(var s in directionDiagonals)castLight(1,1,0,0,directionDiagonals[s][0],directionDiagonals[s][1],0),castLight(1,1,0,directionDiagonals[s][0],0,0,directionDiagonals[s][1]);postMessage(lightMap)};