function getTileX(e,a){return Math.floor(e/tileW)}function getTileY(e,a){return Math.floor(a/tileW)}function getTileCentreCoordX(e,a){return tileW/2*(mapTilesY+a-e)}function getTileCentreCoordY(e,a){return tileH/2*(a+e)}function sortByIsoDepth(e,a){return e[0]<a[0]?-1:e[0]>a[0]?1:0}function findIsoDepth(e,a){return e*tileW+a*(mapTilesX+1)*tileW}function init(){gameCanvas=document.getElementById("gameWorld"),gameCanvas.getContext&&(gameContext=gameCanvas.getContext("2d"),canvasWidth=gameCanvas.width,canvasHeight=gameCanvas.height),getJSON("/data/"+characterId+"/map"+currentMap+".json",function(e){thisMapData=e.map,mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length,loadAssets()},function(e){alert("Error loading map data")}),gameMode="loading",gameLoop()}function prepareGame(){tileImages=[];for(var e=0;e<tileGraphicsToLoad.length;e++)tileImages[e]=Loader.getImage("tile"+e);heroImg=Loader.getImage("heroImg"),backgroundImg=Loader.getImage("backgroundImg"),Input.init(),hero.x=getTileCentreCoordX(hero.tileX,hero.tileY),hero.y=getTileCentreCoordY(hero.tileX,hero.tileY),console.log(hero.tileX+","+hero.tileY+" ==> "+hero.x+", "+hero.y),gameMode="play"}function loadAssets(){imagesToLoad=[],imagesToLoad.push({name:"heroImg",src:"/images/game-world/core/TEMP-link.png"}),imagesToLoad.push({name:"backgroundImg",src:"/images/game-world/maps/"+currentMap+"/bg.png"}),tileGraphicsToLoad=thisMapData.graphics;for(var e=0;e<tileGraphicsToLoad.length;e++)imagesToLoad.push({name:"tile"+e,src:"/images/game-world/maps/"+currentMap+"/"+tileGraphicsToLoad[e].src});Loader.preload(imagesToLoad,prepareGame,loadingProgress)}function loadingProgress(){console.log("loading - "+Loader.getProgress())}function checkCollisions(){thisMapData.collisions;key[2],key[3],key[0],key[1]}function gameLoop(){switch(gameMode){case"loading":break;case"paused":break;case"play":update(),draw()}window.requestAnimationFrame(gameLoop)}function update(){var e=window.performance.now(),a=e-lastTime;if(lastTime=e,hero.isMoving=!1,key[2]?(hero.isMoving=!0,hero.facing="up",hero.x+=hero.speed,hero.y-=hero.speed/2):key[3]?(hero.isMoving=!0,hero.facing="down",hero.x-=hero.speed,hero.y+=hero.speed/2):key[0]?(hero.isMoving=!0,hero.facing="left",hero.x-=hero.speed,hero.y-=hero.speed/2):key[1]&&(hero.isMoving=!0,hero.facing="right",hero.x+=hero.speed,hero.y+=hero.speed/2),checkCollisions(),hero.timeSinceLastFrameSwap+=a,hero.timeSinceLastFrameSwap>hero.animationUpdateTime){var t=(hero.isMoving?"walk-":"stand-")+hero.facing,o=hero.sequences[t];hero.animationFrameIndex<o.length-1?hero.animationFrameIndex+=1:hero.animationFrameIndex=0;var n=o[hero.animationFrameIndex]%7,i=Math.floor(o[hero.animationFrameIndex]/7);hero.offsetX=n*hero.width,hero.offsetY=i*hero.height,hero.timeSinceLastFrameSwap=0}}function draw(){for(var e,a,t=[[findIsoDepth(hero.x,hero.y),heroImg,hero.offsetX,hero.offsetY,hero.width,hero.height,canvasWidth/2-hero.feetOffsetX,canvasHeight/2-hero.feetOffsetY,hero.width,hero.height]],o=thisMapData.terrain,n=0;mapTilesY>n;n++)for(var i=0;mapTilesX>i;i++)"*"!=o[n][i]&&(thisX=getTileCentreCoordX(n,i),thisY=getTileCentreCoordY(n,i),e=thisMapData.graphics[o[n][i]].centreX,a=thisMapData.graphics[o[n][i]].centreY,t.push([findIsoDepth(thisX,thisY),tileImages[o[n][i]],thisX-hero.x-e+canvasWidth/2,thisY-hero.y-a+canvasHeight/2]),2==o[n][i]&&console.log("tile: "+n+", "+i+" ==> "+thisX+", "+thisY+" - "+(thisX-hero.x+canvasWidth/2,thisY-hero.y+canvasHeight/2)+", "+(thisY-hero.y+canvasHeight/2)));t.sort(sortByIsoDepth),gameContext.drawImage(backgroundImg,0,0);for(var n=0;n<t.length;n++)10==t[n].length?gameContext.drawImage(t[n][1],t[n][2],t[n][3],t[n][4],t[n][5],t[n][6],t[n][7],t[n][8],t[n][9]):gameContext.drawImage(t[n][1],t[n][2],t[n][3])}var animationFramesPerSecond=16,lastTime=0,elapsed=0,characterId="chr-html5",currentMap=1,thisMapData="",mapTilesX=0,mapTilesY=0,tileGraphics=[],tileW=48,tileH=tileW/2,tileGraphicsToLoad=0,canvasWidth=256,canvasHeight=176,worldOffsetX=0,worldOffsety=0,key=[0,0,0,0,0],hero={x:0,y:0,dx:0,dy:0,tileX:2,tileY:3,width:17,height:25,feetOffsetX:8,feetOffsetY:21,speed:2,animationFrameIndex:0,timeSinceLastFrameSwap:0,animationUpdateTime:1e3/animationFramesPerSecond,isMoving:!1,facing:"down",sequences:{"stand-down":[3],"stand-up":[10],"stand-right":[17],"stand-left":[24],"walk-down":[3,4,5,6,5,4,3,2,1,0,1,2],"walk-up":[10,11,12,13,12,11,10,9,8,7,8,9],"walk-right":[17,18,19,20,19,18,17,16,15,14,15,16],"walk-left":[24,25,26,27,26,25,24,23,22,21,22,23]}};!function(){for(var e=0,a=["ms","moz","webkit","o"],t=0;t<a.length&&!window.requestAnimationFrame;++t)window.requestAnimationFrame=window[a[t]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[a[t]+"CancelAnimationFrame"]||window[a[t]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(a,t){var o=(new Date).getTime(),n=Math.max(0,16-(o-e)),i=window.setTimeout(function(){a(o+n)},n);return e=o+n,i}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}();var getJSON=function(e,a,t){var o="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");o.open("get",e,!0),o.onreadystatechange=function(){var e,n;4==o.readyState&&(e=o.status,200==e?(n=JSON.parse(o.responseText),a&&a(n)):t&&t(e))},o.send()};window.Loader=function(){function e(){}function a(){}function t(t){++h,e(s()),h==d&&(g=!1,a())}function o(e){console.log("Error on loading the image: "+e.srcElement)}function n(e,a){try{c[e]=new Image,c[e].onload=function(){t(e)},c[e].onerror=o,c[e].src=a}catch(n){console.log(n.message)}}function i(e){return c[e]?c[e]:void 0}function r(t,o,i){if(!g){g=!0;try{d=t.length,e=i||function(){},a=o||function(){};for(var r=0;r<t.length;++r)n(t[r].name,t[r].src)}catch(s){console.log(s.message)}}}function s(){return h/d*100}var h=0,g=!1,d=0,c={};return{preload:r,getProgress:s,getImage:i,images:c}}();var Input={init:function(){document.addEventListener("keydown",function(e){Input.changeKey(e.keyCode,1)}),document.addEventListener("keyup",function(e){Input.changeKey(e.keyCode,0)})},changeKey:function(e,a){switch(e){case KeyBindings.left:key[0]=a;break;case KeyBindings.up:key[2]=a;break;case KeyBindings.right:key[1]=a;break;case KeyBindings.down:key[3]=a;break;case KeyBindings.action:key[4]=a}}},KeyBindings={left:37,right:39,up:38,down:40,action:32,pause:80};"serviceWorker"in navigator&&navigator.serviceWorker.register("/game-world/serviceWorker.min.js",{scope:"/game-world/"}),"querySelectorAll"in document&&"addEventListener"in window&&window.HTMLCanvasElement&&init();