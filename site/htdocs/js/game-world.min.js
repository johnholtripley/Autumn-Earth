function updateCartographicMiniMap(){var e=246/(mapTilesX*tileW),t=hero.x*e,a=hero.y*e,r=0,n=35,o=offScreenCartographyContext.createRadialGradient(t,a,r,t,a,n);o.addColorStop(0,"rgb(255,255,255)"),o.addColorStop(1,"rgba(255,255,255,0)"),offScreenCartographyContext.arc(t,a,n,0,2*Math.PI),offScreenCartographyContext.fillStyle=o,offScreenCartographyContext.fill(),cartographyContext.clearRect(0,0,246,246),cartographyContext.globalCompositeOperation="copy",cartographyContext.drawImage(offScreenCartographyCanvas,0,0),cartographyContext.globalCompositeOperation="source-atop",cartographyContext.drawImage(canvasMapImage,0,0)}function initCartographicMap(){canvasMapImage.src="/game-world/generateCartographicMap.php?playerId="+characterId+"&dungeonName="+randomDungeonName+"&plotChests=true&requestedMap="+newMap,canvasMapImage.onload=function(){canvasMapMaskImage.src="/game-world/getCartographicMapMask.php?chr="+characterId+"&dungeonName="+randomDungeonName+"&currentMap="+newMap+"&cache="+Date.now(),canvasMapMaskImage.onload=function(){offScreenCartographyContext.clearRect(0,0,246,246),offScreenCartographyContext.drawImage(canvasMapMaskImage,0,0),updateCartographicMiniMap()}}}function saveCartographyMask(){var e=offScreenCartographyCanvas.toDataURL();postData("/game-world/saveCartographicMapMask.php","chr="+characterId+"&dungeonName="+randomDungeonName+"&currentMap="+currentMap+"&data="+e)}function getColourName(e,t){var a="";return 1!=currentActiveInventoryItems[t].hasInherentColour&&(a=colourNames[e]),a}function mixColours(){for(var e=0,t=0,a=0,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],n=0;n<arguments.length;n++)r[arguments[n]]++,e|=arguments[n],arguments[n]==(16|arguments[n])&&t++,arguments[n]==(8|arguments[n])&&a++;for(var n=0;n<r.length;n++)if(r[n]/arguments.length>.7){e=n;break}return e>24&&(e-=t>a?8:a>t?16:24),e}function recipeSearchAndFilter(){var e=hero.crafting[currentRecipePanelProfession].sortOrder;if(""!=recipeSearch.value){var t=recipeSearch.value.toLowerCase();e=[];for(var a in hero.crafting[currentRecipePanelProfession].recipes)-1!=hero.crafting[currentRecipePanelProfession].recipes[a].recipeName.toLowerCase().indexOf(t)?e.push(a):-1!=hero.crafting[currentRecipePanelProfession].recipes[a].recipeDescription.toLowerCase().indexOf(t)&&e.push(a)}var r,n=document.querySelectorAll("#createRecipeList li");for(r=0;r<n.length;++r)n[r].classList.remove("active");var o=0;for(r=0;r<e.length;r++)-1!=recipeFilter.value.indexOf(e[r])&&(document.getElementById("recipe"+e[r]).classList.add("active"),o++);0==o&&document.getElementById("noRecipesFound").classList.add("active"),""!=UI.highlightedRecipe&&(document.getElementById(UI.highlightedRecipe).classList.contains("active")||(document.getElementById(UI.highlightedRecipe).classList.remove("highlighted"),craftingRecipeCreateButton.disabled=!0,UI.highlightedRecipe=""))}function recipeSearchInput(){""!=recipeSearch.value?clearRecipeSearch.classList.add("active"):clearRecipeSearch.classList.remove("active"),recipeSearchAndFilter()}function recipeSearchClear(){recipeSearch.value="",clearRecipeSearch.classList.remove("active"),recipeSearchAndFilter()}function recipeSelectComponents(e){var t,a=e.substring(6),r=hero.crafting[currentRecipePanelProfession].recipes[a],n='<img src="/images/game-world/inventory-items/'+r.imageId+'.png" alt="'+r.recipeName+'"><h3>'+r.recipeName+"</h3><p>"+r.recipeDescription+"</p><h4>Requires:</h4>",o="<h4>Available:</h4><ul>",i=r.components.split(","),s=0;n+="<ul>";for(var c=0;c<i.length;c++)if(isNaN(i[c])){if(n+='<li><img src="/images/game-world/inventory-items/'+i[c]+'.png" alt="">'+currentItemGroupFilters[i[c]]+"</li>",t=hasItemTypeInInventory(i[c]),t.length>0)for(var l=0;l<t.length;l++)o+='<li id="fromSlot'+t[l]+'">'+generateSlotMarkup(t[l])+"</li>",s++}else if(n+='<li><img src="/images/game-world/inventory-items/'+i[c]+'.png" alt="'+currentActiveInventoryItems[i[c]].shortname+'">'+currentActiveInventoryItems[i[c]].shortname+"</li>",t=findSlotItemIdInInventory(i[c]),t.length>0)for(var l=0;l<t.length;l++)o+='<li id="fromSlot'+t[l]+'">'+generateSlotMarkup(t[l])+"</li>",s++;0==s&&(o+="<li><p>You don't have any of the required components for this recipe.</p></li>"),currentActiveInventoryItems[r.creates].dyeable>0&&(n+='<li><img src="/images/game-world/inventory-items/dye.png" alt="">Optional dye</li>'),n+='<li><img src="/images/game-world/inventory-items/enchant.png" alt="">Optional enchanted item</li>',n+="</ul>",o+="</ul>",selectComponentsItemBeingCreated.innerHTML=n,componentsAvailableForThisRecipe.innerHTML=o}function scrollbarWidth(){var e=document.createElement("div");e.style.cssText="width:50px;height:50px;overflow-y:scroll;top:-200px;left:-200px;position:absolute;";var t=0,a=0;document.body.appendChild(e),t=e.offsetWidth;var a=e.clientWidth;return document.body.removeChild(e),t-a}function handleScrollDrag(e){translateY=e.pageY-objInitTop,translateY<0&&(translateY=0),translateY+draggerHeight>paneHeight&&(translateY=paneHeight-draggerHeight),document.getElementById("dragger").style.transform="translateY("+translateY+"px)",document.getElementById("scrollingContent").scrollTop=translateY/scrollbarRatio}function endScrollDrag(e){isBeingDragged=!1,document.removeEventListener("mousemove",handleScrollDrag,!1),document.removeEventListener("mouseup",endScrollDrag,!1)}function initDragger(){translateY=0,isBeingDragged=!1;var e=document.getElementById("scrollingContent").scrollHeight;paneHeight=document.getElementById("scrollParent").offsetHeight,scrollbarRatio=paneHeight/e,draggerHeight=Math.floor(scrollbarRatio*paneHeight),document.getElementById("dragger").style.height=draggerHeight+"px",document.getElementById("dragger").addEventListener("mousedown",function(e){e.preventDefault();var t=(window.pageYOffset||document.documentElement.scrollTop)-(document.documentElement.clientTop||0),a=document.getElementById("dragger").getBoundingClientRect();objInitTop=a.top+t,objInitTop=e.pageY-translateY,isBeingDragged=!0,document.addEventListener("mousemove",handleScrollDrag,!1),document.addEventListener("mouseup",endScrollDrag,!1)}),document.getElementById("scrollingContent").addEventListener("scroll",startContentScroll)}function startContentScroll(){isBeingDragged||(scrollOffset=document.getElementById("scrollingContent").scrollTop,handleOffset=Math.round(scrollbarRatio*scrollOffset),translateY=handleOffset,document.getElementById("dragger").style.transform="translateY("+translateY+"px)")}function animateFae(){fae.z=Math.floor(8*(Math.sin(fae.dz)+1)+40),fae.dz+=.2;for(var e=0;e<fae.particles.length;e++)fae.particles[e].alpha-=.1,fae.particles[e].alpha<=0&&fae.particles.splice(e,1);if(fae.particles.length<fae.maxParticles&&1==getRandomInteger(1,2)){var t=findIsoCoordsX(fae.x,fae.y),a=findIsoCoordsY(fae.x,fae.y)-fae.z,r=t+getRandomInteger(0,8)-4,n=a+getRandomInteger(0,8)-4;isInRange(t,a,r,n,6)&&fae.particles.push({depth:findIsoCoordsY(fae.x,fae.y),isoX:r,isoY:n,alpha:1})}}function moveFae(){switch(fae.currentState){case"away":moveFaeToDestination(fae.targetX,fae.targetY);break;case"wait":isInRange(fae.x,fae.y,hero.x,hero.y,3*tileW)&&(fae.currentState="hero");break;default:fae.angleAroundHero+=4;var e=hero.x+fae.radiusAroundHero*Math.cos(fae.angleAroundHero*(Math.PI/180)),t=hero.y+fae.radiusAroundHero*Math.sin(fae.angleAroundHero*(Math.PI/180));moveFaeToDestination(e,t)}}function moveFaeToDestination(e,t){var a=getPythagorasDistance(fae.x,fae.y,e,t);if(a>fae.speed){var r=fae.speed/a;fae.x+=r*(e-fae.x),fae.y+=r*(t-fae.y)}else 2>a?(fae.x=e,fae.y=t,"away"==fae.currentState&&(fae.currentState="wait")):(fae.x+=(e-fae.x)/2,fae.y+=(t-fae.y)/2)}function getTileX(e){return Math.floor(e/tileW)}function getTileY(e){return Math.floor(e/tileW)}function findIsoCoordsX(e,t){return Math.floor(mapTilesY*tileW/2-t/2+e/2)}function findIsoCoordsY(e,t){return Math.floor(e/4+t/4-tileH/2)}function findIsoDepth(e,t,a){var r=(findIsoCoordsX(e,t),findIsoCoordsY(e,t));return r}function getTileCentreCoordX(e){return e*tileW+tileW/2}function getTileCentreCoordY(e){return e*tileW+tileW/2}function getTileIsoCentreCoordX(e,t){return tileW/2*(mapTilesY-t+e)}function getTileIsoCentreCoordY(e,t){return tileH/2*(t+e)}function getCurrentTileX(e){return Math.floor(e/tileW)}function getCurrentTileY(e){return Math.floor(e/tileW)}function getXOffsetFromHeight(e){return Math.sqrt(2)/2*e}function accessDynamicVariable(e){for(var t=e.split("."),a=window,r=0;r<t.length;r++)a[t[r]]&&(a=a[t[r]]);return a}function getNearestParentId(e){for(;!e.id;)e=e.parentNode;return e}function getObjectKeysForInnerValue(e,t,a){var r=[];for(var n in e)e.hasOwnProperty(n)&&e[n][a]===t&&r.push(n);return r}function isAnObjectCollision(e,t,a,r,n,o,i,s){return e+a/2>n-i/2&&n+i/2>e-a/2&&o+s/2>t-r/2&&t+r/2>o-s/2?!0:!1}function getRandomInteger(e,t){return Math.floor(Math.random()*(t-e))+e}function getRandomIntegerInclusive(e,t){return Math.floor(Math.random()*(t-e+1))+e}function isInRange(e,t,a,r,n){var o=getPythagorasDistance(e,t,a,r);return n>=o?!0:!1}function getPythagorasDistance(e,t,a,r){return Math.sqrt((e-a)*(e-a)+(t-r)*(t-r))}function turntoFace(e,t){var a=e.x-t.x,r=e.y-t.y;return Math.abs(a)>Math.abs(r)?a>0?"w":"e":r>0?"n":"s"}function isFacing(e,t){var a=!1;switch(e.facing){case"n":e.y>t.y&&(a=!0);break;case"s":e.y<t.y&&(a=!0);break;case"w":e.x>t.x&&(a=!0);break;case"e":e.x<t.x&&(a=!0)}return a}function parseMoney(e,t){var a="",r=e%100,n=(e-r)/100;return n>0&&(a=n+"G "),0!=r&&(a+=r+"S"),a}function hasLineOfSight(e,t,a,r){var n,o,i,s,c,l=e,d=t,h=[],p=[],g=r-t,u=a-e,m=0;if(c=0>g?-1:1,s=0>u?-1:1,g=Math.abs(2*g),u=Math.abs(2*u),o=e,i=t,u>g)for(n=2*g-u;l!=a;){if(n>=0&&(d+=c,n-=u),l+=s,n+=g,0!=thisMapData.collisions[d][l])return!1;h[m]=d-i,p[m]=l-o,i=d,o=l,m++}else for(n=2*u-g;d!=r;){if(n>=0&&(l+=s,n-=g),d+=c,n+=u,0!=thisMapData.collisions[d][l])return!1;h[m]=d-i,p[m]=l-o,i=d,o=l,m++}return!0}function determineWhichTransitionEvent(){var e,t=document.createElement("fakeelement"),a={transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"};for(e in a)if(void 0!==t.style[e])return a[e]}function uniqueValues(e){var t={};return e.filter(function(e){return t.hasOwnProperty(e)?!1:t[e]=!0})}function sortByHighestValue(e,t){return e[0]<t[0]?1:e[0]>t[0]?-1:0}function sortByLowestValue(e,t){return e[0]<t[0]?-1:e[0]>t[0]?1:0}function getRandomElementFromArray(e){return e[Math.floor(Math.random()*e.length)]}function drawCircle(e,t,a,r){gameContext.fillStyle=e,gameContext.beginPath(),gameContext.arc(t,a,r,0,2*Math.PI),gameContext.fill()}function sendDataWithoutNeedingAResponse(e){var t="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");t.open("get",e,!0),t.send()}function postData(e,t){var a="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");a.open("post",e,!0),a.setRequestHeader("Content-Type","application/x-www-form-urlencoded;"),a.send(t)}function cardGamePlayer2Wins(){hero.stats.cardGamesWon++,processSpeech(thisNPC,thisNPC.cardGameSpeech.lose[0],thisNPC.cardGameSpeech.lose[1]),whichCardWon=pickBestCardToTake(cardGameNameSpace.player1Cards),hero.cards.unshift(cardGameNameSpace.player1Cards[whichCardWon]);var e=thisNPC.uniqueCards.indexOf(cardGameNameSpace.player1Cards[whichCardWon]);-1!=e&&thisNPC.uniqueCards.splice(e,1),UI.showNotification("<p>You won a "+cardGameNameSpace.allCardData[cardGameNameSpace.player1Cards[whichCardWon]][2]+'</p><img class="card players" src="/images/card-game/cards/'+cardGameNameSpace.player1Cards[whichCardWon]+'.png">'),UI.updateCardAlbum(),closeCardGame()}function cardGamePlayer1Wins(){hero.stats.cardGamesLost++,processSpeech(thisNPC,thisNPC.cardGameSpeech.win[0],thisNPC.cardGameSpeech.win[1]),whichCardWon=pickBestCardToTake(cardGameNameSpace.player2Cards),thisNPC.uniqueCards.unshift(cardGameNameSpace.player2Cards[whichCardWon]);var e=hero.cards.indexOf(cardGameNameSpace.player2Cards[whichCardWon]);-1!=e&&hero.cards.splice(e,1),UI.showNotification("<p>You lost a "+cardGameNameSpace.allCardData[cardGameNameSpace.player2Cards[whichCardWon]][2]+'</p><img class="card npcs" src="/images/card-game/cards/'+cardGameNameSpace.player2Cards[whichCardWon]+'.png">'),UI.updateCardAlbum(),closeCardGame()}function cardGameIsDrawn(){hero.stats.cardGamesDrawn++,processSpeech(thisNPC,thisNPC.cardGameSpeech.draw[0],thisNPC.cardGameSpeech.draw[1]),closeCardGame()}function startCardGame(e){hero.cards.length>=12?(cardGameNameSpace.player2Cards=hero.cards.slice(0,12),cardGameNameSpace.player1Cards=e.uniqueCards.concat(allCardPacks[e.baseCardPack]).slice(0,12),cardGameNameSpace.player1Skill=e.cardSkill,cardGameNameSpace.initialiseCardGame(),cardGameWrapper.classList.add("active")):UI.showNotification("<p>You don't have enough cards</p>")}function closeCardGame(){gameMode="play",cardGameWrapper.classList.remove("active"),document.getElementById("cardGame").removeEventListener("click",cardGameNameSpace.canvasClick,!1)}function pickBestCardToTake(e){for(var t,a=-1,r=0,n=0;n<e.length;n++)t=cardGameNameSpace.allCardData[e[n]][0]*cardGameNameSpace.allCardData[e[n]][0]+cardGameNameSpace.allCardData[e[n]][1]*cardGameNameSpace.allCardData[e[n]][1],t>a&&(a=t,r=n);return r}function openBoosterPack(){boosterCardsToAdd=[];var e;do e=getRandomInteger(1,cardGameNameSpace.allCardData.length),-1==boosterCardsToAdd.indexOf(e)&&boosterCardsToAdd.push(e);while(boosterCardsToAdd.length<5);for(var t=document.getElementsByClassName("cardFlip"),a=0;a<t.length;a++)t[a].classList.remove("active");for(var a=0;5>a;a++)document.getElementById("boosterCard"+a).innerHTML='<img src="/images/card-game/cards/'+boosterCardsToAdd[a]+'.png" alt="'+cardGameNameSpace.allCardData[boosterCardsToAdd[a][3]]+'">';boosterPack.classList.add("active"),boosterCardsRevealed=0,boosterPack.addEventListener("click",revealBoosterCard,!1)}function revealBoosterCard(e){"IMG"==e.target.nodeName&&(e.target.parentNode.parentNode.parentNode.classList.add("active"),boosterCardsRevealed++,boosterCardsRevealed>=5&&(hero.cards=boosterCardsToAdd.concat(hero.cards),UI.updateCardAlbum(),boosterPack.classList.remove("active")))}function canAddItemToInventory(e){for(var t=JSON.parse(JSON.stringify(hero.inventory)),a=[],r=!0,n=0;n<e.length;n++){var o=0,i=getObjectKeysForInnerValue(t,e[n].type,"type");if(i.length>0)for(var s=0;s<i.length;s++)if(itemAttributesMatch(t[i[s]],e[n])){var c=t[i[s]].quantity,l=maxNumberOfItemsPerSlot-c>e[n].quantity-o?e[n].quantity-o:maxNumberOfItemsPerSlot-c;if(o+=l,a.push(i[s]),t[i[s]].quantity+=l,o>=e[n].quantity)break}if(o<e[n].quantity)e:for(var s=0;s<hero.bags.length;s++)for(var d=currentActiveInventoryItems[hero.bags[s].type].actionValue,h=0;d>h;h++){var p=s+"-"+h;if(!(p in t)){var l=maxNumberOfItemsPerSlot>e[n].quantity-o?e[n].quantity-o:maxNumberOfItemsPerSlot;if(o+=l,a.push(p),t[p]=new Object,t[p].type=e[n].type,t[p].quantity=l,t[p].quality=e[n].quality,t[p].durability=e[n].durability,t[p].currentWear=e[n].currentWear,t[p].effectiveness=e[n].effectiveness,t[p].wrapped=e[n].wrapped,t[p].colour=e[n].colour,t[p].enchanted=e[n].enchanted,t[p].hallmark=e[n].hallmark,t[p].inscription=e[n].inscription,o>=e[n].quantity)break e}}o!=e[n].quantity&&(r=!1)}return r?(hero.inventory=JSON.parse(JSON.stringify(t)),[!0,a]):[!1]}function hasItemInInventory(e,t){var a=0,r=getObjectKeysForInnerValue(hero.inventory,parseInt(e),"type");if(r.length>0)for(var n=0;n<r.length;n++)a+=hero.inventory[r[n]].quantity;return a>=t?!0:!1}function findSlotItemIdInInventory(e){var t=[];for(var a in hero.inventory)hero.inventory[a].type==e&&t.push(a);return t}function hasItemTypeInInventory(e){var t=[];for(var a in hero.inventory)currentActiveInventoryItems[hero.inventory[a].type].group==e&&t.push(a);return t}function removeItemTypeFromInventory(e,t){var a,r=t,n=getObjectKeysForInnerValue(hero.inventory,parseInt(e),"type");if(n.length>0)for(var o=0;o<n.length;o++)a=hero.inventory[n[o]].quantity,a>r?(removeFromInventory(n[o],r),r=0):(removeFromInventory(n[o],a),r-=a)}function addToInventory(e,t){hero.inventory[e]=JSON.parse(JSON.stringify(t)),document.getElementById("slot"+e).innerHTML=generateSlotMarkup(e)}function removeFromInventory(e,t){var a=hero.inventory[e].quantity,r=document.getElementById("slot"+e);if(a-t>0){hero.inventory[e].quantity-=t;for(var n=0;n<r.childNodes.length;n++)if("qty"==r.childNodes[n].className){r.childNodes[n].innerHTML=hero.inventory[e].quantity;break}}else delete hero.inventory[e],r.innerHTML=""}function itemAttributesMatch(e,t){return e.type==t.type&&e.quality==t.quality&&e.durability==t.durability&&e.currentWear==t.currentWear&&e.effectiveness==t.effectiveness&&e.colour==t.colour&&e.enchanted==t.enchanted&&e.hallmark==t.hallmark&&e.inscription==t.inscription&&e.contains==t.contains?!0:!1}function inventoryItemAction(e,t,a){var r=e.parentElement.id.substring(4);switch(t){case"container":"undefined"!=typeof hero.inventory[r].contains&&1==hero.inventory[r].contains.length&&1==hero.inventory[r].quantity&&(hero.inventory[r]=JSON.parse(JSON.stringify(hero.inventory[r].contains[0])),document.getElementById("slot"+r).innerHTML=generateSlotMarkup(r));break;case"booster":openBoosterPack(),removeFromInventory(r,1);break;case"recipe":canLearnRecipe(a)&&removeFromInventory(r,1);break;case"craft":-1!=professionsKnown.indexOf(a)?UI.populateRecipeList(a):UI.showNotification("<p>You don't know this profession yet.</p>")}}function additionalTooltipDetail(e){var t="";if("recipe"==currentActiveInventoryItems[hero.inventory[e].type].action){for(var a=!1,r=0;r<hero.recipesKnown.length;r++)hero.recipesKnown[r][0]==currentActiveInventoryItems[hero.inventory[e].type].actionValue&&(a=!0);a&&(t+=" (already known)")}return t}function generateSlotMarkup(e){var t="";return theColourPrefix="",thisFileColourSuffix="",thisColourName=getColourName(hero.inventory[e].colour,hero.inventory[e].type),""!=thisColourName&&(theColourPrefix=thisColourName+" ",thisFileColourSuffix="-"+thisColourName.toLowerCase()),thisAction=currentActiveInventoryItems[hero.inventory[e].type].action,dataActionMarkup="",thisAction&&(dataActionMarkup='data-action="'+thisAction+'" data-action-value="'+currentActiveInventoryItems[hero.inventory[e].type].actionValue+'" '),t+='<img src="/images/game-world/inventory-items/'+hero.inventory[e].type+thisFileColourSuffix+'.png" '+dataActionMarkup+'alt="'+theColourPrefix+currentActiveInventoryItems[hero.inventory[e].type].shortname+'">',t+="<p><em>"+theColourPrefix+currentActiveInventoryItems[hero.inventory[e].type].shortname+" </em>"+currentActiveInventoryItems[hero.inventory[e].type].description+' <span class="price">Sell price: '+parseMoney(hero.inventory[e].quantity*currentActiveInventoryItems[hero.inventory[e].type].priceCode,0)+"</span>"+additionalTooltipDetail(e)+"</p>",t+='<span class="qty">'+hero.inventory[e].quantity+"</span>"}function inventorySplitStackSubmit(e){e&&e.preventDefault();var t=splitStackInput.value,a=!0;if(t=parseInt(t),1>t&&(a=!1),Number.isInteger(t)||(a=!1),t>hero.inventory[UI.sourceSlot].quantity&&(a=!1),a){isSplitStackBeingDragged=!0;var r=document.getElementById("slot"+UI.sourceSlot);UI.activeDragObject=document.getElementById("draggableInventorySlot"),UI.activeDragObject.innerHTML=r.innerHTML,removeFromInventory(UI.sourceSlot,t),UI.draggedInventoryObject.quantity=t;for(var n=0;n<UI.activeDragObject.childNodes.length;n++)if("qty"==UI.activeDragObject.childNodes[n].className){UI.activeDragObject.childNodes[n].innerHTML=UI.draggedInventoryObject.quantity;break}UI.inDrag=!0;var o=r.getBoundingClientRect(),i=(window.pageYOffset||document.documentElement.scrollTop)-(document.documentElement.clientTop||0);objInitLeft=o.left+3,objInitTop=o.top+3+i,dragStartX=objInitLeft+22,dragStartY=objInitTop+22,UI.activeDragObject.style.cssText="z-index:2;top: "+objInitTop+"px; left: "+objInitLeft+"px; transform: translate(0px, 0px);",document.addEventListener("mousemove",UI.handleDrag,!1),document.addEventListener("mouseup",UI.endInventoryDrag,!1)}splitStackPanel.classList.remove("active")}function inventorySplitStackCancel(){splitStackPanel.classList.remove("active")}function init(){gameCanvas=document.getElementById("gameWorld"),gameCanvas.getContext&&(gameContext=gameCanvas.getContext("2d"),canvasWidth=gameCanvas.width,canvasHeight=gameCanvas.height,whichTransitionEvent=determineWhichTransitionEvent(),gameMode="mapLoading",cartographyCanvas=document.getElementById("cartographyCanvas"),cartographyContext=cartographyCanvas.getContext("2d"),offScreenCartographyCanvas=document.getElementById("offScreenCartographyCanvas"),offScreenCartographyContext=offScreenCartographyCanvas.getContext("2d"),canvasMapImage=document.createElement("img"),canvasMapMaskImage=document.createElement("img"),UI.init(),Input.init(),gameLoop(),getHeroGameState())}function getHeroGameState(){getJSON("/data/chr"+characterId+"/gameState.json",function(e){hero.tileX=e.tileX,hero.tileY=e.tileY,currentMap=e.currentMap,newMap=currentMap,hero.bags=e.bags,hero.cards=e.cards,hero.stats=e.stats,hero.titlesEarned=e.titlesEarned,hero.activeTitle=e.activeTitle,hero.recipesKnown=e.recipesKnown,hero.professionsKnown=e.professionsKnown;for(var t in e.fae)fae[t]=e.fae[t];hero.inventory=e.inventory,currentMap>0&&sendDataWithoutNeedingAResponse("/game-world/generateDungeonMap.php?playerId="+characterId+"&clearMaps=true"),loadCoreAssets()},function(e){getHeroGameState()})}function loadCoreAssets(){coreImagesToLoad=[],coreImagesToLoad.push({name:"heroImg",src:"/images/game-world/core/test-iso-hero.png"}),Loader.preload(coreImagesToLoad,prepareCoreAssets,loadingProgress)}function prepareCoreAssets(){heroImg=Loader.getImage("heroImg"),getColours()}function loadCardData(){getJSON("/game-world/getCardDetails.php",function(e){cardGameNameSpace.allCardData=e.cards,loadMap()},function(e){loadCardData()})}function loadMapJSON(e){console.log("mapFilePath: "+e),getJSON(e,function(e){thisMapData=e.map,mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length,previousZoneName!=thisMapData.zoneName&&(UI.showZoneName(thisMapData.zoneName),document.title=titleTagPrefix+" - "+thisMapData.zoneName,cartographicTitle.innerHTML=thisMapData.zoneName),initCartographicMap(),findProfessionsAndRecipes(),fae.recentHotspots=[]},function(t){loadMapJSON(e)})}function loadMap(){var e;if(console.log("going from "+currentMap+" to "+newMap),0>newMap&&currentMap>0?(randomDungeonName=randomDungeons[Math.abs(newMap)],newMap=-1):e="/data/chr"+characterId+"/map"+newMap+".json",0>newMap){var t=0,a=0,r=thisMapData.doors;for(var n=0 in r)r[n].map==newMap&&(t+=r[n].startX,a+=r[n].startY);var o=t/3,i=a/3;e="/game-world/generateDungeonMap.php?playerId="+characterId+"&originatingMapId="+currentMap+"&requestedMap="+newMap+"&dungeonName="+randomDungeonName+"&connectingDoorX="+o+"&connectingDoorY="+i}currentMap=newMap,loadMapJSON(e)}function loadMapAssets(){imagesToLoad=[];var e,t,a=currentMap;0>currentMap&&(a="dungeon/"+randomDungeonName),imagesToLoad.push({name:"backgroundImg",src:"/images/game-world/maps/"+a+"/bg.png"}),tileGraphicsToLoad=thisMapData.graphics;for(var r=0;r<tileGraphicsToLoad.length;r++)imagesToLoad.push({name:"tile"+r,src:"/images/game-world/maps/"+a+"/"+tileGraphicsToLoad[r].src});npcGraphicsToLoad=thisMapData.npcs;for(var r=0;r<npcGraphicsToLoad.length;r++)imagesToLoad.push({name:"npc"+npcGraphicsToLoad[r].name,src:"/images/game-world/npcs/"+npcGraphicsToLoad[r].src});itemGraphicsToLoad=thisMapData.items;for(var r=0;r<itemGraphicsToLoad.length;r++)e="",itemGraphicsToLoad[r].colour&&(t=getColourName(itemGraphicsToLoad[r].colour,itemGraphicsToLoad[r].type),""!=t&&(e="-"+t.toLowerCase())),imagesToLoad.push({name:"item"+itemGraphicsToLoad[r].type,src:"/images/game-world/items/"+currentActiveInventoryItems[itemGraphicsToLoad[r].type].worldSrc+e+".png"});Loader.preload(imagesToLoad,prepareGame,loadingProgress)}function loadTitles(){var e=hero.titlesEarned.join("|");getJSON("/game-world/getActiveTitles.php?whichIds="+e,function(e){activeTitles=e,loadCardData()},function(e){loadTitles()})}function getColours(){getJSON("/game-world/getColours.php",function(e){colourNames=e.colourNames,getQuestDetails()},function(e){getColours()})}function getQuestDetails(){getJSON("/game-world/getQuestDetails.php?chr="+characterId,function(e){questData=e.quests,loadTitles()},function(e){getQuestDetails()})}function findProfessionsAndRecipes(){for(var e="",t=0;t<hero.recipesKnown.length;t++)e+=hero.recipesKnown[t][0]+"|";e=e.slice(0,-1),loadProfessionsAndRecipes(e)}function loadProfessionsAndRecipes(e){getJSON("/game-world/getProfessionsAndRecipes.php?whichIds="+e,function(e){hero.crafting=e.professions,currentItemGroupFilters=e.itemGroups,findInventoryItemData()},function(t){loadProfessionsAndRecipes(e)})}function findInventoryItemData(){var e,t=[];for(var a in hero.inventory)if(t.push(hero.inventory[a].type),"undefined"!=typeof hero.inventory[a].contains)for(var r=0;r<hero.inventory[a].contains.length;r++)t.push(hero.inventory[a].contains[r].type);for(var r=0;r<hero.bags.length;r++)t.push(hero.bags[r].type);for(var r=0;r<thisMapData.items.length;r++)t.push(thisMapData.items[r].type);for(var r in hero.crafting)for(var n in hero.crafting[r].filters.All)for(t.push(hero.crafting[r].recipes[hero.crafting[r].filters.All[n]].creates),e=hero.crafting[r].recipes[hero.crafting[r].filters.All[n]].components.split(","),k=0;k<e.length;k++)isNaN(e[k])||t.push(e[k]);t=uniqueValues(t),loadInventoryItemData(t.join("|"))}function loadInventoryItemData(e){getJSON("/game-world/getInventoryItems.php?whichIds="+e,function(e){currentActiveInventoryItems=e,inventoryInterfaceIsBuilt||UI.buildInventoryInterface(),loadMapAssets()},function(t){loadInventoryItemData(e)})}function prepareGame(){tileImages=[];for(var e=0;e<tileGraphicsToLoad.length;e++)tileImages[e]=Loader.getImage("tile"+e);npcImages=[];for(var e=0;e<npcGraphicsToLoad.length;e++)npcImages[npcGraphicsToLoad[e].name]=Loader.getImage("npc"+npcGraphicsToLoad[e].name);itemImages=[];for(var e=0;e<itemGraphicsToLoad.length;e++)itemImages[itemGraphicsToLoad[e].type]=Loader.getImage("item"+itemGraphicsToLoad[e].type);backgroundImg=Loader.getImage("backgroundImg");for(var e=0;e<thisMapData.npcs.length;e++)thisMapData.npcs[e].x=getTileCentreCoordX(thisMapData.npcs[e].tileX),thisMapData.npcs[e].y=getTileCentreCoordY(thisMapData.npcs[e].tileY),thisMapData.npcs[e].drawnFacing=thisMapData.npcs[e].facing,thisMapData.npcs[e].dx=0,thisMapData.npcs[e].dy=0,thisMapData.npcs[e].movementIndex=-1;for(var e=0;e<thisMapData.items.length;e++)thisMapData.items[e].x=getTileCentreCoordX(thisMapData.items[e].tileX),thisMapData.items[e].y=getTileCentreCoordY(thisMapData.items[e].tileY),thisMapData.items[e].width=currentActiveInventoryItems[thisMapData.items[e].type].width,thisMapData.items[e].height=currentActiveInventoryItems[thisMapData.items[e].type].height,thisMapData.items[e].centreX=currentActiveInventoryItems[thisMapData.items[e].type].centreX,thisMapData.items[e].centreY=currentActiveInventoryItems[thisMapData.items[e].type].centreY;activeNPCForDialogue="",hero.x=getTileCentreCoordX(hero.tileX),hero.y=getTileCentreCoordY(hero.tileY),fae.x=hero.x+2*tileW,fae.y=hero.y+2*tileH,fae.z=40,fae.dz=1,timeSinceLastFrameSwap=0,currentAnimationFrame=0,mapTransition="in",mapTransitionCurrentFrames=1,gameMode="play"}function removeMapAssets(){for(var e=0;e<tileGraphicsToLoad.length;e++)tileImages[e].src="",tileImages[e]=null;for(var e=0;e<npcGraphicsToLoad.length;e++)npcImages[e].src="",npcImages[e]=null;for(var e=0;e<itemGraphicsToLoad.length;e++)itemImages[e].src="",itemImages[e]=null;backgroundImg.src="",backgroundImg=null}function loadingProgress(){}function changeMaps(e,t){previousZoneName=thisMapData.zoneName,gameMode="mapLoading",removeMapAssets();var a=thisMapData.doors,r=getTileX(e)+","+getTileX(t);hero.tileX=a[r].startX,hero.tileY=a[r].startY,newMap=a[r].map,loadMap()}function isATerrainCollision(e,t){var a=getTileX(e),r=getTileY(t);if(0>a||0>r||a>=mapTilesX||r>=mapTilesY)return 1;switch(thisMapData.collisions[r][a]){case 1:return 1;case"<":case">":case"^":case"v":return 0;case"d":return activeDoorX=e,activeDoorY=t,0;default:return 0}}function startDoorTransition(){""==mapTransition&&(mapTransitionCurrentFrames=1,mapTransition="out"),0>currentMap&&saveCartographyMask()}function getHeroAsCloseAsPossibleToObject(e,t,a,r){switch(hero.facing){case"n":hero.y=t+r/2+hero.height/2+1;break;case"s":hero.y=t-r/2-hero.height/2-1;break;case"w":hero.x=e+a/2+hero.width/2+1;break;case"e":hero.x=e-a/2-hero.width/2-1}}function checkHeroCollisions(){if(activeDoorX=-1,activeDoorY=-1,key[2])if(isATerrainCollision(hero.x-hero.width/2,hero.y-hero.height/2)||isATerrainCollision(hero.x+hero.width/2,hero.y-hero.height/2)){var e=getTileY(hero.y-hero.height/2),t=(e+1)*tileW;hero.y=t+hero.height/2+1}else-1!=activeDoorX&&startDoorTransition();if(key[3])if(isATerrainCollision(hero.x-hero.width/2,hero.y+hero.height/2)||isATerrainCollision(hero.x+hero.width/2,hero.y+hero.height/2)){var e=getTileY(hero.y+hero.height/2),a=e*tileW;hero.y=a-hero.height/2-1}else-1!=activeDoorX&&startDoorTransition();if(key[0])if(isATerrainCollision(hero.x-hero.width/2,hero.y+hero.height/2)||isATerrainCollision(hero.x-hero.width/2,hero.y-hero.height/2)){var e=getTileX(hero.x-hero.width/2),r=(e+1)*tileW;hero.x=r+hero.width/2+1}else-1!=activeDoorX&&startDoorTransition();if(key[1])if(isATerrainCollision(hero.x+hero.width/2,hero.y+hero.height/2)||isATerrainCollision(hero.x+hero.width/2,hero.y-hero.height/2)){var e=getTileX(hero.x+hero.width/2),n=e*tileW;hero.x=n-hero.width/2-1}else-1!=activeDoorX&&startDoorTransition();for(var o=0;o<thisMapData.npcs.length;o++)thisNPC=thisMapData.npcs[o],thisNPC.isCollidable&&isAnObjectCollision(thisNPC.x,thisNPC.y,thisNPC.width,thisNPC.height,hero.x,hero.y,hero.width,hero.height)&&getHeroAsCloseAsPossibleToObject(thisNPC.x,thisNPC.y,thisNPC.width,thisNPC.height);for(var o=0;o<thisMapData.items.length;o++)thisItem=thisMapData.items[o],isAnObjectCollision(thisItem.x,thisItem.y,thisItem.width,thisItem.height,hero.x,hero.y,hero.width,hero.height)&&getHeroAsCloseAsPossibleToObject(thisItem.x,thisItem.y,thisItem.width,thisItem.height)}function gameLoop(){switch(gameMode){case"mapLoading":console.log("loading map assets...");break;case"paused":break;case"cardGame":cardGameNameSpace.update(),cardGameNameSpace.draw();break;case"play":update(),draw()}window.requestAnimationFrame(gameLoop)}function update(){var e=window.performance.now(),t=e-lastTime;lastTime=e,hero.isMoving=!1,oldHeroX=hero.x,oldHeroY=hero.y;var a=hero.speed;if(key[5]&&(a*=2),"out"!=mapTransition){key[2]?(hero.isMoving=!0,hero.facing="n",hero.y-=a):key[3]?(hero.isMoving=!0,hero.facing="s",hero.y+=a):key[1]?(hero.isMoving=!0,hero.facing="e",hero.x+=a):key[0]&&(hero.isMoving=!0,hero.facing="w",hero.x-=a),key[4]&&checkForActions(),key[6]&&checkForChallenges(),checkHeroCollisions();var r=hero.tileX,n=hero.tileY;hero.tileX=getTileX(hero.x),hero.tileY=getTileY(hero.y),(hero.tileX!=r||hero.tileY!=n)&&heroIsInNewTile(),""!=activeNPCForDialogue&&(isInRange(hero.x,hero.y,activeNPCForDialogue.x,activeNPCForDialogue.y,closeDialogueDistance)||(dialogue.classList.add("slowerFade"),dialogue.classList.remove("active"),dialogue.addEventListener(whichTransitionEvent,UI.removeActiveDialogue,!1)))}else{switch(hero.isMoving=!0,hero.facing){case"n":hero.y-=a;break;case"s":hero.y+=a;break;case"e":hero.x+=a;break;case"w":hero.x-=a}mapTransitionCurrentFrames++,mapTransitionCurrentFrames>=mapTransitionMaxFrames&&changeMaps(activeDoorX,activeDoorY)}"in"==mapTransition&&(mapTransitionCurrentFrames+=2,mapTransitionCurrentFrames>=mapTransitionMaxFrames&&(mapTransition="")),timeSinceLastFrameSwap+=t,timeSinceLastFrameSwap>animationUpdateTime&&(currentAnimationFrame++,timeSinceLastFrameSwap=0,animateFae()),moveFae(),moveNPCs()}function heroIsInNewTile(){hero.z=thisMapData.elevation[getCurrentTileY(hero.y)][getCurrentTileX(hero.x)],0>currentMap&&updateCartographicMiniMap();
for(var e,t,a,r=0;r<thisMapData.hotspots.length;r++)e=thisMapData.hotspots[r],t=getTileCentreCoordX(e.centreX),a=getTileCentreCoordY(e.centreY),isInRange(hero.x,hero.y,t,a,e.radius*tileW)&&(questData[e.quest].hasBeenActivated<1&&UI.showNotification("<p>"+e.message+"</p>"),questData[e.quest].hasBeenActivated=1),"hero"==fae.currentState&&-1===fae.recentHotspots.indexOf(r)&&isInRange(fae.x,fae.y,t,a,fae.range)&&hasLineOfSight(getTileX(fae.x),getTileX(fae.y),e.centreX,e.centreY)&&(fae.targetX=t,fae.targetY=a,fae.recentHotspots.push(r),fae.currentState="away");"wait"==fae.currentState&&(isInRange(fae.x,fae.y,hero.x,hero.y,fae.abandonRadius)||hasLineOfSight(getTileX(fae.x),getTileX(fae.y),hero.tileX,hero.tileY)&&(fae.currentState="hero"))}function checkForActions(){for(var e,t=[],a=0;a<thisMapData.items.length;a++)if(isInRange(hero.x,hero.y,thisMapData.items[a].x,thisMapData.items[a].y,thisMapData.items[a].width/2+hero.width/2+6)&&isFacing(hero,thisMapData.items[a])){var r=currentActiveInventoryItems[itemGraphicsToLoad[a].type].actionValue;switch(currentActiveInventoryItems[itemGraphicsToLoad[a].type].action){case"static":break;case"questToggle":questData[r].hasBeenActivated=Math.abs(questData[r].hasBeenActivated-1);break;case"questSet":questData[r].hasBeenActivated=1;break;case"questUnset":questData[r].hasBeenActivated=0;break;default:t=canAddItemToInventory([thisMapData.items[a]]),t[0]?(thisMapData.items.splice(a,1),UI.showChangeInInventory(t[1])):UI.showNotification("<p>Oops - sorry, no room in your bags</p>")}}for(var a=0;a<thisMapData.npcs.length;a++)if(e=thisMapData.npcs[a],e.speech&&isInRange(hero.x,hero.y,e.x,e.y,e.width+hero.width)&&isFacing(hero,e))if(e.speechIndex>=e.speech.length||canCloseDialogueBalloonNextClick&&activeNPCForDialogue==e)e.speechIndex=0,dialogue.classList.remove("active"),activeNPCForDialogue="",canCloseDialogueBalloonNextClick=!1;else{var n=e.speech[e.speechIndex][0],o=e.speech[e.speechIndex][1];e.drawnFacing=turntoFace(e,hero),processSpeech(e,n,o,!0),e.speechIndex++}key[4]=0}function processSpeech(e,t,a,r){thisSpeech=t,r="undefined"!=typeof r?r:!1,individualSpeechCodes=a.split(",");for(var n=0;n<individualSpeechCodes.length;n++)switch(individualSpeechCodes[n]){case"once":e.speech.splice(e.speechIndex,1),e.speechIndex--;break;case"profession":var o=e.speech[e.speechIndex][2];-1==professionsKnown.indexOf(o)&&(professionsKnown.push(o),showNotification("<p>You learned a new profession</p>"));break;case"quest":case"quest-no-open":case"quest-no-close":case"quest-no-open-no-close":var i=thisSpeech.split("|"),s=e.speech[e.speechIndex][2];if(questData[s].isUnderway)switch(questData[s].whatIsRequiredForCompletion){case"possess":case"give":case"":if("quest"==individualSpeechCodes[n]||"quest-no-open"==individualSpeechCodes[n]){for(var c=(questData[s].itemsNeededForCompletion,!0),l=questData[s].startItemsReceived.split(","),d=[],n=0;n<l.length;n++){var h,p,g=l[n].split("x");g.length>1?(h=g[0],p=g[1]):(h=1,p=l[n]),hasItemInInventory(p,h)||(c=!1)}if(c){if("give"==questData[s].whatIsRequiredForCompletion)for(var n=0;n<l.length;n++){var h,p,g=l[n].split("x");g.length>1?(h=g[0],p=g[1]):(h=1,p=l[n]),removeItemTypeFromInventory(p,h)}thisSpeech=i[2],closeQuest(e,s)}else thisSpeech=i[1],e.speechIndex--}else questData[s].hasBeenCompleted>0?(thisSpeech=i[2],closeQuest(e,s)):(thisSpeech=i[1],e.speechIndex--);break;case"multi":for(var u=questData[s].subQuestsRequiredForCompletion.split(","),m=!0,f=0;f<u.length;f++)switch(questData[u[f]].whatIsRequiredForCompletion){case"possess":case"give":case"":for(var l=(questData[u[f]].itemsNeededForCompletion,questData[u[f]].startItemsReceived.split(",")),d=[],v=0;v<l.length;v++){var h,p,g=l[v].split("x");g.length>1?(h=g[0],p=g[1]):(h=1,p=l[n]),hasItemInInventory(p,h)||(m=!1)}break;case"world":questData[u[f]].hasBeenActivated<1&&(m=!1);break;default:var y=questData[u[f]].valueAtQuestStart,I=accessDynamicVariable(questData[u[f]].whatIsRequiredForCompletion);"+"==questData[u[f]].thresholdNeededForCompletion.charAt(0)?(console.log(I+" < "+questData[u[f]].thresholdNeededForCompletion.substring(1)),I-y<questData[u[f]].thresholdNeededForCompletion&&(m=!1)):I<questData[u[f]].thresholdNeededForCompletion.substring(1)&&(m=!1)}m?(thisSpeech=i[2],closeQuest(e,s)):(thisSpeech=i[1],e.speechIndex--);break;case"world":questData[s].hasBeenActivated>0?(thisSpeech=i[2],closeQuest(e,s)):(thisSpeech=i[1],e.speechIndex--);break;default:var y=questData[s].valueAtQuestStart,I=accessDynamicVariable(questData[s].whatIsRequiredForCompletion),C=!1;"+"==questData[s].thresholdNeededForCompletion.charAt(0)?I-y>=questData[s].thresholdNeededForCompletion&&(C=!0):I>=questData[s].thresholdNeededForCompletion.substring(1)&&(C=!0),C?(thisSpeech=i[2],closeQuest(e,s)):(thisSpeech=i[1],e.speechIndex--)}else{if("quest"==individualSpeechCodes[n]||"quest-no-close"==individualSpeechCodes[n]){var w=!0;if(questData[s].startItemsReceived){for(var S=questData[s].startItemsReceived.split(","),d=[],D=0;D<S.length;D++){var h,p,g=S[D].split("x");g.length>1?(h=g[0],p=g[1]):(h=1,p=S[D]);var b={type:parseInt(p),quantity:parseInt(h),quality:100,durability:100,currentWear:0,effectiveness:100,colour:currentActiveInventoryItems[parseInt(p)].colour,enchanted:0,hallmark:0,inscription:""};d.push(b)}inventoryCheck=canAddItemToInventory(d),inventoryCheck[0]?UI.showChangeInInventory(inventoryCheck[1]):w=!1}if(w){switch(questData[s].whatIsRequiredForCompletion){case"possess":case"give":case"":break;case"multi":for(var u=questData[s].subQuestsRequiredForCompletion.split(","),f=0;f<u.length;f++){switch(questData[u[f]].isUnderway=1,questData[u[f]].whatIsRequiredForCompletion){case"possess":case"give":case"":break;case"world":break;default:questData[u[f]].valueAtQuestStart=accessDynamicVariable(questData[u[f]].whatIsRequiredForCompletion)}questData[u[f]].isUnderway=!0}break;case"world":break;default:questData[s].valueAtQuestStart=accessDynamicVariable(questData[s].whatIsRequiredForCompletion)}questData[s].isUnderway=!0}}thisSpeech=i[0],e.speechIndex--}break;case"play":startCardGame(e)}UI.showDialogue(e,thisSpeech),canCloseDialogueBalloonNextClick=!1,r||(canCloseDialogueBalloonNextClick=!0)}function closeQuest(e,t){giveQuestRewards(t)?(questData[t].isRepeatable>0?(questData[t].hasBeenCompleted=!1,questData[t].isUnderway=!1):(questData[t].hasBeenCompleted=!0,e.speech.splice(e.speechIndex,1),e.speechIndex--),checkForTitlesAwarded(t)):e.speechIndex--}function giveQuestRewards(e){if(questData[e].itemsReceivedOnCompletion){for(var t=[],a=questData[e].itemsReceivedOnCompletion.split(","),r=0;r<a.length;r++){var n,o,i=a[r].split("/"),s=getRandomElementFromArray(i),c=s.split("x");c.length>1?(n=c[0],o=c[1]):(n=1,o=a[r]),i.length>1&&(thisSpeech=thisSpeech.replace(/##itemName##/i,currentActiveInventoryItems[parseInt(o)].shortname));var l={type:parseInt(o),quantity:parseInt(n),quality:100,durability:100,currentWear:0,effectiveness:100,colour:currentActiveInventoryItems[parseInt(o)].colour,enchanted:0,hallmark:0,inscription:""};t.push(l)}return inventoryCheck=canAddItemToInventory(t),inventoryCheck[0]?(UI.showChangeInInventory(inventoryCheck[1]),!0):(UI.showNotification("<p>Oops - sorry, no room in your bags</p>"),!1)}return!0}function checkForTitlesAwarded(e){if(questData[e].titleGainedAfterCompletion){var t=questData[e].titleGainedAfterCompletion;-1==hero.titlesEarned.indexOf(t)&&(hero.titlesEarned.push(t),UI.showNotification("<p>You earned the &quot;"+activeTitles[t]+"&quot; title</p>"))}}function checkForChallenges(){for(var e=0;e<thisMapData.npcs.length;e++)thisNPC=thisMapData.npcs[e],isInRange(hero.x,hero.y,thisNPC.x,thisNPC.y,thisNPC.width+hero.width)&&isFacing(hero,thisNPC)&&thisNPC.cardGameSpeech&&(thisNPC.drawnFacing=turntoFace(thisNPC,hero),processSpeech(thisNPC,thisNPC.cardGameSpeech.challenge[0],thisNPC.cardGameSpeech.challenge[1]));key[6]=0}function moveNPCs(){for(var e,t,a,r,n,o=0;o<thisMapData.npcs.length;o++)if(e=thisMapData.npcs[o],e.isMoving){switch(r=e.x,n=e.y,e.drawnFacing=e.facing,e.facing){case"n":if(e.y-=e.speed,isATerrainCollision(e.x-e.width/2,e.y-e.height/2)||isATerrainCollision(e.x+e.width/2,e.y-e.height/2)){var i=getTileY(e.y-e.height/2),s=(i+1)*tileW;e.y=s+e.height/2+1}break;case"s":if(e.y+=e.speed,isATerrainCollision(e.x-e.width/2,e.y+e.height/2)||isATerrainCollision(e.x+e.width/2,e.y+e.height/2)){var i=getTileY(e.y+e.height/2),c=i*tileW;e.y=c-e.height/2-1}break;case"w":if(e.x-=e.speed,isATerrainCollision(e.x-e.width/2,e.y+e.height/2)||isATerrainCollision(e.x-e.width/2,e.y-e.height/2)){var i=getTileX(e.x-e.width/2),l=(i+1)*tileW;e.x=l+e.width/2+1}break;case"e":if(e.x+=e.speed,isATerrainCollision(e.x+e.width/2,e.y+e.height/2)||isATerrainCollision(e.x+e.width/2,e.y-e.height/2)){var i=getTileX(e.x+e.width/2),d=i*tileW;e.x=d-e.width/2-1}}isAnObjectCollision(e.x,e.y,e.width,e.height,hero.x,hero.y,hero.width,hero.height)&&(e.x=r,e.y=n);for(var h=0;h<thisMapData.npcs.length;h++)o!=h&&(thisOtherNPC=thisMapData.npcs[h],thisOtherNPC.isCollidable&&isAnObjectCollision(e.x,e.y,e.width,e.height,thisOtherNPC.x,thisOtherNPC.y,thisOtherNPC.width,thisOtherNPC.height)&&(e.x=r,e.y=n));for(var o=0;o<thisMapData.items.length;o++)thisItem=thisMapData.items[o],isAnObjectCollision(e.x,e.y,e.width,e.height,thisItem.x,thisItem.y,thisItem.width,thisItem.height)&&(e.x=r,e.y=n);if(e.dx+=e.x-r,e.dy+=e.y-n,t=!1,Math.abs(e.dx)>=tileW&&(e.dx>0?e.dx-=tileW:e.dx+=tileW,t=!0),Math.abs(e.dy)>=tileW&&(e.dy>0?e.dy-=tileW:e.dy+=tileW,t=!0),t)switch(e.movementIndex++,e.movementIndex>=e.movement.length&&(e.movementIndex=0),a=e.movement[e.movementIndex]){case"-":e.isMoving=!1;case"?":do e.facing=facingsPossible[Math.floor(Math.random()*facingsPossible.length)];while(isATerrainCollision(e.x+relativeFacing[e.facing].x*tileW,e.y+relativeFacing[e.facing].y*tileW));break;default:e.facing=a}}}function canLearnRecipe(e){var t=!1;return-1===hero.recipesKnown.indexOf(e)&&hero.recipesKnown.push([parseInt(e),0]),t}function draw(){if("mapLoading"==gameMode)gameContext.fillRect(0,0,canvasWidth,canvasHeight),gameContext.fillStyle="black",gameContext.fill();else{var e,t,a,r,n,o;hero.isox=findIsoCoordsX(hero.x,hero.y),hero.isoy=findIsoCoordsY(hero.x,hero.y);var i=[[findIsoDepth(hero.x,hero.y,hero.z),"img",heroImg,Math.floor(canvasWidth/2-hero.feetOffsetX),Math.floor(canvasHeight/2-hero.feetOffsetY-hero.z)]];a=findIsoCoordsX(fae.x,fae.y),r=findIsoCoordsY(fae.x,fae.y),i.push([findIsoDepth(fae.x,fae.y,0),"faeCentre",Math.floor(a-hero.isox+canvasWidth/2),Math.floor(r-hero.isoy+canvasHeight/2-fae.z)]);for(var s=0;s<fae.particles.length;s++)i.push([fae.particles[s].depth,"faeParticle",Math.floor(fae.particles[s].isoX-hero.isox+canvasWidth/2),Math.floor(fae.particles[s].isoY-hero.isoy+canvasHeight/2),fae.particles[s].alpha]);for(var c=thisMapData.terrain,l=0,d=0,s=0;mapTilesX>s;s++)for(var h=0;mapTilesY>h;h++)"*"!=c[h][s]&&(a=getTileIsoCentreCoordX(s,h),r=getTileIsoCentreCoordY(s,h),e=thisMapData.graphics[c[h][s]].centreX,t=thisMapData.graphics[c[h][s]].centreY,i.push([findIsoDepth(getTileCentreCoordX(s),getTileCentreCoordY(h),0),"img",tileImages[c[h][s]],Math.floor(a-hero.isox-e+canvasWidth/2),Math.floor(r-hero.isoy-t+canvasHeight/2)]));for(var s=0;s<thisMapData.npcs.length;s++)n=thisMapData.npcs[s],l=currentAnimationFrame%n.animation.walk.length,d=n.animation.walk[n.drawnFacing],a=findIsoCoordsX(n.x,n.y),r=findIsoCoordsY(n.x,n.y),i.push([findIsoDepth(n.x,n.y,0),"sprite",npcImages[thisMapData.npcs[s].name],l*n.spriteWidth,d*n.spriteHeight,n.spriteWidth,n.spriteHeight,Math.floor(a-hero.isox-n.centreX+canvasWidth/2),Math.floor(r-hero.isoy-n.centreY+canvasHeight/2),n.spriteWidth,n.spriteHeight]);for(var s=0;s<thisMapData.items.length;s++)o=thisMapData.items[s],a=findIsoCoordsX(o.x,o.y),r=findIsoCoordsY(o.x,o.y),i.push([findIsoDepth(o.x,o.y,0),"img",itemImages[thisMapData.items[s].type],Math.floor(a-hero.isox-o.centreX+canvasWidth/2),Math.floor(r-hero.isoy-o.centreY+canvasHeight/2)]);i.sort(sortByLowestValue),gameContext.drawImage(backgroundImg,Math.floor(getTileIsoCentreCoordX(0,mapTilesX-1)-hero.isox-tileW/2),Math.floor(getTileIsoCentreCoordY(0,0)-hero.isoy-tileH/2));for(var s=0;s<i.length;s++)switch(i[s][1]){case"faeCentre":drawCircle("#ffdc0c",i[s][2],i[s][3],2),drawCircle("rgba(255,220,255,0.3)",i[s][2],i[s][3],4),gameContext.fillStyle="rgba(0,0,0,"+.01*(65-fae.z)+")",gameContext.beginPath(),gameContext.ellipse(i[s][2]-getXOffsetFromHeight(fae.z),i[s][3]+fae.z,3,1,0,0,2*Math.PI),gameContext.fill();break;case"faeParticle":gameContext.fillStyle="rgba(255,220,255,"+i[s][4]+")",gameContext.fillRect(i[s][2],i[s][3],1,1);break;case"sprite":gameContext.drawImage(i[s][2],i[s][3],i[s][4],i[s][5],i[s][6],i[s][7],i[s][8],i[s][9],i[s][10]);break;case"img":gameContext.drawImage(i[s][2],i[s][3],i[s][4])}if(""!=activeNPCForDialogue&&UI.updateDialogue(activeNPCForDialogue),"out"==mapTransition){var p=1-mapTransitionCurrentFrames/mapTransitionMaxFrames,g=gameContext.createRadialGradient(canvasWidth/2,canvasHeight/2,p*canvasWidth/2,canvasWidth/2,canvasHeight/2,0);g.addColorStop(0,"rgba(0,0,0,1)"),g.addColorStop(1,"rgba(0,0,0,0)"),gameContext.fillStyle=g,gameContext.fillRect(0,0,canvasWidth,canvasHeight)}else if("in"==mapTransition){var p=mapTransitionCurrentFrames/mapTransitionMaxFrames,g=gameContext.createRadialGradient(canvasWidth/2,canvasHeight/2,p*canvasWidth/2,canvasWidth/2,canvasHeight/2,0);g.addColorStop(0,"rgba(0,0,0,1)"),g.addColorStop(1,"rgba(0,0,0,0)"),gameContext.fillStyle=g,gameContext.fillRect(0,0,canvasWidth,canvasHeight)}}}var animationFramesPerSecond=16,lastTime=0,elapsed=0,timeSinceLastFrameSwap=0,currentAnimationFrame=0,animationUpdateTime=1e3/animationFramesPerSecond,titleTagPrefix="Autumn Earth",mapTransition="",mapTransitionCurrentFrames=1,mapTransitionMaxFrames=60,activeDoorX=-1,activeDoorY=-1,characterId=999,currentMap=0,newMap=0,thisMapData="",mapTilesX=0,mapTilesY=0,tileGraphics=[],tileW=48,tileH=tileW/2,tileGraphicsToLoad=0,npcGraphicsToLoad=0,itemGraphicsToLoad=0,canvasWidth=800,canvasHeight=600,randomDungeonName="",randomDungeons=["","the-barrow-mines"],previousZoneName="",currentActiveInventoryItems=[],maxNumberOfItemsPerSlot=20,isSplitStackBeingDragged=!1,activeTitles=[],inventoryInterfaceIsBuilt=!1,whichTransitionEvent="",activeNPCForDialogue="",closeDialogueDistance=200,canCloseDialogueBalloonNextClick=!1,thisSpeech="",boosterCardsRevealed=0,boosterCardsToAdd=[],questData=[],colourNames=[],currentRecipePanelProfession=-1,currentItemGroupFilters="",key=[0,0,0,0,0,0,0],hero={x:0,y:0,z:0,dx:0,dy:0,width:20,height:20,feetOffsetX:40,feetOffsetY:69,speed:4,isMoving:!1,facing:"s",sequences:{"stand-s":[3],"stand-n":[10],"stand-w":[17],"stand-e":[24],"walk-s":[3,4,5,6,5,4,3,2,1,0,1,2],"walk-n":[10,11,12,13,12,11,10,9,8,7,8,9],"walk-w":[17,18,19,20,19,18,17,16,15,14,15,16],"walk-e":[24,25,26,27,26,25,24,23,22,21,22,23]}},fae={particles:[],maxParticles:18,radiusAroundHero:20,angleAroundHero:0,targetX:0,targetY:0,currentState:"hero",abandonRadius:500},facingsPossible=["n","e","s","w"],relativeFacing={n:{x:0,y:-1},s:{x:0,y:1},e:{x:1,y:0},w:{x:-1,y:0}};!function(){for(var e=0,t=["ms","moz","webkit","o"],a=0;a<t.length&&!window.requestAnimationFrame;++a)window.requestAnimationFrame=window[t[a]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[a]+"CancelAnimationFrame"]||window[t[a]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,a){var r=(new Date).getTime(),n=Math.max(0,16-(r-e)),o=window.setTimeout(function(){t(r+n)},n);return e=r+n,o}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}();var getJSON=function(e,t,a){var r="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");r.open("get",e,!0),r.onreadystatechange=function(){var e,n;if(4==r.readyState){e=r.status;var o=!0;if(200==e){try{n=JSON.parse(r.responseText)}catch(i){o=!1,a&&a(e)}o&&t&&t(n)}else a&&a(e)}},r.send()};window.Loader=function(){function e(){l=0,d=!1,h=0,p={}}function t(){}function a(){}function r(e){++l,t(c()),l==h&&(d=!1,a())}function n(e){console.log("Error on loading the image: "+e.srcElement)}function o(e,t){try{p[e]=new Image,p[e].onload=function(){r(e)},p[e].onerror=n,p[e].src=t}catch(a){console.log(a.message)}}function i(e){return p[e]?p[e]:void 0}function s(r,n,i){if(e(),!d){d=!0;try{h=r.length,t=i||function(){},a=n||function(){};for(var s=0;s<r.length;++s)o(r[s].name,r[s].src)}catch(c){console.log(c.message)}}}function c(){return l/h*100}var l=0,d=!1,h=0,p={};return{preload:s,getProgress:c,getImage:i,reset:e,images:p}}(),allCardPacks=[[1,1,1,1,1,1,1,1,3,3,3,3,3,3,3,3,3],[1,1,1,1,1,1,2,2,2,2,2,3,3,3,3,3,3]];var Input={init:function(){document.addEventListener("keydown",function(e){Input.changeKey(e.keyCode,1,"down")}),document.addEventListener("keyup",function(e){Input.changeKey(e.keyCode,0,"up")})},changeKey:function(e,t,a){switch(e){case KeyBindings.left:key[0]=t;break;case KeyBindings.up:key[2]=t;break;case KeyBindings.right:key[1]=t;break;case KeyBindings.down:key[3]=t;break;case KeyBindings.action:key[4]=0,"up"===a&&(key[4]=1);break;case KeyBindings.shift:key[5]=t;break;case KeyBindings.challenge:key[6]=t}}},KeyBindings={left:37,right:39,up:38,down:40,pause:80,action:17,shift:16,challenge:67},recipeSearch=document.getElementById("recipeSearch"),clearRecipeSearch=document.getElementById("clearRecipeSearch"),recipeFilter=document.getElementById("recipeFilter"),splitStackInput=document.getElementById("splitStackInput"),splitStackPanel=document.getElementById("splitStackPanel"),craftingRecipeCreateButton=document.getElementById("craftingRecipeCreateButton"),selectComponentsItemBeingCreated=document.getElementById("selectComponentsItemBeingCreated"),componentsAvailableForThisRecipe=document.getElementById("componentsAvailableForThisRecipe"),UI={init:function(){document.getElementById("displayZoneName"),document.getElementById("activeCartographicMap"),document.getElementById("cartographicTitle"),document.getElementById("dialogue"),document.getElementById("notification"),document.getElementById("cardGameWrapper"),document.getElementById("cardAlbumList"),document.getElementById("boosterPack"),document.getElementById("createRecipeList"),document.getElementById("recipeTitleBar")},showZoneName:function(e){displayZoneName.classList.remove("active"),displayZoneName.textContent=e,void displayZoneName.offsetWidth,displayZoneName.classList.add("active")},buildInventoryInterface:function(){for(var e="",t=0;t<hero.bags.length;t++){e+='<div class="inventoryBag" id="inventoryBag'+t+'"><div class="draggableBar">'+currentActiveInventoryItems[hero.bags[t].type].shortname+'</div><ol class="active" id="bag'+t+'">';for(var a=currentActiveInventoryItems[hero.bags[t].type].actionValue,r=0;a>r;r++){var n=t+"-"+r;e+='<li id="slot'+n+'">',e+=n in hero.inventory?generateSlotMarkup(n):"",e+="</li>"}e+="</ol></div></div>"}document.getElementById("inventoryPanels").innerHTML=e,document.getElementById("inventoryPanels").ondblclick=UI.inventoryItemDoubleClick,document.getElementById("createRecipeList").ondblclick=UI.craftingPanelDoubleClick,document.getElementById("createRecipeList").onclick=UI.craftingPanelSingleClick,document.getElementById("craftingRecipeCreateButton").onclick=UI.craftingRecipeCreate,splitStackPanel.onsubmit=inventorySplitStackSubmit,document.getElementById("splitStackCancel").onclick=inventorySplitStackCancel,UI.initDrag(".draggableBar"),UI.initInventoryDrag(),UI.updateCardAlbum(),UI.buildRecipePanel(),hero.professionsKnown.length>0&&UI.populateRecipeList(hero.professionsKnown[0]),inventoryInterfaceIsBuilt=!0},showChangeInInventory:function(e){document.getElementById("slot"+e[0]).addEventListener(whichTransitionEvent,function a(e){elementList=document.querySelectorAll("#inventoryPanels .changed");for(var t=0;t<elementList.length;t++)elementList[t].classList.remove("changed");return e.currentTarget.removeEventListener(whichTransitionEvent,a,!1)},!1);for(var t=0;t<e.length;t++)thisSlotsId=e[t],slotMarkup=generateSlotMarkup(thisSlotsId),thisSlotElem=document.getElementById("slot"+thisSlotsId),thisSlotElem.innerHTML=slotMarkup,thisSlotElem.classList.add("changed")},handleDrag:function(e){UI.activeDragObject.style.cssText="z-index:2;top: "+objInitTop+"px; left: "+objInitLeft+"px; transform: translate("+(e.pageX-dragStartX)+"px, "+(e.pageY-dragStartY)+"px);"},endDrag:function(e){document.removeEventListener("mousemove",UI.handleDrag,!1),document.removeEventListener("mouseup",UI.endDrag,!1),UI.activeDragObject=""},initDrag:function(e){for(var t=document.querySelectorAll(e),a=0;a<t.length;a++)t[a].addEventListener("mousedown",function(a){if(2!=a.button){UI.activeDragObject=this.parentElement;var r=(window.pageYOffset||document.documentElement.scrollTop)-(document.documentElement.clientTop||0),n=this.getBoundingClientRect();objInitLeft=n.left,objInitTop=n.top+r,dragStartX=a.pageX,dragStartY=a.pageY,document.addEventListener("mousemove",UI.handleDrag,!1),document.addEventListener("mouseup",UI.endDrag,!1);var o=document.querySelectorAll(e);for(j=0;j<o.length;j++)t[j].parentElement.style.zIndex=1}},!1)},inventoryItemDoubleClick:function(e){var t=e.target.getAttribute("data-action");t&&inventoryItemAction(e.target,t,e.target.getAttribute("data-action-value"))},showDialogue:function(e,t){var a=getRandomElementFromArray(t.split("/"));""!=activeNPCForDialogue&&dialogue.removeEventListener(whichTransitionEvent,UI.removeActiveDialogue,!1),dialogue.innerHTML=a,dialogue.classList.remove("slowerFade"),dialogue.classList.add("active"),activeNPCForDialogue=e,UI.updateDialogue(activeNPCForDialogue)},updateDialogue:function(e){var t=findIsoCoordsX(e.x,e.y),a=findIsoCoordsY(e.x,e.y),r="translate("+Math.floor(t-hero.isox+canvasWidth/2-40)+"px,"+Math.floor(0-(canvasHeight-(a-hero.isoy-e.centreY+canvasHeight/2)+40))+"px)";dialogue.style.transform=r},showNotification:function(e){notification.classList.remove("active"),notification.innerHTML=e,void notification.offsetWidth,notification.classList.add("active")},updateCardAlbum:function(){for(var e="",t=0;30>t;t++)e+=hero.cards[t]?'<li><img src="/images/card-game/cards/'+hero.cards[t]+'.png" class="card players" alt="'+cardGameNameSpace.allCardData[hero.cards[t]][2]+' card"></li>':"<li></li>";cardAlbumList.innerHTML=e},populateRecipeList:function(e){if(currentRecipePanelProfession!=e){recipeSearch.value="",clearRecipeSearch.classList.remove("active");for(var t,a,r='<li id="noRecipesFound"><p>No recipes found.</p></li>',n="",o=0;o<hero.crafting[e].sortOrder.length;o++)t=hero.crafting[e].recipes[hero.crafting[e].sortOrder[o]],r+='<li class="active" id="recipe'+hero.crafting[e].sortOrder[o]+'"><img src="/images/game-world/inventory-items/'+t.imageId+'.png" alt="'+t.recipeName+'"><h3>'+t.recipeName+"</h3><p>"+t.recipeDescription+"</p></li>";createRecipeList.innerHTML=r;for(var o=0;o<hero.crafting[e].filterOrder.length;o++)a=hero.crafting[e].filters[hero.crafting[e].filterOrder[o]],n+='<option value="'+a+'"',0==o&&(n+=' selected="selected"'),n+=">"+hero.crafting[e].filterOrder[o]+"</option>";recipeFilter.innerHTML=n,currentRecipePanelProfession=e,UI.highlightedRecipe="",craftingRecipeCreateButton.disabled=!0,recipeTitleBar.innerHTML=hero.crafting[e].name+" Recipes"}},buildRecipePanel:function(){recipeSearch.onkeyup=recipeSearchInput,recipeFilter.onchange=recipeSearchAndFilter,clearRecipeSearch.onclick=recipeSearchClear},endInventoryDrag:function(e){for(var t=e.target;!t.id;)t=t.parentNode;var a=t.id;if("slot"==a.substring(0,4)){var r=a.substring(4);if(void 0==hero.inventory[r])isSplitStackBeingDragged?addToInventory(r,UI.draggedInventoryObject):(UI.sourceSlot!=r?(document.getElementById("slot"+UI.sourceSlot).innerHTML="",addToInventory(r,UI.draggedInventoryObject)):hero.inventory[r]=JSON.parse(JSON.stringify(UI.draggedInventoryObject)),document.getElementById("slot"+UI.sourceSlot).classList.remove("hidden")),UI.droppedSuccessfully();else if(itemAttributesMatch(UI.draggedInventoryObject,hero.inventory[r]))if(parseInt(UI.draggedInventoryObject.quantity)+parseInt(hero.inventory[r].quantity)<=maxNumberOfItemsPerSlot){hero.inventory[r].quantity+=parseInt(UI.draggedInventoryObject.quantity);for(var n=document.getElementById("slot"+r),o=0;o<n.childNodes.length;o++)if("qty"==n.childNodes[o].className){n.childNodes[o].innerHTML=hero.inventory[r].quantity;break}isSplitStackBeingDragged||(document.getElementById("slot"+UI.sourceSlot).innerHTML="",document.getElementById("slot"+UI.sourceSlot).classList.remove("hidden")),UI.droppedSuccessfully()}else{var i=maxNumberOfItemsPerSlot-parseInt(hero.inventory[r].quantity);hero.inventory[r].quantity=maxNumberOfItemsPerSlot;for(var n=document.getElementById("slot"+r),o=0;o<n.childNodes.length;o++)if("qty"==n.childNodes[o].className){n.childNodes[o].innerHTML=hero.inventory[r].quantity;break}UI.draggedInventoryObject.quantity-=i;for(var n=document.getElementById("slot"+UI.sourceSlot),o=0;o<n.childNodes.length;o++)if("qty"==n.childNodes[o].className){n.childNodes[o].innerHTML=UI.draggedInventoryObject.quantity;break}for(var n=document.getElementById("draggableInventorySlot"),o=0;o<n.childNodes.length;o++)if("qty"==n.childNodes[o].className){n.childNodes[o].innerHTML=UI.draggedInventoryObject.quantity;break}UI.slideDraggedSlotBack()}else UI.slideDraggedSlotBack()}else if("inventoryBag"==a.substring(0,12)){var s=a.substring(12),c=UI.sourceSlot.indexOf("-"),l=UI.sourceSlot.substring(0,c);if(s==l)UI.slideDraggedSlotBack();else{for(var d=-1,h=currentActiveInventoryItems[hero.bags[s].type].actionValue,p=0;h>p;p++){var g=s+"-"+p;if(!(g in hero.inventory)){d=p;break}}-1!=d?(document.getElementById("slot"+UI.sourceSlot).innerHTML="",addToInventory(s+"-"+d,UI.draggedInventoryObject),document.getElementById("slot"+UI.sourceSlot).classList.remove("hidden"),UI.droppedSuccessfully()):UI.slideDraggedSlotBack()}}else UI.slideDraggedSlotBack();document.removeEventListener("mousemove",UI.handleDrag,!1),document.removeEventListener("mouseup",UI.endInventoryDrag,!1)},droppedSuccessfully:function(){UI.activeDragObject.style.cssText="z-index:2;",UI.activeDragObject="",isSplitStackBeingDragged&&(isSplitStackBeingDragged=!1)},initInventoryDrag:function(){for(var e=document.querySelectorAll(".inventoryBag ol"),t=0;t<e.length;t++)e[t].addEventListener("mousedown",function(e){if(e.preventDefault(),2!=e.button){var t=getNearestParentId(e.target);if(key[5]){UI.sourceSlot=t.id.substring(4),UI.draggedInventoryObject=JSON.parse(JSON.stringify(hero.inventory[UI.sourceSlot])),splitStackInput.setAttribute("max",hero.inventory[UI.sourceSlot].quantity);var a=Math.floor(hero.inventory[UI.sourceSlot].quantity/2);splitStackInput.value=a,splitStackInput.focus(),splitStackInput.setSelectionRange(0,a.toString().length);var r=t.getBoundingClientRect(),n=(window.pageYOffset||document.documentElement.scrollTop)-(document.documentElement.clientTop||0);objInitLeft=r.left+3,objInitTop=r.top+3+n-44,splitStackPanel.style.cssText="z-index:2;top: "+objInitTop+"px; left: "+objInitLeft+"px;",splitStackPanel.classList.add("active"),key[5]=0}else if(!isSplitStackBeingDragged){UI.sourceSlot=t.id.substring(4),UI.draggedInventoryObject=hero.inventory[UI.sourceSlot],UI.activeDragObject=document.getElementById("draggableInventorySlot"),UI.activeDragObject.innerHTML=t.innerHTML,delete hero.inventory[UI.sourceSlot],t.classList.add("hidden");var r=t.getBoundingClientRect(),n=(window.pageYOffset||document.documentElement.scrollTop)-(document.documentElement.clientTop||0);objInitLeft=r.left+3,objInitTop=r.top+3+n,dragStartX=e.pageX,dragStartY=e.pageY,UI.activeDragObject.style.cssText="z-index:2;top: "+objInitTop+"px; left: "+objInitLeft+"px; transform: translate(0px, 0px);",document.addEventListener("mousemove",UI.handleDrag,!1),document.addEventListener("mouseup",UI.endInventoryDrag,!1)}}},!1)},slideDraggedSlotBack:function(){UI.activeDragObject.style.cssText="z-index:2;left: "+objInitLeft+"px; top: "+objInitTop+"px;transition: transform 0.4s ease;",UI.activeDragObject.addEventListener(whichTransitionEvent,function e(t){if(isSplitStackBeingDragged){hero.inventory[UI.sourceSlot].quantity+=UI.draggedInventoryObject.quantity;for(var a=document.getElementById("slot"+UI.sourceSlot),r=0;r<a.childNodes.length;r++)if("qty"==a.childNodes[r].className){a.childNodes[r].innerHTML=hero.inventory[UI.sourceSlot].quantity;break}}else hero.inventory[UI.sourceSlot]=JSON.parse(JSON.stringify(UI.draggedInventoryObject)),document.getElementById("slot"+UI.sourceSlot).classList.remove("hidden");return UI.droppedSuccessfully(),t.currentTarget.removeEventListener(whichTransitionEvent,e,!1)},!1)},removeActiveDialogue:function(){activeNPCForDialogue="",dialogue.removeEventListener(whichTransitionEvent,UI.removeActiveDialogue,!1)},craftingPanelDoubleClick:function(e){var t=getNearestParentId(e.target);"recipe"==t.id.substring(0,6)&&recipeSelectComponents(t.id)},craftingPanelSingleClick:function(e){var t=getNearestParentId(e.target);"recipe"==t.id.substring(0,6)&&(""!=UI.highlightedRecipe&&document.getElementById(UI.highlightedRecipe).classList.remove("highlighted"),UI.highlightedRecipe=t.id,document.getElementById(UI.highlightedRecipe).classList.add("highlighted"),craftingRecipeCreateButton.disabled=!1)},craftingRecipeCreate:function(){""!=UI.highlightedRecipe&&recipeSelectComponents(UI.highlightedRecipe)}};"serviceWorker"in navigator&&navigator.serviceWorker.register("/game-world/serviceWorker.min.js",{scope:"/game-world/"}),"querySelectorAll"in document&&"addEventListener"in window&&window.HTMLCanvasElement&&init();