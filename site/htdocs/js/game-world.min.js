function getTileX(e){return Math.floor(e/tileW)}function getTileY(e){return Math.floor(e/tileW)}function findIsoCoordsX(e,a){return Math.floor(mapTilesY*tileW/2-a/2+e/2)}function findIsoCoordsY(e,a){return Math.floor(e/4+a/4-tileH/2)}function getTileCentreCoordX(e){return e*tileW+tileW/2}function getTileCentreCoordY(e){return e*tileW+tileW/2}function getTileIsoCentreCoordX(e,a){return tileW/2*(mapTilesY-a+e)}function getTileIsoCentreCoordY(e,a){return tileH/2*(a+e)}function getCurrentTileX(e){return Math.floor(e/tileW)}function getCurrentTileY(e){return Math.floor(e/tileW)}function sortByIsoDepth(e,a){return e[0]<a[0]?-1:e[0]>a[0]?1:0}function findIsoDepth(e,a){return a}function init(){gameCanvas=document.getElementById("gameWorld"),gameCanvas.getContext&&(gameContext=gameCanvas.getContext("2d"),canvasWidth=gameCanvas.width,canvasHeight=gameCanvas.height),gameMode="mapLoading",UI.init(),Input.init(),gameLoop(),loadCoreAssets()}function loadCoreAssets(){coreImagesToLoad=[],coreImagesToLoad.push({name:"heroImg",src:"/images/game-world/core/test-iso-hero.png"}),Loader.preload(coreImagesToLoad,prepareCoreAssets,loadingProgress)}function prepareCoreAssets(){heroImg=Loader.getImage("heroImg"),loadMap()}function loadMapJSON(e){console.log("mapFilePath: "+e),getJSON(e,function(e){thisMapData=e.map,mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length,previousZoneName!=thisMapData.zoneName&&UI.showZoneName(thisMapData.zoneName),loadMapAssets()},function(a){loadMapJSON(e)})}function loadMap(){var e;if(console.log("going from "+currentMap+" to "+newMap),0>newMap&&currentMap>0?(randomDungeonName=randomDungeons[Math.abs(newMap)],newMap=-1):e="/data/chr"+characterId+"/map"+newMap+".json",0>newMap){var a=0,o=0,t=thisMapData.doors;for(var n=0 in t)t[n].map==newMap&&(a+=t[n].startX,o+=t[n].startY);var r=a/3,i=o/3;e="/generateDungeonMap.php?playerId="+characterId+"&originatingMapId="+currentMap+"&requestedMap="+newMap+"&dungeonName="+randomDungeonName+"&connectingDoorX="+r+"&connectingDoorY="+i}currentMap=newMap,loadMapJSON(e)}function loadMapAssets(){imagesToLoad=[];var e=currentMap;0>currentMap&&(e="dungeon/"+randomDungeonName),imagesToLoad.push({name:"backgroundImg",src:"/images/game-world/maps/"+e+"/bg.png"}),tileGraphicsToLoad=thisMapData.graphics;for(var a=0;a<tileGraphicsToLoad.length;a++)imagesToLoad.push({name:"tile"+a,src:"/images/game-world/maps/"+e+"/"+tileGraphicsToLoad[a].src});npcGraphicsToLoad=thisMapData.npcs;for(var a=0;a<npcGraphicsToLoad.length;a++)imagesToLoad.push({name:"npc"+a,src:"/images/game-world/npcs/"+npcGraphicsToLoad[a].src});Loader.preload(imagesToLoad,prepareGame,loadingProgress)}function prepareGame(){tileImages=[];for(var e=0;e<tileGraphicsToLoad.length;e++)tileImages[e]=Loader.getImage("tile"+e);npcImages=[];for(var e=0;e<npcGraphicsToLoad.length;e++)npcImages[e]=Loader.getImage("npc"+e);backgroundImg=Loader.getImage("backgroundImg");for(var e=0;e<thisMapData.npcs.length;e++)thisMapData.npcs[e].x=getTileCentreCoordX(thisMapData.npcs[e].tileX),thisMapData.npcs[e].y=getTileCentreCoordY(thisMapData.npcs[e].tileX);hero.x=getTileCentreCoordX(hero.tileX),hero.y=getTileCentreCoordY(hero.tileY),timeSinceLastFrameSwap=0,currentAnimationFrame=0,mapTransition="in",mapTransitionCurrentFrames=1,gameMode="play"}function removeMapAssets(){for(var e=0;e<tileGraphicsToLoad.length;e++)tileImages[e].src="",tileImages[e]=null;for(var e=0;e<npcGraphicsToLoad.length;e++)npcImages[e].src="",npcImages[e]=null;backgroundImg.src="",backgroundImg=null}function loadingProgress(){console.log("loading - "+Loader.getProgress())}function changeMaps(e,a){previousZoneName=thisMapData.zoneName,gameMode="mapLoading",removeMapAssets();var o=thisMapData.doors,t=getTileX(e)+","+getTileX(a);hero.tileX=o[t].startX,hero.tileY=o[t].startY,newMap=o[t].map,loadMap()}function isATerrainCollision(e,a){var o=getTileX(e),t=getTileY(a);if(0>o||0>t||o>=mapTilesX||t>=mapTilesY)return 1;switch(thisMapData.collisions[t][o]){case 1:return 1;case"d":return activeDoorX=e,activeDoorY=a,0;default:return 0}}function startDoorTransition(){""==mapTransition&&(mapTransitionCurrentFrames=1,mapTransition="out")}function checkHeroCollisions(){if(activeDoorX=-1,activeDoorY=-1,key[2])if(isATerrainCollision(hero.x-hero.width/2,hero.y-hero.height/2)||isATerrainCollision(hero.x+hero.width/2,hero.y-hero.height/2)){var e=getTileY(hero.y-hero.height/2),a=(e+1)*tileW;hero.y=a+hero.height/2+1}else-1!=activeDoorX&&startDoorTransition();if(key[3])if(isATerrainCollision(hero.x-hero.width/2,hero.y+hero.height/2)||isATerrainCollision(hero.x+hero.width/2,hero.y+hero.height/2)){var e=getTileY(hero.y+hero.height/2),o=e*tileW;hero.y=o-hero.height/2-1}else-1!=activeDoorX&&startDoorTransition();if(key[0])if(isATerrainCollision(hero.x-hero.width/2,hero.y+hero.height/2)||isATerrainCollision(hero.x-hero.width/2,hero.y-hero.height/2)){var e=getTileX(hero.x-hero.width/2),t=(e+1)*tileW;hero.x=t+hero.width/2+1}else-1!=activeDoorX&&startDoorTransition();if(key[1])if(isATerrainCollision(hero.x+hero.width/2,hero.y+hero.height/2)||isATerrainCollision(hero.x+hero.width/2,hero.y-hero.height/2)){var e=getTileX(hero.x+hero.width/2),n=e*tileW;hero.x=n-hero.width/2-1}else-1!=activeDoorX&&startDoorTransition()}function gameLoop(){switch(gameMode){case"mapLoading":console.log("loading map assets...");break;case"paused":break;case"play":update(),draw()}window.requestAnimationFrame(gameLoop)}function update(){var e=window.performance.now(),a=e-lastTime;if(lastTime=e,hero.isMoving=!1,"out"!=mapTransition)key[2]?(hero.isMoving=!0,hero.facing="up",hero.y-=hero.speed):key[3]?(hero.isMoving=!0,hero.facing="down",hero.y+=hero.speed):key[0]?(hero.isMoving=!0,hero.facing="left",hero.x-=hero.speed):key[1]&&(hero.isMoving=!0,hero.facing="right",hero.x+=hero.speed),hero.tileX=getTileX(hero.x),hero.tileY=getTileY(hero.y),checkHeroCollisions();else{switch(hero.isMoving=!0,hero.facing){case"up":hero.y-=hero.speed;break;case"down":hero.y+=hero.speed;break;case"left":hero.x-=hero.speed;break;case"right":hero.x+=hero.speed}mapTransitionCurrentFrames++,mapTransitionCurrentFrames>=mapTransitionMaxFrames&&changeMaps(activeDoorX,activeDoorY)}"in"==mapTransition&&(mapTransitionCurrentFrames+=2,mapTransitionCurrentFrames>=mapTransitionMaxFrames&&(mapTransition="")),timeSinceLastFrameSwap+=a,timeSinceLastFrameSwap>animationUpdateTime&&currentAnimationFrame++}function draw(){if("mapLoading"==gameMode)gameContext.fillRect(0,0,canvasWidth,canvasHeight),gameContext.fillStyle="black",gameContext.fill();else{var e,a,o,t,n,r=[[findIsoDepth(findIsoCoordsX(hero.x,hero.y),findIsoCoordsY(hero.x,hero.y)),heroImg,Math.floor(canvasWidth/2-hero.feetOffsetX),Math.floor(canvasHeight/2-hero.feetOffsetY)]],i=thisMapData.terrain,s=0,h=0;hero.isox=findIsoCoordsX(hero.x,hero.y),hero.isoy=findIsoCoordsY(hero.x,hero.y);for(var c=0;mapTilesX>c;c++)for(var l=0;mapTilesY>l;l++)"*"!=i[l][c]&&(o=getTileIsoCentreCoordX(c,l),t=getTileIsoCentreCoordY(c,l),e=thisMapData.graphics[i[l][c]].centreX,a=thisMapData.graphics[i[l][c]].centreY,r.push([findIsoDepth(o,t),tileImages[i[l][c]],Math.floor(o-hero.isox-e+canvasWidth/2),Math.floor(t-hero.isoy-a+canvasHeight/2)]));for(var c=0;c<thisMapData.npcs.length;c++)n=thisMapData.npcs[c],s=currentAnimationFrame%n.sequences["walk-up"].length,o=findIsoCoordsX(n.x,n.y),t=findIsoCoordsY(n.x,n.y),r.push([findIsoDepth(o,t),npcImages[c],s*n.width,h,n.width,n.height,Math.floor(o-hero.isox-n.centreX+canvasWidth/2),Math.floor(t-hero.isoy-n.centreY+canvasHeight/2),n.width,n.height]);r.sort(sortByIsoDepth),gameContext.drawImage(backgroundImg,Math.floor(getTileIsoCentreCoordX(0,mapTilesX-1)-hero.isox-tileW/2),Math.floor(getTileIsoCentreCoordY(0,0)-hero.isoy-tileH/2));for(var c=0;c<r.length;c++)10==r[c].length?gameContext.drawImage(r[c][1],r[c][2],r[c][3],r[c][4],r[c][5],r[c][6],r[c][7],r[c][8],r[c][9]):gameContext.drawImage(r[c][1],r[c][2],r[c][3]);if("out"==mapTransition){var d=1-mapTransitionCurrentFrames/mapTransitionMaxFrames,g=gameContext.createRadialGradient(canvasWidth/2,canvasHeight/2,d*canvasWidth/2,canvasWidth/2,canvasHeight/2,0);g.addColorStop(0,"rgba(0,0,0,1)"),g.addColorStop(1,"rgba(0,0,0,0)"),gameContext.fillStyle=g,gameContext.fillRect(0,0,canvasWidth,canvasHeight)}else if("in"==mapTransition){var d=mapTransitionCurrentFrames/mapTransitionMaxFrames,g=gameContext.createRadialGradient(canvasWidth/2,canvasHeight/2,d*canvasWidth/2,canvasWidth/2,canvasHeight/2,0);g.addColorStop(0,"rgba(0,0,0,1)"),g.addColorStop(1,"rgba(0,0,0,0)"),gameContext.fillStyle=g,gameContext.fillRect(0,0,canvasWidth,canvasHeight)}}}var animationFramesPerSecond=16,lastTime=0,elapsed=0,timeSinceLastFrameSwap=0,currentAnimationFrame=0,animationUpdateTime=1e3/animationFramesPerSecond,mapTransition="",mapTransitionCurrentFrames=1,mapTransitionMaxFrames=60,activeDoorX=-1,activeDoorY=-1,characterId=999,currentMap=2,newMap=currentMap,thisMapData="",mapTilesX=0,mapTilesY=0,tileGraphics=[],tileW=48,tileH=tileW/2,tileGraphicsToLoad=0,npcGraphicsToLoad=0,canvasWidth=800,canvasHeight=600,randomDungeonName="",randomDungeons=["","the-barrow-mines"],previousZoneName="",key=[0,0,0,0,0],hero={x:0,y:0,dx:0,dy:0,tileX:12,tileY:12,width:20,height:20,feetOffsetX:40,feetOffsetY:69,speed:4,isMoving:!1,facing:"down",sequences:{"stand-down":[3],"stand-up":[10],"stand-right":[17],"stand-left":[24],"walk-down":[3,4,5,6,5,4,3,2,1,0,1,2],"walk-up":[10,11,12,13,12,11,10,9,8,7,8,9],"walk-right":[17,18,19,20,19,18,17,16,15,14,15,16],"walk-left":[24,25,26,27,26,25,24,23,22,21,22,23]}};!function(){for(var e=0,a=["ms","moz","webkit","o"],o=0;o<a.length&&!window.requestAnimationFrame;++o)window.requestAnimationFrame=window[a[o]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[a[o]+"CancelAnimationFrame"]||window[a[o]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(a,o){var t=(new Date).getTime(),n=Math.max(0,16-(t-e)),r=window.setTimeout(function(){a(t+n)},n);return e=t+n,r}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}();var getJSON=function(e,a,o){var t="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");t.open("get",e,!0),t.onreadystatechange=function(){var e,n;if(4==t.readyState){e=t.status;var r=!0;if(200==e){try{n=JSON.parse(t.responseText)}catch(i){r=!1,o&&o(e)}r&&a&&a(n)}else o&&o(e)}},t.send()};window.Loader=function(){function e(){c=0,l=!1,d=0,g={}}function a(){}function o(){}function t(e){++c,a(h()),c==d&&(l=!1,o())}function n(e){console.log("Error on loading the image: "+e.srcElement)}function r(e,a){try{g[e]=new Image,g[e].onload=function(){t(e)},g[e].onerror=n,g[e].src=a}catch(o){console.log(o.message)}}function i(e){return g[e]?g[e]:void 0}function s(t,n,i){if(e(),!l){l=!0;try{d=t.length,a=i||function(){},o=n||function(){};for(var s=0;s<t.length;++s)r(t[s].name,t[s].src)}catch(h){console.log(h.message)}}}function h(){return c/d*100}var c=0,l=!1,d=0,g={};return{preload:s,getProgress:h,getImage:i,reset:e,images:g}}();var Input={init:function(){document.addEventListener("keydown",function(e){Input.changeKey(e.keyCode,1)}),document.addEventListener("keyup",function(e){Input.changeKey(e.keyCode,0)})},changeKey:function(e,a){switch(e){case KeyBindings.left:key[0]=a;break;case KeyBindings.up:key[2]=a;break;case KeyBindings.right:key[1]=a;break;case KeyBindings.down:key[3]=a;break;case KeyBindings.action:key[4]=a}}},KeyBindings={left:37,right:39,up:38,down:40,action:32,pause:80},UI={init:function(){document.getElementById("displayZoneName")},showZoneName:function(e){displayZoneName.classList.remove("active"),displayZoneName.textContent=e,void displayZoneName.offsetWidth,displayZoneName.classList.add("active")}};"serviceWorker"in navigator&&navigator.serviceWorker.register("/game-world/serviceWorker.min.js",{scope:"/game-world/"}),"querySelectorAll"in document&&"addEventListener"in window&&window.HTMLCanvasElement&&init();