"use strict";var soundGainNode,audioContext=null,soundEffects={},soundsToLoad={coins:"../sounds/coins-NOT_MINE-wow.mp3",bookOpen:"../sounds/book-open-NOT_MINE-wow.mp3",chestOpen:"../sounds/chest-open-NOT_MINE-wow.mp3",bagOpen:"../sounds/bag-open-NOT_MINE-wow.mp3",buttonClick:"../sounds/button-press-NOT_MINE-wow.mp3",hen:"../sounds/hen-NOT_MINE.mp3",horse:"../sounds/horse-NOT_MINE.mp3",lever:"../sounds/lever-NOT_MINE.mp3",keys:"../sounds/keys-NOT_MINE-wow.mp3",unlock:"../sounds/unlock-NOT_MINE-wow.mp3",gather1:"../sounds/gather-herb-NOT_MINE-wow.mp3",gather4:"../sounds/mining-NOT_MINE-wow.mp3",rain:"../sounds/rain-NOT_MINE-youtube.mp3",questComplete:"../sounds/quest-complete-NOT_MINE-wow.mp3",dyeing:"../sounds/dyeing-NOT_MINE-wow.mp3",weaving:"../sounds/tailoring-NOT_MINE.mp3"},loadBuffer=function(e,t){var a=new XMLHttpRequest;a.open("GET",e,!0),a.responseType="arraybuffer",a.onload=function(){audioContext.decodeAudioData(a.response,function(a){a?soundEffects[t]=a:console.log("error decoding file data: "+e)},function(e){console.log("decodeAudioData error",e)})},a.onerror=function(){console.log("audio XHR error")},a.send()},audio={lastTrack:"",init:function(){try{for(var e in window.AudioContext=window.AudioContext||window.webkitAudioContext,audioContext=new AudioContext,(soundGainNode=audioContext.createGain()).connect(audioContext.destination),soundsToLoad)loadBuffer(soundsToLoad[e],e)}catch(e){}},initMusic:function(e){audio[e]=new Audio,audio[e].id=e;var t=document.createElement("source");t.type="audio/mpeg",t.src="/music/game-world/"+e+".mp3",audio[e].appendChild(t),audio[e+"Gain"]=audioContext.createGain(),audio[e+"Source"]=audioContext.createMediaElementSource(audio[e]),audio[e+"Source"].connect(audio[e+"Gain"]),audio[e+"Gain"].connect(audioContext.destination),audio[e].addEventListener("ended",audio.removeMusic,!1)},removeMusic:function(e){var t=e.target.id;audio[t].removeEventListener("ended",audio.removeMusic,!1),delete audio[t],delete audio[t+"Source"],delete audio[t+"Gain"],audio.activeTrack==t&&(audio.activeTrack=void 0)},playSound:function(e,t){var a=audioContext.createBufferSource();a.buffer=e,a.connect(soundGainNode),a.start?a.start(t):a.start=a.noteOn},playMusic:function(e){if(void 0!==audio.activeTrack){if(audio.activeTrack!=e){audio.initMusic(e);var t=audioContext.currentTime;audio[audio.activeTrack+"Gain"].gain.linearRampToValueAtTime(gameSettings.musicVolume,t),audio[audio.activeTrack+"Gain"].gain.linearRampToValueAtTime(0,t+6),audio[e+"Gain"].gain.linearRampToValueAtTime(0,0),audio[e+"Gain"].gain.linearRampToValueAtTime(gameSettings.musicVolume,6),audio[e].play(),audio.activeTrack=e,audio.lastTrack=e}}else e!=audio.lastTrack&&(audio.initMusic(e),audio[e].play(),audio.activeTrack=e,audio.lastTrack=e,audio[audio.activeTrack+"Gain"].gain.setValueAtTime(gameSettings.musicVolume,audioContext.currentTime))},adjustEffectsVolume:function(){gameSettings.soundVolume=soundVolume.value,void 0!==soundGainNode&&soundGainNode.gain.setValueAtTime(gameSettings.soundVolume,0)},adjustMusicVolume:function(){gameSettings.musicVolume=musicVolume.value,void 0!==audio.activeTrack&&audio[audio.activeTrack+"Gain"].gain.setValueAtTime(gameSettings.musicVolume,audioContext.currentTime)},loadAmbientSounds:function(e){for(var t in e)loadBuffer(e[t],t)},checkForAmbientSounds:function(){thisMapData.ambientSounds&&hero.totalGameTimePlayed-timeSinceLastAmbientSoundWasPlayed>minTimeBetweenAmbientSounds&&1==getRandomIntegerInclusive(1,240)&&(timeSinceLastAmbientSoundWasPlayed=hero.totalGameTimePlayed,audio.playSound(soundEffects[getRandomKeyFromObject(thisMapData.ambientSounds)],0))}};function updateCartographicMiniMap(){var e=246/(mapTilesX*tileW),t=hero.x*e,a=hero.y*e,n=offScreenCartographyContext.createRadialGradient(t,a,0,t,a,35);n.addColorStop(0,"rgb(255,255,255)"),n.addColorStop(1,"rgba(255,255,255,0)"),offScreenCartographyContext.arc(t,a,35,0,2*Math.PI),offScreenCartographyContext.fillStyle=n,offScreenCartographyContext.fill(),cartographyContext.clearRect(0,0,246,246),cartographyContext.globalCompositeOperation="copy",cartographyContext.drawImage(offScreenCartographyCanvas,0,0),cartographyContext.globalCompositeOperation="source-atop",cartographyContext.drawImage(canvasMapImage,0,0)}function initCartographicMap(){canvasMapImage.src="/game-world/generateCartographicMap.php?playerId="+characterId+"&dungeonName="+randomDungeonName+"&plotChests=true&requestedMap="+newMap,canvasMapImage.onload=function(){canvasMapMaskImage.src="/game-world/getCartographicMapMask.php?chr="+characterId+"&dungeonName="+randomDungeonName+"&currentMap="+newMap+"&cache="+Date.now(),canvasMapMaskImage.onload=function(){offScreenCartographyContext.clearRect(0,0,246,246),offScreenCartographyContext.drawImage(canvasMapMaskImage,0,0),updateCartographicMiniMap()}}}function saveCartographyMask(){var e=offScreenCartographyCanvas.toDataURL();postData("/game-world/saveCartographicMapMask.php","chr="+characterId+"&dungeonName="+randomDungeonName+"&currentMap="+currentMap+"&data="+e)}function getColourName(e,t){var a="";return 1!=currentActiveInventoryItems[t].hasInherentColour&&(a=colourNames[e]),a}function mixColours(e){for(var t=0,a=0,n=0,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],o=0;o<e.length;o++)i[e[o]]++,t|=e[o],e[o]==(16|e[o])&&a++,e[o]==(8|e[o])&&n++;for(o=0;o<i.length;o++)if(i[o]/e.length>.7){t=o;break}return t>24&&(t-=a>n?8:a<n?16:24),t}const animationFramesPerSecond=16;var gameCanvas,gameContext,gameMode,cartographyContext,cartographyCanvas,offScreenCartographyCanvas,offScreenCartographyContext,canvasMapImage,canvasMapMaskImage,heroImg,shadowImg,imagesToLoad,tileImages,npcImages,itemImages,backgroundImg,objInitLeft,objInitTop,dragStartX,dragStartY,inventoryCheck,timeSinceLastAmbientSoundWasPlayed,gameSettings,lightMap,lightMapOverlay,lightMapContext,activeGatheredObject,questResponseNPC,cursorPositionX,cursorPositionY,lastTime=0,elapsed=0,timeSinceLastFrameSwap=0,currentAnimationFrame=0,animationUpdateTime=62.5,chestIdOpen=-1,currentWeather="",outsideWeather="",weatherLastChangedTime=0;const minTimeBetweenWeatherChanges=5e3;var interfaceIsVisible=!0,activeAction="",dowsing={},gathering={},surveying={},plotPlacement={},postObject={active:!1},retinueObject={active:!1},craftingObject={},retinueBaseLocationX=200,retinueBaseLocationY=350,jumpMapId=null;const titleTagPrefix="Autumn Earth";var mapTransition="",mapTransitionCurrentFrames=1;const mapTransitionMaxFrames=60;var activeDoorX=-1,activeDoorY=-1;const characterId=999;var currentMap=0,newMap=0,thisMapData="",mapTilesX=0,mapTilesY=0,tileGraphics=[];const tileW=48,tileH=tileW/2;var tileGraphicsToLoad=0,npcGraphicsToLoad=0,itemGraphicsToLoad=0,canvasWidth=800,canvasHeight=600,randomDungeonName="",randomDungeons=["","the-dwarrow-mines","the-barrow-mines"],previousZoneName="",currentActiveInventoryItems=[],maxNumberOfItemsPerSlot=20,isSplitStackBeingDragged=!1,possibleTitles=[],inventoryInterfaceIsBuilt=!1,whichTransitionEvent="",whichAnimationEvent="",activeObjectForDialogue="";const closeDialogueDistance=200;var thisChallengeNPC,canCloseDialogueBalloonNextClick=!1,thisSpeech="",boosterCardsRevealed=0,boosterCardsToAdd=[],questData=[],hasActivePet=!1;const breadCrumbLength=16;var activePetImages=[];const minTimeBetweenAmbientSounds=1200;var colourNames=[],currentRecipePanelProfession=-1,currentItemGroupFilters="",thisMapShopItemIds="",shopCurrentlyOpen=-1;const inflationModifier=10,sellPriceModifier=.7,sellPriceSpecialismModifier=.8,buyPriceSpecialismModifier=.9,baseGatheringTime=5e3,gatheringStabilityModifier=.002,gatheringDepletionModifier=2e3,dowsingRingSize=100,baseDowsingRange=10,baseSurveyingTime=1e3,surveyingDepletionModifier=500;var key=[0,0,0,0,0,0,0],hero={x:0,y:0,z:0,dx:0,dy:0,breadcrumb:[],width:20,length:20,centreX:40,centreY:69,speed:4,spriteWidth:62,spriteHeight:79,isMoving:!1,facing:"n",animation:{walk:{length:1,n:0,e:1,s:2,w:3}}},fae={particles:[],maxParticles:18,radiusAroundHero:35,angleAroundHero:0,targetX:0,targetY:0,currentState:"hero",abandonRadius:500,zOffset:40,oscillateOffset:0};function recipeSearchAndFilter(){var e=hero.crafting[currentRecipePanelProfession].sortOrder;if(""!=recipeSearch.value){var t=recipeSearch.value.toLowerCase();for(var a in e=[],hero.crafting[currentRecipePanelProfession].recipes)-1!=hero.crafting[currentRecipePanelProfession].recipes[a].recipeName.toLowerCase().indexOf(t)?e.push(a):-1!=hero.crafting[currentRecipePanelProfession].recipes[a].recipeDescription.toLowerCase().indexOf(t)&&e.push(a)}var n,i=document.querySelectorAll("#createRecipeList li");for(n=0;n<i.length;++n)i[n].classList.remove("active");var o=0;for(n=0;n<e.length;n++)-1!=recipeFilter.value.indexOf(e[n])&&(document.getElementById("recipe"+e[n]).classList.add("active"),o++);0==o&&document.getElementById("noRecipesFound").classList.add("active"),""!=UI.highlightedRecipe&&(document.getElementById(UI.highlightedRecipe).classList.contains("active")||(document.getElementById(UI.highlightedRecipe).classList.remove("highlighted"),craftingRecipeCreateButton.disabled=!0,UI.highlightedRecipe="")),thisDevicesScrollBarWidth>0&&recipeCustomScrollBar.init()}function recipeSearchInput(){""!=recipeSearch.value?clearRecipeSearch.classList.add("active"):clearRecipeSearch.classList.remove("active"),recipeSearchAndFilter()}function recipeSearchClear(){recipeSearch.value="",clearRecipeSearch.classList.remove("active"),recipeSearchAndFilter()}function recipeSelectComponents(e){releaseLockedSlots(),craftingTimeBarOuter.style.display="none",startCrafting.style.display="block",startCrafting.disabled=!0,craftingSelectComponentsPanel.classList.add("active");var t,a=e.substring(6),n=!1,i="-",o=JSON.parse(JSON.stringify(hero.crafting[currentRecipePanelProfession].recipes[a]));craftingObject={componentsAdded:[],whichRecipe:e,thisRecipe:o,required:[],componentInfluences:[],craftedItem:{type:parseInt(o.creates),quantity:1,quality:0,durability:0,effectiveness:0,currentWear:0,wrapped:0,colour:0,enchanted:0,hallmark:0-characterId,inscription:""},finalItemName:o.recipeName,isCreating:!1,optionalDyeAdded:0};var r,s,c,l,d="<h4>Requires:</h4><ul>",h="<h4>Available:</h4><ul>",u=0,g='<div id="craftingOutput"><div id="craftingOutputAttributes"></div><img src="/images/game-world/inventory-items/'+o.imageId+'.png" alt="'+o.recipeName+'"></div><h3>'+o.recipeName+"</h3><p>"+o.recipeDescription+"</p>",p={durability:0,effectiveness:0,quality:0},m={durability:0,effectiveness:0,quality:0},f=o.components.length;for(var v in o.components)if(null!=o.components[v].influence)for(var y in o.components[v].influence)m[y]+=o.components[v].influence[y],p[y]++;else o.components[v].influence={durability:void 0,effectiveness:void 0,quality:void 0};for(var v in o.components){if(l=!1,"",s=void 0!==o.components[v].influence.effectiveness?o.components[v].influence.effectiveness:(100-m.effectiveness)/(f-p.effectiveness),r=void 0!==o.components[v].influence.durability?o.components[v].influence.durability:(100-m.durability)/(f-p.durability),c=void 0!==o.components[v].influence.quality?o.components[v].influence.quality:(100-m.quality)/(f-p.quality),craftingObject.componentInfluences[o.components[v].type]={effectiveness:s,durability:r,quality:c},isNaN(o.components[v].type)){if(d+='<li id="componentType'+o.components[v].type+'">'+generateAttributeGraphicMarkup(c,r,s)+'<img class="previewSlot" src="/images/game-world/inventory-items/'+o.components[v].type+'.png" class="planImage" alt=""><p>'+o.components[v].quantity+"x "+currentItemGroupFilters[o.components[v].type]+"</p></li>",t=hasItemTypeInInventory(o.components[v].type),"dye"==o.components[v].type&&(n=!0),t.length>0)for(y=0;y<t.length;y++)h+='<li id="fromSlot'+t[y]+'">'+generateCraftingSlotMarkup(hero.inventory[t[y]])+"</li>",document.getElementById("slot"+t[y]).classList.add("locked"),u++,l=!0}else if(d+='<li id="componentType'+o.components[v].type+'">'+generateAttributeGraphicMarkup(c,r,s)+'<img src="/images/game-world/inventory-items/'+o.components[v].type+'.png" class="planImage" alt="'+currentActiveInventoryItems[o.components[v].type].shortname+'"><p>'+o.components[v].quantity+"x "+currentActiveInventoryItems[o.components[v].type].shortname+"</p></li>",(t=findSlotItemIdInInventory(o.components[v].type)).length>0)for(var y=0;y<t.length;y++)h+='<li id="fromSlot'+t[y]+'">'+generateCraftingSlotMarkup(hero.inventory[t[y]])+"</li>",document.getElementById("slot"+t[y]).classList.add("locked"),u++,l=!0;craftingObject.required.push({type:o.components[v].type,quantity:o.components[v].quantity}),l||(h+='<li class="componentMissing">You\'re missing a component type</li>'),o.components[v].type!=i&&(h+="</ul><ul>"),i=o.components[v].type}if(0==u&&(h+='<li id="noComponentsAvailable"><p>You don\'t have any of the required components for this recipe.</p></li></ul><ul>'),currentActiveInventoryItems[o.creates].dyeable>0&&(d+='<li id="componentTypeAdditionalDye"><img src="/images/game-world/inventory-items/dye.png" alt=""><p>Dye (optional)</p></li>',!n&&(t=hasItemTypeInInventory("dye")).length>0))for(y=0;y<t.length;y++)h+='<li id="fromSlot'+t[y]+'">'+generateCraftingSlotMarkup(hero.inventory[t[y]])+"</li>",document.getElementById("slot"+t[y]).classList.add("locked");d+='<li id="componentTypeAdditionalImbue"><img src="/images/game-world/inventory-items/enchant.png" alt=""><p>Imbue item (optional)</p></li>',d+="</ul>",h+="</ul>",selectComponentsItemBeingCreated.innerHTML=d,componentsAvailableForThisRecipe.innerHTML=h,displayItemBeingCreated.innerHTML=g}function releaseLockedSlots(){for(var e=document.querySelectorAll("#inventoryPanels .locked"),t=0;t<e.length;t++)e[t].classList.remove("locked")}function addCraftingComponents(e,t){for(var a,n,i,o,r,s=e.substring(8),c=!1,l=0;l<craftingObject.required.length;l++)if(r=!1,craftingObject.required[l].type==hero.inventory[s].type||craftingObject.required[l].type==currentActiveInventoryItems[hero.inventory[s].type].group){if(craftingObject.required[l].quantity>0)r=!0;else if(t){for(var d=0,h=-1,u=0;u<craftingObject.componentsAdded.length;u++)craftingObject.componentsAdded[u].type==craftingObject.required[l].type&&(d++,h=u);1==d&&craftingObject.componentsAdded[h].fromSlot!=s&&(document.querySelector("#componentType"+craftingObject.required[l].type+" .addedItemToRecipe").remove(),(n=document.querySelector("#fromSlot"+craftingObject.componentsAdded[h].fromSlot+" .qty")).classList.remove("modified"),n.textContent=hero.inventory[craftingObject.componentsAdded[h].fromSlot].quantity,craftingObject.required[l].quantity=craftingObject.componentsAdded[h].quantity,craftingObject.componentsAdded.splice(h,1),r=!0)}r&&("dye"==currentActiveInventoryItems[hero.inventory[s].type].group&&(c=!0),a=craftingObject.required[l].quantity,craftingObject.required[l].quantity>hero.inventory[s].quantity&&(a=hero.inventory[s].quantity),craftingObject.required[l].quantity-=a,craftingObject.componentsAdded.push({fromSlot:s,quantity:a,type:craftingObject.required[l].type}),(n=document.querySelector("#"+e+" .qty")).classList.add("modified"),n.textContent=hero.inventory[s].quantity-a,(i=document.getElementById("componentType"+hero.inventory[s].type))||(i=document.getElementById("componentType"+currentActiveInventoryItems[hero.inventory[s].type].group)),i&&((o=JSON.parse(JSON.stringify(hero.inventory[s]))).quantity=a,i.innerHTML+='<div class="addedItemToRecipe">'+generateCraftingSlotMarkup(o)+"</div>"))}"dye"==currentActiveInventoryItems[hero.inventory[s].type].group&&(c||(craftingObject.componentsAdded.push({fromSlot:s,quantity:1,type:"dye"}),(n=document.querySelector("#"+e+" .qty")).classList.add("modified"),n.textContent=hero.inventory[s].quantity-1,(o=JSON.parse(JSON.stringify(hero.inventory[s]))).quantity=1,document.getElementById("componentTypeAdditionalDye").innerHTML+='<div class="addedItemToRecipe">'+generateCraftingSlotMarkup(o)+"</div>",craftingObject.optionalDyeAdded++));var g=!0;for(l=0;l<craftingObject.required.length;l++)craftingObject.required[l].quantity>0&&(g=!1);if(g){if(craftingObject.optionalDyeAdded>0){for(var l in craftingObject.componentInfluences)craftingObject.componentInfluences[l].durability*=.9,craftingObject.componentInfluences[l].effectiveness*=.9,craftingObject.componentInfluences[l].quality*=.9;var p=0,m=0,f=0,v=0;for(var l in craftingObject.componentsAdded)"dye"==craftingObject.componentsAdded[l].type&&(p++,m+=hero.inventory[craftingObject.componentsAdded[l].fromSlot].quality,f+=hero.inventory[craftingObject.componentsAdded[l].fromSlot].durability,v+=hero.inventory[craftingObject.componentsAdded[l].fromSlot].effectiveness);m*=.1/p,f*=.1/p,v*=.1/p,craftingObject.componentInfluences.dye={effectiveness:v,durability:f,quality:m}}var y,I=[];for(l=0;l<craftingObject.componentsAdded.length;l++)y=craftingObject.componentsAdded[l].type,craftingObject.craftedItem.quality+=determineAttributeValue(hero.inventory[craftingObject.componentsAdded[l].fromSlot].quality,craftingObject.componentInfluences[y].quality),craftingObject.craftedItem.durability+=determineAttributeValue(hero.inventory[craftingObject.componentsAdded[l].fromSlot].durability,craftingObject.componentInfluences[y].durability),craftingObject.craftedItem.effectiveness+=determineAttributeValue(hero.inventory[craftingObject.componentsAdded[l].fromSlot].effectiveness,craftingObject.componentInfluences[y].effectiveness),0!=hero.inventory[craftingObject.componentsAdded[l].fromSlot].colour&&I.push(hero.inventory[craftingObject.componentsAdded[l].fromSlot].colour);if(craftingObject.craftedItem.quality=Math.floor(craftingObject.craftedItem.quality),craftingObject.craftedItem.durability=Math.floor(craftingObject.craftedItem.durability),craftingObject.craftedItem.effectiveness=Math.floor(craftingObject.craftedItem.effectiveness),document.getElementById("craftingOutputAttributes").innerHTML=generateAttributeGraphicMarkup(craftingObject.craftedItem.quality,craftingObject.craftedItem.durability,craftingObject.craftedItem.effectiveness),craftingObject.craftedItem.colour=mixColours(I),craftingObject.craftedItem.colour!=craftingObject.thisRecipe.defaultColour){var b=getColourName(craftingObject.craftedItem.colour,craftingObject.craftedItem.type);document.querySelector("#craftingOutput img").src="/images/game-world/inventory-items/"+craftingObject.craftedItem.type+"-"+b.toLowerCase()+".png",craftingObject.finalItemName=b+" "+currentActiveInventoryItems[craftingObject.craftedItem.type].shortname,document.querySelector("#displayItemBeingCreated h3").innerText=craftingObject.finalItemName}else document.querySelector("#displayItemBeingCreated h3").innerText=craftingObject.thisRecipe.recipeName,document.querySelector("#craftingOutput img").src="/images/game-world/inventory-items/"+craftingObject.thisRecipe.imageId+".png";startCrafting.disabled=!1}else startCrafting.disabled=!0,document.getElementById("craftingOutputAttributes").innerHTML="",document.querySelector("#displayItemBeingCreated h3").innerText=craftingObject.thisRecipe.recipeName,document.querySelector("#craftingOutput img").src="/images/game-world/inventory-items/"+craftingObject.thisRecipe.imageId+".png"}function startCraftingTimer(){craftingObject.timeRemaining=100,craftingObject.depletionSpeed=.5,craftingObject.isCreating=!0,UI.updateCraftingPanel(),craftingTimeBarOuter.style.display="block",startCrafting.style.display="none",audio.playSound(soundEffects[hero.crafting[currentRecipePanelProfession].name.toLowerCase()],0)}function processCrafting(){craftingObject.timeRemaining-=craftingObject.depletionSpeed,craftingObject.timeRemaining<=0&&(craftingObject.isCreating=!1,startCraftingProcess()),UI.updateCraftingPanel()}function startCraftingProcess(){(hero.stats.itemsCrafted++,releaseLockedSlots(),(inventoryCheck=canAddItemToInventory([craftingObject.craftedItem]))[0])?UI.showChangeInInventory(inventoryCheck[1]):(sendNPCPost('{"subject":"'+("Your crafted "+craftingObject.finalItemName)+'","message":"'+"This is fine work"+'","senderID":"-1","recipientID":"'+characterId+'","fromName":"'+"Artisan crafter"+'"}',[craftingObject.craftedItem]),UI.showNotification("<p>Crafted item sent by post to you</p>"));if(craftingObject.thisRecipe.hiddenCreates){for(var e=craftingObject.thisRecipe.hiddenCreates.split(","),t=0;t<e.length;t++)a={type:parseInt(e[t]),quantity:1,quality:100,durability:100,currentWear:0,effectiveness:100,colour:0,enchanted:0,hallmark:0,inscription:""};if((inventoryCheck=canAddItemToInventory([a]))[0])UI.showChangeInInventory(inventoryCheck[1]);else sendNPCPost('{"subject":"'+"Your returned crafting items"+'","message":"'+"Returned items"+'","senderID":"-1","recipientID":"'+characterId+'","fromName":"'+"Artisan crafter"+'"}',[a]),UI.showNotification("<p>Crafted item sent by post to you</p>")}if(craftingObject.optionalDyeAdded>0){var a={type:11,quantity:craftingObject.optionalDyeAdded,quality:100,durability:100,currentWear:0,effectiveness:100,colour:0,enchanted:0,hallmark:0,inscription:""};if((inventoryCheck=canAddItemToInventory([a]))[0])UI.showChangeInInventory(inventoryCheck[1]);else sendNPCPost('{"subject":"'+"Your returned crafting items"+'","message":"'+"Returned items"+'","senderID":"-1","recipientID":"'+characterId+'","fromName":"'+"Artisan crafter"+'"}',[a]),UI.showNotification("<p>Crafted item sent by post to you</p>")}for(t=0;t<craftingObject.componentsAdded.length;t++)removeFromInventory(craftingObject.componentsAdded[t].fromSlot,craftingObject.componentsAdded[t].quantity);recipeSelectComponents(craftingObject.whichRecipe),startCrafting.style.display="block",craftingTimeBarOuter.style.display="none"}function determineAttributeValue(e,t){return Math.sqrt(e*t*t/100)}function findRecipeTierLevel(e){var t=e/10;return 10-Math.sqrt(100-t*t)}function gradeAttribute(e){for(var t=[{max:91,grade:"#04752c"},{max:66,grade:"#82b11e"},{max:36,grade:"#b98c45"},{max:11,grade:"#ab471d"}],a=0;a<t.length;a++){var n=t[a];if(e>=n.max)return n.grade}return"#b41119"}function generateCraftingSlotMarkup(e){var t='<div class="attributeSlot">',a="",n="",i="",o=getColourName(e.colour,e.type);return""!=o&&(a=o+" ",n="-"+o.toLowerCase()),"card"==currentActiveInventoryItems[e.type].action&&(i+="players card"),t+=generateAttributeGraphicMarkup(e.quality,e.durability,e.effectiveness),t+='<img src="/images/game-world/inventory-items/'+e.type+n+'.png" alt="'+a+currentActiveInventoryItems[e.type].shortname+'" class="'+i+'">',t+='<span class="qty">'+e.quantity+"</span></div>",t+="<p>"+a+currentActiveInventoryItems[e.type].shortname+"</p>"}function generateAttributeGraphicMarkup(e,t,a){return'<svg xmlns="http://www.w3.org/2000/svg" height="100" width="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="'+gradeAttribute(a)+'"/><path d="M6.699 75a50 50 0 0 1 0-50A50 50 0 0 1 50 0v50z" fill="'+gradeAttribute(e)+'"/><path d="M50 0a50 50 0 0 1 43.301 25 50 50 0 0 1 0 50l-43.3-25z" fill="'+gradeAttribute(t)+'"/></svg>'}function scrollbarWidth(){var e=document.createElement("div");e.style.cssText="width:50px;height:50px;overflow-y:scroll;top:-200px;left:-200px;position:absolute;";var t;document.body.appendChild(e),t=e.offsetWidth;var a=e.clientWidth;return document.body.removeChild(e),t-a}function customScrollBar(e){this.element=e,this.scrollingContent=this.element.firstElementChild,this.hasMouseEventsAttached=!1,this.init=function(){this.translateY=0,this.isBeingDragged=!1,this.scrollingContent.scrollTop=0,this.element.classList.remove("inActive"),this.scrollingContent.style.width=this.scrollingContent.offsetWidth+thisDevicesScrollBarWidth+"px",this.paneHeight=this.element.offsetHeight,this.scrollContentHeight=this.scrollingContent.scrollHeight,this.scrollContentHeight>this.paneHeight?(this.scrollbarRatio=this.paneHeight/this.scrollContentHeight,this.draggerHeight=Math.floor(this.scrollbarRatio*this.paneHeight),this.dragger=this.element.querySelector(".dragger"),this.dragger.style.height=this.draggerHeight+"px",this.dragger.style.transform="translateY("+this.translateY+"px)",this.hasMouseEventsAttached||(this.scrollingContent.addEventListener("scroll",this.contentScroll.bind(this)),this.dragger.addEventListener("mousedown",this.startScrollDrag.bind(this)),this.hasMouseEventsAttached=!0)):(this.element.classList.add("inActive"),this.scrollingContent.removeAttribute("style"))},this.contentScroll=function(){if(!this.isBeingDragged){var e=this.scrollingContent.scrollTop,t=Math.round(this.scrollbarRatio*e);this.translateY=t,this.dragger.style.transform="translateY("+this.translateY+"px)"}},this.startScrollDrag=function(e){e.preventDefault(),this.initialClickPosition=e.pageY-this.translateY,this.isBeingDragged=!0,this.mouseMoveEvent=this.handleScrollDrag.bind(this),document.addEventListener("mousemove",this.mouseMoveEvent,!1),this.mouseUpEvent=this.endScrollDrag.bind(this),document.addEventListener("mouseup",this.mouseUpEvent,!1)},this.handleScrollDrag=function(e){this.translateY=e.pageY-this.initialClickPosition,this.translateY<0&&(this.translateY=0),this.translateY+this.draggerHeight>this.paneHeight&&(this.translateY=this.paneHeight-this.draggerHeight),this.dragger.style.transform="translateY("+this.translateY+"px)",this.scrollingContent.scrollTop=this.translateY/this.scrollbarRatio},this.endScrollDrag=function(e){this.isBeingDragged=!1,document.removeEventListener("mousemove",this.mouseMoveEvent,!1),document.removeEventListener("mouseup",this.mouseUpEvent,!1)},this.init()}for(var thisDevicesScrollBarWidth=scrollbarWidth(),scrollBarElements=document.getElementsByClassName("customScrollBar"),i=0;i<scrollBarElements.length;i++)thisDevicesScrollBarWidth>0?window[scrollBarElements[i].id]=new customScrollBar(scrollBarElements[i]):scrollBarElements[i].classList.add("inActive");function processDowsing(){if(thisMapData.hiddenResources[dowsing.category]){for(var e,t=1/0,a=-1,n=0;n<thisMapData.hiddenResources[dowsing.category].length;n++)(e=getPythagorasDistance(hero.tileX,hero.tileY,thisMapData.hiddenResources[dowsing.category][n].tileX,thisMapData.hiddenResources[dowsing.category][n].tileY))<t&&(t=e,a=n);-1!=a?(dowsing.proximity=100-t/dowsing.range*100,dowsing.proximity=capValues(dowsing.proximity,0,100)):dowsing.proximity=0}}function processSurveying(){surveying.timeRemaining-=surveying.depletionSpeed,surveying.timeRemaining<=0&&(activeAction="",surveyingComplete()),UI.updateSurveyingPanel()}function surveyingComplete(){var e,t,a,n,i,o=!1;if(thisMapData.hiddenResources[surveying.category])for(var r=0;r<thisMapData.hiddenResources[surveying.category].length;r++)if(e=thisMapData.hiddenResources[surveying.category][r],getPythagorasDistance(hero.tileX,hero.tileY,e.tileX,e.tileY)<2){switch(n=hero.facing){case"n":i=["e","w","s"];break;case"e":i=["n","s","w"];break;case"s":i=["n","s","e"];break;case"w":i=["e","w","n"]}do{t=hero.tileX+relativeFacing[n].x,a=hero.tileY+relativeFacing[n].y,n=i.shift()}while(!tileIsClear(t,a)&&i.length>0);i.length>0?(e.tileX=t,e.tileY=a,e.isTemporary=!0,thisMapData.items.push(e),initialiseItem(thisMapData.items.length-1),o=!0):console.log("Error - Couldn't place resource node");break}o||UI.showNotification("<p>No resources found</p>"),surveyingStopped()}function surveyingStopped(){activeAction="",surveying={},surveyingPanel.classList.remove("active")}function animateFae(){fae.dz+=.2;for(var e=0;e<fae.particles.length;e++)fae.particles[e].alpha-=.1,fae.particles[e].alpha<=0&&fae.particles.splice(e,1);if(fae.particles.length<fae.maxParticles&&1==getRandomInteger(1,2)){var t=findIsoCoordsX(fae.x,fae.y),a=findIsoCoordsY(fae.x,fae.y)-fae.oscillateOffset,n=t+getRandomInteger(0,8)-4,i=a+getRandomInteger(0,8)-4;isInRange(t,a,n,i,6)&&fae.particles.push({depth:findIsoDepth(fae.x,fae.y,fae.z),isoX:n,isoY:i,alpha:1})}}function moveFae(){switch(fae.currentState){case"away":moveFaeToDestination(fae.targetX,fae.targetY);break;case"wait":isInRange(fae.x,fae.y,hero.x,hero.y,3*tileW)&&(fae.currentState="hero");break;default:fae.angleAroundHero+=4,moveFaeToDestination(hero.x+fae.radiusAroundHero*Math.cos(fae.angleAroundHero*(Math.PI/180)),hero.y+fae.radiusAroundHero*Math.sin(fae.angleAroundHero*(Math.PI/180)))}}function moveFaeToDestination(e,t){var a=getPythagorasDistance(fae.x,fae.y,e,t);if(a>fae.speed){var n=fae.speed/a;fae.x+=n*(e-fae.x),fae.y+=n*(t-fae.y)}else a<2?(fae.x=e,fae.y=t,"away"==fae.currentState&&(fae.currentState="wait")):(fae.x+=(e-fae.x)/2,fae.y+=(t-fae.y)/2);var i=hero.z;i>fae.z?fae.z+=.5:i<fae.z&&(fae.z-=.5)}function checkForGamePadInput(){Input.isUsingGamePad&&void 0!==Input.gamePad&&null!==Input.gamePad&&void 0!==Input.gamePad.timestamp&&Input.gamePad.timestamp!=Input.gameLastPadTimeStamp&&(Input.gameLastPadTimeStamp=Input.gamePad.timestamp,key[0]=Input.gamePad.axes[1]<=-.5,key[1]=Input.gamePad.axes[1]>=.5,key[2]=Input.gamePad.axes[2]<=-.5,key[3]=Input.gamePad.axes[2]>=.5,key[4]=Input.gamePad.buttons[2].value>0,key[5]=Input.gamePad.buttons[7].value>0)}function checkForRespawns(){for(var e=0;e<thisMapData.items.length;e++)"node"==currentActiveInventoryItems[thisMapData.items[e].type].action&&"active"!=thisMapData.items[e].state&&hero.totalGameTimePlayed-thisMapData.items[e].timeLastHarvested>=currentActiveInventoryItems[thisMapData.items[e].type].respawnRate&&(thisMapData.items[e].state="active")}function processGathering(){gathering.quantity-=gathering.depletionSpeed,gathering.stability-=gathering.stabilitySpeed,gathering.quality=capValues(gathering.quality,0,100),gathering.purity=capValues(gathering.purity,0,100),gathering.stability=capValues(gathering.stability,0,100),gathering.quantity=capValues(gathering.quantity,0,100),gathering.quality*gathering.purity*gathering.stability*gathering.quantity==0&&gatheringComplete(),UI.updateGatheringPanel()}function gatheringComplete(){if(0==gathering.stability)UI.showNotification("<p>Resource failed - nothing was gathered</p>"),gatheringPanel.classList.remove("active");else{var e=gathering.node.contains[0],t=Math.floor(gathering.purity/100*(gathering.node.maxQuantity-gathering.quantity)),a="Yielded: <ol><li>",n=e.type.toString().split("/"),i=e.colour.toString().split("/");a+="<div>",a+=generateCraftingSlotMarkup(activeGatheredObject={type:parseInt(getRandomElementFromArray(n)),quantity:t,quality:gathering.quality,durability:100,currentWear:0,effectiveness:100,colour:parseInt(getRandomElementFromArray(i)),enchanted:0,hallmark:0,inscription:""}),a+="</div></li></ol>",gatheringOutputSlot.innerHTML=a}gatheringStopped()}function gatheringStopped(){if(activeAction="",gathering.node.stability=gathering.stability,gathering.node.quantity=gathering.quantity,0!=gathering.node.quantity&&0!=gathering.node.stability||(gathering.node.stability=gathering.node.maxStability,gathering.node.timeLastHarvested=hero.totalGameTimePlayed,gathering.node.state="inactive"),gathering.node.isTemporary){for(var e=0;e<thisMapData.hiddenResources[currentActiveInventoryItems[gathering.node.type].category].length;e++)if(thisMapData.hiddenResources[currentActiveInventoryItems[gathering.node.type].category][e]===gathering.node){thisMapData.hiddenResources[currentActiveInventoryItems[gathering.node.type].category].splice(e,1);break}for(e=0;e<thisMapData.items.length;e++)if(thisMapData.items[e]===gathering.node){thisMapData.items.splice(e,1);break}}gathering={}}function findIsoCoordsX(e,t){return Math.floor((mapTilesY*tileW-t+e)/2)}function findIsoCoordsY(e,t){return Math.floor((e+t-2*tileH)/4)}function find2DCoordsX(e,t){return e+tileH+2*t-mapTilesY*tileW/2}function find2DCoordsY(e,t){return 2*t+tileH-e+mapTilesY*tileW/2}function findIsoDepth(e,t,a){return findIsoCoordsY(e,t)*tileW/2+2*a}function getTileCentreCoordX(e){return e*tileW+tileW/2}function getTileCentreCoordY(e){return e*tileW+tileW/2}function getTileIsoCentreCoordX(e,t){return tileW/2*(mapTilesY-t+e)}function getTileIsoCentreCoordY(e,t){return tileH/2*(t+e)}function getTileX(e){return Math.floor(e/tileW)}function getTileY(e){return Math.floor(e/tileW)}function getElevation(e,t){return thisMapData.elevation[t][e]}function getXOffsetFromHeight(e){return Math.sqrt(2)/2*e}function capValues(e,t,a){return e<t&&(e=t),e>a&&(e=a),e}function accessDynamicVariable(e){for(var t=e.split("."),a=window,n=0;n<t.length;n++)void 0!==a[t[n]]&&(a=a[t[n]]);return a}function getNearestParentId(e){for(;!e.id;)e=e.parentNode;return e}function getObjectKeysForInnerValue(e,t,a){var n=[];for(var i in e)e.hasOwnProperty(i)&&e[i][a]===t&&n.push(i);return n}function launchFullScreen(e){e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()}function exitFullScreen(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()}function debounce(e,t,a){var n;return function(){var i=this,o=arguments,r=a&&!n;clearTimeout(n),n=setTimeout(function(){n=null,a||e.apply(i,o)},t),r&&e.apply(i,o)}}function isAnObjectCollision(e,t,a,n,i,o,r,s){return e+a/2>i-r/2&&e-a/2<i+r/2&&t-n/2<o+s/2&&t+n/2>o-s/2}const facingsPossible=["n","e","s","w"];var relativeFacing={n:{x:0,y:-1},s:{x:0,y:1},e:{x:1,y:0},w:{x:-1,y:0}};function getRandomInteger(e,t){return Math.floor(Math.random()*(t-e))+e}function getRandomIntegerInclusive(e,t){return Math.floor(Math.random()*(t-e+1))+e}function rollDice(e,t){for(var a=0,n=0;n<e;n++)a+=getRandomIntegerInclusive(1,t);return a}function getRandomKeyFromObject(e){var t=Object.keys(e);return t[t.length*Math.random()<<0]}function isInRange(e,t,a,n,i){return getPythagorasDistance(e,t,a,n)<=i}function getPythagorasDistance(e,t,a,n){return Math.sqrt((e-a)*(e-a)+(t-n)*(t-n))}function turntoFace(e,t){var a=e.x-t.x,n=e.y-t.y;return Math.abs(a)>Math.abs(n)?a>0?"w":"e":n>0?"n":"s"}function turntoFaceTile(e,t,a){var n=e.x-getTileCentreCoordX(t),i=e.y-getTileCentreCoordY(a);return Math.abs(n)>Math.abs(i)?n>0?"w":"e":i>0?"n":"s"}function isFacing(e,t){var a=!1;switch(e.facing){case"n":e.y>t.y&&(a=!0);break;case"s":e.y<t.y&&(a=!0);break;case"w":e.x>t.x&&(a=!0);break;case"e":e.x<t.x&&(a=!0)}return a}function generateHash(e){var t,a,n=0;if(0===e.length)return n;for(t=0,a=e.length;t<a;t++)n=(n<<5)-n+e.charCodeAt(t),n|=0;return n}function parseMoney(e){var t="",a=e%100,n=Math.floor(e/1e4),i=Math.floor((e-1e4*n)/100);return n>0&&(t=n+'<span class="gold"></span>'),(i>0||n>0)&&(t+=i+'<span class="silver"></span>'),t+=a+'<span class="copper"></span>'}function hasLineOfSight(e,t,a,n){var i,o,r,s,c,l,d=e,h=t,u=[],g=[],p=n-t,m=a-e,f=0,v=!1;if(void 0!==thisMapData.innerDoors&&(v=!0),0!=thisMapData.collisions[t][e])return!1;if(v&&(l=currentMap+"-"+e+"-"+t,thisMapData.innerDoors.hasOwnProperty(l)&&!thisMapData.innerDoors[l].isOpen))return!1;if(c=p<0?-1:1,s=m<0?-1:1,p=Math.abs(2*p),o=e,r=t,(m=Math.abs(2*m))>p)for(i=2*p-m;d!=a;){if(i>=0&&(h+=c,i-=m),d+=s,i+=p,0!=thisMapData.collisions[h][d])return!1;if(v&&(l=currentMap+"-"+d+"-"+h,thisMapData.innerDoors.hasOwnProperty(l)&&!thisMapData.innerDoors[l].isOpen))return!1;u[f]=h-r,g[f]=d-o,r=h,o=d,f++}else for(i=2*m-p;h!=n;){if(i>=0&&(d+=s,i-=p),h+=c,i+=m,0!=thisMapData.collisions[h][d])return!1;if(v&&(l=currentMap+"-"+d+"-"+h,thisMapData.innerDoors.hasOwnProperty(l)&&!thisMapData.innerDoors[l].isOpen))return!1;u[f]=h-r,g[f]=d-o,r=h,o=d,f++}return!0}function determineWhichTransitionEvent(){var e,t=document.createElement("fakeelement"),a={transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"};for(e in a)if(void 0!==t.style[e])return a[e];t=null}function determineWhichAnimationEvent(){var e,t=document.createElement("fakeelement"),a={animation:"animationend",OAnimation:"oAnimationEnd",MozAnimation:"animationend",WebkitAnimation:"webkitAnimationEnd"};for(e in a)if(void 0!==t.style[e])return a[e];t=null}function uniqueValues(e){var t={};return e.filter(function(e){return!t.hasOwnProperty(e)&&(t[e]=!0)})}function sortByHighestValue(e,t){return e[0]<t[0]?1:e[0]>t[0]?-1:0}function sortByLowestValue(e,t){return e[0]<t[0]?-1:e[0]>t[0]?1:0}function getRandomElementFromArray(e){return e[Math.floor(Math.random()*e.length)]}function drawEllipse(e,t,a,n,i,o,r){var s=n/2*.5522848,c=i/2*.5522848,l=t+n,d=a+i,h=t+n/2,u=a+i/2;e.beginPath(),e.moveTo(t,u),e.bezierCurveTo(t,u-c,h-s,a,h,a),e.bezierCurveTo(h+s,a,l,u-c,l,u),e.bezierCurveTo(l,u+c,h+s,d,h,d),e.bezierCurveTo(h-s,d,t,u+c,t,u),e.closePath(),o?(e.fillStyle=r,e.fill()):(e.strokeStyle=r,e.stroke())}function drawCircle(e,t,a,n){gameContext.fillStyle=e,gameContext.beginPath(),gameContext.arc(t,a,n,0,2*Math.PI),gameContext.fill()}function drawIsoRectangle(e,t,a,n,i,o){var r=canvasWidth/2-hero.isox,s=canvasHeight/2-hero.isoy;gameContext.fillStyle=o,gameContext.beginPath(),gameContext.moveTo(findIsoCoordsX(e,t)+r,findIsoCoordsY(e,t)+s),gameContext.lineTo(findIsoCoordsX(a,t)+r,findIsoCoordsY(a,t)+s),gameContext.lineTo(findIsoCoordsX(a,n)+r,findIsoCoordsY(a,n)+s),gameContext.lineTo(findIsoCoordsX(e,n)+r,findIsoCoordsY(e,n)+s),gameContext.lineTo(findIsoCoordsX(e,t)+r,findIsoCoordsY(e,t)+s),gameContext.closePath(),i?(gameContext.fillStyle=o,gameContext.fill()):(gameContext.strokeStyle=o,gameContext.stroke())}!function(){for(var e=0,t=["ms","moz","webkit","o"],a=0;a<t.length&&!window.requestAnimationFrame;++a)window.requestAnimationFrame=window[t[a]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[a]+"CancelAnimationFrame"]||window[t[a]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,a){var n=(new Date).getTime(),i=Math.max(0,16-(n-e)),o=window.setTimeout(function(){t(n+i)},i);return e=n+i,o}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}();var getJSON=function(e,t,a){var n="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");n.open("get",e,!0),n.onreadystatechange=function(){var e,i;if(4==n.readyState){var o=!0;if(200==(e=n.status)){try{i=JSON.parse(n.responseText)}catch(t){o=!1,a&&a(e)}o&&t&&t(i)}else a&&a(e)}},n.send()},getJSONWithParams=function(e,t,a,n){var i="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");i.open("POST",e,!0),i.onreadystatechange=function(){var e,t;if(4==i.readyState){var o=!0;if(200==(e=i.status)){try{t=JSON.parse(i.responseText)}catch(t){o=!1,n&&n(e)}o&&a&&a(t)}else n&&n(e)}},i.setRequestHeader("Content-type","application/x-www-form-urlencoded"),i.send(t)};function sendDataWithoutNeedingAResponse(e){var t="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");t.open("get",e,!0),t.send()}function postData(e,t){var a="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");a.open("post",e,!0),a.setRequestHeader("Content-Type","application/x-www-form-urlencoded;"),a.send(t)}function pseudoRandomNumberGenerator(e){this._seed=e%2147483647,this._seed<=0&&(this._seed+=2147483646)}pseudoRandomNumberGenerator.prototype.next=function(){return this._seed=16807*this._seed%2147483647},pseudoRandomNumberGenerator.prototype.nextFloat=function(e,t){return(this.next()-1)/2147483646},window.Loader=function(){var e=0,t=!1,a=0,n={};function i(){e=0,t=!1,a=0,n={}}function o(){}function r(){}function s(e){console.log("Error on loading the image: "+e.srcElement)}function c(i,c){try{n[i]=new Image,n[i].onload=function(){++e,o(l()),e==a&&(t=!1,r())},n[i].onerror=s,n[i].src=c}catch(e){console.log(e.message)}}function l(){return e/a*100}return{preload:function(e,n,s){if(i(),!t){t=!0;try{a=e.length,o=s||function(){},r=n||function(){};for(var l=0;l<e.length;++l)c(e[l].name,e[l].src)}catch(e){console.log(e.message)}}},getProgress:l,getImage:function(e){return n[e]?n[e]:void 0},reset:i,images:n}}();var allCardPacks=[[1,1,1,1,1,1,1,1,3,3,3,3,3,3,3,3,3],[1,1,1,1,1,1,2,2,2,2,2,3,3,3,3,3,3]];function cardGamePlayer2Wins(){hero.stats.cardGamesWon++,hero.currency.cardDust+=7,UI.updateCurrencies(),delete thisChallengeNPC.isPlayingCards,processPlayerWinSpeech(thisChallengeNPC,thisChallengeNPC.cardGameSpeech.lose[0],thisChallengeNPC.cardGameSpeech.lose[1]),closeCardGame()}function cardGamePlayer1Wins(){console.log(thisChallengeNPC),hero.stats.cardGamesLost++,hero.currency.cardDust+=1,UI.updateCurrencies(),delete thisChallengeNPC.isPlayingCards,processSpeech(thisChallengeNPC,thisChallengeNPC.cardGameSpeech.win[0],thisChallengeNPC.cardGameSpeech.win[1]),closeCardGame()}function cardGameIsDrawn(){console.log(thisChallengeNPC),hero.stats.cardGamesDrawn++,hero.currency.cardDust+=3,UI.updateCurrencies(),delete thisChallengeNPC.isPlayingCards,processSpeech(thisChallengeNPC,thisChallengeNPC.cardGameSpeech.draw[0],thisChallengeNPC.cardGameSpeech.draw[1]),closeCardGame()}function processPlayerWinSpeech(e,t,a){if(""!=a){var n=a.split("|"),i=n[1];questData[i].hasBeenCompleted<1?giveQuestRewards(i)&&(questData[i].isRepeatable>0?questData[i].hasBeenCompleted=0:questData[i].hasBeenCompleted=1,UI.showDialogue(e,e.cardGameSpeech.lose[0]+n[2]),canCloseDialogueBalloonNextClick=!0,checkForTitlesAwarded(i)):processSpeech(e,e.cardGameSpeech.lose[0],e.cardGameSpeech.lose[1])}else processSpeech(e,e.cardGameSpeech.lose[0],e.cardGameSpeech.lose[1])}function startCardGame(e){hero.cards.length>=12?(cardGameNameSpace.player2Cards=hero.cards.slice(0,12),cardGameNameSpace.player1Cards=e.uniqueCards.concat(allCardPacks[e.baseCardPack]).slice(0,12),cardGameNameSpace.player1Skill=e.cardSkill,e.cardBackColour?cardGameNameSpace.NPCCardBackColour=e.cardBackColour:cardGameNameSpace.NPCCardBackColour=void 0,cardGameNameSpace.initialiseCardGame(),cardGameWrapper.classList.add("active"),e.isPlayingCards=!0):UI.showNotification("<p>You don't have enough cards</p>")}function closeCardGame(){gameMode="play",cardGameWrapper.classList.remove("active"),document.getElementById("cardGame").removeEventListener("click",cardGameNameSpace.canvasClick,!1)}function pickBestCardToTake(e){for(var t,a=-1,n=0,i=0;i<e.length;i++)(t=cardGameNameSpace.allCardData[e[i]][0]*cardGameNameSpace.allCardData[e[i]][0]+cardGameNameSpace.allCardData[e[i]][1]*cardGameNameSpace.allCardData[e[i]][1])>a&&(a=t,n=i);return n}function openBoosterPack(){var e;boosterCardsToAdd=[];do{e=getRandomInteger(1,cardGameNameSpace.allCardData.length),-1==boosterCardsToAdd.indexOf(e)&&boosterCardsToAdd.push(e)}while(boosterCardsToAdd.length<5);for(var t,a=document.getElementsByClassName("cardFlip"),n=0;n<a.length;n++)a[n].classList.remove("active");for(n=0;n<5;n++)t="",-1==hero.cards.indexOf(boosterCardsToAdd[n])&&(t=' class="new"'),boosterCardsToAdd[n]<0?document.getElementById("boosterCard"+n).innerHTML='<div class="rare"><div class="card players" style="background-image:url(/images/card-game/cards/'+boosterCardsToAdd[n]+'.png)"></div></div>':document.getElementById("boosterCard"+n).innerHTML="<img"+t+' src="/images/card-game/cards/'+boosterCardsToAdd[n]+'.png" alt="'+cardGameNameSpace.allCardData[boosterCardsToAdd[n][3]]+'">';boosterPack.classList.add("active"),boosterCardsRevealed=0,boosterPack.addEventListener("click",revealBoosterCard,!1)}function revealBoosterCard(e){"IMG"==e.target.nodeName&&(e.target.parentNode.parentNode.parentNode.classList.add("active"),++boosterCardsRevealed>=5&&(hero.cards=boosterCardsToAdd.concat(hero.cards),UI.updateCardAlbum(),boosterPack.classList.remove("active")))}const Input={isUsingGamePad:!1,gamePad:null,gameLastPadTimeStamp:null,init:function(){document.addEventListener("keydown",function(e){Input.changeKey(e,1,"down")}),document.addEventListener("keyup",function(e){Input.changeKey(e,0,"up")}),(navigator.getGamepads||navigator.getGamepads())&&(window.addEventListener("gamepadconnected",function(){Input.isUsingGamePad=!0,Input.gamePad=navigator.getGamepads()[0]}),window.addEventListener("gamepaddisconnected",function(e){Input.isUsingGamePad=!1,Input.gamePad=null}))},changeKey:function(e,t,a){var n=document.activeElement.tagName;if("INPUT"!=n&&"TEXTAREA"!=n&&"SELECT"!=n)switch(e.keyCode){case KeyBindings.left:e.preventDefault(),key[0]=t;break;case KeyBindings.up:e.preventDefault(),key[2]=t;break;case KeyBindings.right:e.preventDefault(),key[1]=t;break;case KeyBindings.down:e.preventDefault(),key[3]=t;break;case KeyBindings.action:key[4]=0,"up"===a&&(key[4]=1);break;case KeyBindings.shift:key[5]=t;break;case KeyBindings.challenge:key[6]=t;break;case KeyBindings.toggleUI:key[7]=t;break;case KeyBindings.toggleJournal:key[8]=t}}};function canAddItemToInventory(e){for(var t,a=JSON.parse(JSON.stringify(hero.inventory)),n=[],i=!0,o=0,r=[],s=[],c=0;c<e.length;c++)switch(e[c].type){case"$":o+=e[c].quantity;break;case"follower":r.push([e[c].id,e[c].name]);break;case"profession":s.push(e[c].id);break;default:var l=0,d=getObjectKeysForInnerValue(a,e[c].type,"type");if(d.length>0)for(var h=0;h<d.length;h++)if(!document.getElementById("slot"+d[h]).classList.contains("locked")&&itemAttributesMatch(a[d[h]],e[c])){var u=a[d[h]].quantity;if(l+=m=maxNumberOfItemsPerSlot-u>e[c].quantity-l?e[c].quantity-l:maxNumberOfItemsPerSlot-u,m>0&&(n.push(d[h]),a[d[h]].quantity+=m),l>=e[c].quantity)break}if(l<e[c].quantity)e:for(h=0;h<hero.bags.length;h++)for(var g=currentActiveInventoryItems[hero.bags[h].type].actionValue,p=0;p<g;p++){var m,f=h+"-"+p;if(!(f in a))if(l+=m=maxNumberOfItemsPerSlot>e[c].quantity-l?e[c].quantity-l:maxNumberOfItemsPerSlot,n.push(f),a[f]=new Object,a[f].type=e[c].type,a[f].quantity=m,a[f].quality=e[c].quality,a[f].durability=e[c].durability,a[f].currentWear=e[c].currentWear,a[f].effectiveness=e[c].effectiveness,a[f].wrapped=e[c].wrapped,a[f].colour=e[c].colour,a[f].enchanted=e[c].enchanted,a[f].hallmark=e[c].hallmark,a[f].inscription={},a[f].inscription.title=e[c].inscription.title,a[f].inscription.content=e[c].inscription.content,a[f].inscription.timeCreated=e[c].inscription.timeCreated,l>=e[c].quantity)break e}l!=e[c].quantity&&(i=!1)}if(i){if(hero.inventory=JSON.parse(JSON.stringify(a)),UI.updatePanelsAfterInventoryChange(),o>0&&(hero.currency.money+=o,UI.updateCurrencies(),audio.playSound(soundEffects.coins,0)),r.length>0)for(h=0;h<r.length;h++)UI.showNewFollower(r[h][0],r[h][1]),sendDataWithoutNeedingAResponse("/game-world/activateRetinueFollower.php?followerID="+r[h][0]),t='<li id="retinueFollower'+r[h][0]+'" class="available" data-locationx="200" data-locationy="350" data-activeonquest="-1"><div class="portrait"><img src="/images/retinue/'+r[h][0]+'.png" alt=""></div><h3>'+r[h][1]+"</h3><p>waiting for a quest</p></li>",retinueList.insertAdjacentHTML("beforeend",t);if(s.length>0)for(h=0;h<s.length;h++)-1==hero.professionsKnown.indexOf(s[h])&&(hero.professionsKnown.push(s[h]),UI.showNewProfession(s[h]));return[!0,n]}return[!1]}function hasItemsInInventory(e){for(var t,a,n=!0,i=0;i<e.length;i++){void 0===e[i].quantity&&(e[i].quantity=1),t=0;var o=getObjectKeysForInnerValue(hero.inventory,e[i].type,"type");if(o.length>0)for(var r=0;r<o.length;r++){for(var s in a=!0,e[i])switch(s){case"quantity":break;case"durability":case"quality":case"effectiveness":hero.inventory[o[r]][s]<e[i][s]&&(a=!1);break;default:hero.inventory[o[r]][s]!=e[i][s]&&(a=!1)}a&&(t+=hero.inventory[o[r]].quantity)}t<e[i].quantity&&(n=!1)}return n}function findSlotItemIdInInventory(e){var t=[];for(var a in hero.inventory)hero.inventory[a].type==e&&t.push(a);return t}function hasItemTypeInInventory(e){var t=[];for(var a in hero.inventory)currentActiveInventoryItems[hero.inventory[a].type].group==e&&t.push(a);return t}function removeItemTypeFromInventory(e,t){if(void 0===t)t=1;var a,n=t,i=getObjectKeysForInnerValue(hero.inventory,parseInt(e),"type");if(i.length>0)for(var o=0;o<i.length;o++)(a=hero.inventory[i[o]].quantity)>n?(removeFromInventory(i[o],n),n=0):(removeFromInventory(i[o],a),n-=a)}function addToInventory(e,t){hero.inventory[e]=JSON.parse(JSON.stringify(t)),document.getElementById("slot"+e).innerHTML=generateSlotMarkup(e)}function removeFromInventory(e,t){var a=hero.inventory[e].quantity,n=document.getElementById("slot"+e);a-t>0?(hero.inventory[e].quantity-=t,updateQuantity(e)):(delete hero.inventory[e],n.innerHTML="")}function updateQuantity(e){for(var t=document.getElementById("slot"+e),a=0;a<t.childNodes.length;a++)"qty"==t.childNodes[a].className&&(t.childNodes[a].innerHTML=hero.inventory[e].quantity),"P"==t.childNodes[a].nodeName&&(t.childNodes[a].childNodes[2].innerHTML="Sell price: "+parseMoney(Math.ceil(hero.inventory[e].quantity*sellPriceModifier*inflationModifier*currentActiveInventoryItems[hero.inventory[e].type].priceCode,0)))}function itemAttributesMatch(e,t){return e.type==t.type&&e.quality==t.quality&&e.durability==t.durability&&e.currentWear==t.currentWear&&e.effectiveness==t.effectiveness&&e.colour==t.colour&&e.enchanted==t.enchanted&&e.hallmark==t.hallmark&&e.inscription.title==t.inscription.title&&e.inscription.content==t.inscription.content&&e.inscription.timeCreated==t.inscription.timeCreated&&e.contains==t.contains}function inventoryItemAction(e,t,a){var n,i=e.parentElement.id.substring(4),o=!0;if(void 0!==hero.inventory[i].cooldown&&hero.inventory[i].cooldownTimer>0&&(o=!1),hero.inventory[i].currentWear>=hero.inventory[i].durability&&(o=!1,UI.showNotification("<p>Item needs repairing</p>")),o){for(var r=t.split(","),s=a.split(","),c=0;c<r.length;c++)switch(n=s[c],r[c]){case"container":if(void 0!==hero.inventory[i].contains)if(1==hero.inventory[i].contains.length&&1==hero.inventory[i].quantity)hero.inventory[i]=JSON.parse(JSON.stringify(hero.inventory[i].contains[0])),document.getElementById("slot"+i).innerHTML=generateSlotMarkup(i),UI.showChangeInInventory([i]);else{var l=JSON.parse(JSON.stringify(hero.inventory[i]));removeFromInventory(i,1);var d=canAddItemToInventory(l.contains);d[0]?(document.getElementById("slot"+i).innerHTML=generateSlotMarkup(i),UI.showChangeInInventory(d[1])):(hero.inventory[i]=JSON.parse(JSON.stringify(l)),UI.showNotification("<p>You don't have room for all of these items.</p>"))}break;case"booster":openBoosterPack(),removeFromInventory(i,1);break;case"bag":UI.addNewBag(hero.inventory[i]),audio.playSound(soundEffects.bagOpen,0),removeFromInventory(i,1);break;case"home":var h=hero.inventory[i].additional.split("|");jumpToLocation(h[0],h[1],h[2]);break;case"inscribe":UI.openInscriptionPanel();break;case"collection":if(hero.collections.hasOwnProperty(n)){var u=hero.collections[n].required.indexOf(hero.inventory[i].type);-1!=u&&(hero.collections[n].required[u]>0?(hero.collections[n].required[u]=0-hero.collections[n].required[u],document.getElementById(n+"-"+hero.inventory[i].type).classList.remove("notCollected"),removeFromInventory(i,1)):UI.showNotification("<p>Already added to a collection</p>"))}break;case"card":hero.cards.unshift(n),UI.updateCardAlbum(),removeFromInventory(i,1);break;case"questSet":questData[n].isUnderway||(questData[n].isUnderway=!0,addToJournal(n));break;case"book":document.getElementById("book"+n).classList.add("active"),audio.playSound(soundEffects.bookOpen,0);case"recipe":canLearnRecipe(n)&&removeFromInventory(i,1);break;case"craft":-1!=hero.professionsKnown.indexOf(parseInt(n))?(audio.playSound(soundEffects.buttonClick,0),UI.populateRecipeList(n,hero.inventory[i].quality)):UI.showNotification("<p>You don't know this profession yet.</p>");break;case"deed":var g=n.split("x");plotPlacement.width=g[0],plotPlacement.length=g[1],activeAction="plotPlacement",document.addEventListener("mousemove",UI.movePlotPlacementOverlay,!1)}void 0!==hero.inventory[i].cooldown&&(hero.inventory[i].cooldownTimer=hero.inventory[i].cooldown)}}function additionalTooltipDetail(e){var t="";switch(currentActiveInventoryItems[e.type].action){case"recipe":for(var a=!1,n=0;n<hero.recipesKnown.length;n++)hero.recipesKnown[n]==currentActiveInventoryItems[e.type].actionValue&&(a=!0);a&&(t+=" (already known)");break;case"collection":a=!1;var i=currentActiveInventoryItems[e.type].actionValue;if(hero.collections.hasOwnProperty(i)){var o=hero.collections[i].required.indexOf(e.type);-1!=o?hero.collections[i].required[o]>0&&(t+=" (needed for an active collection - double click to add)"):t+=" (already added to a collection)"}}return t}function generateGenericSlotMarkup(e){var t="",a="",n="",i="",o=getColourName(e.colour,e.type);""!=o&&(a=o+" ",n="-"+o.toLowerCase());var r=currentActiveInventoryItems[e.type].action,s=!1;r&&-1!=r.indexOf("book")&&e.inscription.content&&(s=!0);var c="";if(r)if(s){var l=generateHash(e.inscription.title+e.colour+e.type+e.inscription.timeCreated);c='data-action="'+r+'" data-action-value="'+(-1==r.indexOf(",")?l:currentActiveInventoryItems[e.type].actionValue.replace("?",l))+'" ',UI.buildBook(e,l)}else c='data-action="'+r+'" data-action-value="'+currentActiveInventoryItems[e.type].actionValue+'" ';for(var d=currentActiveInventoryItems[e.type].category.split(","),h=0;h<d.length;h++)i+="itemCategory"+d[h]+" ";if("card"==currentActiveInventoryItems[e.type].action&&(i+="players card"),t+='<img src="/images/game-world/inventory-items/'+e.type+n+'.png" '+c+'alt="'+a+currentActiveInventoryItems[e.type].shortname+'" class="'+i+'">',s)var u="&quot;"+e.inscription.title+"&quot;";else u=currentActiveInventoryItems[e.type].description;if(-1!=u.indexOf("##contains##")&&void 0!==e.contains){var g="";for(h=0;h<e.contains.length;h++)0!=h&&(g+=", "),g+=e.contains[h].quantity+"x "+currentActiveInventoryItems[e.contains[h].type].shortname;u=u.replace("##contains##","Contains: "+g)}return t+="<p><em>"+a+currentActiveInventoryItems[e.type].shortname+" </em>"+u+" ",t+='<span class="price">Sell price: '+parseMoney(Math.ceil(e.quantity*sellPriceModifier*inflationModifier*currentActiveInventoryItems[e.type].priceCode,0))+"</span>",t+='<span class="price specialismPrice">Sell price: '+parseMoney(Math.ceil(e.quantity*sellPriceSpecialismModifier*inflationModifier*currentActiveInventoryItems[e.type].priceCode,0))+"</span>",t+=additionalTooltipDetail(e)+"</p>",t+='<span class="qty">'+e.quantity+"</span>"}function generateSlotMarkup(e){return generateGenericSlotMarkup(hero.inventory[e])+'<div class="coolDown"></div><div class="lockedOverlay" id="lockedOverlay'+e+'"></div>'}function inventorySplitStackSubmit(e){e&&e.preventDefault();var t=splitStackInput.value,a=!0;if((t=parseInt(t))<1&&(a=!1),Number.isInteger(t)||(a=!1),t>hero.inventory[UI.sourceSlot].quantity&&(a=!1),a){isSplitStackBeingDragged=!0;var n=document.getElementById("slot"+UI.sourceSlot);UI.activeDragObject=document.getElementById("draggableInventorySlot"),UI.activeDragObject.innerHTML=n.innerHTML,removeFromInventory(UI.sourceSlot,t),UI.draggedInventoryObject.quantity=t;for(var i=0;i<UI.activeDragObject.childNodes.length;i++)if("qty"==UI.activeDragObject.childNodes[i].className){UI.activeDragObject.childNodes[i].innerHTML=UI.draggedInventoryObject.quantity;break}UI.inDrag=!0;var o=n.getBoundingClientRect(),r=(window.pageYOffset||document.documentElement.scrollTop)-(document.documentElement.clientTop||0);objInitLeft=o.left+3,objInitTop=o.top+3+r,dragStartX=objInitLeft+22,dragStartY=objInitTop+22,UI.activeDragObject.style.cssText="z-index:4;top: "+objInitTop+"px; left: "+objInitLeft+"px; transform: translate(0px, 0px);",document.addEventListener("mousemove",UI.handleDrag,!1),document.addEventListener("mouseup",UI.endInventoryDrag,!1)}splitStackPanel.classList.remove("active"),document.activeElement.blur()}function inventorySplitStackCancel(){splitStackPanel.classList.remove("active"),document.activeElement.blur()}function prepareInventoryObject(e){var t={type:"$",quantity:1,quality:100,durability:100,currentWear:0,effectiveness:100,colour:0,enchanted:0,hallmark:0,inscription:""};for(var a in e)t[a]=e[a];return t}var KeyBindings={left:65,right:68,up:87,down:83,pause:80,action:17,shift:16,challenge:67,toggleUI:9,toggleJournal:81};if(window.Worker){var lightMapWorker=new Worker("/js/worker-lightmap.js");lightMapWorker.onmessage=function(e){lightMap=e.data}}function updateLightMap(){lightMapWorker.postMessage([thisMapData,hero.tileX,hero.tileY,hero.lineOfSightRange,lightMap])}if(window.Worker){var pathfindingWorker=new Worker("/js/worker-pathfinding.js");pathfindingWorker.onmessage=function(e){var t=e.data[0];if("pet"==t){var a=hero.allPets[hero.activePets[e.data[1]]];a.foundPath=e.data[2],"-,pathEnd"==a.foundPath.join()?(a.state="waiting",a.foundPath=""):(a.pathIndex=1,a.state="moving",a.facing=e.data[2][0])}else{var n=thisMapData.npcs.map(function(e){return e.name}).indexOf(t);thisMapData.npcs[n].movement.splice.apply(thisMapData.npcs[n].movement,[thisMapData.npcs[n].movementIndex+2,0].concat(e.data[1])),thisMapData.npcs[n].waitingForAPath=!1,void 0!==e.data[2]&&(thisMapData.npcs[n].lastTargetDestination=e.data[2])}}}function isAPetTerrainCollision(e,t,a){var n=getTileX(t),i=getTileY(a);if(n<0||i<0||n>=mapTilesX||i>=mapTilesY)return 1;switch(thisMapData.collisions[i][n]){case 1:return 1;case"<":case">":case"^":case"v":return 0;case"d":return""!=mapTransition&&(e.state="door"),0;default:return 0}}function movePet(){if(hasActivePet)for(var e,t,a,n,i,o,r,s,c,l=0;l<hero.activePets.length;l++){switch(a=(r=hero.allPets[hero.activePets[l]]).following,s=!1,r.state){case"door":switch(r.facing){case"n":r.y-=r.speed;break;case"s":r.y+=r.speed;break;case"w":r.x-=r.speed;break;case"e":r.x+=r.speed}break;case"moving":switch(i=r.x,o=r.y,r.drawnFacing=r.facing,r.facing){case"n":if(r.y-=r.speed,isAPetTerrainCollision(r,r.x-r.width/2,r.y-r.length/2)||isAPetTerrainCollision(r,r.x+r.width/2,r.y-r.length/2)){var d=(getTileY(r.y-r.length/2)+1)*tileW;r.y=d+r.heilengthght/2+1}break;case"s":if(r.y+=r.speed,isAPetTerrainCollision(r,r.x-r.width/2,r.y+r.length/2)||isAPetTerrainCollision(r,r.x+r.width/2,r.y+r.length/2)){var h=getTileY(r.y+r.length/2)*tileW;r.y=h-r.length/2-1}break;case"w":if(r.x-=r.speed,isAPetTerrainCollision(r,r.x-r.width/2,r.y+r.length/2)||isAPetTerrainCollision(r,r.x-r.width/2,r.y-r.length/2)){var u=(getTileX(r.x-r.width/2)+1)*tileW;r.x=u+r.width/2+1}break;case"e":if(r.x+=r.speed,isAPetTerrainCollision(r,r.x+r.width/2,r.y+r.length/2)||isAPetTerrainCollision(r,r.x+r.width/2,r.y-r.length/2)){var g=getTileX(r.x+r.width/2)*tileW;r.x=g-r.width/2-1}}for(var p=0;p<thisMapData.npcs.length;p++)(e=thisMapData.npcs[p]).isCollidable&&isAnObjectCollision(r.x,r.y,r.width,r.length,e.x,e.y,e.width,e.length)&&(r.x=i,r.y=o);for(p=0;p<hero.activePets.length;p++)l!=p&&(n=hero.allPets[hero.activePets[p]],isAnObjectCollision(r.x,r.y,r.width,r.length,n.x,n.y,n.width,n.length)&&(r.x=i,r.y=o,n.state="moving",n.facing=r.facing));if(void 0!==thisMapData.innerDoors)for(var m in thisMapData.innerDoors)(c=thisMapData.innerDoors[m]).isOpen||isAnObjectCollision(getTileCentreCoordX(c.tileX),getTileCentreCoordY(c.tileY),tileW,tileW,r.x,r.y,r.width,r.length)&&(r.x=i,r.y=o);for(p=0;p<thisMapData.items.length;p++)t=thisMapData.items[p],isAnObjectCollision(r.x,r.y,r.width,r.length,t.x,t.y,t.width,t.length)&&(r.x=i,r.y=o);r.dx+=r.x-i,r.dy+=r.y-o,Math.abs(r.dx)>=tileW&&(r.dx>0?r.dx-=tileW:r.dx+=tileW,s=!0),Math.abs(r.dy)>=tileW&&(r.dy>0?r.dy-=tileW:r.dy+=tileW,s=!0);break;case"findingPath":break;case"queuing":if(!isInRange(a.x,a.y,r.x,r.y,2*tileW)){switch(i=r.x,o=r.y,r.drawnFacing=r.facing,r.facing){case"n":r.y-=r.speed;break;case"s":r.y+=r.speed;break;case"w":r.x-=r.speed;break;case"e":r.x+=r.speed}for(p=0;p<thisMapData.npcs.length;p++)(e=thisMapData.npcs[p]).isCollidable&&isAnObjectCollision(r.x,r.y,r.width,r.length,e.x,e.y,e.width,e.length)&&(r.x=i,r.y=o);for(p=0;p<hero.activePets.length;p++)l!=p&&(n=hero.allPets[hero.activePets[p]],isAnObjectCollision(r.x,r.y,r.width,r.length,n.x,n.y,n.width,n.length)&&(r.x=i,r.y=o));for(p=0;p<thisMapData.items.length;p++)t=thisMapData.items[p],isAnObjectCollision(r.x,r.y,r.width,r.length,t.x,t.y,t.width,t.length)&&(r.x=i,r.y=o);r.dx+=r.x-i,r.dy+=r.y-o,Math.abs(r.dx)>=tileW&&(r.dx>0?r.dx-=tileW:r.dx+=tileW,s=!0),Math.abs(r.dy)>=tileW&&(r.dy>0?r.dy-=tileW:r.dy+=tileW,s=!0),s&&(r.tileX=getTileX(r.x),r.tileY=getTileY(r.y),(r.tileX<0||r.tileY<0||r.tileX>=mapTilesX||r.tileY>=mapTilesY)&&(s=!1))}break;default:isInRange(a.x,a.y,r.x,r.y,2*tileW)||(r.state="moving")}if(s)if(r.tileX=getTileX(r.x),r.tileY=getTileY(r.y),r.breadcrumb.pop(),r.breadcrumb.unshift([r.tileX,r.tileY]),isInRange(a.x,a.y,r.x,r.y,2*tileW))r.state="wait";else{var f=!1;for(m=0;m<a.breadcrumb.length;m++)if(r.tileY==a.breadcrumb[m][1]){if(r.tileX-1==a.breadcrumb[m][0]){r.facing="w",f=!0;break}if(r.tileX+1==a.breadcrumb[m][0]){r.facing="e",f=!0;break}}else if(r.tileX==a.breadcrumb[m][0]){if(r.tileY+1==a.breadcrumb[m][1]){r.facing="s",f=!0;break}if(r.tileY-1==a.breadcrumb[m][1]){r.facing="n",f=!0;break}}f?(r.state="moving",r.foundPath=""):""!=r.foundPath?(r.facing=r.foundPath[r.pathIndex],r.pathIndex++,r.pathIndex>=r.foundPath.length&&(pathfindingWorker.postMessage(["petToHero",hero.allPets[hero.activePets[l]],thisMapData,a.tileX,a.tileY,l]),r.state="findingPath",r.foundPath="")):"findingPath"!=r.state&&(pathfindingWorker.postMessage(["petToHero",hero.allPets[hero.activePets[l]],thisMapData,a.tileX,a.tileY,l]),r.state="findingPath")}}}function isPetBlocked(e,t){var a=!1;switch(t){case"n":isAPetTerrainCollision(e,getTileCentreCoordX(e.tileX),getTileCentreCoordY(e.tileY-1))&&(a=!0);break;case"s":isAPetTerrainCollision(e,getTileCentreCoordX(e.tileX),getTileCentreCoordY(e.tileY+1))&&(a=!0);break;case"e":isAPetTerrainCollision(e,getTileCentreCoordX(e.tileX+1),getTileCentreCoordY(e.tileY))&&(a=!0);break;case"w":isAPetTerrainCollision(e,getTileCentreCoordX(e.tileX-1),getTileCentreCoordY(e.tileY))&&(a=!0)}return a}function pushPetAway(e){var t=hero.allPets[hero.activePets[e]];if(isPetBlocked(t,hero.facing)){var a=[];switch(hero.facing){case"n":case"s":a=["e","w"];break;case"w":case"e":a=["n","s"]}isPetBlocked(t,a[0])?isPetBlocked(t,a[1])?t.state="wait":(t.state="moving",t.facing=a[1]):(t.state="moving",t.facing=a[0])}else t.state="moving",t.facing=hero.facing}var possiblePlantBreedingResults=[10,12,16,20,34],plantBreeding={"1-2":0,"1-3":0,"2-3":0,"2-4":0,"2-5":0};const plantBreedingPRNG=new pseudoRandomNumberGenerator(characterId);possiblePlantBreedingResults.sort(function(e,t){return plantBreedingPRNG.nextFloat()<.5?-1:1});var counter=0;for(var i in plantBreeding)plantBreeding[i]=possiblePlantBreedingResults[counter],counter++;function addToJournal(e){getJSON("/game-world/getQuestJournalEntries.php?chr="+characterId+"&questID="+e,function(e){UI.addToQuestJournal(e)},function(t){addToJournal(e)})}function removeFromJournal(e){var t=document.getElementById("quest"+e);t&&t.remove()}function declineQuest(){acceptQuestChoice.classList.remove("active"),processSpeech(questResponseNPC,questResponseNPC.speech[questResponseNPC.speechIndex][4],questResponseNPC.speech[questResponseNPC.speechIndex][5],!1),canCloseDialogueBalloonNextClick=!0,questResponseNPC=null}function acceptQuest(){acceptQuestChoice.classList.remove("active"),processSpeech(questResponseNPC,questResponseNPC.speech[questResponseNPC.speechIndex][6],questResponseNPC.speech[questResponseNPC.speechIndex][7],!1),openQuest(questResponseNPC.speech[questResponseNPC.speechIndex][2]),canCloseDialogueBalloonNextClick=!0,questResponseNPC=null}function openQuest(e){var t=!0;if(questData[e].startItemsReceived){for(var a=questData[e].startItemsReceived,n=[],i=0;i<a.length;i++){var o=prepareInventoryObject(a[i]);n.push(o)}(inventoryCheck=canAddItemToInventory(n))[0]?UI.showChangeInInventory(inventoryCheck[1]):t=!1}if(t){switch(questData[e].whatIsRequiredForCompletion){case"possess":case"give":case"":break;case"multi":for(var r=questData[e].subQuestsRequiredForCompletion.split(","),s=0;s<r.length;s++){switch(questData[r[s]].whatIsRequiredForCompletion){case"possess":case"give":case"":case"world":break;default:questData[r[s]].valueAtQuestStart=accessDynamicVariable(questData[r[s]].whatIsRequiredForCompletion)}questData[r[s]].isUnderway=!0}break;case"world":break;default:questData[e].valueAtQuestStart=accessDynamicVariable(questData[e].whatIsRequiredForCompletion)}questData[e].isUnderway=!0,addToJournal(e)}}function checkForEscortQuestEnd(e){var t=e.speech[e.speechIndex][3].split("|");if(t[0]==currentMap){var a=getTileCentreCoordX(t[1]),n=getTileCentreCoordY(t[2]);if(isInRange(e.x,e.y,a,n,t[3]*tileW)){e.drawnFacing=turntoFace(e,hero);for(var i=0;i<hero.npcsFollowing.length;i++)if(hero.npcsFollowing[i]===e){hero.npcsFollowing.splice(i,1);break}fae.targetX=e.x,fae.targetY=e.y,fae.currentState="away",e.isMoving=!1,e.movementIndex--,e.forceNewMovementCheck=!1,e.hasCompletedEscortQuest=!0,delete e.following}}}function closeQuest(e,t){giveQuestRewards(e,t),questData[t].isRepeatable>0?(questData[t].hasBeenCompleted=!1,questData[t].isUnderway=!1):(questData[t].hasBeenCompleted=!0,e.speech.splice(e.speechIndex,1),e.speechIndex--),checkForTitlesAwarded(t),audio.playSound(soundEffects.questComplete,0),removeFromJournal(t)}function giveQuestRewards(e,t){questData[t].itemsReceivedOnCompletion&&awardQuestRewards(e,questData[t].itemsReceivedOnCompletion,!1)}function awardQuestRewards(e,t,a){for(var n=[],i=0;i<t.length;i++){var o=t[i],r=prepareInventoryObject(o),s=o.type.toString().split("/");r.type=getRandomElementFromArray(s),isNaN(r.type)||(thisSpeech=thisSpeech.replace(/##itemName##/i,currentActiveInventoryItems[parseInt(r.type)].shortname)),n.push(r)}if((inventoryCheck=canAddItemToInventory(n))[0])UI.showChangeInInventory(inventoryCheck[1]);else{var c=e.speech[e.speechIndex][0].split("|");if(a)var l=e.speech[e.speechIndex][2].replace(/-/g," ")+" collection";else{var d=e.speech[e.speechIndex][2];l=questData[d].journalTitle}var h=c[2];sendNPCPost('{"subject":"'+l+'","message":"'+(h=h.replace(/##itemName##/i,currentActiveInventoryItems[parseInt(n[0].type)].shortname))+'","senderID":"-1","recipientID":"'+characterId+'","fromName":"'+e.name+'"}',n),UI.showNotification("<p>Reward send by post to you</p>")}}function getRetinueQuestTime(e,t,a,n,i){var o=getPythagorasDistance(e,t,a,n);1==i&&(o+=getPythagorasDistance(retinueBaseLocationX,retinueBaseLocationY,a,n));var r=Math.floor(60*o%60),s=Math.floor(o%60),c=Math.floor(o/60%24),l=Math.floor(o/1440);return[o,l>1?l+" days":1==l?"1 day":c>1?c+" hours":1==c?"1 hour":s>1?s+" minutes":1==s?"1 minute":r+" seconds"]}function retinueMissionCompleted(e,t){getJSON("/game-world/getRetinueRewards.php?id="+e+"&chr="+characterId,function(a){if("null"!=a.item)if((inventoryCheck=canAddItemToInventory(a.item))[0])UI.showChangeInInventory(inventoryCheck[1]);else{sendNPCPost('{"subject":"'+("Reward for "+document.getElementById("retinueComplete"+e).getAttribute("data-questname"))+'","message":"Your followers continue to make you proud...","senderID":"-1","recipientID":"'+characterId+'","fromName":"Retinue co-ordinator"}',a.item),UI.showNotification("<p>Reward sent by post to you</p>")}if(t){hero.stats.retinueExplorationMissionsCompleted++;var n=document.getElementById("undiscovered_"+a.explored);hero.retinueMapAreasRevealed.push(a.explored);var i,o=a.explored.split("_");sendDataWithoutNeedingAResponse("/game-world/updateGameState.php?chr="+characterId+"&action=add&field=retinueMapAreasRevealed&value="+encodeURIComponent('"'+o[0]+","+o[1]+'"'));for(var r=-1;r<=1;r++)for(var s=-1;s<=1;s++)(i=document.getElementById("undiscovered_"+(parseInt(o[0])+r)+"_"+(parseInt(o[1])+s)))&&i.classList.add("explorable");getJSON("/game-world/generateRetinueQuest.php?forceHex="+o[0]+"_"+o[1]+"&isAjaxRequest=true",function(e){retinueAvailableQuestMap.insertAdjacentHTML("beforeend",e.mapPin),retinueDetailWrapper.insertAdjacentHTML("beforeend",e.panelMarkup)},function(e){}),n.classList.remove("explorable"),n.classList.add("explored")}else hero.stats.retinueMissionsCompleted++;var c,l=a.followerIds.split(","),d=a.endLocationX/700*100,h=a.endLocationY/450*100;for(r=0;r<l.length;r++)(c=document.getElementById("retinueFollower"+l[r])).classList.add("available"),document.getElementById("followerLocation"+l[r]).style.cssText="left: "+d+"%; top: "+h+"%;",document.getElementById("followerLocationTooltip"+l[r]).style.cssText="left: "+d+"%; top: "+h+"%;",c.setAttribute("data-locationx",a.endLocationX),c.setAttribute("data-locationy",a.endLocationY),c.removeAttribute("data-activeonquest"),document.querySelector("#retinueFollower"+l[r]+" p").innerHTML="waiting for a quest";document.getElementById("retinueComplete"+e).classList.remove("active"),sendDataWithoutNeedingAResponse("/game-world/gotRetinueRewards.php?id="+e+"&newLocationX="+a.endLocationX+"&newLocationY="+a.endLocationY)},function(t){retinueMissionCompleted(e)})}const recipeSearch=document.getElementById("recipeSearch"),clearRecipeSearch=document.getElementById("clearRecipeSearch"),recipeFilter=document.getElementById("recipeFilter"),splitStackInput=document.getElementById("splitStackInput"),splitStackPanel=document.getElementById("splitStackPanel"),shopSplitStackInput=document.getElementById("shopSplitStackInput"),shopSplitStackPanel=document.getElementById("shopSplitStackPanel"),craftingRecipeCreateButton=document.getElementById("craftingRecipeCreateButton"),craftingPanel=document.getElementById("craftingPanel"),craftingSelectComponentsPanel=document.getElementById("craftingSelectComponentsPanel"),selectComponentsItemBeingCreated=document.getElementById("selectComponentsItemBeingCreated"),componentsAvailableForThisRecipe=document.getElementById("componentsAvailableForThisRecipe"),displayItemBeingCreated=document.getElementById("displayItemBeingCreated"),booksAndParchments=document.getElementById("booksAndParchments"),gameWrapper=document.getElementById("gameWrapper"),inventoryPanels=document.getElementById("inventoryPanels"),shopPanel=document.getElementById("shopPanel"),inscriptionPanel=document.getElementById("inscriptionPanel"),inscriptionTextArea=document.getElementById("inscriptionTextArea"),sourceSelection=document.getElementById("sourceSelection"),materialsSelection=document.getElementById("materialsSelection"),inkSelection=document.getElementById("inkSelection"),originalText=document.getElementById("originalText"),scribeCopyText=document.getElementById("scribeCopyText"),scribeOriginalText=document.getElementById("scribeOriginalText"),scribeStartInscription=document.getElementById("scribeStartInscription"),inscriptionTitle=document.getElementById("inscriptionTitle"),soundVolume=document.getElementById("soundVolume"),musicVolume=document.getElementById("musicVolume"),gameSettingsPanel=document.getElementById("gameSettings"),toggleActiveCards=document.getElementById("toggleActiveCards"),toggleFullscreenSwitch=document.getElementById("toggleFullScreen"),collectionQuestPanels=document.getElementById("collectionQuestPanels"),chestPanel=document.getElementById("chestPanel"),chestTitle=document.getElementById("chestTitle"),chestSlotContents=document.getElementById("chest"),interfaceWrapper=document.getElementById("interface"),actionBar=document.getElementById("actionBar"),gatheringPanel=document.getElementById("gatheringPanel"),gatheringBarQuality=document.querySelector("#gatheringQualityBar .progressBar"),gatheringBarPurity=document.querySelector("#gatheringPurityBar .progressBar"),gatheringBarQuantity=document.querySelector("#gatheringQuantityBar .progressBar"),gatheringBarStability=document.querySelector("#gatheringBarStability .progressBar"),surveyingTimeBar=document.querySelector("#surveyingTimeBar .progressBar"),craftingTimeBar=document.querySelector("#craftingTimeBar .progressBar"),craftingTimeBarOuter=document.getElementById("craftingTimeBar"),gatheringOutputSlot=document.getElementById("gatheringOutputSlot"),surveyingPanel=document.getElementById("surveyingPanel"),questJournalEntries=document.getElementById("questJournalEntries"),questJournalRegionFilter=document.getElementById("questJournalRegionFilter"),acceptQuestChoice=document.getElementById("acceptQuestChoice"),questDecline=document.getElementById("questDecline"),questAccept=document.getElementById("questAccept"),postPanel=document.getElementById("postPanel"),sendPostTab=document.getElementById("sendPostTab"),sendPostPanel=document.getElementById("sendPostPanel"),receivedPostTab=document.getElementById("receivedPostTab"),receivedPostPanel=document.getElementById("receivedPostPanel"),sendPostSubject=document.getElementById("sendPostSubject"),sendPostMessage=document.getElementById("sendPostMessage"),sendPostCharacter=document.getElementById("sendPostCharacter"),newPost=document.getElementById("newPost"),retinuePanel=document.getElementById("retinuePanel"),retinueAvailableQuestMap=document.getElementById("retinueAvailableQuestMap"),retinueDetailWrapper=document.getElementById("retinueDetailWrapper"),draggableFollower=document.getElementById("draggableFollower"),retinueQuestStart=document.getElementById("retinueQuestStart"),retinueQuestTimeRequired=document.getElementById("retinueQuestTimeRequired"),retinueList=document.getElementById("retinueList"),retinueExplorePanel=document.getElementById("retinueExplorePanel"),startCrafting=document.getElementById("startCrafting");var notificationQueue=[],notificationIsShowing=!1,retinueQuestTimers=[],UI={init:function(){document.getElementById("displayZoneName"),document.getElementById("activeCartographicMap"),document.getElementById("cartographicTitle"),document.getElementById("dialogue"),document.getElementById("notification"),document.getElementById("cardGameWrapper"),document.getElementById("cardAlbumList"),document.getElementById("boosterPack"),document.getElementById("createRecipeList"),document.getElementById("recipeTitleBar"),document.getElementById("currencies")},showZoneName:function(e){displayZoneName.classList.remove("active"),displayZoneName.textContent=e,displayZoneName.offsetWidth,displayZoneName.classList.add("active")},buildInventoryInterface:function(){for(var e,t,a,n,i,o="",r=0;r<hero.bags.length;r++){a=currentActiveInventoryItems[hero.bags[r].type].shortname,e=currentActiveInventoryItems[hero.bags[r].type].actionValue,o+='<div class="inventoryBag active" id="inventoryBag'+r+'"><div class="draggableBar">'+a+'</div><ol id="bag'+r+'">';for(var s=0;s<e;s++)o+='<li id="slot'+(t=r+"-"+s)+'">',t in hero.inventory?(o+=generateSlotMarkup(t),currentActiveInventoryItems[hero.inventory[t].type].action,void 0!==hero.inventory[t].cooldown&&(hero.inventory[t].cooldownTimer=0)):o+="",o+="</li>";o+="</ol></div></div>"}for(r=0;r<hero.allPets.length;r++)if((n=hero.allPets[r]).inventorySize>0){i="",-1!=hero.activePets.indexOf(r)&&(i=" active"),o+='<div class="inventoryBag'+i+'" id="petInventoryBag'+r+'"><div class="draggableBar">'+n.name+'</div><ol id="bag'+r+'">';for(s=0;s<n.inventorySize;s++)o+='<li id="slot'+(t="p"+r+"-"+s)+'">',t in hero.inventory?(o+=generateSlotMarkup(t),currentActiveInventoryItems[hero.inventory[t].type].action):o+="",o+="</li>";o+="</ol></div></div>"}inventoryPanels.innerHTML=o,gameWrapper.ondblclick=UI.doubleClick,gameWrapper.addEventListener("contextmenu",UI.handleRightClick,!1),createRecipeList.onclick=UI.craftingPanelSingleClick,postPanel.onclick=UI.postPanelSingleClick,retinueAvailableQuestMap.onclick=UI.openRetinueDetailPanel,retinueQuestStart.onclick=UI.addFollowersToQuest,retinuePanel.onclick=UI.retinueSingleClick,document.getElementById("craftingRecipeCreateButton").onclick=UI.craftingRecipeCreate,splitStackPanel.onsubmit=inventorySplitStackSubmit,shopSplitStackPanel.onsubmit=UI.shopSplitStackSubmit,toggleActiveCards.onclick=UI.toggleCardsDisplayed,startCrafting.onclick=startCraftingTimer,document.getElementById("splitStackCancel").onclick=inventorySplitStackCancel,document.getElementById("shopSplitStackCancel").onclick=UI.shopSplitStackCancel,toggleFullscreenSwitch.onchange=UI.toggleFullScreen,document.onfullscreenchange=UI.fullScreenChangeDetected,document.onmozfullscreenchange=UI.fullScreenChangeDetected,document.onwebkitfullscreenchange=UI.fullScreenChangeDetected,soundVolume.onchange=audio.adjustEffectsVolume,musicVolume.onchange=audio.adjustMusicVolume,UI.initInventoryDrag(".inventoryBag ol"),document.getElementById("openSettings").onclick=UI.openSettings,actionBar.onclick=UI.actionBarClick,questDecline.onclick=declineQuest,questAccept.onclick=acceptQuest,UI.initShopDrag(),UI.updateCardAlbum(),UI.updateCurrencies(),UI.buildRecipePanel(),UI.updateInscriptionPanel(),UI.getGameSettings(),UI.buildCollectionPanel(),UI.buildActionBar(),UI.initRetinueTimers(),gameWrapper.onmousedown=UI.globalMouseDown,gameWrapper.onclick=UI.globalClick,inventoryInterfaceIsBuilt=!0},toggleFullScreen:function(){toggleFullscreenSwitch.checked?launchFullScreen(document.documentElement):exitFullScreen()},fullScreenChangeDetected:function(){document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement?toggleFullscreenSwitch.checked=!0:toggleFullscreenSwitch.checked=!1},addNewBag:function(e){hero.bags.push(e);for(var t='<div class="inventoryBag active" id="inventoryBag'+(i=hero.bags.length-1)+'"><div class="draggableBar">'+currentActiveInventoryItems[hero.bags[i].type].shortname+'</div><ol class="active" id="bag'+i+'">',a=currentActiveInventoryItems[hero.bags[i].type].actionValue,n=0;n<a;n++)t+='<li id="slot'+(i+"-"+n)+'"></li>';t+="</ol></div></div>",inventoryPanels.insertAdjacentHTML("beforeend",t),UI.initInventoryDrag("#inventoryBag"+i+" ol")},showChangeInInventory:function(e){if(e.length>0){var t,a,n;document.getElementById("slot"+e[0]).addEventListener(whichTransitionEvent,function e(t){for(var a=document.querySelectorAll("#inventoryPanels .changed"),n=0;n<a.length;n++)a[n].classList.remove("changed");return t.currentTarget.removeEventListener(whichTransitionEvent,e,!1)},!1);for(var i=0;i<e.length;i++)a=generateSlotMarkup(t=e[i]),(n=document.getElementById("slot"+t)).innerHTML=a,n.classList.add("changed")}},handleDrag:function(e){UI.activeDragObject.style.cssText="z-index:4;top: "+objInitTop+"px; left: "+objInitLeft+"px; transform: translate("+(e.pageX-dragStartX)+"px, "+(e.pageY-dragStartY)+"px);"},endDrag:function(e){document.removeEventListener("mousemove",UI.handleDrag,!1),document.removeEventListener("mouseup",UI.endDrag,!1),UI.activeDragObject=""},globalMouseDown:function(e){if("draggableBar"==e.target.className){if(2!=e.button){UI.activeDragObject=e.target.parentElement;var t=(window.pageYOffset||document.documentElement.scrollTop)-(document.documentElement.clientTop||0),a=e.target.getBoundingClientRect();objInitLeft=a.left,objInitTop=a.top+t,dragStartX=e.pageX,dragStartY=e.pageY,document.addEventListener("mousemove",UI.handleDrag,!1),document.addEventListener("mouseup",UI.endDrag,!1);for(var n=document.querySelectorAll(".draggableBar"),i=0;i<n.length;i++)n[i].parentElement.style.zIndex=1}}else{var o=getNearestParentId(e.target);if(-1!==o.id.indexOf("retinueFollower")&&(e.preventDefault(),2!=e.button&&o.classList.contains("available"))){o.classList.add("hasDragCopy");var r=o.id.substring(15);retinueObject.draggedFollower=r,draggableFollower.innerHTML='<div class="portrait"><img src="/images/retinue/'+r+'.png" alt=""></div>',UI.activeDragObject=draggableFollower,UI.draggedOriginal=o;t=(window.pageYOffset||document.documentElement.scrollTop)-(document.documentElement.clientTop||0);var s=o.getBoundingClientRect();objInitLeft=s.left,objInitTop=s.top+t,dragStartX=e.pageX,dragStartY=e.pageY,UI.activeDragObject.style.cssText="z-index:4;top: "+objInitTop+"px; left: "+objInitLeft+"px; transform: translate(0px, 0px);",document.addEventListener("mousemove",UI.handleDrag,!1),document.addEventListener("mouseup",UI.endFollowerDrag,!1);for(n=document.querySelectorAll(".draggableBar"),i=0;i<n.length;i++)n[i].parentElement.style.zIndex=1}}},doubleClick:function(e){var t=e.target.getAttribute("data-action");if(t)inventoryItemAction(e.target,t,e.target.getAttribute("data-action-value"));else{var a=getNearestParentId(e.target);"recipe"==a.id.substring(0,6)?recipeSelectComponents(a.id):"shop"==a.id.substring(0,4)?UI.buyFromShopSlot(a.id):"chest"==a.id.substring(0,5)?UI.addFromChest(a.id):"gathering"==a.id.substring(0,9)?UI.addFromGathering():"postMessage"==a.id.substring(0,11)?UI.takePostAttachments(a.id):"post"==a.id.substring(0,4)?UI.readPostMessage(a.id):"fromSlot"==a.id.substring(0,8)&&addCraftingComponents(a.id,!0)}},showDialogue:function(e,t){var a=getRandomElementFromArray(t.split("/"));""!=activeObjectForDialogue&&dialogue.removeEventListener(whichTransitionEvent,UI.removeActiveDialogue,!1),dialogue.innerHTML=a,dialogue.classList.remove("slowerFade"),dialogue.classList.add("active"),activeObjectForDialogue=e,UI.updateDialogue(activeObjectForDialogue)},updateDialogue:function(e){var t,a=findIsoCoordsX(e.x,e.y),n=findIsoCoordsY(e.x,e.y);t=void 0!==e.speech?"translate("+Math.floor(a-hero.isox+canvasWidth/2-40)+"px,"+Math.floor(0-(canvasHeight-(n-hero.isoy-e.centreY+canvasHeight/2))-e.z)+"px)":"translate("+Math.floor(a-hero.isox+canvasWidth/2-20)+"px,"+Math.floor(0-(canvasHeight-(n-hero.isoy-e.centreY+canvasHeight/2))-e.z-34)+"px)",dialogue.style.transform=t},removeActiveDialogue:function(){activeObjectForDialogue="",dialogue.removeEventListener(whichTransitionEvent,UI.removeActiveDialogue,!1)},showNotification:function(e){notificationIsShowing?-1===notificationQueue.indexOf(e)&&notificationQueue.push(e):(-1===notificationQueue.indexOf(e)&&notificationQueue.push(e),notificationIsShowing=!0,notification.classList.remove("active"),notification.innerHTML=e,notification.offsetHeight,notification.classList.add("active"),notification.addEventListener(whichAnimationEvent,UI.notificationEnded,!1))},notificationEnded:function(){notificationQueue.shift(),notificationIsShowing=!1,dialogue.removeEventListener(whichAnimationEvent,UI.notificationEnded,!1),notificationQueue.length>0&&UI.showNotification(notificationQueue[0])},updateCardAlbum:function(){for(var e,t,a,n,i="<ul>",o=0,r={},s=0;s<hero.cards.length;s++){var c=hero.cards[s];r[c]=r[c]?r[c]+1:1}for(s=1;s<cardGameNameSpace.allCardData.length;s++)a=!1,e="card players",t="",n="",r[s]?(t='<span class="quantity">'+r[s]+"</span>",a=!0):n=' class="inactive"',i+="<li"+n+'><img src="/images/card-game/cards/'+s+'.png" class="'+e+'" alt="'+cardGameNameSpace.allCardData[s][2]+' card">'+t+"</li>",r[0-s]&&(a=!0,i+='<li class="rare"><div class="card players" style="background-image:url(/images/card-game/cards/'+(0-s)+'.png)"></div><span class="quantity">'+r[0-s]+"</span></li>"),a&&o++;i+="</ul>",i+="<p>"+o+" types out of "+(cardGameNameSpace.allCardData.length-1)+". Total individual cards: "+hero.cards.length+"</p>",cardAlbumList.innerHTML=i},populateRecipeList:function(e,t){if(currentRecipePanelProfession!=e){releaseLockedSlots(),craftingSelectComponentsPanel.classList.remove("active"),recipeSearch.value="",clearRecipeSearch.classList.remove("active");for(var a,n=findRecipeTierLevel(t),i='<li id="noRecipesFound"><p>No recipes found.</p></li>',o="",r=0;r<hero.crafting[e].sortOrder.length;r++)n>=(a=hero.crafting[e].recipes[hero.crafting[e].sortOrder[r]]).tier&&(i+='<li class="active" id="recipe'+hero.crafting[e].sortOrder[r]+'"><img src="/images/game-world/inventory-items/'+a.imageId+'.png" alt="'+a.recipeName+'"><h3>'+a.recipeName+"</h3><p>"+a.recipeDescription+"</p></li>");createRecipeList.innerHTML=i;for(r=0;r<hero.crafting[e].filterOrder.length;r++)o+='<option value="'+hero.crafting[e].filters[hero.crafting[e].filterOrder[r]]+'"',0==r&&(o+=' selected="selected"'),o+=">"+hero.crafting[e].filterOrder[r]+"</option>";recipeFilter.innerHTML=o,currentRecipePanelProfession=e,UI.highlightedRecipe="",craftingRecipeCreateButton.disabled=!0,recipeTitleBar.innerHTML=hero.crafting[e].name+" Recipes",thisDevicesScrollBarWidth>0&&recipeCustomScrollBar.init()}craftingPanel.classList.add("active")},buildRecipePanel:function(){recipeSearch.onkeyup=recipeSearchInput,recipeFilter.onchange=recipeSearchAndFilter,clearRecipeSearch.onclick=recipeSearchClear},endInventoryDrag:function(e){var t=!1;if("shopSlot"==UI.sourceSlot.substring(0,8)){t=!0;var a=document.getElementById(UI.sourceSlot).firstElementChild,n=document.getElementById(UI.sourceSlot).parentNode.parentNode,i=a.getAttribute("data-price"),o=n.getAttribute("data-currency"),r={type:parseInt(a.getAttribute("data-type")),quantity:1,quality:100,durability:100,currentWear:0,effectiveness:100,colour:parseInt(a.getAttribute("data-colour")),enchanted:0,hallmark:0,inscription:""};a.hasAttribute("data-inscription")&&(r.inscription=a.getAttribute("data-inscription")),a.hasAttribute("data-contains")&&(r.contains=a.getAttribute("data-contains"))}var s=getNearestParentId(e.target),c=s.id;if("slot"==c.substring(0,4)){var l=c.substring(4);if(void 0==hero.inventory[l])isSplitStackBeingDragged?(addToInventory(l,UI.draggedInventoryObject),UI.droppedSuccessfully()):t?hero.currency[o]>=i?(addToInventory(l,r),hero.currency[o]-=i,UI.updateCurrencies(),audio.playSound(soundEffects.coins,0),UI.droppedSuccessfully()):(UI.showNotification("<p>Not enough money</p>"),UI.slideDraggedSlotBack()):(UI.sourceSlot!=l?(document.getElementById("slot"+UI.sourceSlot).innerHTML="",addToInventory(l,UI.draggedInventoryObject)):hero.inventory[l]=JSON.parse(JSON.stringify(UI.draggedInventoryObject)),document.getElementById("slot"+UI.sourceSlot).classList.remove("hidden"),UI.droppedSuccessfully());else if(t)itemAttributesMatch(r,hero.inventory[l])&&parseInt(hero.inventory[l].quantity)<maxNumberOfItemsPerSlot?hero.currency[o]>=i?(hero.inventory[l].quantity++,updateQuantity(l),hero.currency[o]-=i,UI.updateCurrencies(),audio.playSound(soundEffects.coins,0),UI.droppedSuccessfully()):(UI.showNotification("<p>Not enough money</p>"),UI.slideDraggedSlotBack()):UI.slideDraggedSlotBack();else if(itemAttributesMatch(UI.draggedInventoryObject,hero.inventory[l]))if(parseInt(UI.draggedInventoryObject.quantity)+parseInt(hero.inventory[l].quantity)<=maxNumberOfItemsPerSlot)hero.inventory[l].quantity+=parseInt(UI.draggedInventoryObject.quantity),updateQuantity(l),isSplitStackBeingDragged||(document.getElementById("slot"+UI.sourceSlot).innerHTML="",document.getElementById("slot"+UI.sourceSlot).classList.remove("hidden")),UI.droppedSuccessfully();else{var d=maxNumberOfItemsPerSlot-parseInt(hero.inventory[l].quantity);hero.inventory[l].quantity=maxNumberOfItemsPerSlot,updateQuantity(l),UI.draggedInventoryObject.quantity-=d;for(var h=document.getElementById("slot"+UI.sourceSlot),u=0;u<h.childNodes.length;u++)if("qty"==h.childNodes[u].className){h.childNodes[u].innerHTML=UI.draggedInventoryObject.quantity;break}for(h=document.getElementById("draggableInventorySlot"),u=0;u<h.childNodes.length;u++)if("qty"==h.childNodes[u].className){h.childNodes[u].innerHTML=UI.draggedInventoryObject.quantity;break}inventorySplitStackCancel(),UI.slideDraggedSlotBack()}else UI.slideDraggedSlotBack()}else if("inventoryBag"==c.substring(0,12)){var g=c.substring(12),p=UI.sourceSlot.indexOf("-"),m=UI.sourceSlot.substring(0,p),f=currentActiveInventoryItems[hero.bags[g].type].actionValue,v=-1;if(t)if(hero.currency[o]>=i){for(var y=0;y<f;y++){if(!(g+"-"+y in hero.inventory)){v=y;break}}-1!=v?(hero.currency[o]-=i,UI.updateCurrencies(),audio.playSound(soundEffects.coins,0),UI.droppedSuccessfully(),addToInventory(g+"-"+v,r),UI.droppedSuccessfully()):UI.slideDraggedSlotBack(),UI.droppedSuccessfully()}else UI.showNotification("<p>Not enough money</p>"),UI.slideDraggedSlotBack();else if(g==m)UI.slideDraggedSlotBack();else{for(y=0;y<f;y++){if(!(g+"-"+y in hero.inventory)){v=y;break}}-1!=v?(isSplitStackBeingDragged||(document.getElementById("slot"+UI.sourceSlot).innerHTML=""),addToInventory(g+"-"+v,UI.draggedInventoryObject),document.getElementById("slot"+UI.sourceSlot).classList.remove("hidden"),UI.droppedSuccessfully()):UI.slideDraggedSlotBack()}}else"shopSlot"==c.substring(0,8)?t?UI.slideDraggedSlotBack():UI.sellToShop(s.parentNode.parentNode):s.classList.contains("shop")?t?UI.slideDraggedSlotBack():UI.sellToShop(s):UI.slideDraggedSlotBack();document.removeEventListener("mousemove",UI.handleDrag,!1),document.removeEventListener("mouseup",UI.endInventoryDrag,!1)},sellToShop:function(e){var t,a=currentActiveInventoryItems[UI.draggedInventoryObject.type].category,n=e.getAttribute("data-specialism"),i=e.getAttribute("data-currency");t=-1!=a.indexOf(n)?Math.ceil(UI.draggedInventoryObject.quantity*sellPriceSpecialismModifier*inflationModifier*currentActiveInventoryItems[UI.draggedInventoryObject.type].priceCode,0):Math.ceil(UI.draggedInventoryObject.quantity*sellPriceModifier*inflationModifier*currentActiveInventoryItems[UI.draggedInventoryObject.type].priceCode,0),hero.currency[i]+=t,UI.updateCurrencies(),audio.playSound(soundEffects.coins,0),document.getElementById("slot"+UI.sourceSlot).classList.remove("hidden"),document.getElementById("slot"+UI.sourceSlot).innerHTML="",UI.droppedSuccessfully()},droppedSuccessfully:function(){""!=UI.activeDragObject&&(UI.activeDragObject.style.cssText="z-index:2;",UI.activeDragObject="",isSplitStackBeingDragged&&(isSplitStackBeingDragged=!1),inventorySplitStackCancel(),UI.updatePanelsAfterInventoryChange())},initInventoryDrag:function(e){for(var t=document.querySelectorAll(e),a=0;a<t.length;a++)t[a].addEventListener("mousedown",function(e){if(e.preventDefault(),2!=e.button){var t=getNearestParentId(e.target);if(key[5]){UI.sourceSlot=t.id.substring(4),UI.draggedInventoryObject=JSON.parse(JSON.stringify(hero.inventory[UI.sourceSlot])),splitStackInput.setAttribute("max",hero.inventory[UI.sourceSlot].quantity);var a=Math.floor(hero.inventory[UI.sourceSlot].quantity/2);splitStackInput.value=a,splitStackInput.focus();var n=t.getBoundingClientRect(),i=(window.pageYOffset||document.documentElement.scrollTop)-(document.documentElement.clientTop||0);objInitLeft=n.left+3,objInitTop=n.top+3+i-44,splitStackPanel.style.cssText="z-index:4;top: "+objInitTop+"px; left: "+objInitLeft+"px;",splitStackPanel.classList.add("active"),key[5]=0}else if(!isSplitStackBeingDragged){UI.sourceSlot=t.id.substring(4),UI.draggedInventoryObject=hero.inventory[UI.sourceSlot],UI.activeDragObject=document.getElementById("draggableInventorySlot"),UI.activeDragObject.innerHTML=t.innerHTML,delete hero.inventory[UI.sourceSlot],t.classList.add("hidden");n=t.getBoundingClientRect(),i=(window.pageYOffset||document.documentElement.scrollTop)-(document.documentElement.clientTop||0);objInitLeft=n.left+3,objInitTop=n.top+3+i,dragStartX=e.pageX,dragStartY=e.pageY,UI.activeDragObject.style.cssText="z-index:4;top: "+objInitTop+"px; left: "+objInitLeft+"px; transform: translate(0px, 0px);",document.addEventListener("mousemove",UI.handleDrag,!1),document.addEventListener("mouseup",UI.endInventoryDrag,!1)}}},!1)},slideDraggedSlotBack:function(){UI.activeDragObject.style.cssText="z-index:4;left: "+objInitLeft+"px; top: "+objInitTop+"px;transition: transform 0.4s ease;",UI.activeDragObject.addEventListener(whichTransitionEvent,function e(t){if("shopSlot"!=UI.sourceSlot.substring(0,8))if(isSplitStackBeingDragged){hero.inventory[UI.sourceSlot].quantity+=UI.draggedInventoryObject.quantity;var a=document.getElementById("slot"+UI.sourceSlot);if(a)for(var n=0;n<a.childNodes.length;n++)if("qty"==a.childNodes[n].className){a.childNodes[n].innerHTML=hero.inventory[UI.sourceSlot].quantity;break}}else hero.inventory[UI.sourceSlot]=JSON.parse(JSON.stringify(UI.draggedInventoryObject)),document.getElementById("slot"+UI.sourceSlot).classList.remove("hidden");return UI.droppedSuccessfully(),t.currentTarget.removeEventListener(whichTransitionEvent,e,!1)},!1)},craftingPanelSingleClick:function(e){var t=getNearestParentId(e.target);"recipe"==t.id.substring(0,6)&&(""!=UI.highlightedRecipe&&document.getElementById(UI.highlightedRecipe).classList.remove("highlighted"),UI.highlightedRecipe=t.id,document.getElementById(UI.highlightedRecipe).classList.add("highlighted"),craftingRecipeCreateButton.disabled=!1)},craftingRecipeCreate:function(){""!=UI.highlightedRecipe&&recipeSelectComponents(UI.highlightedRecipe)},buildBook:function(e,t){var a="";e.inscription.content;document.getElementById("book"+t)||(a+='<div class="book inkColour'+e.colour+'" id="book'+t+'">',a+='<div class="draggableBar">&quot;'+e.inscription.title+"&quot;</div>",a+='<button class="closePanel">close</button>',a+=e.inscription.content,a+="</div>",booksAndParchments.innerHTML+=a)},globalClick:function(e){if(e.target.className&&"closePanel"==e.target.className)if(e.target.parentNode.classList.remove("active"),e.target.parentNode.classList.contains("shop"))shopCurrentlyOpen=-1,inventoryPanels.removeAttribute("class"),""!=activeObjectForDialogue&&(dialogue.classList.remove("active"),activeObjectForDialogue.speechIndex=0,UI.removeActiveDialogue());else switch(e.target.parentNode.id){case"gatheringPanel":"gather"==activeAction&&gatheringStopped();break;case"surveyingPanel":"survey"==activeAction&&surveyingStopped();break;case"inscriptionPanel":UI.resetInscriptionPanel();break;case"chestPanel":UI.closeChest();break;case"postPanel":UI.closePost();break;case"retinuePanel":UI.closeRetinuePanel();break;case"craftingSelectComponentsPanel":releaseLockedSlots()}var t=getNearestParentId(e.target);"scribe"==t.id.substring(0,6)&&UI.processInscriptionClick(t)},updateCurrencies:function(){currencies.innerHTML="<p>"+parseMoney(hero.currency.money)+"</p><p>"+hero.currency.cardDust+'<span class="card"><span></p><p>'+hero.currency.keys.length+'<span class="keys"><span></p>'},buildShop:function(e){shopPanel.innerHTML=e},openShop:function(e){shopCurrentlyOpen=e,document.getElementById("shop"+e).classList.add("active"),inventoryPanels.classList.add("shopSpecialism"+document.getElementById("shop"+e).getAttribute("data-specialism"))},closeShop:function(){document.getElementById("shop"+shopCurrentlyOpen).classList.remove("active"),shopCurrentlyOpen=-1,inventoryPanels.removeAttribute("class")},shopSplitStackCancel:function(){shopSplitStackPanel.classList.remove("active"),document.activeElement.blur()},buyFromShopSlot:function(e){var t=document.getElementById(e),a=t.firstElementChild,n=t.parentNode.parentNode,i=a.getAttribute("data-price"),o=n.getAttribute("data-currency");if(hero.currency[o]>=i){var r={type:parseInt(a.getAttribute("data-type")),quantity:1,quality:100,durability:100,currentWear:0,effectiveness:100,colour:parseInt(a.getAttribute("data-colour")),enchanted:0,hallmark:0,inscription:""};a.hasAttribute("data-inscription")&&(r.inscription=a.getAttribute("data-inscription")),a.hasAttribute("data-contains")&&(r.contains=a.getAttribute("data-contains")),(inventoryCheck=canAddItemToInventory([r]))[0]?(hero.currency[o]-=i,UI.updateCurrencies(),audio.playSound(soundEffects.coins,0),UI.showChangeInInventory(inventoryCheck[1])):UI.showNotification("<p>Oops - sorry, no room in your bags</p>")}else UI.showNotification("<p>Oops - sorry, not enough money</p>");UI.activeDragObject.innerHTML=""},initShopDrag:function(){document.getElementById("shopPanel").addEventListener("mousedown",function(e){if(!isSplitStackBeingDragged){var t=getNearestParentId(e.target);if("shopSlot"==t.id.substring(0,8)&&(e.preventDefault(),2!=e.button))if(UI.sourceSlot=t,key[5]){var a=t.firstElementChild,n=t.parentNode.parentNode,i=a.getAttribute("data-price"),o=n.getAttribute("data-currency"),r=Math.floor(hero.currency[o]/i);r>maxNumberOfItemsPerSlot&&(r=maxNumberOfItemsPerSlot),shopSplitStackInput.setAttribute("max",r),shopSplitStackInput.value=1,shopSplitStackInput.focus();var s=t.getBoundingClientRect(),c=(window.pageYOffset||document.documentElement.scrollTop)-(document.documentElement.clientTop||0);objInitLeft=s.left+3,objInitTop=s.top+3+c-44,shopSplitStackPanel.style.cssText="z-index:4;top: "+objInitTop+"px; left: "+objInitLeft+"px;",shopSplitStackPanel.classList.add("active"),key[5]=0}else{UI.sourceSlot=t.id,UI.draggedInventoryObject={type:parseInt(t.getAttribute("data-type")),quantity:1,quality:100,durability:100,currentWear:0,effectiveness:100,colour:parseInt(t.getAttribute("data-colour")),enchanted:0,hallmark:0,inscription:""},t.hasAttribute("data-inscription")&&(UI.draggedInventoryObject.inscription=t.getAttribute("data-inscription")),t.hasAttribute("data-contains")&&(UI.draggedInventoryObject.contains=t.getAttribute("data-contains")),UI.activeDragObject=document.getElementById("draggableShopSlot"),UI.activeDragObject.innerHTML=t.innerHTML;s=t.getBoundingClientRect(),c=(window.pageYOffset||document.documentElement.scrollTop)-(document.documentElement.clientTop||0);objInitLeft=s.left+3,objInitTop=s.top+3+c,dragStartX=e.pageX,dragStartY=e.pageY,UI.activeDragObject.style.cssText="z-index:4;top: "+objInitTop+"px; left: "+objInitLeft+"px; transform: translate(0px, 0px);",document.addEventListener("mousemove",UI.handleDrag,!1),document.addEventListener("mouseup",UI.endInventoryDrag,!1)}}},!1)},shopSplitStackSubmit:function(e){e&&e.preventDefault();var t=shopSplitStackInput.value,a=!0;if((t=parseInt(t))<1&&(a=!1),Number.isInteger(t)||(a=!1),t>shopSplitStackInput.getAttribute("max")&&(a=!1),a){var n=UI.sourceSlot.firstElementChild,i=UI.sourceSlot.parentNode.parentNode,o=n.getAttribute("data-price"),r=i.getAttribute("data-currency"),s={type:parseInt(n.getAttribute("data-type")),quantity:t,quality:100,durability:100,currentWear:0,effectiveness:100,colour:parseInt(n.getAttribute("data-colour")),enchanted:0,hallmark:0,inscription:""};n.hasAttribute("data-inscription")&&(s.inscription=n.getAttribute("data-inscription")),n.hasAttribute("data-contains")&&(s.contains=n.getAttribute("data-contains")),(inventoryCheck=canAddItemToInventory([s]))[0]?(hero.currency[r]-=t*o,UI.updateCurrencies(),audio.playSound(soundEffects.coins,0),UI.showChangeInInventory(inventoryCheck[1])):UI.showNotification("<p>Oops - sorry, no room in your bags</p>")}shopSplitStackPanel.classList.remove("active"),document.activeElement.blur()},openInscriptionPanel:function(){audio.playSound(soundEffects.bookOpen,0),inscriptionTextArea.innerHTML="",inscriptionPanel.classList.add("active")},resetInscriptionPanel:function(){var e,t=document.querySelectorAll("#inscriptionPanel li");for(e=0;e<t.length;++e)t[e].classList.remove("selected")},updateInscriptionPanel:function(){var e,t,a,n="<h3>Inks available:</h3><ol>",i="<h3>Documents available:</h3><ol>",o="<h3>Materials available:</h3><ol>";for(var r in hero.inventory)if(40==hero.inventory[r].type)e="",a="",""!=(t=getColourName(hero.inventory[r].colour,hero.inventory[r].type))&&(a=t+" ",e="-"+t.toLowerCase()),n+='<li class="scribeInk" id="scribeInkFromSlot'+r+'"><img src="/images/game-world/inventory-items/40'+e+'.png" alt="'+a+currentActiveInventoryItems[40].shortname+'">'+hero.inventory[r].quantity+"<h3>"+a+currentActiveInventoryItems[40].shortname+"</h3><p>"+currentActiveInventoryItems[40].description+"</p></li>";else{var s=currentActiveInventoryItems[hero.inventory[r].type].action,c=!1;s&&"book"==s&&(c=!0),c&&(hero.inventory[r].inscription.content?i+='<li class="scribeSource" id="scribeSourceFromSlot'+r+'"><img src="/images/game-world/inventory-items/'+hero.inventory[r].type+'.png" alt="'+currentActiveInventoryItems[hero.inventory[r].type].shortname+'">'+hero.inventory[r].quantity+"<h3>"+currentActiveInventoryItems[hero.inventory[r].type].shortname+"</h3><p>"+hero.inventory[r].inscription.title+"</p></li>":o+='<li class="scribeMaterial" id="scribeMaterialFromSlot'+r+'"><img src="/images/game-world/inventory-items/'+hero.inventory[r].type+'.png" alt="'+currentActiveInventoryItems[hero.inventory[r].type].shortname+'">'+hero.inventory[r].quantity+"<h3>"+currentActiveInventoryItems[hero.inventory[r].type].shortname+"</h3><p>"+currentActiveInventoryItems[hero.inventory[r].type].description+"</p></li>")}n+="</ol>",i+="</ol>",o+="</ol>",sourceSelection.innerHTML=i,materialsSelection.innerHTML=o,inkSelection.innerHTML=n,UI.inscription={mode:"original",selected:{source:"",material:"",ink:""}},scribeStartInscription.setAttribute("disabled","disabled"),inscriptionTitle.value="",inscriptionTextArea.innerHTML=""},processInscriptionClick:function(e){switch(e.className){case"scribeSource":UI.inscription.selected.source=e.id.substring(20);var t=document.querySelectorAll("#sourceSelection li");for(a=0;a<t.length;++a)t[a].classList.remove("selected");e.classList.add("selected");break;case"scribeMaterial":UI.inscription.selected.material=e.id.substring(22);t=document.querySelectorAll("#materialsSelection li");for(a=0;a<t.length;++a)t[a].classList.remove("selected");e.classList.add("selected");break;case"scribeInk":UI.inscription.selected.ink=e.id.substring(17);var a;t=document.querySelectorAll("#inkSelection li");for(a=0;a<t.length;++a)t[a].classList.remove("selected");e.classList.add("selected")}switch("copy"==UI.inscription.mode?""!=UI.inscription.selected.ink&&""!=UI.inscription.selected.material&&""!=UI.inscription.selected.source?scribeStartInscription.removeAttribute("disabled"):scribeStartInscription.setAttribute("disabled","disabled"):""!=UI.inscription.selected.ink&&""!=UI.inscription.selected.material?scribeStartInscription.removeAttribute("disabled"):scribeStartInscription.setAttribute("disabled","disabled"),e.id){case"scribeCopyText":"copy"!=UI.inscription.mode&&UI.resetInscriptionPanel(),UI.inscription.mode="copy",originalText.classList.remove("active"),sourceSelection.classList.add("active"),e.classList.add("active"),scribeOriginalText.classList.remove("active");break;case"scribeOriginalText":"original"!=UI.inscription.mode&&UI.resetInscriptionPanel(),UI.inscription.mode="original",originalText.classList.add("active"),sourceSelection.classList.remove("active"),e.classList.add("active"),scribeCopyText.classList.remove("active");break;case"scribeStartInscription":var n=JSON.parse(JSON.stringify(hero.inventory[UI.inscription.selected.material]));n.quantity=1,n.colour=hero.inventory[UI.inscription.selected.ink].colour,"copy"==UI.inscription.mode?n.inscription={title:hero.inventory[UI.inscription.selected.source].inscription.title,content:hero.inventory[UI.inscription.selected.source].inscription.content,timeCreated:Date.now()}:n.inscription={title:inscriptionTitle.value,content:"<p>"+inscriptionTextArea.innerHTML+"</p>",timeCreated:Date.now()};var i=UI.inscription.selected.material,o=UI.inscription.selected.ink;(inventoryCheck=canAddItemToInventory([n]))[0]?(document.getElementById("slot"+inventoryCheck[1]).innerHTML=generateSlotMarkup(inventoryCheck[1]),UI.showChangeInInventory(inventoryCheck[1]),removeFromInventory(i,1),removeFromInventory(o,1),UI.updateInscriptionPanel()):UI.showNotification("<p>Oops - sorry, no room in your bags</p>")}},updatePanelsAfterInventoryChange:function(){UI.updateInscriptionPanel()},getGameSettings:function(e){soundVolume.value=gameSettings.soundVolume,musicVolume.value=gameSettings.musicVolume,audio.adjustEffectsVolume(),audio.adjustMusicVolume()},openSettings:function(e){e&&e.preventDefault(),gameSettingsPanel.classList.add("active")},toggleCardsDisplayed:function(e){cardAlbumList.classList.toggle("showOnlyPlayers"),toggleActiveCards.innerHTML="Show only collected cards"==toggleActiveCards.innerHTML?"Show all cards":"Show only collected cards"},buildCollectionPanel:function(){for(var e,t,a,n,i=document.querySelectorAll("#collectionQuestPanels section"),o=0;o<i.length;o++)if(e=i[o].dataset.collection,hero.collections.hasOwnProperty(e)){var r;if(hero.collections[e].complete)(r=i[o].getElementsByTagName("P")[0]).textContent=window.atob(r.textContent),r.classList.add("active");for(var s in t="",hero.collections[e].required)n="notCollected",(a=hero.collections[e].required[s])<0&&(n=""),t+='<li class="'+n+'"><img src="/images/game-world/inventory-items/'+Math.abs(a)+'.png"></li>',i[o].getElementsByTagName("OL")[0].innerHTML=t}collectionQuestPanels.classList.add("active")},initiateCollectionQuestPanel:function(e){var t,a,n="";for(var i in hero.collections[e].required)a="notCollected",(t=hero.collections[e].required[i])<0&&(a=""),n+='<li class="'+a+'" id="'+e+"-"+Math.abs(t)+'"><img src="/images/game-world/inventory-items/'+Math.abs(t)+'.png"></li>',document.querySelector("#collection-"+e+" ol").innerHTML=n},completeCollectionQuestPanel:function(e){var t=document.querySelector("#collection-"+e+" p");t.textContent=window.atob(t.textContent),t.classList.add("active")},openChest:function(e){var t=thisMapData.items[e].contains;audio.playSound(soundEffects.chestOpen,0),chestTitle.innerHTML=currentActiveInventoryItems[thisMapData.items[e].type].shortname;for(var a,n="",i=0;i<currentActiveInventoryItems[thisMapData.items[e].type].actionValue;i++){if(n+='<li id="chestSlot-'+e+"-"+i+'">',void 0!==t[i]&&""!=t[i])if("$"==t[i].type)n+='<img src="/images/game-world/inventory-items/coins.png" alt="'+t[i].quantity+' worth of coins">',n+="<p><em>"+parseMoney(t[i].quantity)+" worth of coins </em></p>",n+='<span class="qty">'+parseMoney(t[i].quantity)+"</span>";else{for(var o in a={quantity:1,quality:100,durability:100,currentWear:0,effectiveness:100,colour:0,enchanted:0,hallmark:0,inscription:""},t[i])a[o]=t[i][o];t[i]=a,n+=generateGenericSlotMarkup(a)}n+="</li>"}chestSlotContents.innerHTML=n,chestIdOpen=e,chestPanel.classList.add("active")},closeChest:function(){chestPanel.classList.remove("active"),audio.playSound(soundEffects.chestOpen,0),chestIdOpen=-1},addFromChest:function(e){var t=e.split("-"),a=thisMapData.items[t[1]].contains[t[2]];void 0!==a&&("$"==a.type?(hero.currency.money+=a.quantity,audio.playSound(soundEffects.coins,0),UI.updateCurrencies(),thisMapData.items[t[1]].contains[t[2]]="",document.getElementById(e).innerHTML=""):(inventoryCheck=canAddItemToInventory([a]))[0]?(thisMapData.items[t[1]].contains[t[2]]="",UI.showChangeInInventory(inventoryCheck[1]),document.getElementById(e).innerHTML=""):UI.showNotification("<p>Oops - sorry, no room in your bags</p>"))},toggleUI:function(){interfaceWrapper.classList.toggle("active"),interfaceIsVisible=!interfaceIsVisible},buildActionBar:function(){for(var e,t,a="<ol>",n=0;n<hero.actions.length;n++)"-"==hero.actions[n]?a+='<li><img src="/images/game-world/interface/actions/blank.png" alt="Empty Action slot"></li>':(null==hero.actions[n][2]?(e=hero.actions[n][1],t=hero.actions[n][0],void 0!==hero.actions[n][3]["pet-name"]&&(t+=" "+hero.actions[n][3]["pet-name"])):(e=hero.actions[n][2]+"-"+hero.actions[n][1],t=hero.actions[n][0]+" ("+hero.actions[n][1]+" type"+hero.actions[n][2]+")"),a+='<li class="active" data-index="'+n+'" data-category="'+hero.actions[n][2]+'" id="actionType'+hero.actions[n][1]+'"><img src="/images/game-world/interface/actions/'+e+'.png" alt="'+hero.actions[n][0]+' action"><p>'+t+"</p></li>");a+="</ol>",actionBar.innerHTML=a},actionBarClick:function(e){var t=getNearestParentId(e.target);if("actionType"==t.id.substring(0,10))switch(t.id.substring(10)){case"gather":if("gather"!=activeAction){"survey"==activeAction&&surveyingStopped();for(var a,n=hero.tileX+relativeFacing[hero.facing].x,i=hero.tileY+relativeFacing[hero.facing].y,o=-1,r=0;r<thisMapData.items.length;r++){if(a=thisMapData.items[r],hero.tileX==a.tileX&&hero.tileY==a.tileY){o=r;break}if(n==a.tileX&&i==a.tileY){o=r;break}}if(-1!=o){if(currentActiveInventoryItems[thisMapData.items[o].type].category==t.dataset.category){if("inactive"!=thisMapData.items[o].state){for(var s in gathering.itemIndex=o,gathering.quality=parseInt(thisMapData.items[o].quality),gathering.quantity=100,gathering.maxQuantity=parseInt(thisMapData.items[o].quantity),gathering.purity=parseInt(thisMapData.items[o].purity),gathering.stability=parseInt(thisMapData.items[o].stability),gathering.node=thisMapData.items[o],gathering.depletionTime=5e3,gathering.modifiers=hero.actions[t.dataset.index][3],gathering.modifiers)switch(s){case"time":gathering.depletionTime+=gathering.modifiers[s];break;case"purity":gathering.purity+=gathering.modifiers[s];break;case"stability":gathering.stability+=gathering.modifiers[s];break;case"quality":gathering.quality+=gathering.modifiers[s]}gathering.quality=capValues(gathering.quality,10,100),gathering.purity=capValues(gathering.purity,10,100),gathering.stability=capValues(gathering.stability,10,100),gathering.quantity=capValues(gathering.quantity,10,100),gathering.stabilitySpeed=.002*gathering.quality,gathering.depletionSpeed=2e3/gathering.depletionTime,UI.updateGatheringPanel(),gatheringPanel.offsetHeight,gatheringOutputSlot.innerHTML="",gatheringPanel.classList.add("active"),audio.playSound(soundEffects["gather"+t.dataset.category],0),activeAction="gather"}}else UI.showNotification("<p>Wrong resource type for this action</p>");"dowse"==activeAction&&(activeAction="")}}break;case"dowse":if("survey"==activeAction&&surveyingStopped(),"gather"!=activeAction)if("dowse"!=activeAction)for(var s in dowsing.range=10,dowsing.category=t.dataset.category,activeAction="dowse",dowsing.modifiers=hero.actions[t.dataset.index][3],dowsing.modifiers)switch(s){case"range":dowsing.range+=dowsing.modifiers[s]}else activeAction="",dowsing={};break;case"survey":if("gather"!=activeAction)if("survey"!=activeAction){for(var s in activeAction="survey",surveying.category=t.dataset.category,surveying.timeRequired=1e3,surveying.modifiers=hero.actions[t.dataset.index][3],surveying.modifiers)switch(s){case"time":surveying.timeRequired+=surveying.modifiers[s]}surveying.timeRequired=capValues(surveying.timeRequired,200,2e3),surveying.timeRemaining=100,surveying.depletionSpeed=500/surveying.timeRequired,UI.updateSurveyingPanel(),surveyingPanel.offsetHeight,surveyingPanel.classList.add("active")}else surveyingStopped()}},updateGatheringPanel:function(){gatheringBarQuality.style.width=gathering.quality+"%",gatheringBarQuantity.style.width=gathering.quantity+"%",gatheringBarPurity.style.width=gathering.purity+"%",gatheringBarStability.style.width=gathering.stability+"%"},updateSurveyingPanel:function(){surveyingTimeBar.style.width=100-surveying.timeRemaining+"%"},updateCraftingPanel:function(){craftingTimeBar.style.width=craftingObject.timeRemaining+"%"},addFromGathering:function(){(inventoryCheck=canAddItemToInventory([activeGatheredObject]))[0]?(gatheringOutputSlot.innerHTML="",UI.showChangeInInventory(inventoryCheck[1]),hero.stats.itemsGathered++,gatheringPanel.classList.remove("active")):UI.showNotification("<p>Oops - sorry, no room in your bags</p>")},updateCooldowns:function(){var e;for(var t in hero.inventory)void 0!==hero.inventory[t].cooldown&&hero.inventory[t].cooldownTimer>0&&(hero.inventory[t].cooldownTimer--,e=hero.inventory[t].cooldownTimer/hero.inventory[t].cooldown,document.querySelector("#slot"+t+" .coolDown").style.transform="scaleY("+e+")")},handleRightClick:function(e){console.log("right click"),console.log(e);var t=getNearestParentId(e.target);console.log(t.id)},buildQuestJournal:function(e,t){questJournalEntries.innerHTML=e;var a='<option value="all">Show all</option>';for(var n in t)a+='<option value="'+t[n]+'">'+t[n]+"</option>";questJournalRegionFilter.innerHTML=a,questJournalRegionFilter.onchange=UI.filterJournal,questJournal.classList.add("active")},filterJournal:function(e){var t,a=document.querySelectorAll("#questJournalEntries li");if("all"==questJournalRegionFilter.value)for(t=0;t<a.length;++t)a[t].classList.add("active");else for(t=0;t<a.length;++t)a[t].dataset.region==questJournalRegionFilter.value?a[t].classList.add("active"):a[t].classList.remove("active")},toggleJournal:function(){questJournal.classList.toggle("active")},addToQuestJournal:function(e){questJournalEntries.innerHTML=e.markup+questJournalEntries.innerHTML;for(var t=!1,a=-1,n=0;n<questJournalRegionFilter.length;n++){if(questJournalRegionFilter.options[n].value==e.regions){t=!0;break}"all"!=questJournalRegionFilter.options[n].value&&questJournalRegionFilter.options[n].value>e.regions&&-1==a&&(a=n)}if(!t){var i=document.createElement("OPTION");i.innerText=e.regions,i.value=e.regions,questJournalRegionFilter.options.add(i,a)}},movePlotPlacementOverlay:function(e){cursorPositionX=e.pageX,cursorPositionY=e.pageY},openPost:function(e,t){postObject.x=e,postObject.y=t,postObject.active=!0,postPanel.classList.add("active"),audio.playSound(soundEffects.bookOpen,0)},closePost:function(){postObject.active=!1,postPanel.classList.remove("active")},readPostMessage:function(e){var t=document.getElementById(e);t.classList.contains("unread")&&(t.classList.remove("unread"),sendDataWithoutNeedingAResponse("/game-world/readPost.php?id="+e),0==document.querySelectorAll("#receivedPostPanel .unread").length&&newPost.classList.remove("active"));var a="postMessage"+e.substr(4);document.getElementById(a).classList.add("active")},takePostAttachments:function(e){getJSON("/game-world/getPostAttachment.php?id="+e,function(e){if("null"!=e.item)if((inventoryCheck=canAddItemToInventory(e.item))[0]){UI.showChangeInInventory(inventoryCheck[1]);var t=document.querySelectorAll("#postMessage"+e.id+" .postSlot");for(i=0;i<t.length;++i)t[i].outerHTML="";document.querySelector("#post"+e.id+" .previewSlot").innerHTML="",sendDataWithoutNeedingAResponse("/game-world/gotPostAttachment.php?id="+e.id)}else UI.showNotification("<p>Oops - sorry, no room in your bags</p>")},function(t){UI.takePostAttachments(e)})},postPanelSingleClick:function(e){switch(e.target.id){case"sendPostTab":sendPostTab.classList.add("active"),sendPostPanel.classList.add("active"),receivedPostTab.classList.remove("active"),receivedPostPanel.classList.remove("active");break;case"receivedPostTab":sendPostTab.classList.remove("active"),sendPostPanel.classList.remove("active"),receivedPostTab.classList.add("active"),receivedPostPanel.classList.add("active");break;case"sendPost":sendUserPost('{"subject":"'+sendPostSubject.value+'","message":"'+sendPostMessage.value.replace(/\n/g,"\\\\n")+'","senderID":"'+characterId+'","attachments":0,"recipientCharacterName":"'+sendPostCharacter.value+'","fromName":"Eleaddai"}')}},initRetinueTimers:function(){for(var e=document.getElementsByClassName("retinueQuestTimer"),t=0;t<e.length;t++)retinueQuestTimers.push([e[t],(new Date).getTime()+60*e[t].dataset.minutes*1e3,""])},updateRetinueTimers:function(){for(var e,t,a=(new Date).getTime(),n=0;n<retinueQuestTimers.length;n++){e=retinueQuestTimers[n][1]-a;var i,o=Math.floor(e/1e3%60),r=Math.floor(e/6e4%60),s=Math.floor(e/36e5%24);(t=(i=Math.floor(e/864e5))>1?i+" days remaining":1==i?"1 day remaining":s>1?s+" hours remaining":1==s?"1 hour remaining":r>1?r+" minutes remaining":1==r?"1 minute remaining":o>1?o+" seconds remaining":1==o?"1 second remaining":"complete")!=retinueQuestTimers[n][2]&&(retinueQuestTimers[n][0].innerHTML=t,retinueQuestTimers[n][2]=t),"complete"==t&&(UI.retinueQuestComplete(retinueQuestTimers[n][0]),retinueQuestTimers.splice(n,1),n--)}},openRetinuePanel:function(e){retinuePanel.classList.add("active"),audio.playSound(soundEffects.bookOpen,0),retinueObject.active=!0,retinueObject.x=e.x,retinueObject.y=e.y,retinueObject.passedObject=e},closeRetinuePanel:function(){retinuePanel.classList.remove("active"),void 0!==retinueObject.passedObject&&void 0!==retinueObject.passedObject.speechIndex&&retinueObject.passedObject.speechIndex--,retinueObject={active:!1}},resetRetinuePanels:function(){var e=document.getElementsByClassName("retinueQuestLocationDetailPanel");for(i=0;i<e.length;i++)e[i].classList.remove("active");retinueQuestStart.disabled=!0,retinueQuestTimeRequired.innerHTML="Time required:";var t=document.getElementsByClassName("followerSlot");for(i=0;i<t.length;i++)t[i].innerHTML="";if(retinueObject.followersAdded)for(i=0;i<retinueObject.followersAdded.length;i++)"null"!=retinueObject.followersAdded[i]&&document.getElementById("retinueFollower"+retinueObject.followersAdded[i]).classList.add("available")},openRetinueDetailPanel:function(e){if(e.target.classList.contains("undiscovered")){if(e.target.classList.contains("explorable")){UI.resetRetinuePanels(),retinueExplorePanel.classList.add("active"),retinueObject.openQuestDetail="Exploring",retinueObject.destinationLocationX=e.target.getAttribute("data-locationx"),retinueObject.destinationLocationY=e.target.getAttribute("data-locationy"),retinueObject.followersRequired=Math.ceil(getPythagorasDistance(retinueBaseLocationX,retinueBaseLocationY,retinueObject.destinationLocationX,retinueObject.destinationLocationY)/277);var t=document.querySelectorAll("#retinueExplorePanel .followerSlot");for(a=0;a<t.length;++a)t[a].style.display="none";for(var a=0;a<retinueObject.followersRequired;a++)document.getElementById("dropFollowersPanelExplore-"+a).style.display="block";retinueObject.hasToReturnToBase=1,retinueObject.questName="Exploring",retinueObject.followersAdded=[];for(a=0;a<retinueObject.followersRequired;a++)retinueObject.followersAdded.push("null");var n=e.target.id.split("_");retinueObject.hexCoordX=n[1],retinueObject.hexCoordY=n[2]}}else{var i=e.target.id.substring(20);UI.resetRetinuePanels(),retinueExplorePanel.classList.remove("active"),retinueObject.openQuestDetail=i;var o=document.getElementById("retinueQuestLocationDetail"+i);retinueObject.followersRequired=o.getAttribute("data-requires"),retinueObject.destinationLocationX=o.getAttribute("data-locationx"),retinueObject.destinationLocationY=o.getAttribute("data-locationy"),retinueObject.hasToReturnToBase=o.getAttribute("data-requiresreturn"),retinueObject.questName=o.getAttribute("data-questname"),retinueObject.followersAdded=[];for(a=0;a<retinueObject.followersRequired;a++)retinueObject.followersAdded.push("null");o.classList.add("active")}},endFollowerDrag:function(e){var t=getNearestParentId(e.target);if(-1!==t.id.indexOf("dropFollowersPanel")){var a,n,o=t.id.split("-")[1];"null"!=retinueObject.followersAdded[o]&&document.getElementById("retinueFollower"+retinueObject.followersAdded[o]).classList.add("available"),retinueObject.followersAdded[o]=retinueObject.draggedFollower,-1===retinueObject.followersAdded.indexOf("null")&&(retinueQuestStart.disabled=!1);var r=0,s="";for(i=0;i<retinueObject.followersAdded.length;i++)"null"!=retinueObject.followersAdded[i]&&(n=getRetinueQuestTime((a=document.getElementById("retinueFollower"+retinueObject.followersAdded[i])).getAttribute("data-locationx"),a.getAttribute("data-locationy"),retinueObject.destinationLocationX,retinueObject.destinationLocationY,retinueObject.hasToReturnToBase))[0]>r&&(r=n[0],s=n[1]);retinueObject.timeRequired=r,retinueQuestTimeRequired.innerHTML="Time required: "+s,UI.draggedOriginal.classList.remove("hasDragCopy"),UI.activeDragObject.style.cssText="left: -100px; top: -100px;",t.innerHTML='<img src="/images/retinue/'+retinueObject.draggedFollower+'.png">',document.getElementById("retinueFollower"+retinueObject.draggedFollower).classList.remove("available")}else UI.activeDragObject.style.cssText="z-index:4;left: "+objInitLeft+"px; top: "+objInitTop+"px;transition: transform 0.4s ease;",UI.activeDragObject.addEventListener(whichTransitionEvent,function e(t){return UI.draggedOriginal.classList.remove("hasDragCopy"),t.currentTarget.style.cssText="left: -100px; top: -100px;",t.currentTarget.removeEventListener(whichTransitionEvent,e,!1)},!1);document.removeEventListener("mousemove",UI.handleDrag,!1),document.removeEventListener("mouseup",UI.endFollowerDrag,!1),UI.activeDragObject=""},addFollowersToQuest:function(){var e=[];for(i=0;i<retinueObject.followersAdded.length;i++)document.querySelector("#retinueFollower"+retinueObject.followersAdded[i]+" p").innerHTML='active on "'+retinueObject.questName+'" <span class="retinueQuestTimer" data-minutes="'+retinueObject.timeRequired+'"></span>',retinueQuestTimers.push([document.querySelector("#retinueFollower"+retinueObject.followersAdded[i]+" .retinueQuestTimer"),(new Date).getTime()+60*retinueObject.timeRequired*1e3,""]),e.push(retinueObject.followersAdded[i]),document.getElementById("retinueFollower"+retinueObject.followersAdded[i]).setAttribute("data-activeonquest",retinueObject.openQuestDetail);if("Exploring"==retinueObject.openQuestDetail){var t=document.getElementById("undiscovered_"+retinueObject.hexCoordX+"_"+retinueObject.hexCoordY);t.classList.remove("explorable"),t.classList.add("beingExplored"),getJSON("/game-world/generateExplorationRetinueQuest.php?chr="+characterId+"&followers="+e.join("|")+"&hexCoordX="+retinueObject.hexCoordX+"&hexCoordY="+retinueObject.hexCoordY,function(e){if(e.markup){retinuePanel.insertAdjacentHTML("beforeend",e.markup);var t=e.followers.split(",");for(console.log(e.followers),i=0;i<t.length;i++)document.getElementById("retinueFollower"+t[i]).setAttribute("data-activeonquest",e.questId)}},function(e){}),retinueExplorePanel.classList.remove("active"),delete retinueObject.hexCoordX,delete retinueObject.hexCoordY}else sendDataWithoutNeedingAResponse("/game-world/updateRetinueQuest.php?questID="+retinueObject.openQuestDetail+"&chr="+characterId+"&followers="+e.join("|")),document.getElementById("retinueQuestLocationDetail"+retinueObject.openQuestDetail).classList.remove("active"),document.getElementById("retinueQuestLocation"+retinueObject.openQuestDetail).classList.remove("active");retinueQuestStart.disabled=!0,retinueQuestTimeRequired.innerHTML="Time required:",delete retinueObject.draggedFollower,delete retinueObject.openQuestDetail,delete retinueObject.followersAdded,delete retinueObject.followersRequired,delete retinueObject.destinationLocationX,delete retinueObject.destinationLocationY,delete retinueObject.hasToReturnToBase,delete retinueObject.timeRequired,delete retinueObject.questName},retinueSingleClick:function(e){if("takeRewards"==e.target.className)e.preventDefault(),retinueMissionCompleted(getNearestParentId(e.target).id.substring(15),!1);else if("finishExploration"==e.target.className){e.preventDefault(),retinueMissionCompleted(getNearestParentId(e.target).id.substring(15),!0)}},retinueQuestComplete:function(e){var t=getNearestParentId(e).getAttribute("data-activeonquest");document.getElementById("retinueComplete"+t).classList.add("active")},showNewFollower:function(e,t){UI.showNotification("<p>You have gained a new follower called &quot;"+t+"&quot;</p>")},showNewProfession:function(e){UI.showNotification("<p>You learned a new profession - #"+e+"</p>")}};function setupWeather(){if(thisMapData.isInside)""==outsideWeather&&(outsideWeather=currentWeather,changeWeather(""));else{if(""!=outsideWeather)changeWeather(outsideWeather);else{var e=currentWeather;1==thisMapData.weather.length?changeWeather(thisMapData.weather[0]):-1!==thisMapData.weather.indexOf(e)?changeWeather(e):changeWeather(getRandomElementFromArray(thisMapData.weather))}outsideWeather=""}}function checkForWeatherChange(){thisMapData.isInside||thisMapData.weather.length>1&&hero.totalGameTimePlayed-weatherLastChangedTime>minTimeBetweenWeatherChanges&&changeWeather(getRandomElementFromArray(thisMapData.weather))}function changeWeather(e){e!=currentWeather&&(weatherLastChangedTime=hero.totalGameTimePlayed,""!=currentWeather&&document.getElementById(currentWeather).classList.remove("active"),""!=(currentWeather=e)&&document.getElementById(currentWeather).classList.add("active"),currentWeather in soundEffects&&audio.playSound(soundEffects[currentWeather],0))}function sizeCanvasSize(){gameContext.canvas.width=window.innerWidth,gameContext.canvas.height=window.innerHeight,lightMapContext.canvas.width=window.innerWidth/4,lightMapContext.canvas.height=window.innerHeight/4,canvasWidth=window.innerWidth,canvasHeight=window.innerHeight}"serviceWorker"in navigator&&navigator.serviceWorker.register("/game-world/serviceWorker.min.js",{scope:"/game-world/"});var debouncedResize=debounce(function(){sizeCanvasSize()},250);function init(){(gameCanvas=document.getElementById("gameWorld")).getContext&&(gameContext=gameCanvas.getContext("2d"),lightMapOverlay=document.getElementById("lightMapOverlay"),lightMapContext=lightMapOverlay.getContext("2d"),sizeCanvasSize(),whichTransitionEvent=determineWhichTransitionEvent(),whichAnimationEvent=determineWhichAnimationEvent(),gameMode="mapLoading",cartographyCanvas=document.getElementById("cartographyCanvas"),cartographyContext=cartographyCanvas.getContext("2d"),offScreenCartographyCanvas=document.getElementById("offScreenCartographyCanvas"),offScreenCartographyContext=offScreenCartographyCanvas.getContext("2d"),canvasMapImage=new Image,canvasMapMaskImage=new Image,UI.init(),audio.init(),Input.init(),gameLoop(),getHeroGameState())}function getHeroGameState(){getJSON("/game-world/getGameState.php?chr="+characterId,function(e){for(var t in e)hero[t]=e[t];for(var a in currentMap=e.currentMap,newMap=currentMap,gameSettings=e.settings,timeSinceLastAmbientSoundWasPlayed=hero.totalGameTimePlayed+1.25*minTimeBetweenAmbientSounds,e.allPets&&e.activePets.length>0&&(hasActivePet=!0),e.fae)fae[a]=e.fae[a];currentMap>0&&sendDataWithoutNeedingAResponse("/game-world/generateCircularDungeonMap.php?playerId="+characterId+"&clearMaps=true"),loadCoreAssets()},function(e){getHeroGameState()})}function loadCoreAssets(){var e=[];if(e.push({name:"heroImg",src:"/images/game-world/core/hero.png"}),e.push({name:"shadowImg",src:"/images/game-world/core/shadow-quarter.png"}),hasActivePet)for(var t=0;t<hero.activePets.length;t++)e.push({name:"activePet"+hero.activePets[t],src:"/images/game-world/npcs/"+hero.allPets[hero.activePets[t]].src});Loader.preload(e,prepareCoreAssets,loadingProgress)}function prepareCoreAssets(){if(heroImg=Loader.getImage("heroImg"),shadowImg=Loader.getImage("shadowImg"),hasActivePet)for(var e=0;e<hero.activePets.length;e++)activePetImages[e]=Loader.getImage("activePet"+hero.activePets[e]);getColours()}function loadCardData(){getJSON("/game-world/getCardDetails.php",function(e){cardGameNameSpace.allCardData=e.cards,loadMap()},function(e){loadCardData()})}function loadMapJSON(e){getJSON(e,function(e){var t,a;thisMapData=e.map;var n=0,i=0;if(-1!=hero.tileX.toString().indexOf("?")&&((t=hero.tileX.toString().substring(1)).length>0&&(n=parseInt(t)),hero.tileX=thisMapData.entrance[0]+n),-1!=hero.tileY.toString().indexOf("?")&&((a=hero.tileY.toString().substring(1)).length>0&&(i=parseInt(a)),hero.tileY=thisMapData.entrance[1]+i),hasActivePet){var o=0,r=0;switch(hero.facing){case"n":r=1;break;case"s":r=-1;break;case"e":o=-1;break;case"w":o=1}for(var s=0;s<hero.activePets.length;s++)hero.allPets[hero.activePets[s]].tileX=hero.tileX+o*(s+1),hero.allPets[hero.activePets[s]].tileY=hero.tileY+r*(s+1),hero.allPets[hero.activePets[s]].state=0==s?"moving":"queuing",hero.allPets[hero.activePets[s]].facing=hero.facing}if(mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length,previousZoneName!=thisMapData.zoneName&&(UI.showZoneName(thisMapData.zoneName),document.title=titleTagPrefix+" - "+thisMapData.zoneName,cartographicTitle.innerHTML=thisMapData.zoneName),initCartographicMap(),thisMapData.showOnlyLineOfSight){lightMap=[];for(var c=mapTilesY-1;c>=0;c--){for(var l=[],d=mapTilesX-1;d>=0;d--)l[d]=0;lightMap[c]=l}updateLightMap()}thisMapData.ambientSounds&&audio.loadAmbientSounds(thisMapData.ambientSounds),fae.recentHotspots=[],findProfessionsAndRecipes()},function(t){console.log("retrying..."+e),loadMapJSON(e)})}function loadMap(){var e;newMap<0&&currentMap>0?(randomDungeonName=randomDungeons[Math.abs(newMap)],newMap=-1):e="/game-world/getMap.php?chr="+characterId+"&map="+newMap,newMap<0&&(e="/game-world/generateCircularDungeonMap.php?dungeonName="+randomDungeonName+"&requestedMap="+newMap),currentMap=newMap,loadMapJSON(e)}function loadMapAssets(){var e,t;imagesToLoad=[];var a,n=currentMap;currentMap<0&&(n="dungeon/"+randomDungeonName),-1!==newMap.toString().indexOf("housing")?imagesToLoad.push({name:"backgroundImg",src:"/images/game-world/maps/housing/bg-"+mapTilesX+"x"+mapTilesY+".png"}):imagesToLoad.push({name:"backgroundImg",src:"/images/game-world/maps/"+n+"/bg.png"}),tileGraphicsToLoad=thisMapData.graphics;for(var i=0;i<tileGraphicsToLoad.length;i++)-1!==tileGraphicsToLoad[i].src.indexOf("housing")?imagesToLoad.push({name:"tile"+i,src:"/images/game-world/maps/"+tileGraphicsToLoad[i].src}):imagesToLoad.push({name:"tile"+i,src:"/images/game-world/maps/"+n+"/"+tileGraphicsToLoad[i].src});npcGraphicsToLoad=[];for(i=0;i<thisMapData.npcs.length;i++)a="npc"+thisMapData.npcs[i].name,-1==npcGraphicsToLoad.indexOf(a)&&(imagesToLoad.push({name:a,src:"/images/game-world/npcs/"+thisMapData.npcs[i].src}),npcGraphicsToLoad.push(a));for(i=0;i<thisMapData.items.length;i++)if("nest"==currentActiveInventoryItems[thisMapData.items[i].type].action)for(var o=0;o<thisMapData.items[i].contains.length;o++)a="npc"+thisMapData.items[i].contains[o].name,-1==npcGraphicsToLoad.indexOf(a)&&(imagesToLoad.push({name:a,src:"/images/game-world/npcs/"+thisMapData.items[i].contains[o].src}),npcGraphicsToLoad.push(a));itemGraphicsToLoad=[];var r="";for(i=0;i<thisMapData.items.length;i++)e="",thisMapData.items[i].colour&&""!=(t=getColourName(thisMapData.items[i].colour,thisMapData.items[i].type))&&(e="-"+t.toLowerCase()),r="item"+thisMapData.items[i].type+e,-1==itemGraphicsToLoad.indexOf(r)&&(imagesToLoad.push({name:r,src:"/images/game-world/items/"+currentActiveInventoryItems[thisMapData.items[i].type].worldSrc+e+".png"}),itemGraphicsToLoad.push(r));for(var i in thisMapData.hiddenResources)for(var o in thisMapData.hiddenResources[i])r="item"+thisMapData.hiddenResources[i][o].type,-1==itemGraphicsToLoad.indexOf(r)&&(imagesToLoad.push({name:r,src:"/images/game-world/items/"+currentActiveInventoryItems[thisMapData.hiddenResources[i][o].type].worldSrc+".png"}),itemGraphicsToLoad.push(r));Loader.preload(imagesToLoad,prepareGame,loadingProgress)}function loadTitles(){var e=[];for(var t in questData)""!=questData[t].titleGainedAfterCompletion&&e.push(questData[t].titleGainedAfterCompletion);var a=e.concat(hero.titlesEarned).join("|");getJSON("/game-world/getTitles.php?whichIds="+a,function(e){possibleTitles=e,loadCardData()},function(e){loadTitles()})}function getColours(){getJSON("/game-world/getColours.php",function(e){colourNames=e.colourNames,getQuestDetails()},function(e){getColours()})}function getQuestDetails(){getJSON("/game-world/getQuestDetails.php?chr="+characterId,function(e){questData=e.quests,loadTitles()},function(e){getQuestDetails()})}function findProfessionsAndRecipes(){loadProfessionsAndRecipes(hero.recipesKnown.join("|"))}function loadProfessionsAndRecipes(e){getJSON("/game-world/getProfessionsAndRecipes.php?whichIds="+e,function(e){hero.crafting=e.professions,currentItemGroupFilters=e.itemGroups,getShopData()},function(t){loadProfessionsAndRecipes(e)})}function getShopData(){if(thisMapShopItemIds="",0==thisMapData.shops.length)findInventoryItemData();else{for(var e=JSON.parse('{"mapNumber": "'+currentMap+'","region":"'+thisMapData.region+'","shops": '+JSON.stringify(thisMapData.shops)+"}"),t=0;t<e.shops.length;t++)e.shops[t].hash=generateHash(e.shops[t].name);loadShopData("shopData="+JSON.stringify(e))}}function loadShopData(e){getJSONWithParams("/game-world/getShopItems.php",e,function(e){thisMapShopItemIds=e.allItemIds,UI.buildShop(e.markup),getQuestJournal()},function(t){loadShopData(e)})}function getQuestJournal(){getJSON("/game-world/getQuestJournalEntries.php?chr="+characterId,function(e){UI.buildQuestJournal(e.markup,e.regions),findInventoryItemData()},function(e){getQuestJournal()})}function findInventoryItemData(){var e,t,a=[];for(var n in hero.inventory)if(a.push(hero.inventory[n].type),void 0!==hero.inventory[n].contains)for(var i=0;i<hero.inventory[n].contains.length;i++)a.push(hero.inventory[n].contains[i].type);for(i=0;i<hero.bags.length;i++)a.push(hero.bags[i].type);for(i=0;i<thisMapData.items.length;i++)if(a.push(thisMapData.items[i].type),void 0!==thisMapData.items[i].contains)for(var o=0;o<thisMapData.items[i].contains.length;o++)if(void 0!==thisMapData.items[i].contains[o].type){e=thisMapData.items[i].contains[o].type.toString().split("/");for(var r=0;r<e.length;r++)"$"!=e[r]&&a.push(e[r])}for(var i in thisMapData.hiddenResources)for(var o in thisMapData.hiddenResources[i])if(a.push(thisMapData.hiddenResources[i][o].type),thisMapData.hiddenResources[i][o].contains)for(var r in thisMapData.hiddenResources[i][o].contains){t=thisMapData.hiddenResources[i][o].contains[r].type.split("/");for(var s=0;s<t.length;s++)a.push(t[s])}for(var i in hero.crafting)for(var o in hero.crafting[i].filters.All)for(var r in a.push(hero.crafting[i].recipes[hero.crafting[i].filters.All[o]].creates),hero.crafting[i].recipes[hero.crafting[i].filters.All[o]].components)isNaN(hero.crafting[i].recipes[hero.crafting[i].filters.All[o]].components[r].type)||a.push(hero.crafting[i].recipes[hero.crafting[i].filters.All[o]].components[r].type);""!=thisMapShopItemIds&&a.push(thisMapShopItemIds),loadInventoryItemData((a=uniqueValues(a)).join("|"))}function loadInventoryItemData(e){getJSON("/game-world/getInventoryItems.php?whichIds="+e,function(e){currentActiveInventoryItems=e,inventoryInterfaceIsBuilt||UI.buildInventoryInterface(),loadMapAssets()},function(t){loadInventoryItemData(e)})}function initialiseNPC(e){thisMapData.npcs[e].x=getTileCentreCoordX(thisMapData.npcs[e].tileX),thisMapData.npcs[e].y=getTileCentreCoordY(thisMapData.npcs[e].tileY),thisMapData.npcs[e].z=getElevation(thisMapData.npcs[e].tileX,thisMapData.npcs[e].tileY),thisMapData.npcs[e].drawnFacing=thisMapData.npcs[e].facing,thisMapData.npcs[e].dx=0,thisMapData.npcs[e].dy=0,void 0===thisMapData.npcs[e].speechIndex&&(thisMapData.npcs[e].speechIndex=0),thisMapData.npcs[e].currentAnimation="walk",thisMapData.npcs[e].movementIndex=-1,thisMapData.npcs[e].forceNewMovementCheck=!0,thisMapData.npcs[e].lastTargetDestination=""}function initialiseItem(e){thisMapData.items[e].x=getTileCentreCoordX(thisMapData.items[e].tileX),thisMapData.items[e].y=getTileCentreCoordY(thisMapData.items[e].tileY),thisMapData.items[e].z=getElevation(thisMapData.items[e].tileX,thisMapData.items[e].tileY),thisMapData.items[e].width=currentActiveInventoryItems[thisMapData.items[e].type].width,thisMapData.items[e].length=currentActiveInventoryItems[thisMapData.items[e].type].length,thisMapData.items[e].centreX=currentActiveInventoryItems[thisMapData.items[e].type].centreX,thisMapData.items[e].centreY=currentActiveInventoryItems[thisMapData.items[e].type].centreY,thisMapData.items[e].spriteWidth=currentActiveInventoryItems[thisMapData.items[e].type].spriteWidth,thisMapData.items[e].spriteHeight=currentActiveInventoryItems[thisMapData.items[e].type].spriteHeight,"node"==currentActiveInventoryItems[thisMapData.items[e].type].action&&(thisMapData.items[e].timeLastHarvested||(thisMapData.items[e].timeLastHarvested=hero.totalGameTimePlayed-currentActiveInventoryItems[thisMapData.items[e].type].respawnRate),void 0===thisMapData.items[e].stability&&(thisMapData.items[e].stability=thisMapData.items[e].maxStability),void 0===thisMapData.items[e].quantity&&(thisMapData.items[e].quantity=thisMapData.items[e].maxQuantity)),"nest"==currentActiveInventoryItems[thisMapData.items[e].type].action&&(thisMapData.items[e].timeLastSpawned=hero.totalGameTimePlayed,thisMapData.items[e].spawnsRemaining=thisMapData.items[e].additional)}function prepareGame(){tileImages=[];for(var e=0;e<tileGraphicsToLoad.length;e++)tileImages[e]=Loader.getImage("tile"+e);npcImages=[];for(e=0;e<npcGraphicsToLoad.length;e++)npcImages[npcGraphicsToLoad[e]]=Loader.getImage(npcGraphicsToLoad[e]);itemImages=[];for(e=0;e<itemGraphicsToLoad.length;e++)itemImages[itemGraphicsToLoad[e]]=Loader.getImage(itemGraphicsToLoad[e]);backgroundImg=Loader.getImage("backgroundImg");for(e=0;e<thisMapData.npcs.length;e++)initialiseNPC(e);if(hasActivePet)for(e=0;e<hero.activePets.length;e++){hero.allPets[hero.activePets[e]].x=getTileCentreCoordX(hero.allPets[hero.activePets[e]].tileX),hero.allPets[hero.activePets[e]].y=getTileCentreCoordY(hero.allPets[hero.activePets[e]].tileY),hero.allPets[hero.activePets[e]].tileX<0||hero.allPets[hero.activePets[e]].tileY<0||hero.allPets[hero.activePets[e]].tileX>=mapTilesX||hero.allPets[hero.activePets[e]].tileY>=mapTilesY?hero.allPets[hero.activePets[e]].z=hero.allPets[hero.activePets[e-1]].z:hero.allPets[hero.activePets[e]].z=getElevation(hero.allPets[hero.activePets[e]].tileX,hero.allPets[hero.activePets[e]].tileY),hero.allPets[hero.activePets[e]].dx=0,hero.allPets[hero.activePets[e]].dy=0,hero.allPets[hero.activePets[e]].foundPath="","queuing"!=hero.allPets[hero.activePets[e]].state&&(hero.allPets[hero.activePets[e]].state="wait"),hero.allPets[hero.activePets[e]].following=0==e?hero:hero.allPets[hero.activePets[e-1]],hero.allPets[hero.activePets[e]].breadcrumb=[];for(var t=0;t<breadCrumbLength;t++)hero.allPets[hero.activePets[e]].breadcrumb[t]=[hero.allPets[hero.activePets[e]].tileX,hero.allPets[hero.activePets[e]].tileY]}if(thisMapData.movingPlatforms){var a,n;for(e=0;e<thisMapData.movingPlatforms.length;e++)(a=thisMapData.movingPlatforms[e]).x=getTileCentreCoordX(a.startTileX),a.y=getTileCentreCoordY(a.startTileY),a.z=a.startZ,a.movementIndex=0,a.waitingTimer=0,a.canMove=!0,n=determinePlatformIncrements(a),a.dx=n[0],a.dy=n[1],a.dz=n[2]}for(e=0;e<breadCrumbLength;e++)hero.breadcrumb[e]=[hero.tileX,hero.tileY];for(e=0;e<thisMapData.items.length;e++)initialiseItem(e);activeObjectForDialogue="",hero.x=getTileCentreCoordX(hero.tileX),hero.y=getTileCentreCoordY(hero.tileY),hero.z=getElevation(hero.tileX,hero.tileY),fae.x=hero.x+2*tileW,fae.y=hero.y+2*tileH,fae.currentState="hero",fae.z=hero.z,fae.dz=1,setupWeather(),timeSinceLastFrameSwap=0,currentAnimationFrame=0,mapTransition="in",mapTransitionCurrentFrames=1,gameMode="play"}function removeMapAssets(){for(var e=0;e<tileGraphicsToLoad.length;e++)tileImages[e].onerror="",tileImages[e].src="",tileImages[e]=null;for(var e in npcGraphicsToLoad)npcImages[npcGraphicsToLoad[e]].onerror="",npcImages[npcGraphicsToLoad[e]].src="",npcImages[npcGraphicsToLoad[e]]=null;for(var e in itemGraphicsToLoad)itemImages[itemGraphicsToLoad[e]].onerror="",itemImages[itemGraphicsToLoad[e]].src="",itemImages[itemGraphicsToLoad[e]]=null;backgroundImg.onerror="",backgroundImg.src="",backgroundImg=null}function loadingProgress(){}function changeMaps(e,t){if(previousZoneName=thisMapData.zoneName,gameMode="mapLoading",removeMapAssets(),null==jumpMapId){var a=thisMapData.doors,n=e+","+t;hero.tileX=a[n].startX,hero.tileY=a[n].startY,newMap=a[n].map}else newMap=jumpMapId,jumpMapId=null,hero.tileX=parseInt(e),hero.tileY=parseInt(t);loadMap()}function tileIsClear(e,t){if(e<0||t<0||e>=mapTilesX||t>=mapTilesY)return!1;switch(thisMapData.collisions[t][e]){case 1:return!1;case"<":case">":case"^":case"v":case"d":return!1}if(e==hero.tileX&&t==hero.tileY)return!1;for(var a=0;a<thisMapData.items.length;a++)if(e==thisMapData.items[a].tileX&&t==thisMapData.items[a].tileY)return!1;if(hasActivePet)for(a=0;a<hero.activePets.length;a++)if(e==hero.allPets[hero.activePets[a]].tileX&&t==hero.allPets[hero.activePets[a]].tileY)return!1;for(a=0;a<thisMapData.npcs.length;a++)if(thisMapData.npcs[a].isCollidable&&e==thisMapData.npcs[a].tileX&&t==thisMapData.npcs[a].tileY)return!1;return!0}function isATerrainCollision(e,t){var a=getTileX(e),n=getTileY(t);if(a<0||n<0||a>=mapTilesX||n>=mapTilesY)return 1;switch(thisMapData.collisions[n][a]){case 1:return 1;case"<":case">":case"^":case"v":case"d":default:return 0}}function startDoorTransition(){""==mapTransition&&(mapTransitionCurrentFrames=1,mapTransition="out",""!=activeObjectForDialogue&&(dialogue.classList.remove("active"),UI.removeActiveDialogue()),-1!=chestIdOpen&&UI.closeChest()),saveCartographyMask()}function getHeroAsCloseAsPossibleToObject(e,t,a,n){switch(hero.facing){case"n":hero.y=t+n/2+hero.length/2+1;break;case"s":hero.y=t-n/2-hero.length/2-1;break;case"w":hero.x=e+a/2+hero.width/2+1;break;case"e":hero.x=e-a/2-hero.width/2-1}}function isOnAPlatform(e,t){var a,n=-1;if(thisMapData.movingPlatforms)for(var i=0;i<thisMapData.movingPlatforms.length;i++)if(t>=(a=thisMapData.movingPlatforms[i]).y-tileW/2&&t<=a.y+tileW/2+(a.length-1)*tileW&&e>=a.x-tileW/2&&e<=a.x+tileW/2+(a.width-1)*tileW){n=i;break}return n}function checkHeroCollisions(){var e,t,a,n,i,o,r,s,c,l;if(key[2])if(o=isOnAPlatform(hero.x-hero.width/2,hero.y-hero.length/2),r=isOnAPlatform(hero.x+hero.width/2,hero.y-hero.length/2),(o>-1||!isATerrainCollision(hero.x-hero.width/2,hero.y-hero.length/2))&&(r>-1||!isATerrainCollision(hero.x+hero.width/2,hero.y-hero.length/2)));else if(isOnAPlatform(hero.x-hero.width/2,hero.y+hero.length/2)>-1&&isOnAPlatform(hero.x+hero.width/2,hero.y+hero.length/2)>-1)-1==o&&-1==r&&(hero.y=thisMapData.movingPlatforms[isOnAPlatform(hero.x-hero.width/2,hero.y+hero.length/2)].y-tileW/2+hero.length/2+1);else{var d=(getTileY(hero.y-hero.length/2)+1)*tileW;hero.y=d+hero.length/2+1}if(key[3])if(o=isOnAPlatform(hero.x-hero.width/2,hero.y+hero.length/2),r=isOnAPlatform(hero.x+hero.width/2,hero.y+hero.length/2),(o>-1||!isATerrainCollision(hero.x-hero.width/2,hero.y+hero.length/2))&&(r>-1||!isATerrainCollision(hero.x+hero.width/2,hero.y+hero.length/2)));else if(isOnAPlatform(hero.x-hero.width/2,hero.y-hero.length/2)>-1&&isOnAPlatform(hero.x+hero.width/2,hero.y-hero.length/2)>-1)-1==o&&-1==r&&(hero.y=thisMapData.movingPlatforms[isOnAPlatform(hero.x-hero.width/2,hero.y-hero.length/2)].y+tileW/2+(thisMapData.movingPlatforms[isOnAPlatform(hero.x-hero.width/2,hero.y-hero.length/2)].length-1)*tileW-hero.length/2-1);else{var h=getTileY(hero.y+hero.length/2)*tileW;hero.y=h-hero.length/2-1}if(key[0])if(o=isOnAPlatform(hero.x-hero.width/2,hero.y+hero.length/2),r=isOnAPlatform(hero.x-hero.width/2,hero.y-hero.length/2),(o>-1||!isATerrainCollision(hero.x-hero.width/2,hero.y+hero.length/2))&&(r>-1||!isATerrainCollision(hero.x-hero.width/2,hero.y-hero.length/2)));else if(isOnAPlatform(hero.x+hero.width/2,hero.y-hero.length/2)>-1&&isOnAPlatform(hero.x+hero.width/2,hero.y+hero.length/2)>-1)-1==o&&-1==r&&(hero.x=thisMapData.movingPlatforms[isOnAPlatform(hero.x+hero.width/2,hero.y-hero.length/2)].x-tileW/2+hero.length/2+1);else{var u=(getTileX(hero.x-hero.width/2)+1)*tileW;hero.x=u+hero.width/2+1}if(key[1])if(o=isOnAPlatform(hero.x+hero.width/2,hero.y+hero.length/2),r=isOnAPlatform(hero.x+hero.width/2,hero.y-hero.length/2),(o>-1||!isATerrainCollision(hero.x+hero.width/2,hero.y+hero.length/2))&&(r>-1||!isATerrainCollision(hero.x+hero.width/2,hero.y-hero.length/2)));else if(isOnAPlatform(hero.x-hero.width/2,hero.y-hero.length/2)>-1&&isOnAPlatform(hero.x-hero.width/2,hero.y+hero.length/2)>-1)-1==o&&-1==r&&(hero.x=thisMapData.movingPlatforms[isOnAPlatform(hero.x-hero.width/2,hero.y-hero.length/2)].x+tileW/2+(thisMapData.movingPlatforms[isOnAPlatform(hero.x-hero.width/2,hero.y-hero.length/2)].width-1)*tileW-hero.length/2-1);else{var g=getTileX(hero.x+hero.width/2)*tileW;hero.x=g-hero.width/2-1}if(thisMapData.movingPlatforms)for(var p=0;p<thisMapData.movingPlatforms.length;p++)thisMapData.movingPlatforms[p].canMove=!0;e=isOnAPlatform(hero.x-hero.width/2,hero.y-hero.length/2),t=isOnAPlatform(hero.x+hero.width/2,hero.y-hero.length/2),a=isOnAPlatform(hero.x-hero.width/2,hero.y+hero.length/2),n=isOnAPlatform(hero.x+hero.width/2,hero.y+hero.length/2),e>=0&&(i=e==a&&a==t&&t==n),i?e>=0&&(hero.x+=thisMapData.movingPlatforms[e].dx,hero.y+=thisMapData.movingPlatforms[e].dy,hero.z+=thisMapData.movingPlatforms[e].dz):(e>=0&&(thisMapData.movingPlatforms[e].canMove=!1),t>=0&&(thisMapData.movingPlatforms[t].canMove=!1),a>=0&&(thisMapData.movingPlatforms[a].canMove=!1),n>=0&&(thisMapData.movingPlatforms[n].canMove=!1));for(p=0;p<thisMapData.npcs.length;p++)(s=thisMapData.npcs[p]).isCollidable&&isAnObjectCollision(s.x,s.y,s.width,s.length,hero.x,hero.y,hero.width,hero.length)&&getHeroAsCloseAsPossibleToObject(s.x,s.y,s.width,s.length);for(p=0;p<thisMapData.items.length;p++)isAnObjectCollision((c=thisMapData.items[p]).x,c.y,c.width,c.length,hero.x,hero.y,hero.width,hero.length)&&getHeroAsCloseAsPossibleToObject(c.x,c.y,c.width,c.length);if(hasActivePet)for(p=0;p<hero.activePets.length;p++)isAnObjectCollision(hero.allPets[hero.activePets[p]].x,hero.allPets[hero.activePets[p]].y,hero.allPets[hero.activePets[p]].width,hero.allPets[hero.activePets[p]].length,hero.x,hero.y,hero.width,hero.length)&&(getHeroAsCloseAsPossibleToObject(hero.allPets[hero.activePets[p]].x,hero.allPets[hero.activePets[p]].y,hero.allPets[hero.activePets[p]].width,hero.allPets[hero.activePets[p]].length),pushPetAway(p));if(void 0!==thisMapData.innerDoors)for(var p in thisMapData.innerDoors)if(!(l=thisMapData.innerDoors[p]).isOpen&&isAnObjectCollision(getTileCentreCoordX(l.tileX),getTileCentreCoordY(l.tileY),tileW,tileW,hero.x,hero.y,hero.width,hero.length)){if(l.isLocked){var m=hero.currency.keys.indexOf(p);-1!=m&&(unlockInnerDoor(p),openInnerDoor(p),hero.currency.keys.splice(m,1),UI.updateCurrencies())}else openInnerDoor(p);getHeroAsCloseAsPossibleToObject(getTileCentreCoordX(l.tileX),getTileCentreCoordY(l.tileY),tileW,tileW)}}function gameLoop(){switch(gameMode){case"mapLoading":case"paused":break;case"cardGame":cardGameNameSpace.update(),cardGameNameSpace.draw();var e=window.performance.now();hero.totalGameTimePlayed++;var t=e-lastTime;lastTime=e,(timeSinceLastFrameSwap+=t)>animationUpdateTime&&(currentAnimationFrame++,timeSinceLastFrameSwap=0,animateFae()),moveFae(),moveNPCs(),movePet(),movePlatforms(),updateItems(),audio.checkForAmbientSounds(),checkForRespawns(),UI.updateCooldowns(),draw();break;case"play":update(),draw()}window.requestAnimationFrame(gameLoop)}function update(){checkForGamePadInput();var e=window.performance.now();hero.totalGameTimePlayed++;var t=e-lastTime;lastTime=e,hero.isMoving=!1;var a=hero.speed;if(key[5]&&(a*=2),"out"!=mapTransition){key[2]?(hero.isMoving=!0,hero.facing="n",hero.y-=a):key[3]?(hero.isMoving=!0,hero.facing="s",hero.y+=a):key[1]?(hero.isMoving=!0,hero.facing="e",hero.x+=a):key[0]&&(hero.isMoving=!0,hero.facing="w",hero.x-=a),key[4]&&checkForActions(),key[6]&&checkForChallenges(),key[7]&&(UI.toggleUI(),key[7]=!1),key[8]&&(UI.toggleJournal(),key[8]=!1),checkHeroCollisions();var n=hero.tileX,i=hero.tileY;hero.tileX=getTileX(hero.x),hero.tileY=getTileY(hero.y),hero.tileX==n&&hero.tileY==i||heroIsInNewTile(),""!=activeObjectForDialogue&&null!=activeObjectForDialogue&&(isInRange(hero.x,hero.y,activeObjectForDialogue.x,activeObjectForDialogue.y,closeDialogueDistance)||(dialogue.classList.add("slowerFade"),dialogue.classList.remove("active"),-1!=shopCurrentlyOpen&&(activeObjectForDialogue.speechIndex=0,UI.closeShop()),acceptQuestChoice.classList.remove("active"),dialogue.addEventListener(whichTransitionEvent,UI.removeActiveDialogue,!1))),-1!=chestIdOpen&&(isInRange(hero.x,hero.y,thisMapData.items[chestIdOpen].x,thisMapData.items[chestIdOpen].y,closeDialogueDistance/2)||UI.closeChest()),"gather"==activeAction&&(isInRange(hero.x,hero.y,thisMapData.items[gathering.itemIndex].x,thisMapData.items[gathering.itemIndex].y,closeDialogueDistance/2)||(gatheringPanel.classList.remove("active"),gatheringStopped())),postObject.active&&(isInRange(hero.x,hero.y,postObject.x,postObject.y,closeDialogueDistance/2)||UI.closePost()),retinueObject.active&&(isInRange(hero.x,hero.y,retinueObject.x,retinueObject.y,closeDialogueDistance/2)||UI.closeRetinuePanel())}else{if(null==jumpMapId)switch(hero.isMoving=!0,hero.facing){case"n":hero.y-=a;break;case"s":hero.y+=a;break;case"e":hero.x+=a;break;case"w":hero.x-=a}++mapTransitionCurrentFrames>=mapTransitionMaxFrames&&changeMaps(activeDoorX,activeDoorY)}"in"==mapTransition&&(mapTransitionCurrentFrames+=2)>=mapTransitionMaxFrames&&(mapTransition="",activeDoorX=-1,activeDoorY=-1),(timeSinceLastFrameSwap+=t)>animationUpdateTime&&(currentAnimationFrame++,timeSinceLastFrameSwap=0,animateFae()),moveFae(),moveNPCs(),movePet(),movePlatforms(),updateItems(),checkForWeatherChange(),audio.checkForAmbientSounds(),checkForRespawns(),UI.updateCooldowns(),"gather"==activeAction&&processGathering(),"dowse"==activeAction&&processDowsing(),"survey"==activeAction&&processSurveying(),retinueObject.active&&UI.updateRetinueTimers(),craftingObject.isCreating&&processCrafting()}function heroIsInNewTile(){var e,t,a;hero.z=getElevation(getTileX(hero.x),getTileY(hero.y)),updateCartographicMiniMap();for(var n=0;n<thisMapData.hotspots.length;n++)t=getTileCentreCoordX((e=thisMapData.hotspots[n]).centreX),a=getTileCentreCoordY(e.centreY),isInRange(hero.x,hero.y,t,a,e.radius*tileW)&&(void 0!==e.quest&&(questData[e.quest].hasBeenActivated<1&&UI.showNotification("<p>"+e.message+"</p>"),questData[e.quest].hasBeenActivated=1),void 0!==e.music&&audio.playMusic(e.music),void 0!==e.weather&&changeWeather(e.weather),void 0!==e.openInnerDoor&&(unlockInnerDoor(e.openInnerDoor),openInnerDoor(e.openInnerDoor)),void 0!==e.closeInnerDoor&&closeInnerDoor(e.closeInnerDoor),void 0!==e.toggleInnerDoor&&toggleInnerDoor(e.toggleInnerDoor),void 0!==e.remove&&(thisMapData.hotspots.splice(n,1),n--)),"hero"==fae.currentState&&void 0===e.faeIgnore&&-1===fae.recentHotspots.indexOf(n)&&isInRange(fae.x,fae.y,t,a,fae.range)&&hasLineOfSight(getTileX(fae.x),getTileX(fae.y),e.centreX,e.centreY)&&(fae.targetX=t,fae.targetY=a,fae.recentHotspots.push(n),fae.currentState="away");"wait"==fae.currentState&&(isInRange(fae.x,fae.y,hero.x,hero.y,fae.abandonRadius)||hasLineOfSight(getTileX(fae.x),getTileX(fae.y),hero.tileX,hero.tileY)&&(fae.currentState="hero")),hero.breadcrumb.pop(),hero.breadcrumb.unshift([hero.tileX,hero.tileY]),thisMapData.showOnlyLineOfSight&&updateLightMap(),"d"==thisMapData.collisions[hero.tileY][hero.tileX]&&(activeDoorX=hero.tileX,activeDoorY=hero.tileY,startDoorTransition()),"survey"==activeAction&&surveyingStopped()}function openInnerDoor(e){thisMapData.innerDoors[e].isOpen=!0,thisMapData.showOnlyLineOfSight&&updateLightMap()}function closeInnerDoor(e){tileIsClear(thisMapData.innerDoors[e].tileX,thisMapData.innerDoors[e].tileY)&&(thisMapData.innerDoors[e].isOpen=!1,thisMapData.showOnlyLineOfSight&&updateLightMap())}function toggleInnerDoor(e){tileIsClear(thisMapData.innerDoors[e].tileX,thisMapData.innerDoors[e].tileY)&&(thisMapData.innerDoors[e].isOpen=!thisMapData.innerDoors[e].isOpen,thisMapData.showOnlyLineOfSight&&updateLightMap())}function unlockInnerDoor(e){audio.playSound(soundEffects.unlock,0),thisMapData.innerDoors[e].isLocked=!1,thisMapData.showOnlyLineOfSight&&updateLightMap()}function checkForActions(){for(var e,t=[],a=0;a<thisMapData.items.length;a++)if(isInRange(hero.x,hero.y,thisMapData.items[a].x,thisMapData.items[a].y,thisMapData.items[a].width/2+hero.width/2+6)&&isFacing(hero,thisMapData.items[a])){var n=currentActiveInventoryItems[thisMapData.items[a].type].actionValue;switch(currentActiveInventoryItems[thisMapData.items[a].type].action){case"static":case"nest":break;case"sound":audio.playSound(soundEffects[n],0);break;case"questToggle":questData[n].hasBeenActivated=Math.abs(questData[n].hasBeenActivated-1);break;case"questSet":questData[n].hasBeenActivated=1;break;case"questUnset":questData[n].hasBeenActivated=0;break;case"node":break;case"toggleInnerDoor":toggleInnerDoor(thisMapData.items[a].additional),audio.playSound(soundEffects.lever,0),thisMapData.items[a].state="on"==thisMapData.items[a].state?"off":"on";break;case"openInnerDoor":openInnerDoor(thisMapData.items[a].additional);break;case"closeInnerDoor":closeInnerDoor(thisMapData.items[a].additional);break;case"key":hero.currency.keys.push(thisMapData.items[a].additional),UI.updateCurrencies(),audio.playSound(soundEffects.keys,0),thisMapData.items.splice(a,1);break;case"notice":processSpeech(thisMapData.items[a],thisMapData.items[a].contains[0][0],thisMapData.items[a].contains[0][1],!1,thisMapData.items[a].contains[0][2]);break;case"sit":hero.facing=thisMapData.items[a].facing,console.log("switch to sit animation");break;case"chest":UI.openChest(a);break;case"post":UI.openPost(thisMapData.items[a].x,thisMapData.items[a].y);break;case"retinue":UI.openRetinuePanel(thisMapData.items[a]);break;default:(t=canAddItemToInventory([thisMapData.items[a]]))[0]?(thisMapData.items.splice(a,1),UI.showChangeInInventory(t[1])):UI.showNotification("<p>Oops - sorry, no room in your bags</p>")}}for(a=0;a<thisMapData.npcs.length;a++)if((e=thisMapData.npcs[a]).speech&&isInRange(hero.x,hero.y,e.x,e.y,e.width+hero.width)&&isFacing(hero,e))if(e.speechIndex>=e.speech.length||canCloseDialogueBalloonNextClick&&activeObjectForDialogue==e)e.speechIndex=0,dialogue.classList.remove("active"),activeObjectForDialogue="",canCloseDialogueBalloonNextClick=!1,-1!=shopCurrentlyOpen&&UI.closeShop();else{var i=e.speech[e.speechIndex][0],o=e.speech[e.speechIndex][1];e.drawnFacing=turntoFace(e,hero),processSpeech(e,i,o,!0),e.speechIndex++}key[4]=0}function processSpeech(e,t,a,n,i){thisSpeech=t,n=void 0!==n&&n;for(var o=a.split(","),r=0;r<o.length;r++)switch(o[r]){case"once":e.speech.splice(e.speechIndex,1),e.speechIndex--;break;case"move":e.forceNewMovementCheck=!0,e.isMoving=!0;break;case"shop":UI.openShop(generateHash(e.speech[e.speechIndex][2]));break;case"post":UI.openPost(e.x,e.y);break;case"retinue":UI.openRetinuePanel(e);break;case"sound":audio.playSound(soundEffects[e.speech[e.speechIndex][2]],0);break;case"profession":var s=e.speech[e.speechIndex][2];-1==hero.professionsKnown.indexOf(s)&&(hero.professionsKnown.push(s),UI.showNewProfession(s));break;case"follower":e.speech[e.speechIndex][2];break;case"collection-quest":var c=thisSpeech.split("|"),l=e.speech[e.speechIndex][2];if(hero.collections.hasOwnProperty(l)){var d=!1;for(var h in hero.collections[l].required)if(hero.collections[l].required[h]>0){d=!0;break}if(d)thisSpeech=c[1];else{var u=e.speech[e.speechIndex];void 0!==u[3]&&awardQuestRewards(e,[u[3]],!0),thisSpeech=c[2],hero.collections[l].complete=!0,UI.completeCollectionQuestPanel(l)}}else thisSpeech=c[0],hero.collections[l]={},hero.collections[l].required=thisMapData.collection,hero.collections[l].complete=!1,UI.initiateCollectionQuestPanel(l);break;case"quest":case"quest-no-open":case"quest-no-close":case"quest-no-open-no-close":case"quest-optional":var g,p=thisSpeech.split("|");if(g=void 0!==e.speech?e.speech[e.speechIndex][2]:i,questData[g].isUnderway)if("quest"==o[r]||"quest-no-open"==o[r]||"quest-optional"==o[r])switch(questData[g].whatIsRequiredForCompletion){case"possess":case"give":case"":if(hasItemsInInventory(questData[g].itemsNeededForCompletion)){if("give"==questData[g].whatIsRequiredForCompletion)for(r=0;r<questData[g].itemsNeededForCompletion.length;r++)removeItemTypeFromInventory(questData[g].itemsNeededForCompletion[r].type,questData[g].itemsNeededForCompletion[r].quantity);thisSpeech=p[2],closeQuest(e,g)}else thisSpeech=p[1],e.speechIndex--;break;case"craft":var m=[];for(r=0;r<questData[g].itemsNeededForCompletion.length;r++)(I=JSON.parse(JSON.stringify(questData[g].itemsNeededForCompletion[r]))).hallmark=0-characterId,m.push(I);hasItemsInInventory(m)?(thisSpeech=p[2],closeQuest(e,g)):(thisSpeech=p[1],e.speechIndex--);break;case"multi":for(var f=questData[g].subQuestsRequiredForCompletion.split(","),v=!0,y=0;y<f.length;y++)switch(questData[f[y]].whatIsRequiredForCompletion){case"possess":case"give":case"":hasItemsInInventory(questData[f[y]].itemsNeededForCompletion)||(v=!1);break;case"craft":var I;for(m=[],r=0;r<questData[g].itemsNeededForCompletion.length;r++)(I=JSON.parse(JSON.stringify(questData[g].itemsNeededForCompletion[r]))).hallmark=0-characterId,m.push(I);hasItemsInInventory(m)||(v=!1);break;case"world":questData[f[y]].hasBeenActivated<1&&(v=!1);break;default:var b=questData[f[y]].valueAtQuestStart,C=accessDynamicVariable(questData[f[y]].whatIsRequiredForCompletion);"+"==questData[f[y]].thresholdNeededForCompletion.charAt(0)?C-b<questData[f[y]].thresholdNeededForCompletion&&(v=!1):C<questData[f[y]].thresholdNeededForCompletion.substring(1)&&(v=!1)}v?(thisSpeech=p[2],closeQuest(e,g)):(thisSpeech=p[1],e.speechIndex--);break;case"escort":void 0!==e.hasCompletedEscortQuest?(thisSpeech=p[2],closeQuest(e,g),delete e.hasCompletedEscortQuest):(thisSpeech=p[1],e.speechIndex--);break;case"world":questData[g].hasBeenActivated>0?(thisSpeech=p[2],closeQuest(e,g)):(thisSpeech=p[1],e.speechIndex--);break;default:b=questData[g].valueAtQuestStart,C=accessDynamicVariable(questData[g].whatIsRequiredForCompletion);console.log(b),console.log(C);var w=!1;"+"==questData[g].thresholdNeededForCompletion.charAt(0)?C-b>=questData[g].thresholdNeededForCompletion&&(w=!0):C>=questData[g].thresholdNeededForCompletion.substring(1)&&(w=!0),w?(thisSpeech=p[2],closeQuest(e,g)):(thisSpeech=p[1],e.speechIndex--)}else questData[g].hasBeenCompleted>0?thisSpeech=p[2]:(thisSpeech=p[1],e.speechIndex--);else"quest-optional"==o[r]?(questResponseNPC=e,acceptQuestChoice.classList.add("active"),thisSpeech=p[0],null!=e&&e.speechIndex--):("quest"!=o[r]&&"quest-no-close"!=o[r]||openQuest(g),thisSpeech=p[0],null!=e&&e.speechIndex--);break;case"play":startCardGame(e)}""!=thisSpeech?(void 0===thisSpeech&&(thisSpeech=p[0]),UI.showDialogue(e,thisSpeech)):e.speechIndex--,canCloseDialogueBalloonNextClick=!1,n||(canCloseDialogueBalloonNextClick=!0)}function updateItems(){for(var e,t,a,n=[[0,1],[0,-1],[1,0],[-1,0]],i=0;i<thisMapData.items.length;i++)e=thisMapData.items[i],"nest"==currentActiveInventoryItems[e.type].action&&e.spawnsRemaining>0&&hero.totalGameTimePlayed-e.timeLastSpawned>=currentActiveInventoryItems[e.type].respawnRate&&(t=e.contains[getRandomIntegerInclusive(1,e.contains.length)-1],a=getRandomElementFromArray(n),t.tileX=e.tileX+a[0],t.tileY=e.tileY+a[1],tileIsClear(t.tileX,t.tileY)&&(thisMapData.npcs.push(JSON.parse(JSON.stringify(t))),initialiseNPC(thisMapData.npcs.length-1),e.spawnsRemaining--,e.timeLastSpawned=hero.totalGameTimePlayed))}function checkForTitlesAwarded(e){if(questData[e].titleGainedAfterCompletion){var t=questData[e].titleGainedAfterCompletion;-1==hero.titlesEarned.indexOf(t)&&(hero.titlesEarned.push(t),UI.showNotification("<p>You earned the &quot;"+possibleTitles[t]+"&quot; title</p>"))}}function checkForChallenges(){for(var e=0;e<thisMapData.npcs.length;e++)if(thisChallengeNPC=thisMapData.npcs[e],isInRange(hero.x,hero.y,thisChallengeNPC.x,thisChallengeNPC.y,thisChallengeNPC.width+hero.width)&&isFacing(hero,thisChallengeNPC)&&thisChallengeNPC.cardGameSpeech){thisChallengeNPC.drawnFacing=turntoFace(thisChallengeNPC,hero),processSpeech(thisChallengeNPC,thisChallengeNPC.cardGameSpeech.challenge[0],thisChallengeNPC.cardGameSpeech.challenge[1]);break}key[6]=0}function jumpToLocation(e,t,a){activeDoorX=t,activeDoorY=a,jumpMapId=e,startDoorTransition()}function moveNPCs(){for(var e,t,a,n,i,o,r,s,c=0;c<thisMapData.npcs.length;c++)if(void 0===(e=thisMapData.npcs[c]).isPlayingCards){if(t=!1,e.isMoving){switch(a=e.x,n=e.y,e.drawnFacing=e.facing,e.facing){case"n":if(e.y-=e.speed,isATerrainCollision(e.x-e.width/2,e.y-e.length/2)||isATerrainCollision(e.x+e.width/2,e.y-e.length/2)){var l=(getTileY(e.y-e.length/2)+1)*tileW;e.y=l+e.length/2+1}break;case"s":if(e.y+=e.speed,isATerrainCollision(e.x-e.width/2,e.y+e.length/2)||isATerrainCollision(e.x+e.width/2,e.y+e.length/2)){var d=getTileY(e.y+e.length/2)*tileW;e.y=d-e.length/2-1}break;case"w":if(e.x-=e.speed,isATerrainCollision(e.x-e.width/2,e.y+e.length/2)||isATerrainCollision(e.x-e.width/2,e.y-e.length/2)){var h=(getTileX(e.x-e.width/2)+1)*tileW;e.x=h+e.width/2+1}break;case"e":if(e.x+=e.speed,isATerrainCollision(e.x+e.width/2,e.y+e.length/2)||isATerrainCollision(e.x+e.width/2,e.y-e.length/2)){var u=getTileX(e.x+e.width/2)*tileW;e.x=u-e.width/2-1}}if(isAnObjectCollision(e.x,e.y,e.width,e.length,hero.x,hero.y,hero.width,hero.length)&&(e.x=a,e.y=n),hasActivePet)for(var g=0;g<hero.activePets.length;g++)isAnObjectCollision(e.x,e.y,e.width,e.length,hero.allPets[hero.activePets[g]].x,hero.allPets[hero.activePets[g]].y,hero.allPets[hero.activePets[g]].width,hero.allPets[hero.activePets[g]].length)&&(e.x=a,e.y=n);for(g=0;g<thisMapData.npcs.length;g++)c!=g&&(i=thisMapData.npcs[g]).isCollidable&&isAnObjectCollision(e.x,e.y,e.width,e.length,i.x,i.y,i.width,i.length)&&(e.x=a,e.y=n);for(g=0;g<thisMapData.items.length;g++)o=thisMapData.items[g],isAnObjectCollision(e.x,e.y,e.width,e.length,o.x,o.y,o.width,o.length)&&(e.x=a,e.y=n);if(void 0!==thisMapData.innerDoors)for(var c in thisMapData.innerDoors)(s=thisMapData.innerDoors[c]).isOpen||isAnObjectCollision(getTileCentreCoordX(s.tileX),getTileCentreCoordY(s.tileY),tileW,tileW,e.x,e.y,e.width,e.length)&&(e.x=a,e.y=n);e.dx+=e.x-a,e.dy+=e.y-n,Math.abs(e.dx)>=tileW&&(e.dx>0?e.dx-=tileW:e.dx+=tileW,t=!0),Math.abs(e.dy)>=tileW&&(e.dy>0?e.dy-=tileW:e.dy+=tileW,t=!0)}if(t||e.forceNewMovementCheck)switch(e.tileX=getTileX(e.x),e.tileY=getTileY(e.y),void 0!==e.following&&(e.forceNewMovementCheck||checkForEscortQuestEnd(e)),e.movementIndex++,e.movementIndex>=e.movement.length&&(e.movementIndex=0),"string"!=typeof(r=e.movement[e.movementIndex])?r[0]:r){case"-":e.isMoving=!1,e.forceNewMovementCheck=!1;break;case"?":do{e.facing=facingsPossible[Math.floor(Math.random()*facingsPossible.length)]}while(isATerrainCollision(e.x+relativeFacing[e.facing].x*tileW,e.y+relativeFacing[e.facing].y*tileW));e.forceNewMovementCheck=!1;break;case"find":e.forceNewMovementCheck=!0,e.waitingForAPath||void 0!==e.waitingTimer?(e.waitingTimer++,e.waitingTimer>r[3]?(e.isMoving=!0,e.currentAnimation="walk",delete e.waitingTimer):(e.movementIndex--,e.isMoving=!1)):(pathfindingWorker.postMessage([r[1],e,thisMapData]),e.isMoving=!1,e.waitingForAPath=!0,e.waitingTimer=0,e.currentAnimation="wait",e.movementIndex--);break;case"proximity":e.forceNewMovementCheck=!0;var p=r[1];isInRange(hero.x,hero.y,e.x,e.y,p*tileW)?e.isMoving=!0:(e.isMoving=!1,e.movementIndex--);break;case"remove":e.movement.splice(e.movementIndex-1,2);break;case"pathEnd":var m;if(void 0!==e.following){for(g=e.movementIndex;g>=0;g--)if("string"==typeof(m=e.movement[g])&&"following"==m){var f=e.movementIndex-g;e.movement.splice(g+1,f),e.movementIndex-=f+1,e.isMoving=!0,e.forceNewMovementCheck=!0,delete e.waitingTimer;break}}else{var v=e.lastTargetDestination.split("-");for(e.drawnFacing=turntoFaceTile(e,v[0],v[1]),g=e.movementIndex;g>=0;g--)if("string"!=typeof(m=e.movement[g])&&"find"==m[0]){f=e.movementIndex-g;e.movement.splice(g+1,f),e.movementIndex-=f,e.isMoving=!1,e.forceNewMovementCheck=!0,delete e.waitingTimer;break}}break;case"talkToNeighbour":for(g=0;g<thisMapData.npcs.length;g++)c!=g&&(i=thisMapData.npcs[g],Math.abs(i.tileX-e.tileX)<=1&&Math.abs(i.tileY-e.tileY)<=1&&(i.drawnFacing=turntoFace(i,e)));break;case"follow":switch(r[1]){case"hero":hero.npcsFollowing.length>0?e.following=hero.npcsFollowing[hero.npcsFollowing[hero.npcsFollowing.length-1]]:hero.activePets.length>0?e.following=hero.allPets[hero.activePets[hero.activePets.length-1]]:e.following=hero,hero.npcsFollowing.push(e),e.movement[e.movementIndex]="following",e.movementIndex--,e.forceNewMovementCheck=!1,e.isMoving=!0}break;case"following":if(isInRange(e.following.x,e.following.y,e.x,e.y,2*tileW))e.isMoving=!1,e.movementIndex--,e.forceNewMovementCheck=!0;else{e.isMoving=!0;for(var y=!1,I=0;I<e.following.breadcrumb.length;I++)if(e.tileY==e.following.breadcrumb[I][1]){if(e.tileX-1==e.following.breadcrumb[I][0]){e.facing="w",y=!0;break}if(e.tileX+1==e.following.breadcrumb[I][0]){e.facing="e",y=!0;break}}else if(e.tileX==e.following.breadcrumb[I][0]){if(e.tileY+1==e.following.breadcrumb[I][1]){e.facing="s",y=!0;break}if(e.tileY-1==e.following.breadcrumb[I][1]){e.facing="n",y=!0;break}}y?(e.movementIndex--,e.forceNewMovementCheck=!1):(e.forceNewMovementCheck=!0,e.waitingForAPath||void 0!==e.waitingTimer?e.isMoving=!0:(pathfindingWorker.postMessage(["npcFindFollowing",e,thisMapData]),e.isMoving=!1,e.waitingForAPath=!0,e.waitingTimer=0,e.movementIndex--))}break;default:e.facing=r,e.forceNewMovementCheck=!1}}}function movePlatforms(){if(thisMapData.movingPlatforms){for(var e=0;e<thisMapData.items.length;e++)void 0!=thisMapData.items[e].isOnPlatform&&thisMapData.movingPlatforms[thisMapData.items[e].isOnPlatform].canMove&&(thisMapData.items[e].x+=thisMapData.movingPlatforms[thisMapData.items[e].isOnPlatform].dx,thisMapData.items[e].y+=thisMapData.movingPlatforms[thisMapData.items[e].isOnPlatform].dy,thisMapData.items[e].z+=thisMapData.movingPlatforms[thisMapData.items[e].isOnPlatform].dz);var t,a;for(e=0;e<thisMapData.movingPlatforms.length;e++)(t=thisMapData.movingPlatforms[e]).canMove&&(t.x+=t.dx,t.y+=t.dy,t.z+=t.dz,Math.abs(t.targetX-t.x)<.5&&Math.abs(t.targetY-t.y)<.5&&Math.abs(t.targetZ-t.z)<.5&&(t.x=t.targetX,t.y=t.targetY,t.z=t.targetZ,a=determinePlatformIncrements(t),t.dx=a[0],t.dy=a[1],t.dz=a[2]))}}function determinePlatformIncrements(e){var t,a,n,i=e.movement[e.movementIndex],o=getTileCentreCoordX(i[0]),r=getTileCentreCoordY(i[1]),s=i[2],c=getPythagorasDistance(e.x,e.y,o,r)/e.speed;return t=0-(e.x-o)/c,a=0-(e.y-r)/c,n=0-(e.z-s)/c,e.targetX=o,e.targetY=r,e.targetZ=s,e.movementIndex++,e.movementIndex>=e.movement.length&&(e.movementIndex=0),[t,a,n]}function canLearnRecipe(e){return-1===hero.recipesKnown.indexOf(e)&&hero.recipesKnown.push(parseInt(e)),!1}function sendUserPost(e){var t=JSON.parse(e);getJSONWithParams("/game-world/sendPost.php","postData="+JSON.stringify(t),function(e){e.success?console.log("user post sent"):console.log("user post failed #1")},function(e){console.log("user post failed #2")})}function sendNPCPost(e,t){console.log(e);var a=JSON.parse(e);t&&(a.attachments=t),console.log(JSON.stringify(a)),getJSONWithParams("/game-world/sendPost.php","postData="+JSON.stringify(a),function(e){e.success?newPost.classList.add("active"):console.log("npc post failed #1")},function(e){console.log("npc post failed #2")})}function draw(){if("mapLoading"==gameMode)gameContext.fillStyle="#000000",gameContext.fillRect(0,0,canvasWidth,canvasHeight),gameContext.fill();else{var e,t,a,n,i,o;hero.isox=findIsoCoordsX(hero.x,hero.y),hero.isoy=findIsoCoordsY(hero.x,hero.y);var r=currentAnimationFrame%hero.animation.walk.length,s=hero.animation.walk[hero.facing],c=[[findIsoDepth(hero.x,hero.y,hero.z),"sprite",heroImg,r*hero.spriteWidth,s*hero.spriteHeight,hero.spriteWidth,hero.spriteHeight,Math.floor(canvasWidth/2-hero.centreX),Math.floor(canvasHeight/2-hero.centreY-hero.z),hero.spriteWidth,hero.spriteHeight]];if(interfaceIsVisible)switch(activeAction){case"dowse":c.push([0,"dowsingRing",Math.floor(canvasWidth/2-dowsingRingSize/2),Math.floor(canvasHeight/2-dowsingRingSize/4)]);break;case"plotPlacement":c.push([0,"plotPlacementOverlay"])}a=findIsoCoordsX(fae.x,fae.y),n=findIsoCoordsY(fae.x,fae.y),fae.oscillateOffset=8*(Math.sin(fae.dz)+1)+fae.z+fae.zOffset,c.push([findIsoDepth(fae.x,fae.y,fae.z),"faeCentre",Math.floor(a-hero.isox+canvasWidth/2),Math.floor(n-hero.isoy+canvasHeight/2-fae.oscillateOffset)]);for(var l=0;l<fae.particles.length;l++)c.push([fae.particles[l].depth,"faeParticle",Math.floor(fae.particles[l].isoX-hero.isox+canvasWidth/2),Math.floor(fae.particles[l].isoY-hero.isoy+canvasHeight/2),fae.particles[l].alpha]);var d,h,u,g,p=thisMapData.terrain,m=0,f=0,v="",y=0,I=0;for(l=0;l<mapTilesX;l++)for(var b=0;b<mapTilesY;b++)"*"!=p[b][l]&&(a=getTileIsoCentreCoordX(l,b),n=getTileIsoCentreCoordY(l,b),e=thisMapData.graphics[p[b][l]].centreX,t=thisMapData.graphics[p[b][l]].centreY,c.push([findIsoDepth(getTileCentreCoordX(l),getTileCentreCoordY(b),0),"img",tileImages[p[b][l]],Math.floor(a-hero.isox-e+canvasWidth/2),Math.floor(n-hero.isoy-t+canvasHeight/2)]));if(void 0!==thisMapData.innerDoors)for(var l in thisMapData.innerDoors)thisMapData.innerDoors[l].isOpen||(a=getTileIsoCentreCoordX(thisMapData.innerDoors[l].tileX,thisMapData.innerDoors[l].tileY),n=getTileIsoCentreCoordY(thisMapData.innerDoors[l].tileX,thisMapData.innerDoors[l].tileY),e=thisMapData.graphics[thisMapData.innerDoors[l].graphic].centreX,t=thisMapData.graphics[thisMapData.innerDoors[l].graphic].centreY,c.push([findIsoDepth(getTileCentreCoordX(thisMapData.innerDoors[l].tileX),getTileCentreCoordY(thisMapData.innerDoors[l].tileY),0),"img",tileImages[thisMapData.innerDoors[l].graphic],Math.floor(a-hero.isox-e+canvasWidth/2),Math.floor(n-hero.isoy-t+canvasHeight/2)]));if(hasActivePet)for(l=0;l<hero.activePets.length;l++)m=currentAnimationFrame%hero.allPets[hero.activePets[l]].animation.walk.length,f=hero.allPets[hero.activePets[l]].animation.walk[hero.allPets[hero.activePets[l]].facing],a=findIsoCoordsX(hero.allPets[hero.activePets[l]].x,hero.allPets[hero.activePets[l]].y),n=findIsoCoordsY(hero.allPets[hero.activePets[l]].x,hero.allPets[hero.activePets[l]].y),c.push([findIsoDepth(hero.allPets[hero.activePets[l]].x,hero.allPets[hero.activePets[l]].y,hero.allPets[hero.activePets[l]].z),"sprite",activePetImages[l],m*hero.allPets[hero.activePets[l]].spriteWidth,f*hero.allPets[hero.activePets[l]].spriteHeight,hero.allPets[hero.activePets[l]].spriteWidth,hero.allPets[hero.activePets[l]].spriteHeight,Math.floor(a-hero.isox-hero.allPets[hero.activePets[l]].centreX+canvasWidth/2),Math.floor(n-hero.isoy-hero.allPets[hero.activePets[l]].centreY+canvasHeight/2-hero.allPets[hero.activePets[l]].z),hero.allPets[hero.activePets[l]].spriteWidth,hero.allPets[hero.activePets[l]].spriteHeight]);for(l=0;l<thisMapData.npcs.length;l++)i=thisMapData.npcs[l],m=currentAnimationFrame%i.animation[i.currentAnimation].length,f=i.animation[i.currentAnimation][i.drawnFacing],a=findIsoCoordsX(i.x,i.y),n=findIsoCoordsY(i.x,i.y),g="npc"+thisMapData.npcs[l].name,c.push([findIsoDepth(i.x,i.y,i.z),"sprite",npcImages[g],m*i.spriteWidth,f*i.spriteHeight,i.spriteWidth,i.spriteHeight,Math.floor(a-hero.isox-i.centreX+canvasWidth/2),Math.floor(n-hero.isoy-i.centreY+canvasHeight/2-i.z),i.spriteWidth,i.spriteHeight]);for(l=0;l<thisMapData.items.length;l++)a=findIsoCoordsX((o=thisMapData.items[l]).x,o.y),n=findIsoCoordsY(o.x,o.y),v="",thisMapData.items[l].colour&&""!=(d=getColourName(thisMapData.items[l].colour,thisMapData.items[l].type))&&(v="-"+d.toLowerCase()),h="item"+thisMapData.items[l].type+v,void 0!==o.animation?(void 0!==o.state?(y=o.animation[o.state].length-1,I=o.animation[o.state].row):(y=o.animation.facing.length-1,I=o.animation.facing[o.facing]),c.push([findIsoDepth(o.x,o.y,o.z),"sprite",itemImages[h],y*o.spriteWidth,I*o.spriteHeight,o.spriteWidth,o.spriteHeight,Math.floor(a-hero.isox-o.centreX+canvasWidth/2),Math.floor(n-hero.isoy-o.centreY+canvasHeight/2-o.z),o.spriteWidth,o.spriteHeight])):c.push([findIsoDepth(o.x,o.y,o.z),"img",itemImages[h],Math.floor(a-hero.isox-o.centreX+canvasWidth/2),Math.floor(n-hero.isoy-o.centreY+canvasHeight/2-o.z)]);if(thisMapData.movingPlatforms)for(l=0;l<thisMapData.movingPlatforms.length;l++)a=findIsoCoordsX((u=thisMapData.movingPlatforms[l]).x,u.y),n=findIsoCoordsY(u.x,u.y),e=thisMapData.graphics[u.graphic].centreX,t=thisMapData.graphics[u.graphic].centreY,c.push([findIsoDepth(u.x,u.y,u.z),"img",tileImages[u.graphic],Math.floor(a-hero.isox-e+canvasWidth/2),Math.floor(n-hero.isoy-t+canvasHeight/2)]);c.sort(sortByLowestValue),gameContext.drawImage(backgroundImg,Math.floor(getTileIsoCentreCoordX(0,mapTilesX-1)-hero.isox-tileW/2-400+canvasWidth/2),Math.floor(getTileIsoCentreCoordY(0,0)-hero.isoy-tileH/2-300+canvasHeight/2));for(l=0;l<c.length;l++)switch(c[l][1]){case"faeCentre":drawCircle("#ffdc0c",c[l][2],c[l][3],2),drawCircle("rgba(255,220,255,0.3)",c[l][2],c[l][3],4),gameContext.fillStyle="rgba(0,0,0,"+.01*(65-fae.oscillateOffset)+")",gameContext.beginPath(),gameContext.ellipse(c[l][2]-getXOffsetFromHeight(fae.oscillateOffset),c[l][3]+fae.oscillateOffset,3,1,0,0,2*Math.PI),gameContext.fill();break;case"faeParticle":gameContext.fillStyle="rgba(255,220,255,"+c[l][4]+")",gameContext.fillRect(c[l][2],c[l][3],1,1);break;case"sprite":gameContext.drawImage(c[l][2],c[l][3],c[l][4],c[l][5],c[l][6],c[l][7],c[l][8],c[l][9],c[l][10]);break;case"dowsingRing":gameContext.globalCompositeOperation="lighten",drawEllipse(gameContext,c[l][2]+(100-dowsing.proximity)/2,c[l][3]+(100-dowsing.proximity)/4,dowsingRingSize*dowsing.proximity/100,dowsingRingSize*dowsing.proximity/100/2,!0,"rgba(255,255,0,0.3)"),drawEllipse(gameContext,c[l][2],c[l][3],dowsingRingSize,dowsingRingSize/2,!1,"rgba(255,255,0,0.3)"),gameContext.globalCompositeOperation="source-over";break;case"plotPlacementOverlay":gameContext.globalCompositeOperation="soft-light";var C=cursorPositionX-canvasWidth/2,w=cursorPositionY-canvasHeight/2;if(cursorPositionX){var M,D,S,P=find2DCoordsX(hero.isox+C,hero.isoy+w),T=find2DCoordsY(hero.isox+C,hero.isoy+w);plotPlacement.numberOfBlockedTiles=0;for(b=0-plotPlacement.width/2;b<plotPlacement.width/2;b++)for(var x=0-plotPlacement.length/2;x<plotPlacement.length/2;x++)D=T+tileW*x,S="rgba(0,255,0,0.8)",tileIsClear(getTileX(M=P+tileW*b),getTileY(D))||(S="rgba(255,0,0,0.8)",plotPlacement.numberOfBlockedTiles++),drawIsoRectangle(M=Math.floor(M/tileW)*tileW,D=Math.floor(D/tileW)*tileW,M+tileW,D+tileW,!0,S);console.log("number of blocked tiles: "+plotPlacement.numberOfBlockedTiles)}gameContext.globalCompositeOperation="source-over";break;case"img":gameContext.drawImage(c[l][2],c[l][3],c[l][4])}if(""!=activeObjectForDialogue&&UI.updateDialogue(activeObjectForDialogue),thisMapData.showOnlyLineOfSight){var k;lightMapContext.clearRect(0,0,canvasWidth,canvasHeight);for(l=-1;l<mapTilesX;l++)for(b=-1;b<mapTilesY;b++)a=getTileIsoCentreCoordX(l,b),n=getTileIsoCentreCoordY(l,b),e=28,t=17,k=1,l>-1&&b>-1&&(k=1.01-lightMap[b][l]),k>0?(lightMapContext.save(),lightMapContext.globalAlpha=k,lightMapContext.drawImage(shadowImg,Math.floor(a-hero.isox-e+canvasWidth/2)/4,Math.floor(n-hero.isoy-t+canvasHeight/2)/4),lightMapContext.restore()):lightMapContext.drawImage(shadowImg,Math.floor(a-hero.isox-e+canvasWidth/2)/4,Math.floor(n-hero.isoy-t+canvasHeight/2)/4)}if("out"==mapTransition)if((A=1-mapTransitionCurrentFrames/mapTransitionMaxFrames)<.02)gameContext.fillStyle="#000000",gameContext.fillRect(0,0,canvasWidth,canvasHeight);else(O=gameContext.createRadialGradient(canvasWidth/2,canvasHeight/2,A*canvasWidth/2,canvasWidth/2,canvasHeight/2,0)).addColorStop(0,"rgba(0,0,0,1)"),O.addColorStop(1,"rgba(0,0,0,0)"),gameContext.fillStyle=O,gameContext.fillRect(0,0,canvasWidth,canvasHeight);else if("in"==mapTransition){var O,A=mapTransitionCurrentFrames/mapTransitionMaxFrames;(O=gameContext.createRadialGradient(canvasWidth/2,canvasHeight/2,A*canvasWidth/2,canvasWidth/2,canvasHeight/2,0)).addColorStop(0,"rgba(0,0,0,1)"),O.addColorStop(1,"rgba(0,0,0,0)"),gameContext.fillStyle=O,gameContext.fillRect(0,0,canvasWidth,canvasHeight)}}}window.addEventListener("resize",debouncedResize),"querySelectorAll"in document&&"addEventListener"in window&&window.HTMLCanvasElement&&init();