function init(){gameCanvas=document.getElementById("gameWorld"),gameCanvas.getContext&&(gameContext=gameCanvas.getContext("2d")),getJSON("/data/"+characterId+"/map"+currentMap+".json",function(e){thisMapData=e.map,mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length,loadAssets()},function(e){alert("Error loading map data")}),gameMode="loading",gameLoop()}function getTileCentreCoordX(e,o){return tileW/2*(mapTilesY-o+e)}function getTileCentreCoordY(e,o){return tileH/2*(1+o+e)}function initGame(){tileImages=[];for(var e=0;e<tileGraphicsToLoad.length;e++)tileImages[e]=Loader.getImage("tile"+e);heroImg=Loader.getImage("heroImg"),backgroundImg=Loader.getImage("backgroundImg"),Input.init(),hero.x=getTileCentreCoordX(hero.tileX,hero.tileY)-hero.feetOffsetX,hero.y=getTileCentreCoordY(hero.tileX,hero.tileY)-hero.feetOffsetY,gameMode="play"}function loadAssets(){imagesToLoad=[],imagesToLoad.push({name:"heroImg",src:"/images/game-world/core/TEMP-link.png"}),imagesToLoad.push({name:"backgroundImg",src:"/images/game-world/maps/"+currentMap+"/bg.png"}),tileGraphicsToLoad=thisMapData.graphics;for(var e=0;e<tileGraphicsToLoad.length;e++)imagesToLoad.push({name:"tile"+e,src:"/images/game-world/maps/"+currentMap+"/"+tileGraphicsToLoad[e].src});Loader.preload(imagesToLoad,initGame,loadingProgress)}function loadingProgress(){console.log("loading - "+Loader.getProgress())}function checkCollisions(){var e=thisMapData.collisions,o=hero.width-2;if(key[2]){var a=Math.floor(hero.x/8),t=Math.floor((hero.x+o)/8),n=Math.floor((hero.y+9)/8),r=n*NUM_TILES_WIDE+a,i=n*NUM_TILES_WIDE+t;(1==e[r]||1==e[i])&&(hero.y=8*n)}if(key[3]){var h=Math.floor(hero.x/8),s=Math.floor((hero.x+hero.width-1)/8),n=Math.floor((hero.y+hero.height)/8),g=n*NUM_TILES_WIDE+h,d=n*NUM_TILES_WIDE+s;(1==e[g]||1==e[d])&&(hero.y=8*n-hero.height)}if(key[0]){var m=Math.floor(hero.x/8),c=Math.floor((hero.y+9)/8),l=Math.floor((hero.y+hero.height-1)/8),r=c*NUM_TILES_WIDE+m,g=l*NUM_TILES_WIDE+m;(1==e[r]||1==e[g])&&(hero.x=8*m+8)}if(key[1]){var m=Math.floor((hero.x+hero.width)/8),f=Math.floor((hero.y+9)/8),u=Math.floor((hero.y+hero.height-1)/8),i=f*NUM_TILES_WIDE+m,d=u*NUM_TILES_WIDE+m;(1==e[i]||1==e[d])&&(hero.x=8*m-hero.width)}}function gameLoop(){switch(gameMode){case"loading":break;case"paused":break;case"play":update(),draw()}window.requestAnimationFrame(gameLoop)}function update(){var e=window.performance.now(),o=e-lastTime;if(lastTime=e,hero.isMoving=!1,key[2]&&(hero.isMoving=!0,hero.facing="up",hero.y-=hero.speed),key[3]&&(hero.isMoving=!0,hero.facing="down",hero.y+=hero.speed),key[0]&&(hero.isMoving=!0,hero.facing="left",hero.x-=hero.speed),key[1]&&(hero.isMoving=!0,hero.facing="right",hero.x+=hero.speed),checkCollisions(),hero.timeSinceLastFrameSwap+=o,hero.timeSinceLastFrameSwap>hero.animationUpdateTime){var a=(hero.isMoving?"walk-":"stand-")+hero.facing,t=hero.sequences[a];hero.animationFrameIndex<t.length-1?hero.animationFrameIndex+=1:hero.animationFrameIndex=0;var n=t[hero.animationFrameIndex]%7,r=Math.floor(t[hero.animationFrameIndex]/7);hero.offsetX=n*hero.width,hero.offsetY=r*hero.height,hero.timeSinceLastFrameSwap=0}}function draw(){drawBackground(),gameContext.drawImage(heroImg,hero.offsetX,hero.offsetY,hero.width,hero.height,hero.x,hero.y,hero.width,hero.height)}function drawBackground(){gameContext.drawImage(backgroundImg,0,0);for(var e,o,a=thisMapData.terrain,t=0,n=tileH/2,r=0;r<a.length;r++)for(var i=0;i<a[r].length;i++)thisX=(a.length-r+i)*tileW/2,thisY=(r+i)*tileH/2,e=thisMapData.graphics[a[r][i]].centreX,o=thisMapData.graphics[a[r][i]].centreY,gameContext.drawImage(tileImages[a[r][i]],thisX+t-e,thisY+n-o)}var animationFramesPerSecond=16,lastTime=0,elapsed=0,characterId="chr-html5",currentMap=1,thisMapData="",mapTilesX=0,mapTilesY=0,tileGraphics=[],tileH=24,tileW=48,tileGraphicsToLoad=0,width=256,ROOM_HEIGHT=176,NUM_TILES_WIDE=1,NUM_TILES_HIGH=1,key=[0,0,0,0,0],hero={x:100,y:100,tileX:1,tileY:0,width:17,height:25,feetOffsetX:8,feetOffsetY:21,speed:2,animationFrameIndex:0,timeSinceLastFrameSwap:0,animationUpdateTime:1e3/animationFramesPerSecond,isMoving:!1,facing:"down",sequences:{"stand-down":[3],"stand-up":[10],"stand-right":[17],"stand-left":[24],"walk-down":[3,4,5,6,5,4,3,2,1,0,1,2],"walk-up":[10,11,12,13,12,11,10,9,8,7,8,9],"walk-right":[17,18,19,20,19,18,17,16,15,14,15,16],"walk-left":[24,25,26,27,26,25,24,23,22,21,22,23]}};!function(){for(var e=0,o=["ms","moz","webkit","o"],a=0;a<o.length&&!window.requestAnimationFrame;++a)window.requestAnimationFrame=window[o[a]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[o[a]+"CancelAnimationFrame"]||window[o[a]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(o,a){var t=(new Date).getTime(),n=Math.max(0,16-(t-e)),r=window.setTimeout(function(){o(t+n)},n);return e=t+n,r}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}();var getJSON=function(e,o,a){var t="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");t.open("get",e,!0),t.onreadystatechange=function(){var e,n;4==t.readyState&&(e=t.status,200==e?(n=JSON.parse(t.responseText),o&&o(n)):a&&a(e))},t.send()};window.Loader=function(){function e(){}function o(){}function a(a){++s,e(h()),s==d&&(g=!1,o())}function t(e){console.log("Error on loading the image: "+e.srcElement)}function n(e,o){try{m[e]=new Image,m[e].onload=function(){a(e)},m[e].onerror=t,m[e].src=o}catch(n){console.log(n.message)}}function r(e){return m[e]?m[e]:void 0}function i(a,t,r){if(!g){g=!0;try{d=a.length,e=r||function(){},o=t||function(){};for(var i=0;i<a.length;++i)n(a[i].name,a[i].src)}catch(h){console.log(h.message)}}}function h(){return s/d*100}var s=0,g=!1,d=0,m={};return{preload:i,getProgress:h,getImage:r,images:m}}();var Input={init:function(){document.addEventListener("keydown",function(e){Input.changeKey(e.keyCode,1)}),document.addEventListener("keyup",function(e){Input.changeKey(e.keyCode,0)})},changeKey:function(e,o){switch(e){case KeyBindings.left:key[0]=o;break;case KeyBindings.up:key[2]=o;break;case KeyBindings.right:key[1]=o;break;case KeyBindings.down:key[3]=o;break;case KeyBindings.action:key[4]=o}}},KeyBindings={left:37,right:39,up:38,down:40,action:32,pause:80};"serviceWorker"in navigator&&navigator.serviceWorker.register("/game-world/serviceWorker.min.js",{scope:"/game-world/"}),"querySelectorAll"in document&&"addEventListener"in window&&window.HTMLCanvasElement&&init();