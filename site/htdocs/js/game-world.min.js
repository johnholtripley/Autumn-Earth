function getTileX(e){return Math.floor(e/tileW)}function getTileY(e){return Math.floor(e/tileW)}function findIsoCoordsX(e,a){return Math.floor(mapTilesY*tileW/2-a/2+e/2)}function findIsoCoordsY(e,a){return Math.floor(e/4+a/4-tileH/2)}function getTileCentreCoordX(e){return e*tileW+tileW/2}function getTileCentreCoordY(e){return e*tileW+tileW/2}function getTileIsoCentreCoordX(e,a){return tileW/2*(mapTilesY-a+e)}function getTileIsoCentreCoordY(e,a){return tileH/2*(a+e)}function getCurrentTileX(e){return Math.floor(e/tileW)}function getCurrentTileY(e){return Math.floor(e/tileW)}function sortByIsoDepth(e,a){return e[0]<a[0]?-1:e[0]>a[0]?1:0}function findIsoDepth(e,a){return a}function init(){gameCanvas=document.getElementById("gameWorld"),gameCanvas.getContext&&(gameContext=gameCanvas.getContext("2d"),canvasWidth=gameCanvas.width,canvasHeight=gameCanvas.height),gameMode="mapLoading",Input.init(),loadCoreAssets(),gameLoop()}function prepareGame(){tileImages=[];for(var e=0;e<tileGraphicsToLoad.length;e++)tileImages[e]=Loader.getImage("tile"+e);backgroundImg=Loader.getImage("backgroundImg"),hero.x=getTileCentreCoordX(hero.tileX),hero.y=getTileCentreCoordY(hero.tileY),mapIsTransitioningOut=!1,mapTransitionCurrentFrames=1,mapIsTransitioningIn=!0,gameMode="play"}function loadMap(){getJSON("/data/"+characterId+"/map"+currentMap+".json",function(e){thisMapData=e.map,mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length,loadMapAssets()},function(e){alert("Error loading data for map #"+currentMap)})}function prepareCoreAssets(){heroImg=Loader.getImage("heroImg"),loadMap()}function loadCoreAssets(){coreImagesToLoad=[],coreImagesToLoad.push({name:"heroImg",src:"/images/game-world/core/test-iso-hero.png"}),Loader.preload(coreImagesToLoad,prepareCoreAssets,loadingProgress)}function removeMapAssets(){for(var e=0;e<tileGraphicsToLoad.length;e++)tileImages[e]=null;backgroundImg=null}function loadMapAssets(){imagesToLoad=[],imagesToLoad.push({name:"backgroundImg",src:"/images/game-world/maps/"+currentMap+"/bg.png"}),tileGraphicsToLoad=thisMapData.graphics;for(var e=0;e<tileGraphicsToLoad.length;e++)imagesToLoad.push({name:"tile"+e,src:"/images/game-world/maps/"+currentMap+"/"+tileGraphicsToLoad[e].src});Loader.preload(imagesToLoad,prepareGame,loadingProgress)}function loadingProgress(){console.log("loading - "+Loader.getProgress())}function changeMaps(e,a){gameMode="mapLoading",console.log("chaning maps");var o=thisMapData.doors,i=getTileX(e)+","+getTileX(a);hero.tileX=o[i].startX,hero.tileY=o[i].startY,currentMap=o[i].map,loadMap()}function isATerrainCollision(e,a){switch(thisMapData.collisions[getTileY(a)][getTileX(e)]){case 1:return 1;case"d":return activeDoorX=e,activeDoorY=a,mapIsTransitioningOut||(mapTransitionCurrentFrames=1,mapIsTransitioningOut=!0),0;default:return 0}}function checkHeroCollisions(){if(key[2]&&(isATerrainCollision(hero.x-hero.width/2,hero.y-hero.height/2)||isATerrainCollision(hero.x+hero.width/2,hero.y-hero.height/2))){var e=getTileY(hero.y-hero.height/2),a=(e+1)*tileW;hero.y=a+hero.height/2+1}if(key[3]&&(isATerrainCollision(hero.x-hero.width/2,hero.y+hero.height/2)||isATerrainCollision(hero.x+hero.width/2,hero.y+hero.height/2))){var e=getTileY(hero.y+hero.height/2),o=e*tileW;hero.y=o-hero.height/2-1}if(key[0]&&(isATerrainCollision(hero.x-hero.width/2,hero.y+hero.height/2)||isATerrainCollision(hero.x-hero.width/2,hero.y-hero.height/2))){var e=getTileX(hero.x-hero.width/2),i=(e+1)*tileW;hero.x=i+hero.width/2+1}if(key[1]&&(isATerrainCollision(hero.x+hero.width/2,hero.y+hero.height/2)||isATerrainCollision(hero.x+hero.width/2,hero.y-hero.height/2))){var e=getTileX(hero.x+hero.width/2),t=e*tileW;hero.x=t-hero.width/2-1}}function gameLoop(){switch(gameMode){case"mapLoading":console.log("loading map assets...");break;case"paused":break;case"play":update(),draw()}window.requestAnimationFrame(gameLoop)}function update(){var e=window.performance.now(),a=e-lastTime;if(lastTime=e,hero.isMoving=!1,mapIsTransitioningOut?(mapTransitionCurrentFrames++,mapTransitionCurrentFrames>=mapTransitionMaxFrames&&(mapIsTransitioningOut=!1,changeMaps(activeDoorX,activeDoorY))):(key[2]?(hero.isMoving=!0,hero.facing="up",hero.y-=hero.speed):key[3]?(hero.isMoving=!0,hero.facing="down",hero.y+=hero.speed):key[0]?(hero.isMoving=!0,hero.facing="left",hero.x-=hero.speed):key[1]&&(hero.isMoving=!0,hero.facing="right",hero.x+=hero.speed),hero.tileX=getTileX(hero.x),hero.tileY=getTileY(hero.y),checkHeroCollisions()),mapIsTransitioningIn&&(mapTransitionCurrentFrames++,mapTransitionCurrentFrames>=mapTransitionMaxFrames&&(mapIsTransitioningIn=!1)),hero.timeSinceLastFrameSwap+=a,hero.timeSinceLastFrameSwap>hero.animationUpdateTime){var o=(hero.isMoving?"walk-":"stand-")+hero.facing,i=hero.sequences[o];hero.animationFrameIndex<i.length-1?hero.animationFrameIndex+=1:hero.animationFrameIndex=0;var t=i[hero.animationFrameIndex]%7,n=Math.floor(i[hero.animationFrameIndex]/7);hero.offsetX=t*hero.width,hero.offsetY=n*hero.height,hero.timeSinceLastFrameSwap=0}}function draw(){var e,a,o=[[findIsoDepth(findIsoCoordsX(hero.x,hero.y),findIsoCoordsY(hero.x,hero.y)),heroImg,canvasWidth/2-hero.feetOffsetX,canvasHeight/2-hero.feetOffsetY]],i=thisMapData.terrain;hero.isox=findIsoCoordsX(hero.x,hero.y),hero.isoy=findIsoCoordsY(hero.x,hero.y);for(var t=0;mapTilesX>t;t++)for(var n=0;mapTilesY>n;n++)"*"!=i[n][t]&&(thisX=getTileIsoCentreCoordX(t,n),thisY=getTileIsoCentreCoordY(t,n),e=thisMapData.graphics[i[n][t]].centreX,a=thisMapData.graphics[i[n][t]].centreY,o.push([findIsoDepth(thisX,thisY),tileImages[i[n][t]],thisX-hero.isox-e+canvasWidth/2,thisY-hero.isoy-a+canvasHeight/2]));o.sort(sortByIsoDepth),gameContext.clearRect(0,0,canvasWidth,canvasHeight),gameContext.drawImage(backgroundImg,getTileIsoCentreCoordX(0,mapTilesX-1)-hero.isox+canvasWidth/2-tileW/2,getTileIsoCentreCoordY(0,0)-hero.isoy+canvasHeight/2-tileH/2);for(var t=0;t<o.length;t++)10==o[t].length?gameContext.drawImage(o[t][1],o[t][2],o[t][3],o[t][4],o[t][5],o[t][6],o[t][7],o[t][8],o[t][9]):gameContext.drawImage(o[t][1],o[t][2],o[t][3]);if(mapIsTransitioningOut){console.log("out...");var r=1-mapTransitionCurrentFrames/mapTransitionMaxFrames,s=gameContext.createRadialGradient(canvasWidth/2,canvasHeight/2,r*canvasWidth/2,canvasWidth/2,canvasHeight/2,0);s.addColorStop(0,"rgba(0,0,0,1)"),s.addColorStop(1,"rgba(0,0,0,0)"),gameContext.fillStyle=s,gameContext.fillRect(0,0,canvasWidth,canvasHeight)}if(mapIsTransitioningIn){console.log("in...");var r=mapTransitionCurrentFrames/mapTransitionMaxFrames,s=gameContext.createRadialGradient(canvasWidth/2,canvasHeight/2,r*canvasWidth/2,canvasWidth/2,canvasHeight/2,0);s.addColorStop(0,"rgba(0,0,0,1)"),s.addColorStop(1,"rgba(0,0,0,0)"),gameContext.fillStyle=s,gameContext.fillRect(0,0,canvasWidth,canvasHeight)}}var animationFramesPerSecond=16,lastTime=0,elapsed=0,mapIsTransitioningOut=!1,mapIsTransitioningIn=!1,mapTransitionCurrentFrames=1,mapTransitionMaxFrames=60,activeDoorX=-1,activeDoorY=-1,characterId="chr-html5",currentMap=1,thisMapData="",mapTilesX=0,mapTilesY=0,tileGraphics=[],tileW=48,tileH=tileW/2,tileGraphicsToLoad=0,canvasWidth=256,canvasHeight=176,worldOffsetX=0,worldOffsety=0,key=[0,0,0,0,0],hero={x:0,y:0,dx:0,dy:0,tileX:1,tileY:2,width:20,height:20,feetOffsetX:10,feetOffsetY:16,speed:2,animationFrameIndex:0,timeSinceLastFrameSwap:0,animationUpdateTime:1e3/animationFramesPerSecond,isMoving:!1,facing:"down",sequences:{"stand-down":[3],"stand-up":[10],"stand-right":[17],"stand-left":[24],"walk-down":[3,4,5,6,5,4,3,2,1,0,1,2],"walk-up":[10,11,12,13,12,11,10,9,8,7,8,9],"walk-right":[17,18,19,20,19,18,17,16,15,14,15,16],"walk-left":[24,25,26,27,26,25,24,23,22,21,22,23]}};!function(){for(var e=0,a=["ms","moz","webkit","o"],o=0;o<a.length&&!window.requestAnimationFrame;++o)window.requestAnimationFrame=window[a[o]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[a[o]+"CancelAnimationFrame"]||window[a[o]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(a,o){var i=(new Date).getTime(),t=Math.max(0,16-(i-e)),n=window.setTimeout(function(){a(i+t)},t);return e=i+t,n}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}();var getJSON=function(e,a,o){var i="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");i.open("get",e,!0),i.onreadystatechange=function(){var e,t;4==i.readyState&&(e=i.status,200==e?(t=JSON.parse(i.responseText),a&&a(t)):o&&o(e))},i.send()};window.Loader=function(){function e(){g=0,d=!1,l=0,c={}}function a(){}function o(){}function i(e){++g,a(h()),g==l&&(d=!1,o())}function t(e){console.log("Error on loading the image: "+e.srcElement)}function n(e,a){try{c[e]=new Image,c[e].onload=function(){i(e)},c[e].onerror=t,c[e].src=a}catch(o){console.log(o.message)}}function r(e){return c[e]?c[e]:void 0}function s(i,t,r){if(e(),!d){d=!0;try{l=i.length,a=r||function(){},o=t||function(){};for(var s=0;s<i.length;++s)n(i[s].name,i[s].src)}catch(h){console.log(h.message)}}}function h(){return g/l*100}var g=0,d=!1,l=0,c={};return{preload:s,getProgress:h,getImage:r,reset:e,images:c}}();var Input={init:function(){document.addEventListener("keydown",function(e){Input.changeKey(e.keyCode,1)}),document.addEventListener("keyup",function(e){Input.changeKey(e.keyCode,0)})},changeKey:function(e,a){switch(e){case KeyBindings.left:key[0]=a;break;case KeyBindings.up:key[2]=a;break;case KeyBindings.right:key[1]=a;break;case KeyBindings.down:key[3]=a;break;case KeyBindings.action:key[4]=a}}},KeyBindings={left:37,right:39,up:38,down:40,action:32,pause:80};"serviceWorker"in navigator&&navigator.serviceWorker.register("/game-world/serviceWorker.min.js",{scope:"/game-world/"}),"querySelectorAll"in document&&"addEventListener"in window&&window.HTMLCanvasElement&&init();