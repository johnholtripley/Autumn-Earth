"use strict";function updateCartographicMiniMap(){var e=246/(mapTilesX*tileW),t=hero.x*e,a=hero.y*e,i=0,o=35,n=offScreenCartographyContext.createRadialGradient(t,a,i,t,a,o);n.addColorStop(0,"rgb(255,255,255)"),n.addColorStop(1,"rgba(255,255,255,0)"),offScreenCartographyContext.arc(t,a,o,0,2*Math.PI),offScreenCartographyContext.fillStyle=n,offScreenCartographyContext.fill(),cartographyContext.clearRect(0,0,246,246),cartographyContext.globalCompositeOperation="copy",cartographyContext.drawImage(offScreenCartographyCanvas,0,0),cartographyContext.globalCompositeOperation="source-atop",cartographyContext.drawImage(canvasMapImage,0,0)}function initCartographicMap(){canvasMapImage.src="/game-world/generateCartographicMap.php?playerId="+characterId+"&dungeonName="+randomDungeonName+"&plotChests=true&requestedMap="+newMap,canvasMapImage.onload=function(){canvasMapMaskImage.src="/game-world/getCartographicMapMask.php?chr="+characterId+"&dungeonName="+randomDungeonName+"&currentMap="+newMap+"&cache="+Date.now(),canvasMapMaskImage.onload=function(){offScreenCartographyContext.clearRect(0,0,246,246),offScreenCartographyContext.drawImage(canvasMapMaskImage,0,0),updateCartographicMiniMap()}}}function saveCartographyMask(){var e=offScreenCartographyCanvas.toDataURL();postData("/game-world/saveCartographicMapMask.php","chr="+characterId+"&dungeonName="+randomDungeonName+"&currentMap="+currentMap+"&data="+e)}function getColourName(e,t){var a="";return 1!=currentActiveInventoryItems[t].hasInherentColour&&(a=colourNames[e]),a}function mixColours(){for(var e=0,t=0,a=0,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],o=0;o<arguments.length;o++)i[arguments[o]]++,e|=arguments[o],arguments[o]==(16|arguments[o])&&t++,arguments[o]==(8|arguments[o])&&a++;for(var o=0;o<i.length;o++)if(i[o]/arguments.length>.7){e=o;break}return e>24&&(e-=t>a?8:a>t?16:24),e}function recipeSearchAndFilter(){var e=hero.crafting[currentRecipePanelProfession].sortOrder;if(""!=recipeSearch.value){var t=recipeSearch.value.toLowerCase();e=[];for(var a in hero.crafting[currentRecipePanelProfession].recipes)-1!=hero.crafting[currentRecipePanelProfession].recipes[a].recipeName.toLowerCase().indexOf(t)?e.push(a):-1!=hero.crafting[currentRecipePanelProfession].recipes[a].recipeDescription.toLowerCase().indexOf(t)&&e.push(a)}var i,o=document.querySelectorAll("#createRecipeList li");for(i=0;i<o.length;++i)o[i].classList.remove("active");var n=0;for(i=0;i<e.length;i++)-1!=recipeFilter.value.indexOf(e[i])&&(document.getElementById("recipe"+e[i]).classList.add("active"),n++);0==n&&document.getElementById("noRecipesFound").classList.add("active"),""!=UI.highlightedRecipe&&(document.getElementById(UI.highlightedRecipe).classList.contains("active")||(document.getElementById(UI.highlightedRecipe).classList.remove("highlighted"),craftingRecipeCreateButton.disabled=!0,UI.highlightedRecipe="")),thisDevicesScrollBarWidth>0&&recipeCustomScrollBar.init()}function recipeSearchInput(){""!=recipeSearch.value?clearRecipeSearch.classList.add("active"):clearRecipeSearch.classList.remove("active"),recipeSearchAndFilter()}function recipeSearchClear(){recipeSearch.value="",clearRecipeSearch.classList.remove("active"),recipeSearchAndFilter()}function recipeSelectComponents(e){var t,a=e.substring(6),i=hero.crafting[currentRecipePanelProfession].recipes[a],o='<img src="/images/game-world/inventory-items/'+i.imageId+'.png" alt="'+i.recipeName+'"><h3>'+i.recipeName+"</h3><p>"+i.recipeDescription+"</p><h4>Requires:</h4>",n="<h4>Available:</h4><ul>",r=i.components.split(","),s=0;o+="<ul>";for(var c=0;c<r.length;c++)if(isNaN(r[c])){if(o+='<li><img src="/images/game-world/inventory-items/'+r[c]+'.png" alt="">'+currentItemGroupFilters[r[c]]+"</li>",t=hasItemTypeInInventory(r[c]),t.length>0)for(var l=0;l<t.length;l++)n+='<li id="fromSlot'+t[l]+'">'+generateSlotMarkup(t[l])+"</li>",s++}else if(o+='<li><img src="/images/game-world/inventory-items/'+r[c]+'.png" alt="'+currentActiveInventoryItems[r[c]].shortname+'">'+currentActiveInventoryItems[r[c]].shortname+"</li>",t=findSlotItemIdInInventory(r[c]),t.length>0)for(var l=0;l<t.length;l++)n+='<li id="fromSlot'+t[l]+'">'+generateSlotMarkup(t[l])+"</li>",s++;0==s&&(n+="<li><p>You don't have any of the required components for this recipe.</p></li>"),currentActiveInventoryItems[i.creates].dyeable>0&&(o+='<li><img src="/images/game-world/inventory-items/dye.png" alt="">Optional dye</li>'),o+='<li><img src="/images/game-world/inventory-items/enchant.png" alt="">Optional enchanted item</li>',o+="</ul>",n+="</ul>",selectComponentsItemBeingCreated.innerHTML=o,componentsAvailableForThisRecipe.innerHTML=n}function scrollbarWidth(){var e=document.createElement("div");e.style.cssText="width:50px;height:50px;overflow-y:scroll;top:-200px;left:-200px;position:absolute;";var t=0,a=0;document.body.appendChild(e),t=e.offsetWidth;var a=e.clientWidth;return document.body.removeChild(e),t-a}function customScrollBar(e){this.element=e,this.scrollingContent=this.element.firstElementChild,this.hasMouseEventsAttached=!1,this.init=function(){this.translateY=0,this.isBeingDragged=!1,this.element.classList.remove("inActive"),this.scrollingContent.style.width=this.scrollingContent.offsetWidth+thisDevicesScrollBarWidth+"px",this.paneHeight=this.element.offsetHeight,this.scrollContentHeight=this.scrollingContent.scrollHeight,this.scrollContentHeight>this.paneHeight?(this.scrollbarRatio=this.paneHeight/this.scrollContentHeight,this.draggerHeight=Math.floor(this.scrollbarRatio*this.paneHeight),this.dragger=this.element.querySelector(".dragger"),this.dragger.style.height=this.draggerHeight+"px",this.dragger.style.transform="translateY("+this.translateY+"px)",this.hasMouseEventsAttached||(this.scrollingContent.addEventListener("scroll",this.contentScroll.bind(this)),this.dragger.addEventListener("mousedown",this.startScrollDrag.bind(this)),this.hasMouseEventsAttached=!0)):(this.element.classList.add("inActive"),this.scrollingContent.removeAttribute("style"))},this.contentScroll=function(){if(!this.isBeingDragged){var e=this.scrollingContent.scrollTop,t=Math.round(this.scrollbarRatio*e);this.translateY=t,this.dragger.style.transform="translateY("+this.translateY+"px)"}},this.startScrollDrag=function(e){e.preventDefault(),this.initialClickPosition=e.pageY-this.translateY,this.isBeingDragged=!0,this.mouseMoveEvent=this.handleScrollDrag.bind(this),document.addEventListener("mousemove",this.mouseMoveEvent,!1),this.mouseUpEvent=this.endScrollDrag.bind(this),document.addEventListener("mouseup",this.mouseUpEvent,!1)},this.handleScrollDrag=function(e){this.translateY=e.pageY-this.initialClickPosition,this.translateY<0&&(this.translateY=0),this.translateY+this.draggerHeight>this.paneHeight&&(this.translateY=this.paneHeight-this.draggerHeight),this.dragger.style.transform="translateY("+this.translateY+"px)",this.scrollingContent.scrollTop=this.translateY/this.scrollbarRatio},this.endScrollDrag=function(e){this.isBeingDragged=!1,document.removeEventListener("mousemove",this.mouseMoveEvent,!1),document.removeEventListener("mouseup",this.mouseUpEvent,!1)},this.init()}function animateFae(){fae.dz+=.2;for(var e=0;e<fae.particles.length;e++)fae.particles[e].alpha-=.1,fae.particles[e].alpha<=0&&fae.particles.splice(e,1);if(fae.particles.length<fae.maxParticles&&1==getRandomInteger(1,2)){var t=findIsoCoordsX(fae.x,fae.y),a=findIsoCoordsY(fae.x,fae.y)-fae.oscillateOffset,i=t+getRandomInteger(0,8)-4,o=a+getRandomInteger(0,8)-4;isInRange(t,a,i,o,6)&&fae.particles.push({depth:findIsoDepth(fae.x,fae.y,fae.z),isoX:i,isoY:o,alpha:1})}}function moveFae(){switch(fae.currentState){case"away":moveFaeToDestination(fae.targetX,fae.targetY);break;case"wait":isInRange(fae.x,fae.y,hero.x,hero.y,144)&&(fae.currentState="hero");break;default:fae.angleAroundHero+=4;var e=hero.x+fae.radiusAroundHero*Math.cos(fae.angleAroundHero*(Math.PI/180)),t=hero.y+fae.radiusAroundHero*Math.sin(fae.angleAroundHero*(Math.PI/180));moveFaeToDestination(e,t)}}function moveFaeToDestination(e,t){var a=getPythagorasDistance(fae.x,fae.y,e,t);if(a>fae.speed){var i=fae.speed/a;fae.x+=i*(e-fae.x),fae.y+=i*(t-fae.y)}else 2>a?(fae.x=e,fae.y=t,"away"==fae.currentState&&(fae.currentState="wait")):(fae.x+=(e-fae.x)/2,fae.y+=(t-fae.y)/2);var o=hero.z;o>fae.z?fae.z+=.5:o<fae.z&&(fae.z-=.5)}function getTileX(e){return Math.floor(e/tileW)}function getTileY(e){return Math.floor(e/tileW)}function findIsoCoordsX(e,t){return Math.floor(mapTilesY*tileW/2-t/2+e/2)}function findIsoCoordsY(e,t){return Math.floor(e/4+t/4-12)}function findIsoDepth(e,t,a){return findIsoCoordsY(e,t)*tileW/2+2*a}function getTileCentreCoordX(e){return e*tileW+24}function getTileCentreCoordY(e){return e*tileW+24}function getTileIsoCentreCoordX(e,t){return 24*(mapTilesY-t+e)}function getTileIsoCentreCoordY(e,t){return 12*(t+e)}function getCurrentTileX(e){return Math.floor(e/tileW)}function getCurrentTileY(e){return Math.floor(e/tileW)}function getElevation(e,t){return thisMapData.elevation[t][e]}function getXOffsetFromHeight(e){return Math.sqrt(2)/2*e}function accessDynamicVariable(e){for(var t=e.split("."),a=window,i=0;i<t.length;i++)a[t[i]]&&(a=a[t[i]]);return a}function getNearestParentId(e){for(;!e.id;)e=e.parentNode;return e}function getObjectKeysForInnerValue(e,t,a){var i=[];for(var o in e)e.hasOwnProperty(o)&&e[o][a]===t&&i.push(o);return i}function debounce(e,t,a){var i;return function(){var o=this,n=arguments,r=function(){i=null,a||e.apply(o,n)},s=a&&!i;clearTimeout(i),i=setTimeout(r,t),s&&e.apply(o,n)}}function isAnObjectCollision(e,t,a,i,o,n,r,s){return e+a/2>o-r/2&&o+r/2>e-a/2&&n+s/2>t-i/2&&t+i/2>n-s/2?!0:!1}function getRandomInteger(e,t){return Math.floor(Math.random()*(t-e))+e}function getRandomIntegerInclusive(e,t){return Math.floor(Math.random()*(t-e+1))+e}function getRandomKeyFromObject(e){var t=Object.keys(e);return t[t.length*Math.random()<<0]}function isInRange(e,t,a,i,o){var n=getPythagorasDistance(e,t,a,i);return o>=n?!0:!1}function getPythagorasDistance(e,t,a,i){return Math.sqrt((e-a)*(e-a)+(t-i)*(t-i))}function turntoFace(e,t){var a=e.x-t.x,i=e.y-t.y;return Math.abs(a)>Math.abs(i)?a>0?"w":"e":i>0?"n":"s"}function turntoFaceTile(e,t,a){var i=e.x-getTileCentreCoordX(t),o=e.y-getTileCentreCoordY(a);return Math.abs(i)>Math.abs(o)?i>0?"w":"e":o>0?"n":"s"}function isFacing(e,t){var a=!1;switch(e.facing){case"n":e.y>t.y&&(a=!0);break;case"s":e.y<t.y&&(a=!0);break;case"w":e.x>t.x&&(a=!0);break;case"e":e.x<t.x&&(a=!0)}return a}function generateHash(e){var t,a,i,o=0;if(0===e.length)return o;for(t=0,i=e.length;i>t;t++)a=e.charCodeAt(t),o=(o<<5)-o+a,o|=0;return o}function parseMoney(e){var t="",a=e%100,i=Math.floor(e/1e4),o=Math.floor((e-1e4*i)/100);return i>0&&(t=i+'<span class="gold"></span>'),(o>0||i>0)&&(t+=o+'<span class="silver"></span>'),t+=a+'<span class="copper"></span>'}function hasLineOfSight(e,t,a,i){var o,n,r,s,c,l=e,h=t,d=[],u=[],p=i-t,g=a-e,m=0;if(c=0>p?-1:1,s=0>g?-1:1,p=Math.abs(2*p),g=Math.abs(2*g),n=e,r=t,g>p)for(o=2*p-g;l!=a;){if(o>=0&&(h+=c,o-=g),l+=s,o+=p,0!=thisMapData.collisions[h][l])return!1;d[m]=h-r,u[m]=l-n,r=h,n=l,m++}else for(o=2*g-p;h!=i;){if(o>=0&&(l+=s,o-=p),h+=c,o+=g,0!=thisMapData.collisions[h][l])return!1;d[m]=h-r,u[m]=l-n,r=h,n=l,m++}return!0}function determineWhichTransitionEvent(){var e,t=document.createElement("fakeelement"),a={transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"};for(e in a)if(void 0!==t.style[e])return a[e];t=null}function determineWhichAnimationEvent(){var e,t=document.createElement("fakeelement"),a={animation:"animationend",OAnimation:"oAnimationEnd",MozAnimation:"animationend",WebkitAnimation:"webkitAnimationEnd"};for(e in a)if(void 0!==t.style[e])return a[e];t=null}function uniqueValues(e){var t={};return e.filter(function(e){return t.hasOwnProperty(e)?!1:t[e]=!0})}function sortByHighestValue(e,t){return e[0]<t[0]?1:e[0]>t[0]?-1:0}function sortByLowestValue(e,t){return e[0]<t[0]?-1:e[0]>t[0]?1:0}function getRandomElementFromArray(e){return e[Math.floor(Math.random()*e.length)]}function drawCircle(e,t,a,i){gameContext.fillStyle=e,gameContext.beginPath(),gameContext.arc(t,a,i,0,2*Math.PI),gameContext.fill()}function sendDataWithoutNeedingAResponse(e){var t="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");t.open("get",e,!0),t.send()}function postData(e,t){var a="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");a.open("post",e,!0),a.setRequestHeader("Content-Type","application/x-www-form-urlencoded;"),a.send(t)}function cardGamePlayer2Wins(){hero.stats.cardGamesWon++,hero.currency.cardDust+=7,UI.updateCurrencies(),processPlayerWinSpeech(thisChallengeNPC,thisChallengeNPC.cardGameSpeech.lose[0],thisChallengeNPC.cardGameSpeech.lose[1]),closeCardGame()}function cardGamePlayer1Wins(){hero.stats.cardGamesLost++,hero.currency.cardDust+=1,UI.updateCurrencies(),processSpeech(thisChallengeNPC,thisChallengeNPC.cardGameSpeech.win[0],thisChallengeNPC.cardGameSpeech.win[1]),closeCardGame()}function cardGameIsDrawn(){hero.stats.cardGamesDrawn++,hero.currency.cardDust+=3,UI.updateCurrencies(),processSpeech(thisChallengeNPC,thisChallengeNPC.cardGameSpeech.draw[0],thisChallengeNPC.cardGameSpeech.draw[1]),closeCardGame()}function processPlayerWinSpeech(e,t,a){if(""!=a){var i=a.split("|"),o=i[1];questData[o].hasBeenCompleted<1?giveQuestRewards(o)&&(questData[o].isRepeatable>0?questData[o].hasBeenCompleted=0:questData[o].hasBeenCompleted=1,UI.showDialogue(e,e.cardGameSpeech.lose[0]+i[2]),canCloseDialogueBalloonNextClick=!0,checkForTitlesAwarded(o)):processSpeech(e,e.cardGameSpeech.lose[0],e.cardGameSpeech.lose[1])}else processSpeech(e,e.cardGameSpeech.lose[0],e.cardGameSpeech.lose[1])}function startCardGame(e){hero.cards.length>=12?(cardGameNameSpace.player2Cards=hero.cards.slice(0,12),cardGameNameSpace.player1Cards=e.uniqueCards.concat(allCardPacks[e.baseCardPack]).slice(0,12),cardGameNameSpace.player1Skill=e.cardSkill,e.cardBackColour?cardGameNameSpace.NPCCardBackColour=e.cardBackColour:cardGameNameSpace.NPCCardBackColour=void 0,cardGameNameSpace.initialiseCardGame(),cardGameWrapper.classList.add("active")):UI.showNotification("<p>You don't have enough cards</p>")}function closeCardGame(){gameMode="play",cardGameWrapper.classList.remove("active"),document.getElementById("cardGame").removeEventListener("click",cardGameNameSpace.canvasClick,!1)}function pickBestCardToTake(e){for(var t,a=-1,i=0,o=0;o<e.length;o++)t=cardGameNameSpace.allCardData[e[o]][0]*cardGameNameSpace.allCardData[e[o]][0]+cardGameNameSpace.allCardData[e[o]][1]*cardGameNameSpace.allCardData[e[o]][1],t>a&&(a=t,i=o);return i}function openBoosterPack(){boosterCardsToAdd=[];var e;do e=getRandomInteger(1,cardGameNameSpace.allCardData.length),-1==boosterCardsToAdd.indexOf(e)&&boosterCardsToAdd.push(e);while(boosterCardsToAdd.length<5);for(var t=document.getElementsByClassName("cardFlip"),a=0;a<t.length;a++)t[a].classList.remove("active");for(var i,a=0;5>a;a++)i="",-1==hero.cards.indexOf(boosterCardsToAdd[a])&&(i=' class="new"'),boosterCardsToAdd[a]<0?document.getElementById("boosterCard"+a).innerHTML='<div class="rare"><div class="card players" style="background-image:url(/images/card-game/cards/'+boosterCardsToAdd[a]+'.png)"></div></div>':document.getElementById("boosterCard"+a).innerHTML="<img"+i+' src="/images/card-game/cards/'+boosterCardsToAdd[a]+'.png" alt="'+cardGameNameSpace.allCardData[boosterCardsToAdd[a][3]]+'">';boosterPack.classList.add("active"),boosterCardsRevealed=0,boosterPack.addEventListener("click",revealBoosterCard,!1)}function revealBoosterCard(e){"IMG"==e.target.nodeName&&(e.target.parentNode.parentNode.parentNode.classList.add("active"),boosterCardsRevealed++,boosterCardsRevealed>=5&&(hero.cards=boosterCardsToAdd.concat(hero.cards),UI.updateCardAlbum(),boosterPack.classList.remove("active")))}function canAddItemToInventory(e){for(var t=JSON.parse(JSON.stringify(hero.inventory)),a=[],i=!0,o=0;o<e.length;o++){var n=0,r=getObjectKeysForInnerValue(t,e[o].type,"type");if(r.length>0)for(var s=0;s<r.length;s++)if(itemAttributesMatch(t[r[s]],e[o])){var c=t[r[s]].quantity,l=maxNumberOfItemsPerSlot-c>e[o].quantity-n?e[o].quantity-n:maxNumberOfItemsPerSlot-c;if(n+=l,l>0&&(a.push(r[s]),t[r[s]].quantity+=l),n>=e[o].quantity)break}if(n<e[o].quantity)e:for(var s=0;s<hero.bags.length;s++)for(var h=currentActiveInventoryItems[hero.bags[s].type].actionValue,d=0;h>d;d++){var u=s+"-"+d;if(!(u in t)){var l=maxNumberOfItemsPerSlot>e[o].quantity-n?e[o].quantity-n:maxNumberOfItemsPerSlot;if(n+=l,a.push(u),t[u]=new Object,t[u].type=e[o].type,t[u].quantity=l,t[u].quality=e[o].quality,t[u].durability=e[o].durability,t[u].currentWear=e[o].currentWear,t[u].effectiveness=e[o].effectiveness,t[u].wrapped=e[o].wrapped,t[u].colour=e[o].colour,t[u].enchanted=e[o].enchanted,t[u].hallmark=e[o].hallmark,t[u].inscription={},t[u].inscription.title=e[o].inscription.title,t[u].inscription.content=e[o].inscription.content,t[u].inscription.timeCreated=e[o].inscription.timeCreated,n>=e[o].quantity)break e}}n!=e[o].quantity&&(i=!1)}return i?(hero.inventory=JSON.parse(JSON.stringify(t)),UI.updatePanelsAfterInventoryChange(),[!0,a]):[!1]}function hasItemInInventory(e,t){var a=0,i=getObjectKeysForInnerValue(hero.inventory,parseInt(e),"type");if(i.length>0)for(var o=0;o<i.length;o++)a+=hero.inventory[i[o]].quantity;return a>=t?!0:!1}function findSlotItemIdInInventory(e){var t=[];for(var a in hero.inventory)hero.inventory[a].type==e&&t.push(a);return t}function hasItemTypeInInventory(e){var t=[];for(var a in hero.inventory)currentActiveInventoryItems[hero.inventory[a].type].group==e&&t.push(a);return t}function removeItemTypeFromInventory(e,t){var a,i=t,o=getObjectKeysForInnerValue(hero.inventory,parseInt(e),"type");if(o.length>0)for(var n=0;n<o.length;n++)a=hero.inventory[o[n]].quantity,a>i?(removeFromInventory(o[n],i),i=0):(removeFromInventory(o[n],a),i-=a)}function addToInventory(e,t){hero.inventory[e]=JSON.parse(JSON.stringify(t)),document.getElementById("slot"+e).innerHTML=generateSlotMarkup(e)}function removeFromInventory(e,t){var a=hero.inventory[e].quantity,i=document.getElementById("slot"+e);a-t>0?(hero.inventory[e].quantity-=t,updateQuantity(e)):(delete hero.inventory[e],i.innerHTML="")}function updateQuantity(e){for(var t=document.getElementById("slot"+e),a=0;a<t.childNodes.length;a++)"qty"==t.childNodes[a].className&&(t.childNodes[a].innerHTML=hero.inventory[e].quantity),"P"==t.childNodes[a].nodeName&&(t.childNodes[a].childNodes[2].innerHTML="Sell price: "+parseMoney(Math.ceil(hero.inventory[e].quantity*sellPriceModifier*inflationModifier*currentActiveInventoryItems[hero.inventory[e].type].priceCode,0)))}function itemAttributesMatch(e,t){return e.type==t.type&&e.quality==t.quality&&e.durability==t.durability&&e.currentWear==t.currentWear&&e.effectiveness==t.effectiveness&&e.colour==t.colour&&e.enchanted==t.enchanted&&e.hallmark==t.hallmark&&e.inscription.title==t.inscription.title&&e.inscription.content==t.inscription.content&&e.inscription.timeCreated==t.inscription.timeCreated&&e.contains==t.contains?!0:!1}function inventoryItemAction(e,t,a){var i=e.parentElement.id.substring(4);switch(t){case"container":if("undefined"!=typeof hero.inventory[i].contains)if(1==hero.inventory[i].contains.length&&1==hero.inventory[i].quantity)hero.inventory[i]=JSON.parse(JSON.stringify(hero.inventory[i].contains[0])),document.getElementById("slot"+i).innerHTML=generateSlotMarkup(i),UI.showChangeInInventory([i]);else{var o=JSON.parse(JSON.stringify(hero.inventory[i]));removeFromInventory(i,1);var n=canAddItemToInventory(o.contains);n[0]?(document.getElementById("slot"+i).innerHTML=generateSlotMarkup(i),UI.showChangeInInventory(n[1])):(hero.inventory[i]=JSON.parse(JSON.stringify(o)),UI.showNotification("<p>You don't have room for all of these items.</p>"))}break;case"booster":openBoosterPack(),removeFromInventory(i,1);break;case"bag":UI.addNewBag(hero.inventory[i]),audio.playSound(soundEffects.bagOpen,0),removeFromInventory(i,1);break;case"inscribe":UI.openInscriptionPanel();break;case"card":hero.cards.unshift(a),UI.updateCardAlbum(),removeFromInventory(i,1);break;case"book":document.getElementById("book"+a).classList.add("active"),audio.playSound(soundEffects.bookOpen,0);case"recipe":canLearnRecipe(a)&&removeFromInventory(i,1);break;case"craft":-1!=hero.professionsKnown.indexOf(parseInt(a))?(audio.playSound(soundEffects.buttonClick,0),UI.populateRecipeList(a)):UI.showNotification("<p>You don't know this profession yet.</p>")}}function additionalTooltipDetail(e){var t="";if("recipe"==currentActiveInventoryItems[hero.inventory[e].type].action){for(var a=!1,i=0;i<hero.recipesKnown.length;i++)hero.recipesKnown[i][0]==currentActiveInventoryItems[hero.inventory[e].type].actionValue&&(a=!0);a&&(t+=" (already known)")}return t}function generateSlotMarkup(e){var t="",a="",i="",o="",n=getColourName(hero.inventory[e].colour,hero.inventory[e].type);""!=n&&(a=n+" ",i="-"+n.toLowerCase());var r=currentActiveInventoryItems[hero.inventory[e].type].action,s=!1;r&&"book"==r&&hero.inventory[e].inscription.content&&(s=!0);var c="";if(r)if(s){var l=generateHash(hero.inventory[e].inscription.title+hero.inventory[e].colour+hero.inventory[e].type+hero.inventory[e].inscription.timeCreated);c='data-action="'+r+'" data-action-value="'+l+'" ',UI.buildBook(e,l)}else c='data-action="'+r+'" data-action-value="'+currentActiveInventoryItems[hero.inventory[e].type].actionValue+'" ';for(var h=currentActiveInventoryItems[hero.inventory[e].type].category.split(","),d=0;d<h.length;d++)o+="itemCategory"+h[d]+" ";if("card"==currentActiveInventoryItems[hero.inventory[e].type].action&&(o+="players card"),t+='<img src="/images/game-world/inventory-items/'+hero.inventory[e].type+i+'.png" '+c+'alt="'+a+currentActiveInventoryItems[hero.inventory[e].type].shortname+'" class="'+o+'">',s)var u="&quot;"+hero.inventory[e].inscription.title+"&quot;";else var u=currentActiveInventoryItems[hero.inventory[e].type].description;if(-1!=u.indexOf("##contains##")&&"undefined"!=typeof hero.inventory[e].contains){for(var p="",d=0;d<hero.inventory[e].contains.length;d++)0!=d&&(p+=", "),p+=hero.inventory[e].contains[d].quantity+"x "+currentActiveInventoryItems[hero.inventory[e].contains[d].type].shortname;u=u.replace("##contains##",p)}return t+="<p><em>"+a+currentActiveInventoryItems[hero.inventory[e].type].shortname+" </em>"+u+" ",t+='<span class="price">Sell price: '+parseMoney(Math.ceil(hero.inventory[e].quantity*sellPriceModifier*inflationModifier*currentActiveInventoryItems[hero.inventory[e].type].priceCode,0))+"</span>",t+='<span class="price specialismPrice">Sell price: '+parseMoney(Math.ceil(hero.inventory[e].quantity*sellPriceSpecialismModifier*inflationModifier*currentActiveInventoryItems[hero.inventory[e].type].priceCode,0))+"</span>",t+=additionalTooltipDetail(e)+"</p>",t+='<span class="qty">'+hero.inventory[e].quantity+"</span>"}function inventorySplitStackSubmit(e){e&&e.preventDefault();var t=splitStackInput.value,a=!0;if(t=parseInt(t),1>t&&(a=!1),Number.isInteger(t)||(a=!1),t>hero.inventory[UI.sourceSlot].quantity&&(a=!1),a){isSplitStackBeingDragged=!0;var i=document.getElementById("slot"+UI.sourceSlot);UI.activeDragObject=document.getElementById("draggableInventorySlot"),UI.activeDragObject.innerHTML=i.innerHTML,removeFromInventory(UI.sourceSlot,t),UI.draggedInventoryObject.quantity=t;for(var o=0;o<UI.activeDragObject.childNodes.length;o++)if("qty"==UI.activeDragObject.childNodes[o].className){UI.activeDragObject.childNodes[o].innerHTML=UI.draggedInventoryObject.quantity;break}UI.inDrag=!0;var n=i.getBoundingClientRect(),r=(window.pageYOffset||document.documentElement.scrollTop)-(document.documentElement.clientTop||0);objInitLeft=n.left+3,objInitTop=n.top+3+r,dragStartX=objInitLeft+22,dragStartY=objInitTop+22,UI.activeDragObject.style.cssText="z-index:2;top: "+objInitTop+"px; left: "+objInitLeft+"px; transform: translate(0px, 0px);",document.addEventListener("mousemove",UI.handleDrag,!1),document.addEventListener("mouseup",UI.endInventoryDrag,!1)}splitStackPanel.classList.remove("active")}function inventorySplitStackCancel(){splitStackPanel.classList.remove("active")}function movePet(){if(hasActivePet)for(var e=0;e<hero.activePets.length;e++){if("moving"==hero.allPets[hero.activePets[e]].state){var t,a,i,o,n=hero.allPets[hero.activePets[e]].x,r=hero.allPets[hero.activePets[e]].y;switch(hero.allPets[hero.activePets[e]].drawnFacing=hero.allPets[hero.activePets[e]].facing,hero.allPets[hero.activePets[e]].facing){case"n":if(hero.allPets[hero.activePets[e]].y-=hero.allPets[hero.activePets[e]].speed,isATerrainCollision(hero.allPets[hero.activePets[e]].x-hero.allPets[hero.activePets[e]].width/2,hero.allPets[hero.activePets[e]].y-hero.allPets[hero.activePets[e]].height/2)||isATerrainCollision(hero.allPets[hero.activePets[e]].x+hero.allPets[hero.activePets[e]].width/2,hero.allPets[hero.activePets[e]].y-hero.allPets[hero.activePets[e]].height/2)){var s=getTileY(hero.allPets[hero.activePets[e]].y-hero.allPets[hero.activePets[e]].height/2),c=(s+1)*tileW;hero.allPets[hero.activePets[e]].y=c+hero.allPets[hero.activePets[e]].height/2+1}break;case"s":if(hero.allPets[hero.activePets[e]].y+=hero.allPets[hero.activePets[e]].speed,isATerrainCollision(hero.allPets[hero.activePets[e]].x-hero.allPets[hero.activePets[e]].width/2,hero.allPets[hero.activePets[e]].y+hero.allPets[hero.activePets[e]].height/2)||isATerrainCollision(hero.allPets[hero.activePets[e]].x+hero.allPets[hero.activePets[e]].width/2,hero.allPets[hero.activePets[e]].y+hero.allPets[hero.activePets[e]].height/2)){var s=getTileY(hero.allPets[hero.activePets[e]].y+hero.allPets[hero.activePets[e]].height/2),l=s*tileW;hero.allPets[hero.activePets[e]].y=l-hero.allPets[hero.activePets[e]].height/2-1}break;case"w":if(hero.allPets[hero.activePets[e]].x-=hero.allPets[hero.activePets[e]].speed,isATerrainCollision(hero.allPets[hero.activePets[e]].x-hero.allPets[hero.activePets[e]].width/2,hero.allPets[hero.activePets[e]].y+hero.allPets[hero.activePets[e]].height/2)||isATerrainCollision(hero.allPets[hero.activePets[e]].x-hero.allPets[hero.activePets[e]].width/2,hero.allPets[hero.activePets[e]].y-hero.allPets[hero.activePets[e]].height/2)){var s=getTileX(hero.allPets[hero.activePets[e]].x-hero.allPets[hero.activePets[e]].width/2),h=(s+1)*tileW;hero.allPets[hero.activePets[e]].x=h+hero.allPets[hero.activePets[e]].width/2+1}break;case"e":if(hero.allPets[hero.activePets[e]].x+=hero.allPets[hero.activePets[e]].speed,isATerrainCollision(hero.allPets[hero.activePets[e]].x+hero.allPets[hero.activePets[e]].width/2,hero.allPets[hero.activePets[e]].y+hero.allPets[hero.activePets[e]].height/2)||isATerrainCollision(hero.allPets[hero.activePets[e]].x+hero.allPets[hero.activePets[e]].width/2,hero.allPets[hero.activePets[e]].y-hero.allPets[hero.activePets[e]].height/2)){var s=getTileX(hero.allPets[hero.activePets[e]].x+hero.allPets[hero.activePets[e]].width/2),d=s*tileW;hero.allPets[hero.activePets[e]].x=d-hero.allPets[hero.activePets[e]].width/2-1}}for(var u=0;u<thisMapData.npcs.length;u++)t=thisMapData.npcs[u],t.isCollidable&&isAnObjectCollision(hero.allPets[hero.activePets[e]].x,hero.allPets[hero.activePets[e]].y,hero.allPets[hero.activePets[e]].width,hero.allPets[hero.activePets[e]].height,t.x,t.y,t.width,t.height)&&(hero.allPets[hero.activePets[e]].x=n,hero.allPets[hero.activePets[e]].y=r);for(var u=0;u<hero.activePets.length;u++)e!=u&&(o=hero.allPets[hero.activePets[u]],isAnObjectCollision(hero.allPets[hero.activePets[e]].x,hero.allPets[hero.activePets[e]].y,hero.allPets[hero.activePets[e]].width,hero.allPets[hero.activePets[e]].height,o.x,o.y,o.width,o.height)&&(hero.allPets[hero.activePets[e]].x=n,hero.allPets[hero.activePets[e]].y=r));for(var u=0;u<thisMapData.items.length;u++)a=thisMapData.items[u],isAnObjectCollision(hero.allPets[hero.activePets[e]].x,hero.allPets[hero.activePets[e]].y,hero.allPets[hero.activePets[e]].width,hero.allPets[hero.activePets[e]].height,a.x,a.y,a.width,a.height)&&(hero.allPets[hero.activePets[e]].x=n,hero.allPets[hero.activePets[e]].y=r);hero.allPets[hero.activePets[e]].dx+=hero.allPets[hero.activePets[e]].x-n,hero.allPets[hero.activePets[e]].dy+=hero.allPets[hero.activePets[e]].y-r;var p=!1;Math.abs(hero.allPets[hero.activePets[e]].dx)>=tileW&&(hero.allPets[hero.activePets[e]].dx>0?hero.allPets[hero.activePets[e]].dx-=tileW:hero.allPets[hero.activePets[e]].dx+=tileW,p=!0),Math.abs(hero.allPets[hero.activePets[e]].dy)>=tileW&&(hero.allPets[hero.activePets[e]].dy>0?hero.allPets[hero.activePets[e]].dy-=tileW:hero.allPets[hero.activePets[e]].dy+=tileW,p=!0)}else"findingPath"!=hero.allPets[hero.activePets[e]].state&&(isInRange(hero.x,hero.y,hero.allPets[hero.activePets[e]].x,hero.allPets[hero.activePets[e]].y,96)||(hero.allPets[hero.activePets[e]].state="moving"));if(p)if(hero.allPets[hero.activePets[e]].tileX=getTileX(hero.allPets[hero.activePets[e]].x),hero.allPets[hero.activePets[e]].tileY=getTileY(hero.allPets[hero.activePets[e]].y),e!=hero.activePets.length-1&&(hero.allPets[hero.activePets[e]].breadcrumb.pop(),hero.allPets[hero.activePets[e]].breadcrumb.unshift([hero.allPets[hero.activePets[e]].tileX,hero.allPets[hero.activePets[e]].tileY])),i=hero.allPets[hero.activePets[e]].following,1==e&&console.log(i.x+", "+i.y+" - "+hero.allPets[hero.activePets[e]].x+", "+hero.allPets[hero.activePets[e]].y),isInRange(i.x,i.y,hero.allPets[hero.activePets[e]].x,hero.allPets[hero.activePets[e]].y,96))1==e&&console.log("pet close enough"),hero.allPets[hero.activePets[e]].state="wait";else{for(var g=!1,m=0;m<i.breadcrumb.length;m++)if(hero.allPets[hero.activePets[e]].tileY==i.breadcrumb[m][1]){if(hero.allPets[hero.activePets[e]].tileX-1==i.breadcrumb[m][0]){hero.allPets[hero.activePets[e]].facing="w",g=!0;break}if(hero.allPets[hero.activePets[e]].tileX+1==i.breadcrumb[m][0]){hero.allPets[hero.activePets[e]].facing="e",g=!0;break}}else if(hero.allPets[hero.activePets[e]].tileX==i.breadcrumb[m][0]){if(hero.allPets[hero.activePets[e]].tileY+1==i.breadcrumb[m][1]){hero.allPets[hero.activePets[e]].facing="s",g=!0;break}if(hero.allPets[hero.activePets[e]].tileY-1==i.breadcrumb[m][1]){hero.allPets[hero.activePets[e]].facing="n",g=!0;break}}g?(hero.allPets[hero.activePets[e]].state="moving",hero.allPets[hero.activePets[e]].foundPath=""):""!=hero.allPets[hero.activePets[e]].foundPath?(hero.allPets[hero.activePets[e]].facing=hero.allPets[hero.activePets[e]].foundPath[hero.allPets[hero.activePets[e]].pathIndex],hero.allPets[hero.activePets[e]].pathIndex++,hero.allPets[hero.activePets[e]].pathIndex>=hero.allPets[hero.activePets[e]].foundPath.length&&(console.log("path ran out"),pathfindingWorker.postMessage(["petToHero",hero.allPets[hero.activePets[e]],thisMapData,i.tileX,i.tileY,e]),hero.allPets[hero.activePets[e]].state="findingPath",hero.allPets[hero.activePets[e]].foundPath="")):"findingPath"!=hero.allPets[hero.activePets[e]].state&&(pathfindingWorker.postMessage(["petToHero",hero.allPets[hero.activePets[e]],thisMapData,i.tileX,i.tileY,e]),hero.allPets[hero.activePets[e]].state="findingPath")}}}function pushPetAway(e){hero.allPets[hero.activePets[e]].state="moving",hero.allPets[hero.activePets[e]].facing=hero.facing}function sizeCanvasSize(){gameContext.canvas.width=window.innerWidth,gameContext.canvas.height=window.innerHeight,canvasWidth=window.innerWidth,canvasHeight=window.innerHeight}function init(){gameCanvas=document.getElementById("gameWorld"),gameCanvas.getContext&&(gameContext=gameCanvas.getContext("2d"),sizeCanvasSize(),whichTransitionEvent=determineWhichTransitionEvent(),whichAnimationEvent=determineWhichAnimationEvent(),gameMode="mapLoading",cartographyCanvas=document.getElementById("cartographyCanvas"),cartographyContext=cartographyCanvas.getContext("2d"),offScreenCartographyCanvas=document.getElementById("offScreenCartographyCanvas"),offScreenCartographyContext=offScreenCartographyCanvas.getContext("2d"),canvasMapImage=document.createElement("img"),
canvasMapMaskImage=document.createElement("img"),UI.init(),audio.init(),Input.init(),gameLoop(),getHeroGameState())}function getHeroGameState(){getJSON("/data/chr"+characterId+"/gameState.json",function(e){hero.tileX=e.tileX,hero.tileY=e.tileY,currentMap=e.currentMap,newMap=currentMap,hero.bags=e.bags,hero.cards=e.cards,hero.stats=e.stats,gameSettings=e.settings,hero.currency=e.currency,hero.titlesEarned=e.titlesEarned,hero.activeTitle=e.activeTitle,hero.recipesKnown=e.recipesKnown,hero.professionsKnown=e.professionsKnown,hero.totalGameTimePlayed=e.totalGameTimePlayed,timeSinceLastAmbientSoundWasPlayed=hero.totalGameTimePlayed+1500,e.allPets&&(e.activePets.length>0&&(hasActivePet=!0),hero.activePets=e.activePets,hero.allPets=e.allPets);for(var t in e.fae)fae[t]=e.fae[t];hero.inventory=e.inventory,currentMap>0&&sendDataWithoutNeedingAResponse("/game-world/generateDungeonMap.php?playerId="+characterId+"&clearMaps=true"),loadCoreAssets()},function(e){getHeroGameState()})}function loadCoreAssets(){var e=[];if(e.push({name:"heroImg",src:"/images/game-world/core/test-iso-hero.png"}),hasActivePet)for(var t=0;t<hero.activePets.length;t++)e.push({name:"activePet"+hero.activePets[t],src:"/images/game-world/npcs/"+hero.allPets[hero.activePets[t]].src});Loader.preload(e,prepareCoreAssets,loadingProgress)}function prepareCoreAssets(){if(heroImg=Loader.getImage("heroImg"),hasActivePet)for(var e=0;e<hero.activePets.length;e++)activePetImages[e]=Loader.getImage("activePet"+hero.activePets[e]);getColours()}function loadCardData(){getJSON("/game-world/getCardDetails.php",function(e){cardGameNameSpace.allCardData=e.cards,loadMap()},function(e){loadCardData()})}function loadMapJSON(e){getJSON(e,function(e){thisMapData=e.map,mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length,previousZoneName!=thisMapData.zoneName&&(UI.showZoneName(thisMapData.zoneName),document.title="Autumn Earth - "+thisMapData.zoneName,cartographicTitle.innerHTML=thisMapData.zoneName),initCartographicMap(),findProfessionsAndRecipes(),thisMapData.ambientSounds&&audio.loadAmbientSounds(thisMapData.ambientSounds),fae.recentHotspots=[]},function(t){loadMapJSON(e)})}function loadMap(){var e;if(console.log("going from "+currentMap+" to "+newMap),0>newMap&&currentMap>0?(randomDungeonName=randomDungeons[Math.abs(newMap)],newMap=-1):e="/game-world/getMap.php?chr="+characterId+"&map="+newMap,0>newMap){var t=0,a=0,i=thisMapData.doors;for(var o in i)i[o].map==newMap&&(t+=i[o].startX,a+=i[o].startY);var n=t/3,r=a/3;e="/game-world/generateDungeonMap.php?playerId="+characterId+"&originatingMapId="+currentMap+"&requestedMap="+newMap+"&dungeonName="+randomDungeonName+"&connectingDoorX="+n+"&connectingDoorY="+r}currentMap=newMap,loadMapJSON(e)}function loadMapAssets(){imagesToLoad=[];var e,t,a=currentMap;0>currentMap&&(a="dungeon/"+randomDungeonName),imagesToLoad.push({name:"backgroundImg",src:"/images/game-world/maps/"+a+"/bg.png"}),tileGraphicsToLoad=thisMapData.graphics;for(var i=0;i<tileGraphicsToLoad.length;i++)imagesToLoad.push({name:"tile"+i,src:"/images/game-world/maps/"+a+"/"+tileGraphicsToLoad[i].src});npcGraphicsToLoad=thisMapData.npcs;for(var i=0;i<npcGraphicsToLoad.length;i++)imagesToLoad.push({name:"npc"+npcGraphicsToLoad[i].name,src:"/images/game-world/npcs/"+npcGraphicsToLoad[i].src});itemGraphicsToLoad=[];for(var o="",i=0;i<thisMapData.items.length;i++)e="",thisMapData.items[i].colour&&(t=getColourName(thisMapData.items[i].colour,thisMapData.items[i].type),""!=t&&(e="-"+t.toLowerCase())),o="item"+thisMapData.items[i].type+e,-1==itemGraphicsToLoad.indexOf(o)&&(imagesToLoad.push({name:o,src:"/images/game-world/items/"+currentActiveInventoryItems[thisMapData.items[i].type].worldSrc+e+".png"}),itemGraphicsToLoad.push(o));Loader.preload(imagesToLoad,prepareGame,loadingProgress)}function loadTitles(){var e=hero.titlesEarned.join("|");getJSON("/game-world/getActiveTitles.php?whichIds="+e,function(e){activeTitles=e,loadCardData()},function(e){loadTitles()})}function getColours(){getJSON("/game-world/getColours.php",function(e){colourNames=e.colourNames,getQuestDetails()},function(e){getColours()})}function getQuestDetails(){getJSON("/game-world/getQuestDetails.php?chr="+characterId,function(e){questData=e.quests,loadTitles()},function(e){getQuestDetails()})}function findProfessionsAndRecipes(){for(var e="",t=0;t<hero.recipesKnown.length;t++)e+=hero.recipesKnown[t][0]+"|";e=e.slice(0,-1),loadProfessionsAndRecipes(e)}function loadProfessionsAndRecipes(e){getJSON("/game-world/getProfessionsAndRecipes.php?whichIds="+e,function(e){hero.crafting=e.professions,currentItemGroupFilters=e.itemGroups,getShopData()},function(t){loadProfessionsAndRecipes(e)})}function getShopData(){if(thisMapShopItemIds="",0==thisMapData.shops.length)findInventoryItemData();else{for(var e=JSON.parse('{"mapNumber": '+currentMap+',"shops": '+JSON.stringify(thisMapData.shops)+"}"),t=0;t<e.shops.length;t++)e.shops[t].hash=generateHash(e.shops[t].name);loadShopData("shopData="+JSON.stringify(e))}}function loadShopData(e){getJSONWithParams("/game-world/getShopItems.php",e,function(e){thisMapShopItemIds=e.allItemIds,UI.buildShop(e.markup),findInventoryItemData()},function(t){loadShopData(e)})}function findInventoryItemData(){var e,t=[];for(var a in hero.inventory)if(t.push(hero.inventory[a].type),"undefined"!=typeof hero.inventory[a].contains)for(var i=0;i<hero.inventory[a].contains.length;i++)t.push(hero.inventory[a].contains[i].type);for(var i=0;i<hero.bags.length;i++)t.push(hero.bags[i].type);for(var i=0;i<thisMapData.items.length;i++)t.push(thisMapData.items[i].type);for(var i in hero.crafting)for(var o in hero.crafting[i].filters.All){t.push(hero.crafting[i].recipes[hero.crafting[i].filters.All[o]].creates),e=hero.crafting[i].recipes[hero.crafting[i].filters.All[o]].components.split(",");for(var n=0;n<e.length;n++)isNaN(e[n])||t.push(e[n])}""!=thisMapShopItemIds&&t.push(thisMapShopItemIds),t=uniqueValues(t),loadInventoryItemData(t.join("|"))}function loadInventoryItemData(e){getJSON("/game-world/getInventoryItems.php?whichIds="+e,function(e){currentActiveInventoryItems=e,inventoryInterfaceIsBuilt||UI.buildInventoryInterface(),loadMapAssets()},function(t){loadInventoryItemData(e)})}function prepareGame(){tileImages=[];for(var e=0;e<tileGraphicsToLoad.length;e++)tileImages[e]=Loader.getImage("tile"+e);npcImages=[];for(var e=0;e<npcGraphicsToLoad.length;e++)npcImages[npcGraphicsToLoad[e].name]=Loader.getImage("npc"+npcGraphicsToLoad[e].name);itemImages=[];for(var e=0;e<itemGraphicsToLoad.length;e++)itemImages[itemGraphicsToLoad[e]]=Loader.getImage(itemGraphicsToLoad[e]);backgroundImg=Loader.getImage("backgroundImg");for(var e=0;e<thisMapData.npcs.length;e++)thisMapData.npcs[e].x=getTileCentreCoordX(thisMapData.npcs[e].tileX),thisMapData.npcs[e].y=getTileCentreCoordY(thisMapData.npcs[e].tileY),thisMapData.npcs[e].z=getElevation(thisMapData.npcs[e].tileX,thisMapData.npcs[e].tileY),thisMapData.npcs[e].drawnFacing=thisMapData.npcs[e].facing,thisMapData.npcs[e].dx=0,thisMapData.npcs[e].dy=0,thisMapData.npcs[e].movementIndex=-1,thisMapData.npcs[e].forceNewMovementCheck=!0,thisMapData.npcs[e].lastTargetDestination="";if(hasActivePet)for(var e=0;e<hero.activePets.length;e++)if(hero.allPets[hero.activePets[e]].x=getTileCentreCoordX(hero.allPets[hero.activePets[e]].tileX),hero.allPets[hero.activePets[e]].y=getTileCentreCoordY(hero.allPets[hero.activePets[e]].tileY),hero.allPets[hero.activePets[e]].z=getElevation(hero.allPets[hero.activePets[e]].tileX,hero.allPets[hero.activePets[e]].tileY),hero.allPets[hero.activePets[e]].dx=0,hero.allPets[hero.activePets[e]].dy=0,hero.allPets[hero.activePets[e]].foundPath="",hero.allPets[hero.activePets[e]].state="wait",0==e?hero.allPets[hero.activePets[e]].following=hero:hero.allPets[hero.activePets[e]].following=hero.allPets[hero.activePets[e-1]],e!=hero.activePets.length-1){hero.allPets[hero.activePets[e]].breadcrumb=[];for(var t=0;breadCrumbLength>t;t++)hero.allPets[hero.activePets[e]].breadcrumb[t]=[hero.allPets[hero.activePets[e]].tileX,hero.allPets[hero.activePets[e]].tileY]}for(var e=0;breadCrumbLength>e;e++)hero.breadcrumb[e]=[hero.tileX,hero.tileY];for(var e=0;e<thisMapData.items.length;e++)thisMapData.items[e].x=getTileCentreCoordX(thisMapData.items[e].tileX),thisMapData.items[e].y=getTileCentreCoordY(thisMapData.items[e].tileY),thisMapData.items[e].z=getElevation(thisMapData.items[e].tileX,thisMapData.items[e].tileY),thisMapData.items[e].width=currentActiveInventoryItems[thisMapData.items[e].type].width,thisMapData.items[e].height=currentActiveInventoryItems[thisMapData.items[e].type].height,thisMapData.items[e].centreX=currentActiveInventoryItems[thisMapData.items[e].type].centreX,thisMapData.items[e].centreY=currentActiveInventoryItems[thisMapData.items[e].type].centreY,"node"==currentActiveInventoryItems[thisMapData.items[e].type].action&&(thisMapData.items[e].timeLastHarvested||(thisMapData.items[e].timeLastHarvested=hero.totalGameTimePlayed-currentActiveInventoryItems[thisMapData.items[e].type].respawnRate));activeNPCForDialogue="",hero.x=getTileCentreCoordX(hero.tileX),hero.y=getTileCentreCoordY(hero.tileY),hero.z=getElevation(hero.tileX,hero.tileY),fae.x=hero.x+96,fae.y=hero.y+48,fae.currentState="hero",fae.z=hero.z,fae.dz=1,timeSinceLastFrameSwap=0,currentAnimationFrame=0,mapTransition="in",mapTransitionCurrentFrames=1,gameMode="play"}function removeMapAssets(){for(var e=0;e<tileGraphicsToLoad.length;e++)tileImages[e].src="",tileImages[e]=null;for(var e=0;e<npcGraphicsToLoad.length;e++)npcImages[thisMapData.npcs[e].name].src="",npcImages[thisMapData.npcs[e].name]=null;for(var e in itemGraphicsToLoad)itemImages[itemGraphicsToLoad[e]].src="",itemImages[itemGraphicsToLoad[e]]=null;backgroundImg.src="",backgroundImg=null}function loadingProgress(){}function changeMaps(e,t){previousZoneName=thisMapData.zoneName,gameMode="mapLoading",removeMapAssets();var a=thisMapData.doors,i=getTileX(e)+","+getTileX(t);if(hero.tileX=a[i].startX,hero.tileY=a[i].startY,hasActivePet){var o=0,n=0;switch(hero.facing){case"n":n=1;break;case"s":n=-1;break;case"e":n=-1;break;case"w":n=1}for(var r=0;r<hero.activePets.length;r++)hero.allPets[hero.activePets[r]].tileX=a[i].startX+o,hero.allPets[hero.activePets[r]].tileY=a[i].startY+n,hero.allPets[hero.activePets[r]].state="moving",hero.allPets[hero.activePets[r]].facing=hero.facing}newMap=a[i].map,loadMap()}function isATerrainCollision(e,t){var a=getTileX(e),i=getTileY(t);if(0>a||0>i||a>=mapTilesX||i>=mapTilesY)return 1;switch(thisMapData.collisions[i][a]){case 1:return 1;case"<":case">":case"^":case"v":return 0;case"d":return activeDoorX=e,activeDoorY=t,0;default:return 0}}function startDoorTransition(){""==mapTransition&&(mapTransitionCurrentFrames=1,mapTransition="out",""!=activeNPCForDialogue&&(dialogue.classList.remove("active"),UI.removeActiveDialogue())),0>currentMap&&saveCartographyMask()}function getHeroAsCloseAsPossibleToObject(e,t,a,i){switch(hero.facing){case"n":hero.y=t+i/2+hero.height/2+1;break;case"s":hero.y=t-i/2-hero.height/2-1;break;case"w":hero.x=e+a/2+hero.width/2+1;break;case"e":hero.x=e-a/2-hero.width/2-1}}function checkHeroCollisions(){if(activeDoorX=-1,activeDoorY=-1,key[2])if(isATerrainCollision(hero.x-hero.width/2,hero.y-hero.height/2)||isATerrainCollision(hero.x+hero.width/2,hero.y-hero.height/2)){var e=getTileY(hero.y-hero.height/2),t=(e+1)*tileW;hero.y=t+hero.height/2+1}else-1!=activeDoorX&&startDoorTransition();if(key[3])if(isATerrainCollision(hero.x-hero.width/2,hero.y+hero.height/2)||isATerrainCollision(hero.x+hero.width/2,hero.y+hero.height/2)){var e=getTileY(hero.y+hero.height/2),a=e*tileW;hero.y=a-hero.height/2-1}else-1!=activeDoorX&&startDoorTransition();if(key[0])if(isATerrainCollision(hero.x-hero.width/2,hero.y+hero.height/2)||isATerrainCollision(hero.x-hero.width/2,hero.y-hero.height/2)){var e=getTileX(hero.x-hero.width/2),i=(e+1)*tileW;hero.x=i+hero.width/2+1}else-1!=activeDoorX&&startDoorTransition();if(key[1])if(isATerrainCollision(hero.x+hero.width/2,hero.y+hero.height/2)||isATerrainCollision(hero.x+hero.width/2,hero.y-hero.height/2)){var e=getTileX(hero.x+hero.width/2),o=e*tileW;hero.x=o-hero.width/2-1}else-1!=activeDoorX&&startDoorTransition();for(var n,r,s=0;s<thisMapData.npcs.length;s++)n=thisMapData.npcs[s],n.isCollidable&&isAnObjectCollision(n.x,n.y,n.width,n.height,hero.x,hero.y,hero.width,hero.height)&&getHeroAsCloseAsPossibleToObject(n.x,n.y,n.width,n.height);for(var s=0;s<thisMapData.items.length;s++)r=thisMapData.items[s],isAnObjectCollision(r.x,r.y,r.width,r.height,hero.x,hero.y,hero.width,hero.height)&&getHeroAsCloseAsPossibleToObject(r.x,r.y,r.width,r.height);if(hasActivePet)for(var s=0;s<hero.activePets.length;s++)isAnObjectCollision(hero.allPets[hero.activePets[s]].x,hero.allPets[hero.activePets[s]].y,hero.allPets[hero.activePets[s]].width,hero.allPets[hero.activePets[s]].height,hero.x,hero.y,hero.width,hero.height)&&(getHeroAsCloseAsPossibleToObject(hero.allPets[hero.activePets[s]].x,hero.allPets[hero.activePets[s]].y,hero.allPets[hero.activePets[s]].width,hero.allPets[hero.activePets[s]].height),pushPetAway(s))}function gameLoop(){switch(gameMode){case"mapLoading":break;case"paused":break;case"cardGame":cardGameNameSpace.update(),cardGameNameSpace.draw();break;case"play":update(),draw()}window.requestAnimationFrame(gameLoop)}function update(){var e=window.performance.now();hero.totalGameTimePlayed++;var t=e-lastTime;lastTime=e,hero.isMoving=!1;var a=hero.speed;if(key[5]&&(a*=2),"out"!=mapTransition){key[2]?(hero.isMoving=!0,hero.facing="n",hero.y-=a):key[3]?(hero.isMoving=!0,hero.facing="s",hero.y+=a):key[1]?(hero.isMoving=!0,hero.facing="e",hero.x+=a):key[0]&&(hero.isMoving=!0,hero.facing="w",hero.x-=a),key[4]&&checkForActions(),key[6]&&checkForChallenges(),checkHeroCollisions();var i=hero.tileX,o=hero.tileY;hero.tileX=getTileX(hero.x),hero.tileY=getTileY(hero.y),(hero.tileX!=i||hero.tileY!=o)&&heroIsInNewTile(),""!=activeNPCForDialogue&&(isInRange(hero.x,hero.y,activeNPCForDialogue.x,activeNPCForDialogue.y,closeDialogueDistance)||(dialogue.classList.add("slowerFade"),dialogue.classList.remove("active"),-1!=shopCurrentlyOpen&&(activeNPCForDialogue.speechIndex=0,UI.closeShop()),dialogue.addEventListener(whichTransitionEvent,UI.removeActiveDialogue,!1)))}else{switch(hero.isMoving=!0,hero.facing){case"n":hero.y-=a;break;case"s":hero.y+=a;break;case"e":hero.x+=a;break;case"w":hero.x-=a}mapTransitionCurrentFrames++,mapTransitionCurrentFrames>=mapTransitionMaxFrames&&changeMaps(activeDoorX,activeDoorY)}"in"==mapTransition&&(mapTransitionCurrentFrames+=2,mapTransitionCurrentFrames>=mapTransitionMaxFrames&&(mapTransition="")),timeSinceLastFrameSwap+=t,timeSinceLastFrameSwap>animationUpdateTime&&(currentAnimationFrame++,timeSinceLastFrameSwap=0,animateFae()),moveFae(),moveNPCs(),movePet(),audio.checkForAmbientSounds()}function heroIsInNewTile(){hero.z=getElevation(getCurrentTileX(hero.x),getCurrentTileY(hero.y)),0>currentMap&&updateCartographicMiniMap();for(var e,t,a,i=0;i<thisMapData.hotspots.length;i++)e=thisMapData.hotspots[i],t=getTileCentreCoordX(e.centreX),a=getTileCentreCoordY(e.centreY),isInRange(hero.x,hero.y,t,a,e.radius*tileW)&&("undefined"!=typeof e.quest&&(questData[e.quest].hasBeenActivated<1&&UI.showNotification("<p>"+e.message+"</p>"),questData[e.quest].hasBeenActivated=1),"undefined"!=typeof e.music&&audio.playMusic(e.music)),"hero"==fae.currentState&&-1===fae.recentHotspots.indexOf(i)&&isInRange(fae.x,fae.y,t,a,fae.range)&&hasLineOfSight(getTileX(fae.x),getTileX(fae.y),e.centreX,e.centreY)&&(fae.targetX=t,fae.targetY=a,fae.recentHotspots.push(i),fae.currentState="away");"wait"==fae.currentState&&(isInRange(fae.x,fae.y,hero.x,hero.y,fae.abandonRadius)||hasLineOfSight(getTileX(fae.x),getTileX(fae.y),hero.tileX,hero.tileY)&&(fae.currentState="hero")),hero.breadcrumb.pop(),hero.breadcrumb.unshift([hero.tileX,hero.tileY])}function checkForActions(){for(var e,t=[],a=0;a<thisMapData.items.length;a++)if(isInRange(hero.x,hero.y,thisMapData.items[a].x,thisMapData.items[a].y,thisMapData.items[a].width/2+hero.width/2+6)&&isFacing(hero,thisMapData.items[a])){var i=currentActiveInventoryItems[thisMapData.items[a].type].actionValue;switch(currentActiveInventoryItems[thisMapData.items[a].type].action){case"static":break;case"sound":audio.playSound(soundEffects[i],0);break;case"questToggle":questData[i].hasBeenActivated=Math.abs(questData[i].hasBeenActivated-1);break;case"questSet":questData[i].hasBeenActivated=1;break;case"questUnset":questData[i].hasBeenActivated=0;break;case"node":if(console.log(hero.totalGameTimePlayed+" "+thisMapData.items[a].timeLastHarvested+" > "+currentActiveInventoryItems[thisMapData.items[a].type].respawnRate),hero.totalGameTimePlayed-thisMapData.items[a].timeLastHarvested>=currentActiveInventoryItems[thisMapData.items[a].type].respawnRate){var o=getRandomIntegerInclusive(1,thisMapData.items[a].contains.length);t=canAddItemToInventory([thisMapData.items[a].contains[o-1]]),t[0]?(thisMapData.items[a].timeLastHarvested=hero.totalGameTimePlayed,UI.showChangeInInventory(t[1])):UI.showNotification("<p>Oops - sorry, no room in your bags</p>")}break;default:t=canAddItemToInventory([thisMapData.items[a]]),t[0]?(thisMapData.items.splice(a,1),UI.showChangeInInventory(t[1])):UI.showNotification("<p>Oops - sorry, no room in your bags</p>")}}for(var a=0;a<thisMapData.npcs.length;a++)if(e=thisMapData.npcs[a],e.speech&&isInRange(hero.x,hero.y,e.x,e.y,e.width+hero.width)&&isFacing(hero,e))if(e.speechIndex>=e.speech.length||canCloseDialogueBalloonNextClick&&activeNPCForDialogue==e)e.speechIndex=0,dialogue.classList.remove("active"),activeNPCForDialogue="",canCloseDialogueBalloonNextClick=!1,-1!=shopCurrentlyOpen&&UI.closeShop();else{var n=e.speech[e.speechIndex][0],r=e.speech[e.speechIndex][1];e.drawnFacing=turntoFace(e,hero),processSpeech(e,n,r,!0),e.speechIndex++}key[4]=0}function processSpeech(e,t,a,i){thisSpeech=t,i="undefined"!=typeof i?i:!1;for(var o=a.split(","),n=0;n<o.length;n++)switch(o[n]){case"once":e.speech.splice(e.speechIndex,1),e.speechIndex--;break;case"shop":UI.openShop(generateHash(e.speech[e.speechIndex][2]));break;case"sound":audio.playSound(soundEffects[e.speech[e.speechIndex][2]],0);break;case"profession":var r=e.speech[e.speechIndex][2];-1==hero.professionsKnown.indexOf(r)&&(hero.professionsKnown.push(r),showNotification("<p>You learned a new profession</p>"));break;case"follower":var s=e.speech[e.speechIndex][2];-1==hero.professionsKnown.indexOf(s)&&(hero.professionsKnown.push(s),showNotification("<p>You gained a new follower</p>"));break;case"quest":case"quest-no-open":case"quest-no-close":case"quest-no-open-no-close":var c=thisSpeech.split("|"),l=e.speech[e.speechIndex][2];if(questData[l].isUnderway)switch(questData[l].whatIsRequiredForCompletion){case"possess":case"give":case"":if("quest"==o[n]||"quest-no-open"==o[n]){for(var h=(questData[l].itemsNeededForCompletion,!0),d=questData[l].startItemsReceived.split(","),u=[],n=0;n<d.length;n++){var p,g,m=d[n].split("x");m.length>1?(p=m[0],g=m[1]):(p=1,g=d[n]),hasItemInInventory(g,p)||(h=!1)}if(h){if("give"==questData[l].whatIsRequiredForCompletion)for(var n=0;n<d.length;n++){var p,g,m=d[n].split("x");m.length>1?(p=m[0],g=m[1]):(p=1,g=d[n]),removeItemTypeFromInventory(g,p)}thisSpeech=c[2],closeQuest(e,l)}else thisSpeech=c[1],e.speechIndex--}else questData[l].hasBeenCompleted>0?(thisSpeech=c[2],closeQuest(e,l)):(thisSpeech=c[1],e.speechIndex--);break;case"multi":for(var v=questData[l].subQuestsRequiredForCompletion.split(","),f=!0,y=0;y<v.length;y++)switch(questData[v[y]].whatIsRequiredForCompletion){case"possess":case"give":case"":for(var d=(questData[v[y]].itemsNeededForCompletion,questData[v[y]].startItemsReceived.split(",")),u=[],I=0;I<d.length;I++){var p,g,m=d[I].split("x");m.length>1?(p=m[0],g=m[1]):(p=1,g=d[n]),hasItemInInventory(g,p)||(f=!1)}break;case"world":questData[v[y]].hasBeenActivated<1&&(f=!1);break;default:var P=questData[v[y]].valueAtQuestStart,b=accessDynamicVariable(questData[v[y]].whatIsRequiredForCompletion);"+"==questData[v[y]].thresholdNeededForCompletion.charAt(0)?(console.log(b+" < "+questData[v[y]].thresholdNeededForCompletion.substring(1)),b-P<questData[v[y]].thresholdNeededForCompletion&&(f=!1)):b<questData[v[y]].thresholdNeededForCompletion.substring(1)&&(f=!1)}f?(thisSpeech=c[2],closeQuest(e,l)):(thisSpeech=c[1],e.speechIndex--);break;case"world":questData[l].hasBeenActivated>0?(thisSpeech=c[2],closeQuest(e,l)):(thisSpeech=c[1],e.speechIndex--);break;default:var P=questData[l].valueAtQuestStart,b=accessDynamicVariable(questData[l].whatIsRequiredForCompletion),C=!1;"+"==questData[l].thresholdNeededForCompletion.charAt(0)?b-P>=questData[l].thresholdNeededForCompletion&&(C=!0):b>=questData[l].thresholdNeededForCompletion.substring(1)&&(C=!0),C?(thisSpeech=c[2],closeQuest(e,l)):(thisSpeech=c[1],e.speechIndex--)}else{if("quest"==o[n]||"quest-no-close"==o[n]){var S=!0;if(questData[l].startItemsReceived){for(var w=questData[l].startItemsReceived.split(","),u=[],M=0;M<w.length;M++){var p,g,m=w[M].split("x");m.length>1?(p=m[0],g=m[1]):(p=1,g=w[M]);var T={type:parseInt(g),quantity:parseInt(p),quality:100,durability:100,currentWear:0,effectiveness:100,colour:currentActiveInventoryItems[parseInt(g)].colour,enchanted:0,hallmark:0,inscription:""};u.push(T)}inventoryCheck=canAddItemToInventory(u),inventoryCheck[0]?UI.showChangeInInventory(inventoryCheck[1]):S=!1}if(S){switch(questData[l].whatIsRequiredForCompletion){case"possess":case"give":case"":break;case"multi":for(var v=questData[l].subQuestsRequiredForCompletion.split(","),y=0;y<v.length;y++){switch(questData[v[y]].isUnderway=1,questData[v[y]].whatIsRequiredForCompletion){case"possess":case"give":case"":break;case"world":break;default:questData[v[y]].valueAtQuestStart=accessDynamicVariable(questData[v[y]].whatIsRequiredForCompletion)}questData[v[y]].isUnderway=!0}break;case"world":break;default:questData[l].valueAtQuestStart=accessDynamicVariable(questData[l].whatIsRequiredForCompletion)}questData[l].isUnderway=!0}}thisSpeech=c[0],e.speechIndex--}break;case"play":startCardGame(e)}""!=thisSpeech?UI.showDialogue(e,thisSpeech):e.speechIndex--,canCloseDialogueBalloonNextClick=!1,i||(canCloseDialogueBalloonNextClick=!0)}function closeQuest(e,t){giveQuestRewards(t)?(questData[t].isRepeatable>0?(questData[t].hasBeenCompleted=!1,questData[t].isUnderway=!1):(questData[t].hasBeenCompleted=!0,e.speech.splice(e.speechIndex,1),e.speechIndex--),checkForTitlesAwarded(t)):e.speechIndex--}function giveQuestRewards(e){if(questData[e].itemsReceivedOnCompletion){for(var t=[],a=questData[e].itemsReceivedOnCompletion.split(","),i=0;i<a.length;i++){var o,n,r=a[i].split("/"),s=getRandomElementFromArray(r),c=s.split("x");c.length>1?(o=c[0],n=c[1]):(o=1,n=a[i]),r.length>1&&(thisSpeech=thisSpeech.replace(/##itemName##/i,currentActiveInventoryItems[parseInt(n)].shortname));var l={type:parseInt(n),quantity:parseInt(o),quality:100,durability:100,currentWear:0,effectiveness:100,colour:currentActiveInventoryItems[parseInt(n)].colour,enchanted:0,hallmark:0,inscription:""};t.push(l)}return inventoryCheck=canAddItemToInventory(t),inventoryCheck[0]?(UI.showChangeInInventory(inventoryCheck[1]),!0):(UI.showNotification("<p>Oops - sorry, no room in your bags</p>"),!1)}return!0}function checkForTitlesAwarded(e){if(questData[e].titleGainedAfterCompletion){var t=questData[e].titleGainedAfterCompletion;-1==hero.titlesEarned.indexOf(t)&&(hero.titlesEarned.push(t),UI.showNotification("<p>You earned the &quot;"+activeTitles[t]+"&quot; title</p>"))}}function checkForChallenges(){for(var e=0;e<thisMapData.npcs.length;e++)thisChallengeNPC=thisMapData.npcs[e],isInRange(hero.x,hero.y,thisChallengeNPC.x,thisChallengeNPC.y,thisChallengeNPC.width+hero.width)&&isFacing(hero,thisChallengeNPC)&&thisChallengeNPC.cardGameSpeech&&(thisChallengeNPC.drawnFacing=turntoFace(thisChallengeNPC,hero),processSpeech(thisChallengeNPC,thisChallengeNPC.cardGameSpeech.challenge[0],thisChallengeNPC.cardGameSpeech.challenge[1]));key[6]=0}function moveNPCs(){for(var e,t,a,i,o,n,r,a,s,c=0;c<thisMapData.npcs.length;c++){if(e=thisMapData.npcs[c],e.isMoving){switch(i=e.x,o=e.y,e.drawnFacing=e.facing,e.facing){case"n":if(e.y-=e.speed,isATerrainCollision(e.x-e.width/2,e.y-e.height/2)||isATerrainCollision(e.x+e.width/2,e.y-e.height/2)){var l=getTileY(e.y-e.height/2),h=(l+1)*tileW;e.y=h+e.height/2+1}break;case"s":if(e.y+=e.speed,isATerrainCollision(e.x-e.width/2,e.y+e.height/2)||isATerrainCollision(e.x+e.width/2,e.y+e.height/2)){var l=getTileY(e.y+e.height/2),d=l*tileW;e.y=d-e.height/2-1}break;case"w":if(e.x-=e.speed,isATerrainCollision(e.x-e.width/2,e.y+e.height/2)||isATerrainCollision(e.x-e.width/2,e.y-e.height/2)){var l=getTileX(e.x-e.width/2),u=(l+1)*tileW;e.x=u+e.width/2+1}break;case"e":if(e.x+=e.speed,isATerrainCollision(e.x+e.width/2,e.y+e.height/2)||isATerrainCollision(e.x+e.width/2,e.y-e.height/2)){var l=getTileX(e.x+e.width/2),p=l*tileW;e.x=p-e.width/2-1}}if(isAnObjectCollision(e.x,e.y,e.width,e.height,hero.x,hero.y,hero.width,hero.height)&&(e.x=i,e.y=o),hasActivePet)for(var g=0;g<hero.activePets.length;g++)isAnObjectCollision(e.x,e.y,e.width,e.height,hero.allPets[hero.activePets[g]].x,hero.allPets[hero.activePets[g]].y,hero.allPets[hero.activePets[g]].width,hero.allPets[hero.activePets[g]].height)&&(e.x=i,e.y=o);for(var g=0;g<thisMapData.npcs.length;g++)c!=g&&(n=thisMapData.npcs[g],n.isCollidable&&isAnObjectCollision(e.x,e.y,e.width,e.height,n.x,n.y,n.width,n.height)&&(e.x=i,e.y=o));for(var g=0;g<thisMapData.items.length;g++)r=thisMapData.items[g],isAnObjectCollision(e.x,e.y,e.width,e.height,r.x,r.y,r.width,r.height)&&(e.x=i,e.y=o);e.dx+=e.x-i,e.dy+=e.y-o,t=!1,Math.abs(e.dx)>=tileW&&(e.dx>0?e.dx-=tileW:e.dx+=tileW,t=!0),Math.abs(e.dy)>=tileW&&(e.dy>0?e.dy-=tileW:e.dy+=tileW,t=!0)}if(t||e.forceNewMovementCheck)switch(e.tileX=getTileX(e.x),e.tileY=getTileY(e.y),e.movementIndex++,e.movementIndex>=e.movement.length&&(e.movementIndex=0),a=e.movement[e.movementIndex],s="string"!=typeof a?a[0]:a){case"-":e.isMoving=!1,e.forceNewMovementCheck=!1;case"?":do e.facing=facingsPossible[Math.floor(Math.random()*facingsPossible.length)];while(isATerrainCollision(e.x+relativeFacing[e.facing].x*tileW,e.y+relativeFacing[e.facing].y*tileW));e.forceNewMovementCheck=!1;break;case"find":e.forceNewMovementCheck=!0,e.waitingForAPath||"undefined"!=typeof e.waitingTimer?(e.waitingTimer++,e.waitingTimer>a[3]?e.isMoving=!0:(e.movementIndex--,e.isMoving=!1)):(pathfindingWorker.postMessage([a[1],e,thisMapData]),e.isMoving=!1,e.waitingForAPath=!0,e.waitingTimer=0,e.movementIndex--);break;case"proximity":e.forceNewMovementCheck=!0;var m=a[1];isInRange(hero.x,hero.y,e.x,e.y,m*tileW)?e.isMoving=!0:(e.isMoving=!1,e.movementIndex--);break;case"remove":e.movement.splice(e.movementIndex-1,2);break;case"pathEnd":var v=e.lastTargetDestination.split("-");e.drawnFacing=turntoFaceTile(e,v[0],v[1]);var f;for(g=e.movementIndex;g>=0;g--)if(f=e.movement[g],"string"!=typeof f&&"find"==f[0]){var y=e.movementIndex-g;e.movement.splice(g+1,y),e.movementIndex-=y,e.isMoving=!1,e.forceNewMovementCheck=!0,e.waitingTimer=void 0;break}break;case"talkToNeighbour":for(var g=0;g<thisMapData.npcs.length;g++)c!=g&&(n=thisMapData.npcs[g],Math.abs(n.tileX-e.tileX)<=1&&Math.abs(n.tileY-e.tileY)<=1&&(n.drawnFacing=turntoFace(n,e)));break;default:e.facing=a,e.forceNewMovementCheck=!1}}}function canLearnRecipe(e){var t=!1;return-1===hero.recipesKnown.indexOf(e)&&hero.recipesKnown.push([parseInt(e),0]),t}function draw(){if("mapLoading"==gameMode)gameContext.fillRect(0,0,canvasWidth,canvasHeight),gameContext.fillStyle="#000000",gameContext.fill();else{var e,t,a,i,o,n;hero.isox=findIsoCoordsX(hero.x,hero.y),hero.isoy=findIsoCoordsY(hero.x,hero.y);var r=[[findIsoDepth(hero.x,hero.y,hero.z),"img",heroImg,Math.floor(canvasWidth/2-hero.feetOffsetX),Math.floor(canvasHeight/2-hero.feetOffsetY-hero.z)]];a=findIsoCoordsX(fae.x,fae.y),i=findIsoCoordsY(fae.x,fae.y),fae.oscillateOffset=8*(Math.sin(fae.dz)+1)+fae.z+fae.zOffset,r.push([findIsoDepth(fae.x,fae.y,fae.z),"faeCentre",Math.floor(a-hero.isox+canvasWidth/2),Math.floor(i-hero.isoy+canvasHeight/2-fae.oscillateOffset)]);for(var s=0;s<fae.particles.length;s++)r.push([fae.particles[s].depth,"faeParticle",Math.floor(fae.particles[s].isoX-hero.isox+canvasWidth/2),Math.floor(fae.particles[s].isoY-hero.isoy+canvasHeight/2),fae.particles[s].alpha]);for(var c,l,h=thisMapData.terrain,d=0,u=0,p="",s=0;mapTilesX>s;s++)for(var g=0;mapTilesY>g;g++)"*"!=h[g][s]&&(a=getTileIsoCentreCoordX(s,g),i=getTileIsoCentreCoordY(s,g),e=thisMapData.graphics[h[g][s]].centreX,t=thisMapData.graphics[h[g][s]].centreY,r.push([findIsoDepth(getTileCentreCoordX(s),getTileCentreCoordY(g),0),"img",tileImages[h[g][s]],Math.floor(a-hero.isox-e+canvasWidth/2),Math.floor(i-hero.isoy-t+canvasHeight/2)]));if(hasActivePet)for(var s=0;s<hero.activePets.length;s++)d=currentAnimationFrame%hero.allPets[hero.activePets[s]].animation.walk.length,u=hero.allPets[hero.activePets[s]].animation.walk[hero.allPets[hero.activePets[s]].facing],a=findIsoCoordsX(hero.allPets[hero.activePets[s]].x,hero.allPets[hero.activePets[s]].y),i=findIsoCoordsY(hero.allPets[hero.activePets[s]].x,hero.allPets[hero.activePets[s]].y),r.push([findIsoDepth(hero.allPets[hero.activePets[s]].x,hero.allPets[hero.activePets[s]].y,hero.allPets[hero.activePets[s]].z),"sprite",activePetImages[s],d*hero.allPets[hero.activePets[s]].spriteWidth,u*hero.allPets[hero.activePets[s]].spriteHeight,hero.allPets[hero.activePets[s]].spriteWidth,hero.allPets[hero.activePets[s]].spriteHeight,Math.floor(a-hero.isox-hero.allPets[hero.activePets[s]].centreX+canvasWidth/2),Math.floor(i-hero.isoy-hero.allPets[hero.activePets[s]].centreY+canvasHeight/2-hero.allPets[hero.activePets[s]].z),hero.allPets[hero.activePets[s]].spriteWidth,hero.allPets[hero.activePets[s]].spriteHeight]);for(var s=0;s<thisMapData.npcs.length;s++)o=thisMapData.npcs[s],d=currentAnimationFrame%o.animation.walk.length,u=o.animation.walk[o.drawnFacing],a=findIsoCoordsX(o.x,o.y),i=findIsoCoordsY(o.x,o.y),r.push([findIsoDepth(o.x,o.y,o.z),"sprite",npcImages[thisMapData.npcs[s].name],d*o.spriteWidth,u*o.spriteHeight,o.spriteWidth,o.spriteHeight,Math.floor(a-hero.isox-o.centreX+canvasWidth/2),Math.floor(i-hero.isoy-o.centreY+canvasHeight/2-o.z),o.spriteWidth,o.spriteHeight]);for(var s=0;s<thisMapData.items.length;s++)n=thisMapData.items[s],a=findIsoCoordsX(n.x,n.y),i=findIsoCoordsY(n.x,n.y),p="",thisMapData.items[s].colour&&(c=getColourName(thisMapData.items[s].colour,thisMapData.items[s].type),""!=c&&(p="-"+c.toLowerCase())),l="item"+thisMapData.items[s].type+p,r.push([findIsoDepth(n.x,n.y,n.z),"img",itemImages[l],Math.floor(a-hero.isox-n.centreX+canvasWidth/2),Math.floor(i-hero.isoy-n.centreY+canvasHeight/2-n.z)]);r.sort(sortByLowestValue),gameContext.drawImage(backgroundImg,Math.floor(getTileIsoCentreCoordX(0,mapTilesX-1)-hero.isox-24-400+canvasWidth/2),Math.floor(getTileIsoCentreCoordY(0,0)-hero.isoy-12-300+canvasHeight/2));for(var s=0;s<r.length;s++)switch(r[s][1]){case"faeCentre":drawCircle("#ffdc0c",r[s][2],r[s][3],2),drawCircle("rgba(255,220,255,0.3)",r[s][2],r[s][3],4),gameContext.fillStyle="rgba(0,0,0,"+.01*(65-fae.oscillateOffset)+")",gameContext.beginPath(),gameContext.ellipse(r[s][2]-getXOffsetFromHeight(fae.oscillateOffset),r[s][3]+fae.oscillateOffset,3,1,0,0,2*Math.PI),gameContext.fill();break;case"faeParticle":gameContext.fillStyle="rgba(255,220,255,"+r[s][4]+")",gameContext.fillRect(r[s][2],r[s][3],1,1);break;case"sprite":gameContext.drawImage(r[s][2],r[s][3],r[s][4],r[s][5],r[s][6],r[s][7],r[s][8],r[s][9],r[s][10]);break;case"img":gameContext.drawImage(r[s][2],r[s][3],r[s][4])}if(""!=activeNPCForDialogue&&UI.updateDialogue(activeNPCForDialogue),"out"==mapTransition){var m=1-mapTransitionCurrentFrames/mapTransitionMaxFrames;if(.02>m)gameContext.fillStyle="#000000",gameContext.fillRect(0,0,canvasWidth,canvasHeight);else{var v=gameContext.createRadialGradient(canvasWidth/2,canvasHeight/2,m*canvasWidth/2,canvasWidth/2,canvasHeight/2,0);
v.addColorStop(0,"rgba(0,0,0,1)"),v.addColorStop(1,"rgba(0,0,0,0)"),gameContext.fillStyle=v,gameContext.fillRect(0,0,canvasWidth,canvasHeight)}}else if("in"==mapTransition){var m=mapTransitionCurrentFrames/mapTransitionMaxFrames,v=gameContext.createRadialGradient(canvasWidth/2,canvasHeight/2,m*canvasWidth/2,canvasWidth/2,canvasHeight/2,0);v.addColorStop(0,"rgba(0,0,0,1)"),v.addColorStop(1,"rgba(0,0,0,0)"),gameContext.fillStyle=v,gameContext.fillRect(0,0,canvasWidth,canvasHeight)}}}var audioContext=null,soundGainNode,soundEffects={},soundsToLoad={coins:"../sounds/coins-NOT_MINE-wow.mp3",bookOpen:"../sounds/book-open-NOT_MINE-wow.mp3",bagOpen:"../sounds/bag-open-NOT_MINE-wow.mp3",buttonClick:"../sounds/button-press-NOT_MINE-wow.mp3",hen:"../sounds/hen-NOT_MINE.mp3"},loadBuffer=function(e,t){var a=new XMLHttpRequest;a.open("GET",e,!0),a.responseType="arraybuffer",a.onload=function(){audioContext.decodeAudioData(a.response,function(a){return a?void(soundEffects[t]=a):void console.log("error decoding file data: "+e)},function(e){console.log("decodeAudioData error",e)})},a.onerror=function(){console.log("audio XHR error")},a.send()},audio={lastTrack:"",init:function(){try{window.AudioContext=window.AudioContext||window.webkitAudioContext,audioContext=new AudioContext,soundGainNode=audioContext.createGain(),soundGainNode.connect(audioContext.destination);for(var e in soundsToLoad)loadBuffer(soundsToLoad[e],e)}catch(t){}},initMusic:function(e){audio[e]=new Audio,audio[e].id=e;var t=document.createElement("source");t.type="audio/mpeg",t.src="/music/game-world/"+e+".mp3",audio[e].appendChild(t),audio[e+"Gain"]=audioContext.createGain(),audio[e+"Gain"].gain.setValueAtTime(gameSettings.musicVolume,0),audio[e+"Source"]=audioContext.createMediaElementSource(audio[e]),audio[e+"Source"].connect(audio[e+"Gain"]),audio[e+"Gain"].connect(audioContext.destination),audio[e].addEventListener("ended",audio.removeMusic,!1)},removeMusic:function(e){var t=e.target.id;audio[t].removeEventListener("ended",audio.removeMusic,!1),delete audio[t],delete audio[t+"Source"],delete audio[t+"Gain"],audio.activeTrack==t&&(audio.activeTrack=void 0)},playSound:function(e,t){var a=audioContext.createBufferSource();a.buffer=e,a.connect(soundGainNode),a.start?a.start(t):a.start=a.noteOn},playMusic:function(e){if("undefined"!=typeof audio.activeTrack){if(audio.activeTrack!=e){audio.initMusic(e);var t=6,a=audioContext.currentTime;audio[audio.activeTrack+"Gain"].gain.linearRampToValueAtTime(gameSettings.musicVolume,a),audio[audio.activeTrack+"Gain"].gain.linearRampToValueAtTime(0,a+t),audio[e+"Gain"].gain.linearRampToValueAtTime(0,0),audio[e+"Gain"].gain.linearRampToValueAtTime(gameSettings.musicVolume,t),audio[e].play(),audio.activeTrack=e,audio.lastTrack=e}}else e!=audio.lastTrack&&(audio.initMusic(e),audio[e].play(),audio.activeTrack=e,audio.lastTrack=e)},adjustEffectsVolume:function(){gameSettings.soundVolume=soundVolume.value,"undefined"!=typeof soundGainNode&&(soundGainNode.gain.value=gameSettings.soundVolume)},adjustMusicVolume:function(){gameSettings.musicVolume=musicVolume.value,"undefined"!=typeof audio.activeTrack&&audio[audio.activeTrack+"Gain"].gain.setValueAtTime(gameSettings.musicVolume,audioContext.currentTime)},loadAmbientSounds:function(e){for(var t in e)loadBuffer(e[t],t)},checkForAmbientSounds:function(){thisMapData.ambientSounds&&hero.totalGameTimePlayed-timeSinceLastAmbientSoundWasPlayed>minTimeBetweenAmbientSounds&&1==getRandomIntegerInclusive(1,240)&&(timeSinceLastAmbientSoundWasPlayed=hero.totalGameTimePlayed,audio.playSound(soundEffects[getRandomKeyFromObject(thisMapData.ambientSounds)],0))}};const animationFramesPerSecond=16;var lastTime=0,elapsed=0,timeSinceLastFrameSwap=0,currentAnimationFrame=0,animationUpdateTime=62.5,gameCanvas,gameContext,gameMode,cartographyContext,offScreenCartographyContext,canvasMapImage,canvasMapImage,canvasMapMaskImage,heroImg,imagesToLoad,tileImages,npcImages,itemImages,backgroundImg,objInitLeft,objInitTop,dragStartX,dragStartY,inventoryCheck,timeSinceLastAmbientSoundWasPlayed;const titleTagPrefix="Autumn Earth";var mapTransition="",mapTransitionCurrentFrames=1;const mapTransitionMaxFrames=60;var activeDoorX=-1,activeDoorY=-1,characterId=999,currentMap=0,newMap=0,thisMapData="",mapTilesX=0,mapTilesY=0,tileGraphics=[];const tileW=48,tileH=24;var tileGraphicsToLoad=0,npcGraphicsToLoad=0,itemGraphicsToLoad=0,canvasWidth=800,canvasHeight=600,randomDungeonName="",randomDungeons=["","the-barrow-mines"],previousZoneName="",currentActiveInventoryItems=[],maxNumberOfItemsPerSlot=20,isSplitStackBeingDragged=!1,activeTitles=[],inventoryInterfaceIsBuilt=!1,whichTransitionEvent="",whichAnimationEvent="",activeNPCForDialogue="";const closeDialogueDistance=200;var canCloseDialogueBalloonNextClick=!1,thisSpeech="",boosterCardsRevealed=0,boosterCardsToAdd=[],thisChallengeNPC,questData=[],hasActivePet=!1;const breadCrumbLength=16;var activePetImages=[];const minTimeBetweenAmbientSounds=1200;var colourNames=[],currentRecipePanelProfession=-1,currentItemGroupFilters="",thisMapShopItemIds="",shopCurrentlyOpen=-1;const inflationModifier=10,sellPriceModifier=.7,sellPriceSpecialismModifier=.8,buyPriceSpecialismModifier=.9;for(var key=[0,0,0,0,0,0,0],hero={x:0,y:0,z:0,dx:0,dy:0,breadcrumb:[],width:20,height:20,feetOffsetX:40,feetOffsetY:69,speed:4,isMoving:!1,facing:"s",sequences:{"stand-s":[3],"stand-n":[10],"stand-w":[17],"stand-e":[24],"walk-s":[3,4,5,6,5,4,3,2,1,0,1,2],"walk-n":[10,11,12,13,12,11,10,9,8,7,8,9],"walk-w":[17,18,19,20,19,18,17,16,15,14,15,16],"walk-e":[24,25,26,27,26,25,24,23,22,21,22,23]}},fae={particles:[],maxParticles:18,radiusAroundHero:20,angleAroundHero:0,targetX:0,targetY:0,currentState:"hero",abandonRadius:500,zOffset:40,oscillateOffset:0},thisDevicesScrollBarWidth=scrollbarWidth(),scrollBarElements=document.getElementsByClassName("customScrollBar"),i=0;i<scrollBarElements.length;i++)thisDevicesScrollBarWidth>0?window[scrollBarElements[i].id]=new customScrollBar(scrollBarElements[i]):scrollBarElements[i].classList.add("inActive");var facingsPossible=["n","e","s","w"],relativeFacing={n:{x:0,y:-1},s:{x:0,y:1},e:{x:1,y:0},w:{x:-1,y:0}};!function(){for(var e=0,t=["ms","moz","webkit","o"],a=0;a<t.length&&!window.requestAnimationFrame;++a)window.requestAnimationFrame=window[t[a]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[a]+"CancelAnimationFrame"]||window[t[a]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,a){var i=(new Date).getTime(),o=Math.max(0,16-(i-e)),n=window.setTimeout(function(){t(i+o)},o);return e=i+o,n}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}();var getJSON=function(e,t,a){var i="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");i.open("get",e,!0),i.onreadystatechange=function(){var e,o;if(4==i.readyState){e=i.status;var n=!0;if(200==e){try{o=JSON.parse(i.responseText)}catch(r){n=!1,a&&a(e)}n&&t&&t(o)}else a&&a(e)}},i.send()},getJSONWithParams=function(e,t,a,i){var o="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");o.open("POST",e,!0),o.onreadystatechange=function(){var e,t;if(4==o.readyState){e=o.status;var n=!0;if(200==e){try{t=JSON.parse(o.responseText)}catch(r){n=!1,i&&i(e)}n&&a&&a(t)}else i&&i(e)}},o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.send(t)};window.Loader=function(){function e(){l=0,h=!1,d=0,u={}}function t(){}function a(){}function i(e){++l,t(c()),l==d&&(h=!1,a())}function o(e){console.log("Error on loading the image: "+e.srcElement)}function n(e,t){try{u[e]=new Image,u[e].onload=function(){i(e)},u[e].onerror=o,u[e].src=t}catch(a){console.log(a.message)}}function r(e){return u[e]?u[e]:void 0}function s(i,o,r){if(e(),!h){h=!0;try{d=i.length,t=r||function(){},a=o||function(){};for(var s=0;s<i.length;++s)n(i[s].name,i[s].src)}catch(c){console.log(c.message)}}}function c(){return l/d*100}var l=0,h=!1,d=0,u={};return{preload:s,getProgress:c,getImage:r,reset:e,images:u}}();var allCardPacks=[[1,1,1,1,1,1,1,1,3,3,3,3,3,3,3,3,3],[1,1,1,1,1,1,2,2,2,2,2,3,3,3,3,3,3]],Input={init:function(){document.addEventListener("keydown",function(e){Input.changeKey(e,1,"down")}),document.addEventListener("keyup",function(e){Input.changeKey(e,0,"up")})},changeKey:function(e,t,a){switch(e.keyCode){case KeyBindings.left:e.preventDefault(),key[0]=t;break;case KeyBindings.up:e.preventDefault(),key[2]=t;break;case KeyBindings.right:e.preventDefault(),key[1]=t;break;case KeyBindings.down:e.preventDefault(),key[3]=t;break;case KeyBindings.action:key[4]=0,"up"===a&&(key[4]=1);break;case KeyBindings.shift:key[5]=t;break;case KeyBindings.challenge:key[6]=t}}},KeyBindings={left:37,right:39,up:38,down:40,pause:80,action:17,shift:16,challenge:67};if(window.Worker){var pathfindingWorker=new Worker("/js/worker-pathfinding.js");pathfindingWorker.onmessage=function(e){var t=e.data[0];if("pet"==t){var a=hero.allPets[hero.activePets[e.data[1]]];a.foundPath=e.data[2],a.pathIndex=1,a.state="moving",a.facing=e.data[2][0]}else{var i=thisMapData.npcs.map(function(e){return e.name}).indexOf(t);thisMapData.npcs[i].movement.splice.apply(thisMapData.npcs[i].movement,[thisMapData.npcs[i].movementIndex+2,0].concat(e.data[1])),thisMapData.npcs[i].waitingForAPath=!1,thisMapData.npcs[i].lastTargetDestination=e.data[2]}}}const recipeSearch=document.getElementById("recipeSearch"),clearRecipeSearch=document.getElementById("clearRecipeSearch"),recipeFilter=document.getElementById("recipeFilter"),splitStackInput=document.getElementById("splitStackInput"),splitStackPanel=document.getElementById("splitStackPanel"),shopSplitStackInput=document.getElementById("shopSplitStackInput"),shopSplitStackPanel=document.getElementById("shopSplitStackPanel"),craftingRecipeCreateButton=document.getElementById("craftingRecipeCreateButton"),craftingPanel=document.getElementById("craftingPanel"),selectComponentsItemBeingCreated=document.getElementById("selectComponentsItemBeingCreated"),componentsAvailableForThisRecipe=document.getElementById("componentsAvailableForThisRecipe"),booksAndParchments=document.getElementById("booksAndParchments"),gameWrapper=document.getElementById("gameWrapper"),inventoryPanels=document.getElementById("inventoryPanels"),shopPanel=document.getElementById("shopPanel"),inscriptionPanel=document.getElementById("inscriptionPanel"),inscriptionTextArea=document.getElementById("inscriptionTextArea"),sourceSelection=document.getElementById("sourceSelection"),materialsSelection=document.getElementById("materialsSelection"),inkSelection=document.getElementById("inkSelection"),originalText=document.getElementById("originalText"),scribeCopyText=document.getElementById("scribeCopyText"),scribeOriginalText=document.getElementById("scribeOriginalText"),scribeStartInscription=document.getElementById("scribeStartInscription"),inscriptionTitle=document.getElementById("inscriptionTitle"),soundVolume=document.getElementById("soundVolume"),musicVolume=document.getElementById("musicVolume"),gameSettingsPanel=document.getElementById("gameSettings"),toggleActiveCards=document.getElementById("toggleActiveCards");var notificationQueue=[],notificationIsShowing=!1,UI={init:function(){document.getElementById("displayZoneName"),document.getElementById("activeCartographicMap"),document.getElementById("cartographicTitle"),document.getElementById("dialogue"),document.getElementById("notification"),document.getElementById("cardGameWrapper"),document.getElementById("cardAlbumList"),document.getElementById("boosterPack"),document.getElementById("createRecipeList"),document.getElementById("recipeTitleBar"),document.getElementById("currencies")},showZoneName:function(e){displayZoneName.classList.remove("active"),displayZoneName.textContent=e,void displayZoneName.offsetWidth,displayZoneName.classList.add("active")},buildInventoryInterface:function(){for(var e,t,a,i,o,n,r="",s=0;s<hero.bags.length;s++){i=currentActiveInventoryItems[hero.bags[s].type].shortname,t=currentActiveInventoryItems[hero.bags[s].type].actionValue,r+='<div class="inventoryBag active" id="inventoryBag'+s+'"><div class="draggableBar">'+i+'</div><ol id="bag'+s+'">';for(var c=0;t>c;c++)a=s+"-"+c,r+='<li id="slot'+a+'">',a in hero.inventory?(r+=generateSlotMarkup(a),e=currentActiveInventoryItems[hero.inventory[a].type].action):r+="",r+="</li>";r+="</ol></div></div>"}for(var s=0;s<hero.allPets.length;s++)if(o=hero.allPets[s],o.inventorySize>0){n="",-1!=hero.activePets.indexOf(s)&&(n=" active"),r+='<div class="inventoryBag'+n+'" id="inventoryBag'+s+'"><div class="draggableBar">'+o.name+'</div><ol id="bag'+s+'">';for(var c=0;c<o.inventorySize;c++)a="p"+s+"-"+c,r+='<li id="slot'+a+'">',a in hero.inventory?(r+=generateSlotMarkup(a),e=currentActiveInventoryItems[hero.inventory[a].type].action):r+="",r+="</li>";r+="</ol></div></div>"}inventoryPanels.innerHTML=r,gameWrapper.ondblclick=UI.doubleClick,document.getElementById("createRecipeList").onclick=UI.craftingPanelSingleClick,document.getElementById("craftingRecipeCreateButton").onclick=UI.craftingRecipeCreate,splitStackPanel.onsubmit=inventorySplitStackSubmit,shopSplitStackPanel.onsubmit=UI.shopSplitStackSubmit,toggleActiveCards.onclick=UI.toggleCardsDisplayed,document.getElementById("splitStackCancel").onclick=UI.inventorySplitStackCancel,document.getElementById("shopSplitStackCancel").onclick=UI.shopSplitStackCancel,soundVolume.onchange=audio.adjustEffectsVolume,musicVolume.onchange=audio.adjustMusicVolume,UI.initInventoryDrag(".inventoryBag ol"),document.getElementById("openSettings").onclick=UI.openSettings,UI.initShopDrag(),UI.updateCardAlbum(),UI.updateCurrencies(),UI.buildRecipePanel(),UI.updateInscriptionPanel(),UI.getGameSettings(),hero.professionsKnown.length>0&&UI.populateRecipeList(hero.professionsKnown[0]),gameWrapper.onmousedown=UI.globalMouseDown,gameWrapper.onclick=UI.globalClick,inventoryInterfaceIsBuilt=!0},addNewBag:function(e){hero.bags.push(e);var t;i=hero.bags.length-1;for(var a='<div class="inventoryBag" id="inventoryBag'+i+'"><div class="draggableBar">'+currentActiveInventoryItems[hero.bags[i].type].shortname+'</div><ol class="active" id="bag'+i+'">',o=currentActiveInventoryItems[hero.bags[i].type].actionValue,n=0;o>n;n++)t=i+"-"+n,a+='<li id="slot'+t+'"></li>';a+="</ol></div></div>",inventoryPanels.insertAdjacentHTML("beforeend",a),UI.initInventoryDrag("#inventoryBag"+i+" ol")},showChangeInInventory:function(e){var t,a,i;document.getElementById("slot"+e[0]).addEventListener(whichTransitionEvent,function n(e){for(var t=document.querySelectorAll("#inventoryPanels .changed"),a=0;a<t.length;a++)t[a].classList.remove("changed");return e.currentTarget.removeEventListener(whichTransitionEvent,n,!1)},!1);for(var o=0;o<e.length;o++)t=e[o],a=generateSlotMarkup(t),i=document.getElementById("slot"+t),i.innerHTML=a,i.classList.add("changed")},handleDrag:function(e){UI.activeDragObject.style.cssText="z-index:2;top: "+objInitTop+"px; left: "+objInitLeft+"px; transform: translate("+(e.pageX-dragStartX)+"px, "+(e.pageY-dragStartY)+"px);"},endDrag:function(e){document.removeEventListener("mousemove",UI.handleDrag,!1),document.removeEventListener("mouseup",UI.endDrag,!1),UI.activeDragObject=""},globalMouseDown:function(e){if("draggableBar"==e.target.className&&2!=e.button){UI.activeDragObject=e.target.parentElement;var t=(window.pageYOffset||document.documentElement.scrollTop)-(document.documentElement.clientTop||0),a=e.target.getBoundingClientRect();objInitLeft=a.left,objInitTop=a.top+t,dragStartX=e.pageX,dragStartY=e.pageY,document.addEventListener("mousemove",UI.handleDrag,!1),document.addEventListener("mouseup",UI.endDrag,!1);for(var i=document.querySelectorAll(".draggableBar"),o=0;o<i.length;o++)i[o].parentElement.style.zIndex=1}},doubleClick:function(e){var t=e.target.getAttribute("data-action");if(t)inventoryItemAction(e.target,t,e.target.getAttribute("data-action-value"));else{var a=getNearestParentId(e.target);"recipe"==a.id.substring(0,6)?recipeSelectComponents(a.id):"shop"==a.id.substring(0,4)&&UI.buyFromShopSlot(a.id)}},showDialogue:function(e,t){var a=getRandomElementFromArray(t.split("/"));""!=activeNPCForDialogue&&dialogue.removeEventListener(whichTransitionEvent,UI.removeActiveDialogue,!1),dialogue.innerHTML=a,dialogue.classList.remove("slowerFade"),dialogue.classList.add("active"),activeNPCForDialogue=e,UI.updateDialogue(activeNPCForDialogue)},updateDialogue:function(e){var t=findIsoCoordsX(e.x,e.y),a=findIsoCoordsY(e.x,e.y),i="translate("+Math.floor(t-hero.isox+canvasWidth/2-40)+"px,"+Math.floor(0-(canvasHeight-(a-hero.isoy-e.centreY+canvasHeight/2))-e.z)+"px)";dialogue.style.transform=i},removeActiveDialogue:function(){activeNPCForDialogue="",dialogue.removeEventListener(whichTransitionEvent,UI.removeActiveDialogue,!1)},showNotification:function(e){notificationIsShowing?notificationQueue.push(e):(notificationIsShowing=!0,notification.classList.remove("active"),notification.innerHTML=e,void notification.offsetWidth,notification.classList.add("active"),notification.addEventListener(whichAnimationEvent,UI.notificationEnded,!1))},notificationEnded:function(){notificationQueue.shift(),notificationIsShowing=!1,dialogue.removeEventListener(whichAnimationEvent,UI.notificationEnded,!1),notificationQueue.length>0&&UI.showNotification(notificationQueue[0])},updateCardAlbum:function(){for(var e,t,a,i,o="<ul>",n=0,r={},s=0;s<hero.cards.length;s++){var c=hero.cards[s];r[c]=r[c]?r[c]+1:1}for(var s=1;s<cardGameNameSpace.allCardData.length;s++)a=!1,e="card players",t="",i="",r[s]?(t='<span class="quantity">'+r[s]+"</span>",a=!0):i=' class="inactive"',o+="<li"+i+'><img src="/images/card-game/cards/'+s+'.png" class="'+e+'" alt="'+cardGameNameSpace.allCardData[s][2]+' card">'+t+"</li>",r[0-s]&&(a=!0,o+='<li class="rare"><div class="card players" style="background-image:url(/images/card-game/cards/'+(0-s)+'.png)"></div><span class="quantity">'+r[0-s]+"</span></li>"),a&&n++;o+="</ul>",o+="<p>"+n+" types out of "+(cardGameNameSpace.allCardData.length-1)+". Total individual cards: "+hero.cards.length+"</p>",cardAlbumList.innerHTML=o},populateRecipeList:function(e){if(currentRecipePanelProfession!=e){recipeSearch.value="",clearRecipeSearch.classList.remove("active");for(var t,a,i='<li id="noRecipesFound"><p>No recipes found.</p></li>',o="",n=0;n<hero.crafting[e].sortOrder.length;n++)t=hero.crafting[e].recipes[hero.crafting[e].sortOrder[n]],i+='<li class="active" id="recipe'+hero.crafting[e].sortOrder[n]+'"><img src="/images/game-world/inventory-items/'+t.imageId+'.png" alt="'+t.recipeName+'"><h3>'+t.recipeName+"</h3><p>"+t.recipeDescription+"</p></li>";createRecipeList.innerHTML=i;for(var n=0;n<hero.crafting[e].filterOrder.length;n++)a=hero.crafting[e].filters[hero.crafting[e].filterOrder[n]],o+='<option value="'+a+'"',0==n&&(o+=' selected="selected"'),o+=">"+hero.crafting[e].filterOrder[n]+"</option>";recipeFilter.innerHTML=o,currentRecipePanelProfession=e,UI.highlightedRecipe="",craftingRecipeCreateButton.disabled=!0,recipeTitleBar.innerHTML=hero.crafting[e].name+" Recipes",thisDevicesScrollBarWidth>0&&recipeCustomScrollBar.init()}craftingPanel.classList.add("active")},buildRecipePanel:function(){recipeSearch.onkeyup=recipeSearchInput,recipeFilter.onchange=recipeSearchAndFilter,clearRecipeSearch.onclick=recipeSearchClear},endInventoryDrag:function(e){var t=!1;if("shopSlot"==UI.sourceSlot.substring(0,8)){t=!0;var a=document.getElementById(UI.sourceSlot).firstElementChild,i=document.getElementById(UI.sourceSlot).parentNode.parentNode,o=a.getAttribute("data-price"),n=i.getAttribute("data-currency"),r={type:parseInt(a.getAttribute("data-type")),quantity:1,quality:100,durability:100,currentWear:0,effectiveness:100,colour:parseInt(a.getAttribute("data-colour")),enchanted:0,hallmark:0,inscription:""};a.hasAttribute("data-inscription")&&(r.inscription=a.getAttribute("data-inscription")),a.hasAttribute("data-contains")&&(r.contains=a.getAttribute("data-contains"))}for(var s=e.target;!s.id;)s=s.parentNode;var c=s.id;if("slot"==c.substring(0,4)){var l=c.substring(4);if(void 0==hero.inventory[l])isSplitStackBeingDragged?(addToInventory(l,UI.draggedInventoryObject),UI.droppedSuccessfully()):t?hero.currency[n]>=o?(addToInventory(l,r),hero.currency[n]-=o,UI.updateCurrencies(),audio.playSound(soundEffects.coins,0),UI.droppedSuccessfully()):(UI.showNotification("<p>Not enough money</p>"),UI.slideDraggedSlotBack()):(UI.sourceSlot!=l?(document.getElementById("slot"+UI.sourceSlot).innerHTML="",addToInventory(l,UI.draggedInventoryObject)):hero.inventory[l]=JSON.parse(JSON.stringify(UI.draggedInventoryObject)),document.getElementById("slot"+UI.sourceSlot).classList.remove("hidden"),UI.droppedSuccessfully());else if(t)itemAttributesMatch(r,hero.inventory[l])&&parseInt(hero.inventory[l].quantity)<maxNumberOfItemsPerSlot?hero.currency[n]>=o?(hero.inventory[l].quantity++,updateQuantity(l),hero.currency[n]-=o,UI.updateCurrencies(),audio.playSound(soundEffects.coins,0),UI.droppedSuccessfully()):(UI.showNotification("<p>Not enough money</p>"),UI.slideDraggedSlotBack()):UI.slideDraggedSlotBack();else if(itemAttributesMatch(UI.draggedInventoryObject,hero.inventory[l]))if(parseInt(UI.draggedInventoryObject.quantity)+parseInt(hero.inventory[l].quantity)<=maxNumberOfItemsPerSlot)hero.inventory[l].quantity+=parseInt(UI.draggedInventoryObject.quantity),updateQuantity(l),isSplitStackBeingDragged||(document.getElementById("slot"+UI.sourceSlot).innerHTML="",document.getElementById("slot"+UI.sourceSlot).classList.remove("hidden")),UI.droppedSuccessfully();else{var h=maxNumberOfItemsPerSlot-parseInt(hero.inventory[l].quantity);hero.inventory[l].quantity=maxNumberOfItemsPerSlot,updateQuantity(l),UI.draggedInventoryObject.quantity-=h;for(var d=document.getElementById("slot"+UI.sourceSlot),u=0;u<d.childNodes.length;u++)if("qty"==d.childNodes[u].className){d.childNodes[u].innerHTML=UI.draggedInventoryObject.quantity;break}for(var d=document.getElementById("draggableInventorySlot"),u=0;u<d.childNodes.length;u++)if("qty"==d.childNodes[u].className){d.childNodes[u].innerHTML=UI.draggedInventoryObject.quantity;break}inventorySplitStackCancel(),UI.slideDraggedSlotBack()}else UI.slideDraggedSlotBack()}else if("inventoryBag"==c.substring(0,12))if(t)if(hero.currency[n]>=o){for(var p=-1,g=c.substring(12),m=UI.sourceSlot.indexOf("-"),v=UI.sourceSlot.substring(0,m),f=currentActiveInventoryItems[hero.bags[g].type].actionValue,y=0;f>y;y++){var I=g+"-"+y;if(!(I in hero.inventory)){p=y;break}}-1!=p?(hero.currency[n]-=o,UI.updateCurrencies(),audio.playSound(soundEffects.coins,0),UI.droppedSuccessfully(),addToInventory(g+"-"+p,r),UI.droppedSuccessfully()):UI.slideDraggedSlotBack(),UI.droppedSuccessfully()}else UI.showNotification("<p>Not enough money</p>"),UI.slideDraggedSlotBack();else{var g=c.substring(12),m=UI.sourceSlot.indexOf("-"),v=UI.sourceSlot.substring(0,m);if(g==v)UI.slideDraggedSlotBack();else{for(var p=-1,f=currentActiveInventoryItems[hero.bags[g].type].actionValue,y=0;f>y;y++){var I=g+"-"+y;if(!(I in hero.inventory)){p=y;break}}-1!=p?(isSplitStackBeingDragged||(document.getElementById("slot"+UI.sourceSlot).innerHTML=""),addToInventory(g+"-"+p,UI.draggedInventoryObject),document.getElementById("slot"+UI.sourceSlot).classList.remove("hidden"),UI.droppedSuccessfully()):UI.slideDraggedSlotBack()}}else"shopSlot"==c.substring(0,8)?t?UI.slideDraggedSlotBack():UI.sellToShop(s.parentNode.parentNode):s.classList.contains("shop")?t?UI.slideDraggedSlotBack():UI.sellToShop(s):UI.slideDraggedSlotBack();document.removeEventListener("mousemove",UI.handleDrag,!1),document.removeEventListener("mouseup",UI.endInventoryDrag,!1)},sellToShop:function(e){var t,a=currentActiveInventoryItems[UI.draggedInventoryObject.type].category,i=e.getAttribute("data-specialism"),o=e.getAttribute("data-currency");t=-1!=a.indexOf(i)?Math.ceil(UI.draggedInventoryObject.quantity*sellPriceSpecialismModifier*inflationModifier*currentActiveInventoryItems[UI.draggedInventoryObject.type].priceCode,0):Math.ceil(UI.draggedInventoryObject.quantity*sellPriceModifier*inflationModifier*currentActiveInventoryItems[UI.draggedInventoryObject.type].priceCode,0),hero.currency[o]+=t,UI.updateCurrencies(),audio.playSound(soundEffects.coins,0),UI.droppedSuccessfully()},droppedSuccessfully:function(){""!=UI.activeDragObject&&(UI.activeDragObject.style.cssText="z-index:2;",UI.activeDragObject="",isSplitStackBeingDragged&&(isSplitStackBeingDragged=!1),inventorySplitStackCancel(),UI.updatePanelsAfterInventoryChange())},initInventoryDrag:function(e){for(var t=document.querySelectorAll(e),a=0;a<t.length;a++)t[a].addEventListener("mousedown",function(e){if(e.preventDefault(),2!=e.button){var t=getNearestParentId(e.target);if(key[5]){UI.sourceSlot=t.id.substring(4),UI.draggedInventoryObject=JSON.parse(JSON.stringify(hero.inventory[UI.sourceSlot])),splitStackInput.setAttribute("max",hero.inventory[UI.sourceSlot].quantity);var a=Math.floor(hero.inventory[UI.sourceSlot].quantity/2);splitStackInput.value=a,splitStackInput.focus();var i=t.getBoundingClientRect(),o=(window.pageYOffset||document.documentElement.scrollTop)-(document.documentElement.clientTop||0);objInitLeft=i.left+3,objInitTop=i.top+3+o-44,splitStackPanel.style.cssText="z-index:2;top: "+objInitTop+"px; left: "+objInitLeft+"px;",splitStackPanel.classList.add("active"),key[5]=0}else if(!isSplitStackBeingDragged){UI.sourceSlot=t.id.substring(4),UI.draggedInventoryObject=hero.inventory[UI.sourceSlot],UI.activeDragObject=document.getElementById("draggableInventorySlot"),UI.activeDragObject.innerHTML=t.innerHTML,delete hero.inventory[UI.sourceSlot],t.classList.add("hidden");var i=t.getBoundingClientRect(),o=(window.pageYOffset||document.documentElement.scrollTop)-(document.documentElement.clientTop||0);objInitLeft=i.left+3,objInitTop=i.top+3+o,dragStartX=e.pageX,dragStartY=e.pageY,UI.activeDragObject.style.cssText="z-index:2;top: "+objInitTop+"px; left: "+objInitLeft+"px; transform: translate(0px, 0px);",document.addEventListener("mousemove",UI.handleDrag,!1),document.addEventListener("mouseup",UI.endInventoryDrag,!1)}}},!1)},slideDraggedSlotBack:function(){UI.activeDragObject.style.cssText="z-index:2;left: "+objInitLeft+"px; top: "+objInitTop+"px;transition: transform 0.4s ease;",UI.activeDragObject.addEventListener(whichTransitionEvent,function e(t){if("shopSlot"!=UI.sourceSlot.substring(0,8))if(isSplitStackBeingDragged){hero.inventory[UI.sourceSlot].quantity+=UI.draggedInventoryObject.quantity;var a=document.getElementById("slot"+UI.sourceSlot);if(a)for(var i=0;i<a.childNodes.length;i++)if("qty"==a.childNodes[i].className){a.childNodes[i].innerHTML=hero.inventory[UI.sourceSlot].quantity;break}}else hero.inventory[UI.sourceSlot]=JSON.parse(JSON.stringify(UI.draggedInventoryObject)),document.getElementById("slot"+UI.sourceSlot).classList.remove("hidden");return UI.droppedSuccessfully(),t.currentTarget.removeEventListener(whichTransitionEvent,e,!1)},!1)},craftingPanelSingleClick:function(e){var t=getNearestParentId(e.target);"recipe"==t.id.substring(0,6)&&(""!=UI.highlightedRecipe&&document.getElementById(UI.highlightedRecipe).classList.remove("highlighted"),UI.highlightedRecipe=t.id,document.getElementById(UI.highlightedRecipe).classList.add("highlighted"),craftingRecipeCreateButton.disabled=!1)},craftingRecipeCreate:function(){""!=UI.highlightedRecipe&&recipeSelectComponents(UI.highlightedRecipe)},buildBook:function(e,t){var a="";hero.inventory[e].inscription.content;document.getElementById("book"+t)||(a+='<div class="book inkColour'+hero.inventory[e].colour+'" id="book'+t+'">',a+='<div class="draggableBar">&quot;'+hero.inventory[e].inscription.title+"&quot;</div>",a+='<button class="closePanel">close</button>',a+=hero.inventory[e].inscription.content,a+="</div>",booksAndParchments.innerHTML+=a)},globalClick:function(e){e.target.className&&"closePanel"==e.target.className&&(e.target.parentNode.classList.remove("active"),e.target.parentNode.classList.contains("shop")?(shopCurrentlyOpen=-1,inventoryPanels.removeAttribute("class"),""!=activeNPCForDialogue&&(dialogue.classList.remove("active"),activeNPCForDialogue.speechIndex=0,UI.removeActiveDialogue())):"inscriptionPanel"==e.target.parentNode.id&&UI.resetInscriptionPanel());var t=getNearestParentId(e.target);"scribe"==t.id.substring(0,6)&&UI.processInscriptionClick(t)},updateCurrencies:function(){currencies.innerHTML="<p>"+parseMoney(hero.currency.money)+"</p><p>"+hero.currency.cardDust+'<span class="card"><span></p>'},buildShop:function(e){shopPanel.innerHTML=e},openShop:function(e){shopCurrentlyOpen=e,document.getElementById("shop"+e).classList.add("active"),inventoryPanels.classList.add("shopSpecialism"+document.getElementById("shop"+e).getAttribute("data-specialism"))},closeShop:function(){document.getElementById("shop"+shopCurrentlyOpen).classList.remove("active"),shopCurrentlyOpen=-1,inventoryPanels.removeAttribute("class")},shopSplitStackCancel:function(){shopSplitStackPanel.classList.remove("active")},buyFromShopSlot:function(e){var t=document.getElementById(e),a=t.firstElementChild,i=t.parentNode.parentNode,o=a.getAttribute("data-price"),n=i.getAttribute("data-currency");if(hero.currency[n]>=o){var r={type:parseInt(a.getAttribute("data-type")),quantity:1,quality:100,durability:100,currentWear:0,effectiveness:100,colour:parseInt(a.getAttribute("data-colour")),enchanted:0,hallmark:0,inscription:""};a.hasAttribute("data-inscription")&&(r.inscription=a.getAttribute("data-inscription")),a.hasAttribute("data-contains")&&(r.contains=a.getAttribute("data-contains")),inventoryCheck=canAddItemToInventory([r]),inventoryCheck[0]?(hero.currency[n]-=o,UI.updateCurrencies(),audio.playSound(soundEffects.coins,0),UI.showChangeInInventory(inventoryCheck[1])):UI.showNotification("<p>Oops - sorry, no room in your bags</p>")}else UI.showNotification("<p>Oops - sorry, not enough money</p>");UI.activeDragObject.innerHTML=""},initShopDrag:function(){document.getElementById("shopPanel").addEventListener("mousedown",function(e){if(!isSplitStackBeingDragged){var t=getNearestParentId(e.target);if("shopSlot"==t.id.substring(0,8)&&(e.preventDefault(),2!=e.button))if(UI.sourceSlot=t,key[5]){var a=t.firstElementChild,i=t.parentNode.parentNode,o=a.getAttribute("data-price"),n=i.getAttribute("data-currency"),r=Math.floor(hero.currency[n]/o);r>maxNumberOfItemsPerSlot&&(r=maxNumberOfItemsPerSlot),shopSplitStackInput.setAttribute("max",r),shopSplitStackInput.value=1,shopSplitStackInput.focus();var s=t.getBoundingClientRect(),c=(window.pageYOffset||document.documentElement.scrollTop)-(document.documentElement.clientTop||0);objInitLeft=s.left+3,objInitTop=s.top+3+c-44,shopSplitStackPanel.style.cssText="z-index:2;top: "+objInitTop+"px; left: "+objInitLeft+"px;",shopSplitStackPanel.classList.add("active"),key[5]=0}else{UI.sourceSlot=t.id,UI.draggedInventoryObject={type:parseInt(t.getAttribute("data-type")),quantity:1,quality:100,durability:100,currentWear:0,effectiveness:100,colour:parseInt(t.getAttribute("data-colour")),enchanted:0,hallmark:0,inscription:""},t.hasAttribute("data-inscription")&&(UI.draggedInventoryObject.inscription=t.getAttribute("data-inscription")),t.hasAttribute("data-contains")&&(UI.draggedInventoryObject.contains=t.getAttribute("data-contains")),UI.activeDragObject=document.getElementById("draggableShopSlot"),UI.activeDragObject.innerHTML=t.innerHTML;var s=t.getBoundingClientRect(),c=(window.pageYOffset||document.documentElement.scrollTop)-(document.documentElement.clientTop||0);objInitLeft=s.left+3,objInitTop=s.top+3+c,dragStartX=e.pageX,dragStartY=e.pageY,UI.activeDragObject.style.cssText="z-index:2;top: "+objInitTop+"px; left: "+objInitLeft+"px; transform: translate(0px, 0px);",document.addEventListener("mousemove",UI.handleDrag,!1),document.addEventListener("mouseup",UI.endInventoryDrag,!1)}}},!1)},shopSplitStackSubmit:function(e){e&&e.preventDefault();var t=shopSplitStackInput.value,a=!0;if(t=parseInt(t),
1>t&&(a=!1),Number.isInteger(t)||(a=!1),t>shopSplitStackInput.getAttribute("max")&&(a=!1),a){var i=UI.sourceSlot.firstElementChild,o=UI.sourceSlot.parentNode.parentNode,n=i.getAttribute("data-price"),r=o.getAttribute("data-currency"),s={type:parseInt(i.getAttribute("data-type")),quantity:t,quality:100,durability:100,currentWear:0,effectiveness:100,colour:parseInt(i.getAttribute("data-colour")),enchanted:0,hallmark:0,inscription:""};i.hasAttribute("data-inscription")&&(s.inscription=i.getAttribute("data-inscription")),i.hasAttribute("data-contains")&&(s.contains=i.getAttribute("data-contains")),inventoryCheck=canAddItemToInventory([s]),inventoryCheck[0]?(hero.currency[r]-=t*n,UI.updateCurrencies(),audio.playSound(soundEffects.coins,0),UI.showChangeInInventory(inventoryCheck[1])):UI.showNotification("<p>Oops - sorry, no room in your bags</p>")}shopSplitStackPanel.classList.remove("active")},openInscriptionPanel:function(){audio.playSound(soundEffects.bookOpen,0),inscriptionTextArea.innerHTML="",inscriptionPanel.classList.add("active")},resetInscriptionPanel:function(){var e,t=document.querySelectorAll("#inscriptionPanel li");for(e=0;e<t.length;++e)t[e].classList.remove("selected")},updateInscriptionPanel:function(){var e,t,a,i="<h3>Inks available:</h3><ol>",o="<h3>Documents available:</h3><ol>",n="<h3>Materials available:</h3><ol>";for(var r in hero.inventory)if(40==hero.inventory[r].type)e="",a="",t=getColourName(hero.inventory[r].colour,hero.inventory[r].type),""!=t&&(a=t+" ",e="-"+t.toLowerCase()),i+='<li class="scribeInk" id="scribeInkFromSlot'+r+'"><img src="/images/game-world/inventory-items/40'+e+'.png" alt="'+a+currentActiveInventoryItems[40].shortname+'">'+hero.inventory[r].quantity+"<h3>"+a+currentActiveInventoryItems[40].shortname+"</h3><p>"+currentActiveInventoryItems[40].description+"</p></li>";else{var s=currentActiveInventoryItems[hero.inventory[r].type].action,c=!1;s&&"book"==s&&(c=!0),c&&(hero.inventory[r].inscription.content?o+='<li class="scribeSource" id="scribeSourceFromSlot'+r+'"><img src="/images/game-world/inventory-items/'+hero.inventory[r].type+'.png" alt="'+currentActiveInventoryItems[hero.inventory[r].type].shortname+'">'+hero.inventory[r].quantity+"<h3>"+currentActiveInventoryItems[hero.inventory[r].type].shortname+"</h3><p>"+hero.inventory[r].inscription.title+"</p></li>":n+='<li class="scribeMaterial" id="scribeMaterialFromSlot'+r+'"><img src="/images/game-world/inventory-items/'+hero.inventory[r].type+'.png" alt="'+currentActiveInventoryItems[hero.inventory[r].type].shortname+'">'+hero.inventory[r].quantity+"<h3>"+currentActiveInventoryItems[hero.inventory[r].type].shortname+"</h3><p>"+currentActiveInventoryItems[hero.inventory[r].type].description+"</p></li>")}i+="</ol>",o+="</ol>",n+="</ol>",sourceSelection.innerHTML=o,materialsSelection.innerHTML=n,inkSelection.innerHTML=i,UI.inscription={mode:"original",selected:{source:"",material:"",ink:""}},scribeStartInscription.setAttribute("disabled","disabled"),inscriptionTitle.value="",inscriptionTextArea.innerHTML=""},processInscriptionClick:function(e){switch(e.className){case"scribeSource":UI.inscription.selected.source=e.id.substring(20);var t,a=document.querySelectorAll("#sourceSelection li");for(t=0;t<a.length;++t)a[t].classList.remove("selected");e.classList.add("selected");break;case"scribeMaterial":UI.inscription.selected.material=e.id.substring(22);var t,a=document.querySelectorAll("#materialsSelection li");for(t=0;t<a.length;++t)a[t].classList.remove("selected");e.classList.add("selected");break;case"scribeInk":UI.inscription.selected.ink=e.id.substring(17);var t,a=document.querySelectorAll("#inkSelection li");for(t=0;t<a.length;++t)a[t].classList.remove("selected");e.classList.add("selected")}switch("copy"==UI.inscription.mode?""!=UI.inscription.selected.ink&&""!=UI.inscription.selected.material&&""!=UI.inscription.selected.source?scribeStartInscription.removeAttribute("disabled"):scribeStartInscription.setAttribute("disabled","disabled"):""!=UI.inscription.selected.ink&&""!=UI.inscription.selected.material?scribeStartInscription.removeAttribute("disabled"):scribeStartInscription.setAttribute("disabled","disabled"),e.id){case"scribeCopyText":"copy"!=UI.inscription.mode&&UI.resetInscriptionPanel(),UI.inscription.mode="copy",originalText.classList.remove("active"),sourceSelection.classList.add("active"),e.classList.add("active"),scribeOriginalText.classList.remove("active");break;case"scribeOriginalText":"original"!=UI.inscription.mode&&UI.resetInscriptionPanel(),UI.inscription.mode="original",originalText.classList.add("active"),sourceSelection.classList.remove("active"),e.classList.add("active"),scribeCopyText.classList.remove("active");break;case"scribeStartInscription":var i=JSON.parse(JSON.stringify(hero.inventory[UI.inscription.selected.material]));i.quantity=1,i.colour=hero.inventory[UI.inscription.selected.ink].colour,"copy"==UI.inscription.mode?i.inscription={title:hero.inventory[UI.inscription.selected.source].inscription.title,content:hero.inventory[UI.inscription.selected.source].inscription.content,timeCreated:Date.now()}:i.inscription={title:inscriptionTitle.value,content:"<p>"+inscriptionTextArea.innerHTML+"</p>",timeCreated:Date.now()};var o=UI.inscription.selected.material,n=UI.inscription.selected.ink;inventoryCheck=canAddItemToInventory([i]),inventoryCheck[0]?(document.getElementById("slot"+inventoryCheck[1]).innerHTML=generateSlotMarkup(inventoryCheck[1]),UI.showChangeInInventory(inventoryCheck[1]),removeFromInventory(o,1),removeFromInventory(n,1),UI.updateInscriptionPanel()):UI.showNotification("<p>Oops - sorry, no room in your bags</p>")}},updatePanelsAfterInventoryChange:function(){UI.updateInscriptionPanel()},getGameSettings:function(e){soundVolume.value=gameSettings.soundVolume,musicVolume.value=gameSettings.musicVolume,audio.adjustEffectsVolume(),audio.adjustMusicVolume()},openSettings:function(e){e&&e.preventDefault(),gameSettingsPanel.classList.add("active")},toggleCardsDisplayed:function(e){cardAlbumList.classList.toggle("showOnlyPlayers"),toggleActiveCards.innerHTML="Show only collected cards"==toggleActiveCards.innerHTML?"Show all cards":"Show only collected cards"}};"serviceWorker"in navigator&&navigator.serviceWorker.register("/game-world/serviceWorker.min.js",{scope:"/game-world/"});var debouncedResize=debounce(function(){sizeCanvasSize()},250);window.addEventListener("resize",debouncedResize),"querySelectorAll"in document&&"addEventListener"in window&&window.HTMLCanvasElement&&init();