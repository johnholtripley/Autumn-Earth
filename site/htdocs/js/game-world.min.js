function updateCartographicMiniMap(){var e=246/(mapTilesX*tileW),a=hero.x*e,t=hero.y*e,r=0,o=35,n=offScreenCartographyContext.createRadialGradient(a,t,r,a,t,o);n.addColorStop(0,"rgb(255,255,255)"),n.addColorStop(1,"rgba(255,255,255,0)"),offScreenCartographyContext.arc(a,t,o,0,2*Math.PI),offScreenCartographyContext.fillStyle=n,offScreenCartographyContext.fill(),cartographyContext.clearRect(0,0,246,246),cartographyContext.globalCompositeOperation="copy",cartographyContext.drawImage(offScreenCartographyCanvas,0,0),cartographyContext.globalCompositeOperation="source-atop",cartographyContext.drawImage(canvasMapImage,0,0)}function initCartographicMap(){canvasMapImage.src="/game-world/generateCartographicMap.php?playerId="+characterId+"&dungeonName="+randomDungeonName+"&plotChests=true&requestedMap="+newMap,canvasMapImage.onload=function(){console.log("getting mask - /game-world/getCartographicMapMask.php?chr="+characterId+"&dungeonName="+randomDungeonName+"&currentMap="+newMap),canvasMapMaskImage.src="/game-world/getCartographicMapMask.php?chr="+characterId+"&dungeonName="+randomDungeonName+"&currentMap="+newMap+"&cache="+Date.now(),canvasMapMaskImage.onload=function(){console.log("canvasMapMaskImage onload"),offScreenCartographyContext.clearRect(0,0,246,246),offScreenCartographyContext.drawImage(canvasMapMaskImage,0,0),updateCartographicMiniMap()}}}function saveCartographyMask(){var e=offScreenCartographyCanvas.toDataURL();postData("/game-world/saveCartographicMapMask.php","chr="+characterId+"&dungeonName="+randomDungeonName+"&currentMap="+currentMap+"&data="+e)}function getColourName(e,a){var t="";return 1!=currentActiveInventoryItems[a].hasInherentColour&&(t=colourNames[e]),t}function mixColours(){for(var e=0,a=0,t=0,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],o=0;o<arguments.length;o++)r[arguments[o]]++,e|=arguments[o],arguments[o]==(16|arguments[o])&&a++,arguments[o]==(8|arguments[o])&&t++;for(var o=0;o<r.length;o++)if(r[o]/arguments.length>.7){e=o;break}return e>24&&(e-=a>t?8:t>a?16:24),e}function getTileX(e){return Math.floor(e/tileW)}function getTileY(e){return Math.floor(e/tileW)}function findIsoCoordsX(e,a){return Math.floor(mapTilesY*tileW/2-a/2+e/2)}function findIsoCoordsY(e,a){return Math.floor(e/4+a/4-tileH/2)}function getTileCentreCoordX(e){return e*tileW+tileW/2}function getTileCentreCoordY(e){return e*tileW+tileW/2}function getTileIsoCentreCoordX(e,a){return tileW/2*(mapTilesY-a+e)}function getTileIsoCentreCoordY(e,a){return tileH/2*(a+e)}function getCurrentTileX(e){return Math.floor(e/tileW)}function getCurrentTileY(e){return Math.floor(e/tileW)}function getXOffsetFromHeight(e){return Math.sqrt(2)/2*e}function accessDynamicVariable(e){for(var a=e.split("."),t=window,r=0;r<a.length;r++)t[a[r]]&&(t=t[a[r]]);return t}function getObjectKeysForInnerValue(e,a,t){var r=[];for(var o in e)e.hasOwnProperty(o)&&e[o][t]===a&&r.push(o);return r}function isAnObjectCollision(e,a,t,r,o,n,i,s){return e+t/2>o-i/2&&o+i/2>e-t/2&&n+s/2>a-r/2&&a+r/2>n-s/2?!0:!1}function getRandomInteger(e,a){return Math.floor(Math.random()*(a-e))+e}function getRandomIntegerInclusive(e,a){return Math.floor(Math.random()*(a-e+1))+e}function isInRange(e,a,t,r,o){var n=Math.sqrt((e-t)*(e-t)+(a-r)*(a-r));return o>=n?!0:!1}function turntoFace(e,a){var t=e.x-a.x,r=e.y-a.y;return Math.abs(t)>Math.abs(r)?t>0?"w":"e":r>0?"n":"s"}function isFacing(e,a){var t=!1;switch(e.facing){case"n":e.y>a.y&&(t=!0);break;case"s":e.y<a.y&&(t=!0);break;case"w":e.x>a.x&&(t=!0);break;case"e":e.x<a.x&&(t=!0)}return t}function parseMoney(e,a){var t="",r=e%100,o=(e-r)/100;return o>0&&(t=o+"G "),0!=r&&(t+=r+"S"),t}function addClass(e,a){e.classList?e.classList.add(a):e.className+=" "+a}function removeClass(e,a){e.classList?e.classList.remove(a):e.className=e.className.replace(new RegExp("(^|\\b)"+a.split(" ").join("|")+"(\\b|$)","gi")," ")}function determineWhichTransitionEvent(){var e,a=document.createElement("fakeelement"),t={transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"};for(e in t)if(void 0!==a.style[e])return t[e]}function uniqueValues(e){var a={};return e.filter(function(e){return a.hasOwnProperty(e)?!1:a[e]=!0})}function sortByHighestValue(e,a){return e[0]<a[0]?1:e[0]>a[0]?-1:0}function sortByLowestValue(e,a){return e[0]<a[0]?-1:e[0]>a[0]?1:0}function drawCircle(e,a,t,r){gameContext.fillStyle=e,gameContext.beginPath(),gameContext.arc(a,t,r,0,2*Math.PI),gameContext.fill()}function sendDataWithoutNeedingAResponse(e){var a="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");a.open("get",e,!0),a.send()}function postData(e,a){var t="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");t.open("post",e,!0),t.setRequestHeader("Content-Type","application/x-www-form-urlencoded;"),t.send(a)}function cardGamePlayer2Wins(){hero.stats.cardGamesWon++,processSpeech(thisNPC,thisNPC.cardGameSpeech.lose[0],thisNPC.cardGameSpeech.lose[1]),whichCardWon=pickBestCardToTake(cardGameNameSpace.player1Cards),hero.cards.unshift(cardGameNameSpace.player1Cards[whichCardWon]);var e=thisNPC.uniqueCards.indexOf(cardGameNameSpace.player1Cards[whichCardWon]);-1!=e&&thisNPC.uniqueCards.splice(e,1),UI.showNotification("<p>You won a "+cardGameNameSpace.allCardData[cardGameNameSpace.player1Cards[whichCardWon]][2]+'</p><img class="card players" src="/images/card-game/cards/'+cardGameNameSpace.player1Cards[whichCardWon]+'.png">'),UI.updateCardAlbum(),closeCardGame()}function cardGamePlayer1Wins(){hero.stats.cardGamesLost++,processSpeech(thisNPC,thisNPC.cardGameSpeech.win[0],thisNPC.cardGameSpeech.win[1]),whichCardWon=pickBestCardToTake(cardGameNameSpace.player2Cards),thisNPC.uniqueCards.unshift(cardGameNameSpace.player2Cards[whichCardWon]);var e=hero.cards.indexOf(cardGameNameSpace.player2Cards[whichCardWon]);-1!=e&&hero.cards.splice(e,1),UI.showNotification("<p>You lost a "+cardGameNameSpace.allCardData[cardGameNameSpace.player2Cards[whichCardWon]][2]+'</p><img class="card npcs" src="/images/card-game/cards/'+cardGameNameSpace.player2Cards[whichCardWon]+'.png">'),UI.updateCardAlbum(),closeCardGame()}function cardGameIsDrawn(){processSpeech(thisNPC,thisNPC.cardGameSpeech.draw[0],thisNPC.cardGameSpeech.draw[1]),closeCardGame()}function startCardGame(e){hero.cards.length>=12?(cardGameNameSpace.player2Cards=hero.cards.slice(0,12),cardGameNameSpace.player1Cards=e.uniqueCards.concat(allCardPacks[e.baseCardPack]).slice(0,12),cardGameNameSpace.player1Skill=e.cardSkill,cardGameNameSpace.initialiseCardGame(),cardGameWrapper.classList.add("active")):UI.showNotification("<p>You don't have enough cards</p>")}function closeCardGame(){gameMode="play",cardGameWrapper.classList.remove("active"),document.getElementById("cardGame").removeEventListener("click",cardGameNameSpace.canvasClick,!1)}function pickBestCardToTake(e){for(var a,t=-1,r=0,o=0;o<e.length;o++)a=cardGameNameSpace.allCardData[e[o]][0]*cardGameNameSpace.allCardData[e[o]][0]+cardGameNameSpace.allCardData[e[o]][1]*cardGameNameSpace.allCardData[e[o]][1],a>t&&(t=a,r=o);return r}function openBoosterPack(){boosterCardsToAdd=[];var e;do e=getRandomInteger(1,cardGameNameSpace.allCardData.length),-1==boosterCardsToAdd.indexOf(e)&&boosterCardsToAdd.push(e);while(boosterCardsToAdd.length<5);for(var a=document.getElementsByClassName("cardFlip"),t=0;t<a.length;t++)a[t].classList.remove("active");for(var t=0;5>t;t++)document.getElementById("boosterCard"+t).innerHTML='<img src="/images/card-game/cards/'+boosterCardsToAdd[t]+'.png" alt="'+cardGameNameSpace.allCardData[boosterCardsToAdd[t][3]]+'">';boosterPack.classList.add("active"),boosterCardsRevealed=0,boosterPack.addEventListener("click",revealBoosterCard,!1)}function revealBoosterCard(e){"IMG"==e.target.nodeName&&(e.target.parentNode.parentNode.parentNode.classList.add("active"),boosterCardsRevealed++,boosterCardsRevealed>=5&&(hero.cards=boosterCardsToAdd.concat(hero.cards),UI.updateCardAlbum(),boosterPack.classList.remove("active")))}function canAddItemToInventory(e){for(var a=JSON.parse(JSON.stringify(hero.inventory)),t=[],r=!0,o=0;o<e.length;o++){var n=0,i=getObjectKeysForInnerValue(a,e[o].type,"type");if(i.length>0)for(var s=0;s<i.length;s++)if(itemAttributesMatch(a[i[s]],e[o])){var c=a[i[s]].quantity,h=maxNumberOfItemsPerSlot-c>e[o].quantity-n?e[o].quantity-n:maxNumberOfItemsPerSlot-c;if(n+=h,t.push(i[s]),a[i[s]].quantity+=h,n>=e[o].quantity)break}if(n<e[o].quantity)e:for(var s=0;s<hero.bags.length;s++)for(var l=currentActiveInventoryItems[hero.bags[s].type].actionValue,d=0;l>d;d++){var p=s+"-"+d;if(!(p in a)){var h=maxNumberOfItemsPerSlot>e[o].quantity-n?e[o].quantity-n:maxNumberOfItemsPerSlot;if(n+=h,t.push(p),a[p]=new Object,a[p].type=e[o].type,a[p].quantity=h,a[p].quality=e[o].quality,a[p].durability=e[o].durability,a[p].currentWear=e[o].currentWear,a[p].effectiveness=e[o].effectiveness,a[p].wrapped=e[o].wrapped,a[p].colour=e[o].colour,a[p].enchanted=e[o].enchanted,a[p].hallmark=e[o].hallmark,a[p].inscription=e[o].inscription,n>=e[o].quantity)break e}}n!=e[o].quantity&&(r=!1)}return r?(hero.inventory=JSON.parse(JSON.stringify(a)),[!0,t]):[!1]}function hasItemInInventory(e,a){var t=0,r=getObjectKeysForInnerValue(hero.inventory,parseInt(e),"type");if(r.length>0)for(var o=0;o<r.length;o++)t+=hero.inventory[r[o]].quantity;return t>=a?!0:!1}function removeItemTypeFromInventory(e,a){var t,r=a,o=getObjectKeysForInnerValue(hero.inventory,parseInt(e),"type");if(o.length>0)for(var n=0;n<o.length;n++)t=hero.inventory[o[n]].quantity,t>r?(removeFromInventory(o[n],r),r=0):(removeFromInventory(o[n],t),r-=t)}function removeFromInventory(e,a){var t=hero.inventory[e].quantity,r=document.getElementById("slot"+e);if(t-a>0){hero.inventory[e].quantity-=a;for(var o=0;o<r.childNodes.length;o++)if("qty"==r.childNodes[o].className){r.childNodes[o].innerHTML=hero.inventory[e].quantity;break}}else delete hero.inventory[e],r.innerHTML='<img alt="Empty slot" src="/images/game-world/inventory-items/blank.png">'}function itemAttributesMatch(e,a){return e.quality==a.quality&&e.durability==a.durability&&e.currentWear==a.currentWear&&e.effectiveness==a.effectiveness&&e.wrapped==a.wrapped&&e.colour==a.colour&&e.enchanted==a.enchanted&&e.hallmark==a.hallmark&&e.inscription==a.inscription?!0:!1}function inventoryItemAction(e,a,t){switch(a){case"booster":openBoosterPack(),removeFromInventory(e.parentElement.id.substring(4),1);break;case"recipe":learnRecipe(t),removeFromInventory(e.parentElement.id.substring(4),1)}}function additionalTooltipDetail(e){var a="";return"recipe"==currentActiveInventoryItems[hero.inventory[e].type].action&&-1!=hero.recipesKnown.indexOf(parseInt(currentActiveInventoryItems[hero.inventory[e].type].actionValue))&&(a+=" (already known)"),a}function init(){gameCanvas=document.getElementById("gameWorld"),gameCanvas.getContext&&(gameContext=gameCanvas.getContext("2d"),canvasWidth=gameCanvas.width,canvasHeight=gameCanvas.height,whichTransitionEvent=determineWhichTransitionEvent(),gameMode="mapLoading",cartographyCanvas=document.getElementById("cartographyCanvas"),cartographyContext=cartographyCanvas.getContext("2d"),offScreenCartographyCanvas=document.getElementById("offScreenCartographyCanvas"),offScreenCartographyContext=offScreenCartographyCanvas.getContext("2d"),canvasMapImage=document.createElement("img"),canvasMapMaskImage=document.createElement("img"),UI.init(),Input.init(),gameLoop(),getHeroGameState())}function getHeroGameState(){getJSON("/data/chr"+characterId+"/gameState.json",function(e){hero.tileX=e.tileX,hero.tileY=e.tileY,currentMap=e.currentMap,newMap=currentMap,hero.bags=e.bags,hero.cards=e.cards,hero.stats=e.stats,hero.titlesEarned=e.titlesEarned,hero.activeTitle=e.activeTitle,hero.recipesKnown=e.recipesKnown,hero.professionsKnown=e.professionsKnown,hero.inventory=e.inventory,currentMap>0&&sendDataWithoutNeedingAResponse("/game-world/generateDungeonMap.php?playerId="+characterId+"&clearMaps=true"),loadCoreAssets()},function(e){getHeroGameState()})}function loadCoreAssets(){coreImagesToLoad=[],coreImagesToLoad.push({name:"heroImg",src:"/images/game-world/core/test-iso-hero.png"}),Loader.preload(coreImagesToLoad,prepareCoreAssets,loadingProgress)}function prepareCoreAssets(){heroImg=Loader.getImage("heroImg"),getColours()}function loadCardData(){getJSON("/game-world/getCardDetails.php",function(e){cardGameNameSpace.allCardData=e.cards,loadMap()},function(e){loadCardData()})}function loadMapJSON(e){console.log("mapFilePath: "+e),getJSON(e,function(e){thisMapData=e.map,mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length,previousZoneName!=thisMapData.zoneName&&(UI.showZoneName(thisMapData.zoneName),document.title=titleTagPrefix+" - "+thisMapData.zoneName,cartographicTitle.innerHTML=thisMapData.zoneName),initCartographicMap(),findInventoryItemData()},function(a){loadMapJSON(e)})}function loadMap(){var e;if(console.log("going from "+currentMap+" to "+newMap),0>newMap&&currentMap>0?(randomDungeonName=randomDungeons[Math.abs(newMap)],newMap=-1):e="/data/chr"+characterId+"/map"+newMap+".json",0>newMap){var a=0,t=0,r=thisMapData.doors;for(var o=0 in r)r[o].map==newMap&&(a+=r[o].startX,t+=r[o].startY);var n=a/3,i=t/3;e="/game-world/generateDungeonMap.php?playerId="+characterId+"&originatingMapId="+currentMap+"&requestedMap="+newMap+"&dungeonName="+randomDungeonName+"&connectingDoorX="+n+"&connectingDoorY="+i}currentMap=newMap,loadMapJSON(e)}function loadMapAssets(){imagesToLoad=[];var e,a,t=currentMap;0>currentMap&&(t="dungeon/"+randomDungeonName),imagesToLoad.push({name:"backgroundImg",src:"/images/game-world/maps/"+t+"/bg.png"}),tileGraphicsToLoad=thisMapData.graphics;for(var r=0;r<tileGraphicsToLoad.length;r++)imagesToLoad.push({name:"tile"+r,src:"/images/game-world/maps/"+t+"/"+tileGraphicsToLoad[r].src});npcGraphicsToLoad=thisMapData.npcs;for(var r=0;r<npcGraphicsToLoad.length;r++)imagesToLoad.push({name:"npc"+r,src:"/images/game-world/npcs/"+npcGraphicsToLoad[r].src});itemGraphicsToLoad=thisMapData.items;for(var r=0;r<itemGraphicsToLoad.length;r++)e="",itemGraphicsToLoad[r].colour&&(a=getColourName(itemGraphicsToLoad[r].colour,itemGraphicsToLoad[r].type),""!=a&&(e="-"+a.toLowerCase())),imagesToLoad.push({name:"item"+r,src:"/images/game-world/items/"+currentActiveInventoryItems[itemGraphicsToLoad[r].type].worldSrc+e+".png"});Loader.preload(imagesToLoad,prepareGame,loadingProgress)}function loadTitles(){var e=hero.titlesEarned.join("|");getJSON("/game-world/getActiveTitles.php?whichIds="+e,function(e){activeTitles=e,loadCardData()},function(e){loadTitles()})}function getColours(){getJSON("/game-world/getColours.php",function(e){colourNames=e.colourNames,getQuestDetails()},function(e){getColours()})}function getQuestDetails(){getJSON("/game-world/getQuestDetails.php?chr="+characterId,function(e){questData=e.quests,loadTitles()},function(e){getQuestDetails()})}function findProfessionsAndRecipes(){var e=hero.recipesKnown.join("|");loadProfessionsAndRecipes(e)}function loadProfessionsAndRecipes(e){getJSON("/game-world/getProfessionsAndRecipes.php?whichIds="+e,function(e){hero.crafting=e.professions,inventoryInterfaceIsBuilt||UI.buildInventoryInterface(),loadMapAssets()},function(a){loadProfessionsAndRecipes(e)})}function findInventoryItemData(){var e=[];for(var a in hero.inventory)hero.inventory.hasOwnProperty(a)&&-1==e.indexOf(hero.inventory[a].type)&&e.push(hero.inventory[a].type);for(var t=0;t<hero.bags.length;t++)e.push(hero.bags[t].type);for(var t=0;t<thisMapData.items.length;t++)e.push(thisMapData.items[t].type);loadInventoryItemData(e.join("|"))}function loadInventoryItemData(e){getJSON("/game-world/getInventoryItems.php?whichIds="+e,function(e){currentActiveInventoryItems=e,findProfessionsAndRecipes()},function(a){loadInventoryItemData(e)})}function prepareGame(){tileImages=[];for(var e=0;e<tileGraphicsToLoad.length;e++)tileImages[e]=Loader.getImage("tile"+e);npcImages=[];for(var e=0;e<npcGraphicsToLoad.length;e++)npcImages[e]=Loader.getImage("npc"+e);itemImages=[];for(var e=0;e<itemGraphicsToLoad.length;e++)itemImages[e]=Loader.getImage("item"+e);backgroundImg=Loader.getImage("backgroundImg");for(var e=0;e<thisMapData.npcs.length;e++)thisMapData.npcs[e].x=getTileCentreCoordX(thisMapData.npcs[e].tileX),thisMapData.npcs[e].y=getTileCentreCoordY(thisMapData.npcs[e].tileY),thisMapData.npcs[e].drawnFacing=thisMapData.npcs[e].facing,thisMapData.npcs[e].dx=0,thisMapData.npcs[e].dy=0,thisMapData.npcs[e].movementIndex=-1;for(var e=0;e<thisMapData.items.length;e++)thisMapData.items[e].x=getTileCentreCoordX(thisMapData.items[e].tileX),thisMapData.items[e].y=getTileCentreCoordY(thisMapData.items[e].tileY),thisMapData.items[e].width=currentActiveInventoryItems[thisMapData.items[e].type].width,thisMapData.items[e].height=currentActiveInventoryItems[thisMapData.items[e].type].height,thisMapData.items[e].centreX=currentActiveInventoryItems[thisMapData.items[e].type].centreX,thisMapData.items[e].centreY=currentActiveInventoryItems[thisMapData.items[e].type].centreY;activeNPCForDialogue="",hero.x=getTileCentreCoordX(hero.tileX),hero.y=getTileCentreCoordY(hero.tileY),fae.x=hero.x+2*tileW,fae.y=hero.y+2*tileH,fae.z=40,fae.dz=1,fae.pulse=0,fae.state="idle",timeSinceLastFrameSwap=0,currentAnimationFrame=0,mapTransition="in",mapTransitionCurrentFrames=1,gameMode="play"}function removeMapAssets(){for(var e=0;e<tileGraphicsToLoad.length;e++)tileImages[e].src="",tileImages[e]=null;for(var e=0;e<npcGraphicsToLoad.length;e++)npcImages[e].src="",npcImages[e]=null;for(var e=0;e<itemGraphicsToLoad.length;e++)itemImages[e].src="",itemImages[e]=null;backgroundImg.src="",backgroundImg=null}function loadingProgress(){console.log("loading - "+Loader.getProgress())}function changeMaps(e,a){previousZoneName=thisMapData.zoneName,gameMode="mapLoading",removeMapAssets();var t=thisMapData.doors,r=getTileX(e)+","+getTileX(a);hero.tileX=t[r].startX,hero.tileY=t[r].startY,newMap=t[r].map,loadMap()}function isATerrainCollision(e,a){var t=getTileX(e),r=getTileY(a);if(0>t||0>r||t>=mapTilesX||r>=mapTilesY)return 1;switch(thisMapData.collisions[r][t]){case 1:return 1;case"d":return activeDoorX=e,activeDoorY=a,0;default:return 0}}function startDoorTransition(){""==mapTransition&&(mapTransitionCurrentFrames=1,mapTransition="out"),0>currentMap&&saveCartographyMask()}function getHeroAsCloseAsPossibleToObject(e,a,t,r){switch(hero.facing){case"n":hero.y=a+r/2+hero.height/2+1;break;case"s":hero.y=a-r/2-hero.height/2-1;break;case"w":hero.x=e+t/2+hero.width/2+1;break;case"e":hero.x=e-t/2-hero.width/2-1}}function checkHeroCollisions(){if(activeDoorX=-1,activeDoorY=-1,key[2])if(isATerrainCollision(hero.x-hero.width/2,hero.y-hero.height/2)||isATerrainCollision(hero.x+hero.width/2,hero.y-hero.height/2)){var e=getTileY(hero.y-hero.height/2),a=(e+1)*tileW;hero.y=a+hero.height/2+1}else-1!=activeDoorX&&startDoorTransition();if(key[3])if(isATerrainCollision(hero.x-hero.width/2,hero.y+hero.height/2)||isATerrainCollision(hero.x+hero.width/2,hero.y+hero.height/2)){var e=getTileY(hero.y+hero.height/2),t=e*tileW;hero.y=t-hero.height/2-1}else-1!=activeDoorX&&startDoorTransition();if(key[0])if(isATerrainCollision(hero.x-hero.width/2,hero.y+hero.height/2)||isATerrainCollision(hero.x-hero.width/2,hero.y-hero.height/2)){var e=getTileX(hero.x-hero.width/2),r=(e+1)*tileW;hero.x=r+hero.width/2+1}else-1!=activeDoorX&&startDoorTransition();if(key[1])if(isATerrainCollision(hero.x+hero.width/2,hero.y+hero.height/2)||isATerrainCollision(hero.x+hero.width/2,hero.y-hero.height/2)){var e=getTileX(hero.x+hero.width/2),o=e*tileW;hero.x=o-hero.width/2-1}else-1!=activeDoorX&&startDoorTransition();for(var n=0;n<thisMapData.npcs.length;n++)thisNPC=thisMapData.npcs[n],thisNPC.isCollidable&&isAnObjectCollision(thisNPC.x,thisNPC.y,thisNPC.width,thisNPC.height,hero.x,hero.y,hero.width,hero.height)&&getHeroAsCloseAsPossibleToObject(thisNPC.x,thisNPC.y,thisNPC.width,thisNPC.height);for(var n=0;n<thisMapData.items.length;n++)thisItem=thisMapData.items[n],isAnObjectCollision(thisItem.x,thisItem.y,thisItem.width,thisItem.height,hero.x,hero.y,hero.width,hero.height)&&getHeroAsCloseAsPossibleToObject(thisItem.x,thisItem.y,thisItem.width,thisItem.height)}function gameLoop(){switch(gameMode){case"mapLoading":console.log("loading map assets...");break;case"paused":break;case"cardGame":cardGameNameSpace.update(),cardGameNameSpace.draw();break;case"play":update(),draw()}window.requestAnimationFrame(gameLoop)}function update(){var e=window.performance.now(),a=e-lastTime;lastTime=e,hero.isMoving=!1,oldHeroX=hero.x,oldHeroY=hero.y;var t=hero.speed;if(key[5]&&(t*=2),"out"!=mapTransition){key[2]?(hero.isMoving=!0,hero.facing="n",hero.y-=t):key[3]?(hero.isMoving=!0,hero.facing="s",hero.y+=t):key[1]?(hero.isMoving=!0,hero.facing="e",hero.x+=t):key[0]&&(hero.isMoving=!0,hero.facing="w",hero.x-=t),key[4]&&checkForActions(),key[6]&&checkForChallenges(),checkHeroCollisions();var r=hero.tileX,o=hero.tileY;hero.tileX=getTileX(hero.x),hero.tileY=getTileY(hero.y),(hero.tileX!=r||hero.tileY!=o)&&heroIsInNewTile(),""!=activeNPCForDialogue&&(isInRange(hero.x,hero.y,activeNPCForDialogue.x,activeNPCForDialogue.y,closeDialogueDistance)||(dialogue.classList.add("slowerFade"),dialogue.classList.remove("active"),dialogue.addEventListener(whichTransitionEvent,function n(e){return activeNPCForDialogue="",e.currentTarget.removeEventListener(whichTransitionEvent,n,!1)},!1)))}else{switch(hero.isMoving=!0,hero.facing){case"n":hero.y-=t;break;case"s":hero.y+=t;break;case"e":hero.x+=t;break;case"w":hero.x-=t}mapTransitionCurrentFrames++,mapTransitionCurrentFrames>=mapTransitionMaxFrames&&changeMaps(activeDoorX,activeDoorY)}"in"==mapTransition&&(mapTransitionCurrentFrames+=2,mapTransitionCurrentFrames>=mapTransitionMaxFrames&&(mapTransition="")),timeSinceLastFrameSwap+=a,timeSinceLastFrameSwap>animationUpdateTime&&(currentAnimationFrame++,timeSinceLastFrameSwap=0,animateFae()),moveNPCs()}function heroIsInNewTile(){0>currentMap&&updateCartographicMiniMap();for(var e,a=0;a<thisMapData.hotspots.length;a++)e=thisMapData.hotspots[a],isInRange(hero.x,hero.y,getTileCentreCoordX(e.centreX),getTileCentreCoordY(e.centreY),e.radius*tileW)&&(questData[e.quest].hasBeenActivated<1&&UI.showNotification("<p>"+e.message+"</p>"),questData[e.quest].hasBeenActivated=1)}function checkForActions(){for(var e,a=[],t=0;t<thisMapData.items.length;t++)if(isInRange(hero.x,hero.y,thisMapData.items[t].x,thisMapData.items[t].y,thisMapData.items[t].width/2+hero.width/2+6)&&isFacing(hero,thisMapData.items[t])){var r=currentActiveInventoryItems[itemGraphicsToLoad[t].type].actionValue;switch(currentActiveInventoryItems[itemGraphicsToLoad[t].type].action){case"static":break;case"questToggle":questData[r].hasBeenActivated=Math.abs(questData[r].hasBeenActivated-1);break;case"questSet":questData[r].hasBeenActivated=1;break;case"questUnset":questData[r].hasBeenActivated=0;break;default:a=canAddItemToInventory([thisMapData.items[t]]),a[0]?(thisMapData.items.splice(t,1),UI.showChangeInInventory(a[1])):UI.showNotification("<p>Oops - sorry, no room in your bags</p>")}}for(var t=0;t<thisMapData.npcs.length;t++)if(e=thisMapData.npcs[t],e.speech&&isInRange(hero.x,hero.y,e.x,e.y,e.width+hero.width)&&isFacing(hero,e))if(e.speechIndex>=e.speech.length||canCloseDialogueBalloonNextClick&&activeNPCForDialogue==e)e.speechIndex=0,dialogue.classList.remove("active"),activeNPCForDialogue="",canCloseDialogueBalloonNextClick=!1;else{var o=e.speech[e.speechIndex][0],n=e.speech[e.speechIndex][1];e.drawnFacing=turntoFace(e,hero),processSpeech(e,o,n,!0),e.speechIndex++}key[4]=0}function processSpeech(e,a,t,r){r="undefined"!=typeof r?r:!1,individualSpeechCodes=t.split(",");for(var o=0;o<individualSpeechCodes.length;o++)switch(individualSpeechCodes[o]){case"once":e.speech.splice(e.speechIndex,1),e.speechIndex--;break;case"quest":case"quest-no-open":case"quest-no-close":case"quest-no-open-no-close":var n=a.split("|"),i=e.speech[e.speechIndex][2];if(questData[i].isUnderway)switch(questData[i].whatIsRequiredForCompletion){case"possess":case"give":case"":if("quest"==individualSpeechCodes[o]||"quest-no-open"==individualSpeechCodes[o]){for(var s=(questData[i].itemsNeededForCompletion,!0),c=questData[i].startItemsReceived.split(","),h=[],o=0;o<c.length;o++){var l,d,p=c[o].split("x");p.length>1?(l=p[0],d=p[1]):(l=1,d=c[o]),hasItemInInventory(d,l)||(s=!1)}if(s){if("give"==questData[i].whatIsRequiredForCompletion)for(var o=0;o<c.length;o++){var l,d,p=c[o].split("x");p.length>1?(l=p[0],d=p[1]):(l=1,d=c[o]),removeItemTypeFromInventory(d,l)}a=n[2],closeQuest(e,i)}else a=n[1],e.speechIndex--}else questData[i].hasBeenCompleted>0?(a=n[2],closeQuest(e,i)):(a=n[1],e.speechIndex--);break;case"multi":for(var m=questData[i].subQuestsRequiredForCompletion.split(","),g=!0,u=0;u<m.length;u++)switch(questData[m[u]].whatIsRequiredForCompletion){case"possess":case"give":case"":for(var c=(questData[m[u]].itemsNeededForCompletion,questData[m[u]].startItemsReceived.split(",")),h=[],f=0;f<c.length;f++){var l,d,p=c[f].split("x");p.length>1?(l=p[0],d=p[1]):(l=1,d=c[o]),hasItemInInventory(d,l)||(g=!1)}break;case"world":questData[m[u]].hasBeenActivated<1&&(g=!1);break;default:var v=questData[m[u]].valueAtQuestStart,y=accessDynamicVariable(questData[m[u]].whatIsRequiredForCompletion);"+"==questData[m[u]].thresholdNeededForCompletion.charAt(0)?(console.log(y+" < "+questData[m[u]].thresholdNeededForCompletion.substring(1)),y-v<questData[m[u]].thresholdNeededForCompletion&&(g=!1)):y<questData[m[u]].thresholdNeededForCompletion.substring(1)&&(g=!1)}console.log("allSubQuestsComplete: "+g),g?(a=n[2],closeQuest(e,i)):(a=n[1],e.speechIndex--);break;case"world":questData[i].hasBeenActivated>0?(a=n[2],closeQuest(e,i)):(a=n[1],e.speechIndex--);break;default:var v=questData[i].valueAtQuestStart,y=accessDynamicVariable(questData[i].whatIsRequiredForCompletion),C=!1;"+"==questData[i].thresholdNeededForCompletion.charAt(0)?y-v>=questData[i].thresholdNeededForCompletion&&(C=!0):y>=questData[i].thresholdNeededForCompletion.substring(1)&&(C=!0),C?(a=n[2],closeQuest(e,i)):(a=n[1],e.speechIndex--)}else{if("quest"==individualSpeechCodes[o]||"quest-no-close"==individualSpeechCodes[o]){var I=!0;if(questData[i].startItemsReceived){for(var w=questData[i].startItemsReceived.split(","),h=[],M=0;M<w.length;M++){var l,d,p=w[M].split("x");p.length>1?(l=p[0],d=p[1]):(l=1,d=w[M]);var D={type:parseInt(d),quantity:parseInt(l),quality:100,durability:100,currentWear:0,effectiveness:100,wrapped:0,colour:currentActiveInventoryItems[parseInt(d)].colour,enchanted:0,hallmark:0,inscription:""};h.push(D)}inventoryCheck=canAddItemToInventory(h),inventoryCheck[0]?UI.showChangeInInventory(inventoryCheck[1]):I=!1}if(I){switch(questData[i].whatIsRequiredForCompletion){case"possess":case"give":case"":break;case"multi":for(var m=questData[i].subQuestsRequiredForCompletion.split(","),u=0;u<m.length;u++){switch(questData[m[u]].isUnderway=1,questData[m[u]].whatIsRequiredForCompletion){case"possess":case"give":case"":break;case"world":break;default:questData[m[u]].valueAtQuestStart=accessDynamicVariable(questData[m[u]].whatIsRequiredForCompletion)}questData[m[u]].isUnderway=!0}break;case"world":break;default:questData[i].valueAtQuestStart=accessDynamicVariable(questData[i].whatIsRequiredForCompletion)}questData[i].isUnderway=!0}}a=n[0],e.speechIndex--}break;case"play":startCardGame(e)}UI.showDialogue(e,a),canCloseDialogueBalloonNextClick=!1,r||(canCloseDialogueBalloonNextClick=!0)}function closeQuest(e,a){giveQuestRewards(a)?(questData[a].isRepeatable>0?(questData[a].hasBeenCompleted=!1,questData[a].isUnderway=!1):(questData[a].hasBeenCompleted=!0,e.speech.splice(e.speechIndex,1),e.speechIndex--),checkForTitlesAwarded(a)):e.speechIndex--}function giveQuestRewards(e){if(questData[e].itemsReceivedOnCompletion){for(var a=[],t=questData[e].itemsReceivedOnCompletion.split(","),r=0;r<t.length;r++){var o,n,i=t[r].split("x");i.length>1?(o=i[0],n=i[1]):(o=1,n=t[r]);var s={type:parseInt(n),quantity:parseInt(o),quality:100,durability:100,currentWear:0,effectiveness:100,wrapped:0,colour:currentActiveInventoryItems[parseInt(n)].colour,enchanted:0,hallmark:0,inscription:""};a.push(s)}return inventoryCheck=canAddItemToInventory(a),inventoryCheck[0]?(UI.showChangeInInventory(inventoryCheck[1]),!0):(UI.showNotification("<p>Oops - sorry, no room in your bags</p>"),!1)}return!0}function checkForTitlesAwarded(e){if(questData[e].titleGainedAfterCompletion){var a=questData[e].titleGainedAfterCompletion;-1==hero.titlesEarned.indexOf(a)&&(hero.titlesEarned.push(a),UI.showNotification("<p>You earned the &quot;"+activeTitles[a]+"&quot; title</p>"))}}function checkForChallenges(){for(var e=0;e<thisMapData.npcs.length;e++)thisNPC=thisMapData.npcs[e],isInRange(hero.x,hero.y,thisNPC.x,thisNPC.y,thisNPC.width+hero.width)&&isFacing(hero,thisNPC)&&thisNPC.cardGameSpeech&&(thisNPC.drawnFacing=turntoFace(thisNPC,hero),processSpeech(thisNPC,thisNPC.cardGameSpeech.challenge[0],thisNPC.cardGameSpeech.challenge[1]));key[6]=0}function moveNPCs(){for(var e,a,t,r,o,n=0;n<thisMapData.npcs.length;n++)if(e=thisMapData.npcs[n],e.isMoving){switch(r=e.x,o=e.y,e.drawnFacing=e.facing,e.facing){case"n":if(e.y-=e.speed,isATerrainCollision(e.x-e.width/2,e.y-e.height/2)||isATerrainCollision(e.x+e.width/2,e.y-e.height/2)){var i=getTileY(e.y-e.height/2),s=(i+1)*tileW;e.y=s+e.height/2+1}break;case"s":if(e.y+=e.speed,isATerrainCollision(e.x-e.width/2,e.y+e.height/2)||isATerrainCollision(e.x+e.width/2,e.y+e.height/2)){var i=getTileY(e.y+e.height/2),c=i*tileW;e.y=c-e.height/2-1}break;case"w":if(e.x-=e.speed,isATerrainCollision(e.x-e.width/2,e.y+e.height/2)||isATerrainCollision(e.x-e.width/2,e.y-e.height/2)){var i=getTileX(e.x-e.width/2),h=(i+1)*tileW;e.x=h+e.width/2+1}break;case"e":if(e.x+=e.speed,isATerrainCollision(e.x+e.width/2,e.y+e.height/2)||isATerrainCollision(e.x+e.width/2,e.y-e.height/2)){var i=getTileX(e.x+e.width/2),l=i*tileW;e.x=l-e.width/2-1}}isAnObjectCollision(e.x,e.y,e.width,e.height,hero.x,hero.y,hero.width,hero.height)&&(e.x=r,e.y=o);for(var d=0;d<thisMapData.npcs.length;d++)n!=d&&(thisOtherNPC=thisMapData.npcs[d],thisOtherNPC.isCollidable&&isAnObjectCollision(e.x,e.y,e.width,e.height,thisOtherNPC.x,thisOtherNPC.y,thisOtherNPC.width,thisOtherNPC.height)&&(e.x=r,e.y=o));for(var n=0;n<thisMapData.items.length;n++)thisItem=thisMapData.items[n],isAnObjectCollision(e.x,e.y,e.width,e.height,thisItem.x,thisItem.y,thisItem.width,thisItem.height)&&(e.x=r,e.y=o);if(e.dx+=e.x-r,e.dy+=e.y-o,a=!1,Math.abs(e.dx)>=tileW&&(e.dx>0?e.dx-=tileW:e.dx+=tileW,a=!0),Math.abs(e.dy)>=tileW&&(e.dy>0?e.dy-=tileW:e.dy+=tileW,a=!0),a)switch(e.movementIndex++,e.movementIndex>=e.movement.length&&(e.movementIndex=0),t=e.movement[e.movementIndex]){case"-":e.isMoving=!1;case"?":do e.facing=facingsPossible[Math.floor(Math.random()*facingsPossible.length)];while(isATerrainCollision(e.x+relativeFacing[e.facing].x*tileW,e.y+relativeFacing[e.facing].y*tileW));break;default:e.facing=t}}}function animateFae(){fae.z=Math.floor(8*(Math.sin(fae.dz)+1)+40),fae.dz+=.2;for(var e=0;e<fae.particles.length;e++)fae.particles[e].alpha-=.1,fae.particles[e].alpha<=0&&fae.particles.splice(e,1);if(fae.particles.length<fae.maxParticles&&1==getRandomInteger(1,4)){var a=findIsoCoordsX(fae.x,fae.y),t=findIsoCoordsY(fae.x,fae.y)-fae.z,r=a+getRandomInteger(0,8)-4,o=t+getRandomInteger(0,8)-4;isInRange(a,t,r,o,6)&&fae.particles.push({depth:findIsoCoordsY(fae.x,fae.y),isoX:r,isoY:o,alpha:1})}}function learnRecipe(e){-1===hero.recipesKnown.indexOf(e)&&hero.recipesKnown.push(parseInt(e))}function draw(){if("mapLoading"==gameMode)gameContext.fillRect(0,0,canvasWidth,canvasHeight),gameContext.fillStyle="black",gameContext.fill();else{var e,a,t,r,o,n;hero.isox=findIsoCoordsX(hero.x,hero.y),hero.isoy=findIsoCoordsY(hero.x,hero.y);var i=[[hero.isoy,"img",heroImg,Math.floor(canvasWidth/2-hero.feetOffsetX),Math.floor(canvasHeight/2-hero.feetOffsetY)]];t=findIsoCoordsX(fae.x,fae.y),r=findIsoCoordsY(fae.x,fae.y),
i.push([r,"faeCentre",Math.floor(t-hero.isox+canvasWidth/2),Math.floor(r-hero.isoy+canvasHeight/2-fae.z)]);for(var s=0;s<fae.particles.length;s++)i.push([fae.particles[s].depth,"faeParticle",Math.floor(fae.particles[s].isoX-hero.isox+canvasWidth/2),Math.floor(fae.particles[s].isoY-hero.isoy+canvasHeight/2),fae.particles[s].alpha]);for(var c=thisMapData.terrain,h=0,l=0,s=0;mapTilesX>s;s++)for(var d=0;mapTilesY>d;d++)"*"!=c[d][s]&&(t=getTileIsoCentreCoordX(s,d),r=getTileIsoCentreCoordY(s,d),e=thisMapData.graphics[c[d][s]].centreX,a=thisMapData.graphics[c[d][s]].centreY,i.push([r,"img",tileImages[c[d][s]],Math.floor(t-hero.isox-e+canvasWidth/2),Math.floor(r-hero.isoy-a+canvasHeight/2)]));for(var s=0;s<thisMapData.npcs.length;s++)o=thisMapData.npcs[s],h=currentAnimationFrame%o.animation.walk.length,l=o.animation.walk[o.drawnFacing],t=findIsoCoordsX(o.x,o.y),r=findIsoCoordsY(o.x,o.y),i.push([r,"sprite",npcImages[s],h*o.spriteWidth,l*o.spriteHeight,o.spriteWidth,o.spriteHeight,Math.floor(t-hero.isox-o.centreX+canvasWidth/2),Math.floor(r-hero.isoy-o.centreY+canvasHeight/2),o.spriteWidth,o.spriteHeight]);for(var s=0;s<thisMapData.items.length;s++)n=thisMapData.items[s],t=findIsoCoordsX(n.x,n.y),r=findIsoCoordsY(n.x,n.y),i.push([r,"img",itemImages[s],Math.floor(t-hero.isox-n.centreX+canvasWidth/2),Math.floor(r-hero.isoy-n.centreY+canvasHeight/2)]);i.sort(sortByLowestValue),gameContext.drawImage(backgroundImg,Math.floor(getTileIsoCentreCoordX(0,mapTilesX-1)-hero.isox-tileW/2),Math.floor(getTileIsoCentreCoordY(0,0)-hero.isoy-tileH/2));for(var s=0;s<i.length;s++)switch(i[s][1]){case"faeCentre":drawCircle("#ffdc0c",i[s][2],i[s][3],2),drawCircle("rgba(255,220,255,0.3)",i[s][2],i[s][3],4),gameContext.fillStyle="rgba(0,0,0,"+.01*(65-fae.z)+")",gameContext.beginPath(),gameContext.ellipse(i[s][2]-getXOffsetFromHeight(fae.z),i[s][3]+fae.z,3,1,0,0,2*Math.PI),gameContext.fill();break;case"faeParticle":gameContext.fillStyle="rgba(255,220,255,"+i[s][4]+")",gameContext.fillRect(i[s][2],i[s][3],1,1);break;case"sprite":gameContext.drawImage(i[s][2],i[s][3],i[s][4],i[s][5],i[s][6],i[s][7],i[s][8],i[s][9],i[s][10]);break;case"img":gameContext.drawImage(i[s][2],i[s][3],i[s][4])}if(""!=activeNPCForDialogue&&UI.updateDialogue(activeNPCForDialogue),"out"==mapTransition){var p=1-mapTransitionCurrentFrames/mapTransitionMaxFrames,m=gameContext.createRadialGradient(canvasWidth/2,canvasHeight/2,p*canvasWidth/2,canvasWidth/2,canvasHeight/2,0);m.addColorStop(0,"rgba(0,0,0,1)"),m.addColorStop(1,"rgba(0,0,0,0)"),gameContext.fillStyle=m,gameContext.fillRect(0,0,canvasWidth,canvasHeight)}else if("in"==mapTransition){var p=mapTransitionCurrentFrames/mapTransitionMaxFrames,m=gameContext.createRadialGradient(canvasWidth/2,canvasHeight/2,p*canvasWidth/2,canvasWidth/2,canvasHeight/2,0);m.addColorStop(0,"rgba(0,0,0,1)"),m.addColorStop(1,"rgba(0,0,0,0)"),gameContext.fillStyle=m,gameContext.fillRect(0,0,canvasWidth,canvasHeight)}}}var animationFramesPerSecond=16,lastTime=0,elapsed=0,timeSinceLastFrameSwap=0,currentAnimationFrame=0,animationUpdateTime=1e3/animationFramesPerSecond,titleTagPrefix="Autumn Earth",mapTransition="",mapTransitionCurrentFrames=1,mapTransitionMaxFrames=60,activeDoorX=-1,activeDoorY=-1,characterId=999,currentMap=0,newMap=0,thisMapData="",mapTilesX=0,mapTilesY=0,tileGraphics=[],tileW=48,tileH=tileW/2,tileGraphicsToLoad=0,npcGraphicsToLoad=0,itemGraphicsToLoad=0,canvasWidth=800,canvasHeight=600,randomDungeonName="",randomDungeons=["","the-barrow-mines"],previousZoneName="",currentActiveInventoryItems=[],maxNumberOfItemsPerSlot=20,activeTitles=[],inventoryInterfaceIsBuilt=!1,whichTransitionEvent="",activeNPCForDialogue="",closeDialogueDistance=200,canCloseDialogueBalloonNextClick=!1,boosterCardsRevealed=0,boosterCardsToAdd=[],questData=[],colourNames=[],currentRecipePanelProfession=-1,key=[0,0,0,0,0,0],hero={x:0,y:0,dx:0,dy:0,width:20,height:20,feetOffsetX:40,feetOffsetY:69,speed:4,isMoving:!1,facing:"s",sequences:{"stand-s":[3],"stand-n":[10],"stand-w":[17],"stand-e":[24],"walk-s":[3,4,5,6,5,4,3,2,1,0,1,2],"walk-n":[10,11,12,13,12,11,10,9,8,7,8,9],"walk-w":[17,18,19,20,19,18,17,16,15,14,15,16],"walk-e":[24,25,26,27,26,25,24,23,22,21,22,23]}},fae={particles:[],maxParticles:10},facingsPossible=["n","e","s","w"],relativeFacing={n:{x:0,y:-1},s:{x:0,y:1},e:{x:1,y:0},w:{x:-1,y:0}};!function(){for(var e=0,a=["ms","moz","webkit","o"],t=0;t<a.length&&!window.requestAnimationFrame;++t)window.requestAnimationFrame=window[a[t]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[a[t]+"CancelAnimationFrame"]||window[a[t]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(a,t){var r=(new Date).getTime(),o=Math.max(0,16-(r-e)),n=window.setTimeout(function(){a(r+o)},o);return e=r+o,n}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}();var getJSON=function(e,a,t){var r="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");r.open("get",e,!0),r.onreadystatechange=function(){var e,o;if(4==r.readyState){e=r.status;var n=!0;if(200==e){try{o=JSON.parse(r.responseText)}catch(i){n=!1,t&&t(e)}n&&a&&a(o)}else t&&t(e)}},r.send()};window.Loader=function(){function e(){h=0,l=!1,d=0,p={}}function a(){}function t(){}function r(e){++h,a(c()),h==d&&(l=!1,t())}function o(e){console.log("Error on loading the image: "+e.srcElement)}function n(e,a){try{p[e]=new Image,p[e].onload=function(){r(e)},p[e].onerror=o,p[e].src=a}catch(t){console.log(t.message)}}function i(e){return p[e]?p[e]:void 0}function s(r,o,i){if(e(),!l){l=!0;try{d=r.length,a=i||function(){},t=o||function(){};for(var s=0;s<r.length;++s)n(r[s].name,r[s].src)}catch(c){console.log(c.message)}}}function c(){return h/d*100}var h=0,l=!1,d=0,p={};return{preload:s,getProgress:c,getImage:i,reset:e,images:p}}(),allCardPacks=[[1,1,1,1,1,1,1,1,3,3,3,3,3,3,3,3,3],[1,1,1,1,1,1,2,2,2,2,2,3,3,3,3,3,3]];var Input={init:function(){document.addEventListener("keydown",function(e){Input.changeKey(e.keyCode,1,"down")}),document.addEventListener("keyup",function(e){Input.changeKey(e.keyCode,0,"up")})},changeKey:function(e,a,t){switch(e){case KeyBindings.left:key[0]=a;break;case KeyBindings.up:key[2]=a;break;case KeyBindings.right:key[1]=a;break;case KeyBindings.down:key[3]=a;break;case KeyBindings.action:key[4]=0,"up"===t&&(key[4]=1);break;case KeyBindings.run:key[5]=a;break;case KeyBindings.challenge:key[6]=a}}},KeyBindings={left:37,right:39,up:38,down:40,pause:80,action:17,run:16,challenge:67},UI={init:function(){document.getElementById("displayZoneName"),document.getElementById("activeCartographicMap"),document.getElementById("cartographicTitle"),document.getElementById("dialogue"),document.getElementById("notification"),document.getElementById("cardGameWrapper"),document.getElementById("cardAlbumList"),document.getElementById("boosterPack"),document.getElementById("createRecipeList")},showZoneName:function(e){displayZoneName.classList.remove("active"),displayZoneName.textContent=e,void displayZoneName.offsetWidth,displayZoneName.classList.add("active")},buildInventoryInterface:function(){for(var e,a,t,r,o,n="",i=0;i<hero.bags.length;i++){n+='<div class="inventoryBag"><div class="draggableBar">'+currentActiveInventoryItems[hero.bags[i].type].shortname+'</div><ol class="active" id="bag'+i+'">';for(var s=currentActiveInventoryItems[hero.bags[i].type].actionValue,c=0;s>c;c++){var h=i+"-"+c;n+='<li id="slot'+h+'">',h in hero.inventory?(a="",t="",e=getColourName(hero.inventory[h].colour,hero.inventory[h].type),""!=e&&(a=e+" ",t="-"+e.toLowerCase()),r=currentActiveInventoryItems[hero.inventory[h].type].action,o="",r&&(o='data-action="'+r+'" data-action-value="'+currentActiveInventoryItems[hero.inventory[h].type].actionValue+'" '),n+='<img src="/images/game-world/inventory-items/'+hero.inventory[h].type+t+'.png" '+o+'alt="">',n+='<span class="qty">'+hero.inventory[h].quantity+"</span>",n+="<p><em>"+a+currentActiveInventoryItems[hero.inventory[h].type].shortname+" </em>"+currentActiveInventoryItems[hero.inventory[h].type].description+' <span class="price">Sell price: '+parseMoney(hero.inventory[h].quantity*currentActiveInventoryItems[hero.inventory[h].type].priceCode,0)+"</span>"+additionalTooltipDetail(h)+"</p>"):n+='<img alt="Empty slot" src="/images/game-world/inventory-items/blank.png">',n+="</li>"}n+="</ol></div></div>"}document.getElementById("inventoryPanels").innerHTML=n,document.getElementById("inventoryPanels").ondblclick=UI.inventoryItemDoubleClick,UI.initDrag(".draggableBar"),UI.updateCardAlbum(),UI.populateRecipeList(0),inventoryInterfaceIsBuilt=!0},showChangeInInventory:function(e){document.getElementById("slot"+e[0]).addEventListener(whichTransitionEvent,function t(e){elementList=document.querySelectorAll("#inventoryPanels .changed");for(var a=0;a<elementList.length;a++)removeClass(elementList[a],"changed");return e.currentTarget.removeEventListener(whichTransitionEvent,t,!1)},!1);for(var a=0;a<e.length;a++)thisSlotsId=e[a],slotMarkup='<img src="/images/game-world/inventory-items/'+hero.inventory[thisSlotsId].type+'.png" alt="">',slotMarkup+='<span class="qty">'+hero.inventory[thisSlotsId].quantity+"</span>",slotMarkup+="<p><em>"+currentActiveInventoryItems[hero.inventory[thisSlotsId].type].shortname+" </em>"+currentActiveInventoryItems[hero.inventory[thisSlotsId].type].description+' <span class="price">Sell price: '+parseMoney(hero.inventory[thisSlotsId].quantity*currentActiveInventoryItems[hero.inventory[thisSlotsId].type].priceCode,0)+"</span>"+additionalTooltipDetail(thisSlotsId)+"</p>",thisSlotElem=document.getElementById("slot"+thisSlotsId),thisSlotElem.innerHTML=slotMarkup,addClass(thisSlotElem,"changed")},handleDrag:function(e){UI.inDrag&&(UI.activeDragObject.style.cssText="z-index:2;left: "+(objInitLeft+e.pageX-dragStartX)+"px; top: "+(objInitTop+e.pageY-dragStartY)+"px")},endDrag:function(e){UI.inDrag=!1,document.removeEventListener("mousemove",UI.handleDrag,!1),document.removeEventListener("mouseup",UI.endDrag,!1),UI.activeDragObject=""},initDrag:function(e){var a=document.querySelectorAll(e);for(i=0;i<a.length;i++)a[i].addEventListener("mousedown",function(t){UI.activeDragObject=this.parentElement,UI.inDrag=!0,objInitLeft=UI.activeDragObject.offsetLeft,objInitTop=UI.activeDragObject.offsetTop,dragStartX=t.pageX,dragStartY=t.pageY,document.addEventListener("mousemove",UI.handleDrag,!1),document.addEventListener("mouseup",UI.endDrag,!1);var r=document.querySelectorAll(e);for(j=0;j<r.length;j++)a[j].parentElement.style.zIndex=1},!1)},inventoryItemDoubleClick:function(e){var a=e.target.getAttribute("data-action");a&&inventoryItemAction(e.target,a,e.target.getAttribute("data-action-value"))},showDialogue:function(e,a){dialogue.innerHTML=a,dialogue.classList.remove("slowerFade"),dialogue.classList.add("active"),activeNPCForDialogue=e,UI.updateDialogue(activeNPCForDialogue)},updateDialogue:function(e){var a=findIsoCoordsX(e.x,e.y),t=findIsoCoordsY(e.x,e.y),r="translate("+Math.floor(a-hero.isox+canvasWidth/2-40)+"px,"+Math.floor(0-(canvasHeight-(t-hero.isoy-e.centreY+canvasHeight/2)+40))+"px)";dialogue.style.transform=r},showNotification:function(e){notification.classList.remove("active"),notification.innerHTML=e,void notification.offsetWidth,notification.classList.add("active")},updateCardAlbum:function(){for(var e="",a=0;30>a;a++)e+=hero.cards[a]?'<li><img src="/images/card-game/cards/'+hero.cards[a]+'.png" class="card players" alt="'+cardGameNameSpace.allCardData[hero.cards[a]][2]+' card"></li>':"<li></li>";cardAlbumList.innerHTML=e},populateRecipeList:function(e){if(currentRecipePanelProfession!=e){for(var a,t="",r=0;r<hero.crafting[e].sortOrder.length;r++)a=hero.crafting[e].recipes[hero.crafting[e].sortOrder[r]],t+='<li class="active"><img src="/images/game-world/inventory-items/'+a.imageId+'.png" alt="'+a.recipeName+'"><h3>'+a.recipeName+"</h3><p>"+a.recipeDescription+"</p></li>";createRecipeList.innerHTML=t,currentRecipePanelProfession=e}}};"serviceWorker"in navigator&&navigator.serviceWorker.register("/game-world/serviceWorker.min.js",{scope:"/game-world/"}),"querySelectorAll"in document&&"addEventListener"in window&&window.HTMLCanvasElement&&init();