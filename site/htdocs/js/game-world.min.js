function updateCartographicMiniMap(){var e=246/(mapTilesX*tileW),t=hero.x*e,a=hero.y*e,n=0,i=35,r=offScreenCartographyContext.createRadialGradient(t,a,n,t,a,i);r.addColorStop(0,"rgb(255,255,255)"),r.addColorStop(1,"rgba(255,255,255,0)"),offScreenCartographyContext.arc(t,a,i,0,2*Math.PI),offScreenCartographyContext.fillStyle=r,offScreenCartographyContext.fill(),cartographyContext.clearRect(0,0,246,246),cartographyContext.globalCompositeOperation="copy",cartographyContext.drawImage(offScreenCartographyCanvas,0,0),cartographyContext.globalCompositeOperation="source-atop",cartographyContext.drawImage(canvasMapImage,0,0)}function initCartographicMap(){canvasMapImage.src="/generateCartographicMap.php?playerId="+characterId+"&dungeonName="+randomDungeonName+"&plotChests=true&requestedMap="+newMap,canvasMapImage.onload=function(){console.log("getting mask - /game-world/getCartographicMapMask.php?chr="+characterId+"&dungeonName="+randomDungeonName+"&currentMap="+newMap),canvasMapMaskImage.src="/game-world/getCartographicMapMask.php?chr="+characterId+"&dungeonName="+randomDungeonName+"&currentMap="+newMap+"&cache="+Date.now(),canvasMapMaskImage.onload=function(){console.log("canvasMapMaskImage onload"),offScreenCartographyContext.clearRect(0,0,246,246),offScreenCartographyContext.drawImage(canvasMapMaskImage,0,0),updateCartographicMiniMap()}}}function saveCartographyMask(){var e=offScreenCartographyCanvas.toDataURL();postData("/game-world/saveCartographicMapMask.php","chr="+characterId+"&dungeonName="+randomDungeonName+"&currentMap="+currentMap+"&data="+e)}function getColourName(e,t){var a="";return 1!=currentActiveInventoryItems[t].hasInherentColour&&(a=colourNames[e]),a}function mixColours(){for(var e=0,t=0,a=0,n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],i=0;i<arguments.length;i++)n[arguments[i]]++,e|=arguments[i],arguments[i]==(16|arguments[i])&&t++,arguments[i]==(8|arguments[i])&&a++;for(var i=0;i<n.length;i++)if(n[i]/arguments.length>.7){e=i;break}return e>24&&(e-=t>a?8:a>t?16:24),e}function getTileX(e){return Math.floor(e/tileW)}function getTileY(e){return Math.floor(e/tileW)}function findIsoCoordsX(e,t){return Math.floor(mapTilesY*tileW/2-t/2+e/2)}function findIsoCoordsY(e,t){return Math.floor(e/4+t/4-tileH/2)}function getTileCentreCoordX(e){return e*tileW+tileW/2}function getTileCentreCoordY(e){return e*tileW+tileW/2}function getTileIsoCentreCoordX(e,t){return tileW/2*(mapTilesY-t+e)}function getTileIsoCentreCoordY(e,t){return tileH/2*(t+e)}function getCurrentTileX(e){return Math.floor(e/tileW)}function getCurrentTileY(e){return Math.floor(e/tileW)}function sortByIsoDepth(e,t){return e[0]<t[0]?-1:e[0]>t[0]?1:0}function getXOffsetFromHeight(e){return Math.sqrt(2)/2*e}function getObjectKeysForInnerValue(e,t,a){console.log("looking for "+t);var n=[];for(var i in e)e.hasOwnProperty(i)&&(console.log("checking:"+e[i][a]),e[i][a]===t&&n.push(i));return n}function isAnObjectCollision(e,t,a,n,i,r,o,s){return e+a/2>i-o/2&&i+o/2>e-a/2&&r+s/2>t-n/2&&t+n/2>r-s/2?!0:!1}function getRandomInteger(e,t){return Math.floor(Math.random()*(t-e))+e}function isInRange(e,t,a,n,i){var r=Math.sqrt((e-a)*(e-a)+(t-n)*(t-n));return i>=r?!0:!1}function turntoFace(e,t){var a=e.x-t.x,n=e.y-t.y;return Math.abs(a)>Math.abs(n)?a>0?"w":"e":n>0?"n":"s"}function isFacing(e,t){var a=!1;switch(e.facing){case"n":e.y>t.y&&(a=!0);break;case"s":e.y<t.y&&(a=!0);break;case"w":e.x>t.x&&(a=!0);break;case"e":e.x<t.x&&(a=!0)}return a}function parseMoney(e,t){var a="",n=e%100,i=(e-n)/100;return i>0&&(a=i+"G "),0!=n&&(a+=n+"S"),a}function addClass(e,t){e.classList?e.classList.add(t):e.className+=" "+t}function removeClass(e,t){e.classList?e.classList.remove(t):e.className=e.className.replace(new RegExp("(^|\\b)"+t.split(" ").join("|")+"(\\b|$)","gi")," ")}function determineWhichTransitionEvent(){var e,t=document.createElement("fakeelement"),a={transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"};for(e in a)if(void 0!==t.style[e])return a[e]}function drawCircle(e,t,a,n){gameContext.fillStyle=e,gameContext.beginPath(),gameContext.arc(t,a,n,0,2*Math.PI),gameContext.fill()}function sendDataWithoutNeedingAResponse(e){var t="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");t.open("get",e,!0),t.send()}function postData(e,t){var a="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");a.open("post",e,!0),a.setRequestHeader("Content-Type","application/x-www-form-urlencoded;"),a.send(t)}function init(){gameCanvas=document.getElementById("gameWorld"),gameCanvas.getContext&&(gameContext=gameCanvas.getContext("2d"),canvasWidth=gameCanvas.width,canvasHeight=gameCanvas.height,whichTransitionEvent=determineWhichTransitionEvent(),gameMode="mapLoading",cartographyCanvas=document.getElementById("cartographyCanvas"),cartographyContext=cartographyCanvas.getContext("2d"),offScreenCartographyCanvas=document.getElementById("offScreenCartographyCanvas"),offScreenCartographyContext=offScreenCartographyCanvas.getContext("2d"),canvasMapImage=document.createElement("img"),canvasMapMaskImage=document.createElement("img"),UI.init(),Input.init(),gameLoop(),getHeroGameState())}function getHeroGameState(){getJSON("/data/chr"+characterId+"/gameState.json",function(e){hero.tileX=e.tileX,hero.tileY=e.tileY,currentMap=e.currentMap,newMap=currentMap,hero.bags=e.bags,hero.inventory=e.inventory,currentMap>0&&sendDataWithoutNeedingAResponse("/generateDungeonMap.php?playerId="+characterId+"&clearMaps=true"),loadCoreAssets()},function(e){getHeroGameState()})}function loadCoreAssets(){coreImagesToLoad=[],coreImagesToLoad.push({name:"heroImg",src:"/images/game-world/core/test-iso-hero.png"}),Loader.preload(coreImagesToLoad,prepareCoreAssets,loadingProgress)}function prepareCoreAssets(){heroImg=Loader.getImage("heroImg"),loadMap()}function loadMapJSON(e){console.log("mapFilePath: "+e),getJSON(e,function(e){thisMapData=e.map,mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length,previousZoneName!=thisMapData.zoneName&&(UI.showZoneName(thisMapData.zoneName),document.title=titleTagPrefix+" - "+thisMapData.zoneName,cartographicTitle.innerHTML=thisMapData.zoneName),initCartographicMap(),findInventoryItemData()},function(t){loadMapJSON(e)})}function loadMap(){var e;if(console.log("going from "+currentMap+" to "+newMap),0>newMap&&currentMap>0?(randomDungeonName=randomDungeons[Math.abs(newMap)],newMap=-1):e="/data/chr"+characterId+"/map"+newMap+".json",0>newMap){var t=0,a=0,n=thisMapData.doors;for(var i=0 in n)n[i].map==newMap&&(t+=n[i].startX,a+=n[i].startY);var r=t/3,o=a/3;e="/generateDungeonMap.php?playerId="+characterId+"&originatingMapId="+currentMap+"&requestedMap="+newMap+"&dungeonName="+randomDungeonName+"&connectingDoorX="+r+"&connectingDoorY="+o}currentMap=newMap,loadMapJSON(e)}function loadMapAssets(){imagesToLoad=[];var e,t,a=currentMap;0>currentMap&&(a="dungeon/"+randomDungeonName),imagesToLoad.push({name:"backgroundImg",src:"/images/game-world/maps/"+a+"/bg.png"}),tileGraphicsToLoad=thisMapData.graphics;for(var n=0;n<tileGraphicsToLoad.length;n++)imagesToLoad.push({name:"tile"+n,src:"/images/game-world/maps/"+a+"/"+tileGraphicsToLoad[n].src});npcGraphicsToLoad=thisMapData.npcs;for(var n=0;n<npcGraphicsToLoad.length;n++)imagesToLoad.push({name:"npc"+n,src:"/images/game-world/npcs/"+npcGraphicsToLoad[n].src});itemGraphicsToLoad=thisMapData.items;for(var n=0;n<itemGraphicsToLoad.length;n++)e="",itemGraphicsToLoad[n].colour&&(t=getColourName(itemGraphicsToLoad[n].colour,itemGraphicsToLoad[n].type),""!=t&&(e="-"+t.toLowerCase())),imagesToLoad.push({name:"item"+n,src:"/images/game-world/items/"+currentActiveInventoryItems[itemGraphicsToLoad[n].type].worldSrc+e+".png"});Loader.preload(imagesToLoad,prepareGame,loadingProgress)}function findInventoryItemData(){var e=[];for(var t in hero.inventory)hero.inventory.hasOwnProperty(t)&&-1==e.indexOf(hero.inventory[t].type)&&e.push(hero.inventory[t].type);for(var a=0;a<hero.bags.length;a++)e.push(hero.bags[a].type);for(var a=0;a<thisMapData.items.length;a++)e.push(thisMapData.items[a].type);loadInventoryItemData(e.join("|"))}function loadInventoryItemData(e){getJSON("/game-world/getInventoryItems.php?whichIds="+e,function(e){currentActiveInventoryItems=e,inventoryInterfaceIsBuilt||UI.buildInventoryInterface(),loadMapAssets()},function(t){loadInventoryItemData(e)})}function prepareGame(){tileImages=[];for(var e=0;e<tileGraphicsToLoad.length;e++)tileImages[e]=Loader.getImage("tile"+e);npcImages=[];for(var e=0;e<npcGraphicsToLoad.length;e++)npcImages[e]=Loader.getImage("npc"+e);itemImages=[];for(var e=0;e<itemGraphicsToLoad.length;e++)itemImages[e]=Loader.getImage("item"+e);backgroundImg=Loader.getImage("backgroundImg");for(var e=0;e<thisMapData.npcs.length;e++)thisMapData.npcs[e].x=getTileCentreCoordX(thisMapData.npcs[e].tileX),thisMapData.npcs[e].y=getTileCentreCoordY(thisMapData.npcs[e].tileY),thisMapData.npcs[e].drawnFacing=thisMapData.npcs[e].facing,thisMapData.npcs[e].dx=0,thisMapData.npcs[e].dy=0,thisMapData.npcs[e].movementIndex=-1;for(var e=0;e<thisMapData.items.length;e++)thisMapData.items[e].x=getTileCentreCoordX(thisMapData.items[e].tileX),thisMapData.items[e].y=getTileCentreCoordY(thisMapData.items[e].tileY),thisMapData.items[e].width=currentActiveInventoryItems[thisMapData.items[e].type].width,thisMapData.items[e].height=currentActiveInventoryItems[thisMapData.items[e].type].height,thisMapData.items[e].centreX=currentActiveInventoryItems[thisMapData.items[e].type].centreX,thisMapData.items[e].centreY=currentActiveInventoryItems[thisMapData.items[e].type].centreY;activeNPCForDialogue="",hero.x=getTileCentreCoordX(hero.tileX),hero.y=getTileCentreCoordY(hero.tileY),fae.x=hero.x+2*tileW,fae.y=hero.y+2*tileH,fae.z=40,fae.dz=1,fae.pulse=0,fae.state="idle",timeSinceLastFrameSwap=0,currentAnimationFrame=0,mapTransition="in",mapTransitionCurrentFrames=1,gameMode="play"}function removeMapAssets(){for(var e=0;e<tileGraphicsToLoad.length;e++)tileImages[e].src="",tileImages[e]=null;for(var e=0;e<npcGraphicsToLoad.length;e++)npcImages[e].src="",npcImages[e]=null;for(var e=0;e<itemGraphicsToLoad.length;e++)itemImages[e].src="",itemImages[e]=null;backgroundImg.src="",backgroundImg=null}function loadingProgress(){console.log("loading - "+Loader.getProgress())}function changeMaps(e,t){previousZoneName=thisMapData.zoneName,gameMode="mapLoading",removeMapAssets();var a=thisMapData.doors,n=getTileX(e)+","+getTileX(t);hero.tileX=a[n].startX,hero.tileY=a[n].startY,newMap=a[n].map,loadMap()}function isATerrainCollision(e,t){var a=getTileX(e),n=getTileY(t);if(0>a||0>n||a>=mapTilesX||n>=mapTilesY)return 1;switch(thisMapData.collisions[n][a]){case 1:return 1;case"d":return activeDoorX=e,activeDoorY=t,0;default:return 0}}function startDoorTransition(){""==mapTransition&&(mapTransitionCurrentFrames=1,mapTransition="out"),0>currentMap&&saveCartographyMask()}function getHeroAsCloseAsPossibleToObject(e,t,a,n){switch(hero.facing){case"n":hero.y=t+n/2+hero.height/2+1;break;case"s":hero.y=t-n/2-hero.height/2-1;break;case"w":hero.x=e+a/2+hero.width/2+1;break;case"e":hero.x=e-a/2-hero.width/2-1}}function checkHeroCollisions(){if(activeDoorX=-1,activeDoorY=-1,key[2])if(isATerrainCollision(hero.x-hero.width/2,hero.y-hero.height/2)||isATerrainCollision(hero.x+hero.width/2,hero.y-hero.height/2)){var e=getTileY(hero.y-hero.height/2),t=(e+1)*tileW;hero.y=t+hero.height/2+1}else-1!=activeDoorX&&startDoorTransition();if(key[3])if(isATerrainCollision(hero.x-hero.width/2,hero.y+hero.height/2)||isATerrainCollision(hero.x+hero.width/2,hero.y+hero.height/2)){var e=getTileY(hero.y+hero.height/2),a=e*tileW;hero.y=a-hero.height/2-1}else-1!=activeDoorX&&startDoorTransition();if(key[0])if(isATerrainCollision(hero.x-hero.width/2,hero.y+hero.height/2)||isATerrainCollision(hero.x-hero.width/2,hero.y-hero.height/2)){var e=getTileX(hero.x-hero.width/2),n=(e+1)*tileW;hero.x=n+hero.width/2+1}else-1!=activeDoorX&&startDoorTransition();if(key[1])if(isATerrainCollision(hero.x+hero.width/2,hero.y+hero.height/2)||isATerrainCollision(hero.x+hero.width/2,hero.y-hero.height/2)){var e=getTileX(hero.x+hero.width/2),i=e*tileW;hero.x=i-hero.width/2-1}else-1!=activeDoorX&&startDoorTransition();for(var r=0;r<thisMapData.npcs.length;r++)thisNPC=thisMapData.npcs[r],thisNPC.isCollidable&&isAnObjectCollision(thisNPC.x,thisNPC.y,thisNPC.width,thisNPC.height,hero.x,hero.y,hero.width,hero.height)&&getHeroAsCloseAsPossibleToObject(thisNPC.x,thisNPC.y,thisNPC.width,thisNPC.height);for(var r=0;r<thisMapData.items.length;r++)thisItem=thisMapData.items[r],isAnObjectCollision(thisItem.x,thisItem.y,thisItem.width,thisItem.height,hero.x,hero.y,hero.width,hero.height)&&getHeroAsCloseAsPossibleToObject(thisItem.x,thisItem.y,thisItem.width,thisItem.height)}function gameLoop(){switch(gameMode){case"mapLoading":console.log("loading map assets...");break;case"paused":break;case"play":update(),draw()}window.requestAnimationFrame(gameLoop)}function update(){var e=window.performance.now(),t=e-lastTime;lastTime=e,hero.isMoving=!1,oldHeroX=hero.x,oldHeroY=hero.y;var a=hero.speed;if(key[5]&&(a*=2),"out"!=mapTransition){key[2]?(hero.isMoving=!0,hero.facing="n",hero.y-=a):key[3]?(hero.isMoving=!0,hero.facing="s",hero.y+=a):key[1]?(hero.isMoving=!0,hero.facing="e",hero.x+=a):key[0]&&(hero.isMoving=!0,hero.facing="w",hero.x-=a),key[4]&&checkForActions(),checkHeroCollisions();var n=hero.tileX,i=hero.tileY;hero.tileX=getTileX(hero.x),hero.tileY=getTileY(hero.y),(hero.tileX!=n||hero.tileY!=i)&&heroIsInNewTile(),""!=activeNPCForDialogue&&(isInRange(hero.x,hero.y,activeNPCForDialogue.x,activeNPCForDialogue.y,closeDialogueDistance)||(dialogue.classList.add("slowerFade"),dialogue.classList.remove("active"),dialogue.addEventListener(whichTransitionEvent,function r(e){return activeNPCForDialogue="",e.currentTarget.removeEventListener(whichTransitionEvent,r,!1)},!1)))}else{switch(hero.isMoving=!0,hero.facing){case"n":hero.y-=a;break;case"s":hero.y+=a;break;case"e":hero.x+=a;break;case"w":hero.x-=a}mapTransitionCurrentFrames++,mapTransitionCurrentFrames>=mapTransitionMaxFrames&&changeMaps(activeDoorX,activeDoorY)}"in"==mapTransition&&(mapTransitionCurrentFrames+=2,mapTransitionCurrentFrames>=mapTransitionMaxFrames&&(mapTransition="")),timeSinceLastFrameSwap+=t,timeSinceLastFrameSwap>animationUpdateTime&&(currentAnimationFrame++,timeSinceLastFrameSwap=0,animateFae()),moveNPCs()}function heroIsInNewTile(){updateCartographicMiniMap()}function canAddItemToInventory(e){var t=JSON.parse(JSON.stringify(hero.inventory)),a=0,n=[],i=getObjectKeysForInnerValue(t,e.type,"type");if(i.length>0)for(var r=0;r<i.length;r++)if(itemAttributesMatch(t[i[r]],e)){var o=t[i[r]].quantity,s=maxNumberOfItemsPerSlot-o>e.quantity-a?e.quantity-a:maxNumberOfItemsPerSlot-o;if(a+=s,n.push(i[r]),t[i[r]].quantity+=s,a>=e.quantity)break}if(a<e.quantity)e:for(var r=0;r<hero.bags.length;r++)for(var h=currentActiveInventoryItems[hero.bags[r].type].actionValue,c=0;h>c;c++){var l=r+"-"+c;if(!(l in t)){var s=maxNumberOfItemsPerSlot>e.quantity-a?e.quantity-a:maxNumberOfItemsPerSlot;if(a+=s,n.push(l),t[l]=new Object,t[l].type=e.type,t[l].quantity=s,t[l].quality=e.quality,t[l].durability=e.durability,t[l].currentWear=e.currentWear,t[l].effectiveness=e.effectiveness,t[l].wrapped=e.wrapped,t[l].colour=e.colour,t[l].enchanted=e.enchanted,t[l].hallmark=e.hallmark,t[l].inscription=e.inscription,a>=e.quantity)break e}}return a==e.quantity?(hero.inventory=JSON.parse(JSON.stringify(t)),[!0,n]):[!1]}function itemAttributesMatch(e,t){return e.quality==t.quality&&e.durability==t.durability&&e.currentWear==t.currentWear&&e.effectiveness==t.effectiveness&&e.wrapped==t.wrapped&&e.colour==t.colour&&e.enchanted==t.enchanted&&e.hallmark==t.hallmark&&e.inscription==t.inscription?!0:!1}function checkForActions(){for(var e,t,a,n,i=[],r=0;r<thisMapData.items.length;r++)if(isInRange(hero.x,hero.y,thisMapData.items[r].x,thisMapData.items[r].y,thisMapData.items[r].width/2+hero.width/2+6)&&isFacing(hero,thisMapData.items[r]))switch(currentActiveInventoryItems[itemGraphicsToLoad[r].type].action){case"static":break;default:if(i=canAddItemToInventory(thisMapData.items[r]),i[0]){thisMapData.items.splice(r,1),document.getElementById("slot"+i[1][0]).addEventListener(whichTransitionEvent,function c(e){elementList=document.querySelectorAll("#inventoryPanels .changed");for(var t=0;t<elementList.length;t++)removeClass(elementList[t],"changed");return e.currentTarget.removeEventListener(whichTransitionEvent,c,!1)},!1);for(var o=0;o<i[1].length;o++)t=i[1][o],e='<img src="/images/game-world/inventory-items/'+hero.inventory[t].type+'.png" alt="">',e+='<span class="qty">'+hero.inventory[t].quantity+"</span>",e+="<p><em>"+currentActiveInventoryItems[hero.inventory[t].type].shortname+" </em>"+currentActiveInventoryItems[hero.inventory[t].type].description+' <span class="price">Sell price: '+parseMoney(hero.inventory[t].quantity*currentActiveInventoryItems[hero.inventory[t].type].priceCode,0)+"</span></p>",a=document.getElementById("slot"+t),a.innerHTML=e,addClass(a,"changed")}else alert("no room in the inventory")}for(var r=0;r<thisMapData.npcs.length;r++)if(n=thisMapData.npcs[r],n.speech&&isInRange(hero.x,hero.y,n.x,n.y,n.width+hero.width)&&isFacing(hero,n))if(n.speechIndex>=n.speech.length)n.speechIndex=0,dialogue.classList.remove("active"),activeNPCForDialogue="";else{var s=n.speech[n.speechIndex][0],h=n.speech[n.speechIndex][1];switch(n.drawnFacing=turntoFace(n,hero),h){case"once":n.speech.splice(n.speechIndex,1),UI.showDialogue(n,s);break;default:UI.showDialogue(n,s),n.speechIndex++}}key[4]=0}function moveNPCs(){for(var e,t,a,n,i,r=0;r<thisMapData.npcs.length;r++)if(e=thisMapData.npcs[r],e.isMoving){switch(n=e.x,i=e.y,e.drawnFacing=e.facing,e.facing){case"n":if(e.y-=e.speed,isATerrainCollision(e.x-e.width/2,e.y-e.height/2)||isATerrainCollision(e.x+e.width/2,e.y-e.height/2)){var o=getTileY(e.y-e.height/2),s=(o+1)*tileW;e.y=s+e.height/2+1}break;case"s":if(e.y+=e.speed,isATerrainCollision(e.x-e.width/2,e.y+e.height/2)||isATerrainCollision(e.x+e.width/2,e.y+e.height/2)){var o=getTileY(e.y+e.height/2),h=o*tileW;e.y=h-e.height/2-1}break;case"w":if(e.x-=e.speed,isATerrainCollision(e.x-e.width/2,e.y+e.height/2)||isATerrainCollision(e.x-e.width/2,e.y-e.height/2)){var o=getTileX(e.x-e.width/2),c=(o+1)*tileW;e.x=c+e.width/2+1}break;case"e":if(e.x+=e.speed,isATerrainCollision(e.x+e.width/2,e.y+e.height/2)||isATerrainCollision(e.x+e.width/2,e.y-e.height/2)){var o=getTileX(e.x+e.width/2),l=o*tileW;e.x=l-e.width/2-1}}isAnObjectCollision(e.x,e.y,e.width,e.height,hero.x,hero.y,hero.width,hero.height)&&(e.x=n,e.y=i);for(var g=0;g<thisMapData.npcs.length;g++)r!=g&&(thisOtherNPC=thisMapData.npcs[g],thisOtherNPC.isCollidable&&isAnObjectCollision(e.x,e.y,e.width,e.height,thisOtherNPC.x,thisOtherNPC.y,thisOtherNPC.width,thisOtherNPC.height)&&(e.x=n,e.y=i));for(var r=0;r<thisMapData.items.length;r++)thisItem=thisMapData.items[r],isAnObjectCollision(e.x,e.y,e.width,e.height,thisItem.x,thisItem.y,thisItem.width,thisItem.height)&&(e.x=n,e.y=i);if(e.dx+=e.x-n,e.dy+=e.y-i,t=!1,Math.abs(e.dx)>=tileW&&(e.dx>0?e.dx-=tileW:e.dx+=tileW,t=!0),Math.abs(e.dy)>=tileW&&(e.dy>0?e.dy-=tileW:e.dy+=tileW,t=!0),t)switch(e.movementIndex++,e.movementIndex>=e.movement.length&&(e.movementIndex=0),a=e.movement[e.movementIndex]){case"-":e.isMoving=!1;case"?":do e.facing=facingsPossible[Math.floor(Math.random()*facingsPossible.length)];while(isATerrainCollision(e.x+relativeFacing[e.facing].x*tileW,e.y+relativeFacing[e.facing].y*tileW));break;default:e.facing=a}}}function animateFae(){fae.z=Math.floor(8*(Math.sin(fae.dz)+1)+40),fae.dz+=.2;for(var e=0;e<fae.particles.length;e++)fae.particles[e].alpha-=.1,fae.particles[e].alpha<=0&&fae.particles.splice(e,1);if(fae.particles.length<fae.maxParticles&&1==getRandomInteger(1,4)){var t=findIsoCoordsX(fae.x,fae.y),a=findIsoCoordsY(fae.x,fae.y)-fae.z,n=t+getRandomInteger(0,8)-4,i=a+getRandomInteger(0,8)-4;isInRange(t,a,n,i,6)&&fae.particles.push({depth:findIsoCoordsY(fae.x,fae.y),isoX:n,isoY:i,alpha:1})}}function draw(){if("mapLoading"==gameMode)gameContext.fillRect(0,0,canvasWidth,canvasHeight),gameContext.fillStyle="black",gameContext.fill();else{var e,t,a,n,i,r;hero.isox=findIsoCoordsX(hero.x,hero.y),hero.isoy=findIsoCoordsY(hero.x,hero.y);var o=[[hero.isoy,"img",heroImg,Math.floor(canvasWidth/2-hero.feetOffsetX),Math.floor(canvasHeight/2-hero.feetOffsetY)]];a=findIsoCoordsX(fae.x,fae.y),n=findIsoCoordsY(fae.x,fae.y),o.push([n,"faeCentre",Math.floor(a-hero.isox+canvasWidth/2),Math.floor(n-hero.isoy+canvasHeight/2-fae.z)]);for(var s=0;s<fae.particles.length;s++)o.push([fae.particles[s].depth,"faeParticle",Math.floor(fae.particles[s].isoX-hero.isox+canvasWidth/2),Math.floor(fae.particles[s].isoY-hero.isoy+canvasHeight/2),fae.particles[s].alpha]);for(var h=thisMapData.terrain,c=0,l=0,s=0;mapTilesX>s;s++)for(var g=0;mapTilesY>g;g++)"*"!=h[g][s]&&(a=getTileIsoCentreCoordX(s,g),n=getTileIsoCentreCoordY(s,g),e=thisMapData.graphics[h[g][s]].centreX,t=thisMapData.graphics[h[g][s]].centreY,o.push([n,"img",tileImages[h[g][s]],Math.floor(a-hero.isox-e+canvasWidth/2),Math.floor(n-hero.isoy-t+canvasHeight/2)]));for(var s=0;s<thisMapData.npcs.length;s++)i=thisMapData.npcs[s],c=currentAnimationFrame%i.animation.walk.length,l=i.animation.walk[i.drawnFacing],a=findIsoCoordsX(i.x,i.y),n=findIsoCoordsY(i.x,i.y),o.push([n,"sprite",npcImages[s],c*i.spriteWidth,l*i.spriteHeight,i.spriteWidth,i.spriteHeight,Math.floor(a-hero.isox-i.centreX+canvasWidth/2),Math.floor(n-hero.isoy-i.centreY+canvasHeight/2),i.spriteWidth,i.spriteHeight]);for(var s=0;s<thisMapData.items.length;s++)r=thisMapData.items[s],a=findIsoCoordsX(r.x,r.y),n=findIsoCoordsY(r.x,r.y),o.push([n,"img",itemImages[s],Math.floor(a-hero.isox-r.centreX+canvasWidth/2),Math.floor(n-hero.isoy-r.centreY+canvasHeight/2)]);o.sort(sortByIsoDepth),gameContext.drawImage(backgroundImg,Math.floor(getTileIsoCentreCoordX(0,mapTilesX-1)-hero.isox-tileW/2),Math.floor(getTileIsoCentreCoordY(0,0)-hero.isoy-tileH/2));for(var s=0;s<o.length;s++)switch(o[s][1]){case"faeCentre":drawCircle("#ffdc0c",o[s][2],o[s][3],2),drawCircle("rgba(255,220,255,0.3)",o[s][2],o[s][3],4),gameContext.fillStyle="rgba(0,0,0,"+.01*(65-fae.z)+")",gameContext.beginPath(),gameContext.ellipse(o[s][2]-getXOffsetFromHeight(fae.z),o[s][3]+fae.z,3,1,0,0,2*Math.PI),gameContext.fill();break;case"faeParticle":gameContext.fillStyle="rgba(255,220,255,"+o[s][4]+")",gameContext.fillRect(o[s][2],o[s][3],1,1);break;case"sprite":gameContext.drawImage(o[s][2],o[s][3],o[s][4],o[s][5],o[s][6],o[s][7],o[s][8],o[s][9],o[s][10]);break;case"img":gameContext.drawImage(o[s][2],o[s][3],o[s][4])}if(""!=activeNPCForDialogue&&UI.updateDialogue(activeNPCForDialogue),"out"==mapTransition){var m=1-mapTransitionCurrentFrames/mapTransitionMaxFrames,p=gameContext.createRadialGradient(canvasWidth/2,canvasHeight/2,m*canvasWidth/2,canvasWidth/2,canvasHeight/2,0);p.addColorStop(0,"rgba(0,0,0,1)"),p.addColorStop(1,"rgba(0,0,0,0)"),gameContext.fillStyle=p,gameContext.fillRect(0,0,canvasWidth,canvasHeight)}else if("in"==mapTransition){var m=mapTransitionCurrentFrames/mapTransitionMaxFrames,p=gameContext.createRadialGradient(canvasWidth/2,canvasHeight/2,m*canvasWidth/2,canvasWidth/2,canvasHeight/2,0);p.addColorStop(0,"rgba(0,0,0,1)"),p.addColorStop(1,"rgba(0,0,0,0)"),gameContext.fillStyle=p,gameContext.fillRect(0,0,canvasWidth,canvasHeight)}}}colourNames=["","Crimson","Yellow","Orange","Blue","Purple","Green","Brown","White","Pink","(light yellow/cream)","(light orange/coral)","Aquamarine","Violet","(light green/lime)","Tawny","Black","Ruby/Maroon","(dark yellow/amber)","(dark orange/sienna)","(dark blue/sapphire)","(indigo/imperial purple)","(dark green/emerald/olive)","(dark brown/chestnut)","Grey"];var animationFramesPerSecond=16,lastTime=0,elapsed=0,timeSinceLastFrameSwap=0,currentAnimationFrame=0,animationUpdateTime=1e3/animationFramesPerSecond,titleTagPrefix="Autumn Earth",mapTransition="",mapTransitionCurrentFrames=1,mapTransitionMaxFrames=60,activeDoorX=-1,activeDoorY=-1,characterId=999,currentMap=0,newMap=0,thisMapData="",mapTilesX=0,mapTilesY=0,tileGraphics=[],tileW=48,tileH=tileW/2,tileGraphicsToLoad=0,npcGraphicsToLoad=0,itemGraphicsToLoad=0,canvasWidth=800,canvasHeight=600,randomDungeonName="",randomDungeons=["","the-barrow-mines"],previousZoneName="",currentActiveInventoryItems=[],maxNumberOfItemsPerSlot=20,inventoryInterfaceIsBuilt=!1,whichTransitionEvent="",activeNPCForDialogue="",closeDialogueDistance=200,key=[0,0,0,0,0],hero={x:0,y:0,dx:0,dy:0,width:20,height:20,feetOffsetX:40,feetOffsetY:69,speed:4,isMoving:!1,facing:"s",sequences:{"stand-s":[3],"stand-n":[10],"stand-w":[17],"stand-e":[24],"walk-s":[3,4,5,6,5,4,3,2,1,0,1,2],"walk-n":[10,11,12,13,12,11,10,9,8,7,8,9],"walk-w":[17,18,19,20,19,18,17,16,15,14,15,16],"walk-e":[24,25,26,27,26,25,24,23,22,21,22,23]}},fae={particles:[],maxParticles:10},facingsPossible=["n","e","s","w"],relativeFacing={n:{x:0,y:-1},s:{x:0,y:1},e:{x:1,y:0},w:{x:-1,y:0}};!function(){for(var e=0,t=["ms","moz","webkit","o"],a=0;a<t.length&&!window.requestAnimationFrame;++a)window.requestAnimationFrame=window[t[a]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[a]+"CancelAnimationFrame"]||window[t[a]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,a){var n=(new Date).getTime(),i=Math.max(0,16-(n-e)),r=window.setTimeout(function(){t(n+i)},i);return e=n+i,r}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}();var getJSON=function(e,t,a){var n="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");n.open("get",e,!0),n.onreadystatechange=function(){var e,i;if(4==n.readyState){e=n.status;var r=!0;if(200==e){try{i=JSON.parse(n.responseText)}catch(o){r=!1,a&&a(e)}r&&t&&t(i)}else a&&a(e)}},n.send()};window.Loader=function(){function e(){c=0,l=!1,g=0,m={}}function t(){}function a(){}function n(e){++c,t(h()),c==g&&(l=!1,a())}function i(e){console.log("Error on loading the image: "+e.srcElement)}function r(e,t){try{m[e]=new Image,m[e].onload=function(){n(e)},m[e].onerror=i,m[e].src=t}catch(a){console.log(a.message)}}function o(e){return m[e]?m[e]:void 0}function s(n,i,o){if(e(),!l){l=!0;try{g=n.length,t=o||function(){},a=i||function(){};for(var s=0;s<n.length;++s)r(n[s].name,n[s].src)}catch(h){console.log(h.message)}}}function h(){return c/g*100}var c=0,l=!1,g=0,m={};return{preload:s,getProgress:h,getImage:o,reset:e,images:m}}();var Input={init:function(){document.addEventListener("keydown",function(e){Input.changeKey(e.keyCode,1,"down")}),document.addEventListener("keyup",function(e){Input.changeKey(e.keyCode,0,"up")})},changeKey:function(e,t,a){switch(e){case KeyBindings.left:key[0]=t;break;case KeyBindings.up:key[2]=t;break;case KeyBindings.right:key[1]=t;break;case KeyBindings.down:key[3]=t;break;case KeyBindings.action:key[4]=0,"up"===a&&(key[4]=1);break;case KeyBindings.run:key[5]=t}}},KeyBindings={left:37,right:39,up:38,down:40,pause:80,action:17,run:16},UI={init:function(){document.getElementById("displayZoneName"),document.getElementById("activeCartographicMap"),document.getElementById("cartographicTitle"),document.getElementById("dialogue")},showZoneName:function(e){displayZoneName.classList.remove("active"),displayZoneName.textContent=e,void displayZoneName.offsetWidth,displayZoneName.classList.add("active")},buildInventoryInterface:function(){for(var e,t,a,n="",i=0;i<hero.bags.length;i++){n+='<div class="inventoryBag"><div class="draggableBar">'+currentActiveInventoryItems[hero.bags[i].type].shortname+'</div><ol class="active" id="bag'+i+'">';for(var r=currentActiveInventoryItems[hero.bags[i].type].actionValue,o=0;r>o;o++){var s=i+"-"+o;n+='<li id="slot'+s+'">',s in hero.inventory?(t="",a="",e=getColourName(hero.inventory[s].colour,hero.inventory[s].type),""!=e&&(t=e+" ",a="-"+e.toLowerCase()),n+='<img src="/images/game-world/inventory-items/'+hero.inventory[s].type+a+'.png" alt="">',n+='<span class="qty">'+hero.inventory[s].quantity+"</span>",n+="<p><em>"+t+currentActiveInventoryItems[hero.inventory[s].type].shortname+" </em>"+currentActiveInventoryItems[hero.inventory[s].type].description+' <span class="price">Sell price: '+parseMoney(hero.inventory[s].quantity*currentActiveInventoryItems[hero.inventory[s].type].priceCode,0)+"</span></p>"):n+='<img alt="Empty slot" src="/images/game-world/inventory-items/blank.png">',n+="</li>"}n+="</ol></div></div>"}document.getElementById("inventoryPanels").innerHTML=n,UI.initDrag(".draggableBar"),inventoryInterfaceIsBuilt=!0},handleDrag:function(e){UI.inDrag&&(UI.activeDragObject.style.cssText="z-index:2;left: "+(objInitLeft+e.pageX-dragStartX)+"px; top: "+(objInitTop+e.pageY-dragStartY)+"px")},endDrag:function(e){UI.inDrag=!1,document.removeEventListener("mousemove",UI.handleDrag,!1),document.removeEventListener("mouseup",UI.endDrag,!1),UI.activeDragObject=""},initDrag:function(e){var t=document.querySelectorAll(e);for(i=0;i<t.length;i++)t[i].addEventListener("mousedown",function(a){UI.activeDragObject=this.parentElement,UI.inDrag=!0,objInitLeft=UI.activeDragObject.offsetLeft,objInitTop=UI.activeDragObject.offsetTop,dragStartX=a.pageX,dragStartY=a.pageY,document.addEventListener("mousemove",UI.handleDrag,!1),document.addEventListener("mouseup",UI.endDrag,!1);var n=document.querySelectorAll(e);for(j=0;j<n.length;j++)t[j].parentElement.style.zIndex=1},!1)},showDialogue:function(e,t){dialogue.innerHTML=t,dialogue.classList.remove("slowerFade"),dialogue.classList.add("active"),activeNPCForDialogue=e,UI.updateDialogue(activeNPCForDialogue)},updateDialogue:function(e){var t=findIsoCoordsX(e.x,e.y),a=findIsoCoordsY(e.x,e.y),n="translate("+Math.floor(t-hero.isox+canvasWidth/2-40)+"px,"+Math.floor(0-(canvasHeight-(a-hero.isoy-e.centreY+canvasHeight/2)+40))+"px)";dialogue.style.transform=n}};"serviceWorker"in navigator&&navigator.serviceWorker.register("/game-world/serviceWorker.min.js",{scope:"/game-world/"}),"querySelectorAll"in document&&"addEventListener"in window&&window.HTMLCanvasElement&&init();