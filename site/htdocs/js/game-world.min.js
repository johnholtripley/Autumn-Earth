"use strict";var soundGainNode,audioContext=null,soundEffects={},soundsToLoad={coins:"../sounds/coins-NOT_MINE-wow.mp3",bookOpen:"../sounds/book-open-NOT_MINE-wow.mp3",chestOpen:"../sounds/chest-open-NOT_MINE-wow.mp3",bagOpen:"../sounds/bag-open-NOT_MINE-wow.mp3",buttonClick:"../sounds/button-press-NOT_MINE-wow.mp3",hen:"../sounds/hen-NOT_MINE.mp3",horse:"../sounds/horse-NOT_MINE.mp3",doe:"../sounds/doe-NOT_MINE.mp3",lever:"../sounds/lever-NOT_MINE.mp3",keys:"../sounds/keys-NOT_MINE-wow.mp3",unlock:"../sounds/unlock-NOT_MINE-wow.mp3",gather1:"../sounds/gather-herb-NOT_MINE-wow.mp3",gather4:"../sounds/mining-NOT_MINE-wow.mp3",rain:"../sounds/rain-NOT_MINE-youtube.mp3",questComplete:"../sounds/quest-complete-NOT_MINE-wow.mp3",dyeing:"../sounds/dyeing-NOT_MINE-wow.mp3",weaving:"../sounds/tailoring-NOT_MINE.mp3",pouring:"../sounds/pour-water-NOT_MINE.mp3",digging:"../sounds/digging-NOT_MINE.mp3",cardCraft:"../sounds/craft-card-NOT_MINE-hearthstone.mp3",foundChest:"../sounds/found-treasure-NOT_MINE-wow.mp3",splash:"../sounds/water-splash-NOT_MINE-fesliyanstudios.mp3",whistle:"../sounds/whistle-NOT_MINE-wow.mp3","Small hawk":"../sounds/hawk-NOT_MINE-wow.mp3"},loadAudioBuffer=function(e,t){var a=new XMLHttpRequest;a.open("GET",e,!0),a.responseType="arraybuffer",a.onload=function(){audioContext.decodeAudioData(a.response,function(a){a?soundEffects[t]=a:console.log("error decoding file data: "+e)},function(e){console.log("decodeAudioData error",e)})},a.onerror=function(){console.log("audio XHR error")},a.send()},audio={lastTrack:"",playingHourChime:!1,init:function(){try{for(var e in window.AudioContext=window.AudioContext||window.webkitAudioContext,audioContext=new AudioContext,(soundGainNode=audioContext.createGain()).connect(audioContext.destination),soundsToLoad)loadAudioBuffer(soundsToLoad[e],e)}catch(e){}},initMusic:function(e){audio[e]=new Audio,audio[e].id=e;var t=document.createElement("source");t.type="audio/mpeg",t.src="/music/game-world/"+e+".mp3",audio[e].appendChild(t),audio[e+"Gain"]=audioContext.createGain(),audio[e+"Source"]=audioContext.createMediaElementSource(audio[e]),audio[e+"Source"].connect(audio[e+"Gain"]),audio[e+"Gain"].connect(audioContext.destination),audio[e].addEventListener("ended",audio.removeMusic,!1)},removeMusic:function(e){var t=e.target.id;audio[t].removeEventListener("ended",audio.removeMusic,!1),delete audio[t],delete audio[t+"Source"],delete audio[t+"Gain"],audio.activeTrack==t&&(audio.activeTrack=void 0)},playSound:function(e,t,a,i){void 0===a&&(a=0);var n=audioContext.createBufferSource();if(n.buffer=e,n.numberToPlay=a,void 0!==i){var o=audioContext.createGain();o.gain.value=i/gameSettings.soundVolume,o.connect(audioContext.destination),n.connect(o)}else n.connect(soundGainNode);a>1&&n.addEventListener("ended",function e(t){return this.numberToPlay>1&&audio.playSound(this.buffer,0,this.numberToPlay-1),t.currentTarget.removeEventListener("ended",e,!1)},!1),n.start?n.start(t):n.start=n.noteOn},playMusic:function(e){if(void 0!==audio.activeTrack){if(audio.activeTrack!=e){audio.initMusic(e);var t=audioContext.currentTime;audio[audio.activeTrack+"Gain"].gain.linearRampToValueAtTime(gameSettings.musicVolume,t),audio[audio.activeTrack+"Gain"].gain.linearRampToValueAtTime(0,t+6),audio[e+"Gain"].gain.linearRampToValueAtTime(0,0),audio[e+"Gain"].gain.linearRampToValueAtTime(gameSettings.musicVolume,6),audio[e].play(),audio.activeTrack=e,audio.lastTrack=e}}else e!=audio.lastTrack&&(audio.initMusic(e),audio[e].play(),audio.activeTrack=e,audio.lastTrack=e,audio[audio.activeTrack+"Gain"].gain.setValueAtTime(gameSettings.musicVolume,audioContext.currentTime))},fadeOutMusic:function(e,t){if(void 0!==typeof audio[e]){var a=audioContext.currentTime;audio[e+"Gain"].gain.linearRampToValueAtTime(gameSettings.musicVolume,a),audio[e+"Gain"].gain.linearRampToValueAtTime(0,a+t),audio[e].removeEventListener("ended",audio.removeMusic,!1),audio.lastTrack="",audio.activeTrack=void 0,delete audio[e],delete audio[e+"Source"],delete audio[e+"Gain"]}},adjustEffectsVolume:function(){gameSettings.soundVolume=soundVolume.value,void 0!==soundGainNode&&soundGainNode.gain.setValueAtTime(gameSettings.soundVolume,0)},adjustMusicVolume:function(){gameSettings.musicVolume=musicVolume.value,void 0!==audio.activeTrack&&audio[audio.activeTrack+"Gain"].gain.setValueAtTime(gameSettings.musicVolume,audioContext.currentTime)},loadAmbientSounds:function(e){for(var t in e)loadAudioBuffer(e[t],t)},checkForAmbientSounds:function(){for(var e=[],t=0;t<visibleMaps.length;t++)if(thisMapData[visibleMaps[t]].ambientSounds)for(var a in thisMapData[visibleMaps[t]].ambientSounds)a in e||(e[a]=thisMapData[visibleMaps[t]].ambientSounds[a]);hero.totalGameTimePlayed-timeSinceLastAmbientSoundWasPlayed>minTimeBetweenAmbientSounds&&1==getRandomIntegerInclusive(1,240)&&(timeSinceLastAmbientSoundWasPlayed=hero.totalGameTimePlayed,audio.playSound(soundEffects[getRandomKeyFromObject(e)],0));for(t=0;t<visibleMaps.length;t++)if(thisMapData[visibleMaps[t]].hourChime){var i=new Date;i.getMinutes()<1?audio.playingHourChime||(audio.playingHourChime=!0,audio.playSound(soundEffects.hourChime,0,keepWithinRange(i.getHours(),1,12))):audio.playingHourChime=!1}}},cartography={innerRadius:0,outerRadius:35,isLoading:!1,coordinateCentreTileE:50,coordinateCentreTileN:50,init:function(){cartography.cartographyUnits=246/(mapTilesX*tileW),cartography.newCartographicMap(),cartography.worldHeightInTiles=worldMapTileLength*worldMap.length,isOverWorldMap&&cartography.updateCoordinates()},newCartographicMap:function(){cartography.isLoading=!0,canvasMapImage.src="/game-world/generateCartographicMap.php?playerId="+characterId+"&dungeonName="+randomDungeonName+"&plotChests=true&requestedMap="+currentMap,canvasMapImage.onload=function(){canvasMapMaskImage.src="/game-world/getCartographicMapMask.php?chr="+characterId+"&dungeonName="+randomDungeonName+"&currentMap="+currentMap+"&cache="+Date.now(),canvasMapMaskImage.setAttribute("crossorigin","anonymous"),canvasMapMaskImage.onload=function(){offScreenCartographyContext.clearRect(0,0,246,246),offScreenCartographyContext.drawImage(canvasMapMaskImage,0,0),cartography.isLoading=!1,cartography.updateCartographicMiniMap()}}},updateCartographicMiniMap:function(){if(!cartography.isLoading){if(isOverWorldMap)var e=hero.x%worldMapWidthPx*cartography.cartographyUnits,t=hero.y%worldMapWidthPx*cartography.cartographyUnits;else e=hero.x*cartography.cartographyUnits,t=hero.y*cartography.cartographyUnits;var a=offScreenCartographyContext.createRadialGradient(e,t,cartography.innerRadius,e,t,cartography.outerRadius);a.addColorStop(0,"rgb(255,255,255)"),a.addColorStop(1,"rgba(255,255,255,0)"),offScreenCartographyContext.arc(e,t,cartography.outerRadius,0,2*Math.PI),offScreenCartographyContext.fillStyle=a,offScreenCartographyContext.fill(),cartographyContext.clearRect(0,0,246,246),cartographyContext.globalCompositeOperation="copy",cartographyContext.drawImage(offScreenCartographyCanvas,0,0),cartographyContext.globalCompositeOperation="source-atop",cartographyContext.drawImage(canvasMapImage,0,0)}},saveCartographyMask:function(){var e=offScreenCartographyCanvas.toDataURL();postData("/game-world/saveCartographicMapMask.php","chr="+characterId+"&dungeonName="+randomDungeonName+"&currentMap="+currentMap+"&data="+e)},updateCoordinates:function(){var e=((hero.tileX-cartography.coordinateCentreTileE)/worldMapTileLength).toFixed(2).toString().split("."),t=((cartography.worldHeightInTiles-hero.tileY-cartography.coordinateCentreTileN)/worldMapTileLength).toFixed(2).toString().split(".");cartographyCoordinates.innerHTML=e[0]+"&deg; "+e[1]+"&rsquo; E, "+t[0]+"&deg; "+t[1]+"&rsquo;  N"}};function getColourName(e,t){var a="";return void 0!==e&&1!=currentActiveInventoryItems[t].hasInherentColour&&(a=colourNames[e]),a}function mixColours(e){for(var t=0,a=0,i=0,n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],o=0;o<e.length;o++)n[e[o]]++,t|=e[o],e[o]==(16|e[o])&&a++,e[o]==(8|e[o])&&i++;for(o=0;o<n.length;o++)if(n[o]/e.length>.7){t=o;break}return t>24&&(t-=a>i?8:a<i?16:24),t}const animationFramesPerSecond=16;var lastTime=0,elapsed=0,timeSinceLastFrameSwap=0,currentAnimationFrame=0;const animationUpdateTime=62.5;var gameCanvas,gameContext,reflectedCanvas,reflectionContext,waterCanvas,waterContext,gameMode,cartographyContext,cartographyCanvas,offScreenCartographyCanvas,offScreenCartographyContext,canvasMapImage,canvasMapMaskImage,heroImg,shadowImg,tilledEarth,tileMask,addedWater,ocean,oceanSpriteWidth,oceanSpriteHeight,oceanCanvas,oceanContext,imagesToLoad,objInitLeft,objInitTop,dragStartX,dragStartY,inventoryCheck,timeSinceLastAmbientSoundWasPlayed,gameSettings,lightMap,lightMapOverlay,lightMapContext,activeGatheredObject,questResponseNPC,cursorPositionX,cursorPositionY,whichVisibleMap,allRecipes,availableScreenWidth,availableScreenHeight,housingData,inventorySlotReference,chestIdOpen=-1,currentWeather="",outsideWeather="",allPossibleWeather=[""],weatherLastChangedTime=0;const minTimeBetweenWeatherChanges=5e3;var tileImages=[],npcImages=[],itemImages=[],backgroundImgs=[],oceanNumberOfFrames=29,oceanCurrentFrame=0,amountForTheNextBankSlot=5e5,maximumBankSlotsPossible=28,interfaceIsVisible=!0,activeAction="",dowsing={},gathering={},surveying={},plotPlacement={},postObject={active:!1},bankObject={active:!1},retinueObject={active:!1},craftingObject={},retinueBaseLocationX=200,retinueBaseLocationY=350;const costToRehireFollower=11e4;var jumpMapId=null;const titleTagPrefix="Autumn Earth";var mapTransition="",mapTransitionCurrentFrames=1;const mapTransitionMaxFrames=60;var activeDoorX=-1,activeDoorY=-1;const characterId=999;var currentMap=0,newMap=0,thisMapData={},mapTilesX=0,mapTilesY=0,tileGraphics=[];const tileW=48,tileH=tileW/2;var tileGraphicsToLoad=0,npcGraphicsToLoad=0,itemGraphicsToLoad=0,canvasWidth=800,canvasHeight=600,randomDungeonName="",randomDungeons=["","the-dwarrow-mines","the-barrow-mines"],previousZoneName="",currentActiveInventoryItems={},maxNumberOfItemsPerSlot=20,isSplitStackBeingDragged=!1,possibleTitles=[],inventoryInterfaceIsBuilt=!1,whichTransitionEvent="",whichAnimationEvent="",activeObjectForDialogue="";const closeDialogueDistance=200;var thisChallengeNPC,canCloseDialogueBalloonNextClick=!1,thisSpeech="",boosterCardsRevealed=0,boosterCardsToAdd=[],questData=[],hasActivePet=!1;const breadCrumbLength=16;var activePetImages=[];const minTimeBetweenAmbientSounds=1200;var colourNames=[],detailedRecipeData=[],currentRecipePanelProfession=-1,currentItemGroupFilters="",thisMapShopItemIds="",shopCurrentlyOpen=-1,workshopTimers=[],workshopObject={workshopCurrentlyOpen:-1};const inflationModifier=10,sellPriceModifier=.7,sellPriceSpecialismModifier=.8,buyPriceSpecialismModifier=.9,baseGatheringTime=5e3,gatheringStabilityModifier=.002,gatheringDepletionModifier=2e3,dowsingRingSize=100,baseDowsingRange=10,baseSurveyingTime=1e3,surveyingDepletionModifier=500,facingsPossible=["n","e","s","w"];var key=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],hero={x:0,y:0,z:0,dx:0,dy:0,breadcrumb:[],width:20,length:20,centreX:51,centreY:68,speed:4,spriteWidth:83,spriteHeight:88,isMoving:!1,facing:"s",terrain:"earth",currentAnimation:"idle",animation:{walk:{length:19,"start-row":0,n:0,e:1,s:2,w:3},run:{length:11,"start-row":4,n:0,e:1,s:2,w:3},idle:{length:31,"start-row":8,n:0,e:1,s:2,w:3},music:{length:18,"start-row":12,n:0,e:1,s:2,w:3}}},fae={particles:[],maxParticles:18,radiusAroundHero:35,angleAroundHero:0,targetX:0,targetY:0,currentState:"hero",abandonRadius:500,zOffset:40,oscillateOffset:0},isOverWorldMap=!0,worldMap=[],visibleMaps=[];const worldMapWidthPx=2400,worldMapHeightPx=1200,worldMapTileLength=50;var visibleMapsLoading=[];function recipeSearchAndFilter(){var e=hero.crafting[currentRecipePanelProfession].sortOrder;if(""!=recipeSearch.value){var t=recipeSearch.value.toLowerCase();for(var a in e=[],hero.crafting[currentRecipePanelProfession].recipes)-1!=hero.crafting[currentRecipePanelProfession].recipes[a].recipeName.toLowerCase().indexOf(t)?e.push(a):-1!=hero.crafting[currentRecipePanelProfession].recipes[a].recipeDescription.toLowerCase().indexOf(t)&&e.push(a)}var i,n=document.querySelectorAll("#createRecipeList li");for(i=0;i<n.length;++i)n[i].classList.remove("active");var o=0,r=recipeFilter.value.split(",");for(i=0;i<e.length;i++)-1!=r.indexOf(e[i].toString())&&(document.getElementById("recipe"+e[i]).classList.add("active"),o++);0==o&&document.getElementById("noRecipesFound").classList.add("active"),""!=UI.highlightedRecipe&&(document.getElementById(UI.highlightedRecipe).classList.contains("active")||(document.getElementById(UI.highlightedRecipe).classList.remove("highlighted"),craftingRecipeCreateButton.disabled=!0,UI.highlightedRecipe="")),thisDevicesScrollBarWidth>0&&recipeCustomScrollBar.init()}function recipeSearchInput(){""!=recipeSearch.value?clearRecipeSearch.classList.add("active"):clearRecipeSearch.classList.remove("active"),recipeSearchAndFilter()}function recipeSearchClear(){recipeSearch.value="",clearRecipeSearch.classList.remove("active"),recipeSearchAndFilter()}function recipeSelectComponents(e,t){var a;releaseLockedSlots(),craftingTimeBarOuter.style.display="none",startCrafting.style.display="block",startCrafting.disabled=!0,craftingSelectComponentsPanel.classList.add("active"),t?(a=e,startWorkshopCrafting.style.display="block",startCrafting.style.display="none"):(a=e.substring(6),startWorkshopCrafting.style.display="none",startCrafting.style.display="block");var i,n=!1,o="-";if(t)var r=JSON.parse(JSON.stringify(detailedRecipeData[a]));else r=JSON.parse(JSON.stringify(hero.crafting[currentRecipePanelProfession].recipes[a]));craftingObject={componentsAdded:[],whichRecipe:e,thisRecipe:r,recipeId:a,required:[],componentInfluences:[],craftedItem:{type:parseInt(r.creates),quantity:1,quality:0,durability:0,effectiveness:0,currentWear:0,wrapped:0,colour:0,enchanted:0,hallmark:0-characterId,inscription:""},finalItemName:r.recipeName,isCreating:!1,optionalDyeAdded:0},t&&(craftingObject.craftedItem.hallmark=0,craftingObject.whichWorkshop=document.getElementById("workshop"+workshopCurrentlyOpen).getAttribute("data-workshopname"));var s,c,l,h,d="<h4>Requires:</h4><ul>",u="<h4>Available:</h4><ul>",p=0,g='<div id="craftingOutput"><div id="craftingOutputAttributes"></div><img src="/images/game-world/inventory-items/'+r.imageId+'.png" alt="'+r.recipeName+'"></div><h3>'+r.recipeName+"</h3><p>"+r.recipeDescription+"</p>",m={durability:0,effectiveness:0,quality:0},v={durability:0,effectiveness:0,quality:0},f=r.components.length;for(var y in r.components)if(null!=r.components[y].influence)for(var I in r.components[y].influence)v[I]+=r.components[y].influence[I],m[I]++;else r.components[y].influence={durability:void 0,effectiveness:void 0,quality:void 0};for(var y in r.components){if(h=!1,"",c=void 0!==r.components[y].influence.effectiveness?r.components[y].influence.effectiveness:(100-v.effectiveness)/(f-m.effectiveness),s=void 0!==r.components[y].influence.durability?r.components[y].influence.durability:(100-v.durability)/(f-m.durability),l=void 0!==r.components[y].influence.quality?r.components[y].influence.quality:(100-v.quality)/(f-m.quality),craftingObject.componentInfluences[r.components[y].type]={effectiveness:c,durability:s,quality:l},isNaN(r.components[y].type)){if(d+='<li id="componentType'+r.components[y].type+'">'+generateAttributeGraphicMarkup(l,s,c)+'<img class="previewSlot" src="/images/game-world/inventory-items/'+r.components[y].type+'.png" class="planImage" alt=""><p>'+r.components[y].quantity+"x "+currentItemGroupFilters[r.components[y].type]+"</p></li>",i=hasItemTypeInInventory(r.components[y].type),"dye"==r.components[y].type&&(n=!0),i.length>0)for(I=0;I<i.length;I++)u+='<li id="fromSlot'+i[I]+'">'+generateCraftingSlotMarkup(hero.inventory[i[I]])+"</li>",document.getElementById("slot"+i[I]).classList.add("locked"),p++,h=!0}else if(d+='<li id="componentType'+r.components[y].type+'">'+generateAttributeGraphicMarkup(l,s,c)+'<img src="/images/game-world/inventory-items/'+r.components[y].type+'.png" class="planImage" alt="'+currentActiveInventoryItems[r.components[y].type].shortname+'"><p>'+r.components[y].quantity+"x "+currentActiveInventoryItems[r.components[y].type].shortname+"</p></li>",(i=findSlotItemIdInInventory(r.components[y].type)).length>0)for(var I=0;I<i.length;I++)u+='<li id="fromSlot'+i[I]+'">'+generateCraftingSlotMarkup(hero.inventory[i[I]])+"</li>",document.getElementById("slot"+i[I]).classList.add("locked"),p++,h=!0;craftingObject.required.push({type:r.components[y].type,quantity:r.components[y].quantity}),h||(u+='<li class="componentMissing">You\'re missing a component type</li>'),r.components[y].type!=o&&(u+="</ul><ul>"),o=r.components[y].type}if(0==p&&(u+='<li id="noComponentsAvailable"><p>You don\'t have any of the required components for this recipe.</p></li></ul><ul>'),currentActiveInventoryItems[r.creates].dyeable>0&&(d+='<li id="componentTypeAdditionalDye"><img src="/images/game-world/inventory-items/dye.png" alt=""><p>Dye (optional)</p></li>',!n&&(i=hasItemTypeInInventory("dye")).length>0))for(I=0;I<i.length;I++)u+='<li id="fromSlot'+i[I]+'">'+generateCraftingSlotMarkup(hero.inventory[i[I]])+"</li>",document.getElementById("slot"+i[I]).classList.add("locked");d+='<li id="componentTypeAdditionalImbue"><img src="/images/game-world/inventory-items/enchant.png" alt=""><p>Imbue item (optional)</p></li>',d+="</ul>",u+="</ul>",selectComponentsItemBeingCreated.innerHTML=d,componentsAvailableForThisRecipe.innerHTML=u,displayItemBeingCreated.innerHTML=g}function releaseLockedSlots(){for(var e=document.querySelectorAll("#inventoryPanels .locked"),t=0;t<e.length;t++)e[t].classList.remove("locked")}function addCraftingComponents(e,t){for(var a,i,n,o,r,s=e.substring(8),c=!1,l=0;l<craftingObject.required.length;l++)if(r=!1,craftingObject.required[l].type==hero.inventory[s].type||craftingObject.required[l].type==currentActiveInventoryItems[hero.inventory[s].type].group){if(craftingObject.required[l].quantity>0)r=!0;else if(t){for(var h=0,d=-1,u=0;u<craftingObject.componentsAdded.length;u++)craftingObject.componentsAdded[u].type==craftingObject.required[l].type&&(h++,d=u);1==h&&craftingObject.componentsAdded[d].fromSlot!=s&&(document.querySelector("#componentType"+craftingObject.required[l].type+" .addedItemToRecipe").remove(),(i=document.querySelector("#fromSlot"+craftingObject.componentsAdded[d].fromSlot+" .qty")).classList.remove("modified"),i.textContent=hero.inventory[craftingObject.componentsAdded[d].fromSlot].quantity,craftingObject.required[l].quantity=craftingObject.componentsAdded[d].quantity,craftingObject.componentsAdded.splice(d,1),r=!0)}r&&("dye"==currentActiveInventoryItems[hero.inventory[s].type].group&&(c=!0),a=craftingObject.required[l].quantity,craftingObject.required[l].quantity>hero.inventory[s].quantity&&(a=hero.inventory[s].quantity),craftingObject.required[l].quantity-=a,craftingObject.componentsAdded.push({fromSlot:s,quantity:a,type:craftingObject.required[l].type}),(i=document.querySelector("#"+e+" .qty")).classList.add("modified"),i.textContent=hero.inventory[s].quantity-a,(n=document.getElementById("componentType"+hero.inventory[s].type))||(n=document.getElementById("componentType"+currentActiveInventoryItems[hero.inventory[s].type].group)),n&&((o=JSON.parse(JSON.stringify(hero.inventory[s]))).quantity=a,n.innerHTML+='<div class="addedItemToRecipe">'+generateCraftingSlotMarkup(o)+"</div>"))}"dye"==currentActiveInventoryItems[hero.inventory[s].type].group&&(c||(craftingObject.componentsAdded.push({fromSlot:s,quantity:1,type:"dye"}),(i=document.querySelector("#"+e+" .qty")).classList.add("modified"),i.textContent=hero.inventory[s].quantity-1,(o=JSON.parse(JSON.stringify(hero.inventory[s]))).quantity=1,document.getElementById("componentTypeAdditionalDye").innerHTML+='<div class="addedItemToRecipe">'+generateCraftingSlotMarkup(o)+"</div>",craftingObject.optionalDyeAdded++));var p=!0;for(l=0;l<craftingObject.required.length;l++)craftingObject.required[l].quantity>0&&(p=!1);if(p){if(craftingObject.optionalDyeAdded>0){for(var l in craftingObject.componentInfluences)craftingObject.componentInfluences[l].durability*=.9,craftingObject.componentInfluences[l].effectiveness*=.9,craftingObject.componentInfluences[l].quality*=.9;var g=0,m=0,v=0,f=0;for(var l in craftingObject.componentsAdded)"dye"==craftingObject.componentsAdded[l].type&&(g++,m+=hero.inventory[craftingObject.componentsAdded[l].fromSlot].quality,v+=hero.inventory[craftingObject.componentsAdded[l].fromSlot].durability,f+=hero.inventory[craftingObject.componentsAdded[l].fromSlot].effectiveness);m*=.1/g,v*=.1/g,f*=.1/g,craftingObject.componentInfluences.dye={effectiveness:f,durability:v,quality:m}}var y,I=[];for(l=0;l<craftingObject.componentsAdded.length;l++)y=craftingObject.componentsAdded[l].type,craftingObject.craftedItem.quality+=determineAttributeValue(hero.inventory[craftingObject.componentsAdded[l].fromSlot].quality,craftingObject.componentInfluences[y].quality),craftingObject.craftedItem.durability+=determineAttributeValue(hero.inventory[craftingObject.componentsAdded[l].fromSlot].durability,craftingObject.componentInfluences[y].durability),craftingObject.craftedItem.effectiveness+=determineAttributeValue(hero.inventory[craftingObject.componentsAdded[l].fromSlot].effectiveness,craftingObject.componentInfluences[y].effectiveness),0!=hero.inventory[craftingObject.componentsAdded[l].fromSlot].colour&&I.push(hero.inventory[craftingObject.componentsAdded[l].fromSlot].colour);if(craftingObject.craftedItem.quality=Math.floor(craftingObject.craftedItem.quality),craftingObject.craftedItem.durability=Math.floor(craftingObject.craftedItem.durability),craftingObject.craftedItem.effectiveness=Math.floor(craftingObject.craftedItem.effectiveness),document.getElementById("craftingOutputAttributes").innerHTML=generateAttributeGraphicMarkup(craftingObject.craftedItem.quality,craftingObject.craftedItem.durability,craftingObject.craftedItem.effectiveness),craftingObject.craftedItem.colour=mixColours(I),craftingObject.craftedItem.colour!=craftingObject.thisRecipe.defaultColour){var b=getColourName(craftingObject.craftedItem.colour,craftingObject.craftedItem.type);document.querySelector("#craftingOutput img").src="/images/game-world/inventory-items/"+craftingObject.craftedItem.type+"-"+b.toLowerCase()+".png",craftingObject.finalItemName=b+" "+currentActiveInventoryItems[craftingObject.craftedItem.type].shortname,document.querySelector("#displayItemBeingCreated h3").innerText=craftingObject.finalItemName,craftingObject.finalImageSrc=craftingObject.craftedItem.type+"-"+b.toLowerCase()}else document.querySelector("#displayItemBeingCreated h3").innerText=craftingObject.thisRecipe.recipeName,document.querySelector("#craftingOutput img").src="/images/game-world/inventory-items/"+craftingObject.thisRecipe.imageId+".png",craftingObject.finalImageSrc=craftingObject.thisRecipe.imageId;startCrafting.disabled=!1,startWorkshopCrafting.disabled=!1}else startCrafting.disabled=!0,startWorkshopCrafting.disabled=!0,document.getElementById("craftingOutputAttributes").innerHTML="",document.querySelector("#displayItemBeingCreated h3").innerText=craftingObject.thisRecipe.recipeName,document.querySelector("#craftingOutput img").src="/images/game-world/inventory-items/"+craftingObject.thisRecipe.imageId+".png"}function startCraftingTimer(){craftingObject.timeRemaining=100,craftingObject.depletionSpeed=.5,craftingObject.isCreating=!0,UI.updateCraftingPanel(),craftingTimeBarOuter.style.display="block",startCrafting.style.display="none",audio.playSound(soundEffects[hero.crafting[currentRecipePanelProfession].name.toLowerCase()],0)}function processCrafting(){craftingObject.timeRemaining-=craftingObject.depletionSpeed,craftingObject.timeRemaining<=0&&(craftingObject.isCreating=!1,startCraftingProcess()),UI.updateCraftingPanel()}function updateInventoryAfterCrafting(){if(craftingObject.thisRecipe.hiddenCreates){for(var e=craftingObject.thisRecipe.hiddenCreates.split(","),t=0;t<e.length;t++)a={type:parseInt(e[t]),quantity:1,quality:100,durability:100,currentWear:0,effectiveness:100,colour:0,enchanted:0,hallmark:0,inscription:""};if((inventoryCheck=canAddItemToInventory([a]))[0])UI.showChangeInInventory(inventoryCheck[1]);else sendNPCPost('{"subject":"'+"Your returned crafting items"+'","message":"'+"Returned items"+'","senderID":"-1","recipientID":"'+characterId+'","fromName":"'+"Artisan crafter"+'"}',[a]),UI.showNotification("<p>My crafted item is in the post</p>")}if(craftingObject.optionalDyeAdded>0){var a={type:11,quantity:craftingObject.optionalDyeAdded,quality:100,durability:100,currentWear:0,effectiveness:100,colour:0,enchanted:0,hallmark:0,inscription:""};if((inventoryCheck=canAddItemToInventory([a]))[0])UI.showChangeInInventory(inventoryCheck[1]);else sendNPCPost('{"subject":"'+"Your returned crafting items"+'","message":"'+"Returned items"+'","senderID":"-1","recipientID":"'+characterId+'","fromName":"'+"Artisan crafter"+'"}',[a]),UI.showNotification("<p>My crafted item is in the post</p>")}for(t=0;t<craftingObject.componentsAdded.length;t++)removeFromInventory(craftingObject.componentsAdded[t].fromSlot,craftingObject.componentsAdded[t].quantity)}function startCraftingProcess(){if(hero.stats.itemsCrafted++,releaseLockedSlots(),(inventoryCheck=canAddItemToInventory([craftingObject.craftedItem]))[0])UI.showChangeInInventory(inventoryCheck[1]);else{sendNPCPost('{"subject":"'+("Your crafted "+craftingObject.finalItemName)+'","message":"This is fine work","senderID":"-1","recipientID":"'+characterId+'","fromName":"Artisan crafter"}',[craftingObject.craftedItem]),UI.showNotification("<p>My crafted item is in the post</p>")}updateInventoryAfterCrafting(),recipeSelectComponents(craftingObject.whichRecipe,!1),startCrafting.style.display="block",craftingTimeBarOuter.style.display="none"}function determineAttributeValue(e,t){return Math.sqrt(e*t*t/100)}function findRecipeTierLevel(e){var t=e/10;return 10-Math.sqrt(100-t*t)}function gradeAttribute(e){for(var t=[{max:91,grade:"#04752c"},{max:66,grade:"#82b11e"},{max:36,grade:"#b98c45"},{max:11,grade:"#ab471d"}],a=0;a<t.length;a++){var i=t[a];if(e>=i.max)return i.grade}return"#b41119"}function generateCraftingSlotMarkup(e){var t='<div class="attributeSlot">',a="",i="",n="",o=getColourName(e.colour,e.type);return""!=o&&(a=o+" ",i="-"+o.toLowerCase()),"card"==currentActiveInventoryItems[e.type].action&&(n+="players card"),t+=generateAttributeGraphicMarkup(e.quality,e.durability,e.effectiveness),t+='<img src="/images/game-world/inventory-items/'+e.type+i+'.png" alt="'+a+currentActiveInventoryItems[e.type].shortname+'" class="'+n+'">',t+='<span class="qty">'+e.quantity+"</span></div>",t+="<p>"+a+currentActiveInventoryItems[e.type].shortname+"</p>"}function generateAttributeGraphicMarkup(e,t,a){return'<svg xmlns="http://www.w3.org/2000/svg" height="100" width="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="'+gradeAttribute(a)+'"/><path d="M6.699 75a50 50 0 0 1 0-50A50 50 0 0 1 50 0v50z" fill="'+gradeAttribute(e)+'"/><path d="M50 0a50 50 0 0 1 43.301 25 50 50 0 0 1 0 50l-43.3-25z" fill="'+gradeAttribute(t)+'"/></svg>'}function scrollbarWidth(){var e=document.createElement("div");e.style.cssText="width:50px;height:50px;overflow-y:scroll;top:-200px;left:-200px;position:absolute;";var t;document.body.appendChild(e),t=e.offsetWidth;var a=e.clientWidth;return document.body.removeChild(e),t-a}function customScrollBar(e){this.element=e,this.scrollingContent=this.element.firstElementChild,this.hasMouseEventsAttached=!1,this.init=function(){this.translateY=0,this.isBeingDragged=!1,this.scrollingContent.scrollTop=0,this.element.classList.remove("inActive"),this.scrollingContent.style.width=this.scrollingContent.offsetWidth+thisDevicesScrollBarWidth+"px",this.paneHeight=this.element.offsetHeight,this.scrollContentHeight=this.scrollingContent.scrollHeight,this.scrollContentHeight>this.paneHeight?(this.scrollbarRatio=this.paneHeight/this.scrollContentHeight,this.draggerHeight=Math.floor(this.scrollbarRatio*this.paneHeight),this.dragger=this.element.querySelector(".dragger"),this.dragger.style.height=this.draggerHeight+"px",this.dragger.style.transform="translateY("+this.translateY+"px)",this.hasMouseEventsAttached||(this.scrollingContent.addEventListener("scroll",this.contentScroll.bind(this)),this.dragger.addEventListener("mousedown",this.startScrollDrag.bind(this)),this.hasMouseEventsAttached=!0)):(this.element.classList.add("inActive"),this.scrollingContent.removeAttribute("style"))},this.contentScroll=function(){if(!this.isBeingDragged){var e=this.scrollingContent.scrollTop,t=Math.round(this.scrollbarRatio*e);this.translateY=t,this.dragger.style.transform="translateY("+this.translateY+"px)"}},this.startScrollDrag=function(e){e.preventDefault(),this.initialClickPosition=e.pageY-this.translateY,this.isBeingDragged=!0,this.mouseMoveEvent=this.handleScrollDrag.bind(this),document.addEventListener("mousemove",this.mouseMoveEvent,!1),this.mouseUpEvent=this.endScrollDrag.bind(this),document.addEventListener("mouseup",this.mouseUpEvent,!1)},this.handleScrollDrag=function(e){this.translateY=e.pageY-this.initialClickPosition,this.translateY<0&&(this.translateY=0),this.translateY+this.draggerHeight>this.paneHeight&&(this.translateY=this.paneHeight-this.draggerHeight),this.dragger.style.transform="translateY("+this.translateY+"px)",this.scrollingContent.scrollTop=this.translateY/this.scrollbarRatio},this.endScrollDrag=function(e){this.isBeingDragged=!1,document.removeEventListener("mousemove",this.mouseMoveEvent,!1),document.removeEventListener("mouseup",this.mouseUpEvent,!1)},this.init()}for(var thisDevicesScrollBarWidth=scrollbarWidth(),scrollBarElements=document.getElementsByClassName("customScrollBar"),i=0;i<scrollBarElements.length;i++)thisDevicesScrollBarWidth>0?window[scrollBarElements[i].id]=new customScrollBar(scrollBarElements[i]):scrollBarElements[i].classList.add("inActive");function processDowsing(){for(var e=1/0,t=-1,a=0;a<visibleMaps.length;a++)if(whichVisibleMap=visibleMaps[a],thisMapData[whichVisibleMap].hiddenResources[dowsing.category])for(var i=0;i<thisMapData[whichVisibleMap].hiddenResources[dowsing.category].length;i++)(t=getPythagorasDistance(hero.tileX,hero.tileY,thisMapData[whichVisibleMap].hiddenResources[dowsing.category][i].tileX,thisMapData[whichVisibleMap].hiddenResources[dowsing.category][i].tileY))<e&&(e=t);-1!=t?(dowsing.proximity=100-e/dowsing.range*100,dowsing.proximity=capValues(dowsing.proximity,0,100)):dowsing.proximity=0}function processSurveying(){surveying.timeRemaining-=surveying.depletionSpeed,surveying.timeRemaining<=0&&(activeAction="",surveyingComplete()),UI.updateSurveyingPanel()}function surveyingComplete(){for(var e,t,a,i,n,o=!1,r=0;r<visibleMaps.length;r++)if(whichVisibleMap=visibleMaps[r],thisMapData[whichVisibleMap].hiddenResources[surveying.category])for(var s=0;s<thisMapData[whichVisibleMap].hiddenResources[surveying.category].length;s++)if(e=thisMapData[whichVisibleMap].hiddenResources[surveying.category][s],getPythagorasDistance(hero.tileX,hero.tileY,e.tileX,e.tileY)<2){switch(i=hero.facing){case"n":n=["e","w","s"];break;case"e":n=["n","s","w"];break;case"s":n=["n","s","e"];break;case"w":n=["e","w","n"]}do{t=hero.tileX+relativeFacing[i].x,a=hero.tileY+relativeFacing[i].y,i=n.shift()}while(!tileIsClear(t,a)&&n.length>0);n.length>0?(e.tileX=t,e.tileY=a,e.isTemporary=!0,thisMapData[whichVisibleMap].items.push(e),initialiseItem(thisMapData[whichVisibleMap].items[thisMapData[whichVisibleMap].items.length-1]),o=!0,thisMapData[whichVisibleMap].hiddenResources[surveying.category].splice(s,1)):console.log("Error - Couldn't place resource node");break}o||UI.showNotification("<p>I couldn't find any resources</p>"),surveyingStopped()}function surveyingStopped(){activeAction="",surveying={},surveyingPanel.classList.remove("active")}function animateFae(){fae.dz+=.2;for(var e=0;e<fae.particles.length;e++)fae.particles[e].alpha-=.1,fae.particles[e].alpha<=0&&fae.particles.splice(e,1);if(fae.particles.length<fae.maxParticles&&1==getRandomInteger(1,2)){var t=findIsoCoordsX(fae.x,fae.y),a=findIsoCoordsY(fae.x,fae.y)-fae.oscillateOffset,i=t+getRandomInteger(0,8)-4,n=a+getRandomInteger(0,8)-4;isInRange(t,a,i,n,6)&&fae.particles.push({depth:findIsoDepth(fae.x,fae.y,fae.z),isoX:i,isoY:n,alpha:1})}}function moveFae(){switch(fae.currentState){case"away":moveFaeToDestination(fae.targetX,fae.targetY);break;case"wait":isInRange(fae.x,fae.y,hero.x,hero.y,3*tileW)&&(fae.currentState="hero");break;default:fae.angleAroundHero+=4,moveFaeToDestination(hero.x+fae.radiusAroundHero*Math.cos(fae.angleAroundHero*(Math.PI/180)),hero.y+fae.radiusAroundHero*Math.sin(fae.angleAroundHero*(Math.PI/180)))}}function moveFaeToDestination(e,t){var a=getPythagorasDistance(fae.x,fae.y,e,t);if(a>fae.speed){var i=fae.speed/a;fae.x+=i*(e-fae.x),fae.y+=i*(t-fae.y)}else a<2?(fae.x=e,fae.y=t,"away"==fae.currentState&&(fae.currentState="wait")):(fae.x+=(e-fae.x)/2,fae.y+=(t-fae.y)/2);var n=hero.z;n>fae.z?fae.z+=.5:n<fae.z&&(fae.z-=.5)}function successfullyTilledEarth(e,t){var a=findMapNumberFromGlobalCoordinates(e,t),i=getLocalCoordinatesX(e),n=getLocalCoordinatesX(t);if(void 0!==thisMapData[a].properties[n][i].tilled){if(1==thisMapData[a].properties[n][i].tilled){var o=findItemAtTile(e,t);-1!=o&&thisMapData[a].items.splice(o,1)}return 0==thisMapData[a].properties[n][i].tilled&&(thisMapData[a].properties[n][i].tilled=1),audio.playSound(soundEffects.digging,0),!0}return!1}function getTileWaterAmount(e,t){var a=0,i=findMapNumberFromGlobalCoordinates(e,t);e=getLocalCoordinatesX(e),t=getLocalCoordinatesX(t);return void 0!==thisMapData[i].properties[t][e].water&&(a=thisMapData[i].properties[t][e].water.amount),a}function pourLiquid(e,t){var a=findSlotByHash(hero.holding.hash),i=findMapNumberFromGlobalCoordinates(e,t);e=getLocalCoordinatesX(e),t=getLocalCoordinatesX(t);console.log(i),hero.inventory[a].contains[0].quantity>0?(audio.playSound(soundEffects.pouring,0),console.log(thisMapData[i].properties[t][e]),void 0===thisMapData[i].properties[t][e].water?(thisMapData[i].properties[t][e].water={},thisMapData[i].properties[t][e].water.amount=1):(thisMapData[i].properties[t][e].water.amount++,checkWaterRunOff()),thisMapData[i].properties[t][e].water.time=hero.totalGameTimePlayed,hero.inventory[a].contains[0].quantity--,updateGauge(a),UI.updateHeldItemGauge(),console.log(thisMapData[i].properties[t][e])):UI.showNotification("<p>I need to refill this</p>")}function checkWaterRunOff(){}function successfullyPlantSeed(e,t){var a=!1,i=findMapNumberFromGlobalCoordinates(e,t),n=getLocalCoordinatesX(e),o=getLocalCoordinatesY(t);if(1==thisMapData[i].properties[o][n].tilled)if(null==findItemWithinArmsLength()){var r=findSlotByHash(hero.holding.hash),s=JSON.parse(JSON.stringify(currentActiveInventoryItems[hero.inventory[r].type].actionValue));s.tileX=e,s.tileY=t,s.timeLastHarvested=hero.totalGameTimePlayed,currentActiveInventoryItems[hero.inventory[r].type].dyeable>0&&(s.colour=hero.inventory[r].colour),s.quality=hero.inventory[r].quality,s.effectiveness=hero.inventory[r].effectiveness,s.durability=hero.inventory[r].durability,thisMapData[i].items.push(s),initialiseItem(thisMapData[i].items[thisMapData[i].items.length-1]),reducedHeldQuantity(r),updateQuantity(r),UI.updateHeldItems(),audio.playSound(soundEffects.gather1,0),a=!0}else a=!1;else a=!1;return a}function checkCrop(e){var t=!1;if(""!=hero.holding.type&&"pollen"==currentActiveInventoryItems[hero.holding.type].action&&(console.log("pollinate "+e.state+":4"),4==e.state))if(void 0===e.contains.seed){t=!0;var a=findSlotByHash(hero.holding.hash),i=currentActiveInventoryItems[hero.inventory[a].type].actionValue,n=e.type,o=n,r=n;if(i!=n&&(console.log(i,n),r=i<n?i+"-"+n:n+"-"+i,o=hero.plantBreeding[r]),console.log("result",o),currentActiveInventoryItems[o].dyeable>0){var s,c=hero.inventory[a].colour,l=e.colour;s=void 0===l&&void 0===c?9:void 0===l?c:void 0===c?l:mixColours([l,c])}var h=currentActiveInventoryItems[o].actionValue,d={type:parseInt(h),colour:s,quality:Math.ceil((e.quality+hero.inventory[a].quality)/2),durability:Math.ceil((e.durability+hero.inventory[a].durability)/2),effectiveness:Math.ceil((e.effectiveness+hero.inventory[a].effectiveness)/2)};d.quantity=Math.ceil(6*(e.quality*hero.inventory[a].quality/2e4+e.effectiveness*hero.inventory[a].effectiveness/2e4)),d=prepareInventoryObject(d),e.contains.seed=JSON.parse(JSON.stringify(d)),e.contains.seed.crossBreedParents=r,UI.showNotification("<p>I've successfully pollinated that</p>"),reducedHeldQuantity(a),updateQuantity(a),UI.updateHeldItems()}else UI.showNotification("<p>I've already pollinated that</p>");if(!t)switch(e.state){case 4:if(void 0!==e.contains.pollen){var u={type:e.contains.pollen.type,quantity:e.contains.pollen.quantity,quality:e.quality,durability:e.durability,effectiveness:e.effectiveness};currentActiveInventoryItems[e.type].dyeable>0&&void 0!==e.colour&&(u.colour=e.colour),u=prepareInventoryObject(u),(inventoryCheck=canAddItemToInventory([u]))[0]?(UI.showChangeInInventory(inventoryCheck[1]),delete e.contains.pollen):UI.showNotification("<p>I don't have room in my bags for that</p>")}break;case 5:if(console.log("gathering seeds/fruit",e.contains.seed,e.contains.fruit),void 0!==e.contains.seed)if((inventoryCheck=canAddItemToInventory([e.contains.seed]))[0]){UI.showChangeInInventory(inventoryCheck[1]);var p,g=e.contains.seed.crossBreedParents,m="";p=-1==e.contains.seed.crossBreedParents.toString().indexOf("-")?e.contains.seed.crossBreedParents:hero.plantBreeding[g];var v=getColourName(e.contains.seed.colour,p);""!=v&&(m="-"+v.toLowerCase());var f="item"+p+m;if(void 0===itemImages[f]){var y="/images/game-world/items/"+currentActiveInventoryItems[p].worldSrc+m+".png";Loader.preload([{name:f,src:y}],function(){itemImages[f]=Loader.getImage(f)},function(){})}if(void 0!==e.contains.seed.crossBreedParents&&-1!=e.contains.seed.crossBreedParents.toString().indexOf("-")&&-1===hero.plantCrossesKnown.indexOf(g)){hero.plantCrossesKnown.push(g),UI.showNotification("<p>I learnt a new cross breed&hellip;</p>");var I=document.getElementsByClassName("parent"+g);I[0].innerHTML='<img src="/images/game-world/inventory-items/'+p+'.png"><p>'+currentActiveInventoryItems[hero.plantBreeding[g]].shortname+"</p>",I[1].innerHTML='<img src="/images/game-world/inventory-items/'+p+'.png"><p>'+currentActiveInventoryItems[hero.plantBreeding[g]].shortname+"</p>"}console.log("harvested seed"),e.contains.seed={}}else UI.showNotification("<p>I don't have room in my bags for that</p>")}}function checkForGamePadInput(){Input.isUsingGamePad&&navigator.getGamepads()[0].timestamp!=Input.gameLastPadTimeStamp&&(Input.gameLastPadTimeStamp=navigator.getGamepads()[0].timestamp,key[0]=navigator.getGamepads()[0].axes[0]<=-.5,key[1]=navigator.getGamepads()[0].axes[0]>=.5,key[2]=navigator.getGamepads()[0].axes[1]<=-.5,key[3]=navigator.getGamepads()[0].axes[1]>=.5,key[4]=navigator.getGamepads()[0].buttons[2].value>0,key[5]=navigator.getGamepads()[0].buttons[7].value>0)}function checkForRespawns(){for(var e=0;e<visibleMaps.length;e++)for(var t=visibleMaps[e],a=0;a<thisMapData[t].items.length;a++)switch(currentActiveInventoryItems[thisMapData[t].items[a].type].action){case"node":"active"!=thisMapData[t].items[a].state&&hero.totalGameTimePlayed-thisMapData[t].items[a].timeLastHarvested>=currentActiveInventoryItems[thisMapData[t].items[a].type].respawnRate&&(thisMapData[t].items[a].state="active");break;case"crop":if(parseInt(thisMapData[t].items[a].state)<5){var i=0;void 0!==thisMapData[t].items[a].additional&&(i=thisMapData[t].items[a].additional);var n=Math.abs(getTileWaterAmount(thisMapData[t].items[a].tileX,thisMapData[t].items[a].tileY)-i);hero.totalGameTimePlayed-thisMapData[t].items[a].timeLastHarvested>=currentActiveInventoryItems[thisMapData[t].items[a].type].respawnRate&&(thisMapData[t].items[a].quality-=4*n,thisMapData[t].items[a].effectiveness-=4*n,thisMapData[t].items[a].durability-=4*n,thisMapData[t].items[a].quality=capValues(thisMapData[t].items[a].quality,1,100),thisMapData[t].items[a].effectiveness=capValues(thisMapData[t].items[a].effectiveness,1,100),thisMapData[t].items[a].durability=capValues(thisMapData[t].items[a].durability,1,100),thisMapData[t].items[a].state++,thisMapData[t].items[a].timeLastHarvested=hero.totalGameTimePlayed)}else if(void 0===thisMapData[t].items[a].contains.seed){var o=currentActiveInventoryItems[thisMapData[t].items[a].type].actionValue,r={type:parseInt(o),quality:Math.ceil(.8*thisMapData[t].items[a].quality),durability:Math.ceil(.8*thisMapData[t].items[a].durability),effectiveness:Math.ceil(.8*thisMapData[t].items[a].effectiveness)};void 0!==thisMapData[t].items[a].colour&&(r.colour=thisMapData[t].items[a].colour);r.quantity=Math.ceil(6*(thisMapData[t].items[a].quality*thisMapData[t].items[a].quality/2e4+thisMapData[t].items[a].effectiveness*thisMapData[t].items[a].effectiveness/2e4)),r=prepareInventoryObject(r),thisMapData[t].items[a].contains.seed=JSON.parse(JSON.stringify(r)),thisMapData[t].items[a].contains.seed.crossBreedParents=thisMapData[t].items[a].type}}}function processGathering(){gathering.quantity-=gathering.depletionSpeed,gathering.stability-=gathering.stabilitySpeed,gathering.quality=capValues(gathering.quality,0,100),gathering.purity=capValues(gathering.purity,0,100),gathering.stability=capValues(gathering.stability,0,100),gathering.quantity=capValues(gathering.quantity,0,100),gathering.quality*gathering.purity*gathering.stability*gathering.quantity==0&&gatheringComplete(),UI.updateGatheringPanel()}function gatheringComplete(){if(0==gathering.stability)UI.showNotification("<p>I couldn't gather anything from that</p>"),gatheringPanel.classList.remove("active");else{var e=gathering.node.contains[0],t=Math.floor(gathering.purity/100*(gathering.node.maxQuantity-gathering.quantity)),a="Yielded: <ol><li>",i=e.type.toString().split("/"),n=e.colour.toString().split("/");a+="<div>",a+=generateCraftingSlotMarkup(activeGatheredObject={type:parseInt(getRandomElementFromArray(i)),quantity:t,quality:gathering.quality,durability:100,currentWear:0,effectiveness:100,colour:parseInt(getRandomElementFromArray(n)),enchanted:0,hallmark:0,inscription:""}),a+="</div></li></ol>",gatheringOutputSlot.innerHTML=a}gatheringStopped()}function gatheringStopped(){if(activeAction="",gathering.node.stability=gathering.stability,gathering.node.quantity=gathering.quantity,0!=gathering.node.quantity&&0!=gathering.node.stability||(gathering.node.stability=gathering.node.maxStability,gathering.node.timeLastHarvested=hero.totalGameTimePlayed,gathering.node.state="inactive"),gathering.node.isTemporary)for(var e=0;e<thisMapData[gathering.itemMap].items.length;e++)if(thisMapData[gathering.itemMap].items[e]===gathering.node){thisMapData[gathering.itemMap].items.splice(e,1);break}gathering={}}function findIsoCoordsX(e,t){return Math.floor((mapTilesY*tileW-t+e)/2)}function findIsoCoordsY(e,t){return Math.floor((e+t-2*tileH)/4)}function find2DCoordsX(e,t){return e+tileH+2*t-mapTilesY*tileW/2}function find2DCoordsY(e,t){return 2*t+tileH-e+mapTilesY*tileW/2}function findIsoDepth(e,t,a){return findIsoCoordsY(e,t)*tileW/2+2*a}function getTileCentreCoordX(e){return e*tileW+tileW/2}function getTileCentreCoordY(e){return e*tileW+tileW/2}function getTileIsoCentreCoordX(e,t){return tileW/2*(mapTilesY-t+e)}function getTileIsoCentreCoordY(e,t){return tileH/2*(t+e)}function getTileCoordsFromScreenPosition(e,t){var a=e-canvasWidth/2,i=t-canvasHeight/2,n=find2DCoordsX(hero.isox+a,hero.isoy+i),o=find2DCoordsY(hero.isox+a,hero.isoy+i);return[getTileX(n),getTileY(o)]}function getTileX(e){return Math.floor(e/tileW)}function getTileY(e){return Math.floor(e/tileW)}function getElevation(e,t){var a,i,n;isOverWorldMap?(n=findMapNumberFromGlobalCoordinates(e,t),a=getLocalCoordinatesX(e),i=getLocalCoordinatesY(t)):(n=currentMap,a=e,i=t);var o=0;return void 0!==thisMapData[n].properties[i][a].elevation&&(o=thisMapData[n].properties[i][a].elevation),o}function checkForSlopes(e){var t,a,i,n=e.tileX,o=e.tileY;switch(isOverWorldMap?(t=getLocalCoordinatesX(n),a=getLocalCoordinatesY(o),i=findMapNumberFromGlobalCoordinates(n,o)):(t=n,a=o,i=currentMap),thisMapData[i].collisions[a][t]){case">":console.log(e.x%tileW);var r=thisMapData[i].properties[a][t].elevation.split(">");e.z=parseInt(r[0])+parseInt(r[1])*(tileW-e.x%tileW)/tileW;break;case"<":console.log(e.x%tileW);r=thisMapData[i].properties[a][t].elevation.split(">");e.z=parseInt(r[0])+parseInt(r[1])*(e.x%tileW)/tileW;break;case"v":r=thisMapData[i].properties[a][t].elevation.split(">");console.log(e.y%tileW+" - "+r[0]+parseInt(r[1])*(tileW-e.y%tileW)/tileW),e.z=parseInt(r[0])+parseInt(r[1])*(tileW-e.y%tileW)/tileW;break;case"^":r=thisMapData[i].properties[a][t].elevation.split(">");console.log(e.y%tileW+" - "+r[0]+parseInt(r[1])*(tileW-e.y%tileW)/tileW),e.z=parseInt(r[0])+parseInt(r[1])*(e.y%tileW)/tileW;break;default:e.z=getElevation(e.tileX,e.tileY)}}function dataURItoBlob(e){for(var t=e.split(",")[0].split(":")[1].split(";")[0],a=atob(e.split(",")[1]),i=[],n=0;n<a.length;n++)i.push(a.charCodeAt(n));return new Blob([new Uint8Array(i)],{type:t})}function getCurrentDateTimeFormatted(){var e=new Date,t=e.getDate(),a=e.getMonth()+1;return t<10&&(t="0"+t),a<10&&(a="0"+a),t+"-"+a+"-"+e.getFullYear()+"_"+e.getHours()+"-"+e.getMinutes()+"-"+e.getSeconds()}function parseTime(e){var t=Math.floor(e/1e3%60),a=Math.floor(e/6e4%60),i=Math.floor(e/36e5%24);return i>24?Math.floor(i/24)+" days":i>1?i+" hours":1==i?a>1?"1 hour & "+a+" minutes":1==a?"1 hour & 1 minute":"1 hour":a>1?a+" minutes":1==a&&0==t?"1 minute":1==t?"1 second":t+" seconds"}function isATerrainCollision(e,t){var a,i,n,o=getTileX(e),r=getTileY(t);if(isOverWorldMap){if(a=getLocalCoordinatesX(o),i=getLocalCoordinatesY(r),o<0||r<0||o>=worldMapTileLength*worldMap[0].length||r>=worldMapTileLength*worldMap.length)return 1;n=findMapNumberFromGlobalCoordinates(o,r)}else{if(i=r,(a=o)<0||i<0||a>=mapTilesX||i>=mapTilesY)return 1;n=currentMap}switch(thisMapData[n].collisions[i][a]){case 1:return 1;case"<":case">":case"^":case"v":case"d":default:return 0}}function findWhichWorldMap(e,t){return worldMap[Math.floor(t/worldMapTileLength)][Math.floor(e/worldMapTileLength)]}function getXOffsetFromHeight(e){return Math.sqrt(2)/2*e}function findItemAtTile(e,t){for(var a,i=-1,n=findMapNumberFromGlobalCoordinates(e,t),o=0;o<thisMapData[n].items.length;o++)if(e==(a=thisMapData[n].items[o]).tileX&&t==a.tileY){i=o;break}return i}function findItemWithinArmsLength(){for(var e,t=hero.tileX+relativeFacing[hero.facing].x,a=hero.tileY+relativeFacing[hero.facing].y,i=null,n=0;n<visibleMaps.length;n++)for(var o=0;o<thisMapData[visibleMaps[n]].items.length;o++){if(e=thisMapData[visibleMaps[n]].items[o],hero.tileX==e.tileX&&hero.tileY==e.tileY){i=e;break}if(t==e.tileX&&a==e.tileY){i=e;break}}return i}function capValues(e,t,a){return e<t&&(e=t),e>a&&(e=a),e}function keepWithinRange(e,t,a){return e<t&&(e+=a),e>a&&(e-=a),e}function accessDynamicVariable(e){for(var t=e.split("."),a=window,i=0;i<t.length;i++)void 0!==a[t[i]]&&(a=a[t[i]]);return a}function getNearestParentId(e){for(;!e.id;)e=e.parentNode;return e}function getObjectKeysForInnerValue(e,t,a){var i=[];for(var n in e)e.hasOwnProperty(n)&&e[n][a]===t&&i.push(n);return i}function launchFullScreen(e){e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()}function exitFullScreen(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()}function debounce(e,t,a){var i;return function(){var n=this,o=arguments,r=a&&!i;clearTimeout(i),i=setTimeout(function(){i=null,a||e.apply(n,o)},t),r&&e.apply(n,o)}}function isAnObjectCollision(e,t,a,i,n,o,r,s){return e+a/2>n-r/2&&e-a/2<n+r/2&&t-i/2<o+s/2&&t+i/2>o-s/2}var relativeFacing={n:{x:0,y:-1},s:{x:0,y:1},e:{x:1,y:0},w:{x:-1,y:0}};function getRandomInteger(e,t){return Math.floor(Math.random()*(t-e))+e}function getRandomIntegerInclusive(e,t){return Math.floor(Math.random()*(t-e+1))+e}function rollDice(e,t){for(var a=0,i=0;i<e;i++)a+=getRandomIntegerInclusive(1,t);return a}function getRandomKeyFromObject(e){var t=Object.keys(e);return t[t.length*Math.random()<<0]}function isInRange(e,t,a,i,n){return getPythagorasDistance(e,t,a,i)<=n}function getPythagorasDistance(e,t,a,i){return Math.sqrt((e-a)*(e-a)+(t-i)*(t-i))}function turntoFace(e,t){var a=e.x-t.x,i=e.y-t.y;return Math.abs(a)>Math.abs(i)?a>0?"w":"e":i>0?"n":"s"}function turntoFaceTile(e,t,a){var i=e.x-getTileCentreCoordX(t),n=e.y-getTileCentreCoordY(a);return Math.abs(i)>Math.abs(n)?i>0?"w":"e":n>0?"n":"s"}function isFacing(e,t){var a=!1;switch(e.facing){case"n":e.y>t.y&&(a=!0);break;case"s":e.y<t.y&&(a=!0);break;case"w":e.x>t.x&&(a=!0);break;case"e":e.x<t.x&&(a=!0)}return a}function generateHash(e){var t,a,i=0;if(0===e.length)return i;for(t=0,a=e.length;t<a;t++)i=(i<<5)-i+e.charCodeAt(t),i|=0;return i}function parseMoney(e){var t=!1;e<0&&(e=Math.abs(e),t=!0);var a="",i=e%100,n=Math.floor(e/1e4),o=Math.floor((e-1e4*n)/100);return n>0&&(a=n+'<span class="gold"></span>'),(o>0||n>0)&&(a+=o+'<span class="silver"></span>'),a+=i+'<span class="copper"></span>',t&&(a="-"+a),a}function hasLineOfSight(e,t,a,i){var n,o,r,s,c,l,h=findMapNumberFromGlobalCoordinates(e,t),d=e,u=t,p=[],g=[],m=i-t,v=a-e,f=0,y=!1;void 0!==thisMapData[h].innerDoors&&(y=!0);var I=getLocalCoordinatesX(e),b=getLocalCoordinatesY(t);if(0!=thisMapData[h].collisions[b][I])return!1;if(y&&(l=h+"-"+I+"-"+b,thisMapData[h].innerDoors.hasOwnProperty(l)&&!thisMapData[h].innerDoors[l].isOpen))return!1;if(c=m<0?-1:1,s=v<0?-1:1,m=Math.abs(2*m),o=e,r=t,(v=Math.abs(2*v))>m)for(n=2*m-v;d!=a;){if(n>=0&&(u+=c,n-=v),n+=m,h=findMapNumberFromGlobalCoordinates(d+=s,u),I=getLocalCoordinatesX(d),b=getLocalCoordinatesY(u),0!=thisMapData[h].collisions[b][I])return!1;if(y&&(l=h+"-"+I+"-"+b,thisMapData[h].innerDoors.hasOwnProperty(l)&&!thisMapData[h].innerDoors[l].isOpen))return!1;p[f]=u-r,g[f]=d-o,r=u,o=d,f++}else for(n=2*v-m;u!=i;){if(n>=0&&(d+=s,n-=m),n+=v,h=findMapNumberFromGlobalCoordinates(d,u+=c),I=getLocalCoordinatesX(d),b=getLocalCoordinatesY(u),0!=thisMapData[h].collisions[b][I])return!1;if(y&&(l=h+"-"+I+"-"+b,thisMapData[h].innerDoors.hasOwnProperty(l)&&!thisMapData[h].innerDoors[l].isOpen))return!1;p[f]=u-r,g[f]=d-o,r=u,o=d,f++}return!0}function determineWhichTransitionEvent(){var e,t=document.createElement("fakeelement"),a={transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"};for(e in a)if(void 0!==t.style[e])return a[e];t=null}function determineWhichAnimationEvent(){var e,t=document.createElement("fakeelement"),a={animation:"animationend",OAnimation:"oAnimationEnd",MozAnimation:"animationend",WebkitAnimation:"webkitAnimationEnd"};for(e in a)if(void 0!==t.style[e])return a[e];t=null}function uniqueValues(e){var t={};return e.filter(function(e){return!t.hasOwnProperty(e)&&(t[e]=!0)})}function sortByHighestValue(e,t){return e[0]<t[0]?1:e[0]>t[0]?-1:0}function sortByLowestValue(e,t){return e[0]<t[0]?-1:e[0]>t[0]?1:0}function removeElementFromArray(e,t){var a=e.indexOf(t);a>-1&&e.splice(a,1)}function getRandomElementFromArray(e){return e[Math.floor(Math.random()*e.length)]}function drawEllipse(e,t,a,i,n,o,r){var s=i/2*.5522848,c=n/2*.5522848,l=t+i,h=a+n,d=t+i/2,u=a+n/2;e.beginPath(),e.moveTo(t,u),e.bezierCurveTo(t,u-c,d-s,a,d,a),e.bezierCurveTo(d+s,a,l,u-c,l,u),e.bezierCurveTo(l,u+c,d+s,h,d,h),e.bezierCurveTo(d-s,h,t,u+c,t,u),e.closePath(),o?(e.fillStyle=r,e.fill()):(e.strokeStyle=r,e.stroke())}function drawCircle(e,t,a,i,n){n.fillStyle=e,n.beginPath(),n.arc(t,a,i,0,2*Math.PI),n.fill()}function drawIsoRectangle(e,t,a,i,n,o,r){var s=canvasWidth/2-hero.isox,c=canvasHeight/2-hero.isoy;r.fillStyle=o,r.beginPath(),r.moveTo(findIsoCoordsX(e,t)+s,findIsoCoordsY(e,t)+c),r.lineTo(findIsoCoordsX(a,t)+s,findIsoCoordsY(a,t)+c),r.lineTo(findIsoCoordsX(a,i)+s,findIsoCoordsY(a,i)+c),r.lineTo(findIsoCoordsX(e,i)+s,findIsoCoordsY(e,i)+c),r.lineTo(findIsoCoordsX(e,t)+s,findIsoCoordsY(e,t)+c),r.closePath(),n?(r.fillStyle=o,r.fill()):(r.strokeStyle=o,r.stroke())}!function(){for(var e=0,t=["ms","moz","webkit","o"],a=0;a<t.length&&!window.requestAnimationFrame;++a)window.requestAnimationFrame=window[t[a]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[a]+"CancelAnimationFrame"]||window[t[a]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,a){var i=(new Date).getTime(),n=Math.max(0,16-(i-e)),o=window.setTimeout(function(){t(i+n)},n);return e=i+n,o}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}();var getJSONWithParams=function(e,t,a,i){var n="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");n.open("POST",e,!0),n.onreadystatechange=function(){var e,t;if(4==n.readyState){var o=!0;if(200==(e=n.status)){try{t=JSON.parse(n.responseText)}catch(t){o=!1,i&&i(e)}o&&a&&a(t)}else i&&i(e)}},n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.send(t)};function sendGetData(e,t,a){var i="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");i.open("get",e,!0),i.onreadystatechange=function(){var e,n;4==i.readyState&&(200==(e=i.status)?(n=i.responseText,t&&t(n)):a&&a(e))},i.setRequestHeader("Content-type","application/x-www-form-urlencoded"),i.send()}function sendDataWithoutNeedingAResponse(e){var t="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");t.open("get",e,!0),t.send()}function postData(e,t){var a="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");a.open("post",e,!0),a.setRequestHeader("Content-Type","application/x-www-form-urlencoded;"),a.send(t)}function placePlotPlacement(){if(0==plotPlacement.numberOfBlockedTiles){document.removeEventListener("mousemove",UI.movePlotPlacementOverlay,!1),document.removeEventListener("click",placePlotPlacement,!1),activeAction="";var e=getTileCoordsFromScreenPosition(cursorPositionX,cursorPositionY);e[0]-=plotPlacement.width/2,e[1]-=plotPlacement.length/2,getJSON("/game-world/addPlot.php?width="+plotPlacement.width+"&height="+plotPlacement.length+"&tileX="+e[0]+"&tileY="+e[1]+"&chr="+characterId,function(t){t.success&&(removeItemTypeFromInventory(plotPlacement.whichType,1),hero.housing.hasAPlayerHouse=!0,hero.housing.northWestCornerTileX=e[0],hero.housing.northWestCornerTileY=e[1],hero.housing.southEastCornerTileX=e[0]+parseInt(plotPlacement.width),hero.housing.southEastCornerTileY=e[1]+parseInt(plotPlacement.length),hero.housing.draft=[],hero.housing.draft[0]=[],hero.settings.showFootprintInEditMode=!0,showHousingFootprintCheckbox.checked=!0,UI.openHousingPanel(),UI.openHousingConstructionPanel())},function(e){})}else UI.showNotification("<p>I can't put a plot there</p>")}window.Loader=function(){var e=0,t=!1,a=0,i={};function n(){e=0,t=!1,a=0,i={}}function o(){}function r(){}function s(e){console.log("Error on loading the image: "+e.srcElement)}function c(n,c){try{i[n]=new Image,i[n].onload=function(){++e,o(l()),e==a&&(t=!1,r())},i[n].onerror=s,i[n].src=c}catch(e){console.log(e.message)}}function l(){return e/a*100}return{preload:function(e,i,s){if(n(),!t){t=!0;try{a=e.length,o=s||function(){},r=i||function(){};for(var l=0;l<e.length;++l)c(e[l].name,e[l].src)}catch(e){console.log(e.message)}}},getProgress:l,getImage:function(e){return i[e]?i[e]:void 0},reset:n,images:i}}();const firstTileThatWouldBeActive=document.querySelector(".housingTileGroup.active li");var housingNameSpace={whichTileActive:"",whichWorldTileActive:"",whichElevationActive:0,maxElevationsPossible:3,whichDyeColourActive:0,runningCostTotal:0,costForActiveTile:0,activeTool:"paint",mousePosition:[],draftHousingTilesToLoad:[],whichItemIdsLoading:[],whichFacingActive:"n",whichZIndexActive:0,currentTileCanBeElevated:firstTileThatWouldBeActive.getAttribute("data-canbelevated"),zIndexesPerElevation:3*tileW,activeTileCanBeRotated:firstTileThatWouldBeActive.getAttribute("data-canberotated"),floodFillTilesChecked:[],init:function(){if(hero.housing.hasAPlayerHouse){if(hero.housing.draft)for(var e,t,a,i,n=0;n<hero.housing.draft.length;n++)for(var o=0;o<hero.housing.draft[n].length;o++){e=0,void 0!==hero.housing.draft[n][o].colour&&(e=hero.housing.draft[n][o].colour),t=document.querySelector('#housingTileSelection li[data-id="'+hero.housing.draft[n][o].type+'"]').getAttribute("data-cleanurl"),a="",0!=e&&""!=(i=colourNames[e])&&(a="-"+i.toLowerCase());var r="item"+hero.housing.draft[n][o].type+a;-1===housingNameSpace.whichItemIdsLoading.indexOf(r)&&(housingNameSpace.draftHousingTilesToLoad.push({name:r,src:"/images/game-world/items/"+t+".png"}),housingNameSpace.whichItemIdsLoading.push(r))}Loader.preload(housingNameSpace.draftHousingTilesToLoad,housingNameSpace.prepareDraftHousingAssets,loadingProgress)}},prepareDraftHousingAssets:function(){for(var e=0;e<housingNameSpace.whichItemIdsLoading.length;e++)itemImages[housingNameSpace.whichItemIdsLoading[e]]=Loader.getImage(housingNameSpace.whichItemIdsLoading[e])},update:function(){if(key[12]){document.getElementById("housingTile"+housingNameSpace.whichTileActive).classList.remove("active"),housingNameSpace.whichTileActive="",housingNameSpace.whichWorldTileActive="",housingNameSpace.costForActiveTile=0,housingNameSpace.activeTool="";for(var e=0;e<housingConstructionToolButtons.length;e++)housingConstructionToolButtons[e].classList.remove("active");key[12]=!1}key[7]&&(UI.toggleUI(),key[7]=!1),key[15]&&(housingNameSpace.adjustRotation(-1),key[15]=!1),key[16]&&(housingNameSpace.adjustRotation(1),key[16]=!1),key[13]&&(housingNameSpace.adjustZIndex(1),key[13]=!1),key[14]&&(housingNameSpace.adjustZIndex(-1),key[14]=!1)},worldClickHandler:function(e){var t=e.pageX-canvasWidth/2,a=e.pageY-canvasHeight/2,i=find2DCoordsX(hero.isox+t,hero.isoy+a),n=find2DCoordsY(hero.isox+t,hero.isoy+a),o=getTileX(i),r=getTileY(n);if(o>=hero.housing.northWestCornerTileX&&o<hero.housing.southEastCornerTileX&&r>=hero.housing.northWestCornerTileY&&r<hero.housing.southEastCornerTileY&&"CANVAS"==e.target.nodeName)switch(housingNameSpace.activeTool){case"paint":""!=housingNameSpace.whichTileActive&&housingNameSpace.addTileToLocation(o-hero.housing.northWestCornerTileX,r-hero.housing.northWestCornerTileY);break;case"remove":var s=hero.housing.draft[housingNameSpace.whichElevationActive].filter(function(e){return e.tileX==o-hero.housing.northWestCornerTileX&&e.tileY==r-hero.housing.northWestCornerTileY});for(var c in s)housingNameSpace.runningCostTotal-=parseInt(document.getElementById("housingTile"+s[c].type).getAttribute("data-price"));housingNameSpace.updateRunningTotal(),hero.housing.draft[housingNameSpace.whichElevationActive]=hero.housing.draft[housingNameSpace.whichElevationActive].filter(function(e){return!(e.tileX==o-hero.housing.northWestCornerTileX&&e.tileY==r-hero.housing.northWestCornerTileY)});break;case"fill":""!=housingNameSpace.whichTileActive&&housingNameSpace.floodFillFrom(o-hero.housing.northWestCornerTileX,r-hero.housing.northWestCornerTileY)}},addTileToLocation:function(e,t){var a={type:parseInt(housingNameSpace.whichTileActive),tileX:e,tileY:t,lockedToPlayerId:characterId};housingNameSpace.currentTileCanBeElevated&&(a.tileZ=housingNameSpace.whichZIndexActive/tileW),0!=housingNameSpace.whichDyeColourActive&&(a.colour=parseInt(housingNameSpace.whichDyeColourActive)),housingNameSpace.activeTileCanBeRotated&&(a.facing=housingNameSpace.whichFacingActive),hero.housing.draft[housingNameSpace.whichElevationActive].push(a),housingNameSpace.runningCostTotal+=housingNameSpace.costForActiveTile,housingNameSpace.updateRunningTotal()},mouseMove:function(e){housingNameSpace.mousePosition=getTileCoordsFromScreenPosition(e.pageX,e.pageY)},toggleShowPlotFootprint:function(e){e.target.checked?hero.settings.showFootprintInEditMode=!0:hero.settings.showFootprintInEditMode=!1},housingTileColourChange:function(e){if(housingNameSpace.whichDyeColourActive!=housingTileColour.value){housingNameSpace.whichDyeColourActive=housingTileColour.value,housingNameSpace.loadNewTile(housingNameSpace.whichTileActive,housingNameSpace.whichWorldTileActive,housingNameSpace.whichDyeColourActive);var t="";"0"!=housingTileColour.value&&(t="-"+colourNames[housingNameSpace.whichDyeColourActive].toLowerCase());for(var a=0;a<housingTileSelectionListItems.length;a++)housingTileSelectionListItems[a].firstElementChild.src="/images/game-world/items/"+housingTileSelectionListItems[a].getAttribute("data-cleanurl")+t+".png"}},selectNewTile:function(e){""!=housingNameSpace.whichTileActive&&document.getElementById("housingTile"+housingNameSpace.whichTileActive).classList.remove("active");var t=getNearestParentId(e.target);t.classList.add("active"),housingNameSpace.costForActiveTile=parseInt(t.getAttribute("data-price")),housingNameSpace.whichWorldTileActive=t.getAttribute("data-cleanurl"),"remove"==housingNameSpace.activeTool&&(housingNameSpace.activeTool="paint"),housingNameSpace.activeTileCanBeRotated=t.getAttribute("data-canberotated"),housingNameSpace.currentTileCanBeElevated=t.getAttribute("data-canbelevated"),housingNameSpace.showActiveTool(document.getElementById("housingConstructToolPaint")),housingNameSpace.whichTileActive=t.getAttribute("data-id"),housingNameSpace.loadNewTile(housingNameSpace.whichTileActive,housingNameSpace.whichWorldTileActive,housingNameSpace.whichDyeColourActive)},loadNewTile:function(e,t,a){var i="";if(0!=a){var n=colourNames[a];""!=n&&(i="-"+n.toLowerCase())}var o="item"+e+i;void 0===itemImages[o]&&Loader.preload([{name:o,src:"/images/game-world/items/"+t+i+".png"}],function(){itemImages[o]=Loader.getImage(o),console.log("completed laoding: "+o)},function(){})},commitDesign:function(){var e;housingNameSpace.runningCostTotal>hero.currency.money?UI.showYesNoDialogueBox("Not enough money&hellip;","Save design","Cancel design","housingNameSpace.saveDraftDesign","housingNameSpace.abandonLatestChanges"):(e=housingNameSpace.runningCostTotal<0?"Commit this design and be refunded "+parseMoney(0-housingNameSpace.runningCostTotal)+"?":"Commit this design at a cost of "+parseMoney(housingNameSpace.runningCostTotal)+"?",UI.showYesNoDialogueBox(e,"Commit design","Save for later","housingNameSpace.publishCommittedDesign","housingNameSpace.saveDraftDesign"))},publishCommittedDesign:function(){getJSONWithParams("/game-world/savePlot.php","chr="+characterId+"&postData="+JSON.stringify(hero.housing.draft)+"&northWestCornerTileX="+hero.housing.northWestCornerTileX+"&northWestCornerTileY="+hero.housing.northWestCornerTileY,function(e){if(e.success){UI.hideYesNoDialogueBox(),hero.currency.money-=housingNameSpace.runningCostTotal,UI.updateCurrencies(),0!=housingNameSpace.runningCostTotal&&(audio.playSound(soundEffects.coins,0),housingNameSpace.runningCostTotal=0),hero.housing.draftCost=0,housingNameSpace.updateRunningTotal();for(var t,a,i=uniqueValues([findWhichWorldMap(hero.housing.northWestCornerTileX,hero.housing.northWestCornerTileY),findWhichWorldMap(hero.housing.southEastCornerTileX,hero.housing.southEastCornerTileY),findWhichWorldMap(hero.housing.southEastCornerTileX,hero.housing.northWestCornerTileY),findWhichWorldMap(hero.housing.northWestCornerTileX,hero.housing.southEastCornerTileY)]),n=0;n<i.length;n++)thisMapData[i[n]].items=thisMapData[i[n]].items.filter(function(e){return e.lockedToPlayerId!==characterId});for(n=0;n<hero.housing.draft[0].length;n++)(t=JSON.parse(JSON.stringify(hero.housing.draft[0][n]))).tileX+=hero.housing.northWestCornerTileX,t.tileY+=hero.housing.northWestCornerTileY,a=findWhichWorldMap(t.tileX,t.tileY),thisMapData[a].items.push(t),initialiseItem(thisMapData[a].items[thisMapData[a].items.length-1]);UI.closeHousingConstructionPanel()}},function(e){})},checkSaveDraftDesign:function(){UI.showYesNoDialogueBox("Save these latest changes to your draft version?","Save to draft","Abandon changes","housingNameSpace.saveDraftDesign","housingNameSpace.abandonLatestChanges")},abandonLatestChanges:function(){hero.housing.draft=JSON.parse(JSON.stringify(housingNameSpace.restoreDraft)),housingNameSpace.runningCostTotal=0,housingNameSpace.updateRunningTotal(),UI.closeHousingConstructionPanel(),UI.hideYesNoDialogueBox()},saveDraftDesign:function(){hero.housing.draftCost=housingNameSpace.runningCostTotal,getJSONWithParams("/game-world/savePlot.php","chr="+characterId+"&postData="+JSON.stringify(hero.housing.draft)+"&northWestCornerTileX="+hero.housing.northWestCornerTileX+"&northWestCornerTileY="+hero.housing.northWestCornerTileY+"&draft=true",function(e){e.success&&(UI.showNotification("<p>I've saved that design for later</p>"),UI.hideYesNoDialogueBox(),UI.closeHousingConstructionPanel())},function(e){})},checkAbandonDesign:function(){UI.showYesNoDialogueBox("Abandon this draft design entirely?","Abandon draft","Keep this changes for now","housingNameSpace.abandonDesign","UI.hideYesNoDialogueBox")},abandonDesign:function(){getJSONWithParams("/game-world/removeDraftPlot.php","chr="+characterId,function(e){e.housing.success&&(hero.housing.draft=JSON.parse(e.housing.draft),UI.showNotification("<p>I've abandoned that draft design</p>"),UI.hideYesNoDialogueBox(),UI.closeHousingConstructionPanel())},function(e){})},changeActiveTool:function(e){var t=getNearestParentId(e.target);housingNameSpace.activeTool=t.getAttribute("data-action"),housingNameSpace.showActiveTool(t)},showActiveTool:function(e){for(var t=0;t<housingConstructionToolButtons.length;t++)housingConstructionToolButtons[t].classList.remove("active");e.classList.add("active")},updateRunningTotal:function(){housingNameSpace.runningCostTotal>hero.currency.money?housingRunningTotal.classList.add("notEnough"):housingRunningTotal.classList.remove("notEnough"),housingRunningTotal.innerHTML=parseMoney(housingNameSpace.runningCostTotal)},toggleTileGroup:function(e){for(i=0;i<housingTileGroups.length;i++)housingTileGroups[i].classList.remove("active");for(document.getElementById(e.target.getAttribute("data-group")).classList.add("active"),i=0;i<housingToggleButtons.length;i++)housingToggleButtons[i].classList.remove("active");e.target.classList.add("active")},adjustRotation:function(e){var t=facingsPossible.indexOf(housingNameSpace.whichFacingActive);(t+=e)<0&&(t=facingsPossible.length-1),t>=facingsPossible.length&&(t=0),housingNameSpace.whichFacingActive=facingsPossible[t]},adjustZIndex:function(e){housingNameSpace.whichZIndexActive+=e,housingNameSpace.whichZIndexActive<0&&(housingNameSpace.whichZIndexActive=0,housingNameSpace.whichElevationActive>0&&(housingNameSpace.whichElevationActive--,housingNameSpace.updateElevationDisplay())),housingNameSpace.whichZIndexActive>=housingNameSpace.zIndexesPerElevation&&(housingNameSpace.whichElevationActive<housingNameSpace.maxElevationsPossible?(housingNameSpace.whichZIndexActive=0,housingNameSpace.whichElevationActive++,housingNameSpace.updateElevationDisplay()):housingNameSpace.whichZIndexActive=housingNameSpace.zIndexesPerElevation)},updateElevationDisplay:function(){},findTileAtLocation:function(e,t){for(var a=[],i="",n=0;n<hero.housing.draft[housingNameSpace.whichElevationActive].length;n++)hero.housing.draft[housingNameSpace.whichElevationActive][n].tileX==e&&hero.housing.draft[housingNameSpace.whichElevationActive][n].tileY==t&&(a.push[n],i=hero.housing.draft[housingNameSpace.whichElevationActive][n].type);if(a.length>1){var o,r=9999;for(n=0;n<a.length;n++)o=9999,hero.housing.draft[housingNameSpace.whichElevationActive][a[n]].tileZ&&(o=hero.housing.draft[housingNameSpace.whichElevationActive][a[n]].tileZ),o<r&&(r=o,i=a[n])}return i},floodFillFrom:function(e,t){housingNameSpace.floodFillTilesChecked=[],housingNameSpace.floodFillTile(e,t,housingNameSpace.findTileAtLocation(e,t))},floodFillTile:function(e,t,a){if(-1==housingNameSpace.floodFillTilesChecked.indexOf(e+"_"+t)&&(housingNameSpace.floodFillTilesChecked.push(e+"_"+t),e>=0&&e<hero.housing.southEastCornerTileX-hero.housing.northWestCornerTileX&&t>=0&&t<hero.housing.southEastCornerTileY-hero.housing.northWestCornerTileY&&housingNameSpace.findTileAtLocation(e,t)==a)){if(""!=a){var i=hero.housing.draft[housingNameSpace.whichElevationActive].filter(function(i){return i.tileX==e&&i.tileY==t&&i.type==a});for(var n in i)housingNameSpace.runningCostTotal-=parseInt(document.getElementById("housingTile"+i[n].type).getAttribute("data-price"));housingNameSpace.updateRunningTotal(),hero.housing.draft[housingNameSpace.whichElevationActive]=hero.housing.draft[housingNameSpace.whichElevationActive].filter(function(i){return!(i.tileX==e&&i.tileY==t&&i.type==a)})}housingNameSpace.addTileToLocation(e,t),housingNameSpace.floodFillTile(e+1,t,a),housingNameSpace.floodFillTile(e-1,t,a),housingNameSpace.floodFillTile(e,t+1,a),housingNameSpace.floodFillTile(e,t-1,a)}}},allCardPacks=[[1,1,1,1,1,1,1,1,3,3,3,3,3,3,3,3,3],[1,1,1,1,1,1,2,2,2,2,2,3,3,3,3,3,3]];function cardGamePlayer2Concedes(){delete thisChallengeNPC.isPlayingCards,processSpeech(thisChallengeNPC,thisChallengeNPC.cardGameSpeech.win[0],thisChallengeNPC.cardGameSpeech.win[1]),closeCardGame()}function cardGamePlayer2Wins(){hero.stats.cardGamesWon++,hero.stats.cardGamesPlayed++,hero.currency.cardDust+=7,UI.updateCurrencies(),UI.updateCardAlbum(),void 0!==thisChallengeNPC.cardBackId&&-1==hero.cardBacks.indexOf(parseInt(thisChallengeNPC.cardBackId))&&(hero.cardBacks.push(parseInt(thisChallengeNPC.cardBackId)),UI.showNotification("<p>I've just won a new card back</p>"),UI.updateCardAlbum()),delete thisChallengeNPC.isPlayingCards,processPlayerWinSpeech(thisChallengeNPC,thisChallengeNPC.cardGameSpeech.lose[0],thisChallengeNPC.cardGameSpeech.lose[1]),closeCardGame()}function cardGamePlayer1Wins(){hero.stats.cardGamesLost++,hero.stats.cardGamesPlayed++,hero.currency.cardDust+=1,UI.updateCurrencies(),UI.updateCardAlbum(),delete thisChallengeNPC.isPlayingCards,processSpeech(thisChallengeNPC,thisChallengeNPC.cardGameSpeech.win[0],thisChallengeNPC.cardGameSpeech.win[1]),closeCardGame()}function cardGameIsDrawn(){console.log("DRAWN"),console.log(thisChallengeNPC),hero.stats.cardGamesDrawn++,hero.stats.cardGamesPlayed++,hero.currency.cardDust+=3,UI.updateCurrencies(),UI.updateCardAlbum(),delete thisChallengeNPC.isPlayingCards,processSpeech(thisChallengeNPC,thisChallengeNPC.cardGameSpeech.draw[0],thisChallengeNPC.cardGameSpeech.draw[1]),closeCardGame()}function processPlayerWinSpeech(e,t,a){if(""!=a){var i=a.split("|"),n=i[1];questData[n].hasBeenCompleted<1?giveQuestRewards(n)&&(questData[n].isRepeatable>0?questData[n].hasBeenCompleted=0:questData[n].hasBeenCompleted=1,UI.showDialogue(e,e.cardGameSpeech.lose[0]+i[2]),canCloseDialogueBalloonNextClick=!0,checkForTitlesAwarded(n)):processSpeech(e,e.cardGameSpeech.lose[0],e.cardGameSpeech.lose[1])}else processSpeech(e,e.cardGameSpeech.lose[0],e.cardGameSpeech.lose[1])}function startCardGame(e){console.log(e.name),hero.cards.length>=12?(cardGameNameSpace.player2Cards=hero.cards.slice(0,12),cardGameNameSpace.player1Cards=e.uniqueCards.concat(allCardPacks[e.baseCardPack]).slice(0,12),cardGameNameSpace.player1Skill=e.cardSkill,e.cardBackId?cardGameNameSpace.NPCCardBackColour=e.cardBackId:cardGameNameSpace.NPCCardBackColour=void 0,cardGameNameSpace.initialiseCardGame(),cardGameWrapper.classList.add("active"),e.isPlayingCards=!0,audio.playMusic("card-game-NOT_MINE-Shuffle-or-Boogie")):UI.showNotification("<p>I don't have enough cards</p>")}function closeCardGame(){gameMode="play",audio.fadeOutMusic("card-game-NOT_MINE-Shuffle-or-Boogie",2.5),cardGameWrapper.classList.remove("active"),document.getElementById("cardGame").removeEventListener("click",cardGameNameSpace.canvasClick,!1)}function openBoosterPack(){var e;boosterCardsToAdd=[];do{e=getRandomInteger(1,cardGameNameSpace.allCardData.length),-1==boosterCardsToAdd.indexOf(e)&&boosterCardsToAdd.push(e)}while(boosterCardsToAdd.length<5);for(var t,a=document.getElementsByClassName("cardFlip"),i=0;i<a.length;i++)a[i].classList.remove("active");for(i=0;i<5;i++)t="",-1==hero.cards.indexOf(boosterCardsToAdd[i])&&(t=' class="new"'),boosterCardsToAdd[i]<0?document.getElementById("boosterCard"+i).innerHTML='<div class="rare"><div class="card players" style="background-image:url(/images/card-game/cards/'+boosterCardsToAdd[i]+'.png)"></div></div>':document.getElementById("boosterCard"+i).innerHTML="<img"+t+' src="/images/card-game/cards/'+boosterCardsToAdd[i]+'.png" alt="'+cardGameNameSpace.allCardData[boosterCardsToAdd[i][3]]+'">';boosterPack.classList.add("active"),boosterCardsRevealed=0,boosterPack.addEventListener("click",revealBoosterCard,!1)}function revealBoosterCard(e){"IMG"==e.target.nodeName&&(e.target.parentNode.parentNode.parentNode.classList.add("active"),++boosterCardsRevealed>=5&&(hero.cards=boosterCardsToAdd.concat(hero.cards),UI.updateCardAlbum(),boosterPack.classList.remove("active")))}function hnefataflPlayer2Concedes(){delete thisChallengeNPC.isPlayingCards,processSpeech(thisChallengeNPC,thisChallengeNPC.hnefataflSpeech.win[0],thisChallengeNPC.hnefataflSpeech.win[1]),closeHnefataflGame()}function hnefataflPlayer2Wins(){hero.stats.hnefataflGamesWon++,hero.stats.hnefataflGamesPlayed++,delete thisChallengeNPC.isPlayingCards,processHnefataflPlayerWinSpeech(thisChallengeNPC,thisChallengeNPC.hnefataflSpeech.lose[0],thisChallengeNPC.hnefataflSpeech.lose[1]),closeHnefataflGame()}function hnefataflPlayer1Wins(){hero.stats.hnefataflGamesLost++,hero.stats.hnefataflGamesPlayed++,delete thisChallengeNPC.isPlayingCards,processSpeech(thisChallengeNPC,thisChallengeNPC.hnefataflSpeech.win[0],thisChallengeNPC.hnefataflSpeech.win[1]),closeHnefataflGame()}function hnefataflIsDrawn(){hero.stats.hnefataflGamesDrawn++,hero.stats.hnefataflGamesPlayed++,delete thisChallengeNPC.isPlayingCards,processSpeech(thisChallengeNPC,thisChallengeNPC.hnefataflSpeech.draw[0],thisChallengeNPC.hnefataflSpeech.draw[1]),closeHnefataflGame()}function processHnefataflPlayerWinSpeech(e,t,a){if(""!=a){var i=a.split("|"),n=i[1];questData[n].hasBeenCompleted<1?giveQuestRewards(n)&&(questData[n].isRepeatable>0?questData[n].hasBeenCompleted=0:questData[n].hasBeenCompleted=1,UI.showDialogue(e,e.hnefataflSpeech.lose[0]+i[2]),canCloseDialogueBalloonNextClick=!0,checkForTitlesAwarded(n)):processSpeech(e,e.hnefataflSpeech.lose[0],e.hnefataflSpeech.lose[1])}else processSpeech(e,e.hnefataflSpeech.lose[0],e.hnefataflSpeech.lose[1])}function startHnefataflGame(e){console.log(e.name),hnefataflNameSpace.initialisehnefataflGame(),hnefataflGameWrapper.classList.add("active"),e.isPlayingCards=!0}function closeHnefataflGame(){gameMode="play",hnefataflGameWrapper.classList.remove("active"),document.getElementById("hnefataflGame").removeEventListener("click",hnefataflNameSpace.canvasClick,!1)}const Input={isUsingGamePad:!1,gamePad:null,gameLastPadTimeStamp:null,init:function(){document.addEventListener("keydown",function(e){Input.changeKey(e,1,"down")}),document.addEventListener("keyup",function(e){Input.changeKey(e,0,"up")}),(navigator.getGamepads||navigator.getGamepads())&&(window.addEventListener("gamepadconnected",function(){Input.isUsingGamePad=!0}),window.addEventListener("gamepaddisconnected",function(e){Input.isUsingGamePad=!1})),"ontouchstart"in document.documentElement&&Input.initTouchEvents()},changeKey:function(e,t,a){var i=document.activeElement.tagName,n=document.activeElement.hasAttribute("contenteditable");if("INPUT"!=i&&"TEXTAREA"!=i&&"SELECT"!=i&&!n)switch(e.keyCode){case KeyBindings.left:e.preventDefault(),key[0]=t;break;case KeyBindings.up:e.preventDefault(),key[2]=t;break;case KeyBindings.right:e.preventDefault(),key[1]=t;break;case KeyBindings.down:e.preventDefault(),key[3]=t;break;case KeyBindings.action:key[4]=0,"up"===a&&(key[4]=1),key[25]=t;break;case KeyBindings.shift:key[5]=t;break;case KeyBindings.challenge:key[6]=t;break;case KeyBindings.toggleUI:key[7]=t;break;case KeyBindings.toggleJournal:key[8]=t;break;case KeyBindings.toggleToolLeft:key[9]=t;break;case KeyBindings.toggleToolRight:key[10]=t;break;case KeyBindings.printScreen:key[11]=0,"up"===a&&(key[11]=1);break;case KeyBindings.escape:key[12]=t;break;case KeyBindings.cursorUp:key[13]=t;break;case KeyBindings.cursorDown:key[14]=t;break;case KeyBindings.cursorLeft:key[15]=t;break;case KeyBindings.cursorRight:key[16]=t;break;case KeyBindings.c:key[17]=0,e.preventDefault(),"up"===a&&(key[17]=1);break;case KeyBindings.d:key[18]=0,e.preventDefault(),"up"===a&&(key[18]=1);break;case KeyBindings.e:key[19]=0,e.preventDefault(),"up"===a&&(key[19]=1);break;case KeyBindings.f:key[20]=0,e.preventDefault(),"up"===a&&(key[20]=1);break;case KeyBindings.g:key[21]=0,e.preventDefault(),"up"===a&&(key[21]=1);break;case KeyBindings.a:key[22]=0,e.preventDefault(),"up"===a&&(key[22]=1);break;case KeyBindings.b:key[23]=0,e.preventDefault(),"up"===a&&(key[23]=1);break;case KeyBindings["c^"]:key[24]=0,e.preventDefault(),"up"===a&&(key[24]=1)}},initTouchEvents:function(){document.getElementById("touchTapAction").style.display="block",document.body.addEventListener("touchmove",function(e){e.touches.length>1||e.scale&&1!==e.scale||(e.preventDefault(),moveHeroTowards(e.touches[0].clientX,e.touches[0].clientY))},{passive:!1}),document.body.addEventListener("touchend",function(e){key[0]=!1,key[1]=!1,key[2]=!1,key[3]=!1,key[5]=!1},!1)}};function canAddItemToInventory(e){for(var t,a=JSON.parse(JSON.stringify(hero.inventory)),i=[],n=!0,o=0,r=[],s=[],c=[],l=0;l<e.length;l++)switch(e[l].type){case"$":o+=e[l].quantity;break;case"follower":r.push([e[l].id,e[l].name]);break;case"profession":s.push(e[l].id);break;default:"treasureMap"==currentActiveInventoryItems[e[l].type].action&&c.push(e[l].contains);var h=0,d=getObjectKeysForInnerValue(a,e[l].type,"type");if(d.length>0)for(var u=0;u<d.length;u++)if(!document.getElementById("slot"+d[u]).classList.contains("locked")&&itemAttributesMatch(a[d[u]],e[l])){var p=a[d[u]].quantity;if(h+=v=maxNumberOfItemsPerSlot-p>e[l].quantity-h?e[l].quantity-h:maxNumberOfItemsPerSlot-p,v>0&&(i.push(d[u]),a[d[u]].quantity+=v),h>=e[l].quantity)break}if(h<e[l].quantity)e:for(u=0;u<hero.bags.length;u++)for(var g=currentActiveInventoryItems[hero.bags[u].type].actionValue,m=0;m<g;m++){var v,f=u+"-"+m;if(!(f in a))if(h+=v=maxNumberOfItemsPerSlot>e[l].quantity-h?e[l].quantity-h:maxNumberOfItemsPerSlot,i.push(f),a[f]=JSON.parse(JSON.stringify(e[l])),a[f].hash=createItemHash(e[l].type,v),h>=e[l].quantity)break e}h!=e[l].quantity&&(n=!1)}if(n){if(hero.inventory=JSON.parse(JSON.stringify(a)),UI.updatePanelsAfterInventoryChange(),o>0&&(hero.currency.money+=o,UI.updateCurrencies(),audio.playSound(soundEffects.coins,0)),r.length>0)for(u=0;u<r.length;u++)UI.showNewFollower(r[u][0],r[u][1]),sendDataWithoutNeedingAResponse("/game-world/activateRetinueFollower.php?followerID="+r[u][0]),t='<li id="retinueFollower'+r[u][0]+'" class="available" data-locationx="200" data-locationy="350" data-activeonquest="-1"><div class="portrait"><img src="/images/retinue/'+r[u][0]+'.png" alt=""></div><h3>'+r[u][1]+"</h3><p>waiting for a quest</p></li>",retinueList.insertAdjacentHTML("beforeend",t);if(s.length>0)for(u=0;u<s.length;u++)-1==hero.professionsKnown.indexOf(s[u])&&(hero.professionsKnown.push(s[u]),UI.showNewProfession(s[u]));if(c.length>0)for(u=0;u<c.length;u++)UI.createTreasureMap(c[u]);return[!0,i]}return[!1]}function hasItemsInInventory(e){for(var t,a,i=!0,n=0;n<e.length;n++){void 0===e[n].quantity&&(e[n].quantity=1),t=0;var o=getObjectKeysForInnerValue(hero.inventory,e[n].type,"type");if(o.length>0)for(var r=0;r<o.length;r++){for(var s in a=!0,e[n])switch(s){case"quantity":break;case"durability":case"quality":case"effectiveness":hero.inventory[o[r]][s]<e[n][s]&&(a=!1);break;default:hero.inventory[o[r]][s]!=e[n][s]&&(a=!1)}a&&(t+=hero.inventory[o[r]].quantity)}t<e[n].quantity&&(i=!1)}return i}function findSlotItemIdInInventory(e){var t=[];for(var a in hero.inventory)hero.inventory[a].type==e&&t.push(a);return t}function hasItemTypeInInventory(e){var t=[];for(var a in hero.inventory)currentActiveInventoryItems[hero.inventory[a].type].group==e&&t.push(a);return t}function removeItemTypeFromInventory(e,t){if(void 0===t)t=1;var a,i=t,n=getObjectKeysForInnerValue(hero.inventory,parseInt(e),"type");if(n.length>0)for(var o=0;o<n.length;o++)(a=hero.inventory[n[o]].quantity)>i?(removeFromInventory(n[o],i),i=0):(removeFromInventory(n[o],a),i-=a)}function addToInventory(e,t,a=!1){hero.inventory[e]=JSON.parse(JSON.stringify(t)),(void 0===hero.inventory[e].hash||a)&&(hero.inventory[e].hash=createItemHash(t.type,t.quantity)),document.getElementById("slot"+e).innerHTML=generateSlotMarkup(e)}function removeFromInventory(e,t){var a=hero.inventory[e].quantity,i=document.getElementById("slot"+e);a-t>0?(hero.inventory[e].quantity-=t,updateQuantity(e)):(delete hero.inventory[e],i.innerHTML="")}function updateQuantity(e){for(var t=document.getElementById("slot"+e),a=0;a<t.childNodes.length;a++)"qty"==t.childNodes[a].className&&(t.childNodes[a].innerHTML=hero.inventory[e].quantity),"P"==t.childNodes[a].nodeName&&(t.childNodes[a].childNodes[2].innerHTML="Sell price: "+parseMoney(Math.ceil(hero.inventory[e].quantity*sellPriceModifier*inflationModifier*currentActiveInventoryItems[hero.inventory[e].type].priceCode,0)))}function itemAttributesMatch(e,t){return e.type==t.type&&e.quality==t.quality&&e.durability==t.durability&&e.currentWear==t.currentWear&&e.effectiveness==t.effectiveness&&e.colour==t.colour&&e.enchanted==t.enchanted&&e.hallmark==t.hallmark&&e.inscription.title==t.inscription.title&&e.inscription.content==t.inscription.content&&e.inscription.timeCreated==t.inscription.timeCreated&&e.contains==t.contains}function inventoryItemAction(e,t,a){var i,n=e.parentElement.id.substring(4),o=!0;if(void 0!==hero.inventory[n].cooldown&&hero.inventory[n].cooldownTimer>0&&(o=!1),hero.inventory[n].currentWear>=hero.inventory[n].durability&&(o=!1,UI.showNotification("<p>I need to repair this item first</p>")),o){for(var r=t.split(","),s=a.split(","),c=0;c<r.length;c++)switch(i=s[c],r[c]){case"container":if(void 0!==hero.inventory[n].contains)if(1==hero.inventory[n].contains.length&&1==hero.inventory[n].quantity)hero.inventory[n]=JSON.parse(JSON.stringify(hero.inventory[n].contains[0])),document.getElementById("slot"+n).innerHTML=generateSlotMarkup(n),UI.showChangeInInventory([n]);else{var l=JSON.parse(JSON.stringify(hero.inventory[n]));removeFromInventory(n,1);var h=canAddItemToInventory(l.contains);h[0]?(document.getElementById("slot"+n).innerHTML=generateSlotMarkup(n),UI.showChangeInInventory(h[1])):(hero.inventory[n]=JSON.parse(JSON.stringify(l)),UI.showNotification("<p>I don't have room for all of these items.</p>"))}break;case"booster":openBoosterPack(),removeFromInventory(n,1);break;case"treasureMap":UI.showTreasureMap(hero.inventory[n].contains);break;case"bag":UI.addNewBag(hero.inventory[n]),audio.playSound(soundEffects.bagOpen,0),removeFromInventory(n,1);break;case"home":var d=hero.inventory[n].additional.split("|");jumpToLocation(d[0],d[1],d[2]);break;case"pet":inventorySlotReference=n,checkAddPetToWorld();break;case"music":music.enterMusicMode(i);break;case"transcription":""==music.currentInstrument?UI.showNotification("<p>I haven't got an instrument equipped to play that</p>"):music.startplayBackTranscription(hero.inventory[n].inscription.content.slice(0));break;case"inscribe":UI.openInscriptionPanel();break;case"holdable":UI.holdItem(n);break;case"collection":if(hero.collections.hasOwnProperty(i)){var u=hero.collections[i].required.indexOf(hero.inventory[n].type);-1!=u&&(hero.collections[i].required[u]>0?(hero.collections[i].required[u]=0-hero.collections[i].required[u],document.getElementById(i+"-"+hero.inventory[n].type).classList.remove("notCollected"),removeFromInventory(n,1)):UI.showNotification("<p>I already have that in a collection</p>"))}break;case"catalogue":var p="catalogue"+hero.inventory[n].contains.catalogueName;if(document.getElementById(p))document.getElementById(p).classList.add("active"),audio.playSound(soundEffects.bookOpen,0);else{var g={ids:hero.inventory[n].contains.required,complete:!1};hero.catalogues[hero.inventory[n].contains.catalogueName]=g,getCatalogueMarkup(hero.inventory[n].contains.required.join("|"),hero.inventory[n].contains.catalogueName)}break;case"card":hero.cards.unshift(hero.inventory[n].contains),UI.updateCardAlbum(),removeFromInventory(n,1);break;case"cardBack":hero.cardBacks.unshift(0-hero.inventory[n].contains["ugc-id"]),UI.updateCardAlbum(),removeFromInventory(n,1);break;case"questSet":questData[i].isUnderway||(questData[i].isUnderway=!0,addToJournal(i));break;case"book":if(""!=hero.inventory[n].inscription&&(document.getElementById("book"+i).classList.add("active"),audio.playSound(soundEffects.bookOpen,0),"object"==typeof hero.inventory[n].additional))for(var m in hero.inventory[n].additional)switch(m){case"quest":canOpenQuest(hero.inventory[n].additional[m])&&openQuest(hero.inventory[n].additional[m]);break;case"recipe":canLearnRecipe(hero.inventory[n].additional[m])?UI.showNotification("<p>I learned a new recipe</p>"):UI.showNotification("<p>I already know that&hellip;</p>");break;case"collection-quest":var v=hero.inventory[n].additional[m].zoneName;console.log(hero.inventory[n].additional[m]),hero.collections.hasOwnProperty(v)||(hero.collections[v]={},hero.collections[v].required=hero.inventory[n].additional[m].required,hero.collections[v].complete=!1,UI.initiateCollectionQuestPanel(v))}break;case"recipe":canLearnRecipe(hero.inventory[n].contains)?(removeFromInventory(n,1),UI.showNotification("<p>I learned a new recipe</p>")):UI.showNotification("<p>I already know that&hellip;</p>");break;case"craft":-1!=hero.professionsKnown.indexOf(parseInt(i))?(audio.playSound(soundEffects.buttonClick,0),UI.populateRecipeList(i,hero.inventory[n].quality)):UI.showNotification("<p>I don't know this profession yet.</p>");break;case"deed":if(isOverWorldMap)if(hero.housing.hasAPlayerHouse)UI.showNotification("<p>I already have a house&hellip;</p>");else if(hasItemsInInventory([{type:86}])){var f=i.split("x");plotPlacement.width=f[0],plotPlacement.length=f[1],plotPlacement.whichType=hero.inventory[n].type,activeAction="plotPlacement",document.addEventListener("mousemove",UI.movePlotPlacementOverlay,!1),document.addEventListener("click",placePlotPlacement,!1)}else UI.showNotification("<p>I need to buy a housing tool first</p>");else UI.showNotification("<p>I can't do that indoors&hellip;</p>");break;case"house":hero.housing.hasAPlayerHouse?UI.openHousingPanel():UI.showNotification("<p>I don't have a house yet&hellip;</p>")}void 0!==hero.inventory[n]&&void 0!==hero.inventory[n].cooldown&&(hero.inventory[n].cooldownTimer=hero.inventory[n].cooldown)}}function additionalTooltipDetail(e){var t="";switch(currentActiveInventoryItems[e.type].action){case"recipe":for(var a=!1,i=0;i<hero.recipesKnown.length;i++)hero.recipesKnown[i]==e.contains&&(a=!0);a&&(t+=" (already known)");break;case"collection":a=!1;var n=currentActiveInventoryItems[e.type].actionValue;if(hero.collections.hasOwnProperty(n)){var o=hero.collections[n].required.indexOf(e.type);-1!=o?hero.collections[n].required[o]>0&&(t+=" (needed for an active collection - double click to add)"):t+=" (already added to a collection)"}}return t}function generateGenericSlotMarkup(e){var t="",a="",i="",n="",o=getColourName(e.colour,e.type);""!=o&&(a=o+" ",i="-"+o.toLowerCase());var r=currentActiveInventoryItems[e.type].action,s=!1,c=!1,l=!1,h="",d="";r&&e.inscription.content&&(-1!=r.indexOf("book")&&(s=!0,l=!0),"transcription"==r&&(l=!0));var u=!1;1==currentActiveInventoryItems[e.type].holdable&&(u=!0);var p="";if(r)if(s){var g,m=generateHash(e.inscription.title+e.colour+e.type+e.inscription.timeCreated);g=-1==r.indexOf(",")?m:currentActiveInventoryItems[e.type].actionValue.replace("?",m),p='data-action="'+r+'" data-action-value="'+g+'" ',UI.buildBook(e,m)}else p='data-action="'+r+'" data-action-value="'+currentActiveInventoryItems[e.type].actionValue+'" ';u&&(p='data-action="holdable" data-action-value="'+currentActiveInventoryItems[e.type].action+'" ');for(var v=currentActiveInventoryItems[e.type].category.split(","),f=0;f<v.length;f++)n+="itemCategory"+v[f]+" ";if("card"==currentActiveInventoryItems[e.type].action){c=!0,n+="players card";var y=e.contains;y<0&&(y=Math.abs(y),h="-rare",d="rare ")}var I,b=!1;if(void 0!==e.contains&&void 0!==e.contains["ugc-id"]&&(b=!0),b?(t+='<img src="/images/user-generated/'+e.contains["ugc-id"]+'-slot.png" '+p+'alt="'+a+currentActiveInventoryItems[e.type].shortname+'" class="'+n+'">',I=void 0!==e.contains["ugc-title"]?e.contains["ugc-title"]:currentActiveInventoryItems[e.type].description):c?(I="A "+d+"'"+cardGameNameSpace.allCardData[y][2]+"' totem card",t+='<img src="/images/card-game/inventory-items/'+y+h+'.png" '+p+'alt="'+a+currentActiveInventoryItems[e.type].shortname+'" class="'+n+'">'):(t+='<img src="/images/game-world/inventory-items/'+e.type+i+'.png" '+p+'alt="'+a+currentActiveInventoryItems[e.type].shortname+'" class="'+n+'">',I=l?"&quot;"+e.inscription.title+"&quot;":currentActiveInventoryItems[e.type].description),-1!=I.indexOf("##contains##")&&void 0!==e.contains){var M="";for(f=0;f<e.contains.length;f++)0!=f&&(M+=", "),M+=e.contains[f].quantity+"x "+currentActiveInventoryItems[e.contains[f].type].shortname;I=I.replace("##contains##","Contains: "+M)}var w=currentActiveInventoryItems[e.type].shortname;return"recipe"==currentActiveInventoryItems[e.type].action&&(w=allRecipes[e.contains][0]+" "+w,I+=" (for the "+allRecipes[e.contains][1]+" profession)."),t+="<p><em>"+a+w+" </em>"+I+" ",t+='<span class="price">Sell price: '+parseMoney(Math.ceil(e.quantity*sellPriceModifier*inflationModifier*currentActiveInventoryItems[e.type].priceCode,0))+"</span>",t+='<span class="price specialismPrice">Sell price: '+parseMoney(Math.ceil(e.quantity*sellPriceSpecialismModifier*inflationModifier*currentActiveInventoryItems[e.type].priceCode,0))+"</span>",t+=additionalTooltipDetail(e)+"</p>",t+=addGauge(e),t+='<span class="qty">'+e.quantity+"</span>"}function generateSlotMarkup(e){return generateGenericSlotMarkup(hero.inventory[e])+'<div class="coolDown"></div><div class="lockedOverlay" id="lockedOverlay'+e+'"></div>'}function inventorySplitStackSubmit(e){e&&e.preventDefault();var t=splitStackInput.value,a=!0;if((t=parseInt(t))<1&&(a=!1),Number.isInteger(t)||(a=!1),t>hero.inventory[UI.sourceSlot].quantity&&(a=!1),a){isSplitStackBeingDragged=!0;var i=document.getElementById("slot"+UI.sourceSlot);UI.activeDragObject=document.getElementById("draggableInventorySlot"),UI.activeDragObject.innerHTML=i.innerHTML,removeFromInventory(UI.sourceSlot,t),UI.draggedInventoryObject.quantity=t;for(var n=0;n<UI.activeDragObject.childNodes.length;n++)if("qty"==UI.activeDragObject.childNodes[n].className){UI.activeDragObject.childNodes[n].innerHTML=UI.draggedInventoryObject.quantity;break}UI.inDrag=!0;var o=i.getBoundingClientRect(),r=(window.pageYOffset||document.documentElement.scrollTop)-(document.documentElement.clientTop||0);objInitLeft=o.left+3,objInitTop=o.top+3+r,dragStartX=objInitLeft+22,dragStartY=objInitTop+22,UI.activeDragObject.style.cssText="z-index:4;top: "+objInitTop+"px; left: "+objInitLeft+"px; transform: translate(0px, 0px);",document.addEventListener("mousemove",UI.handleDrag,!1),document.addEventListener("mouseup",UI.endInventoryDrag,!1)}splitStackPanel.classList.remove("active"),document.activeElement.blur()}function inventorySplitStackCancel(){splitStackPanel.classList.remove("active"),document.activeElement.blur()}function prepareInventoryObject(e){var t={type:"$",quantity:1,quality:100,durability:100,currentWear:0,effectiveness:100,colour:0,enchanted:0,hallmark:0,inscription:""};for(var a in e)t[a]=e[a];return t}function createItemHash(e,t){return""+e+t+characterId+Date.now()}function findSlotByHash(e){var t=-1;for(var a in hero.inventory)if(hero.inventory[a].hash==e){t=a;break}return t}function addGauge(e){var t="";if(currentActiveInventoryItems[e.type].holdable>0&&void 0!==e.contains){var a=e.contains[0].quantity/parseInt(currentActiveInventoryItems[e.type].actionValue)*100;t+='<span class="gauge gauge'+currentActiveInventoryItems[e.contains[0].type].shortname+'"><span style="width:'+a+'%"></span></span>'}return t}function updateGauge(e){var t=hero.inventory[e].contains[0].quantity/parseInt(currentActiveInventoryItems[hero.inventory[e].type].actionValue)*100;document.getElementById("slot"+e).querySelector(".gauge span").style.width=t+"%"}function reducedHeldQuantity(e){hero.inventory[e].quantity--,0==hero.inventory[e].quantity&&(hero.holding.hash="",hero.holding.type="",delete hero.inventory[e],document.getElementById("slot"+e).innerHTML="")}var KeyBindings={left:65,right:68,up:87,down:83,pause:80,action:17,shift:16,ctrl:17,challenge:67,toggleUI:9,toggleJournal:81,toggleToolLeft:219,toggleToolRight:221,printScreen:44,escape:27,cursorUp:38,cursorDown:40,cursorLeft:37,cursorRight:39,c:49,d:50,e:51,f:52,g:53,a:54,b:55,"c^":56};if(window.Worker){var lightMapWorker=new Worker("/js/worker-lightmap.js");lightMapWorker.onmessage=function(e){lightMap=e.data}}function updateLightMap(){lightMapWorker.postMessage([thisMapData,hero.tileX,hero.tileY,hero.lineOfSightRange,lightMap])}const music={currentInstrument:"",isTranscribing:!0,currentTranscriptionStartTime:"",currentTranscription:[],isPlayingBackTranscription:!1,activePlayBackTranscription:[],playbackTranscriptionStartTime:"",notesToLoad:["c3-a","c3-as","c3-b","c3-c","c3-cs","c3-d","c3-ds","c3-e","c3-f","c3-fs","c3-g","c3-gs","c4-a","c4-as","c4-b","c4-c","c4-cs","c4-d","c4-ds","c4-e","c4-f","c4-fs","c4-g","c4-gs","c5-a","c5-as","c5-b","c5-c","c5-cs","c5-d","c5-ds","c5-e","c5-f","c5-fs","c5-g","c5-gs","c6-c"],loadInstrumentSounds:function(e){for(var t=0;t<music.notesToLoad.length;t++)loadAudioBuffer("../music/instruments/"+e+"/"+music.notesToLoad[t]+".mp3",e+"-"+music.notesToLoad[t])},enterMusicMode:function(e){music.currentInstrument=e},exitMusicMode:function(){music.currentInstrument="",music.isTranscribing&&music.stopTranscription(),music.isPlayingBackTranscription=!1},playCurrentInstrumentNote:function(e){music.isTranscribing&&(-1==music.currentTranscriptionStartTime&&(music.currentTranscriptionStartTime=performance.now()),music.currentTranscription.push([performance.now()-music.currentTranscriptionStartTime,e])),audio.playSound(soundEffects[music.currentInstrument+"-"+e],0)},checkKeyPresses:function(){var e=4;key[5]&&(e=3),key[25]&&(e=5),key[17]&&(music.playCurrentInstrumentNote("c"+e+"-c"),key[17]=0),key[18]&&(music.playCurrentInstrumentNote("c"+e+"-d"),key[18]=0),key[19]&&(music.playCurrentInstrumentNote("c"+e+"-e"),key[19]=0),key[20]&&(music.playCurrentInstrumentNote("c"+e+"-f"),key[20]=0),key[21]&&(music.playCurrentInstrumentNote("c"+e+"-g"),key[21]=0),key[22]&&(music.playCurrentInstrumentNote("c"+e+"-a"),key[22]=0),key[23]&&(music.playCurrentInstrumentNote("c"+e+"-b"),key[23]=0),key[24]&&(music.playCurrentInstrumentNote("c"+(e+1)+"-c"),key[24]=0)},startTranscription:function(){music.currentTranscription=[],music.isTranscribing=!0,music.currentTranscriptionStartTime=-1},stopTranscription:function(){if(music.isTranscribing=!1,music.currentTranscription.length>0){var e={type:114,inscription:{title:transcriptionTitle.value,timeCreated:Date.now(),content:music.currentTranscription}};if(e=prepareInventoryObject(e),(inventoryCheck=canAddItemToInventory([e]))[0])UI.showChangeInInventory(inventoryCheck[1]);else{sendNPCPost('{"subject":"'+("Your transcription of '"+transcriptionTitle.value+"'")+'","message":"Beautifully composed","senderID":"-1","recipientID":"'+characterId+'","fromName":"Taliesin the bard"}',[e]),UI.showNotification("<p>My transcription is in the post</p>")}postData("/game-world/generateTranscriptionObject.php","chr="+characterId+"&transcription="+JSON.stringify(e.inscription))}},startplayBackTranscription:function(e){music.playbackTranscriptionStartTime=performance.now(),music.activePlayBackTranscription=e,music.isPlayingBackTranscription=!0,music.isTranscribing=!1},playBackTranscription:function(){music.activePlayBackTranscription.length>0?performance.now()-music.playbackTranscriptionStartTime>=music.activePlayBackTranscription[0][0]&&(music.playCurrentInstrumentNote(music.activePlayBackTranscription[0][1]),music.activePlayBackTranscription.shift()):music.isPlayingBackTranscription=!1}};if(window.Worker){var pathfindingWorker=new Worker("/js/worker-pathfinding.js");pathfindingWorker.onmessage=function(e){var t=e.data[0];if("pet"==t){var a=hero.allPets[hero.activePets[e.data[1]]];a.foundPath=e.data[2],"-,pathEnd"==a.foundPath.join()?(a.state="waiting",a.foundPath=""):(a.pathIndex=1,a.state="moving",a.facing=e.data[2][0])}else{for(var i=null,n=0;n<visibleMaps.length;n++)for(var o=0;o<thisMapData[visibleMaps[n]].npcs.length;o++)thisMapData[visibleMaps[n]].npcs[o].uniqueIndex==t&&(i=thisMapData[visibleMaps[n]].npcs[o]);null!=i&&(i.movement.splice.apply(i.movement,[i.movementIndex+2,0].concat(e.data[1])),i.waitingForAPath=!1,void 0!==e.data[2]&&(i.lastTargetDestination=e.data[2]))}}}function isAPetTerrainCollision(e,t,a){var i=getTileX(t),n=getTileY(a),o=getLocalCoordinatesX(i),r=getLocalCoordinatesX(n),s=findMapNumberFromGlobalCoordinates(i,n);if(void 0===thisMapData[s].collisions[r])return 1;if(void 0===thisMapData[s].collisions[r][o])return 1;switch(thisMapData[s].collisions[r][o]){case 1:return 1;case"<":case">":case"^":case"v":return 0;case"d":return""!=mapTransition&&(e.state="door"),0;default:return 0}}function movePet(){if(hasActivePet)for(var e,t,a,i,n,o,r,s,c,l=0;l<hero.activePets.length;l++){switch(a=(r=hero.allPets[hero.activePets[l]]).following,s=!1,r.state){case"door":switch(r.facing){case"n":r.y-=r.speed;break;case"s":r.y+=r.speed;break;case"w":r.x-=r.speed;break;case"e":r.x+=r.speed}break;case"moving":switch(n=r.x,o=r.y,r.drawnFacing=r.facing,r.facing){case"n":if(r.y-=r.speed,isAPetTerrainCollision(r,r.x-r.width/2,r.y-r.length/2)||isAPetTerrainCollision(r,r.x+r.width/2,r.y-r.length/2)){var h=(getTileY(r.y-r.length/2)+1)*tileW;r.y=h+r.heilengthght/2+1}break;case"s":if(r.y+=r.speed,isAPetTerrainCollision(r,r.x-r.width/2,r.y+r.length/2)||isAPetTerrainCollision(r,r.x+r.width/2,r.y+r.length/2)){var d=getTileY(r.y+r.length/2)*tileW;r.y=d-r.length/2-1}break;case"w":if(r.x-=r.speed,isAPetTerrainCollision(r,r.x-r.width/2,r.y+r.length/2)||isAPetTerrainCollision(r,r.x-r.width/2,r.y-r.length/2)){var u=(getTileX(r.x-r.width/2)+1)*tileW;r.x=u+r.width/2+1}break;case"e":if(r.x+=r.speed,isAPetTerrainCollision(r,r.x+r.width/2,r.y+r.length/2)||isAPetTerrainCollision(r,r.x+r.width/2,r.y-r.length/2)){var p=getTileX(r.x+r.width/2)*tileW;r.x=p-r.width/2-1}}for(var g=0;g<hero.activePets.length;g++)l!=g&&(i=hero.allPets[hero.activePets[g]],isAnObjectCollision(r.x,r.y,r.width,r.length,i.x,i.y,i.width,i.length)&&(r.x=n,r.y=o,i.state="moving",i.facing=r.facing));for(var m=0;m<visibleMaps.length;m++){for(g=0;g<thisMapData[visibleMaps[m]].npcs.length;g++)(e=thisMapData[visibleMaps[m]].npcs[g]).isCollidable&&isAnObjectCollision(r.x,r.y,r.width,r.length,e.x,e.y,e.width,e.length)&&(r.x=n,r.y=o);if(void 0!==thisMapData[visibleMaps[m]].innerDoors)for(var v in thisMapData[visibleMaps[m]].innerDoors)(c=thisMapData[visibleMaps[m]].innerDoors[v]).isOpen||isAnObjectCollision(getTileCentreCoordX(c.tileX),getTileCentreCoordY(c.tileY),tileW,tileW,r.x,r.y,r.width,r.length)&&(r.x=n,r.y=o);for(g=0;g<thisMapData[visibleMaps[m]].items.length;g++)(t=thisMapData[visibleMaps[m]].items[g]).isCollidable&&isAnObjectCollision(r.x,r.y,r.width,r.length,t.x,t.y,t.width,t.length)&&(r.x=n,r.y=o)}r.dx+=r.x-n,r.dy+=r.y-o,Math.abs(r.dx)>=tileW&&(r.dx>0?r.dx-=tileW:r.dx+=tileW,s=!0),Math.abs(r.dy)>=tileW&&(r.dy>0?r.dy-=tileW:r.dy+=tileW,s=!0);break;case"findingPath":break;case"queuing":if(!isInRange(a.x,a.y,r.x,r.y,2*tileW)){switch(n=r.x,o=r.y,r.drawnFacing=r.facing,r.facing){case"n":r.y-=r.speed;break;case"s":r.y+=r.speed;break;case"w":r.x-=r.speed;break;case"e":r.x+=r.speed}for(g=0;g<hero.activePets.length;g++)l!=g&&(i=hero.allPets[hero.activePets[g]],isAnObjectCollision(r.x,r.y,r.width,r.length,i.x,i.y,i.width,i.length)&&(r.x=n,r.y=o));for(m=0;m<visibleMaps.length;m++){for(g=0;g<thisMapData[visibleMaps[m]].npcs.length;g++)(e=thisMapData[visibleMaps[m]].npcs[g]).isCollidable&&isAnObjectCollision(r.x,r.y,r.width,r.length,e.x,e.y,e.width,e.length)&&(r.x=n,r.y=o);for(g=0;g<thisMapData[visibleMaps[m]].items.length;g++)t=thisMapData[visibleMaps[m]].items[g],isAnObjectCollision(r.x,r.y,r.width,r.length,t.x,t.y,t.width,t.length)&&(r.x=n,r.y=o)}r.dx+=r.x-n,r.dy+=r.y-o,Math.abs(r.dx)>=tileW&&(r.dx>0?r.dx-=tileW:r.dx+=tileW,s=!0),Math.abs(r.dy)>=tileW&&(r.dy>0?r.dy-=tileW:r.dy+=tileW,s=!0),s&&(r.tileX=getTileX(r.x),r.tileY=getTileY(r.y),(r.tileX<0||r.tileY<0||r.tileX>=mapTilesX||r.tileY>=mapTilesY)&&(s=!1))}break;default:isInRange(a.x,a.y,r.x,r.y,4*tileW)||(r.state="moving")}if(s)if(r.tileX=getTileX(r.x),r.tileY=getTileY(r.y),r.breadcrumb.pop(),r.breadcrumb.unshift([r.tileX,r.tileY]),isInRange(a.x,a.y,r.x,r.y,2*tileW))r.state="wait";else{var f=!1;for(v=0;v<a.breadcrumb.length;v++)if(r.tileY==a.breadcrumb[v][1]){if(r.tileX-1==a.breadcrumb[v][0]){r.facing="w",f=!0;break}if(r.tileX+1==a.breadcrumb[v][0]){r.facing="e",f=!0;break}}else if(r.tileX==a.breadcrumb[v][0]){if(r.tileY+1==a.breadcrumb[v][1]){r.facing="s",f=!0;break}if(r.tileY-1==a.breadcrumb[v][1]){r.facing="n",f=!0;break}}f?(r.state="moving",r.foundPath=""):""!=r.foundPath?(r.facing=r.foundPath[r.pathIndex],r.pathIndex++,r.pathIndex>=r.foundPath.length&&(pathfindingWorker.postMessage(["petToHero",hero.allPets[hero.activePets[l]],thisMapData,a.tileX,a.tileY,l,visibleMaps,isOverWorldMap]),r.state="findingPath",r.foundPath="")):"findingPath"!=r.state&&(pathfindingWorker.postMessage(["petToHero",hero.allPets[hero.activePets[l]],thisMapData,a.tileX,a.tileY,l,visibleMaps,isOverWorldMap]),r.state="findingPath")}checkForSlopes(r)}}function isPetBlocked(e,t){var a=!1;switch(t){case"n":isAPetTerrainCollision(e,getTileCentreCoordX(e.tileX),getTileCentreCoordY(e.tileY-1))&&(a=!0);break;case"s":isAPetTerrainCollision(e,getTileCentreCoordX(e.tileX),getTileCentreCoordY(e.tileY+1))&&(a=!0);break;case"e":isAPetTerrainCollision(e,getTileCentreCoordX(e.tileX+1),getTileCentreCoordY(e.tileY))&&(a=!0);break;case"w":isAPetTerrainCollision(e,getTileCentreCoordX(e.tileX-1),getTileCentreCoordY(e.tileY))&&(a=!0)}return a}function pushPetAway(e){var t=hero.allPets[hero.activePets[e]];if(isPetBlocked(t,hero.facing)){var a=[];switch(hero.facing){case"n":case"s":a=["e","w"];break;case"w":case"e":a=["n","s"]}isPetBlocked(t,a[0])?isPetBlocked(t,a[1])?t.state="wait":(t.state="moving",t.facing=a[1]):(t.state="moving",t.facing=a[0])}else t.state="moving",t.facing=hero.facing}function addToJournal(e){getJSON("/game-world/getQuestJournalEntries.php?chr="+characterId+"&questID="+e,function(e){UI.addToQuestJournal(e)},function(t){addToJournal(e)})}function removeFromJournal(e){var t=document.getElementById("quest"+e);t&&t.remove()}function declineQuest(){acceptQuestChoice.classList.remove("active"),processSpeech(questResponseNPC,questResponseNPC.speech[questResponseNPC.speechIndex][4],questResponseNPC.speech[questResponseNPC.speechIndex][5],!1),canCloseDialogueBalloonNextClick=!0,questResponseNPC=null}function acceptQuest(){acceptQuestChoice.classList.remove("active"),processSpeech(questResponseNPC,questResponseNPC.speech[questResponseNPC.speechIndex][6],questResponseNPC.speech[questResponseNPC.speechIndex][7],!1),openQuest(questResponseNPC.speech[questResponseNPC.speechIndex][2]),canCloseDialogueBalloonNextClick=!0,questResponseNPC=null}function canOpenQuest(e){return!(questData[e].isUnderway||"0"!=questData[e].hasBeenCompleted&&"1"!=questData[e].isRepeatable)}function openQuest(e){var t=!0;if(questData[e].startItemsReceived){for(var a=questData[e].startItemsReceived,i=[],n=0;n<a.length;n++){var o=prepareInventoryObject(a[n]);i.push(o)}(inventoryCheck=canAddItemToInventory(i))[0]?UI.showChangeInInventory(inventoryCheck[1]):t=!1}if(t){switch(questData[e].whatIsRequiredForCompletion){case"possess":case"give":case"":break;case"multi":for(var r=questData[e].subQuestsRequiredForCompletion.split(","),s=0;s<r.length;s++){switch(questData[r[s]].whatIsRequiredForCompletion){case"possess":case"give":case"":case"world":break;default:questData[r[s]].valueAtQuestStart=accessDynamicVariable(questData[r[s]].whatIsRequiredForCompletion)}questData[r[s]].isUnderway=!0}break;case"world":break;default:questData[e].valueAtQuestStart=accessDynamicVariable(questData[e].whatIsRequiredForCompletion)}questData[e].isUnderway=!0,addToJournal(e)}}function checkForEscortQuestEnd(e){var t=e.speech[e.speechIndex][3].split("|"),a=getTileCentreCoordX(t[0]),i=getTileCentreCoordY(t[1]);if(isInRange(e.x,e.y,a,i,t[2]*tileW)){e.drawnFacing=turntoFace(e,hero);for(var n=0;n<hero.npcsFollowing.length;n++)if(hero.npcsFollowing[n]===e){hero.npcsFollowing.splice(n,1);break}fae.targetX=e.x,fae.targetY=e.y,fae.currentState="away",e.isMoving=!1,e.movementIndex--,e.forceNewMovementCheck=!1,e.hasCompletedEscortQuest=!0,delete e.following}}function closeQuest(e,t){giveQuestRewards(e,t),questData[t].isRepeatable>0?questData[t].hasBeenCompleted=!1:(questData[t].hasBeenCompleted=!0,e.speech.splice(e.speechIndex,1),e.speechIndex--),questData[t].isUnderway=!1,checkForTitlesAwarded(t),audio.playSound(soundEffects.questComplete,0),removeFromJournal(t)}function giveQuestRewards(e,t){questData[t].itemsReceivedOnCompletion&&awardQuestRewards(e,questData[t].itemsReceivedOnCompletion,!1)}function awardQuestRewards(e,t,a){for(var i=[],n=0;n<t.length;n++){var o=t[n],r=o;if("follower"!=o.type){r=prepareInventoryObject(o);var s=o.type.toString().split("/");r.type=parseInt(getRandomElementFromArray(s))}isNaN(r.type)||(thisSpeech=thisSpeech.replace(/##itemName##/i,currentActiveInventoryItems[parseInt(r.type)].shortname)),i.push(r)}if((inventoryCheck=canAddItemToInventory(i))[0])UI.showChangeInInventory(inventoryCheck[1]);else{var c=e.speech[e.speechIndex][0].split("|");if(a)var l=e.speech[e.speechIndex][2].replace(/-/g," ")+" collection";else{var h=e.speech[e.speechIndex][2];l=questData[h].journalTitle}var d=c[2];sendNPCPost('{"subject":"'+l+'","message":"'+(d=d.replace(/##itemName##/i,currentActiveInventoryItems[parseInt(i[0].type)].shortname))+'","senderID":"-1","recipientID":"'+characterId+'","fromName":"'+e.name+'"}',i),UI.showNotification("<p>My reward will be sent in the post</p>")}}function getRetinueQuestTime(e,t,a,i,n){var o=getPythagorasDistance(e,t,a,i);1==n&&(o+=getPythagorasDistance(retinueBaseLocationX,retinueBaseLocationY,a,i));var r=Math.floor(60*o%60),s=Math.floor(o%60),c=Math.floor(o/60%24),l=Math.floor(o/1440);return[o,l>1?l+" days":1==l?"1 day":c>1?c+" hours":1==c?"1 hour":s>1?s+" minutes":1==s?"1 minute":r+" seconds"]}function retinueMissionCompleted(e,t){getJSON("/game-world/getRetinueRewards.php?id="+e+"&chr="+characterId,function(a){if("null"!=a.item)if((inventoryCheck=canAddItemToInventory(a.item))[0])UI.showChangeInInventory(inventoryCheck[1]);else{sendNPCPost('{"subject":"'+("Reward for "+document.getElementById("retinueComplete"+e).getAttribute("data-questname"))+'","message":"Your followers continue to make you proud...","senderID":"-1","recipientID":"'+characterId+'","fromName":"Retinue co-ordinator"}',a.item),UI.showNotification("<p>My reward will be sent in the post</p>")}if(t){hero.stats.retinueExplorationMissionsCompleted++;var i,n=document.getElementById("undiscovered_"+a.explored),o=a.explored.split("_");hero.retinueMapAreasRevealed.push(o[0]+","+o[1]),saveGame();for(var r=-1;r<=1;r++)for(var s=-1;s<=1;s++)(i=document.getElementById("undiscovered_"+(parseInt(o[0])+r)+"_"+(parseInt(o[1])+s)))&&i.classList.add("explorable");getJSON("/game-world/generateRetinueQuest.php?forceHex="+o[0]+"_"+o[1]+"&isAjaxRequest=true",function(e){retinueAvailableQuestMap.insertAdjacentHTML("beforeend",e.mapPin),retinueDetailWrapper.insertAdjacentHTML("beforeend",e.panelMarkup)},function(e){}),n.classList.remove("explorable"),n.classList.add("explored")}else hero.stats.retinueMissionsCompleted++;var c,l=a.followerIds.split(","),h=a.endLocationX/700*100,d=a.endLocationY/450*100;for(r=0;r<l.length;r++)(c=document.getElementById("retinueFollower"+l[r])).classList.add("available"),document.getElementById("followerLocation"+l[r]).style.cssText="left: "+h+"%; top: "+d+"%;",document.getElementById("followerLocationTooltip"+l[r]).style.cssText="left: "+h+"%; top: "+d+"%;",c.setAttribute("data-locationx",a.endLocationX),c.setAttribute("data-locationy",a.endLocationY),c.removeAttribute("data-activeonquest"),document.querySelector("#retinueFollower"+l[r]+" p").innerHTML="waiting for a quest",c.classList.contains("hired")&&document.getElementById("retinueFollowerRehire"+l[r]).classList.add("active");document.getElementById("retinueComplete"+e).classList.remove("active"),sendDataWithoutNeedingAResponse("/game-world/gotRetinueRewards.php?id="+e+"&newLocationX="+a.endLocationX+"&newLocationY="+a.endLocationY)},function(t){retinueMissionCompleted(e)})}function hireNewFollower(){if(hero.currency.money>=costToRehireFollower){hero.currency.money-=costToRehireFollower,UI.updateCurrencies(),audio.playSound(soundEffects.coins,0);for(var e,t=hireRetinueFollowerPanel.getAttribute("data-NPC"),a=null,i=0;i<visibleMaps.length;i++)for(var n=0;n<thisMapData[visibleMaps[i]].npcs.length;n++)(e=thisMapData[visibleMaps[i]].npcs[n]).uniqueIndex==t&&(a=e);if(null!==a){a.speech.splice(a.speechIndex,1),sendDataWithoutNeedingAResponse("/game-world/activateRetinueFollower.php?followerID="+a.followerId);var o='<li id="retinueFollower'+a.followerId+'" class="available" data-locationx="200" data-locationy="350" data-activeonquest="-1"><div class="portrait"><img src="/images/retinue/'+a.followerId+'.png" alt=""></div><h3>'+a.name+"</h3><p>waiting for a quest</p></li>";retinueList.insertAdjacentHTML("beforeend",o)}}else UI.showNotification("<p>I haven't got enough money</p>");UI.closeHireFollowerPanel()}function getLocalCoordinatesX(e){return e%worldMapTileLength}function getLocalCoordinatesY(e){return e%worldMapTileLength}function findMapNumberFromGlobalCoordinates(e,t){return worldMap[Math.floor(t/worldMapTileLength)][Math.floor(e/worldMapTileLength)]}var getJSON=function(e,t,a){var i="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");i.open("get",e,!0),i.onreadystatechange=function(){var e,n;if(4==i.readyState){var o=!0;if(200==(e=i.status)){try{n=JSON.parse(i.responseText)}catch(t){o=!1,a&&a(e)}o&&t&&t(n)}else a&&a(e)}},i.send()};const recipeSearch=document.getElementById("recipeSearch"),clearRecipeSearch=document.getElementById("clearRecipeSearch"),recipeFilter=document.getElementById("recipeFilter"),splitStackInput=document.getElementById("splitStackInput"),splitStackPanel=document.getElementById("splitStackPanel"),shopSplitStackInput=document.getElementById("shopSplitStackInput"),shopSplitStackPanel=document.getElementById("shopSplitStackPanel"),craftingRecipeCreateButton=document.getElementById("craftingRecipeCreateButton"),craftingPanel=document.getElementById("craftingPanel"),craftingSelectComponentsPanel=document.getElementById("craftingSelectComponentsPanel"),selectComponentsItemBeingCreated=document.getElementById("selectComponentsItemBeingCreated"),componentsAvailableForThisRecipe=document.getElementById("componentsAvailableForThisRecipe"),displayItemBeingCreated=document.getElementById("displayItemBeingCreated"),booksAndParchments=document.getElementById("booksAndParchments"),gameWrapper=document.getElementById("gameWrapper"),inventoryPanels=document.getElementById("inventoryPanels"),inventoryBank=document.getElementById("inventoryBank"),inventoryBankTitle=document.getElementById("inventoryBankTitle"),bankCurrency=document.getElementById("bankCurrency"),shopPanel=document.getElementById("shopPanel"),workshopPanel=document.getElementById("workshopPanel"),inscriptionPanel=document.getElementById("inscriptionPanel"),inscriptionTextArea=document.getElementById("inscriptionTextArea"),sourceSelection=document.getElementById("sourceSelection"),materialsSelection=document.getElementById("materialsSelection"),inkSelection=document.getElementById("inkSelection"),originalText=document.getElementById("originalText"),scribeCopyText=document.getElementById("scribeCopyText"),scribeOriginalText=document.getElementById("scribeOriginalText"),scribeStartInscription=document.getElementById("scribeStartInscription"),inscriptionTitle=document.getElementById("inscriptionTitle"),soundVolume=document.getElementById("soundVolume"),musicVolume=document.getElementById("musicVolume"),gameSettingsPanel=document.getElementById("gameSettings"),toggleActiveCards=document.getElementById("toggleActiveCards"),cardAlbum=document.getElementById("cardAlbum"),cardAlbumTabs=document.querySelectorAll("#cardAlbum .tabs"),toggleFullscreenSwitch=document.getElementById("toggleFullScreen"),collectionQuestPanels=document.getElementById("collectionQuestPanels"),chestPanel=document.getElementById("chestPanel"),chestTitle=document.getElementById("chestTitle"),chestSlotContents=document.getElementById("chest"),interfaceWrapper=document.getElementById("interface"),actionBar=document.getElementById("actionBar"),gatheringPanel=document.getElementById("gatheringPanel"),gatheringBarQuality=document.querySelector("#gatheringQualityBar .progressBar"),gatheringBarPurity=document.querySelector("#gatheringPurityBar .progressBar"),gatheringBarQuantity=document.querySelector("#gatheringQuantityBar .progressBar"),gatheringBarStability=document.querySelector("#gatheringBarStability .progressBar"),surveyingTimeBar=document.getElementById("surveyingTimeBar"),craftingTimeBarOuter=document.getElementById("craftingTimeBar"),gatheringOutputSlot=document.getElementById("gatheringOutputSlot"),surveyingPanel=document.getElementById("surveyingPanel"),questJournalEntries=document.getElementById("questJournalEntries"),questJournalRegionFilter=document.getElementById("questJournalRegionFilter"),acceptQuestChoice=document.getElementById("acceptQuestChoice"),questDecline=document.getElementById("questDecline"),questAccept=document.getElementById("questAccept"),postPanel=document.getElementById("postPanel"),sendPostTab=document.getElementById("sendPostTab"),sendPostPanel=document.getElementById("sendPostPanel"),receivedPostTab=document.getElementById("receivedPostTab"),receivedPostPanel=document.getElementById("receivedPostPanel"),sendPostSubject=document.getElementById("sendPostSubject"),sendPostMessage=document.getElementById("sendPostMessage"),sendPostCharacter=document.getElementById("sendPostCharacter"),newPost=document.getElementById("newPost"),retinuePanel=document.getElementById("retinuePanel"),retinueAvailableQuestMap=document.getElementById("retinueAvailableQuestMap"),retinueDetailWrapper=document.getElementById("retinueDetailWrapper"),draggableFollower=document.getElementById("draggableFollower"),retinueQuestStart=document.getElementById("retinueQuestStart"),retinueQuestTimeRequired=document.getElementById("retinueQuestTimeRequired"),retinueList=document.getElementById("retinueList"),retinueExplorePanel=document.getElementById("retinueExplorePanel"),startCrafting=document.getElementById("startCrafting"),startWorkshopCrafting=document.getElementById("startWorkshopCrafting"),horticulturePanel=document.getElementById("horticulturePanel"),characterPanel=document.getElementById("characterPanel"),holdingIcon=document.getElementById("holdingIcon"),quickHold=document.getElementById("quickHold"),holdingGauge=document.getElementById("holdingGauge"),cardGameConcede=document.getElementById("cardGameConcede"),hnefataflConcede=document.getElementById("hnefataflConcede"),treasureMapPanels=document.getElementById("treasureMapPanels"),hireRetinueFollowerPanel=document.getElementById("hireRetinueFollowerPanel"),hireRetinueFollowerPanelContent=document.getElementById("hireRetinueFollowerPanelContent"),catalogueQuestPanels=document.getElementById("catalogueQuestPanels"),housingPanel=document.getElementById("housingPanel"),transcriptionPanel=document.getElementById("transcriptionPanel"),housingConstructionPanel=document.getElementById("housingConstructionPanel"),housingTileColour=document.getElementById("housingTileColour"),housingTileSelectionListItems=document.querySelectorAll("#housingTileSelection ul:not(#housing-items) li"),housingConstructionToolButtons=document.querySelectorAll("#housingConstructionTools li"),housingRunningTotal=document.getElementById("housingRunningTotal"),housingTileGroups=document.querySelectorAll(".housingTileGroup"),yesNoDialoguePanel=document.getElementById("yesNoDialoguePanel"),yesNoDialogueHeading=document.getElementById("yesNoDialogueHeading"),yesNoDialogueButton1=document.getElementById("yesNoDialogueButton1"),yesNoDialogueButton2=document.getElementById("yesNoDialogueButton2"),housingToggleButtons=document.querySelectorAll("#housingGroupTabs button"),transcriptionTitle=document.getElementById("transcriptionTitle"),cartographyCoordinates=document.getElementById("cartographyCoordinates");var notificationQueue=[],notificationIsShowing=!1,retinueQuestTimers=[],UI={init:function(){document.getElementById("displayZoneName"),document.getElementById("activeCartographicMap"),document.getElementById("cartographicTitle"),document.getElementById("dialogue"),document.getElementById("notification"),document.getElementById("cardGameWrapper"),document.getElementById("cardAlbumList"),document.getElementById("boosterPack"),document.getElementById("createRecipeList"),document.getElementById("recipeTitleBar"),document.getElementById("currencies")},showZoneName:function(e){displayZoneName.classList.remove("active"),displayZoneName.textContent=e,displayZoneName.offsetWidth,displayZoneName.classList.add("active")},buildInventoryInterface:function(){var e=hero.characterName;0!=hero.activeTitle&&(e+=" - "+possibleTitles[hero.activeTitle]),document.getElementById("characterName").innerHTML=e,characterPanel.classList.add("active");for(var t,a,i,n,o,r="",s="",c=0;c<hero.bags.length;c++){t="","bank"==hero.bags[c].type?(i=hero.bags[c].bankSlots,UI.whichInvenotryPanelIsTheBank=c,hero.bags[c].bankSlots==maximumBankSlotsPossible&&(document.getElementById("bankBuyMoreSlots").style.display="none")):(o=currentActiveInventoryItems[hero.bags[c].type].shortname,i=currentActiveInventoryItems[hero.bags[c].type].actionValue,t+='<div class="inventoryBag active" id="inventoryBag'+c+'"><div class="draggableBar">'+o+"</div>"),t+='<ol id="bag'+c+'">';for(var l=0;l<i;l++)t+='<li id="slot'+(n=c+"-"+l)+'">',n in hero.inventory?(t+=generateSlotMarkup(n),a=currentActiveInventoryItems[hero.inventory[n].type].action,void 0!==hero.inventory[n].cooldown&&(hero.inventory[n].cooldownTimer=0),"treasureMap"==a&&UI.createTreasureMap(hero.inventory[n].contains),"music"==a&&music.loadInstrumentSounds(currentActiveInventoryItems[hero.inventory[n].type].actionValue)):t+="",t+="</li>";t+="</ol>","bank"==hero.bags[c].type?s+=t:r+=t+"</div>"}for(c=0;c<hero.allPets.length;c++)hero.allPets[c].inventorySize>0&&(r+=UI.generatePetInventorySlot(c));for(inventoryPanels.insertAdjacentHTML("beforeend",r),bankCurrency.insertAdjacentHTML("beforebegin",s),gameWrapper.ondblclick=UI.doubleClick,gameWrapper.addEventListener("contextmenu",UI.handleRightClick,!1),createRecipeList.onclick=UI.craftingPanelSingleClick,postPanel.onclick=UI.postPanelSingleClick,retinueAvailableQuestMap.onclick=UI.openRetinueDetailPanel,retinueQuestStart.onclick=UI.addFollowersToQuest,retinuePanel.onclick=UI.retinueSingleClick,document.getElementById("craftingRecipeCreateButton").onclick=UI.craftingRecipeCreate,splitStackPanel.onsubmit=inventorySplitStackSubmit,shopSplitStackPanel.onsubmit=UI.shopSplitStackSubmit,cardAlbum.onclick=UI.cardAlbumClick,startCrafting.onclick=startCraftingTimer,startWorkshopCrafting.onclick=addItemToWorkshopQueue,cardGameConcede.onclick=cardGamePlayer2Concedes,hnefataflConcede.onclick=hnefataflPlayer2Concedes,document.getElementById("showHousingFootprintCheckbox").onchange=housingNameSpace.toggleShowPlotFootprint,housingTileColour.onchange=housingNameSpace.housingTileColourChange,document.getElementById("splitStackCancel").onclick=inventorySplitStackCancel,document.getElementById("shopSplitStackCancel").onclick=UI.shopSplitStackCancel,document.getElementById("hireRetinueFollowerNo").onclick=UI.closeHireFollowerPanel,document.getElementById("hireRetinueFollowerYes").onclick=hireNewFollower,document.getElementById("touchTapAction").onclick=UI.touchTapAction,document.getElementById("bankBuyMoreSlots").onclick=UI.buyMoreBankSlots,document.getElementById("openHousingConstructButton").onclick=UI.openHousingConstructionPanel,document.getElementById("housingTileSelection").onclick=housingNameSpace.selectNewTile,document.getElementById("housingConstructionSaveButton").onclick=housingNameSpace.commitDesign,document.getElementById("housingConstructionTools").onclick=housingNameSpace.changeActiveTool,document.getElementById("housingConstructionCancelButton").onclick=housingNameSpace.checkAbandonDesign,document.querySelector("#housingConstructionPanel .closePanel").onclick=housingNameSpace.checkSaveDraftDesign,document.getElementById("buttonStopTranscription").onclick=music.stopTranscription,c=0;c<housingToggleButtons.length;c++)housingToggleButtons[c].onclick=housingNameSpace.toggleTileGroup;toggleFullscreenSwitch.onchange=UI.toggleFullScreen,document.onfullscreenchange=UI.fullScreenChangeDetected,document.onwebkitfullscreenchange=UI.fullScreenChangeDetected,soundVolume.onchange=audio.adjustEffectsVolume,musicVolume.onchange=audio.adjustMusicVolume,UI.initInventoryDrag(".inventoryBag ol"),document.getElementById("openSettings").onclick=UI.openSettings,actionBar.onclick=UI.actionBarClick,questDecline.onclick=declineQuest,questAccept.onclick=acceptQuest,UI.initShopDrag(),UI.updateCardAlbum(),UI.updateCurrencies(),UI.buildRecipePanel(),UI.updateInscriptionPanel(),UI.getGameSettings(),UI.buildCollectionPanel(),UI.buildActionBar(),UI.initRetinueTimers(),UI.updateHeldItems(),UI.updateQuickHold(),gameWrapper.onmousedown=UI.globalMouseDown,gameWrapper.onclick=UI.globalClick,inventoryInterfaceIsBuilt=!0},toggleFullScreen:function(){toggleFullscreenSwitch.checked?launchFullScreen(document.documentElement):exitFullScreen()},fullScreenChangeDetected:function(){document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement?toggleFullscreenSwitch.checked=!0:toggleFullscreenSwitch.checked=!1},addNewBag:function(e){hero.bags.push(e);for(var t='<div class="inventoryBag active" id="inventoryBag'+(i=hero.bags.length-1)+'"><div class="draggableBar">'+currentActiveInventoryItems[hero.bags[i].type].shortname+'</div><ol class="active" id="bag'+i+'">',a=currentActiveInventoryItems[hero.bags[i].type].actionValue,n=0;n<a;n++)t+='<li id="slot'+(i+"-"+n)+'"></li>';t+="</ol></div></div>",inventoryPanels.insertAdjacentHTML("beforeend",t),UI.initInventoryDrag("#inventoryBag"+i+" ol")},showChangeInInventory:function(e){if(e.length>0){var t,a,i;document.getElementById("slot"+e[0]).addEventListener(whichTransitionEvent,function e(t){for(var a=document.querySelectorAll("#inventoryPanels .changed"),i=0;i<a.length;i++)a[i].classList.remove("changed");return t.currentTarget.removeEventListener(whichTransitionEvent,e,!1)},!1);for(var n=0;n<e.length;n++)a=generateSlotMarkup(t=e[n]),(i=document.getElementById("slot"+t)).innerHTML=a,i.classList.add("changed")}},handleDrag:function(e){UI.activeDragObject.style.cssText="z-index:4;top: "+objInitTop+"px; left: "+objInitLeft+"px; transform: translate("+(e.pageX-dragStartX)+"px, "+(e.pageY-dragStartY)+"px);"},endDrag:function(e){document.removeEventListener("mousemove",UI.handleDrag,!1),document.removeEventListener("mouseup",UI.endDrag,!1),UI.activeDragObject=""},globalMouseDown:function(e){if("draggableBar"==e.target.className){if(2!=e.button){UI.activeDragObject=e.target.parentElement;var t=(window.pageYOffset||document.documentElement.scrollTop)-(document.documentElement.clientTop||0),a=e.target.getBoundingClientRect();objInitLeft=a.left,objInitTop=a.top+t,dragStartX=e.pageX,dragStartY=e.pageY,document.addEventListener("mousemove",UI.handleDrag,!1),document.addEventListener("mouseup",UI.endDrag,!1);for(var i=document.querySelectorAll(".draggableBar"),n=0;n<i.length;n++)i[n].parentElement.style.zIndex=1}}else{var o=getNearestParentId(e.target);if(-1!==o.id.indexOf("retinueFollower")&&(e.preventDefault(),2!=e.button&&o.classList.contains("available"))){o.classList.add("hasDragCopy");var r=o.id.substring(15);retinueObject.draggedFollower=r,draggableFollower.innerHTML='<div class="portrait"><img src="/images/retinue/'+r+'.png" alt=""></div>',UI.activeDragObject=draggableFollower,UI.draggedOriginal=o;t=(window.pageYOffset||document.documentElement.scrollTop)-(document.documentElement.clientTop||0);var s=o.getBoundingClientRect();objInitLeft=s.left,objInitTop=s.top+t,dragStartX=e.pageX,dragStartY=e.pageY,UI.activeDragObject.style.cssText="z-index:4;top: "+objInitTop+"px; left: "+objInitLeft+"px; transform: translate(0px, 0px);",document.addEventListener("mousemove",UI.handleDrag,!1),document.addEventListener("mouseup",UI.endFollowerDrag,!1);for(i=document.querySelectorAll(".draggableBar"),n=0;n<i.length;n++)i[n].parentElement.style.zIndex=1}}},doubleClick:function(e){var t=e.target.getAttribute("data-action"),a=getNearestParentId(e.target);"recipe"==a.id.substring(0,6)?recipeSelectComponents(a.id,!1):"workshopItems"==a.id.substring(0,13)?checkIfWorkshopItemIsComplete(e.target.closest(".itemSlot")):"workshop"==a.id.substring(0,8)?recipeSelectComponents(e.target.closest("li").getAttribute("data-recipe"),!0):"shop"==a.id.substring(0,4)?UI.buyFromShopSlot(a.id):"chest"==a.id.substring(0,5)?UI.addFromChest(a.id):"gathering"==a.id.substring(0,9)?UI.addFromGathering():"postMessage"==a.id.substring(0,11)?UI.takePostAttachments(a.id):"post"==a.id.substring(0,4)?UI.readPostMessage(a.id):"fromSlot"==a.id.substring(0,8)&&addCraftingComponents(a.id,!0),t&&inventoryItemAction(e.target,t,e.target.getAttribute("data-action-value"))},showDialogue:function(e,t){UI.showUI();var a=getRandomElementFromArray(t.split("/"));""!=activeObjectForDialogue&&dialogue.removeEventListener(whichTransitionEvent,UI.removeActiveDialogue,!1),dialogue.innerHTML=a,dialogue.classList.remove("slowerFade"),dialogue.classList.add("active"),activeObjectForDialogue=e,UI.updateDialogue(activeObjectForDialogue)},updateDialogue:function(e){var t,a=findIsoCoordsX(e.x,e.y),i=findIsoCoordsY(e.x,e.y);t=void 0!==e.speech?"translate("+Math.floor(a-hero.isox+canvasWidth/2-40)+"px,"+Math.floor(0-(canvasHeight-(i-hero.isoy-e.centreY+canvasHeight/2))-e.z)+"px)":"translate("+Math.floor(a-hero.isox+canvasWidth/2-20)+"px,"+Math.floor(0-(canvasHeight-(i-hero.isoy-e.centreY+canvasHeight/2))-e.z-34)+"px)",dialogue.style.transform=t},removeActiveDialogue:function(){activeObjectForDialogue="",dialogue.removeEventListener(whichTransitionEvent,UI.removeActiveDialogue,!1)},showNotification:function(e){notificationIsShowing?-1===notificationQueue.indexOf(e)&&notificationQueue.push(e):(-1===notificationQueue.indexOf(e)&&notificationQueue.push(e),notificationIsShowing=!0,notification.classList.remove("active"),notification.innerHTML=e,notification.offsetHeight,notification.classList.add("active"),notification.addEventListener(whichAnimationEvent,UI.notificationEnded,!1))},notificationEnded:function(){notificationQueue.shift(),notificationIsShowing=!1,dialogue.removeEventListener(whichAnimationEvent,UI.notificationEnded,!1),notificationQueue.length>0&&UI.showNotification(notificationQueue[0])},cardAlbumClick:function(e){var t=getNearestParentId(e.target);if(t.classList.contains("craftCard")){var a=t.id.substring(8),i={type:34,contains:a};i=prepareInventoryObject(i),(inventoryCheck=canAddItemToInventory([i]))[0]?(hero.currency.cardDust-=cardGameNameSpace.allCardData[a][3],UI.updateCurrencies(),UI.updateCardAlbum(),UI.showChangeInInventory(inventoryCheck[1]),audio.playSound(soundEffects.cardCraft,0)):UI.showNotification("<p>I've don't have room in my bags for that</p>")}else if(t.classList.contains("cardBack"))hero.activeCardBack=t.id.substring(8),UI.changeActiveCardBack(),UI.updateCardAlbum();else if(t.classList.contains("tabs")){for(var n=0;n<cardAlbumTabs.length;n++)cardAlbumTabs[n].classList.remove("active");switch(t.classList.add("active"),t.id){case"tabShowAlbum":cardAlbumList.className="showAlbum";break;case"tabShowBacks":cardAlbumList.className="showBacks";break;case"tabShowCrafting":cardAlbumList.className="showCrafting"}}},updateCardAlbum:function(){for(var e,t,a,i="<ul>",n=0,o={},r=0;r<hero.cards.length;r++){var s=hero.cards[r];o[s]=o[s]?o[s]+1:1}for(r=1;r<cardGameNameSpace.allCardData.length;r++)t=!1,"card players",e="",a="",o[r]?(e='<span class="quantity">'+o[r]+"</span>",t=!0):a="inactive",o[0-r]&&(t=!0,i+='<li class="rare card players"><div style="background-image:url(/images/card-game/cards/'+(0-r)+'.png)"></div><span class="quantity">'+o[0-r]+"</span></li>",a+=" hasRare"),i+='<li class="'+a+'"><img src="/images/card-game/cards/'+r+'.png" class="card players" alt="'+cardGameNameSpace.allCardData[r][2]+' card">'+e,hero.currency.cardDust>=cardGameNameSpace.allCardData[r][3]?i+='<button class="craftCard" id="cardCard'+r+'">Craft '+cardGameNameSpace.allCardData[r][2]+" ("+cardGameNameSpace.allCardData[r][3]+")</button>":i+='<span class="craftingCost">Needs '+cardGameNameSpace.allCardData[r][3]+"</span>",i+="</li>",t&&n++;for(r=0;r<hero.cardBacks.length;r++)i+='<li id="cardBack'+hero.cardBacks[r]+'" class="cardBack',hero.cardBacks[r]==hero.activeCardBack&&(i+=" active"),hero.cardBacks[r]<0?i+='"><img src="/images/user-generated/'+Math.abs(hero.cardBacks[r])+'-world.jpg"></li>':i+='"><img src="/images/card-game/card-backs/'+hero.cardBacks[r]+'.jpg"></li>';i+="</ul>",i+='<p id="dustCurrency">'+hero.currency.cardDust+" dust</p>",i+="<p>"+n+" types out of "+(cardGameNameSpace.allCardData.length-1)+". Total individual cards: "+hero.cards.length+". Total backs: "+hero.cardBacks.length+"</p>",cardAlbumList.innerHTML=i},changeActiveCardBack:function(){hero.activeCardBack<0?document.getElementById("playersCardBack").innerHTML=".card.players {background-image: url(/images/user-generated/"+Math.abs(hero.activeCardBack)+"-world.jpg);}":document.getElementById("playersCardBack").innerHTML=".card.players {background-image: url(/images/card-game/card-backs/"+hero.activeCardBack+".jpg);}"},populateRecipeList:function(e,t){if(currentRecipePanelProfession!=e){releaseLockedSlots(),craftingSelectComponentsPanel.classList.remove("active"),recipeSearch.value="",clearRecipeSearch.classList.remove("active");for(var a,i=findRecipeTierLevel(t),n='<li id="noRecipesFound"><p>No recipes found.</p></li>',o="",r=0;r<hero.crafting[e].sortOrder.length;r++)i>=(a=hero.crafting[e].recipes[hero.crafting[e].sortOrder[r]]).tier&&(n+='<li class="active" id="recipe'+hero.crafting[e].sortOrder[r]+'"><img src="/images/game-world/inventory-items/'+a.imageId+'.png" alt="'+a.recipeName+'"><h3>'+a.recipeName+"</h3><p>"+a.recipeDescription+"</p></li>");createRecipeList.innerHTML=n;for(r=0;r<hero.crafting[e].filterOrder.length;r++)o+='<option value="'+hero.crafting[e].filters[hero.crafting[e].filterOrder[r]]+'"',0==r&&(o+=' selected="selected"'),o+=">"+hero.crafting[e].filterOrder[r]+"</option>";recipeFilter.innerHTML=o,currentRecipePanelProfession=e,UI.highlightedRecipe="",craftingRecipeCreateButton.disabled=!0,recipeTitleBar.innerHTML=hero.crafting[e].name+" Recipes",thisDevicesScrollBarWidth>0&&recipeCustomScrollBar.init()}craftingPanel.classList.add("active")},buildRecipePanel:function(){recipeSearch.onkeyup=recipeSearchInput,recipeFilter.onchange=recipeSearchAndFilter,clearRecipeSearch.onclick=recipeSearchClear},endInventoryDrag:function(e){var t=!1;if("shopSlot"==UI.sourceSlot.substring(0,8)){t=!0;var a=document.getElementById(UI.sourceSlot).firstElementChild,i=document.getElementById(UI.sourceSlot).parentNode.parentNode,n=a.getAttribute("data-price"),o=i.getAttribute("data-currency"),r={type:parseInt(a.getAttribute("data-type")),quantity:1,quality:100,durability:100,currentWear:0,effectiveness:100,colour:parseInt(a.getAttribute("data-colour")),enchanted:0,hallmark:0,inscription:""};a.hasAttribute("data-inscription")&&(r.inscription=a.getAttribute("data-inscription")),a.hasAttribute("data-ugcid")?(r.contains={},r.contains["ugc-id"]=a.getAttribute("data-ugcid"),a.hasAttribute("data-ugctitle")&&(r.contains["ugc-title"]=a.getAttribute("data-ugctitle"))):a.hasAttribute("data-contains")&&(r.contains=a.getAttribute("data-contains"))}var s=getNearestParentId(e.target),c=s.id;if("slot"==c.substring(0,4)){var l=c.substring(4);if(null==hero.inventory[l])isSplitStackBeingDragged?(addToInventory(l,UI.draggedInventoryObject,!0),UI.droppedSuccessfully()):t?hero.currency[o]>=n?(addToInventory(l,r),hero.currency[o]-=n,UI.updateCurrencies(),audio.playSound(soundEffects.coins,0),UI.droppedSuccessfully()):(UI.showNotification("<p>I don't have have enough money</p>"),UI.slideDraggedSlotBack()):(UI.sourceSlot!=l?(document.getElementById("slot"+UI.sourceSlot).innerHTML="",addToInventory(l,UI.draggedInventoryObject)):hero.inventory[l]=JSON.parse(JSON.stringify(UI.draggedInventoryObject)),document.getElementById("slot"+UI.sourceSlot).classList.remove("hidden"),UI.droppedSuccessfully());else if(t)itemAttributesMatch(r,hero.inventory[l])&&parseInt(hero.inventory[l].quantity)<maxNumberOfItemsPerSlot?hero.currency[o]>=n?(hero.inventory[l].quantity++,updateQuantity(l),hero.currency[o]-=n,UI.updateCurrencies(),audio.playSound(soundEffects.coins,0),UI.droppedSuccessfully()):(UI.showNotification("<p>I don't have have enough money</p>"),UI.slideDraggedSlotBack()):UI.slideDraggedSlotBack();else if(itemAttributesMatch(UI.draggedInventoryObject,hero.inventory[l]))if(parseInt(UI.draggedInventoryObject.quantity)+parseInt(hero.inventory[l].quantity)<=maxNumberOfItemsPerSlot)hero.inventory[l].quantity+=parseInt(UI.draggedInventoryObject.quantity),updateQuantity(l),isSplitStackBeingDragged||(document.getElementById("slot"+UI.sourceSlot).innerHTML="",document.getElementById("slot"+UI.sourceSlot).classList.remove("hidden")),UI.droppedSuccessfully();else{var h=maxNumberOfItemsPerSlot-parseInt(hero.inventory[l].quantity);hero.inventory[l].quantity=maxNumberOfItemsPerSlot,updateQuantity(l),UI.draggedInventoryObject.quantity-=h;for(var d=document.getElementById("slot"+UI.sourceSlot),u=0;u<d.childNodes.length;u++)if("qty"==d.childNodes[u].className){d.childNodes[u].innerHTML=UI.draggedInventoryObject.quantity;break}for(d=document.getElementById("draggableInventorySlot"),u=0;u<d.childNodes.length;u++)if("qty"==d.childNodes[u].className){d.childNodes[u].innerHTML=UI.draggedInventoryObject.quantity;break}inventorySplitStackCancel(),UI.slideDraggedSlotBack()}else UI.slideDraggedSlotBack()}else if("inventoryBag"==c.substring(0,12)){var p=c.substring(12),g=UI.sourceSlot.indexOf("-"),m=UI.sourceSlot.substring(0,g),v=currentActiveInventoryItems[hero.bags[p].type].actionValue,f=-1;if(t)if(hero.currency[o]>=n){for(var y=0;y<v;y++){if(!(p+"-"+y in hero.inventory)){f=y;break}}-1!=f?(hero.currency[o]-=n,UI.updateCurrencies(),audio.playSound(soundEffects.coins,0),UI.droppedSuccessfully(),addToInventory(p+"-"+f,r),UI.droppedSuccessfully()):UI.slideDraggedSlotBack(),UI.droppedSuccessfully()}else UI.showNotification("<p>I don't have have enough money</p>"),UI.slideDraggedSlotBack();else if(p==m)UI.slideDraggedSlotBack();else{for(y=0;y<v;y++){if(!(p+"-"+y in hero.inventory)){f=y;break}}-1!=f?(isSplitStackBeingDragged||(document.getElementById("slot"+UI.sourceSlot).innerHTML=""),addToInventory(p+"-"+f,UI.draggedInventoryObject),document.getElementById("slot"+UI.sourceSlot).classList.remove("hidden"),UI.droppedSuccessfully()):UI.slideDraggedSlotBack()}}else if("shopSlot"==c.substring(0,8))t?UI.slideDraggedSlotBack():UI.sellToShop(s.parentNode.parentNode);else if(s.classList.contains("shop"))t?UI.slideDraggedSlotBack():UI.sellToShop(s);else if(s.classList.contains("workshop")){if(29==UI.draggedInventoryObject.type)-1!=s.getAttribute("data-possiblerecipes").split(",").indexOf(UI.draggedInventoryObject.contains+"")?(document.getElementById("slot"+UI.sourceSlot).classList.remove("hidden"),document.getElementById("slot"+UI.sourceSlot).innerHTML="",UI.droppedSuccessfully(),addRecipeToWorkshop(UI.draggedInventoryObject,s)):(UI.showNotification("<p>That workshop can't use that recipe</p>"),UI.slideDraggedSlotBack());else UI.slideDraggedSlotBack()}else UI.slideDraggedSlotBack();document.removeEventListener("mousemove",UI.handleDrag,!1),document.removeEventListener("mouseup",UI.endInventoryDrag,!1)},sellToShop:function(e){var t,a=currentActiveInventoryItems[UI.draggedInventoryObject.type].category,i=e.getAttribute("data-specialism");t=-1!=a.indexOf(i)?Math.ceil(UI.draggedInventoryObject.quantity*sellPriceSpecialismModifier*inflationModifier*currentActiveInventoryItems[UI.draggedInventoryObject.type].priceCode,0):Math.ceil(UI.draggedInventoryObject.quantity*sellPriceModifier*inflationModifier*currentActiveInventoryItems[UI.draggedInventoryObject.type].priceCode,0),hero.currency.money+=t,UI.updateCurrencies(),audio.playSound(soundEffects.coins,0),document.getElementById("slot"+UI.sourceSlot).classList.remove("hidden"),document.getElementById("slot"+UI.sourceSlot).innerHTML="",UI.droppedSuccessfully()},droppedSuccessfully:function(){""!=UI.activeDragObject&&(UI.activeDragObject.style.cssText="z-index:2;",UI.activeDragObject="",isSplitStackBeingDragged&&(isSplitStackBeingDragged=!1),inventorySplitStackCancel(),UI.updatePanelsAfterInventoryChange())},initInventoryDrag:function(e){for(var t=document.querySelectorAll(e),a=0;a<t.length;a++)t[a].addEventListener("mousedown",function(e){if(e.preventDefault(),2!=e.button){var t=getNearestParentId(e.target);if(key[5]){UI.sourceSlot=t.id.substring(4),UI.draggedInventoryObject=JSON.parse(JSON.stringify(hero.inventory[UI.sourceSlot])),splitStackInput.setAttribute("max",hero.inventory[UI.sourceSlot].quantity);var a=Math.floor(hero.inventory[UI.sourceSlot].quantity/2);splitStackInput.value=a,splitStackInput.focus();var i=t.getBoundingClientRect(),n=(window.pageYOffset||document.documentElement.scrollTop)-(document.documentElement.clientTop||0);objInitLeft=i.left+3,objInitTop=i.top+3+n-44,splitStackPanel.style.cssText="z-index:4;top: "+objInitTop+"px; left: "+objInitLeft+"px;",splitStackPanel.classList.add("active"),key[5]=0}else if(!isSplitStackBeingDragged){UI.sourceSlot=t.id.substring(4),UI.draggedInventoryObject=hero.inventory[UI.sourceSlot],UI.activeDragObject=document.getElementById("draggableInventorySlot"),UI.activeDragObject.innerHTML=t.innerHTML,delete hero.inventory[UI.sourceSlot],t.classList.add("hidden");i=t.getBoundingClientRect(),n=(window.pageYOffset||document.documentElement.scrollTop)-(document.documentElement.clientTop||0);objInitLeft=i.left+3,objInitTop=i.top+3+n,dragStartX=e.pageX,dragStartY=e.pageY,UI.activeDragObject.style.cssText="z-index:4;top: "+objInitTop+"px; left: "+objInitLeft+"px; transform: translate(0px, 0px);",document.addEventListener("mousemove",UI.handleDrag,!1),document.addEventListener("mouseup",UI.endInventoryDrag,!1)}}},!1)},slideDraggedSlotBack:function(){UI.activeDragObject.style.cssText="z-index:4;left: "+objInitLeft+"px; top: "+objInitTop+"px;transition: transform 0.4s ease;",UI.activeDragObject.addEventListener(whichTransitionEvent,function e(t){if("shopSlot"!=UI.sourceSlot.substring(0,8))if(isSplitStackBeingDragged){hero.inventory[UI.sourceSlot].quantity+=UI.draggedInventoryObject.quantity;var a=document.getElementById("slot"+UI.sourceSlot);if(a)for(var i=0;i<a.childNodes.length;i++)if("qty"==a.childNodes[i].className){a.childNodes[i].innerHTML=hero.inventory[UI.sourceSlot].quantity;break}}else hero.inventory[UI.sourceSlot]=JSON.parse(JSON.stringify(UI.draggedInventoryObject)),document.getElementById("slot"+UI.sourceSlot).classList.remove("hidden");return UI.droppedSuccessfully(),t.currentTarget.removeEventListener(whichTransitionEvent,e,!1)},!1)},craftingPanelSingleClick:function(e){var t=getNearestParentId(e.target);"recipe"==t.id.substring(0,6)&&(""!=UI.highlightedRecipe&&document.getElementById(UI.highlightedRecipe).classList.remove("highlighted"),UI.highlightedRecipe=t.id,document.getElementById(UI.highlightedRecipe).classList.add("highlighted"),craftingRecipeCreateButton.disabled=!1)},craftingRecipeCreate:function(){""!=UI.highlightedRecipe&&recipeSelectComponents(UI.highlightedRecipe,!1)},workshopPanelSingleClick:function(e){var t=getNearestParentId(e.target);"recipe"==t.id.substring(0,6)&&(""!=UI.highlightedWorkshopRecipe&&document.getElementById(UI.highlightedWorkshopRecipe).classList.remove("highlighted"),UI.highlightedWorkshopRecipe=t.id,document.getElementById(UI.highlightedWorkshopRecipe).classList.add("highlighted"),e.target.closest(".workshop").querySelector(".workshopRecipeCreateButton").disabled=!1)},workshopRecipeCreate:function(){""!=UI.highlightedWorkshopRecipe&&recipeSelectComponents(UI.highlightedWorkshopRecipe,!0)},buildBook:function(e,t){var a="";e.inscription.content;document.getElementById("book"+t)||(a+='<div class="book inkColour'+e.colour+'" id="book'+t+'">',a+='<div class="draggableBar">&quot;'+e.inscription.title+"&quot;</div>",a+='<button class="closePanel">close</button>',a+=e.inscription.content,a+="</div>",booksAndParchments.innerHTML+=a)},globalClick:function(e){if(e.target.className&&"closePanel"==e.target.className)if(e.target.parentNode.classList.remove("active"),e.target.parentNode.classList.contains("workshop"))workshopObject.workshopCurrentlyOpen=-1,""!=activeObjectForDialogue&&(dialogue.classList.remove("active"),activeObjectForDialogue.speechIndex=0,UI.removeActiveDialogue());else if(e.target.parentNode.classList.contains("shop"))shopCurrentlyOpen=-1,inventoryPanels.removeAttribute("class"),""!=activeObjectForDialogue&&(dialogue.classList.remove("active"),activeObjectForDialogue.speechIndex=0,UI.removeActiveDialogue());else switch(e.target.parentNode.id){case"gatheringPanel":"gather"==activeAction&&gatheringStopped();break;case"surveyingPanel":"survey"==activeAction&&surveyingStopped();break;case"inscriptionPanel":UI.resetInscriptionPanel();break;case"chestPanel":UI.closeChest();break;case"postPanel":UI.closePost();break;case"retinuePanel":UI.closeRetinuePanel();break;case"craftingSelectComponentsPanel":releaseLockedSlots()}var t=getNearestParentId(e.target);"scribe"==t.id.substring(0,6)&&UI.processInscriptionClick(t)},updateCurrencies:function(){currencies.innerHTML="<p>"+parseMoney(hero.currency.money)+"</p><p>"+hero.currency.cardDust+'<span class="card"><span></p><p>'+hero.currency.keys.length+'<span class="keys"><span></p>',bankCurrency.innerHTML="<p>"+parseMoney(hero.currency.money)+"</p>"},buildShop:function(e){shopPanel.insertAdjacentHTML("beforeend",e)},buildWorkshop:function(e){workshopPanel.insertAdjacentHTML("beforeend",e);var t=workshopPanel.querySelectorAll("select");for(i=0;i<t.length;++i)t[i].onchange=workshopSelectHireApprentice;workshopPanel.querySelector("input[name=hireApprenticeName]").onfocus=workshopApprenticeNameChange,workshopPanel.querySelector(".primaryButton").onclick=hireApprentice,UI.highlightedWorkshopRecipe="",workshopPanel.querySelector(".availableRecipes ol").onclick=UI.workshopPanelSingleClick,workshopPanel.querySelector(".workshopRecipeCreateButton").onclick=UI.workshopRecipeCreate},initWorkshops:function(e){for(var t,a=e.split(","),i=0;i<a.length;i++)t=document.getElementById(a[i]),thisDevicesScrollBarWidth>0?window[a[i]]=new customScrollBar(t.querySelector(".customScrollBar")):t.querySelector(".customScrollBar").classList.add("inActive"),workshopTimers[a[i]]=Date.now()},openedShopSuccessfully:function(e){return!!document.getElementById("shop"+e)&&(UI.showUI(),shopCurrentlyOpen=e,document.getElementById("shop"+e).classList.add("active"),inventoryPanels.classList.add("shopSpecialism"+document.getElementById("shop"+e).getAttribute("data-specialism")),!0)},closeShop:function(){document.getElementById("shop"+shopCurrentlyOpen).classList.remove("active"),shopCurrentlyOpen=-1,inventoryPanels.removeAttribute("class")},openWorkshop:function(e){workshopObject.workshopHash=generateHash(e),UI.showUI(),workshopObject.workshopCurrentlyOpen=workshopObject.workshopHash,audio.playSound(soundEffects.buttonClick,0),document.getElementById("workshop"+workshopObject.workshopHash).classList.add("active");for(var t=document.getElementById("workshop"+workshopObject.workshopHash).querySelectorAll(".itemSlot"),a=0;a<t.length;a++)if(!t[a].hasAttribute("data-complete")){workshopObject.activeItemSlot=t[a],workshopObject.activeSlotTimeRequired=parseInt(t[a].getAttribute("data-timeremaining"));break}workshopObject.lastTimeText="",UI.updateWorkshopTimer()},closeWorkshop:function(){document.getElementById("workshop"+workshopObject.workshopCurrentlyOpen).classList.remove("active"),craftingSelectComponentsPanel.classList.remove("active"),releaseLockedSlots(),workshopObject={workshopCurrentlyOpen:-1}},updateWorkshopTimer:function(){var e=Date.now()-workshopTimers["workshop"+workshopObject.workshopHash],t=parseTime(workshopObject.activeSlotTimeRequired-e);workshopObject.lastTimeText!=t&&(workshopObject.activeItemSlot.querySelector(".status span").innerText=t,workshopObject.lastTimeText=t)},shopSplitStackCancel:function(){shopSplitStackPanel.classList.remove("active"),document.activeElement.blur()},buyFromShopSlot:function(e){var t=document.getElementById(e),a=t.firstElementChild,i=t.parentNode.parentNode,n=a.getAttribute("data-price"),o=i.getAttribute("data-currency");if(hero.currency[o]>=n){var r={type:parseInt(a.getAttribute("data-type")),quantity:1,quality:100,durability:100,currentWear:0,effectiveness:100,colour:parseInt(a.getAttribute("data-colour")),enchanted:0,hallmark:0,inscription:""};if(a.hasAttribute("data-inscription"))try{r.inscription=JSON.parse(a.getAttribute("data-inscription"))}catch(e){r.inscription=a.getAttribute("data-inscription")}a.hasAttribute("data-ugcid")?(r.contains={},r.contains["ugc-id"]=a.getAttribute("data-ugcid"),a.hasAttribute("data-ugctitle")&&(r.contains["ugc-title"]=a.getAttribute("data-ugctitle"))):a.hasAttribute("data-contains")&&(console.log("has Contains",a.getAttribute("data-contains")),r.contains=a.getAttribute("data-contains")),(inventoryCheck=canAddItemToInventory([r]))[0]?(hero.currency[o]-=n,UI.updateCurrencies(),audio.playSound(soundEffects.coins,0),UI.showChangeInInventory(inventoryCheck[1])):UI.showNotification("<p>I don't have room in my bags for that</p>")}else UI.showNotification("<p>I don't have enough money</p>");UI.activeDragObject.innerHTML=""},initShopDrag:function(){document.getElementById("shopPanel").addEventListener("mousedown",function(e){if(!isSplitStackBeingDragged){var t=getNearestParentId(e.target);if("shopSlot"==t.id.substring(0,8)&&(e.preventDefault(),2!=e.button))if(UI.sourceSlot=t,key[5]){var a=t.firstElementChild,i=t.parentNode.parentNode,n=a.getAttribute("data-price"),o=i.getAttribute("data-currency"),r=Math.floor(hero.currency[o]/n);r>maxNumberOfItemsPerSlot&&(r=maxNumberOfItemsPerSlot),shopSplitStackInput.setAttribute("max",r),shopSplitStackInput.value=1,shopSplitStackInput.focus();var s=t.getBoundingClientRect(),c=(window.pageYOffset||document.documentElement.scrollTop)-(document.documentElement.clientTop||0);objInitLeft=s.left+3,objInitTop=s.top+3+c-44,shopSplitStackPanel.style.cssText="z-index:4;top: "+objInitTop+"px; left: "+objInitLeft+"px;",shopSplitStackPanel.classList.add("active"),key[5]=0}else{UI.sourceSlot=t.id,UI.draggedInventoryObject={type:parseInt(t.getAttribute("data-type")),quantity:1,quality:100,durability:100,currentWear:0,effectiveness:100,colour:parseInt(t.getAttribute("data-colour")),enchanted:0,hallmark:0,inscription:""},t.hasAttribute("data-inscription")&&(UI.draggedInventoryObject.inscription=t.getAttribute("data-inscription")),t.hasAttribute("data-contains")&&(UI.draggedInventoryObject.contains=t.getAttribute("data-contains")),UI.activeDragObject=document.getElementById("draggableShopSlot"),UI.activeDragObject.innerHTML=t.innerHTML;s=t.getBoundingClientRect(),c=(window.pageYOffset||document.documentElement.scrollTop)-(document.documentElement.clientTop||0);objInitLeft=s.left+3,objInitTop=s.top+3+c,dragStartX=e.pageX,dragStartY=e.pageY,UI.activeDragObject.style.cssText="z-index:4;top: "+objInitTop+"px; left: "+objInitLeft+"px; transform: translate(0px, 0px);",document.addEventListener("mousemove",UI.handleDrag,!1),document.addEventListener("mouseup",UI.endInventoryDrag,!1)}}},!1)},shopSplitStackSubmit:function(e){e&&e.preventDefault();var t=shopSplitStackInput.value,a=!0;if((t=parseInt(t))<1&&(a=!1),Number.isInteger(t)||(a=!1),t>shopSplitStackInput.getAttribute("max")&&(a=!1),a){var i=UI.sourceSlot.firstElementChild,n=UI.sourceSlot.parentNode.parentNode,o=i.getAttribute("data-price"),r=n.getAttribute("data-currency"),s={type:parseInt(i.getAttribute("data-type")),quantity:t,quality:100,durability:100,currentWear:0,effectiveness:100,colour:parseInt(i.getAttribute("data-colour")),enchanted:0,hallmark:0,inscription:""};i.hasAttribute("data-inscription")&&(s.inscription=i.getAttribute("data-inscription")),i.hasAttribute("data-contains")&&(s.contains=i.getAttribute("data-contains")),(inventoryCheck=canAddItemToInventory([s]))[0]?(hero.currency[r]-=t*o,UI.updateCurrencies(),audio.playSound(soundEffects.coins,0),UI.showChangeInInventory(inventoryCheck[1])):UI.showNotification("<p>I don't have room in my bags for that</p>")}shopSplitStackPanel.classList.remove("active"),document.activeElement.blur()},openInscriptionPanel:function(){audio.playSound(soundEffects.bookOpen,0),inscriptionTextArea.innerHTML="",inscriptionPanel.classList.add("active")},resetInscriptionPanel:function(){var e,t=document.querySelectorAll("#inscriptionPanel li");for(e=0;e<t.length;++e)t[e].classList.remove("selected")},updateInscriptionPanel:function(){var e,t,a,i="<h3>Inks available:</h3><ol>",n="<h3>Documents available:</h3><ol>",o="<h3>Materials available:</h3><ol>";for(var r in hero.inventory)if(40==hero.inventory[r].type)e="",a="",""!=(t=getColourName(hero.inventory[r].colour,hero.inventory[r].type))&&(a=t+" ",e="-"+t.toLowerCase()),i+='<li class="scribeInk" id="scribeInkFromSlot'+r+'"><img src="/images/game-world/inventory-items/40'+e+'.png" alt="'+a+currentActiveInventoryItems[40].shortname+'">'+hero.inventory[r].quantity+"<h3>"+a+currentActiveInventoryItems[40].shortname+"</h3><p>"+currentActiveInventoryItems[40].description+"</p></li>";else{var s=currentActiveInventoryItems[hero.inventory[r].type].action,c=!1;s&&"book"==s&&(c=!0),c&&(hero.inventory[r].inscription.content?n+='<li class="scribeSource" id="scribeSourceFromSlot'+r+'"><img src="/images/game-world/inventory-items/'+hero.inventory[r].type+'.png" alt="'+currentActiveInventoryItems[hero.inventory[r].type].shortname+'">'+hero.inventory[r].quantity+"<h3>"+currentActiveInventoryItems[hero.inventory[r].type].shortname+"</h3><p>"+hero.inventory[r].inscription.title+"</p></li>":o+='<li class="scribeMaterial" id="scribeMaterialFromSlot'+r+'"><img src="/images/game-world/inventory-items/'+hero.inventory[r].type+'.png" alt="'+currentActiveInventoryItems[hero.inventory[r].type].shortname+'">'+hero.inventory[r].quantity+"<h3>"+currentActiveInventoryItems[hero.inventory[r].type].shortname+"</h3><p>"+currentActiveInventoryItems[hero.inventory[r].type].description+"</p></li>")}i+="</ol>",n+="</ol>",o+="</ol>",sourceSelection.innerHTML=n,materialsSelection.innerHTML=o,inkSelection.innerHTML=i,UI.inscription={mode:"original",selected:{source:"",material:"",ink:""}},scribeStartInscription.setAttribute("disabled","disabled"),inscriptionTitle.value="",inscriptionTextArea.innerHTML=""},processInscriptionClick:function(e){switch(e.className){case"scribeSource":UI.inscription.selected.source=e.id.substring(20);var t=document.querySelectorAll("#sourceSelection li");for(a=0;a<t.length;++a)t[a].classList.remove("selected");e.classList.add("selected");break;case"scribeMaterial":UI.inscription.selected.material=e.id.substring(22);t=document.querySelectorAll("#materialsSelection li");for(a=0;a<t.length;++a)t[a].classList.remove("selected");e.classList.add("selected");break;case"scribeInk":UI.inscription.selected.ink=e.id.substring(17);var a;t=document.querySelectorAll("#inkSelection li");for(a=0;a<t.length;++a)t[a].classList.remove("selected");e.classList.add("selected")}switch("copy"==UI.inscription.mode?""!=UI.inscription.selected.ink&&""!=UI.inscription.selected.material&&""!=UI.inscription.selected.source?scribeStartInscription.removeAttribute("disabled"):scribeStartInscription.setAttribute("disabled","disabled"):""!=UI.inscription.selected.ink&&""!=UI.inscription.selected.material?scribeStartInscription.removeAttribute("disabled"):scribeStartInscription.setAttribute("disabled","disabled"),e.id){case"scribeCopyText":"copy"!=UI.inscription.mode&&UI.resetInscriptionPanel(),UI.inscription.mode="copy",originalText.classList.remove("active"),sourceSelection.classList.add("active"),e.classList.add("active"),scribeOriginalText.classList.remove("active");break;case"scribeOriginalText":"original"!=UI.inscription.mode&&UI.resetInscriptionPanel(),UI.inscription.mode="original",originalText.classList.add("active"),sourceSelection.classList.remove("active"),e.classList.add("active"),scribeCopyText.classList.remove("active");break;case"scribeStartInscription":var i=JSON.parse(JSON.stringify(hero.inventory[UI.inscription.selected.material]));i.quantity=1,i.colour=hero.inventory[UI.inscription.selected.ink].colour,"copy"==UI.inscription.mode?i.inscription={title:hero.inventory[UI.inscription.selected.source].inscription.title,content:hero.inventory[UI.inscription.selected.source].inscription.content,timeCreated:Date.now()}:i.inscription={title:inscriptionTitle.value,content:'<div class="inscribeContent">'+inscriptionTextArea.innerHTML+"</div>",timeCreated:Date.now()};var n=UI.inscription.selected.material,o=UI.inscription.selected.ink;(inventoryCheck=canAddItemToInventory([i]))[0]?(document.getElementById("slot"+inventoryCheck[1]).innerHTML=generateSlotMarkup(inventoryCheck[1]),UI.showChangeInInventory(inventoryCheck[1]),removeFromInventory(n,1),removeFromInventory(o,1),UI.updateInscriptionPanel()):UI.showNotification("<p>I don't have room in my bags for that</p>")}},updatePanelsAfterInventoryChange:function(){UI.updateInscriptionPanel(),UI.checkHeldItem(),UI.updateQuickHold()},getGameSettings:function(e){soundVolume.value=gameSettings.soundVolume,musicVolume.value=gameSettings.musicVolume,audio.adjustEffectsVolume(),audio.adjustMusicVolume()},openSettings:function(e){e&&e.preventDefault(),gameSettingsPanel.classList.add("active")},buildCollectionPanel:function(){for(var e,t,a,i,n=document.querySelectorAll("#collectionQuestPanels section"),o=0;o<n.length;o++)if(e=n[o].dataset.collection,hero.collections.hasOwnProperty(e)){var r;if(hero.collections[e].complete)(r=n[o].getElementsByTagName("P")[0]).textContent=window.atob(r.textContent),r.classList.add("active");for(var s in t="",hero.collections[e].required)i="notCollected",(a=hero.collections[e].required[s])<0&&(i=""),t+='<li class="'+i+'"><img src="/images/game-world/inventory-items/'+Math.abs(a)+'.png"></li>',n[o].getElementsByTagName("OL")[0].innerHTML=t}collectionQuestPanels.classList.add("active")},initiateCollectionQuestPanel:function(e){var t,a,i="";for(var n in hero.collections[e].required)a="notCollected",(t=hero.collections[e].required[n])<0&&(a=""),i+='<li class="'+a+'" id="'+e+"-"+Math.abs(t)+'"><img src="/images/game-world/inventory-items/'+Math.abs(t)+'.png"></li>',document.querySelector("#collection-"+e+" ol").innerHTML=i},completeCollectionQuestPanel:function(e){var t=document.querySelector("#collection-"+e+" p");t.textContent=window.atob(t.textContent),t.classList.add("active")},openChest:function(e,t){UI.showUI();var a=thisMapData[e].items[t].contains;audio.playSound(soundEffects.chestOpen,0),chestTitle.innerHTML=currentActiveInventoryItems[thisMapData[e].items[t].type].shortname;for(var i,n="",o=0;o<currentActiveInventoryItems[thisMapData[e].items[t].type].actionValue;o++){if(n+='<li id="chestSlot-'+t+"-"+o+"-"+e+'">',void 0!==a[o]&&""!=a[o])if("$"==a[o].type)n+='<img src="/images/game-world/inventory-items/coins.png" alt="'+a[o].quantity+' worth of coins">',n+="<p><em>"+parseMoney(a[o].quantity)+" worth of coins </em></p>",n+='<span class="qty">'+parseMoney(a[o].quantity)+"</span>";else{for(var r in i={quantity:1,quality:100,durability:100,currentWear:0,effectiveness:100,colour:0,enchanted:0,hallmark:0,inscription:""},a[o])i[r]=a[o][r];a[o]=i,n+=generateGenericSlotMarkup(i)}n+="</li>"}chestSlotContents.innerHTML=n,chestIdOpen=t+"-"+e,chestPanel.classList.add("active")},closeChest:function(){chestPanel.classList.remove("active"),audio.playSound(soundEffects.chestOpen,0),chestIdOpen=-1},addFromChest:function(e){var t=e.split("-"),a=t[3],i=thisMapData[a].items[t[1]].contains[t[2]];void 0!==i&&("$"==i.type?(hero.currency.money+=i.quantity,audio.playSound(soundEffects.coins,0),UI.updateCurrencies(),thisMapData[a].items[t[1]].contains[t[2]]="",document.getElementById(e).innerHTML=""):(inventoryCheck=canAddItemToInventory([i]))[0]?(thisMapData[a].items[t[1]].contains[t[2]]="",UI.showChangeInInventory(inventoryCheck[1]),document.getElementById(e).innerHTML=""):UI.showNotification("<p>I don't have room in my bags for that</p>"))},toggleUI:function(){interfaceWrapper.classList.toggle("active"),interfaceIsVisible=!interfaceIsVisible},showUI:function(){interfaceWrapper.classList.add("active"),interfaceIsVisible=!0},buildActionBar:function(){for(var e,t,a="<ol>",i=0;i<hero.actions.length;i++)"-"==hero.actions[i]?a+='<li><img src="/images/game-world/interface/actions/blank.png" alt="Empty Action slot"></li>':(null==hero.actions[i][2]?(e=hero.actions[i][1],t=hero.actions[i][0],void 0!==hero.actions[i][3]["pet-name"]&&(t+=" "+hero.actions[i][3]["pet-name"])):(e=hero.actions[i][2]+"-"+hero.actions[i][1],t=hero.actions[i][0]+" ("+hero.actions[i][1]+" type"+hero.actions[i][2]+")"),a+='<li class="active" data-index="'+i+'" data-category="'+hero.actions[i][2]+'" id="actionType'+hero.actions[i][1]+'"><img src="/images/game-world/interface/actions/'+e+'.png" alt="'+hero.actions[i][0]+' action"><p>'+t+"</p></li>");a+="</ol>",actionBar.innerHTML=a},actionBarClick:function(e){var t=getNearestParentId(e.target);if("actionType"==t.id.substring(0,10))switch(t.id.substring(10)){case"gather":if("gather"!=activeAction)if("survey"==activeAction&&surveyingStopped(),null!=(i=findItemWithinArmsLength())){if(currentActiveInventoryItems[i.type].category==t.dataset.category){if("inactive"!=i.state){for(var a in gathering.itemObject=i,gathering.itemMap=findMapNumberFromGlobalCoordinates(i.tileX,i.tileY),gathering.quality=parseInt(i.quality),gathering.quantity=100,gathering.maxQuantity=parseInt(i.quantity),gathering.purity=parseInt(i.purity),gathering.stability=parseInt(i.stability),gathering.node=i,gathering.depletionTime=5e3,gathering.modifiers=hero.actions[t.dataset.index][3],gathering.modifiers)switch(a){case"time":gathering.depletionTime+=gathering.modifiers[a];break;case"purity":gathering.purity+=gathering.modifiers[a];break;case"stability":gathering.stability+=gathering.modifiers[a];break;case"quality":gathering.quality+=gathering.modifiers[a]}gathering.quality=capValues(gathering.quality,10,100),gathering.purity=capValues(gathering.purity,10,100),gathering.stability=capValues(gathering.stability,10,100),gathering.quantity=capValues(gathering.quantity,10,100),gathering.stabilitySpeed=.002*gathering.quality,gathering.depletionSpeed=2e3/gathering.depletionTime,UI.updateGatheringPanel(),gatheringPanel.offsetHeight,gatheringOutputSlot.innerHTML="",gatheringPanel.classList.add("active"),audio.playSound(soundEffects["gather"+t.dataset.category],0),activeAction="gather"}}else UI.showNotification("<p>I don't think that's the right resource type for this action</p>");"dowse"==activeAction&&(activeAction="")}break;case"dowse":if("survey"==activeAction&&surveyingStopped(),"gather"!=activeAction)if("dowse"!=activeAction)for(var a in dowsing.range=10,dowsing.category=t.dataset.category,activeAction="dowse",dowsing.modifiers=hero.actions[t.dataset.index][3],dowsing.modifiers)switch(a){case"range":dowsing.range+=dowsing.modifiers[a]}else activeAction="",dowsing={};break;case"transcribe":""==music.currentInstrument?UI.showNotification("<p>I haven't got an instrument equipped to do that</p>"):(transcriptionPanel.classList.add("active"),music.startTranscription());break;case"plant-breeding":"survey"==activeAction&&surveyingStopped(),activeAction="pollinating",-1!=(i=findItemWithinArmsLength())&&(console.log(currentActiveInventoryItems[thisMapData.items[i].type].category),console.log(currentActiveInventoryItems[thisMapData.items[i].type].action),gameWrapper.classList.add("targetingPollen"));break;case"survey":if("gather"!=activeAction)if("survey"!=activeAction){for(var a in activeAction="survey",surveying.category=t.dataset.category,surveying.timeRequired=1e3,surveying.modifiers=hero.actions[t.dataset.index][3],surveying.modifiers)switch(a){case"time":surveying.timeRequired+=surveying.modifiers[a]}surveying.timeRequired=capValues(surveying.timeRequired,200,2e3),surveying.timeRemaining=100,surveying.depletionSpeed=500/surveying.timeRequired,UI.updateSurveyingPanel(),surveyingPanel.classList.add("active")}else surveyingStopped();break;case"mount":audio.playSound(soundEffects.whistle,0);break;case"identify":var i;if("survey"==activeAction&&surveyingStopped(),null!=(i=findItemWithinArmsLength())){var n="";for(var o in hero.catalogues)if(!hero.catalogues[o].completed){var r=hero.catalogues[o].ids.indexOf(i.type);-1!==r&&(document.querySelector("#catalogue"+o+" li[data-id='"+i.type+"']").classList.add("complete"),n="&mdash;I needed that for a catalogue",hero.catalogues[o].ids[r]=0-i.type)}UI.showNotification("<p>That's a "+currentActiveInventoryItems[i.type].shortname+n+".</p>")}}},updateGatheringPanel:function(){gatheringBarQuality.style.width=gathering.quality+"%",gatheringBarQuantity.style.width=gathering.quantity+"%",gatheringBarPurity.style.width=gathering.purity+"%",gatheringBarStability.style.width=gathering.stability+"%"},updateSurveyingPanel:function(){var e=surveying.timeRemaining/3.3333;e=92*Math.floor(e),surveyingTimeBar.style.backgroundPosition="-"+e+"px 0"},updateCraftingPanel:function(){var e=craftingObject.timeRemaining/3.3333;e=92*Math.floor(e),craftingTimeBar.style.backgroundPosition="-"+e+"px 0"},addFromGathering:function(){(inventoryCheck=canAddItemToInventory([activeGatheredObject]))[0]?(gatheringOutputSlot.innerHTML="",UI.showChangeInInventory(inventoryCheck[1]),hero.stats.itemsGathered++,gatheringPanel.classList.remove("active")):UI.showNotification("<p>I don't have room in my bags for that</p>")},updateCooldowns:function(){var e;for(var t in hero.inventory)void 0!==hero.inventory[t].cooldown&&hero.inventory[t].cooldownTimer>0&&(hero.inventory[t].cooldownTimer--,e=hero.inventory[t].cooldownTimer/hero.inventory[t].cooldown,document.querySelector("#slot"+t+" .coolDown").style.transform="scaleY("+e+")")},handleRightClick:function(e){console.log("right click"),console.log(e);var t=getNearestParentId(e.target);console.log(t.id)},buildQuestJournal:function(e,t){questJournalEntries.innerHTML=e;var a='<option value="all">Show all</option>';for(var i in t)a+='<option value="'+t[i]+'">'+t[i]+"</option>";questJournalRegionFilter.innerHTML=a,questJournalRegionFilter.onchange=UI.filterJournal,questJournal.classList.add("active")},filterJournal:function(e){var t,a=document.querySelectorAll("#questJournalEntries li");if("all"==questJournalRegionFilter.value)for(t=0;t<a.length;++t)a[t].classList.add("active");else for(t=0;t<a.length;++t)a[t].dataset.region==questJournalRegionFilter.value?a[t].classList.add("active"):a[t].classList.remove("active")},toggleJournal:function(){questJournal.classList.toggle("active")},addToQuestJournal:function(e){questJournalEntries.innerHTML=e.markup+questJournalEntries.innerHTML;for(var t=!1,a=-1,i=0;i<questJournalRegionFilter.length;i++){if(questJournalRegionFilter.options[i].value==e.regions){t=!0;break}"all"!=questJournalRegionFilter.options[i].value&&questJournalRegionFilter.options[i].value>e.regions&&-1==a&&(a=i)}if(!t){var n=document.createElement("OPTION");n.innerText=e.regions,n.value=e.regions,questJournalRegionFilter.options.add(n,a)}},movePlotPlacementOverlay:function(e){cursorPositionX=e.pageX,cursorPositionY=e.pageY},openPost:function(e,t){UI.showUI(),postObject.x=e,postObject.y=t,postObject.active=!0,postPanel.classList.add("active"),audio.playSound(soundEffects.bookOpen,0)},closePost:function(){postObject.active=!1,postPanel.classList.remove("active")},readPostMessage:function(e){var t=document.getElementById(e);if(t.classList.contains("unread")&&(t.classList.remove("unread"),sendDataWithoutNeedingAResponse("/game-world/readPost.php?id="+e),0==document.querySelectorAll("#receivedPostPanel .unread").length&&newPost.classList.remove("active")),t.hasAttribute("data-quest")){var a=t.getAttribute("data-quest");canOpenQuest(a)&&openQuest(a)}var i="postMessage"+e.substr(4);document.getElementById(i).classList.add("active")},takePostAttachments:function(e){getJSON("/game-world/getPostAttachment.php?id="+e,function(e){if("null"!=e.item)if((inventoryCheck=canAddItemToInventory(e.item))[0]){UI.showChangeInInventory(inventoryCheck[1]);var t=document.querySelectorAll("#postMessage"+e.id+" .postSlot");for(i=0;i<t.length;++i)t[i].outerHTML="";document.querySelector("#post"+e.id+" .previewSlot").innerHTML="",sendDataWithoutNeedingAResponse("/game-world/gotPostAttachment.php?id="+e.id)}else UI.showNotification("<p>I don't have room in my bags for that</p>")},function(t){UI.takePostAttachments(e)})},postPanelSingleClick:function(e){switch(e.target.id){case"sendPostTab":sendPostTab.classList.add("active"),sendPostPanel.classList.add("active"),receivedPostTab.classList.remove("active"),receivedPostPanel.classList.remove("active");break;case"receivedPostTab":sendPostTab.classList.remove("active"),sendPostPanel.classList.remove("active"),receivedPostTab.classList.add("active"),receivedPostPanel.classList.add("active");break;case"sendPost":sendUserPost('{"subject":"'+sendPostSubject.value+'","message":"'+sendPostMessage.value.replace(/\n/g,"\\\\n")+'","senderID":"'+characterId+'","attachments":0,"recipientCharacterName":"'+sendPostCharacter.value+'","fromName":"Eleaddai"}')}},initRetinueTimers:function(){for(var e=document.getElementsByClassName("retinueQuestTimer"),t=0;t<e.length;t++)retinueQuestTimers.push([e[t],(new Date).getTime()+60*e[t].dataset.minutes*1e3,""])},updateRetinueTimers:function(){for(var e,t,a=(new Date).getTime(),i=0;i<retinueQuestTimers.length;i++){e=retinueQuestTimers[i][1]-a;var n,o=Math.floor(e/1e3%60),r=Math.floor(e/6e4%60),s=Math.floor(e/36e5%24);(t=(n=Math.floor(e/864e5))>1?n+" days remaining":1==n?"1 day remaining":s>1?s+" hours remaining":1==s?"1 hour remaining":r>1?r+" minutes remaining":1==r?"1 minute remaining":o>1?o+" seconds remaining":1==o?"1 second remaining":"complete")!=retinueQuestTimers[i][2]&&(retinueQuestTimers[i][0].innerHTML=t,retinueQuestTimers[i][2]=t),"complete"==t&&(UI.retinueQuestComplete(retinueQuestTimers[i][0]),retinueQuestTimers.splice(i,1),i--)}},openRetinuePanel:function(e){UI.showUI(),retinuePanel.classList.add("active"),audio.playSound(soundEffects.bookOpen,0),retinueObject.active=!0,retinueObject.x=e.x,retinueObject.y=e.y,retinueObject.passedObject=e},closeRetinuePanel:function(){retinuePanel.classList.remove("active"),void 0!==retinueObject.passedObject&&void 0!==retinueObject.passedObject.speechIndex&&retinueObject.passedObject.speechIndex--,retinueObject={active:!1}},resetRetinuePanels:function(){var e=document.getElementsByClassName("retinueQuestLocationDetailPanel");for(i=0;i<e.length;i++)e[i].classList.remove("active");retinueQuestStart.disabled=!0,retinueQuestTimeRequired.innerHTML="Time required:";var t=document.getElementsByClassName("followerSlot");for(i=0;i<t.length;i++)t[i].innerHTML="";if(retinueObject.followersAdded)for(i=0;i<retinueObject.followersAdded.length;i++)"null"!=retinueObject.followersAdded[i]&&document.getElementById("retinueFollower"+retinueObject.followersAdded[i]).classList.add("available")},openRetinueDetailPanel:function(e){if(e.target.classList.contains("undiscovered")){if(e.target.classList.contains("explorable")){UI.resetRetinuePanels(),retinueExplorePanel.classList.add("active"),retinueObject.openQuestDetail="Exploring",retinueObject.destinationLocationX=e.target.getAttribute("data-locationx"),retinueObject.destinationLocationY=e.target.getAttribute("data-locationy"),retinueObject.followersRequired=Math.ceil(getPythagorasDistance(retinueBaseLocationX,retinueBaseLocationY,retinueObject.destinationLocationX,retinueObject.destinationLocationY)/277);var t=document.querySelectorAll("#retinueExplorePanel .followerSlot");for(a=0;a<t.length;++a)t[a].style.display="none";for(var a=0;a<retinueObject.followersRequired;a++)document.getElementById("dropFollowersPanelExplore-"+a).style.display="block";retinueObject.hasToReturnToBase=1,retinueObject.questName="Exploring",retinueObject.followersAdded=[];for(a=0;a<retinueObject.followersRequired;a++)retinueObject.followersAdded.push("null");var i=e.target.id.split("_");retinueObject.hexCoordX=i[1],retinueObject.hexCoordY=i[2]}}else{var n=e.target.id.substring(20);UI.resetRetinuePanels(),retinueExplorePanel.classList.remove("active"),retinueObject.openQuestDetail=n;var o=document.getElementById("retinueQuestLocationDetail"+n);retinueObject.followersRequired=o.getAttribute("data-requires"),retinueObject.destinationLocationX=o.getAttribute("data-locationx"),retinueObject.destinationLocationY=o.getAttribute("data-locationy"),retinueObject.hasToReturnToBase=o.getAttribute("data-requiresreturn"),retinueObject.questName=o.getAttribute("data-questname"),retinueObject.followersAdded=[];for(a=0;a<retinueObject.followersRequired;a++)retinueObject.followersAdded.push("null");o.classList.add("active")}},endFollowerDrag:function(e){var t=getNearestParentId(e.target);if(-1!==t.id.indexOf("dropFollowersPanel")){var a,n,o=t.id.split("-")[1];"null"!=retinueObject.followersAdded[o]&&document.getElementById("retinueFollower"+retinueObject.followersAdded[o]).classList.add("available"),retinueObject.followersAdded[o]=retinueObject.draggedFollower,-1===retinueObject.followersAdded.indexOf("null")&&(retinueQuestStart.disabled=!1);var r=0,s="";for(i=0;i<retinueObject.followersAdded.length;i++)"null"!=retinueObject.followersAdded[i]&&(n=getRetinueQuestTime((a=document.getElementById("retinueFollower"+retinueObject.followersAdded[i])).getAttribute("data-locationx"),a.getAttribute("data-locationy"),retinueObject.destinationLocationX,retinueObject.destinationLocationY,retinueObject.hasToReturnToBase))[0]>r&&(r=n[0],s=n[1]);retinueObject.timeRequired=r,retinueQuestTimeRequired.innerHTML="Time required: "+s,UI.draggedOriginal.classList.remove("hasDragCopy"),UI.activeDragObject.style.cssText="left: -100px; top: -100px;",t.innerHTML='<img src="/images/retinue/'+retinueObject.draggedFollower+'.png">',document.getElementById("retinueFollower"+retinueObject.draggedFollower).classList.remove("available")}else UI.activeDragObject.style.cssText="z-index:4;left: "+objInitLeft+"px; top: "+objInitTop+"px;transition: transform 0.4s ease;",UI.activeDragObject.addEventListener(whichTransitionEvent,function e(t){return UI.draggedOriginal.classList.remove("hasDragCopy"),t.currentTarget.style.cssText="left: -100px; top: -100px;",t.currentTarget.removeEventListener(whichTransitionEvent,e,!1)},!1);document.removeEventListener("mousemove",UI.handleDrag,!1),document.removeEventListener("mouseup",UI.endFollowerDrag,!1),UI.activeDragObject=""},addFollowersToQuest:function(){var e=[];for(i=0;i<retinueObject.followersAdded.length;i++)document.querySelector("#retinueFollower"+retinueObject.followersAdded[i]+" p").innerHTML='active on "'+retinueObject.questName+'" <span class="retinueQuestTimer" data-minutes="'+retinueObject.timeRequired+'"></span>',retinueQuestTimers.push([document.querySelector("#retinueFollower"+retinueObject.followersAdded[i]+" .retinueQuestTimer"),(new Date).getTime()+60*retinueObject.timeRequired*1e3,""]),e.push(retinueObject.followersAdded[i]),document.getElementById("retinueFollower"+retinueObject.followersAdded[i]).setAttribute("data-activeonquest",retinueObject.openQuestDetail);if("Exploring"==retinueObject.openQuestDetail){var t=document.getElementById("undiscovered_"+retinueObject.hexCoordX+"_"+retinueObject.hexCoordY);t.classList.remove("explorable"),t.classList.add("beingExplored"),getJSON("/game-world/generateExplorationRetinueQuest.php?chr="+characterId+"&followers="+e.join("|")+"&hexCoordX="+retinueObject.hexCoordX+"&hexCoordY="+retinueObject.hexCoordY,function(e){if(e.markup){retinuePanel.insertAdjacentHTML("beforeend",e.markup);var t=e.followers.split(",");for(console.log(e.followers),i=0;i<t.length;i++)document.getElementById("retinueFollower"+t[i]).setAttribute("data-activeonquest",e.questId)}},function(e){}),retinueExplorePanel.classList.remove("active"),delete retinueObject.hexCoordX,delete retinueObject.hexCoordY}else sendDataWithoutNeedingAResponse("/game-world/updateRetinueQuest.php?questID="+retinueObject.openQuestDetail+"&chr="+characterId+"&followers="+e.join("|")),document.getElementById("retinueQuestLocationDetail"+retinueObject.openQuestDetail).classList.remove("active"),document.getElementById("retinueQuestLocation"+retinueObject.openQuestDetail).classList.remove("active");retinueQuestStart.disabled=!0,retinueQuestTimeRequired.innerHTML="Time required:",delete retinueObject.draggedFollower,delete retinueObject.openQuestDetail,delete retinueObject.followersAdded,delete retinueObject.followersRequired,delete retinueObject.destinationLocationX,delete retinueObject.destinationLocationY,delete retinueObject.hasToReturnToBase,delete retinueObject.timeRequired,delete retinueObject.questName},retinueSingleClick:function(e){var t=getNearestParentId(e.target);switch(e.target.className){case"takeRewards":e.preventDefault(),retinueMissionCompleted(t.id.substring(15),!1);break;case"finishExploration":e.preventDefault(),retinueMissionCompleted(t.id.substring(15),!0);break;case"reHireFollowerNo":e.preventDefault();var a=e.target.getAttribute("data-follower");retinueList.removeChild(document.getElementById("retinueFollower"+a)),sendDataWithoutNeedingAResponse("/game-world/removeHiredFollower.php?id="+questId),t.classList.remove("active");break;case"reHireFollowerYes":e.preventDefault(),hero.currency.money>=costToRehireFollower?(hero.currency.money-=costToRehireFollower,UI.updateCurrencies(),audio.playSound(soundEffects.coins,0)):UI.showNotification("<p>I haven't got enough money</p>"),t.classList.remove("active")}},retinueQuestComplete:function(e){var t=getNearestParentId(e).getAttribute("data-activeonquest");document.getElementById("retinueComplete"+t).classList.add("active")},showNewFollower:function(e,t){UI.showNotification("<p>I've gained a new follower called &quot;"+t+"&quot;</p>")},showNewProfession:function(e){UI.showNotification("<p>I learned a new profession - #"+e+"</p>")},buildHorticulturePanel:function(e){horticulturePanel.insertAdjacentHTML("beforeend",e),horticulturePanel.classList.add("active")},holdItem:function(e){hero.holding.hash=hero.inventory[e].hash,hero.holding.type=hero.inventory[e].type,UI.updateHeldItems();for(var t=quickHold.querySelectorAll("li"),a=0;a<t.length;a++)if(t[a].dataset.hash==hero.holding.hash){hero.holding.quickHoldIndex=a;break}UI.updateQuickHold()},updateHeldItems:function(){if(""!=hero.holding.hash){var e="",t=getColourName(hero.inventory[findSlotByHash(hero.holding.hash)].colour,hero.holding.type);""!=t&&(e="-"+t.toLowerCase()),holdingIcon.innerHTML='<img src="/images/game-world/inventory-items/'+hero.holding.type+e+'.png" alt="'+currentActiveInventoryItems[hero.holding.type].shortname+'">',UI.updateHeldItemGauge()}else holdingIcon.innerHTML="",holdingGauge.classList.remove("active")},updateHeldItemGauge:function(){var e=hero.inventory[findSlotByHash(hero.holding.hash)];if(void 0!==e.contains){var t=e.contains[0].quantity/currentActiveInventoryItems[e.type].actionValue*100;holdingGauge.className="gauge"+currentActiveInventoryItems[e.contains[0].type].shortname,holdingGauge.querySelector("span").style.width=t+"%",holdingGauge.classList.add("active")}else holdingGauge.classList.remove("active")},checkHeldItem:function(){if(""!=hero.holding.hash&&-1==findSlotByHash(hero.holding.hash)){var e=findSlotItemIdInInventory(hero.holding.type);e.length>0?(hero.holding.hash=hero.inventory[e[0]].hash,hero.holding.type=""):(hero.holding.hash="",hero.holding.type="",UI.updateHeldItems())}},updateQuickHold:function(){var e,t,a="<ul>",i=1,n=[];for(var o in hero.inventory)1==currentActiveInventoryItems[hero.inventory[o].type].holdable&&n.push(o);n=n.sort(),a+='<li id="quickHold0" data-type="empty" data-hash=""><img src="/images/game-world/inventory-items/empty.png" alt="Empty"></li>';for(var r=0;r<n.length;r++)o=n[r],a+='<li id="quickHold'+i+'" ',i===hero.holding.quickHoldIndex&&(a+='class="active" '),a+='data-type="'+hero.inventory[o].type+'" data-hash="'+hero.inventory[o].hash+'">',e="",""!=(t=getColourName(hero.inventory[o].colour,hero.inventory[o].type))&&(e="-"+t.toLowerCase()),a+='<img src="/images/game-world/inventory-items/'+hero.inventory[o].type+e+'.png" alt="'+currentActiveInventoryItems[hero.inventory[o].type].shortname+'"></li>',i++;a+="</ul>",quickHold.innerHTML=a,hero.quickHoldLength=i},moveQuickHold:function(e){document.getElementById("quickHold"+hero.holding.quickHoldIndex).classList.remove("active"),hero.holding.quickHoldIndex+=e,hero.holding.quickHoldIndex<0?hero.holding.quickHoldIndex=hero.quickHoldLength-1:hero.holding.quickHoldIndex>=hero.quickHoldLength&&(hero.holding.quickHoldIndex=0);var t=document.getElementById("quickHold"+hero.holding.quickHoldIndex);t.classList.add("active"),0==hero.holding.quickHoldIndex?(hero.holding.hash="",hero.holding.type=""):(hero.holding.hash=t.dataset.hash,hero.holding.type=t.dataset.type),UI.updateHeldItems(),quickHold.classList.add("active"),quickHold.addEventListener(whichTransitionEvent,function e(t){return quickHold.classList.remove("active"),t.currentTarget.removeEventListener(whichTransitionEvent,e,!1)},!1)},createTreasureMap:function(e){if(-1===hero.activeTreasureMaps.indexOf(e)){var t='<div class="treasureMap" id="treasureMap'+e+'"><div class="draggableBar">X marks the spot...</div><button class="closePanel">close</button>',a=e.split("_");t+='<img src="/game-world/generateMapImage.php?playerId='+characterId+"&sepia=true&tileX="+a[0]+"&tileY="+a[1]+'&radius=12&scale=0.3&overlay=true">',t+="</div>",treasureMapPanels.insertAdjacentHTML("beforeend",t),hero.activeTreasureMaps.push(e)}},showTreasureMap:function(e){document.getElementById("treasureMap"+e).classList.add("active")},openHireFollowerPanel:function(e){hireRetinueFollowerPanelContent.innerHTML='<img src="/images/retinue/'+e.followerId+'.png" alt="">Would you like to hire '+e.name+"?",hireRetinueFollowerPanel.classList.add("active"),hireRetinueFollowerPanel.setAttribute("data-NPC",e.uniqueIndex)},closeHireFollowerPanel:function(){hireRetinueFollowerPanel.classList.remove("active"),dialogue.classList.add("slowerFade"),dialogue.classList.remove("active")},touchTapAction:function(){key[4]=1},openHousingPanel:function(){housingPanel.classList.add("active")},openHousingConstructionPanel:function(){housingConstructionPanel.classList.add("active"),document.addEventListener("click",housingNameSpace.worldClickHandler,!1),document.addEventListener("mousemove",housingNameSpace.mouseMove,!1),hero.housing.draftCost&&0!=hero.housing.draftCost&&(housingNameSpace.runningCostTotal=hero.housing.draftCost),housingNameSpace.restoreDraft=JSON.parse(JSON.stringify(hero.housing.draft)),changeWeather(""),gameMode="housing"},closeHousingConstructionPanel:function(){housingConstructionPanel.classList.remove("active"),document.removeEventListener("click",housingNameSpace.worldClickHandler,!1),document.removeEventListener("mousemove",housingNameSpace.mouseMove,!1),gameMode="play"},showYesNoDialogueBox:function(e,t,a,i,n){yesNoDialogueButton1.innerText=t;var o=i.split(".");o.length>1?yesNoDialogueButton1.onclick=window[o[0]][o[1]]:yesNoDialogueButton1.onclick=window[i],yesNoDialogueButton2.innerText=a;var r=n.split(".");r.length>1?yesNoDialogueButton2.onclick=window[r[0]][r[1]]:yesNoDialogueButton2.onclick=window[n],yesNoDialogueHeading.innerHTML=e,yesNoDialoguePanel.classList.add("active")},hideYesNoDialogueBox:function(){yesNoDialoguePanel.classList.remove("active")},generatePetInventorySlot:function(e){var t,a="",i=hero.allPets[e],n="";-1!=hero.activePets.indexOf(e)&&(n=" active"),a+='<div class="inventoryBag'+n+'" id="petInventoryBag'+e+'"><div class="draggableBar">'+i.name+'</div><ol id="bag'+e+'">';for(var o=0;o<i.inventorySize;o++)a+='<li id="slot'+(t="p"+e+"-"+o)+'">',t in hero.inventory?(a+=generateSlotMarkup(t),currentActiveInventoryItems[hero.inventory[t].type].action):a+="",a+="</li>";return a+="</ol></div></div>"},openBank:function(e,t,a){UI.showUI(),bankObject.x=e,bankObject.y=t,bankObject.active=!0,void 0!==a&&(bankObject.passedObject=a),inventoryBankTitle.innerHTML=thisMapData[currentMap].zoneName+" bank",inventoryBank.classList.add("active"),audio.playSound(soundEffects.bagOpen,0)},closeBank:function(){void 0!==bankObject.passedObject&&void 0!==bankObject.passedObject.speechIndex&&bankObject.passedObject.speechIndex--,bankObject.active=!1,delete bankObject.passedObject,inventoryBank.classList.remove("active")},addBankSlots:function(){UI.hideYesNoDialogueBox();var e="";hero.currency.money-=amountForTheNextBankSlot,amountForTheNextBankSlot*=2.8,UI.updateCurrencies(),audio.playSound(soundEffects.coins,0);for(var t=hero.bags[UI.whichInvenotryPanelIsTheBank].bankSlots,a=1;a<=2;a++)e+='<li id="slot'+UI.whichInvenotryPanelIsTheBank+"-"+(t+a)+'"></li>';document.getElementById("bag"+UI.whichInvenotryPanelIsTheBank).insertAdjacentHTML("beforeend",e),hero.bags[UI.whichInvenotryPanelIsTheBank].bankSlots+=2,hero.bags[UI.whichInvenotryPanelIsTheBank].bankSlots==maximumBankSlotsPossible&&(document.getElementById("bankBuyMoreSlots").style.display="none")},buyMoreBankSlots:function(){hero.bags[UI.whichInvenotryPanelIsTheBank].bankSlots<maximumBankSlotsPossible?hero.currency.money>=amountForTheNextBankSlot?UI.showYesNoDialogueBox("Purchase 3 more bank slots for "+parseMoney(amountForTheNextBankSlot)+"?","Yes","No","UI.addBankSlots","UI.hideYesNoDialogueBox"):UI.showNotification("<p>I don't have enough money&hellip;</p>"):UI.showNotification("<p>I've already got as many as I can have.</p>")}};function setupWeather(){if(updatePossibleWeather(),isOverWorldMap){if(""!=outsideWeather)changeWeather(outsideWeather);else{var e=currentWeather;1==allPossibleWeather.length?changeWeather(allPossibleWeather[0]):-1!==allPossibleWeather.indexOf(e)?changeWeather(e):changeWeather(getRandomElementFromArray(allPossibleWeather))}outsideWeather=""}else""==outsideWeather&&(outsideWeather=currentWeather,changeWeather(""));weatherLastChangedTime=hero.totalGameTimePlayed}function updatePossibleWeather(){allPossibleWeather=[];for(var e=0;e<visibleMaps.length;e++)allPossibleWeather=allPossibleWeather.concat(thisMapData[visibleMaps[e]].weather)}function checkForWeatherChange(){isOverWorldMap&&allPossibleWeather.length>1&&hero.totalGameTimePlayed-weatherLastChangedTime>minTimeBetweenWeatherChanges&&changeWeather(getRandomElementFromArray(allPossibleWeather))}function changeWeather(e){e!=currentWeather&&(weatherLastChangedTime=hero.totalGameTimePlayed,""!=currentWeather&&document.getElementById(currentWeather).classList.remove("active"),""!=(currentWeather=e)&&document.getElementById(currentWeather).classList.add("active"),currentWeather in soundEffects&&audio.playSound(soundEffects[currentWeather],0))}function workshopSelectHireApprentice(e){var t=e.target.closest(".hireApprentice"),a="",n="",o=t.querySelectorAll("select");for(i=0;i<o.length;++i)a+=o[i].value,""!=n&&(n+="-"),n+=o[i].value;var r=t.querySelector("input[name=hireApprenticeName]").value;-1!==t.getAttribute("data-allapprenticenames").indexOf(r)&&(t.querySelector("input[name=hireApprenticeName]").value=t.getAttribute("data-"+a)),t.querySelector(".apprenticePortrait").src="/images/retinue/source/"+n+".png"}function workshopApprenticeNameChange(e){var t=e.target.closest(".hireApprentice"),a=e.target.value;-1!==t.getAttribute("data-allapprenticenames").indexOf(a)&&e.target.setSelectionRange(0,e.target.value.length)}function hireApprentice(e){var t=e.target.closest(".workshop"),a=e.target.getAttribute("data-cost");if(hero.currency.money>=a){hero.currency.money-=a,UI.updateCurrencies(),audio.playSound(soundEffects.coins,0);var i=t.querySelector("input[name=hireApprenticeName]").value,n={name:i},o=t.querySelectorAll(".hireApprentice select"),r="";for(l=0;l<o.length;++l)""!=r&&(r+="-"),r+=o[l].value,n[o[l].getAttribute("data-key")]=o[l].value;var s='<li><img src="/images/retinue/source/'+r+'.png" alt=""><h6>'+i+"</h6></li>";t.querySelector(".activeApprentices ol").insertAdjacentHTML("beforeend",s);for(var c=t.getAttribute("data-workshopname"),l=0;l<thisMapData[currentMap].workshops.length;l++)if(thisMapData[currentMap].workshops[l].name==c){thisMapData[currentMap].workshops[l].apprentices.push(n);var h=thisMapData[currentMap].workshops[l].apprentices.length;break}if(h>=t.getAttribute("data-maxapprentices"))t.querySelector(".hireApprentice").style.display="none";else{var d=(h+1)*(h+1)*1e4,u="Hire this apprentice ("+parseMoney(d)+")";t.querySelector(".primaryButton").setAttribute("data-cost",d),t.querySelector(".primaryButton").innerHTML=u}var p=r.split("-"),g="data-"+p[0]+p[1];sendGetData("/game-world/generateProceduralName.php?sex="+p[1]+"&race="+p[0],function(e){t.querySelector("input[name=hireApprenticeName]").value=e,t.querySelector(".hireApprentice").setAttribute(g,e);var a=t.querySelector(".hireApprentice").getAttribute("data-allapprenticenames");console.log("was: "+a),a=a.replace(i,e),console.log("now: "+a),t.querySelector(".hireApprentice").setAttribute("data-allapprenticenames",a)},function(e){})}else UI.showNotification("<p>I don't have enough money</p>")}function appendRecipeData(e){for(var t in e)detailedRecipeData.hasOwnProperty(t)||(detailedRecipeData[t]=e[t])}function addItemToWorkshopQueue(){hero.stats.itemsCraftedAtWorkshop++;for(var e={item:craftingObject.craftedItem,fromWhichRecipe:craftingObject.recipeId,finalImageSrc:craftingObject.finalImageSrc,finalItemName:craftingObject.finalItemName,startTime:Date.now(),hash:generateHash(craftingObject.finalItemName+Date.now())},t=0;t<thisMapData[currentMap].workshops.length;t++)if(thisMapData[currentMap].workshops[t].name==craftingObject.whichWorkshop){thisMapData[currentMap].workshops[t].itemsQueued.push(e);break}releaseLockedSlots(),updateInventoryAfterCrafting(),recipeSelectComponents(craftingObject.whichRecipe,!0),console.log(JSON.stringify(thisMapData[currentMap].workshops))}function loadNewWorkshopRecipeData(e,t){getJSON("/game-world/getRecipeDetails.php?recipe="+e,function(a){appendRecipeData(a.recipe);var i='<li data-recipe="'+e+'">';i+='<img src="/images/game-world/inventory-items/'+a.recipe[e].imageId+'.png" alt=""><h3>'+a.recipe[e].recipeName+"</h3><p>"+a.recipe[e].recipeDescription+"</p></li>",t.querySelector(".availableRecipes ol").insertAdjacentHTML("beforeend",i),thisDevicesScrollBarWidth>0&&window[t.id].init()},function(t){loadNewWorkshopRecipeData(e)})}function addRecipeToWorkshop(e,t){for(var a=t.getAttribute("data-workshopname"),i=0;i<thisMapData[currentMap].workshops.length;i++)if(thisMapData[currentMap].workshops[i].name==a){thisMapData[currentMap].workshops[i].recipesKnown.push(e.contains);break}loadNewWorkshopRecipeData(e.contains,t)}function checkIfWorkshopItemIsComplete(e){if(e.hasAttribute("data-complete")){var t=JSON.parse(e.getAttribute("data-item")),a=canAddItemToInventory([t]);if(a[0])UI.showChangeInInventory(a[1]);else{var i="Your crafted "+e.getAttribute("data-name"),n=activeObjectForDialogue.name;sendNPCPost('{"subject":"'+i+'","message":"Some of our finest work...","senderID":"-1","recipientID":"'+characterId+'","fromName":"'+n+'"}',[t]),UI.showNotification("<p>My workshop item is in the post</p>")}for(var o=e.closest(".workshop").getAttribute("data-workshopname"),r=e.getAttribute("data-hash"),s=0;s<thisMapData[currentMap].workshops.length;s++)if(thisMapData[currentMap].workshops[s].name==o)for(var c=0;c<thisMapData[currentMap].workshops[s].itemsQueued.length;c++)if(thisMapData[currentMap].workshops[s].itemsQueued[c].hash==r){delete thisMapData[currentMap].workshops[s].itemsQueued[c];break}e.remove()}}function sizeCanvasSize(){availableScreenWidth=window.innerWidth,availableScreenHeight=window.innerHeight,screen.width<window.innerWidth&&(availableScreenWidth=screen.width),screen.height<window.innerHeight&&(availableScreenHeight=screen.height),gameContext.canvas.width=availableScreenWidth,gameContext.canvas.height=availableScreenHeight,reflectionContext.canvas.width=availableScreenWidth,reflectionContext.canvas.height=availableScreenHeight,waterContext.canvas.width=availableScreenWidth,waterContext.canvas.height=availableScreenHeight,lightMapContext.canvas.width=availableScreenWidth,lightMapContext.canvas.height=availableScreenHeight,canvasWidth=availableScreenWidth,canvasHeight=availableScreenHeight}"serviceWorker"in navigator&&navigator.serviceWorker.register("/game-world/serviceWorker.min.js",{updateViaCache:"imports",scope:"/game-world/"});var debouncedResize=debounce(function(){reflectionContext.setTransform(1,0,0,1,0,0),waterContext.setTransform(1,0,0,1,0,0),sizeCanvasSize(),reflectionContext.scale(1,-1),waterContext.scale(1,-1)},250);function loadGlobalMapData(){getJSON("/data/world-map.json",function(e){worldMap=e.worldMap,init()},function(e){loadGlobalMapData()})}function init(){(gameCanvas=document.getElementById("gameWorld")).getContext&&(gameContext=gameCanvas.getContext("2d"),lightMapOverlay=document.createElement("canvas"),lightMapContext=lightMapOverlay.getContext("2d"),reflectedCanvas=document.createElement("canvas"),reflectionContext=reflectedCanvas.getContext("2d"),oceanCanvas=document.createElement("canvas"),oceanContext=oceanCanvas.getContext("2d"),waterCanvas=document.createElement("canvas"),waterContext=waterCanvas.getContext("2d"),sizeCanvasSize(),reflectionContext.scale(1,-1),waterContext.scale(1,-1),whichTransitionEvent=determineWhichTransitionEvent(),whichAnimationEvent=determineWhichAnimationEvent(),gameMode="mapLoading",cartographyCanvas=document.getElementById("cartographyCanvas"),cartographyContext=cartographyCanvas.getContext("2d"),offScreenCartographyCanvas=document.getElementById("offScreenCartographyCanvas"),offScreenCartographyContext=offScreenCartographyCanvas.getContext("2d"),canvasMapImage=new Image,canvasMapMaskImage=new Image,UI.init(),audio.init(),Input.init(),gameLoop(),getHeroGameState())}function getHeroGameState(){getJSON("/game-world/getCoreData.php?chr="+characterId,function(e){for(var t in e.gameState)hero[t]=e.gameState[t];for(var a in newMap=findMapNumberFromGlobalCoordinates(e.gameState.tileX,e.gameState.tileY),gameSettings=e.gameState.settings,timeSinceLastAmbientSoundWasPlayed=hero.totalGameTimePlayed+1.25*minTimeBetweenAmbientSounds,e.gameState.allPets&&e.gameState.activePets.length>0&&(hasActivePet=!0),e.gameState.fae)fae[a]=e.gameState.fae[a];(currentMap=newMap)>0&&sendDataWithoutNeedingAResponse("/game-world/generateCircularDungeonMap.php?playerId="+characterId+"&clearMaps=true"),hero.x=getTileCentreCoordX(hero.tileX),hero.y=getTileCentreCoordY(hero.tileY),hero.isox=findIsoCoordsX(hero.x,hero.y),hero.isoy=findIsoCoordsY(hero.x,hero.y),colourNames=e.colours.colourNames,UI.buildHorticulturePanel(e.horticulture.markup),hero.plantBreeding=e.horticulture.data,questData=e.quests,possibleTitles=e.titles,housingData=e.housingItems,cardGameNameSpace.allCardData=e.cards.cards,hero.cardBacks=e.cards.backs,hero.activeCardBack=e.cards.activeBack,UI.changeActiveCardBack(),hero.crafting=e.recipes.professions,allRecipes=e.recipes.all,currentItemGroupFilters=e.recipes.itemGroups,UI.buildQuestJournal(e.journal.markup,e.journal.regions),loadCoreAssets()},function(e){getHeroGameState()})}function loadCoreAssets(){var e=[];if(e.push({name:"heroImg",src:"/images/game-world/core/hero.png"}),e.push({name:"shadowImg",src:"/images/game-world/core/shadow-quarter.png"}),e.push({name:"tilledEarth",src:"/images/game-world/core/tilled.png"}),e.push({name:"tileMask",src:"/images/game-world/core/tile-mask.png"}),e.push({name:"addedWater",src:"/images/game-world/core/added-water.png"}),e.push({name:"ocean",src:"/images/game-world/core/animated-ocean.png"}),hasActivePet)for(var t=0;t<hero.activePets.length;t++)e.push({name:"activePet"+hero.activePets[t],src:"/images/game-world/npcs/"+hero.allPets[hero.activePets[t]].src});Loader.preload(e,prepareCoreAssets,loadingProgress)}function prepareCoreAssets(){if(heroImg=Loader.getImage("heroImg"),shadowImg=Loader.getImage("shadowImg"),tilledEarth=Loader.getImage("tilledEarth"),tileMask=Loader.getImage("tileMask"),addedWater=Loader.getImage("addedWater"),ocean=Loader.getImage("ocean"),oceanSpriteWidth=ocean.width/oceanNumberOfFrames,oceanSpriteHeight=ocean.height,oceanContext.canvas.width=oceanSpriteWidth,oceanContext.canvas.height=oceanSpriteHeight,hasActivePet)for(var e=0;e<hero.activePets.length;e++)activePetImages[e]=Loader.getImage("activePet"+hero.activePets[e]);housingNameSpace.init(),loadMap()}function initialisePet(e,t,a){hero.allPets[hero.activePets[e]].tileX=hero.tileX+t*(e+1),hero.allPets[hero.activePets[e]].tileY=hero.tileY+a*(e+1),isOverWorldMap||(hero.allPets[hero.activePets[e]].state=0==e?"moving":"queuing"),hero.allPets[hero.activePets[e]].state="moving",hero.allPets[hero.activePets[e]].facing=hero.facing}function initialisePetObject(e){var t=hero.allPets[hero.activePets[e]];t.x=getTileCentreCoordX(t.tileX),t.y=getTileCentreCoordY(t.tileY),isOverWorldMap?t.z=getElevation(t.tileX,t.tileY):t.tileX<0||t.tileY<0||t.tileX>=mapTilesX||t.tileY>=mapTilesY?t.z=defaultElevation:t.z=getElevation(t.tileX,t.tileY),t.dx=0,t.dy=0,t.foundPath="","queuing"!=t.state&&(t.state="wait"),t.following=0==e?hero:hero.allPets[hero.activePets[i-1]],t.breadcrumb=[];for(var a=0;a<breadCrumbLength;a++)t.breadcrumb[a]=[t.tileX,t.tileY]}function processInitialMap(){var e,t,a=0,i=0;if(-1!=hero.tileX.toString().indexOf("?")&&((e=hero.tileX.toString().substring(1)).length>0&&(a=parseInt(e)),hero.tileX=thisMapData[currentMap].entrance[0]+a),-1!=hero.tileY.toString().indexOf("?")&&((t=hero.tileY.toString().substring(1)).length>0&&(i=parseInt(t)),hero.tileY=thisMapData[currentMap].entrance[1]+i),hasActivePet){var n=0,o=0;switch(hero.facing){case"n":o=1;break;case"s":o=-1;break;case"e":n=-1;break;case"w":n=1}for(var r=0;r<hero.activePets.length;r++)initialisePet(r,n,o)}if(mapTilesY=thisMapData[currentMap].terrain.length,mapTilesX=thisMapData[currentMap].terrain[0].length,updateZoneName(),cartography.init(),thisMapData[currentMap].showOnlyLineOfSight){lightMap=[];for(var s=mapTilesY-1;s>=0;s--){for(var c=[],l=mapTilesX-1;l>=0;l--)c[l]=0;lightMap[s]=c}updateLightMap()}thisMapData[currentMap].ambientSounds&&audio.loadAmbientSounds(thisMapData[currentMap].ambientSounds),thisMapData[currentMap].hourChime&&audio.loadAmbientSounds({hourChime:thisMapData[currentMap].hourChime}),fae.recentHotspots=[],findInventoryItemData()}function updateZoneName(){previousZoneName!=thisMapData[currentMap].zoneName&&(UI.showZoneName(thisMapData[currentMap].zoneName),document.title=titleTagPrefix+" - "+thisMapData[currentMap].zoneName,cartographicTitle.innerHTML=thisMapData[currentMap].zoneName)}function loadNewVisibleMapAssets(e){e<0&&(e="dungeon/"+randomDungeonName);var t,a=new Image;a.onload=function(){backgroundImgs[e]=a},a.onerror=function(){},a.src="/images/game-world/backgrounds/"+e+".png";for(var i,n=[],o=0;o<thisMapData[e].items.length;o++)t=getItemPathAndIdentifier(thisMapData[e].items[o]),void 0===itemImages[t[1]]&&(n[t[1]]=new Image,n[t[1]].identifier=t[1],n[t[1]].onload=function(){itemImages[this.identifier]=n[this.identifier]},n[t[1]].onerror=function(){},n[t[1]].src=t[0]);var r,s=[];for(o=0;o<thisMapData[e].graphics.length;o++)i=thisMapData[e].graphics[o].src,void 0===tileImages[i]&&(s[i]=new Image,s[i].identifier=i,s[i].onload=function(){tileImages[this.identifier]=s[this.identifier]},s[i].onerror=function(){},s[i].src="/images/game-world/terrain/"+thisMapData[e].graphics[o].src);var c=[];for(o=0;o<thisMapData[e].npcs.length;o++)r="npc"+thisMapData[e].npcs[o].src,void 0===npcImages[r]&&(c[r]=new Image,c[r].identifier=r,c[r].onload=function(){npcImages[this.identifier]=c[this.identifier]},c[r].onerror=function(){},c[r].src="/images/game-world/npcs/"+thisMapData[e].npcs[o].src);for(o=0;o<thisMapData[e].items.length;o++)if("nest"==currentActiveInventoryItems[thisMapData[e].items[o].type].action)for(var l=0;l<thisMapData[e].items[o].contains.length;l++)r="npc"+thisMapData[e].items[o].contains[l].src,void 0===npcImages[r]&&(c[r]=new Image,c[r].identifier=r,c[r].onload=function(){npcImages[this.identifier]=c[this.identifier]},c[r].onerror=function(){},c[r].src="/images/game-world/npcs/"+thisMapData[e].npcs[o].src)}function processNewVisibleMapData(e){visibleMaps.push(e),removeElementFromArray(visibleMapsLoading,e);for(var t=0;t<thisMapData[e].items.length;t++)initialiseItem(thisMapData[e].items[t]);for(t=0;t<thisMapData[e].npcs.length;t++)initialiseNPC(thisMapData[e].npcs[t]);updatePossibleWeather(),loadNewVisibleMapAssets(e)}function loadNewVisibleInventoryItemData(e,t){e.length>0?getJSON("/game-world/getInventoryItems.php?isAnUpdate=true&whichIds="+e,function(e){for(var a in e)currentActiveInventoryItems[a]=e[a];processNewVisibleMapData(t)},function(a){loadNewVisibleInventoryItemData(e,t)}):processNewVisibleMapData(t)}function loadNewVisibleJSON(e,t){getJSON(e,function(e){thisMapData[t]=e.mapData.map,UI.buildShop(e.shops.markup),e.workshops&&(UI.buildWorkshop(e.workshops.markup),UI.initWorkshops(e.workshops.allWorkshopIds),appendRecipeData(e.workshops.recipeData));for(var a=uniqueValues(getItemIdsForMap(t)),i=e.shops.allItemIds,n=0;n<a.length;n++)a[n]in currentActiveInventoryItems||i.push(a[n]);loadNewVisibleInventoryItemData(i.join("|"),t)},function(a){loadNewVisibleJSON(e,t)})}function loadNewVisibleMap(e){-1===visibleMapsLoading.indexOf(e)&&(visibleMapsLoading.push(e),loadNewVisibleJSON("/game-world/getMap.php?chr="+characterId+"&map="+e,e))}function loadMapJSON(e){getJSON(e,function(e){thisMapData[e.mapData.map.mapId]=e.mapData.map;var t=currentMap=e.mapData.map.mapId;-1===t.indexOf("housing")&&(t=parseInt(currentMap)),visibleMaps.push(t),thisMapShopItemIds=e.shops.allItemIds,UI.buildShop(e.shops.markup),e.workshops&&(UI.buildWorkshop(e.workshops.markup),UI.initWorkshops(e.workshops.allWorkshopIds),appendRecipeData(e.workshops.recipeData)),processInitialMap(),(isOverWorldMap=!e.mapData.map.isInside)&&updateVisibleMaps()},function(t){console.log("retrying..."+e),loadMapJSON(e)})}function loadMap(){var e="";newMap<0&&currentMap>0&&(randomDungeonName=randomDungeons[Math.abs(newMap)],newMap=-1),""!=randomDungeonName&&(e="&dungeonName="+randomDungeonName),loadMapJSON("/game-world/getMap.php?chr="+characterId+"&map="+newMap+e)}function getItemPathAndIdentifier(e){var t,a,i="";if(e.colour){var n=getColourName(e.colour,e.type);""!=n&&(i="-"+n.toLowerCase())}return t="item"+e.type+i,a="/images/game-world/items/"+currentActiveInventoryItems[e.type].worldSrc+i+".png",void 0!==e.contains&&void 0!==e.contains["ugc-id"]&&(t="item"+e.type+"_"+e.contains["ugc-id"],a="/images/user-generated/"+e.contains["ugc-id"]+"-world.png"),[a,t]}function loadMapAssets(){var e,t;imagesToLoad=[];var a,i,n=currentMap;npcGraphicsToLoad=[],itemGraphicsToLoad=[];var o,r="";tileGraphicsToLoad=[];for(var s=0;s<visibleMaps.length;s++){n=visibleMaps[s],visibleMaps[s]<0&&(n=randomDungeonName),-1!==newMap.toString().indexOf("housing")?imagesToLoad.push({name:"backgroundImg"+currentMap,src:"/images/game-world/backgrounds/housing/bg-"+mapTilesX+"x"+mapTilesY+".png"}):imagesToLoad.push({name:"backgroundImg"+visibleMaps[s],src:"/images/game-world/backgrounds/"+n+".png"});for(var c=0;c<thisMapData[visibleMaps[s]].graphics.length;c++)i=thisMapData[visibleMaps[s]].graphics[c].src,-1==tileGraphicsToLoad.indexOf(i)&&(imagesToLoad.push({name:i,src:"/images/game-world/terrain/"+thisMapData[visibleMaps[s]].graphics[c].src}),tileGraphicsToLoad.push(i));for(c=0;c<thisMapData[visibleMaps[s]].npcs.length;c++)a="npc"+thisMapData[visibleMaps[s]].npcs[c].src,-1==npcGraphicsToLoad.indexOf(a)&&(imagesToLoad.push({name:a,src:"/images/game-world/npcs/"+thisMapData[visibleMaps[s]].npcs[c].src}),npcGraphicsToLoad.push(a));for(c=0;c<thisMapData[visibleMaps[s]].items.length;c++)if("nest"==currentActiveInventoryItems[thisMapData[visibleMaps[s]].items[c].type].action)for(var l=0;l<thisMapData[visibleMaps[s]].items[c].contains.length;l++)a="npc"+thisMapData[visibleMaps[s]].items[c].contains[l].src,-1==npcGraphicsToLoad.indexOf(a)&&(imagesToLoad.push({name:a,src:"/images/game-world/npcs/"+thisMapData[visibleMaps[s]].items[c].contains[l].src}),npcGraphicsToLoad.push(a));var h;for(c=0;c<thisMapData[visibleMaps[s]].items.length;c++)h=getItemPathAndIdentifier(thisMapData[visibleMaps[s]].items[c]),-1==itemGraphicsToLoad.indexOf(h[1])&&(imagesToLoad.push({name:h[1],src:h[0]}),itemGraphicsToLoad.push(h[1]));for(var c in thisMapData[visibleMaps[s]].hiddenResources)for(var l in thisMapData[visibleMaps[s]].hiddenResources[c])r="item"+thisMapData[visibleMaps[s]].hiddenResources[c][l].type,-1==itemGraphicsToLoad.indexOf(r)&&(imagesToLoad.push({name:r,src:"/images/game-world/items/"+currentActiveInventoryItems[thisMapData[visibleMaps[s]].hiddenResources[c][l].type].worldSrc+".png"}),itemGraphicsToLoad.push(r));for(var d in hero.inventory)"seed"==currentActiveInventoryItems[hero.inventory[d].type].action&&(o=currentActiveInventoryItems[hero.inventory[d].type].actionValue.type,e="",""!=(t=getColourName(hero.inventory[d].colour,o))&&(e="-"+t.toLowerCase()),r="item"+o+e,-1==itemGraphicsToLoad.indexOf(r)&&(imagesToLoad.push({name:r,src:"/images/game-world/items/"+currentActiveInventoryItems[o].worldSrc+e+".png"}),itemGraphicsToLoad.push(r)))}Loader.preload(imagesToLoad,prepareGame,loadingProgress)}function getItemIdsForMap(e){for(var t,a,i=[],n=0;n<thisMapData[e].items.length;n++)if(i.push(thisMapData[e].items[n].type),void 0!==thisMapData[e].items[n].contains)if(Array.isArray(thisMapData[e].items[n].contains)){for(var o=0;o<thisMapData[e].items[n].contains.length;o++)if(void 0!==thisMapData[e].items[n].contains[o].type){t=thisMapData[e].items[n].contains[o].type.toString().split("/");for(var r=0;r<t.length;r++)"$"!=t[r]&&i.push(parseInt(t[r]))}}else if(void 0===thisMapData[e].items[n].contains["ugc-id"])for(var o in thisMapData[e].items[n].contains)i.push(thisMapData[e].items[n].contains[o].type);for(var n in thisMapData[e].hiddenResources)for(var o in thisMapData[e].hiddenResources[n])if(i.push(thisMapData[e].hiddenResources[n][o].type),thisMapData[e].hiddenResources[n][o].contains)for(var r in thisMapData[e].hiddenResources[n][o].contains){a=thisMapData[e].hiddenResources[n][o].contains[r].type.split("/");for(var s=0;s<a.length;s++)i.push(parseInt(a[s]))}return i}function findInventoryItemData(){var e=[];for(var t in hero.inventory)if(e.push(hero.inventory[t].type),void 0!==hero.inventory[t].contains)for(var a=0;a<hero.inventory[t].contains.length;a++)e.push(hero.inventory[t].contains[a].type);for(a=0;a<hero.bags.length;a++)e.push(hero.bags[a].type);for(var i=0;i<visibleMaps.length;i++)e=e.concat(getItemIdsForMap(visibleMaps[i]));for(var a in hero.crafting)for(var n in hero.crafting[a].filters.All)for(var o in e.push(hero.crafting[a].recipes[hero.crafting[a].filters.All[n]].creates),hero.crafting[a].recipes[hero.crafting[a].filters.All[n]].components)isNaN(hero.crafting[a].recipes[hero.crafting[a].filters.All[n]].components[o].type)||e.push(hero.crafting[a].recipes[hero.crafting[a].filters.All[n]].components[o].type);""!=thisMapShopItemIds&&e.push(thisMapShopItemIds),loadInventoryItemData((e=uniqueValues(e)).join("|"))}function loadInventoryItemData(e){getJSON("/game-world/getInventoryItems.php?whichIds="+e,function(e){currentActiveInventoryItems=e,inventoryInterfaceIsBuilt||UI.buildInventoryInterface(),loadMapAssets()},function(t){loadInventoryItemData(e)})}function initialiseNPC(e){e.x=getTileCentreCoordX(e.tileX),e.y=getTileCentreCoordY(e.tileY),e.z=getElevation(e.tileX,e.tileY),e.drawnFacing=e.facing,e.dx=0,e.dy=0,void 0===e.speechIndex&&(e.speechIndex=0),e.currentAnimation="walk",e.movementIndex=-1,e.forceNewMovementCheck=!0,e.lastTargetDestination="",e.uniqueIndex=generateHash("npc"+e.x+"*"+e.y),void 0===e.reactionRange&&(e.reactionRange=1)}function initialiseItem(e){e.x=getTileCentreCoordX(e.tileX),e.y=getTileCentreCoordY(e.tileY),void 0===e.tileZ?e.z=getElevation(e.tileX,e.tileY):e.z=e.tileZ*tileW,e.width=currentActiveInventoryItems[e.type].width,e.length=currentActiveInventoryItems[e.type].length,e.centreX=currentActiveInventoryItems[e.type].centreX,e.centreY=currentActiveInventoryItems[e.type].centreY,e.spriteWidth=currentActiveInventoryItems[e.type].spriteWidth,e.spriteHeight=currentActiveInventoryItems[e.type].spriteHeight,e.canBeRotated=currentActiveInventoryItems[e.type].canBeRotated,e.isCollidable=!0,"gate"==currentActiveInventoryItems[e.type].action&&"open"==e.state&&(e.isCollidable=!1),"node"==currentActiveInventoryItems[e.type].action&&(e.timeLastHarvested||(e.timeLastHarvested=hero.totalGameTimePlayed-currentActiveInventoryItems[e.type].respawnRate),void 0===e.stability&&(e.stability=e.maxStability),void 0===e.quantity&&(e.quantity=e.maxQuantity)),"nest"==currentActiveInventoryItems[e.type].action&&(e.timeLastSpawned=hero.totalGameTimePlayed,e.spawnsRemaining=e.additional)}function prepareGame(){for(var e=0;e<tileGraphicsToLoad.length;e++)tileImages[tileGraphicsToLoad[e]]=Loader.getImage(tileGraphicsToLoad[e]);for(e=0;e<npcGraphicsToLoad.length;e++)npcImages[npcGraphicsToLoad[e]]=Loader.getImage(npcGraphicsToLoad[e]);for(e=0;e<itemGraphicsToLoad.length;e++)itemImages[itemGraphicsToLoad[e]]=Loader.getImage(itemGraphicsToLoad[e]);backgroundImgs[currentMap]=Loader.getImage("backgroundImg"+currentMap);for(e=0;e<visibleMaps.length;e++)backgroundImgs[visibleMaps[e]]=Loader.getImage("backgroundImg"+visibleMaps[e]);for(var t=0;t<visibleMaps.length;t++)for(e=0;e<thisMapData[visibleMaps[t]].npcs.length;e++)initialiseNPC(thisMapData[visibleMaps[t]].npcs[e]);hero.z;if(hasActivePet)for(e=0;e<hero.activePets.length;e++)initialisePetObject(e);if(thisMapData[currentMap].movingPlatforms){var a,i;for(e=0;e<thisMapData[currentMap].movingPlatforms.length;e++)(a=thisMapData[currentMap].movingPlatforms[e]).x=getTileCentreCoordX(a.startTileX),a.y=getTileCentreCoordY(a.startTileY),a.z=a.startZ,a.movementIndex=0,a.waitingTimer=0,a.canMove=!0,i=determinePlatformIncrements(a),a.dx=i[0],a.dy=i[1],a.dz=i[2]}for(e=0;e<breadCrumbLength;e++)hero.breadcrumb[e]=[hero.tileX,hero.tileY];for(t=0;t<visibleMaps.length;t++)for(e=0;e<thisMapData[visibleMaps[t]].items.length;e++)initialiseItem(thisMapData[visibleMaps[t]].items[e]);activeObjectForDialogue="",hero.x=getTileCentreCoordX(hero.tileX),hero.y=getTileCentreCoordY(hero.tileY),hero.z=getElevation(hero.tileX,hero.tileY),fae.x=hero.x+2*tileW,fae.y=hero.y+2*tileH,fae.currentState="hero",fae.z=hero.z,fae.dz=1,setupWeather(),timeSinceLastFrameSwap=0,currentAnimationFrame=0,mapTransition="in",mapTransitionCurrentFrames=1,gameMode="play",""!=thisMapData[currentMap].musicOnEnter?audio.playMusic(thisMapData[currentMap].musicOnEnter):void 0!==audio.activeTrack&&audio.fadeOutMusic(audio.activeTrack,6),checkForHotspots()}function removeMapAssets(){for(var e in tileGraphicsToLoad)tileImages[tileGraphicsToLoad[e]].onerror="",tileImages[tileGraphicsToLoad[e]].src="",delete tileImages[tileGraphicsToLoad[e]];for(var e in npcGraphicsToLoad)npcImages[npcGraphicsToLoad[e]].onerror="",npcImages[npcGraphicsToLoad[e]].src="",delete npcImages[npcGraphicsToLoad[e]];for(var e in itemGraphicsToLoad)itemImages[itemGraphicsToLoad[e]].onerror="",itemImages[itemGraphicsToLoad[e]].src="",delete itemImages[itemGraphicsToLoad[e]];for(var e in backgroundImgs)void 0!==backgroundImgs[e]&&(backgroundImgs[e].onerror="",backgroundImgs[e].src="",delete backgroundImgs[e])}function loadingProgress(){}function changeMaps(e,t){if(previousZoneName=thisMapData[currentMap].zoneName,gameMode="mapLoading",removeMapAssets(),null==jumpMapId){var a=thisMapData[currentMap].doors,i=e+","+t;hero.tileX=a[i].startX,hero.tileY=a[i].startY,newMap=a[i].map}else newMap=jumpMapId,jumpMapId=null,hero.tileX=e,hero.tileY=t;"?"!=hero.tileX&&(hero.tileX=parseInt(hero.tileX)),"?"!=hero.tileY&&(hero.tileY=parseInt(hero.tileY)),visibleMaps=[],loadMap()}function tileIsClear(e,t){var a=getLocalCoordinatesX(e),i=getLocalCoordinatesY(t);if(isOverWorldMap){if(e<0||t<0||e>=worldMapTileLength*worldMap[0].length||t>=worldMapTileLength*worldMap.length)return!1}else if(a<0||i<0||a>=mapTilesX||i>=mapTilesY)return!1;var n=findMapNumberFromGlobalCoordinates(e,t);switch(thisMapData[n].collisions[i][a]){case 1:return!1;case"<":case">":case"^":case"v":case"d":return!1}if(e==hero.tileX&&t==hero.tileY)return!1;for(var o=0;o<thisMapData[n].items.length;o++)if(e==thisMapData[n].items[o].tileX&&t==thisMapData[n].items[o].tileY&&thisMapData[n].items[o].isCollidable)return!1;for(o=0;o<thisMapData[n].npcs.length;o++)if(thisMapData[n].npcs[o].isCollidable&&e==thisMapData[n].npcs[o].tileX&&t==thisMapData[n].npcs[o].tileY)return!1;if(hasActivePet)for(o=0;o<hero.activePets.length;o++)if(e==hero.allPets[hero.activePets[o]].tileX&&t==hero.allPets[hero.activePets[o]].tileY)return!1;return!0}function startDoorTransition(){""==mapTransition&&(mapTransitionCurrentFrames=1,mapTransition="out",""!=activeObjectForDialogue&&(dialogue.classList.remove("active"),UI.removeActiveDialogue()),-1!=chestIdOpen&&UI.closeChest()),cartography.saveCartographyMask(),shopPanel.innerHTML=""}function getHeroAsCloseAsPossibleToObject(e,t,a,i){switch(hero.facing){case"n":hero.y=t+i/2+hero.length/2+1;break;case"s":hero.y=t-i/2-hero.length/2-1;break;case"w":hero.x=e+a/2+hero.width/2+1;break;case"e":hero.x=e-a/2-hero.width/2-1}}function isOnAPlatform(e,t){var a,i=-1;if(thisMapData[currentMap].movingPlatforms)for(var n=0;n<thisMapData[currentMap].movingPlatforms.length;n++)if(t>=(a=thisMapData[currentMap].movingPlatforms[n]).y-tileW/2&&t<=a.y+tileW/2+(a.length-1)*tileW&&e>=a.x-tileW/2&&e<=a.x+tileW/2+(a.width-1)*tileW){i=n;break}return i}function checkHeroCollisions(){var e,t,a,i,n,o,r,s,c,l;if(key[2])if(o=isOnAPlatform(hero.x-hero.width/2,hero.y-hero.length/2),r=isOnAPlatform(hero.x+hero.width/2,hero.y-hero.length/2),(o>-1||!isATerrainCollision(hero.x-hero.width/2,hero.y-hero.length/2))&&(r>-1||!isATerrainCollision(hero.x+hero.width/2,hero.y-hero.length/2)));else if(isOnAPlatform(hero.x-hero.width/2,hero.y+hero.length/2)>-1&&isOnAPlatform(hero.x+hero.width/2,hero.y+hero.length/2)>-1)-1==o&&-1==r&&(hero.y=thisMapData[currentMap].movingPlatforms[isOnAPlatform(hero.x-hero.width/2,hero.y+hero.length/2)].y-tileW/2+hero.length/2+1);else{var h=(getTileY(hero.y-hero.length/2)+1)*tileW;hero.y=h+hero.length/2+1}if(key[3])if(o=isOnAPlatform(hero.x-hero.width/2,hero.y+hero.length/2),r=isOnAPlatform(hero.x+hero.width/2,hero.y+hero.length/2),(o>-1||!isATerrainCollision(hero.x-hero.width/2,hero.y+hero.length/2))&&(r>-1||!isATerrainCollision(hero.x+hero.width/2,hero.y+hero.length/2)));else if(isOnAPlatform(hero.x-hero.width/2,hero.y-hero.length/2)>-1&&isOnAPlatform(hero.x+hero.width/2,hero.y-hero.length/2)>-1)-1==o&&-1==r&&(hero.y=thisMapData[currentMap].movingPlatforms[isOnAPlatform(hero.x-hero.width/2,hero.y-hero.length/2)].y+tileW/2+(thisMapData[currentMap].movingPlatforms[isOnAPlatform(hero.x-hero.width/2,hero.y-hero.length/2)].length-1)*tileW-hero.length/2-1);else{var d=getTileY(hero.y+hero.length/2)*tileW;hero.y=d-hero.length/2-1}if(key[0])if(o=isOnAPlatform(hero.x-hero.width/2,hero.y+hero.length/2),r=isOnAPlatform(hero.x-hero.width/2,hero.y-hero.length/2),(o>-1||!isATerrainCollision(hero.x-hero.width/2,hero.y+hero.length/2))&&(r>-1||!isATerrainCollision(hero.x-hero.width/2,hero.y-hero.length/2)));else if(isOnAPlatform(hero.x+hero.width/2,hero.y-hero.length/2)>-1&&isOnAPlatform(hero.x+hero.width/2,hero.y+hero.length/2)>-1)-1==o&&-1==r&&(hero.x=thisMapData[currentMap].movingPlatforms[isOnAPlatform(hero.x+hero.width/2,hero.y-hero.length/2)].x-tileW/2+hero.length/2+1);else{var u=(getTileX(hero.x-hero.width/2)+1)*tileW;hero.x=u+hero.width/2+1}if(key[1])if(o=isOnAPlatform(hero.x+hero.width/2,hero.y+hero.length/2),r=isOnAPlatform(hero.x+hero.width/2,hero.y-hero.length/2),(o>-1||!isATerrainCollision(hero.x+hero.width/2,hero.y+hero.length/2))&&(r>-1||!isATerrainCollision(hero.x+hero.width/2,hero.y-hero.length/2)));else if(isOnAPlatform(hero.x-hero.width/2,hero.y-hero.length/2)>-1&&isOnAPlatform(hero.x-hero.width/2,hero.y+hero.length/2)>-1)-1==o&&-1==r&&(hero.x=thisMapData[currentMap].movingPlatforms[isOnAPlatform(hero.x-hero.width/2,hero.y-hero.length/2)].x+tileW/2+(thisMapData[currentMap].movingPlatforms[isOnAPlatform(hero.x-hero.width/2,hero.y-hero.length/2)].width-1)*tileW-hero.length/2-1);else{var p=getTileX(hero.x+hero.width/2)*tileW;hero.x=p-hero.width/2-1}if(thisMapData[currentMap].movingPlatforms)for(var g=0;g<thisMapData[currentMap].movingPlatforms.length;g++)thisMapData[currentMap].movingPlatforms[g].canMove=!0;e=isOnAPlatform(hero.x-hero.width/2,hero.y-hero.length/2),t=isOnAPlatform(hero.x+hero.width/2,hero.y-hero.length/2),a=isOnAPlatform(hero.x-hero.width/2,hero.y+hero.length/2),i=isOnAPlatform(hero.x+hero.width/2,hero.y+hero.length/2),e>=0&&(n=e==a&&a==t&&t==i),n?e>=0&&(hero.x+=thisMapData[currentMap].movingPlatforms[e].dx,hero.y+=thisMapData[currentMap].movingPlatforms[e].dy,hero.z+=thisMapData[currentMap].movingPlatforms[e].dz):(e>=0&&(thisMapData[currentMap].movingPlatforms[e].canMove=!1),t>=0&&(thisMapData[currentMap].movingPlatforms[t].canMove=!1),a>=0&&(thisMapData[currentMap].movingPlatforms[a].canMove=!1),i>=0&&(thisMapData[currentMap].movingPlatforms[i].canMove=!1));for(var m=0;m<visibleMaps.length;m++){whichVisibleMap=visibleMaps[m];for(g=0;g<thisMapData[whichVisibleMap].npcs.length;g++)(s=thisMapData[whichVisibleMap].npcs[g]).isCollidable&&isAnObjectCollision(s.x,s.y,s.width,s.length,hero.x,hero.y,hero.width,hero.length)&&getHeroAsCloseAsPossibleToObject(s.x,s.y,s.width,s.length);for(g=0;g<thisMapData[whichVisibleMap].items.length;g++)(c=thisMapData[whichVisibleMap].items[g]).isCollidable&&isAnObjectCollision(c.x,c.y,c.width,c.length,hero.x,hero.y,hero.width,hero.length)&&getHeroAsCloseAsPossibleToObject(c.x,c.y,c.width,c.length)}if(hasActivePet)for(g=0;g<hero.activePets.length;g++)isAnObjectCollision(hero.allPets[hero.activePets[g]].x,hero.allPets[hero.activePets[g]].y,hero.allPets[hero.activePets[g]].width,hero.allPets[hero.activePets[g]].length,hero.x,hero.y,hero.width,hero.length)&&(getHeroAsCloseAsPossibleToObject(hero.allPets[hero.activePets[g]].x,hero.allPets[hero.activePets[g]].y,hero.allPets[hero.activePets[g]].width,hero.allPets[hero.activePets[g]].length),pushPetAway(g));if(void 0!==thisMapData[currentMap].innerDoors)for(var g in thisMapData[currentMap].innerDoors)if(!(l=thisMapData[currentMap].innerDoors[g]).isOpen&&isAnObjectCollision(getTileCentreCoordX(l.tileX),getTileCentreCoordY(l.tileY),tileW,tileW,hero.x,hero.y,hero.width,hero.length)){if(l.isLocked){var v=hero.currency.keys.indexOf(g);-1!=v&&(unlockInnerDoor(g),openInnerDoor(g),hero.currency.keys.splice(v,1),UI.updateCurrencies())}else openInnerDoor(g);getHeroAsCloseAsPossibleToObject(getTileCentreCoordX(l.tileX),getTileCentreCoordY(l.tileY),tileW,tileW)}}function updateSurroundingGameWorld(){var e=window.performance.now();hero.totalGameTimePlayed++;var t=e-lastTime;lastTime=e,(timeSinceLastFrameSwap+=t)>animationUpdateTime&&(currentAnimationFrame++,timeSinceLastFrameSwap=0,animateFae()),moveFae(),moveNPCs(),movePet(),movePlatforms(),updateItems(),audio.checkForAmbientSounds(),checkForRespawns(),UI.updateCooldowns(),draw()}function gameLoop(){switch(gameMode){case"mapLoading":break;case"cardGame":cardGameNameSpace.update(),cardGameNameSpace.draw(),updateSurroundingGameWorld();break;case"hnefataflGame":hnefataflNameSpace.update(),hnefataflNameSpace.draw(),updateSurroundingGameWorld();break;case"housing":housingNameSpace.update(),updateSurroundingGameWorld();break;case"play":update(),draw()}window.requestAnimationFrame(gameLoop)}function moveHeroTowards(e,t){var a=e-availableScreenWidth/2,i=t-availableScreenHeight/2;key[5]=!1,(Math.abs(a)>availableScreenWidth/4||Math.abs(i)>availableScreenHeight/4)&&(key[5]=!0),key[0]=!1,key[1]=!1,key[2]=!1,key[3]=!1,a<0?i<0?key[0]=1:key[3]=1:i<0?key[2]=1:key[1]=1}function update(){checkForGamePadInput();var e=window.performance.now();hero.totalGameTimePlayed++;var t=e-lastTime;lastTime=e,hero.isMoving=!1;var a=hero.speed;if(key[5]&&(a*=2),"out"!=mapTransition){if(key[2]?(hero.isMoving=!0,hero.facing="n",hero.y-=a):key[3]?(hero.isMoving=!0,hero.facing="s",hero.y+=a):key[1]?(hero.isMoving=!0,hero.facing="e",hero.x+=a):key[0]&&(hero.isMoving=!0,hero.facing="w",hero.x-=a),key[4]&&checkForActions(),key[6]&&checkForChallenges(),key[7]&&(UI.toggleUI(),key[7]=!1),key[8]&&(UI.toggleJournal(),key[8]=!1),key[9]&&(UI.moveQuickHold(-1),key[9]=!1),key[10]&&(UI.moveQuickHold(1),key[10]=!1),key[11]&&(printScreen(),key[11]=!1),key[12]){switch(activeAction){case"plotPlacement":document.removeEventListener("mousemove",UI.movePlotPlacementOverlay,!1),document.removeEventListener("click",placePlotPlacement,!1);break;case"survey":surveyingStopped();break;case"gather":gatheringPanel.classList.remove("active"),gatheringStopped()}activeAction="",key[12]=!1}""!=music.currentInstrument&&music.checkKeyPresses(),music.isPlayingBackTranscription&&music.playBackTranscription(),checkHeroCollisions();var i,n=hero.tileX,o=hero.tileY;hero.tileX=getTileX(hero.x),hero.tileY=getTileY(hero.y),checkForSlopes(hero),hero.tileX==n&&hero.tileY==o||heroIsInNewTile(),""!=activeObjectForDialogue&&null!=activeObjectForDialogue&&(isInRange(hero.x,hero.y,activeObjectForDialogue.x,activeObjectForDialogue.y,closeDialogueDistance)||(dialogue.classList.add("slowerFade"),dialogue.classList.remove("active"),-1!=shopCurrentlyOpen&&(activeObjectForDialogue.speechIndex=0,UI.closeShop()),-1!=workshopCurrentlyOpen&&(activeObjectForDialogue.speechIndex=0,UI.closeWorkshop()),acceptQuestChoice.classList.remove("active"),dialogue.addEventListener(whichTransitionEvent,UI.removeActiveDialogue,!1))),-1!=chestIdOpen&&(i=chestIdOpen.split("-"),isInRange(hero.x,hero.y,thisMapData[i[1]].items[i[0]].x,thisMapData[i[1]].items[i[0]].y,closeDialogueDistance/2)||UI.closeChest()),"gather"==activeAction&&(isInRange(hero.x,hero.y,gathering.itemObject.x,gathering.itemObject.y,closeDialogueDistance/2)||(gatheringPanel.classList.remove("active"),gatheringStopped())),postObject.active&&(isInRange(hero.x,hero.y,postObject.x,postObject.y,closeDialogueDistance/2)||UI.closePost()),bankObject.active&&(isInRange(hero.x,hero.y,bankObject.x,bankObject.y,closeDialogueDistance/2)||UI.closeBank()),retinueObject.active&&(isInRange(hero.x,hero.y,retinueObject.x,retinueObject.y,closeDialogueDistance/2)||UI.closeRetinuePanel())}else{if(null==jumpMapId)switch(hero.isMoving=!0,hero.facing){case"n":hero.y-=a;break;case"s":hero.y+=a;break;case"e":hero.x+=a;break;case"w":hero.x-=a}(mapTransitionCurrentFrames+=2)>=mapTransitionMaxFrames&&changeMaps(activeDoorX,activeDoorY)}"in"==mapTransition&&(mapTransitionCurrentFrames+=2)>=mapTransitionMaxFrames&&(mapTransition="",activeDoorX=-1,activeDoorY=-1),(timeSinceLastFrameSwap+=t)>animationUpdateTime&&(currentAnimationFrame++,timeSinceLastFrameSwap=0,animateFae()),hero.isMoving?(key[5]?hero.currentAnimation="run":hero.currentAnimation="walk",""!=music.currentInstrument&&music.exitMusicMode()):""!=music.currentInstrument?hero.currentAnimation="music":hero.currentAnimation="idle",moveFae(),moveNPCs(),movePet(),movePlatforms(),updateItems(),checkForWeatherChange(),audio.checkForAmbientSounds(),checkForRespawns(),UI.updateCooldowns(),"gather"==activeAction&&processGathering(),"dowse"==activeAction&&processDowsing(),"survey"==activeAction&&processSurveying(),retinueObject.active&&UI.updateRetinueTimers(),-1!=workshopObject.workshopCurrentlyOpen&&UI.updateWorkshopTimer(),craftingObject.isCreating&&processCrafting()}function updateVisibleMaps(){for(var e,t=hero.isox-canvasWidth,a=hero.isoy-canvasHeight,i=hero.isox+canvasWidth,n=hero.isoy+canvasHeight,o=find2DCoordsX(t,hero.isoy),r=find2DCoordsY(hero.isox,a),s=find2DCoordsX(i,hero.isoy),c=find2DCoordsY(hero.isox,n),l=worldMapTileLength*tileW,h=Math.floor(o/l),d=Math.floor(r/l),u=Math.floor(s/l),p=Math.floor(c/l),g=[],m=h;m<=u;m++)for(var v=d;v<=p;v++)e=!1,void 0!==worldMap[v]&&void 0!==worldMap[v][m]&&(e=!0),e&&g.push(worldMap[v][m]);var f=g.filter(function(e){return visibleMaps.indexOf(e)<0});for(m=0;m<f.length;m++)loadNewVisibleMap(f[m])}function checkForHotspots(){for(var e,t,a,i=0;i<thisMapData[currentMap].hotspots.length;i++)t=getTileCentreCoordX((e=thisMapData[currentMap].hotspots[i]).centreX),a=getTileCentreCoordY(e.centreY),isInRange(hero.x,hero.y,t,a,e.radius*tileW)&&(void 0!==e.quest&&(questData[e.quest].hasBeenActivated<1&&UI.showNotification("<p>"+e.message+"</p>"),questData[e.quest].hasBeenActivated=1),void 0!==e.music&&audio.playMusic(e.music),void 0!==e.weather&&changeWeather(e.weather),void 0!==e.openInnerDoor&&(unlockInnerDoor(e.openInnerDoor),openInnerDoor(e.openInnerDoor)),void 0!==e.closeInnerDoor&&closeInnerDoor(e.closeInnerDoor),void 0!==e.toggleInnerDoor&&toggleInnerDoor(e.toggleInnerDoor),void 0!==e.remove&&(thisMapData[currentMap].hotspots.splice(i,1),i--)),"hero"==fae.currentState&&void 0===e.faeIgnore&&-1===fae.recentHotspots.indexOf(i)&&isInRange(fae.x,fae.y,t,a,fae.range)&&hasLineOfSight(getTileX(fae.x),getTileX(fae.y),e.centreX,e.centreY)&&(fae.targetX=t,fae.targetY=a,fae.recentHotspots.push(i),fae.currentState="away")}function changeCurrentMap(e){cartography.saveCartographyMask(),currentMap=e,cartography.newCartographicMap(),updateZoneName()}function heroIsInNewTile(){if(cartography.updateCartographicMiniMap(),isOverWorldMap){cartography.updateCoordinates();var e=findMapNumberFromGlobalCoordinates(hero.tileX,hero.tileY);e!=currentMap&&changeCurrentMap(e),updateVisibleMaps()}checkForHotspots(),"wait"==fae.currentState&&(isInRange(fae.x,fae.y,hero.x,hero.y,fae.abandonRadius)||hasLineOfSight(getTileX(fae.x),getTileX(fae.y),hero.tileX,hero.tileY)&&(fae.currentState="hero")),hero.breadcrumb.pop(),hero.breadcrumb.unshift([hero.tileX,hero.tileY]),thisMapData[currentMap].showOnlyLineOfSight&&updateLightMap(),"d"==thisMapData[currentMap].collisions[getLocalCoordinatesY(hero.tileY)][getLocalCoordinatesX(hero.tileX)]&&(activeDoorX=hero.tileX,activeDoorY=hero.tileY,startDoorTransition()),"survey"==activeAction&&surveyingStopped()}function openInnerDoor(e){thisMapData[currentMap].innerDoors[e].isOpen=!0,thisMapData[currentMap].showOnlyLineOfSight&&updateLightMap()}function closeInnerDoor(e){tileIsClear(thisMapData[currentMap].innerDoors[e].tileX,thisMapData[currentMap].innerDoors[e].tileY)&&(thisMapData[currentMap].innerDoors[e].isOpen=!1,thisMapData[currentMap].showOnlyLineOfSight&&updateLightMap())}function toggleInnerDoor(e){tileIsClear(thisMapData[currentMap].innerDoors[e].tileX,thisMapData[currentMap].innerDoors[e].tileY)&&(thisMapData[currentMap].innerDoors[e].isOpen=!thisMapData[currentMap].innerDoors[e].isOpen,thisMapData[currentMap].showOnlyLineOfSight&&updateLightMap())}function unlockInnerDoor(e){audio.playSound(soundEffects.unlock,0),thisMapData[currentMap].innerDoors[e].isLocked=!1,thisMapData[currentMap].showOnlyLineOfSight&&updateLightMap()}function getCatalogueMarkup(e,t){getJSON("http://develop.ae/game-world/getCatalogueContents.php?itemIds="+e+"&name="+t,function(e){catalogueQuestPanels.insertAdjacentHTML("beforeend",e.markup),audio.playSound(soundEffects.bookOpen,0)},function(a){getCatalogueMarkup(e,t)})}function usedActiveTool(){var e=!1;if(""!=hero.holding.type){var t=hero.tileX+relativeFacing[hero.facing].x,a=hero.tileY+relativeFacing[hero.facing].y;switch(currentActiveInventoryItems[hero.holding.type].action){case"till":for(var i,n,o,r,s,c,l,h=!1,d=0;d<hero.activeTreasureMaps.length;d++)if(i=hero.activeTreasureMaps[d].split("_"),getPythagorasDistance(hero.tileX,hero.tileY,i[0],i[1])<2){switch(c={type:48,contains:[{type:6},{type:2},{type:"$",quantity:5e3}]},n=hero.facing){case"n":o=["e","w","s"];break;case"e":o=["n","s","w"];break;case"s":o=["n","s","e"];break;case"w":o=["e","w","n"]}do{r=hero.tileX+relativeFacing[n].x,s=hero.tileY+relativeFacing[n].y,n=o.shift()}while(!tileIsClear(r,s)&&o.length>0);if(o.length>0){for(var u in c.tileX=r,c.tileY=s,l=findMapNumberFromGlobalCoordinates(r,s),thisMapData[l].items.push(c),initialiseItem(thisMapData[l].items[thisMapData[l].items.length-1]),hero.inventory)console.log(hero.inventory[u].contains+" == "+hero.activeTreasureMaps[d]),hero.inventory[u].contains==hero.activeTreasureMaps[d]&&(delete hero.inventory[u],document.getElementById("slot"+u).innerHTML="");document.getElementById("treasureMap"+hero.activeTreasureMaps[d]).classList.remove("active"),hero.activeTreasureMaps.splice(d,1),audio.playSound(soundEffects.foundChest,0),h=!0,e=!0}else console.log("couldn't place chest")}h||successfullyTilledEarth(t,a)&&(e=!0);break;case"seed":successfullyPlantSeed(t,a)&&(e=!0);break;case"holds-liquid":var p=!1,g=findSlotByHash(hero.holding.hash),m=findItemWithinArmsLength();null!=m&&"source"==currentActiveInventoryItems[m.type].action&&(p=!0,hero.inventory[g].contains[0].type=currentActiveInventoryItems[m.type].actionValue,hero.inventory[g].contains[0].quantity=currentActiveInventoryItems[hero.inventory[g].type].actionValue,audio.playSound(soundEffects.pouring,0),updateGauge(g),UI.updateHeldItemGauge()),p||pourLiquid(t,a),e=!0}}return e}function checkForActions(){if(!usedActiveTool())for(var e,t=[],a=0;a<visibleMaps.length;a++){for(var i=0;i<thisMapData[visibleMaps[a]].items.length;i++)if((!thisMapData[visibleMaps[a]].items[i].activeForQuest||questData[thisMapData[visibleMaps[a]].items[i].activeForQuest].isUnderway)&&isInRange(hero.x,hero.y,thisMapData[visibleMaps[a]].items[i].x,thisMapData[visibleMaps[a]].items[i].y,thisMapData[visibleMaps[a]].items[i].width/2+hero.width/2+6)&&isFacing(hero,thisMapData[visibleMaps[a]].items[i])){var n=currentActiveInventoryItems[thisMapData[visibleMaps[a]].items[i].type].actionValue;switch(currentActiveInventoryItems[thisMapData[visibleMaps[a]].items[i].type].action){case"static":case"nest":break;case"sound":audio.playSound(soundEffects[n],0);break;case"questToggle":questData[n].hasBeenActivated=Math.abs(questData[n].hasBeenActivated-1);break;case"questSet":questData[n].hasBeenActivated=1;break;case"questUnset":questData[n].hasBeenActivated=0;break;case"node":break;case"toggleInnerDoor":toggleInnerDoor(thisMapData[visibleMaps[a]].items[i].additional),audio.playSound(soundEffects.lever,0),thisMapData[visibleMaps[a]].items[i].state="on"==thisMapData[visibleMaps[a]].items[i].state?"off":"on";break;case"openInnerDoor":openInnerDoor(thisMapData[visibleMaps[a]].items[i].additional);break;case"closeInnerDoor":closeInnerDoor(thisMapData[visibleMaps[a]].items[i].additional);break;case"key":hero.currency.keys.push(thisMapData[visibleMaps[a]].items[i].additional),UI.updateCurrencies(),audio.playSound(soundEffects.keys,0),thisMapData[visibleMaps[a]].items.splice(i,1);break;case"gate":thisMapData[visibleMaps[a]].items[i].state="open"==thisMapData[visibleMaps[a]].items[i].state?"closed":"open",thisMapData[visibleMaps[a]].items[i].isCollidable=1!=thisMapData[visibleMaps[a]].items[i].isCollidable;break;case"notice":processSpeech(thisMapData[visibleMaps[a]].items[i],thisMapData[visibleMaps[a]].items[i].contains[0][0],thisMapData[visibleMaps[a]].items[i].contains[0][1],!1,thisMapData[visibleMaps[a]].items[i].contains[0][2]);break;case"sit":hero.facing=thisMapData[visibleMaps[a]].items[i].facing,console.log("switch to sit animation");break;case"signpost":for(var o in thisMapData[visibleMaps[a]].items[i].contains)UI.showNotification("<p>"+o+" to "+thisMapData[visibleMaps[a]].items[i].contains[o]+"</p>");break;case"chest":UI.openChest(visibleMaps[a],i);break;case"post":UI.openPost(thisMapData[visibleMaps[a]].items[i].x,thisMapData[visibleMaps[a]].items[i].y);break;case"bank":UI.openBank(thisMapData[visibleMaps[a]].items[i].x,thisMapData[visibleMaps[a]].items[i].y);break;case"retinue":UI.openRetinuePanel(thisMapData[visibleMaps[a]].items[i]);break;case"source":break;case"crop":checkCrop(thisMapData[visibleMaps[a]].items[i]);break;default:var r=!0;thisMapData[visibleMaps[a]].items[i].lockedToPlayerId&&thisMapData[visibleMaps[a]].items[i].lockedToPlayerId!=characterId&&(r=!1),r?(t=canAddItemToInventory([prepareInventoryObject(thisMapData[visibleMaps[a]].items[i])]))[0]?(thisMapData[visibleMaps[a]].items.splice(i,1),UI.showChangeInInventory(t[1])):UI.showNotification("<p>I don't have room in my bags for that</p>"):UI.showNotification("<p>I can't pick that up</p>")}}for(i=0;i<thisMapData[visibleMaps[a]].npcs.length;i++)if((e=thisMapData[visibleMaps[a]].npcs[i]).speech&&isInRange(hero.x,hero.y,e.x,e.y,e.reactionRange*tileW)&&isFacing(hero,e))if(e.speechIndex>=e.speech.length||canCloseDialogueBalloonNextClick&&activeObjectForDialogue==e)e.speechIndex=0,dialogue.classList.remove("active"),activeObjectForDialogue="",canCloseDialogueBalloonNextClick=!1,-1!=shopCurrentlyOpen&&UI.closeShop();else{var s=e.speech[e.speechIndex][0],c=e.speech[e.speechIndex][1];e.drawnFacing=turntoFace(e,hero),processSpeech(e,s,c,!0),e.speechIndex++}}key[4]=0}function processSpeech(e,t,a,i,n){thisSpeech=t,i=void 0!==i&&i;for(var o=a.split(","),r=0;r<o.length;r++)switch(o[r]){case"once":e.speech.splice(e.speechIndex,1),e.speechIndex--;break;case"move":e.forceNewMovementCheck=!0,e.isMoving=!0;break;case"shop":UI.openedShopSuccessfully(generateHash(e.speech[e.speechIndex][2]))||void 0!==e.shopEmptySpeech&&(thisSpeech=e.shopEmptySpeech);break;case"workshop":UI.openWorkshop(e.speech[e.speechIndex][2]);break;case"post":UI.openPost(e.x,e.y);break;case"bank":UI.openBank(e.x,e.y,e);break;case"retinue":UI.openRetinuePanel(e);break;case"sound":audio.playSound(soundEffects[e.speech[e.speechIndex][2]],0);break;case"profession":var s=e.speech[e.speechIndex][2];-1==hero.professionsKnown.indexOf(s)&&(hero.professionsKnown.push(s),UI.showNewProfession(s));break;case"follower":e.speech[e.speechIndex][2];break;case"hire":UI.openHireFollowerPanel(e),e.speechIndex--;break;case"collection-quest":case"collection-quest-no-open":var c=thisSpeech.split("|"),l=e.speech[e.speechIndex][2];if(hero.collections.hasOwnProperty(l)){var h=!1;for(var d in hero.collections[l].required)if(hero.collections[l].required[d]>0){h=!0;break}if(h)thisSpeech=c[1];else void 0!==(I=e.speech[e.speechIndex])[4]&&awardQuestRewards(e,I[4],!0),thisSpeech=c[2],hero.collections[l].complete=!0,UI.completeCollectionQuestPanel(l),e.speech.splice(e.speechIndex,1)}else"collection-quest-no-open"!=o[r]?(thisSpeech=c[0],hero.collections[l]={},hero.collections[l].required=e.speech[e.speechIndex][3],hero.collections[l].complete=!1,UI.initiateCollectionQuestPanel(l)):thisSpeech=c[1];e.speechIndex--;break;case"give":for(var u=thisSpeech.split("|"),p=e.speech[e.speechIndex][2],g=[],m=0;m<p.length;m++){var v=prepareInventoryObject(p[m]);g.push(v)}(inventoryCheck=canAddItemToInventory(g))[0]?(thisSpeech=u[0],UI.showChangeInInventory(inventoryCheck[1]),e.speech.splice(e.speechIndex,1),e.speechIndex--):(thisSpeech=u[1],e.speechIndex--);break;case"catalogue":var f=thisSpeech.split("|"),y=e.speech[e.speechIndex][2];if(hero.catalogues.hasOwnProperty(y)){h=!1;for(var d in hero.catalogues[y].ids)if(hero.catalogues[y].ids[d]>0){h=!0;break}if(h)thisSpeech=f[1];else{thisSpeech=f[2];var I=e.speech[e.speechIndex];for(var b in void 0!==I[3]&&awardQuestRewards(e,I[3],!1),hero.catalogues[y].complete=!0,e.speech.splice(e.speechIndex,1),hero.inventory)if(84==hero.inventory[b].type&&hero.inventory[b].contains.catalogueName==y){removeFromInventory(b,1);break}}}else thisSpeech=f[0];e.speechIndex--;break;case"quest":case"quest-no-open":case"quest-no-close":case"quest-no-open-no-close":case"quest-optional":var M,w=thisSpeech.split("|");M=void 0!==e.speech?e.speech[e.speechIndex][2]:n;var C,S=!0;if(""!=questData[M].prerequisite){if(-1!==questData[M].prerequisite.indexOf(">"))accessDynamicVariable((C=questData[M].prerequisite.split(">"))[0].trim())<=C[1].trim()&&(S=!1);else if(-1!==questData[M].prerequisite.indexOf("<"))accessDynamicVariable((C=questData[M].prerequisite.split("<"))[0].trim())>=C[1].trim()&&(S=!1);else if(-1!==questData[M].prerequisite.indexOf("="))accessDynamicVariable((C=questData[M].prerequisite.split("="))[0].trim())!=C[1].trim()&&(S=!1);else{var T=questData[M].prerequisite.split(",");for(var d in T)0==questData[T[d]].hasBeenCompleted&&(S=!1)}S||(e.speechIndex++,e.speechIndex>=e.speech.length&&(e.speechIndex=0),processSpeech(e,e.speech[e.speechIndex][0],e.speech[e.speechIndex][1],!0))}if(S)if(questData[M].isUnderway)if("quest"==o[r]||"quest-no-open"==o[r]||"quest-optional"==o[r])switch(questData[M].whatIsRequiredForCompletion){case"possess":case"give":case"":if(hasItemsInInventory(questData[M].itemsNeededForCompletion)){if("give"==questData[M].whatIsRequiredForCompletion)for(r=0;r<questData[M].itemsNeededForCompletion.length;r++)removeItemTypeFromInventory(questData[M].itemsNeededForCompletion[r].type,questData[M].itemsNeededForCompletion[r].quantity);thisSpeech=w[2],closeQuest(e,M)}else thisSpeech=w[1],e.speechIndex--;break;case"craft":var k=[];for(r=0;r<questData[M].itemsNeededForCompletion.length;r++)(x=JSON.parse(JSON.stringify(questData[M].itemsNeededForCompletion[r]))).hallmark=0-characterId,k.push(x);hasItemsInInventory(k)?(thisSpeech=w[2],closeQuest(e,M)):(thisSpeech=w[1],e.speechIndex--);break;case"multi":for(var D=questData[M].subQuestsRequiredForCompletion.split(","),P=!0,A=0;A<D.length;A++)switch(questData[D[A]].whatIsRequiredForCompletion){case"possess":case"give":case"":hasItemsInInventory(questData[D[A]].itemsNeededForCompletion)||(P=!1);break;case"craft":var x;for(k=[],r=0;r<questData[M].itemsNeededForCompletion.length;r++)(x=JSON.parse(JSON.stringify(questData[M].itemsNeededForCompletion[r]))).hallmark=0-characterId,k.push(x);hasItemsInInventory(k)||(P=!1);break;case"world":questData[D[A]].hasBeenActivated<1&&(P=!1);break;default:var N=questData[D[A]].valueAtQuestStart,O=accessDynamicVariable(questData[D[A]].whatIsRequiredForCompletion);"+"==questData[D[A]].thresholdNeededForCompletion.charAt(0)?O-N<questData[D[A]].thresholdNeededForCompletion&&(P=!1):O<questData[D[A]].thresholdNeededForCompletion.substring(1)&&(P=!1)}P?(thisSpeech=w[2],closeQuest(e,M)):(thisSpeech=w[1],e.speechIndex--);break;case"escort":void 0!==e.hasCompletedEscortQuest?(thisSpeech=w[2],closeQuest(e,M),delete e.hasCompletedEscortQuest):(thisSpeech=w[1],e.speechIndex--);break;case"world":questData[M].hasBeenActivated>0?(thisSpeech=w[2],closeQuest(e,M)):(thisSpeech=w[1],e.speechIndex--);break;default:N=questData[M].valueAtQuestStart,O=accessDynamicVariable(questData[M].whatIsRequiredForCompletion);var L=!1;if("["==questData[M].thresholdNeededForCompletion.charAt(0)){var B=O.map(String),E=questData[M].thresholdNeededForCompletion.replace("[","").replace("]","").split(",");L=!0;for(var q=0;q<E.length;q++)-1===B.indexOf(E[q])&&(L=!1)}else"+"==questData[M].thresholdNeededForCompletion.charAt(0)?O-N>=questData[M].thresholdNeededForCompletion&&(L=!0):O>=questData[M].thresholdNeededForCompletion.substring(1)&&(L=!0);L?(thisSpeech=w[2],closeQuest(e,M)):(thisSpeech=w[1],e.speechIndex--)}else questData[M].hasBeenCompleted>0?thisSpeech=w[2]:(thisSpeech=w[1],e.speechIndex--);else"quest-optional"==o[r]?(questResponseNPC=e,acceptQuestChoice.classList.add("active"),thisSpeech=w[0],null!=e&&e.speechIndex--):("quest"!=o[r]&&"quest-no-close"!=o[r]||openQuest(M),thisSpeech=w[0],null!=e&&e.speechIndex--);break;case"play":startCardGame(e);break;case"hnefatafl":thisChallengeNPC=e,startHnefataflGame(e)}""!=thisSpeech?(void 0===thisSpeech&&(thisSpeech=w[0]),UI.showDialogue(e,thisSpeech)):e.speechIndex--,canCloseDialogueBalloonNextClick=!1,i||(canCloseDialogueBalloonNextClick=!0)}function updateItems(){for(var e,t,a,i=[[0,1],[0,-1],[1,0],[-1,0]],n=0;n<visibleMaps.length;n++)for(var o=0;o<thisMapData[visibleMaps[n]].items.length;o++)e=thisMapData[visibleMaps[n]].items[o],"nest"==currentActiveInventoryItems[e.type].action&&e.spawnsRemaining>0&&hero.totalGameTimePlayed-e.timeLastSpawned>=currentActiveInventoryItems[e.type].respawnRate&&(t=e.contains[getRandomIntegerInclusive(1,e.contains.length)-1],a=getRandomElementFromArray(i),t.tileX=e.tileX+a[0],t.tileY=e.tileY+a[1],tileIsClear(t.tileX,t.tileY)&&(thisMapData[visibleMaps[n]].npcs.push(JSON.parse(JSON.stringify(t))),initialiseNPC(thisMapData[visibleMaps[n]].npcs[thisMapData[visibleMaps[n]].npcs.length-1]),e.spawnsRemaining--,e.timeLastSpawned=hero.totalGameTimePlayed))}function checkForTitlesAwarded(e){if(questData[e].titleGainedAfterCompletion){var t=questData[e].titleGainedAfterCompletion;-1==hero.titlesEarned.indexOf(t)&&(hero.titlesEarned.push(t),UI.showNotification("<p>I earned the &quot;"+possibleTitles[t]+"&quot; title</p>"))}}function checkForChallenges(){for(var e,t=0;t<visibleMaps.length;t++)for(var a=0;a<thisMapData[visibleMaps[t]].npcs.length;a++)if(e=thisMapData[visibleMaps[t]].npcs[a],isInRange(hero.x,hero.y,e.x,e.y,e.width+hero.width)&&isFacing(hero,e)&&e.cardGameSpeech){e.drawnFacing=turntoFace(e,hero),thisChallengeNPC=e,processSpeech(e,e.cardGameSpeech.challenge[0],e.cardGameSpeech.challenge[1]);break}key[6]=0}function jumpToLocation(e,t,a){activeDoorX=t,activeDoorY=a,jumpMapId=e,startDoorTransition()}function moveNPCs(){for(var e,t,a,i,n,o,r,s,c=0;c<visibleMaps.length;c++)for(var l=0;l<thisMapData[visibleMaps[c]].npcs.length;l++)if((e=thisMapData[visibleMaps[c]].npcs[l]).hasJustGotNewPath=!1,void 0===e.isPlayingCards){if(t=!1,e.isMoving){switch(a=e.x,i=e.y,e.drawnFacing=e.facing,e.facing){case"n":if(e.y-=e.speed,isATerrainCollision(e.x-e.width/2,e.y-e.length/2)||isATerrainCollision(e.x+e.width/2,e.y-e.length/2)){var h=(getTileY(e.y-e.length/2)+1)*tileW;e.y=h+e.length/2+1}break;case"s":if(e.y+=e.speed,isATerrainCollision(e.x-e.width/2,e.y+e.length/2)||isATerrainCollision(e.x+e.width/2,e.y+e.length/2)){var d=getTileY(e.y+e.length/2)*tileW;e.y=d-e.length/2-1}break;case"w":if(e.x-=e.speed,isATerrainCollision(e.x-e.width/2,e.y+e.length/2)||isATerrainCollision(e.x-e.width/2,e.y-e.length/2)){var u=(getTileX(e.x-e.width/2)+1)*tileW;e.x=u+e.width/2+1}break;case"e":if(e.x+=e.speed,isATerrainCollision(e.x+e.width/2,e.y+e.length/2)||isATerrainCollision(e.x+e.width/2,e.y-e.length/2)){var p=getTileX(e.x+e.width/2)*tileW;e.x=p-e.width/2-1}}if(isAnObjectCollision(e.x,e.y,e.width,e.length,hero.x,hero.y,hero.width,hero.length)&&(e.x=a,e.y=i),hasActivePet)for(var g=0;g<hero.activePets.length;g++)isAnObjectCollision(e.x,e.y,e.width,e.length,hero.allPets[hero.activePets[g]].x,hero.allPets[hero.activePets[g]].y,hero.allPets[hero.activePets[g]].width,hero.allPets[hero.activePets[g]].length)&&(e.x=a,e.y=i);for(var m=0;m<visibleMaps.length;m++)for(g=0;g<thisMapData[visibleMaps[m]].npcs.length;g++)n=thisMapData[visibleMaps[m]].npcs[g],e.uniqueIndex!=n.uniqueIndex&&n.isCollidable&&isAnObjectCollision(e.x,e.y,e.width,e.length,n.x,n.y,n.width,n.length)&&(e.x=a,e.y=i);for(g=0;g<thisMapData[currentMap].items.length;g++)(o=thisMapData[currentMap].items[g]).isCollidable&&isAnObjectCollision(e.x,e.y,e.width,e.length,o.x,o.y,o.width,o.length)&&(e.x=a,e.y=i);if(void 0!==thisMapData[currentMap].innerDoors)for(var l in thisMapData[currentMap].innerDoors)(s=thisMapData[currentMap].innerDoors[l]).isOpen||isAnObjectCollision(getTileCentreCoordX(s.tileX),getTileCentreCoordY(s.tileY),tileW,tileW,e.x,e.y,e.width,e.length)&&(e.x=a,e.y=i);e.dx+=e.x-a,e.dy+=e.y-i,Math.abs(e.dx)>=tileW&&(e.dx>0?e.dx-=tileW:e.dx+=tileW,t=!0),Math.abs(e.dy)>=tileW&&(e.dy>0?e.dy-=tileW:e.dy+=tileW,t=!0)}if(t||e.forceNewMovementCheck){switch(e.tileX=getTileX(e.x),e.tileY=getTileY(e.y),void 0!==e.following&&(e.forceNewMovementCheck||checkForEscortQuestEnd(e)),e.movementIndex++,e.movementIndex>=e.movement.length&&(e.movementIndex=0),"string"!=typeof(r=e.movement[e.movementIndex])?r[0]:r){case"-":e.isMoving=!1,e.forceNewMovementCheck=!1;break;case"?":if(1==getRandomIntegerInclusive(1,3)||!tileIsClear(e.tileX+relativeFacing[e.facing].x,e.tileY+relativeFacing[e.facing].y)){var v;switch(v="n"==e.facing||"s"==e.facing?1==getRandomIntegerInclusive(1,2)?["e","w"]:["w","e"]:1==getRandomIntegerInclusive(1,2)?["n","s"]:["s","n"],e.facing){case"n":v.push("s"),v.push("n");break;case"s":v.push("n"),v.push("s");break;case"e":v.push("w"),v.push("e");break;case"w":v.push("e"),v.push("w")}do{e.facing=v.shift()}while(!tileIsClear(e.tileX+relativeFacing[e.facing].x,e.tileY+relativeFacing[e.facing].y))}e.forceNewMovementCheck=!1;break;case"find":e.forceNewMovementCheck=!0,e.waitingForAPath||void 0!==e.waitingTimer?(e.waitingTimer++,e.waitingTimer>r[3]?(e.isMoving=!0,e.hasJustGotNewPath=!0,e.currentAnimation="walk",delete e.waitingTimer):(e.movementIndex--,e.isMoving=!1)):(pathfindingWorker.postMessage([r[1],e,thisMapData,visibleMaps,isOverWorldMap]),e.isMoving=!1,e.waitingForAPath=!0,e.waitingTimer=0,e.currentAnimation="wait",e.movementIndex--);break;case"wait":void 0===e.waitingTimer?(e.waitingTimer=0,e.currentAnimation="wait",e.isMoving=!1,e.movementIndex--):(e.waitingTimer++,e.waitingTimer>r[1]?(activeObjectForDialogue==e&&(dialogue.classList.remove("active"),dialogue.addEventListener(whichTransitionEvent,UI.removeActiveDialogue,!1)),e.isMoving=!0,e.currentAnimation="walk",delete e.waitingTimer):(e.movementIndex--,e.isMoving=!1));break;case"proximity":e.forceNewMovementCheck=!0;var f=r[1];isInRange(hero.x,hero.y,e.x,e.y,f*tileW)?e.isMoving=!0:(e.isMoving=!1,e.movementIndex--);break;case"speech":processSpeech(e,r[1],"",!1);break;case"remove":e.movement.splice(e.movementIndex-1,2),e.movementIndex-=2;break;case"pathEnd":var y;if(void 0!==e.following){for(g=e.movementIndex;g>=0;g--)if("string"==typeof(y=e.movement[g])&&"following"==y){var I=e.movementIndex-g;e.movement.splice(g+1,I),e.movementIndex-=I+1,e.isMoving=!0,e.forceNewMovementCheck=!0,delete e.waitingTimer;break}}else{var b=e.lastTargetDestination.split("-");for(e.drawnFacing=turntoFaceTile(e,b[0],b[1]),g=e.movementIndex;g>=0;g--)if("string"!=typeof(y=e.movement[g])&&"find"==y[0]){I=e.movementIndex-g;e.movement.splice(g+1,I),e.movementIndex-=I,e.isMoving=!1,e.forceNewMovementCheck=!0,delete e.waitingTimer;break}}break;case"talkToNeighbour":for(g=0;g<thisMapData[currentMap].npcs.length;g++)l!=g&&(n=thisMapData[currentMap].npcs[g],Math.abs(n.tileX-e.tileX)<=1&&Math.abs(n.tileY-e.tileY)<=1&&(n.drawnFacing=turntoFace(n,e)));break;case"follow":switch(r[1]){case"hero":hero.npcsFollowing.length>0?e.following=hero.npcsFollowing[hero.npcsFollowing[hero.npcsFollowing.length-1]]:hero.activePets.length>0?e.following=hero.allPets[hero.activePets[hero.activePets.length-1]]:e.following=hero,hero.npcsFollowing.push(e),e.movement[e.movementIndex]="following",e.movementIndex--,e.forceNewMovementCheck=!1,e.isMoving=!0}break;case"following":if(isInRange(e.following.x,e.following.y,e.x,e.y,2*tileW))e.isMoving=!1,e.movementIndex--,e.forceNewMovementCheck=!0;else{e.isMoving=!0;for(var M=!1,w=0;w<e.following.breadcrumb.length;w++)if(e.tileY==e.following.breadcrumb[w][1]){if(e.tileX-1==e.following.breadcrumb[w][0]){e.facing="w",M=!0;break}if(e.tileX+1==e.following.breadcrumb[w][0]){e.facing="e",M=!0;break}}else if(e.tileX==e.following.breadcrumb[w][0]){if(e.tileY+1==e.following.breadcrumb[w][1]){e.facing="s",M=!0;break}if(e.tileY-1==e.following.breadcrumb[w][1]){e.facing="n",M=!0;break}}M?(e.movementIndex--,e.forceNewMovementCheck=!1):(e.forceNewMovementCheck=!0,e.waitingForAPath||void 0!==e.waitingTimer?e.isMoving=!0:(pathfindingWorker.postMessage(["npcFindFollowing",e,thisMapData,visibleMaps,isOverWorldMap]),e.isMoving=!1,e.waitingForAPath=!0,e.waitingTimer=0,e.movementIndex--))}break;case"sound":var C=1;r[2]&&(C=(worldMapWidthPx-getPythagorasDistance(e.x,e.y,hero.x,hero.y))/worldMapWidthPx),C>.05&&audio.playSound(soundEffects[r[1]],0,0,C);break;case"animate":void 0===e.animationWaitingTimer?(e.currentAnimation=r[1],e.animationWaitingTimer=currentAnimationFrame,e.movementIndex--,e.isMoving=!1,e.forceNewMovementCheck=!0):currentAnimationFrame+1<e.animation[e.currentAnimation].length*r[2]+e.animationWaitingTimer?(e.movementIndex--,e.forceNewMovementCheck=!0):(e.isMoving=!0,e.forceNewMovementCheck=!0,e.currentAnimation="walk",delete e.animationWaitingTimer);break;default:e.facing=r,e.forceNewMovementCheck=!1}if(e.isMoving&&!e.hasJustGotNewPath){var S=relativeFacing[e.facing],T=e.tileX+S.x,k=e.tileY+S.y;if(!tileIsClear(T,k)&&""!=e.lastTargetDestination){var D;b=e.lastTargetDestination.split("-");for(g=e.movement.length;g>=0;g--)if("pathEnd"==e.movement[g]){D=g;break}for(g=D;g>=0;g--)if(!("string"==typeof(y=e.movement[g])&&0!=g||"find"!=y[0]&&0!=g)){I=D-g;e.movement.splice(g+1,I),e.movementIndex=g,e.isMoving=!1,e.forceNewMovementCheck=!0,delete e.waitingTimer;break}if(!e.waitingForAPath&&void 0===e.waitingTimer){var P,A,x,N,O=JSON.parse(JSON.stringify(thisMapData));for(w=-3;w<=3;w++)for(var L=-3;L<=3;L++)tileIsClear(P=T+w,A=k+L)||(x=getLocalCoordinatesX(P),N=getLocalCoordinatesY(A),O[findMapNumberFromGlobalCoordinates(P,A)].collisions[x][N]=1);pathfindingWorker.postMessage(["tile",b[0],b[1],e,O,visibleMaps,isOverWorldMap]),e.isMoving=!1,e.waitingForAPath=!0,e.waitingTimer=0,e.currentAnimation="wait",e.movementIndex--}}}}checkForSlopes(e)}}function movePlatforms(){if(thisMapData[currentMap].movingPlatforms){for(var e=0;e<thisMapData[currentMap].items.length;e++)null!=thisMapData[currentMap].items[e].isOnPlatform&&thisMapData[currentMap].movingPlatforms[thisMapData[currentMap].items[e].isOnPlatform].canMove&&(thisMapData[currentMap].items[e].x+=thisMapData[currentMap].movingPlatforms[thisMapData[currentMap].items[e].isOnPlatform].dx,thisMapData[currentMap].items[e].y+=thisMapData[currentMap].movingPlatforms[thisMapData[currentMap].items[e].isOnPlatform].dy,thisMapData[currentMap].items[e].z+=thisMapData[currentMap].movingPlatforms[thisMapData[currentMap].items[e].isOnPlatform].dz);var t,a;for(e=0;e<thisMapData[currentMap].movingPlatforms.length;e++)(t=thisMapData[currentMap].movingPlatforms[e]).canMove&&(t.x+=t.dx,t.y+=t.dy,t.z+=t.dz,Math.abs(t.targetX-t.x)<.5&&Math.abs(t.targetY-t.y)<.5&&Math.abs(t.targetZ-t.z)<.5&&(t.x=t.targetX,t.y=t.targetY,t.z=t.targetZ,a=determinePlatformIncrements(t),t.dx=a[0],t.dy=a[1],t.dz=a[2]))}}function determinePlatformIncrements(e){var t,a,i,n=e.movement[e.movementIndex],o=getTileCentreCoordX(n[0]),r=getTileCentreCoordY(n[1]),s=n[2],c=getPythagorasDistance(e.x,e.y,o,r)/e.speed;return t=0-(e.x-o)/c,a=0-(e.y-r)/c,i=0-(e.z-s)/c,e.targetX=o,e.targetY=r,e.targetZ=s,e.movementIndex++,e.movementIndex>=e.movement.length&&(e.movementIndex=0),[t,a,i]}function loadNewRecipeData(e){getJSON("/game-world/getRecipeDetails.php?recipe="+e,function(t){hero.crafting[t.profession].recipes[e]=t.recipe[e],hero.crafting[t.profession].sortOrder.unshift(e)},function(t){loadNewRecipeData(e)})}function canLearnRecipe(e){var t=!1;return console.log(hero.crafting),-1===hero.recipesKnown.indexOf(e)&&(hero.recipesKnown.push(parseInt(e)),loadNewRecipeData(e),t=!0),t}function initialiseAndPlacePet(e,t,a){var i=e.shift(),n=hero.allPets.length;hero.allPets.push(i),hero.activePets.push(n),initialisePet(hero.activePets.length-1,t,a),initialisePetObject(hero.activePets.length-1),i.inventorySize>0&&inventoryPanels.insertAdjacentHTML("beforeend",UI.generatePetInventorySlot(n)),Loader.preload([{name:"activePet"+hero.activePets[n],src:"/images/game-world/npcs/"+i.src}],function(){activePetImages.push(Loader.getImage("activePet"+hero.activePets[n])),e.length>0&&initialiseAndPlacePet(thesePetsToAdd.shift(),t,a)},function(){})}function addPetToWorld(){UI.hideYesNoDialogueBox();var e=0,t=0;switch(hero.facing){case"n":t=2;break;case"s":t=-2;break;case"e":e=-2;break;case"w":e=2}soundEffects.hasOwnProperty(hero.inventory[inventorySlotReference].contains[0].name)&&audio.playSound(soundEffects[hero.inventory[inventorySlotReference].contains[0].name],0),initialiseAndPlacePet(hero.inventory[inventorySlotReference].contains,e,t),reducedHeldQuantity(inventorySlotReference),hasActivePet=!0}function checkAddPetToWorld(){UI.showYesNoDialogueBox("Hatch "+hero.inventory[inventorySlotReference].contains[0].name+"?","Yes","No, keep it as an egg","addPetToWorld","UI.hideYesNoDialogueBox")}function sendUserPost(e){var t=JSON.parse(e);getJSONWithParams("/game-world/sendPost.php","postData="+JSON.stringify(t),function(e){e.success?console.log("user post sent"):console.log("user post failed #1")},function(e){console.log("user post failed #2")})}function sendNPCPost(e,t){console.log(e);var a=JSON.parse(e);t&&(a.attachments=t),getJSONWithParams("/game-world/sendPost.php","postData="+JSON.stringify(a),function(e){e.success?newPost.classList.add("active"):console.log("npc post failed #1")},function(e){console.log("npc post failed #2")})}function saveGame(){var e=[],t=JSON.stringify(hero,function(t,a){if("object"==typeof a&&null!==a){if(-1!==e.indexOf(a))return;e.push(a)}return a});e=null,getJSONWithParams("/game-world/saveGameState.php","chr="+characterId+"+&postData="+t,function(e){e.success},function(e){})}function isVisibleOnScreen(e,t){var a=Math.abs(hero.isox-e),i=Math.abs(hero.isoy-t);return!(a>canvasWidth/2+tileW)&&!(i>canvasHeight/2+tileW)}function printScreen(){var e=gameCanvas.toDataURL("image/jpeg",1),t=URL.createObjectURL(dataURItoBlob(e)),a=document.getElementById("printScreenAnchor");a.href=t,a.setAttribute("download","screenshot_"+getCurrentDateTimeFormatted()+".jpg"),a.click()}function draw(){if("mapLoading"==gameMode)gameContext.fillStyle="#000000",gameContext.fillRect(0,0,canvasWidth,canvasHeight);else{if(waterContext.fillStyle="#000000",waterContext.fillRect(0,0,canvasWidth,-canvasHeight),reflectionContext.clearRect(0,0,canvasWidth,-canvasHeight),isOverWorldMap){gameContext.clearRect(0,0,canvasWidth,canvasHeight);var e,t,a=oceanSpriteWidth-(hero.isox+1e10)%oceanSpriteWidth,i=oceanSpriteHeight-(hero.isoy+1e10)%oceanSpriteHeight;oceanContext.drawImage(ocean,Math.floor(oceanCurrentFrame)*oceanSpriteWidth,0,oceanSpriteWidth,oceanSpriteHeight,0,0,oceanSpriteWidth,oceanSpriteHeight);for(var n=-oceanSpriteWidth;n<=canvasWidth;n+=oceanSpriteWidth)for(var o=-oceanSpriteHeight;o<=canvasHeight;o+=oceanSpriteHeight)gameContext.drawImage(oceanCanvas,a+n,i+o);(oceanCurrentFrame+=.25)==oceanNumberOfFrames&&(oceanCurrentFrame=0),waterContext.globalCompositeOperation="destination-out";for(n=0;n<visibleMaps.length;n++)b=thisMapData[visibleMaps[n]].globalCoordinateTile0X*worldMapTileLength,M=thisMapData[visibleMaps[n]].globalCoordinateTile0Y*worldMapTileLength,e=Math.floor(canvasWidth/2+getTileIsoCentreCoordX(b,M)-hero.isox-worldMapWidthPx/2),t=Math.floor(canvasHeight/2+getTileIsoCentreCoordY(b,M)-hero.isoy-tileH/2),void 0!==backgroundImgs[visibleMaps[n]]&&(gameContext.drawImage(backgroundImgs[visibleMaps[n]],e,t),waterContext.drawImage(backgroundImgs[visibleMaps[n]],e,t-canvasHeight));waterContext.globalCompositeOperation="source-over"}else gameContext.fillStyle="#000000",gameContext.fillRect(0,0,canvasWidth,canvasHeight),void 0!==backgroundImgs[currentMap]&&gameContext.drawImage(backgroundImgs[currentMap],Math.floor(getTileIsoCentreCoordX(0,mapTilesY-1)-thisMapData[currentMap].backgroundOffsetX-hero.isox-tileW/2+canvasWidth/2),Math.floor(getTileIsoCentreCoordY(0,0)-hero.isoy-thisMapData[currentMap].backgroundOffsetY-tileH/2+canvasHeight/2));var r,s,c,l,h,d,u,p,g,m;hero.isox=findIsoCoordsX(hero.x,hero.y),hero.isoy=findIsoCoordsY(hero.x,hero.y);var v=currentAnimationFrame%hero.animation[hero.currentAnimation].length,f=hero.animation[hero.currentAnimation][hero.facing]+hero.animation[hero.currentAnimation]["start-row"],y=0;void 0!==thisMapData[currentMap].properties[getLocalCoordinatesY(hero.tileY)][getLocalCoordinatesX(hero.tileX)].waterDepth?(y=thisMapData[currentMap].properties[getLocalCoordinatesY(hero.tileY)][getLocalCoordinatesX(hero.tileX)].waterDepth,"water"!=hero.terrain&&(audio.playSound(soundEffects.splash,0),hero.terrain="water")):hero.terrain="earth";var I,b,M,w=[[findIsoDepth(hero.x,hero.y,hero.z),"sprite",heroImg,v*hero.spriteWidth,f*hero.spriteHeight,hero.spriteWidth,hero.spriteHeight-y,Math.floor(canvasWidth/2-hero.centreX),Math.floor(canvasHeight/2-hero.centreY-hero.z),hero.spriteWidth,hero.spriteHeight-y,,hero.centreY-y/2]];if(interfaceIsVisible){switch(activeAction){case"dowse":w.push([0,"dowsingRing",Math.floor(canvasWidth/2-dowsingRingSize/2),Math.floor(canvasHeight/2-dowsingRingSize/4)]);break;case"plotPlacement":w.push([0,"plotPlacementOverlay"])}if("housing"==gameMode&&(hero.settings.showFootprintInEditMode&&w.push([0,"houseGroundPlan"]),housingNameSpace.mousePosition[0]>=hero.housing.northWestCornerTileX&&housingNameSpace.mousePosition[0]<hero.housing.southEastCornerTileX&&housingNameSpace.mousePosition[1]>=hero.housing.northWestCornerTileY&&housingNameSpace.mousePosition[1]<hero.housing.southEastCornerTileY))switch(housingNameSpace.activeTool){case"paint":""!=housingNameSpace.whichTileActive&&(h=0,housingNameSpace.currentTileCanBeElevated&&(h=housingNameSpace.whichZIndexActive),w.push([findIsoDepth(getTileCentreCoordX(housingNameSpace.mousePosition[0]),getTileCentreCoordY(housingNameSpace.mousePosition[1]),h+getElevation(housingNameSpace.mousePosition[0],housingNameSpace.mousePosition[1])),"ghostSelectedHousingTile"]));break;case"remove":w.push([0,"ghostRemoveHousingTile"])}}if("housing"==gameMode){var C,S,T,k;for(n=housingNameSpace.whichElevationActive,o=0;o<hero.housing.draft[n].length;o++){C=hero.housing.draft[n][o].type;var D=(hero.housing.northWestCornerTileX+hero.housing.draft[n][o].tileX+.5)*tileW,P=(hero.housing.northWestCornerTileY+hero.housing.draft[n][o].tileY+.5)*tileW,A=getElevation(hero.housing.northWestCornerTileX+hero.housing.draft[n][o].tileX,hero.housing.northWestCornerTileY+hero.housing.draft[n][o].tileY);if(R="",hero.housing.draft[n][o].colour)""!=(Q=colourNames[hero.housing.draft[n][o].colour])&&(R="-"+Q.toLowerCase());x="item"+C+R,c=findIsoCoordsX(D,P),l=findIsoCoordsY(D,P),hero.housing.draft[n][o].tileZ&&(A+=hero.housing.draft[n][o].tileZ*tileW),p=!1,"remove"==housingNameSpace.activeTool&&hero.housing.northWestCornerTileX+hero.housing.draft[n][o].tileX==housingNameSpace.mousePosition[0]&&hero.housing.northWestCornerTileY+hero.housing.draft[n][o].tileY==housingNameSpace.mousePosition[1]&&(p=!0),void 0!==currentActiveInventoryItems[C]?(g=currentActiveInventoryItems[C].centreX,m=currentActiveInventoryItems[C].centreY,S=currentActiveInventoryItems[C].canBeRotated,T=currentActiveInventoryItems[C].spriteHeight,k=currentActiveInventoryItems[C].spriteWidth):(g=housingData[C].centreX,m=housingData[C].centreY,S=housingData[C].canBeRotated,T=housingData[C].spriteHeight,k=housingData[C].spriteWidth),p?S?w.push([findIsoDepth(D,P,A),"sprite",itemImages[x],0,facingsPossible.indexOf(hero.housing.draft[n][o].facing)*T,k,T,Math.floor(c-hero.isox-g+canvasWidth/2),Math.floor(l-hero.isoy-m+canvasHeight/2-A),k,T,.3]):w.push([findIsoDepth(D,P,A),"img",itemImages[x],Math.floor(c-hero.isox-g+canvasWidth/2),Math.floor(l-hero.isoy-m+canvasHeight/2-A),.3]):S?w.push([findIsoDepth(D,P,A),"sprite",itemImages[x],0,facingsPossible.indexOf(hero.housing.draft[n][o].facing)*T,k,T,Math.floor(c-hero.isox-g+canvasWidth/2),Math.floor(l-hero.isoy-m+canvasHeight/2-A),k,T]):w.push([findIsoDepth(D,P,A),"img",itemImages[x],Math.floor(c-hero.isox-g+canvasWidth/2),Math.floor(l-hero.isoy-m+canvasHeight/2-A)])}}c=findIsoCoordsX(fae.x,fae.y),l=findIsoCoordsY(fae.x,fae.y),fae.oscillateOffset=8*(Math.sin(fae.dz)+1)+fae.z+fae.zOffset,isVisibleOnScreen(c,l)&&w.push([findIsoDepth(fae.x,fae.y,fae.z),"faeCentre",Math.floor(c-hero.isox+canvasWidth/2),Math.floor(l-hero.isoy+canvasHeight/2-fae.oscillateOffset)]);for(n=0;n<fae.particles.length;n++)w.push([fae.particles[n].depth,"faeParticle",Math.floor(fae.particles[n].isoX-hero.isox+canvasWidth/2),Math.floor(fae.particles[n].isoY-hero.isoy+canvasHeight/2),fae.particles[n].alpha]);for(var x,N,O,L,B,E,q,U,W=0,j=0,R="",H=0,F=0,Y=0;Y<visibleMaps.length;Y++){I=thisMapData[visibleMaps[Y]].terrain,isOverWorldMap?(b=thisMapData[visibleMaps[Y]].globalCoordinateTile0X*worldMapTileLength,M=thisMapData[visibleMaps[Y]].globalCoordinateTile0Y*worldMapTileLength):(b=0,M=0);for(n=0;n<mapTilesX;n++)for(o=0;o<mapTilesY;o++){if("*"!=I[o][n]&&isVisibleOnScreen(c=getTileIsoCentreCoordX(n+b,o+M),l=getTileIsoCentreCoordY(n+b,o+M))&&(r=thisMapData[visibleMaps[Y]].graphics[I[o][n]].centreX,s=thisMapData[visibleMaps[Y]].graphics[I[o][n]].centreY,L=thisMapData[visibleMaps[Y]].graphics[I[o][n]].src,thisMapData[visibleMaps[Y]].graphics[I[o][n]].animation?(B=thisMapData[visibleMaps[Y]].graphics[I[o][n]].animation,H=Math.floor(B.currentFrame),F=0,w.push([findIsoDepth(getTileCentreCoordX(n+b),getTileCentreCoordY(o+M),0),"sprite",tileImages[L],H*B.spriteWidth,F*B.spriteHeight,B.spriteWidth,B.spriteHeight,Math.floor(c-hero.isox-r+canvasWidth/2),Math.floor(l-hero.isoy-s+canvasHeight/2),B.spriteWidth,B.spriteHeight,,s])):w.push([findIsoDepth(getTileCentreCoordX(n+b),getTileCentreCoordY(o+M),0),"img",tileImages[L],Math.floor(c-hero.isox-r+canvasWidth/2),Math.floor(l-hero.isoy-s+canvasHeight/2)])),1==thisMapData[visibleMaps[Y]].properties[o][n].tilled&&isVisibleOnScreen(c=getTileIsoCentreCoordX(n+b,o+M),l=getTileIsoCentreCoordY(n+b,o+M))&&(r=tileW/2,s=tileH/2,w.push([0,"img",tilledEarth,Math.floor(c-hero.isox-r+canvasWidth/2),Math.floor(l-hero.isoy-s+canvasHeight/2)])),void 0!==thisMapData[visibleMaps[Y]].properties[o][n].water&&thisMapData[visibleMaps[Y]].properties[o][n].water.amount>0&&isVisibleOnScreen(c=getTileIsoCentreCoordX(n+b,o+M),l=getTileIsoCentreCoordY(n+b,o+M))){r=tileW/2,s=tileH/2;for(var X=0;X<thisMapData[visibleMaps[Y]].properties[o][n].water.amount;X++)w.push([X+1,"img",addedWater,Math.floor(c-hero.isox-r+canvasWidth/2),Math.floor(l-hero.isoy-s+canvasHeight/2)])}void 0!==thisMapData[visibleMaps[Y]].properties[o][n].waterDepth&&isVisibleOnScreen(c=getTileIsoCentreCoordX(n+b,o+M),l=getTileIsoCentreCoordY(n+b,o+M))&&(r=tileW/2,s=tileH/2,waterContext.drawImage(tileMask,Math.floor(c-hero.isox-r+canvasWidth/2),Math.floor(l-hero.isoy-s+canvasHeight/2)-canvasHeight))}for(n=0;n<thisMapData[visibleMaps[Y]].graphics.length;n++)thisMapData[visibleMaps[Y]].graphics[n].animation&&(thisMapData[visibleMaps[Y]].graphics[n].animation.currentFrame+=.2,thisMapData[visibleMaps[Y]].graphics[n].animation.currentFrame>=thisMapData[visibleMaps[Y]].graphics[n].animation.length&&(thisMapData[visibleMaps[Y]].graphics[n].animation.currentFrame=0));var G;if(void 0!==thisMapData[visibleMaps[Y]].innerDoors)for(var n in thisMapData[visibleMaps[Y]].innerDoors)thisMapData[visibleMaps[Y]].innerDoors[n].isOpen||isVisibleOnScreen(c=getTileIsoCentreCoordX(thisMapData[visibleMaps[Y]].innerDoors[n].tileX,thisMapData[visibleMaps[Y]].innerDoors[n].tileY),l=getTileIsoCentreCoordY(thisMapData[visibleMaps[Y]].innerDoors[n].tileX,thisMapData[visibleMaps[Y]].innerDoors[n].tileY))&&(G=thisMapData[visibleMaps[Y]].innerDoors[n].graphic,G=thisMapData[visibleMaps[Y]].graphics[G].src,r=thisMapData[visibleMaps[Y]].graphics[thisMapData[visibleMaps[Y]].innerDoors[n].graphic].centreX,s=thisMapData[visibleMaps[Y]].graphics[thisMapData[visibleMaps[Y]].innerDoors[n].graphic].centreY,w.push([findIsoDepth(getTileCentreCoordX(thisMapData[visibleMaps[Y]].innerDoors[n].tileX),getTileCentreCoordY(thisMapData[visibleMaps[Y]].innerDoors[n].tileY),0),"img",tileImages[G],Math.floor(c-hero.isox-r+canvasWidth/2),Math.floor(l-hero.isoy-s+canvasHeight/2)]))}if(hasActivePet)for(n=0;n<hero.activePets.length;n++)"moving"!=(E=hero.allPets[hero.activePets[n]].state)&&(E="wait"),W=currentAnimationFrame%hero.allPets[hero.activePets[n]].animation[E].length,j=hero.allPets[hero.activePets[n]].animation[E][hero.allPets[hero.activePets[n]].facing],isVisibleOnScreen(c=findIsoCoordsX(hero.allPets[hero.activePets[n]].x,hero.allPets[hero.activePets[n]].y),l=findIsoCoordsY(hero.allPets[hero.activePets[n]].x,hero.allPets[hero.activePets[n]].y))&&w.push([findIsoDepth(hero.allPets[hero.activePets[n]].x,hero.allPets[hero.activePets[n]].y,hero.allPets[hero.activePets[n]].z),"sprite",activePetImages[n],W*hero.allPets[hero.activePets[n]].spriteWidth,j*hero.allPets[hero.activePets[n]].spriteHeight,hero.allPets[hero.activePets[n]].spriteWidth,hero.allPets[hero.activePets[n]].spriteHeight,Math.floor(c-hero.isox-hero.allPets[hero.activePets[n]].centreX+canvasWidth/2),Math.floor(l-hero.isoy-hero.allPets[hero.activePets[n]].centreY+canvasHeight/2-hero.allPets[hero.activePets[n]].z),hero.allPets[hero.activePets[n]].spriteWidth,hero.allPets[hero.activePets[n]].spriteHeight,,hero.allPets[hero.activePets[n]].centreY]);for(Y=0;Y<visibleMaps.length;Y++){whichVisibleMap=visibleMaps[Y];for(n=0;n<thisMapData[whichVisibleMap].npcs.length;n++)W=void 0===(d=thisMapData[whichVisibleMap].npcs[n]).animationWaitingTimer?currentAnimationFrame%d.animation[d.currentAnimation].length:(currentAnimationFrame+1-d.animationWaitingTimer)%d.animation[d.currentAnimation].length,j=d.animation[d.currentAnimation][d.drawnFacing],isVisibleOnScreen(c=findIsoCoordsX(d.x,d.y),l=findIsoCoordsY(d.x,d.y))&&(O="npc"+thisMapData[whichVisibleMap].npcs[n].src,w.push([findIsoDepth(d.x,d.y,d.z),"sprite",npcImages[O],W*d.spriteWidth,j*d.spriteHeight,d.spriteWidth,d.spriteHeight,Math.floor(c-hero.isox-d.centreX+canvasWidth/2),Math.floor(l-hero.isoy-d.centreY+canvasHeight/2-d.z),d.spriteWidth,d.spriteHeight,,d.centreY]));for(n=0;n<thisMapData[whichVisibleMap].items.length;n++)u=thisMapData[whichVisibleMap].items[n],q=!0,"housing"==gameMode&&u.lockedToPlayerId&&u.lockedToPlayerId==characterId&&(q=!1),q&&isVisibleOnScreen(c=findIsoCoordsX(u.x,u.y),l=findIsoCoordsY(u.x,u.y))&&(R="",thisMapData[whichVisibleMap].items[n].colour&&""!=(Q=getColourName(u.colour,u.type))&&(R="-"+Q.toLowerCase()),x="item"+thisMapData[whichVisibleMap].items[n].type+R,void 0!==thisMapData[whichVisibleMap].items[n].contains&&void 0!==thisMapData[whichVisibleMap].items[n].contains["ugc-id"]&&(x="item"+thisMapData[whichVisibleMap].items[n].type+"_"+thisMapData[whichVisibleMap].items[n].contains["ugc-id"]),void 0!==u.animation?(void 0!==u.state&&(H=u.animation[u.state].length-1,F=u.animation[u.state].row),w.push([findIsoDepth(u.x,u.y,u.z),"sprite",itemImages[x],H*u.spriteWidth,F*u.spriteHeight,u.spriteWidth,u.spriteHeight,Math.floor(c-hero.isox-u.centreX+canvasWidth/2),Math.floor(l-hero.isoy-u.centreY+canvasHeight/2-u.z),u.spriteWidth,u.spriteHeight])):u.canBeRotated?(H=0,F=facingsPossible.indexOf(u.facing),w.push([findIsoDepth(u.x,u.y,u.z),"sprite",itemImages[x],H*u.spriteWidth,F*u.spriteHeight,u.spriteWidth,u.spriteHeight,Math.floor(c-hero.isox-u.centreX+canvasWidth/2),Math.floor(l-hero.isoy-u.centreY+canvasHeight/2-u.z),u.spriteWidth,u.spriteHeight])):w.push([findIsoDepth(u.x,u.y,u.z),"img",itemImages[x],Math.floor(c-hero.isox-u.centreX+canvasWidth/2),Math.floor(l-hero.isoy-u.centreY+canvasHeight/2-u.z)]));if(thisMapData[whichVisibleMap].movingPlatforms)for(n=0;n<thisMapData[whichVisibleMap].movingPlatforms.length;n++)isVisibleOnScreen(c=findIsoCoordsX((N=thisMapData[whichVisibleMap].movingPlatforms[n]).x,N.y),l=findIsoCoordsY(N.x,N.y))&&(r=thisMapData[whichVisibleMap].graphics[N.graphic].centreX,s=thisMapData[whichVisibleMap].graphics[N.graphic].centreY,w.push([findIsoDepth(N.x,N.y,N.z),"img",tileImages[N.graphic],Math.floor(c-hero.isox-r+canvasWidth/2),Math.floor(l-hero.isoy-s+canvasHeight/2)]))}w.sort(sortByLowestValue);for(n=0;n<w.length;n++)switch(w[n][1]){case"faeCentre":var V=getRandomIntegerInclusive(1,2);drawCircle("rgba(255,220,255,0.3)",w[n][2],w[n][3],4,gameContext),drawCircle("#fec856",w[n][2],w[n][3],V,gameContext),gameContext.fillStyle="rgba(0,0,0,"+.01*(65-fae.oscillateOffset)+")",gameContext.beginPath(),gameContext.ellipse(w[n][2]-getXOffsetFromHeight(fae.oscillateOffset),w[n][3]+fae.oscillateOffset,3,1,0,0,2*Math.PI),gameContext.fill();break;case"faeParticle":gameContext.fillStyle="rgba(255,220,255,"+w[n][4]+")",gameContext.fillRect(w[n][2],w[n][3],1,1);break;case"sprite":void 0!==w[n][2]&&(U=2*(w[n][10]-w[n][12]),void 0!==w[n][11]&&(gameContext.globalAlpha=w[n][11],reflectionContext.globalAlpha=w[n][11]),reflectionContext.drawImage(w[n][2],w[n][3],w[n][4],w[n][5],w[n][6],w[n][7],0-w[n][8]-2*w[n][6]+U,w[n][9],w[n][10]),gameContext.drawImage(w[n][2],w[n][3],w[n][4],w[n][5],w[n][6],w[n][7],w[n][8],w[n][9],w[n][10]),void 0!==w[n][11]&&(gameContext.globalAlpha=1,reflectionContext.globalAlpha=1));break;case"dowsingRing":gameContext.globalCompositeOperation="lighten",drawEllipse(gameContext,w[n][2]+(100-dowsing.proximity)/2,w[n][3]+(100-dowsing.proximity)/4,dowsingRingSize*dowsing.proximity/100,dowsingRingSize*dowsing.proximity/100/2,!0,"rgba(255,255,0,0.3)"),drawEllipse(gameContext,w[n][2],w[n][3],dowsingRingSize,dowsingRingSize/2,!1,"rgba(255,255,0,0.3)"),gameContext.globalCompositeOperation="source-over";break;case"ghostRemoveHousingTile":drawIsoRectangle(housingNameSpace.mousePosition[0]*tileW,housingNameSpace.mousePosition[1]*tileW,(housingNameSpace.mousePosition[0]+1)*tileW,(housingNameSpace.mousePosition[1]+1)*tileW,!0,"rgba(255,0,0,0.3)",gameContext);break;case"ghostSelectedHousingTile":var Q;if(gameContext.globalAlpha=.5,R="","0"!=housingNameSpace.whichDyeColourActive)R="-"+(Q=colourNames[housingNameSpace.whichDyeColourActive]).toLowerCase();x="item"+housingNameSpace.whichTileActive+R,void 0!==itemImages[x]&&(c=getTileIsoCentreCoordX(housingNameSpace.mousePosition[0],housingNameSpace.mousePosition[1]),l=getTileIsoCentreCoordY(housingNameSpace.mousePosition[0],housingNameSpace.mousePosition[1]),h=getElevation(housingNameSpace.mousePosition[0],housingNameSpace.mousePosition[1]),housingNameSpace.currentTileCanBeElevated&&(h+=housingNameSpace.whichZIndexActive),void 0!==currentActiveInventoryItems[housingNameSpace.whichTileActive]?(g=currentActiveInventoryItems[housingNameSpace.whichTileActive].centreX,m=currentActiveInventoryItems[housingNameSpace.whichTileActive].centreY,S=currentActiveInventoryItems[housingNameSpace.whichTileActive].canBeRotated,T=currentActiveInventoryItems[housingNameSpace.whichTileActive].spriteHeight,k=currentActiveInventoryItems[housingNameSpace.whichTileActive].spriteWidth):(g=housingData[housingNameSpace.whichTileActive].centreX,m=housingData[housingNameSpace.whichTileActive].centreY,S=housingData[housingNameSpace.whichTileActive].canBeRotated,T=housingData[housingNameSpace.whichTileActive].spriteHeight,k=housingData[housingNameSpace.whichTileActive].spriteWidth),S?(F=facingsPossible.indexOf(housingNameSpace.whichFacingActive),gameContext.drawImage(itemImages[x],0,F*T,k,T,Math.floor(c-hero.isox-g+canvasWidth/2),Math.floor(l-hero.isoy-m+canvasHeight/2-h),k,T)):gameContext.drawImage(itemImages[x],Math.floor(c-hero.isox-g+canvasWidth/2),Math.floor(l-hero.isoy-m+canvasHeight/2-h))),gameContext.globalAlpha=1;break;case"houseGroundPlan":drawIsoRectangle(hero.housing.northWestCornerTileX*tileW,hero.housing.northWestCornerTileY*tileW,hero.housing.southEastCornerTileX*tileW,hero.housing.southEastCornerTileY*tileW,!0,"rgba(255,255,0,0.2)",gameContext);break;case"plotPlacementOverlay":gameContext.globalCompositeOperation="soft-light";var J=getTileCoordsFromScreenPosition(cursorPositionX,cursorPositionY);if(cursorPositionX){var z,K,_;plotPlacement.numberOfBlockedTiles=0;for(o=0-plotPlacement.width/2;o<plotPlacement.width/2;o++)for(X=0-plotPlacement.length/2;X<plotPlacement.length/2;X++)_="rgba(0,255,0,0.8)",tileIsClear(z=J[0]+o,K=J[1]+X)||(_="rgba(255,0,0,0.8)",plotPlacement.numberOfBlockedTiles++),drawIsoRectangle(z*tileW,K*tileW,(z+1)*tileW,(K+1)*tileW,!0,_,gameContext)}gameContext.globalCompositeOperation="source-over";break;case"img":void 0!==w[n][5]&&(gameContext.globalAlpha=w[n][5]),void 0!==w[n][2]&&gameContext.drawImage(w[n][2],w[n][3],w[n][4]),void 0!==w[n][5]&&(gameContext.globalAlpha=1)}if(isOverWorldMap&&(reflectionContext.globalCompositeOperation="destination-in",reflectionContext.drawImage(waterCanvas,0,-canvasHeight),reflectionContext.globalCompositeOperation="source-over",gameContext.globalAlpha=.3,gameContext.drawImage(reflectedCanvas,0,0),gameContext.globalAlpha=1),""!=activeObjectForDialogue&&UI.updateDialogue(activeObjectForDialogue),thisMapData[currentMap].showOnlyLineOfSight){var Z;lightMapContext.clearRect(0,0,canvasWidth,canvasHeight);for(n=-1;n<mapTilesX;n++)for(o=-1;o<mapTilesY;o++)c=getTileIsoCentreCoordX(n,o),l=getTileIsoCentreCoordY(n,o),r=28,s=17,Z=1,n>-1&&o>-1&&(Z=1.01-lightMap[o][n]),Z>0?(lightMapContext.save(),lightMapContext.globalAlpha=Z,lightMapContext.drawImage(shadowImg,Math.floor(c-hero.isox-r+canvasWidth/2),Math.floor(l-hero.isoy-s+canvasHeight/2)),lightMapContext.restore()):lightMapContext.drawImage(shadowImg,Math.floor(c-hero.isox-r+canvasWidth/2),Math.floor(l-hero.isoy-s+canvasHeight/2));gameContext.drawImage(lightMapOverlay,0,0)}if("out"==mapTransition)if((ee=1-mapTransitionCurrentFrames/mapTransitionMaxFrames)<.02)gameContext.fillStyle="#000000",gameContext.fillRect(0,0,canvasWidth,canvasHeight);else($=gameContext.createRadialGradient(canvasWidth/2,canvasHeight/2,ee*canvasWidth/2,canvasWidth/2,canvasHeight/2,0)).addColorStop(0,"rgba(0,0,0,1)"),$.addColorStop(1,"rgba(0,0,0,0)"),gameContext.fillStyle=$,gameContext.fillRect(0,0,canvasWidth,canvasHeight);else if("in"==mapTransition){var $,ee=mapTransitionCurrentFrames/mapTransitionMaxFrames;($=gameContext.createRadialGradient(canvasWidth/2,canvasHeight/2,ee*canvasWidth/2,canvasWidth/2,canvasHeight/2,0)).addColorStop(0,"rgba(0,0,0,1)"),$.addColorStop(1,"rgba(0,0,0,0)"),gameContext.fillStyle=$,gameContext.fillRect(0,0,canvasWidth,canvasHeight)}}}function scheduleMeasurement(){if(!performance.measureMemory)return void console.log("performance.measureMemory() is not available.");const e=measurementInterval();console.log("Scheduling memory measurement in "+Math.round(e/1e3)+" seconds."),setTimeout(performMeasurement,e)}window.addEventListener("resize",debouncedResize),"querySelectorAll"in document&&"addEventListener"in window&&window.HTMLCanvasElement&&loadGlobalMapData(),window.onload=function(){scheduleMeasurement()};