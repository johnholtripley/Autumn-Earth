function mixColours(){for(var e=0,t=0,a=0,i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],o=0;o<arguments.length;o++)i[arguments[o]]++,e|=arguments[o],arguments[o]==(16|arguments[o])&&t++,arguments[o]==(8|arguments[o])&&a++;for(var o=0;o<i.length;o++)if(i[o]/arguments.length>.7){e=o;break}return e>24&&(e-=t>a?8:a>t?16:24),e}function getTileX(e){return Math.floor(e/tileW)}function getTileY(e){return Math.floor(e/tileW)}function findIsoCoordsX(e,t){return Math.floor(mapTilesY*tileW/2-t/2+e/2)}function findIsoCoordsY(e,t){return Math.floor(e/4+t/4-tileH/2)}function getTileCentreCoordX(e){return e*tileW+tileW/2}function getTileCentreCoordY(e){return e*tileW+tileW/2}function getTileIsoCentreCoordX(e,t){return tileW/2*(mapTilesY-t+e)}function getTileIsoCentreCoordY(e,t){return tileH/2*(t+e)}function getCurrentTileX(e){return Math.floor(e/tileW)}function getCurrentTileY(e){return Math.floor(e/tileW)}function sortByIsoDepth(e,t){return e[0]<t[0]?-1:e[0]>t[0]?1:0}function init(){gameCanvas=document.getElementById("gameWorld"),gameCanvas.getContext&&(gameContext=gameCanvas.getContext("2d"),canvasWidth=gameCanvas.width,canvasHeight=gameCanvas.height),gameMode="mapLoading",UI.init(),Input.init(),gameLoop(),getHeroGameState()}function getHeroGameState(){getJSON("/data/chr"+characterId+"/gameState.json",function(e){hero.tileX=e.tileX,hero.tileY=e.tileY,currentMap=e.currentMap,newMap=currentMap,hero.bags=e.bags,hero.inventory=e.inventory,loadCoreAssets()},function(e){getHeroGameState()})}function loadCoreAssets(){coreImagesToLoad=[],coreImagesToLoad.push({name:"heroImg",src:"/images/game-world/core/test-iso-hero.png"}),Loader.preload(coreImagesToLoad,prepareCoreAssets,loadingProgress)}function prepareCoreAssets(){heroImg=Loader.getImage("heroImg"),loadMap()}function loadMapJSON(e){console.log("mapFilePath: "+e),getJSON(e,function(e){thisMapData=e.map,mapTilesY=thisMapData.terrain.length,mapTilesX=thisMapData.terrain[0].length,previousZoneName!=thisMapData.zoneName&&UI.showZoneName(thisMapData.zoneName),findInventoryItemData()},function(t){loadMapJSON(e)})}function loadMap(){var e;if(console.log("going from "+currentMap+" to "+newMap),0>newMap&&currentMap>0?(randomDungeonName=randomDungeons[Math.abs(newMap)],newMap=-1):e="/data/chr"+characterId+"/map"+newMap+".json",0>newMap){var t=0,a=0,i=thisMapData.doors;for(var o=0 in i)i[o].map==newMap&&(t+=i[o].startX,a+=i[o].startY);var n=t/3,r=a/3;e="/generateDungeonMap.php?playerId="+characterId+"&originatingMapId="+currentMap+"&requestedMap="+newMap+"&dungeonName="+randomDungeonName+"&connectingDoorX="+n+"&connectingDoorY="+r}currentMap=newMap,loadMapJSON(e)}function loadMapAssets(){imagesToLoad=[];var e=currentMap;0>currentMap&&(e="dungeon/"+randomDungeonName),imagesToLoad.push({name:"backgroundImg",src:"/images/game-world/maps/"+e+"/bg.png"}),tileGraphicsToLoad=thisMapData.graphics;for(var t=0;t<tileGraphicsToLoad.length;t++)imagesToLoad.push({name:"tile"+t,src:"/images/game-world/maps/"+e+"/"+tileGraphicsToLoad[t].src});npcGraphicsToLoad=thisMapData.npcs;for(var t=0;t<npcGraphicsToLoad.length;t++)imagesToLoad.push({name:"npc"+t,src:"/images/game-world/npcs/"+npcGraphicsToLoad[t].src});itemGraphicsToLoad=thisMapData.items;for(var t=0;t<itemGraphicsToLoad.length;t++)imagesToLoad.push({name:"item"+t,src:"/images/game-world/items/"+itemGraphicsToLoad[t].src});Loader.preload(imagesToLoad,prepareGame,loadingProgress)}function findInventoryItemData(){var e=[];for(var t in hero.inventory)hero.inventory.hasOwnProperty(t)&&-1==e.indexOf(hero.inventory[t].type)&&e.push(hero.inventory[t].type);loadInventoryItemData(e.join("|"))}function loadInventoryItemData(e){getJSON("/game-world/getInventoryItems.php?whichIds="+e,function(e){currentActiveInventoryItems=e,console.log(currentActiveInventoryItems[5].shortname),console.log(currentActiveInventoryItems[9].shortname),inventoryInterfaceIsBuilt||UI.buildInventoryInterface(),loadMapAssets()},function(t){loadInventoryItemData(e)})}function prepareGame(){tileImages=[];for(var e=0;e<tileGraphicsToLoad.length;e++)tileImages[e]=Loader.getImage("tile"+e);npcImages=[];for(var e=0;e<npcGraphicsToLoad.length;e++)npcImages[e]=Loader.getImage("npc"+e);itemImages=[];for(var e=0;e<itemGraphicsToLoad.length;e++)itemImages[e]=Loader.getImage("item"+e);backgroundImg=Loader.getImage("backgroundImg");for(var e=0;e<thisMapData.npcs.length;e++)thisMapData.npcs[e].x=getTileCentreCoordX(thisMapData.npcs[e].tileX),thisMapData.npcs[e].y=getTileCentreCoordY(thisMapData.npcs[e].tileY),thisMapData.npcs[e].dx=0,thisMapData.npcs[e].dy=0,thisMapData.npcs[e].movementIndex=-1;for(var e=0;e<thisMapData.items.length;e++)thisMapData.items[e].x=getTileCentreCoordX(thisMapData.items[e].tileX),thisMapData.items[e].y=getTileCentreCoordY(thisMapData.items[e].tileY);hero.x=getTileCentreCoordX(hero.tileX),hero.y=getTileCentreCoordY(hero.tileY),timeSinceLastFrameSwap=0,currentAnimationFrame=0,mapTransition="in",mapTransitionCurrentFrames=1,gameMode="play"}function removeMapAssets(){for(var e=0;e<tileGraphicsToLoad.length;e++)tileImages[e].src="",tileImages[e]=null;for(var e=0;e<npcGraphicsToLoad.length;e++)npcImages[e].src="",npcImages[e]=null;for(var e=0;e<itemGraphicsToLoad.length;e++)itemImages[e].src="",itemImages[e]=null;backgroundImg.src="",backgroundImg=null}function loadingProgress(){console.log("loading - "+Loader.getProgress())}function changeMaps(e,t){previousZoneName=thisMapData.zoneName,gameMode="mapLoading",removeMapAssets();var a=thisMapData.doors,i=getTileX(e)+","+getTileX(t);hero.tileX=a[i].startX,hero.tileY=a[i].startY,newMap=a[i].map,loadMap()}function isATerrainCollision(e,t){var a=getTileX(e),i=getTileY(t);if(0>a||0>i||a>=mapTilesX||i>=mapTilesY)return 1;switch(thisMapData.collisions[i][a]){case 1:return 1;case"d":return activeDoorX=e,activeDoorY=t,0;default:return 0}}function startDoorTransition(){""==mapTransition&&(mapTransitionCurrentFrames=1,mapTransition="out")}function getHeroAsCloseAsPossibleToObject(e,t,a,i){switch(hero.facing){case"n":hero.y=t+i/2+hero.height/2+1;break;case"s":hero.y=t-i/2-hero.height/2-1;break;case"w":hero.x=e-a/2-hero.width/2-1;break;case"e":hero.x=e+a/2+hero.width/2+1}}function checkHeroCollisions(){if(activeDoorX=-1,activeDoorY=-1,key[2])if(isATerrainCollision(hero.x-hero.width/2,hero.y-hero.height/2)||isATerrainCollision(hero.x+hero.width/2,hero.y-hero.height/2)){var e=getTileY(hero.y-hero.height/2),t=(e+1)*tileW;hero.y=t+hero.height/2+1}else-1!=activeDoorX&&startDoorTransition();if(key[3])if(isATerrainCollision(hero.x-hero.width/2,hero.y+hero.height/2)||isATerrainCollision(hero.x+hero.width/2,hero.y+hero.height/2)){var e=getTileY(hero.y+hero.height/2),a=e*tileW;hero.y=a-hero.height/2-1}else-1!=activeDoorX&&startDoorTransition();if(key[0])if(isATerrainCollision(hero.x-hero.width/2,hero.y+hero.height/2)||isATerrainCollision(hero.x-hero.width/2,hero.y-hero.height/2)){var e=getTileX(hero.x-hero.width/2),i=(e+1)*tileW;hero.x=i+hero.width/2+1}else-1!=activeDoorX&&startDoorTransition();if(key[1])if(isATerrainCollision(hero.x+hero.width/2,hero.y+hero.height/2)||isATerrainCollision(hero.x+hero.width/2,hero.y-hero.height/2)){var e=getTileX(hero.x+hero.width/2),o=e*tileW;hero.x=o-hero.width/2-1}else-1!=activeDoorX&&startDoorTransition();for(var n=0;n<thisMapData.npcs.length;n++)thisNPC=thisMapData.npcs[n],thisNPC.isCollidable&&isAnObjectCollision(thisNPC.x,thisNPC.y,thisNPC.width,thisNPC.height,hero.x,hero.y,hero.width,hero.height)&&getHeroAsCloseAsPossibleToObject(thisNPC.x,thisNPC.y,thisNPC.width,thisNPC.height);for(var n=0;n<thisMapData.items.length;n++)thisItem=thisMapData.items[n],isAnObjectCollision(thisItem.x,thisItem.y,thisItem.width,thisItem.height,hero.x,hero.y,hero.width,hero.height)&&getHeroAsCloseAsPossibleToObject(thisItem.x,thisItem.y,thisItem.width,thisItem.height)}function gameLoop(){switch(gameMode){case"mapLoading":console.log("loading map assets...");break;case"paused":break;case"play":update(),draw()}window.requestAnimationFrame(gameLoop)}function update(){var e=window.performance.now(),t=e-lastTime;if(lastTime=e,hero.isMoving=!1,oldHeroX=hero.x,oldHeroY=hero.y,"out"!=mapTransition)key[2]?(hero.isMoving=!0,hero.facing="n",hero.y-=hero.speed):key[3]?(hero.isMoving=!0,hero.facing="s",hero.y+=hero.speed):key[0]?(hero.isMoving=!0,hero.facing="e",hero.x-=hero.speed):key[1]&&(hero.isMoving=!0,hero.facing="w",hero.x+=hero.speed),checkHeroCollisions(),hero.tileX=getTileX(hero.x),hero.tileY=getTileY(hero.y);else{switch(hero.isMoving=!0,hero.facing){case"n":hero.y-=hero.speed;break;case"s":hero.y+=hero.speed;break;case"e":hero.x-=hero.speed;break;case"w":hero.x+=hero.speed}mapTransitionCurrentFrames++,mapTransitionCurrentFrames>=mapTransitionMaxFrames&&changeMaps(activeDoorX,activeDoorY)}"in"==mapTransition&&(mapTransitionCurrentFrames+=2,mapTransitionCurrentFrames>=mapTransitionMaxFrames&&(mapTransition="")),timeSinceLastFrameSwap+=t,timeSinceLastFrameSwap>animationUpdateTime&&(currentAnimationFrame++,timeSinceLastFrameSwap=0),moveNPCs()}function isAnObjectCollision(e,t,a,i,o,n,r,s){return e+a/2>o-r/2&&o+r/2>e-a/2&&n+s/2>t-i/2&&t+i/2>n-s/2?!0:!1}function moveNPCs(){for(var e,t,a,i,o,n=0;n<thisMapData.npcs.length;n++)if(e=thisMapData.npcs[n],e.isMoving){switch(i=e.x,o=e.y,e.facing){case"n":if(e.y-=e.speed,isATerrainCollision(e.x-e.width/2,e.y-e.height/2)||isATerrainCollision(e.x+e.width/2,e.y-e.height/2)){var r=getTileY(e.y-e.height/2),s=(r+1)*tileW;e.y=s+e.height/2+1}break;case"s":if(e.y+=e.speed,isATerrainCollision(e.x-e.width/2,e.y+e.height/2)||isATerrainCollision(e.x+e.width/2,e.y+e.height/2)){var r=getTileY(e.y+e.height/2),h=r*tileW;e.y=h-e.height/2-1}break;case"w":if(e.x-=e.speed,isATerrainCollision(e.x-e.width/2,e.y+e.height/2)||isATerrainCollision(e.x-e.width/2,e.y-e.height/2)){var r=getTileX(e.x-e.width/2),l=(r+1)*tileW;e.x=l+e.width/2+1}break;case"e":if(e.x+=e.speed,isATerrainCollision(e.x+e.width/2,e.y+e.height/2)||isATerrainCollision(e.x+e.width/2,e.y-e.height/2)){var r=getTileX(e.x+e.width/2),c=r*tileW;e.x=c-e.width/2-1}}isAnObjectCollision(e.x,e.y,e.width,e.height,hero.x,hero.y,hero.width,hero.height)&&(e.x=i,e.y=o);for(var g=0;g<thisMapData.npcs.length;g++)n!=g&&(thisOtherNPC=thisMapData.npcs[g],thisOtherNPC.isCollidable&&isAnObjectCollision(e.x,e.y,e.width,e.height,thisOtherNPC.x,thisOtherNPC.y,thisOtherNPC.width,thisOtherNPC.height)&&(e.x=i,e.y=o));for(var n=0;n<thisMapData.items.length;n++)thisItem=thisMapData.items[n],isAnObjectCollision(e.x,e.y,e.width,e.height,thisItem.x,thisItem.y,thisItem.width,thisItem.height)&&(e.x=i,e.y=o);if(e.dx+=e.x-i,e.dy+=e.y-o,t=!1,Math.abs(e.dx)>=tileW&&(e.dx>0?e.dx-=tileW:e.dx+=tileW,t=!0),Math.abs(e.dy)>=tileW&&(e.dy>0?e.dy-=tileW:e.dy+=tileW,t=!0),t)switch(e.movementIndex++,e.movementIndex>=e.movement.length&&(e.movementIndex=0),a=e.movement[e.movementIndex]){case"-":e.isMoving=!1,console.log(getTileY(e.y));case"?":do e.facing=facingsPossible[Math.floor(Math.random()*facingsPossible.length)];while(isATerrainCollision(e.x+relativeFacing[e.facing].x*tileW,e.y+relativeFacing[e.facing].y*tileW));break;default:e.facing=a}}}function draw(){if("mapLoading"==gameMode)gameContext.fillRect(0,0,canvasWidth,canvasHeight),gameContext.fillStyle="black",gameContext.fill();else{hero.isox=findIsoCoordsX(hero.x,hero.y),hero.isoy=findIsoCoordsY(hero.x,hero.y);for(var e,t,a,i,o,n,r=[[hero.isoy,heroImg,Math.floor(canvasWidth/2-hero.feetOffsetX),Math.floor(canvasHeight/2-hero.feetOffsetY)]],s=thisMapData.terrain,h=0,l=0,c=0;mapTilesX>c;c++)for(var g=0;mapTilesY>g;g++)"*"!=s[g][c]&&(a=getTileIsoCentreCoordX(c,g),i=getTileIsoCentreCoordY(c,g),e=thisMapData.graphics[s[g][c]].centreX,t=thisMapData.graphics[s[g][c]].centreY,r.push([i,tileImages[s[g][c]],Math.floor(a-hero.isox-e+canvasWidth/2),Math.floor(i-hero.isoy-t+canvasHeight/2)]));for(var c=0;c<thisMapData.npcs.length;c++)o=thisMapData.npcs[c],h=currentAnimationFrame%o.animation.walk.length,l=o.animation.walk[o.facing],a=findIsoCoordsX(o.x,o.y),i=findIsoCoordsY(o.x,o.y),r.push([i,npcImages[c],h*o.spriteWidth,l*o.spriteHeight,o.spriteWidth,o.spriteHeight,Math.floor(a-hero.isox-o.centreX+canvasWidth/2),Math.floor(i-hero.isoy-o.centreY+canvasHeight/2),o.spriteWidth,o.spriteHeight]);for(var c=0;c<thisMapData.items.length;c++)n=thisMapData.items[c],a=findIsoCoordsX(n.x,n.y),i=findIsoCoordsY(n.x,n.y),r.push([i,itemImages[c],Math.floor(a-hero.isox-n.centreX+canvasWidth/2),Math.floor(i-hero.isoy-n.centreY+canvasHeight/2)]);r.sort(sortByIsoDepth),gameContext.drawImage(backgroundImg,Math.floor(getTileIsoCentreCoordX(0,mapTilesX-1)-hero.isox-tileW/2),Math.floor(getTileIsoCentreCoordY(0,0)-hero.isoy-tileH/2));for(var c=0;c<r.length;c++)10==r[c].length?gameContext.drawImage(r[c][1],r[c][2],r[c][3],r[c][4],r[c][5],r[c][6],r[c][7],r[c][8],r[c][9]):gameContext.drawImage(r[c][1],r[c][2],r[c][3]);if("out"==mapTransition){var m=1-mapTransitionCurrentFrames/mapTransitionMaxFrames,d=gameContext.createRadialGradient(canvasWidth/2,canvasHeight/2,m*canvasWidth/2,canvasWidth/2,canvasHeight/2,0);d.addColorStop(0,"rgba(0,0,0,1)"),d.addColorStop(1,"rgba(0,0,0,0)"),gameContext.fillStyle=d,gameContext.fillRect(0,0,canvasWidth,canvasHeight)}else if("in"==mapTransition){var m=mapTransitionCurrentFrames/mapTransitionMaxFrames,d=gameContext.createRadialGradient(canvasWidth/2,canvasHeight/2,m*canvasWidth/2,canvasWidth/2,canvasHeight/2,0);d.addColorStop(0,"rgba(0,0,0,1)"),d.addColorStop(1,"rgba(0,0,0,0)"),gameContext.fillStyle=d,gameContext.fillRect(0,0,canvasWidth,canvasHeight)}}}colourNames=["","Crimson","Yellow","Orange","Blue","Purple","Green","Brown","White","Pink","(light yellow/cream)","(light orange/coral)","Aquamarine","Violet","(light green/lime)","Tawny","Black","Ruby/Maroon","(dark yellow/amber)","(dark orange/sienna)","(dark blue/sapphire)","(indigo/imperial purple)","(dark green/emerald/olive)","(dark brown/chestnut)","Grey"];var animationFramesPerSecond=16,lastTime=0,elapsed=0,timeSinceLastFrameSwap=0,currentAnimationFrame=0,animationUpdateTime=1e3/animationFramesPerSecond,mapTransition="",mapTransitionCurrentFrames=1,mapTransitionMaxFrames=60,activeDoorX=-1,activeDoorY=-1,characterId=999,currentMap=0,newMap=0,thisMapData="",mapTilesX=0,mapTilesY=0,tileGraphics=[],tileW=48,tileH=tileW/2,tileGraphicsToLoad=0,npcGraphicsToLoad=0,itemGraphicsToLoad=0,canvasWidth=800,canvasHeight=600,randomDungeonName="",randomDungeons=["","the-barrow-mines"],previousZoneName="",currentActiveInventoryItems=[],inventoryInterfaceIsBuilt=!1,key=[0,0,0,0,0],hero={x:0,y:0,dx:0,dy:0,width:20,height:20,feetOffsetX:40,feetOffsetY:69,speed:4,isMoving:!1,facing:"s",sequences:{"stand-s":[3],"stand-n":[10],"stand-w":[17],"stand-e":[24],"walk-s":[3,4,5,6,5,4,3,2,1,0,1,2],"walk-n":[10,11,12,13,12,11,10,9,8,7,8,9],"walk-w":[17,18,19,20,19,18,17,16,15,14,15,16],"walk-e":[24,25,26,27,26,25,24,23,22,21,22,23]}},facingsPossible=["n","e","s","w"],relativeFacing={n:{x:0,y:-1},s:{x:0,y:1},e:{x:1,y:0},w:{x:-1,y:0}};!function(){for(var e=0,t=["ms","moz","webkit","o"],a=0;a<t.length&&!window.requestAnimationFrame;++a)window.requestAnimationFrame=window[t[a]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[a]+"CancelAnimationFrame"]||window[t[a]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,a){var i=(new Date).getTime(),o=Math.max(0,16-(i-e)),n=window.setTimeout(function(){t(i+o)},o);return e=i+o,n}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}();var getJSON=function(e,t,a){var i="undefined"!=typeof XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");i.open("get",e,!0),i.onreadystatechange=function(){var e,o;if(4==i.readyState){e=i.status;var n=!0;if(200==e){try{o=JSON.parse(i.responseText)}catch(r){n=!1,a&&a(e)}n&&t&&t(o)}else a&&a(e)}},i.send()};window.Loader=function(){function e(){l=0,c=!1,g=0,m={}}function t(){}function a(){}function i(e){++l,t(h()),l==g&&(c=!1,a())}function o(e){console.log("Error on loading the image: "+e.srcElement)}function n(e,t){try{m[e]=new Image,m[e].onload=function(){i(e)},m[e].onerror=o,m[e].src=t}catch(a){console.log(a.message)}}function r(e){return m[e]?m[e]:void 0}function s(i,o,r){if(e(),!c){c=!0;try{g=i.length,t=r||function(){},a=o||function(){};for(var s=0;s<i.length;++s)n(i[s].name,i[s].src)}catch(h){console.log(h.message)}}}function h(){return l/g*100}var l=0,c=!1,g=0,m={};return{preload:s,getProgress:h,getImage:r,reset:e,images:m}}();var Input={init:function(){document.addEventListener("keydown",function(e){Input.changeKey(e.keyCode,1)}),document.addEventListener("keyup",function(e){Input.changeKey(e.keyCode,0)})},changeKey:function(e,t){switch(e){case KeyBindings.left:key[0]=t;break;case KeyBindings.up:key[2]=t;break;case KeyBindings.right:key[1]=t;break;case KeyBindings.down:key[3]=t;break;case KeyBindings.action:key[4]=t}}},KeyBindings={left:37,right:39,up:38,down:40,action:32,pause:80},UI={init:function(){document.getElementById("displayZoneName")},showZoneName:function(e){displayZoneName.classList.remove("active"),displayZoneName.textContent=e,void displayZoneName.offsetWidth,displayZoneName.classList.add("active")},buildInventoryInterface:function(){inventoryInterfaceIsBuilt=!0}};"serviceWorker"in navigator&&navigator.serviceWorker.register("/game-world/serviceWorker.min.js",{scope:"/game-world/"}),"querySelectorAll"in document&&"addEventListener"in window&&window.HTMLCanvasElement&&init();