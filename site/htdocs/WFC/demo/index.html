
<html>
    <head>

        <style>
            body {
                font-family: "Arial", "Helvetica Neue", "Helvetica", sans-serif;
                font-size:11px;
                margin:0;
                padding: 10px 0 10px 20px;
            }



            canvas {
                border: 2px solid black;
                background:black;
                box-shadow:0 0 10px black;
                cursor:crosshair;
                user-select: none;
                -moz-user-select: none;
                -webkit-user-select: none;
                margin:10px;
                transition:opacity 0.2s linear;
                display: block;
            }










        </style>

<script type="text/javascript" src="wfc.js"></script>

    </head>

    <body>




 
input:
        <canvas id="samplePattern" width="20" height="20" style="width:140px; height:140px; image-rendering: pixelated;"></canvas>
output:
        <canvas id="generatedPattern" width="48" height="48" style="width:240px; height:240px; image-rendering: pixelated;"></canvas>







        <script type="text/javascript">
       
// https://github.com/kchapelier/wavefunctioncollapse


            var options = {
                n: 3,
                symmetry: 8,
                ground: 0,
                periodic: 1,
                periodicInput: 1,
                width: 48,
                height: 48,
                sampleWidth: 20,
                sampleHeight: 20
            };


            var sampleCanvas = document.getElementById('samplePattern'),
                sampleContext = sampleCanvas.getContext('2d'),
                sampleData = null;

            var generateCanvas = document.getElementById('generatedPattern'),
                generateContext = generateCanvas.getContext('2d'),
                generateData = null;

            function setSample (img) {
                var width = Math.min(50, img.width);
                var height = Math.min(50, img.height);
                sampleCanvas.width = width;
                sampleCanvas.height = height;
                sampleCanvas.style.width = (width * 7) + 'px';
                sampleCanvas.style.height = (height * 7) + 'px';
                sampleContext.drawImage(img, 0, 0);

                sampleData = sampleContext.getImageData(0, 0, width, height);

                //document.body.classList.add('allow-generation');
            }


            var updateGenerateData = function updateGenerateData () {
                if (generateData === null || generateCanvas.width != options.width || generateCanvas.height != options.height) {
                    generateCanvas.width = options.width;
                    generateCanvas.height = options.height;
                    generateCanvas.style.width = (options.width * 5) + 'px';
                    generateCanvas.style.height = (options.height * 5) + 'px';
                    generateData = generateContext.createImageData(options.width, options.height);
                }
             
            };


var whichSample = "Less Rooms";
var img = new Image();
img.onload = function () {
     setSample(img);
            updateGenerateData();
            generateWFC();
};
img.src = './samples/' + whichSample + '.png';


              



            function generateWFC() {
                var message = {
                    generateData: generateData.data.buffer,
                    sampleData: sampleData.data.buffer,
                    sampleWidth: sampleData.width,
                    sampleHeight: sampleData.height,
                    n: options.n,
                    width: options.width,
                    height: options.height,
                    periodicInput: options.periodicInput,
                    periodic: options.periodic,
                    symmetry: options.symmetry,
                    ground: options.ground
                };
              
                  
            
              var tries = 0;
                  var instance = new wfc.OverlappingModel(new Uint8Array(message.sampleData), message.sampleWidth, message.sampleHeight, message.n, message.width, message.height, message.periodicInput, message.periodic, message.symmetry, message.ground);
                  
                      var finished = false;
    var time;

    do {
        tries++;
        console.log('> Generation attempt #' + tries + ' out of 5');
        time = Date.now();
        finished = instance.generate();
        console.log('> Generation completed ' + (finished ? 'successfully' : 'unsuccessfully') + ' in ' + ((Date.now() - time) / 1000).toFixed(3) + 's');
    } while (tries < 5 && !finished);
    
    
    var responseData = finished ? instance.graphics(new Uint8Array(message.generateData)).buffer : message.generateData
    
    generateData = new ImageData(new Uint8ClampedArray(responseData), options.width, options.height);
                   if (finished) {
                        generateContext.putImageData(generateData, 0, 0);
                    }
    
             
              
            }


        </script>
    </body>

</html>



